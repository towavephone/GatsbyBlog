webpackJsonp([0xe84bedced712],{1235:function(n,s){n.exports={data:{file:{childImageSharp:{sizes:{base64:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAeCAYAAAAsEj5rAAAACXBIWXMAAAsSAAALEgHS3X78AAAHlElEQVRIx12We2xT5xXAbcI2Vmn7o1I1uhVYRxL8tuPn9bXv0+/4/YgdOyYkkATCCEEYsqVNC2wCIYQWShmUBFh4hMAWECot0BUtlI4yAS1oKqJQXimsDBgTU8codnLO7r0uUPpJn87Rp+/8vvOdc75zr8xmZmTieI1NykU5yxOfxDncz3NUjAlyDXMjXGMhys+cG+FzGQ8VU4t7XuV8z8m+GUkrJclSqVReYJ0ZWQ8Tl2AdTPhnq9ns2QKd+crDZiHha8NsYCE21HZiXphpb3sxxTf99Tdsw51ldHqFaLOXXyzvYqOyZ0YPk5soylfouuUbvHOxh56JbiqJfi4/FnE1lxKetrGUZ954nbcdU/752ORpxWVsc6mZjPxctFtApeVtra1lmIPwTxClgeCqvGTsX/WWOEbtyTGWSoGbToOPzUHQ1QghVxOEhRniZ5U8XB4TzvTdgj1ZJdq2OOrkGhVRBnrYFum6TiK0l2fr0emMlVxcBhlnEniqDjlBuqg0CnD0MPWiDrwzhR4u+5B3x3WiLUNHJjxzZYvR8ZKTCP+Xo1JoM/nBYvSB1egHuyUIrCOBPj4LtD0KlD2K4h7SGip62aygxzaK9rHA3Aqt2vw0MRYjnyJtYaQdsXG9hgWFwgmVlXZUKUjUqmm0CgfwhA80Kgr1Wg40Sue4SuFEnZq+YjMbJ0kh0zmfemjQ0j2EJYh2a23RVOODIBvHmCsBUaoWLDoWKIsP50bTApxC5QwH1Ghp0Gk4MBk8aDLQEslooCc88VClsK+zGANI2mqLer0XFuea8PSuN+DM7o3QWyhAR7IBfj+vDbyOICS9aSjkZo8nvSlUKuxXLDUOKdN6LSl/AlRUE+vNAnD50l8XeTIEPiYEzXYG5mlNeGz7BvjPpY/g5snDcHxwE+zs7oCh1zvHCrNm48u/ML8j2muVQblBZ3t6ZY2KXKtQcDiwdk1xx9rV0BlqghEuD4fNUTy1Zwhw7Cbioxu461fdsOgFDa5pbh3zu6NifE9f+XCPlGHS5nuaFI3K8brJ4EUHES4WFiyEP2/dCPc2vYH/3NIHePcywP1LWLp3Ec4tWQa3FvbAu7294yqVA801rju5utYfiQyKDD4DnC8GWEhMafJPtBALxuHjo3+C8bufIn59DfHBFcDiDcQvzyF+/iEsbWuDadNMaDW5H7nY6Iyyh165zfLNtdUqIqLTsEJSQqBVUTD1JQPqdRT8sf9NuH7kMHy0fRg+O3EUzp96H/Zs2SBklxFKxwFmowtdTCIoPQx7oKLzl32PPTRPVSudDwQgCrUGL0+twdzsDjjSdwD2J1fh/q7N0N+1EtykB178qVY4lAahRktWkw95JrG4DAxPvHU3Wwb+rlcsHfK0WNxCoMdUCgdUaxnMBPKw7dVe2LyhDw4MboORA4NQOd2CaiUFaqWjZJGAyQGRUeubP8FqElqZspquEBeUM2zrnEQUa3R8USVcp2qGDZV6ErqXL4PfrlwFhSU9cPL4MejfshOsZq90sCg5KvHZ5MnPfa+cmFrxukRFuRZNcYqIoNngHheeFmiF11ClIDBdPwfqG9qhc1E3rF25GnrX90M204JqBfWItPrP8lTqa7vFpSw3GJ9cZjI4pW5TXaWezpKxh4Q5gEY9LwApVOtZMApxVWhd2DKvC7K5FjTUsFCj45Ah4yXaHuz1MBlgyHCb1HXISIXMTcekOJqN1h/72Mx92h5DwuwHjeChWseBQsNgJJ6H944eB5oNgaLajnaL/07E24wuKr7Cz+XuuenUsMioCxYmyHhnSPLQTYVVYVfjI46Mo80WBLMgLY4E1FhCOENBAsfHQG/0juuNPqGguU8ywXas5XNbg6783wJ8w781GtUPJc+irkap/Ufdje0JXytStnDJbA2D1Z4EKxEHsyUMRmsIdcZaNFpCYBYqwWQLPhD3Btn6t2Pe5uF0cD7Sdr/xmSab8racFaDooOvuk0wDEs40EFQGbVQGbEKXJoTPgZ3JoJGIgULvR6M1jE67rzvpae5ojC7GEJ9rfgILc7lC3NV0T6flTtjoPLK+VuD8rcD65gDtaQInPxOtzoxQRrXgD8/BdW/+YezYByfxvfdHvnxl+ZLKCDfzUMIze60Ey+brJukrqcjA1u3tBw8dfZiZuRQFaNFory/WEPUlE5kFK5WDQKRtbFPfUOnChUvFL27cwKuj/8CBHXv2iQw/k/KGuNwyCYiIkhw+sO/569eu7b1+ffR/H5z4BAcG38X1m/biyjX9ODR8GC9dHsXLV0fx5KlzePDIyFd7ht9ZJZhJrcvLhV/wMuUPljQWtC6Z+FjfuWPHlPMXLq64Onpz3d8/Pf9WX//OW2vWbITBof3n3tqya9fbh/7SvW1gZ9Xj/V1dr8kf614qIZONjBwrezi8Ty54K5d9ZzTmF+xe1LnioaD+4Nvrn4/ermif3yHp8UCDLMCky7Z+n192+/YdST9z5mPZ7t1D8ouXv6gQ4S9WTplks7mut8xZijxbKz2vvi2D39/cPyB/HC5xOm2czPvd35F8rkGCS0+I4WXV1QbJaMq06XqbNXCQJIILpH8hOic3GghZMpl62qG/Nf4PRzaQ862MzO4AAAAASUVORK5CYII=",aspectRatio:.6666666666666666,src:"/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-25c91.png",srcSet:"/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-8a97b.png 200w,\n/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-0fdf3.png 400w,\n/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-25c91.png 600w",srcWebp:"/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-216f6.webp",srcSetWebp:"/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-5d70e.webp 200w,\n/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-d1677.webp 400w,\n/static/avatar-dc7bc85837bf005ae32d2a37dfdfa8a2-216f6.webp 600w",sizes:"(max-width: 600px) 100vw, 600px"}}},site:{siteMetadata:{title:"女王控的博客",description:'前端工程师，黑猫女王控，欢迎勾搭，技术相关<a href="https://github.com/towavephone" target="_blank">@towavephone</a>，QQ闲聊<a href="tencent://AddContact/?fromId=45&fromSubId=1&subcmd=all&uin=634407147&website=www.oicqzone.com">@towave</a>，bili关注<a href="https://space.bilibili.com/11507708#/" target="_blank">@towave</a>',siteUrl:"https://blog.towavephone.com"}},mainPost:{html:'<h1 id="分布式系统、单体系统区别"><a href="#%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E3%80%81%E5%8D%95%E4%BD%93%E7%B3%BB%E7%BB%9F%E5%8C%BA%E5%88%AB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分布式系统、单体系统区别</h1>\n<p>分布式系统是对单体系统的一种改进，但这种改进同样也带来了复杂度和实现难度。</p>\n<h2 id="背景"><a href="#%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>背景</h2>\n<p>单体系统存在以下情况不能应对：</p>\n<ol>\n<li>业务复杂度和产品迭代速度</li>\n<li>处理高并发、大数据量的用户请求</li>\n<li>代码维护和团队协作</li>\n</ol>\n<p>但是分布式系统引入了新问题</p>\n<ol>\n<li>网络传输的三态性</li>\n<li>数据的一致性</li>\n<li>可用性</li>\n</ol>\n<p>// TODO <a href="https://juejin.cn/book/7106442254533066787/section/7106701956340514857" target="_blank" rel="nofollow noreferrer noopener">https://juejin.cn/book/7106442254533066787/section/7106701956340514857</a></p>',excerpt:"…",timeToRead:1,tableOfContents:'<ul>\n<li>\n<p><a href="/distributed-services-practice-learn/#%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E3%80%81%E5%8D%95%E4%BD%93%E7%B3%BB%E7%BB%9F%E5%8C%BA%E5%88%AB">分布式系统、单体系统区别</a></p>\n<ul>\n<li><a href="/distributed-services-practice-learn/#%E8%83%8C%E6%99%AF">背景</a></li>\n</ul>\n</li>\n</ul>',wordCount:{words:33},frontmatter:{date:"2023-09-14 11:42:36",path:"/distributed-services-practice-learn/",tags:"后端, 系统设计, 读书笔记, 分布式",title:"分布式服务入门学习",draft:null,catalog_number:null}},nextPost:{html:'<h1 id="培养-pythonic-思维"><a href="#%E5%9F%B9%E5%85%BB-pythonic-%E6%80%9D%E7%BB%B4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>培养 Pythonic 思维</h1>\n<h2 id="第-1-条：查询自己使用的-python-版本"><a href="#%E7%AC%AC-1-%E6%9D%A1%EF%BC%9A%E6%9F%A5%E8%AF%A2%E8%87%AA%E5%B7%B1%E4%BD%BF%E7%94%A8%E7%9A%84-python-%E7%89%88%E6%9C%AC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 1 条：查询自己使用的 Python 版本</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32388685056500232000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ python --version\n\\$ python -V\n\\$ python3 --version\n\\$ python3 -V`, `32388685056500232000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ python --version\n$ python -V\n$ python3 --version\n$ python3 -V</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75036683869854320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> import sys\n>>> print(sys.version_info)\nsys.version_info(major=3, minor=6, micro=15, releaselevel=\'final\', serial=0)\n>>> print(sys.version)\n3.6.15 (default, Apr 20 2022, 13:05:41)\n[GCC 5.4.0 20160609]`, `75036683869854320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> <span class="token function">import</span> sys\n<span class="token operator">>></span><span class="token operator">></span> print<span class="token punctuation">(</span>sys.version_info<span class="token punctuation">)</span>\nsys.version_info<span class="token punctuation">(</span>major<span class="token operator">=</span><span class="token number">3</span>, <span class="token assign-left variable">minor</span><span class="token operator">=</span><span class="token number">6</span>, <span class="token assign-left variable">micro</span><span class="token operator">=</span><span class="token number">15</span>, <span class="token assign-left variable">releaselevel</span><span class="token operator">=</span><span class="token string">\'final\'</span>, <span class="token assign-left variable">serial</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> print<span class="token punctuation">(</span>sys.version<span class="token punctuation">)</span>\n<span class="token number">3.6</span>.15 <span class="token punctuation">(</span>default, Apr <span class="token number">20</span> <span class="token number">2022</span>, <span class="token number">13</span>:05:41<span class="token punctuation">)</span>\n<span class="token punctuation">[</span>GCC <span class="token number">5.4</span>.0 <span class="token number">20160609</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Python 2 于 2020 年 1 月 1 日退场，到这一刻，所有的 bug 修复、安全补丁，以及特性向后移植都会停止。此后，如果你还坚持使用 Python 2，那么会面临很多不利因素，因为它不会再获得正式的维护了。深度依赖 Python 2 代码库的开发者可以考虑用 2to3（Python 预装的工具）与 <a href="https://six.readthedocs.io/" target="_blank" rel="nofollow noreferrer noopener">six</a> 这样的工具过渡到 Python 3。</p>\n<h2 id="第-2-条：遵循-pep-8-风格指南"><a href="#%E7%AC%AC-2-%E6%9D%A1%EF%BC%9A%E9%81%B5%E5%BE%AA-pep-8-%E9%A3%8E%E6%A0%BC%E6%8C%87%E5%8D%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 2 条：遵循 PEP 8 风格指南</h2>\n<h3 id="与空白有关的建议"><a href="#%E4%B8%8E%E7%A9%BA%E7%99%BD%E6%9C%89%E5%85%B3%E7%9A%84%E5%BB%BA%E8%AE%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>与空白有关的建议</h3>\n<p>在 Python 中，空白（whitespace）在语法上相当重要。Python 程序员对空白字符的用法尤其在意，因为它们会影响代码的清晰程度。在这方面，大家应该遵循以下几条建议。</p>\n<ul>\n<li>用空格（space）表示缩进，而不要用制表符（tab）。</li>\n<li>和语法相关的每一层缩进都用 4 个空格表示。</li>\n<li>每行不超过 79 个字符。</li>\n<li>对于占据多行的长表达式来说，除了首行之外的其余各行都应该在通常的缩进级别之上再加 4 个空格。</li>\n<li>在同一份文件中，函数与类之间用两个空行隔开。</li>\n<li>在同一个类中，方法与方法之间用一个空行隔开。</li>\n<li>使用字典时，键与冒号之间不加空格，写在同一行的冒号和值之间应该加一个空格。</li>\n<li>给变量赋值时，赋值符号的左边和右边各加一个空格，并且只加一个空格就好。</li>\n<li>给变量的类型做注解（annotation）时，不要把变量名和冒号隔开，但在类型信息前应该有一个空格。</li>\n</ul>\n<h3 id="与命名有关的建议"><a href="#%E4%B8%8E%E5%91%BD%E5%90%8D%E6%9C%89%E5%85%B3%E7%9A%84%E5%BB%BA%E8%AE%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>与命名有关的建议</h3>\n<p>PEP 8 建议采用不同的方式来给 Python 代码中的各个部分命名，这样在阅读代码时，就可以根据这些名称看出它们在 Python 语言中的角色。遵循以下与命名相关的建议。</p>\n<ul>\n<li>函数、变量及属性用小写字母来拼写，各单词之间用下划线相连，例如：<code class="language-text">lowercase_underscore</code>。</li>\n<li>受保护的实例属性，用一个下划线开头，例如：<code class="language-text">_leading_underscore</code>。</li>\n<li>私有的实例属性，用两个下划线开头，例如：<code class="language-text">__double_leading_underscore</code>。</li>\n<li>类（包括异常）命名时，每个单词的首字母均大写，例如：CapitalizedWord。</li>\n<li>模块级别的常量，所有字母都大写，各单词之间用下划线相连，例如：<code class="language-text">ALL_CAPS</code>。</li>\n<li>类中的实例方法，应该把第一个参数命名为 self，用来表示该对象本身。</li>\n<li>类方法的第一个参数，应该命名为 cls，用来表示这个类本身。</li>\n</ul>\n<h3 id="与表达式和语句有关的建议"><a href="#%E4%B8%8E%E8%A1%A8%E8%BE%BE%E5%BC%8F%E5%92%8C%E8%AF%AD%E5%8F%A5%E6%9C%89%E5%85%B3%E7%9A%84%E5%BB%BA%E8%AE%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>与表达式和语句有关的建议</h3>\n<p>The Zen of Python 中提到：<code class="language-text">每件事都应该有简单的做法，而且最好只有一种</code>。PEP 8 就试着运用这个理念，来规范表达式和语句的写法。</p>\n<ul>\n<li>采用行内否定，即把否定词直接写在要否定的内容前面，而不要放在整个表达式的前面，例如应该写 <code class="language-text">if a is not b</code>，而不是 <code class="language-text">if not a is b</code>。</li>\n<li>不要通过长度判断容器或序列是不是空的，例如不要通过 <code class="language-text">if len(somelist) == 0</code> 判断 somelist 是否为 <code class="language-text">[]</code> 或 <code class="language-text">&#39;&#39;</code> 等空值，而是应该采用 <code class="language-text">if not somelist</code> 这样的写法来判断，因为 Python 会把空值自动评估为 False。</li>\n<li>如果要判断容器或序列里面有没有内容（比如要判断 somelist 是否为 <code class="language-text">[1]</code> 或 <code class="language-text">&#39;hi&#39;</code> 这样非空的值），也不应该通过长度来判断，而是应该采用 <code class="language-text">if somelist</code> 语句，因为 Python 会把非空的值自动判定为 True。</li>\n<li>不要把 if 语句、for 循环、while 循环及 except 复合语句挤在一行。应该把这些语句分成多行来写，这样更加清晰。</li>\n<li>如果表达式一行写不下，可以用括号将其括起来，而且要适当地添加换行与缩进以便于阅读。多行的表达式，应该用括号括起来，而不要用 <code class="language-text">\\</code> 符号续行。</li>\n</ul>\n<h3 id="与引入有关的建议"><a href="#%E4%B8%8E%E5%BC%95%E5%85%A5%E6%9C%89%E5%85%B3%E7%9A%84%E5%BB%BA%E8%AE%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>与引入有关的建议</h3>\n<p>PEP 8 对于怎样在代码中引入并使用模块，给出了下面几条建议。</p>\n<ul>\n<li>import 语句（含 <code class="language-text">from x import y</code>）总是应该放在文件开头。</li>\n<li>引入模块时，总是应该使用绝对名称，而不应该根据当前模块路径来使用相对名称。例如，要引入 bar 包中的 foo 模块，应该完整地写出 <code class="language-text">from bar import foo</code>，即便当前路径为 bar 包里，也不应该简写为 <code class="language-text">import foo</code>。</li>\n<li>如果一定要用相对名称来编写 import 语句，那就应该明确地写成：<code class="language-text">from . import foo</code>。文件中的 import 语句应该按顺序划分成三个部分：首先引入标准库里的模块，然后引入第三方模块，最后引入自己的模块。属于同一个部分的 import 语句按字母顺序排列。</li>\n</ul>\n<h2 id="第-3-条：了解-bytes-与-str-的区别"><a href="#%E7%AC%AC-3-%E6%9D%A1%EF%BC%9A%E4%BA%86%E8%A7%A3-bytes-%E4%B8%8E-str-%E7%9A%84%E5%8C%BA%E5%88%AB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 3 条：了解 bytes 与 str 的区别</h2>\n<p>Python 有两种类型可以表示字符序列：一种是 bytes，另一种是 str。</p>\n<p>bytes 实例包含的是原始数据，即 8 位的无符号值（通常按照 ASCII 编码标准来显示）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11691150961120743000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = b\'h\\x65llo\'\nprint(list(a))\nprint(a)\n\n>>>\n[104, 101, 108, 108, 111]\nb\'hello\'`, `11691150961120743000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token string">b\'h\\x65llo\'</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">104</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">108</span><span class="token punctuation">,</span> <span class="token number">108</span><span class="token punctuation">,</span> <span class="token number">111</span><span class="token punctuation">]</span>\n<span class="token string">b\'hello\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>str 实例包含的是 Unicode 码点（code point，也叫作代码点），这些码点与人类语言之中的文本字符相对应。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23401986560990884000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = \'a\\u0300 propos\'\nprint(list(a))\nprint(a)\n\n>>>\n[\'a\', \'̀\', \' \', \'p\', \'r\', \'o\', \'p\', \'o\', \'s\']\nà propos`, `23401986560990884000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token string">\'a\\u0300 propos\'</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'̀\'</span><span class="token punctuation">,</span> <span class="token string">\' \'</span><span class="token punctuation">,</span> <span class="token string">\'p\'</span><span class="token punctuation">,</span> <span class="token string">\'r\'</span><span class="token punctuation">,</span> <span class="token string">\'o\'</span><span class="token punctuation">,</span> <span class="token string">\'p\'</span><span class="token punctuation">,</span> <span class="token string">\'o\'</span><span class="token punctuation">,</span> <span class="token string">\'s\'</span><span class="token punctuation">]</span>\nà propos</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>两种不同的字符类型与 Python 中两种常见的使用情况相对应：</p>\n<ul>\n<li>开发者需要操作原始的 8 位值序列，序列里面的这些 8 位值合起来表示一个应该按 UTF-8 或其他标准编码的字符串。</li>\n<li>开发者需要操作通用的 Unicode 字符串，而不是操作某种特定编码的字符串。</li>\n</ul>\n<p>我们通常需要编写两个辅助函数，以便在这两种情况之间转换，确保输入值类型符合开发者的预期形式。</p>\n<p>第一个辅助函数接受 bytes 或 str 实例，并返回 str：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57924384890328850000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def to_str(bytes_or_str):\n    if isinstance(bytes_or_str, bytes):\n        value = bytes_or_str.decode(\'utf-8\')\n    else:\n        value = bytes_or_str\n    return value # Instance of str\n\nprint(repr(to_str(b\'foo\')))\nprint(repr(to_str(\'bar\')))\n\n>>>\n\'foo\'\n\'bar\'`, `57924384890328850000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">to_str</span><span class="token punctuation">(</span>bytes_or_str<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>bytes_or_str<span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        value <span class="token operator">=</span> bytes_or_str<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">\'utf-8\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        value <span class="token operator">=</span> bytes_or_str\n    <span class="token keyword">return</span> value <span class="token comment"># Instance of str</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">repr</span><span class="token punctuation">(</span>to_str<span class="token punctuation">(</span><span class="token string">b\'foo\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">repr</span><span class="token punctuation">(</span>to_str<span class="token punctuation">(</span><span class="token string">\'bar\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token string">\'foo\'</span>\n<span class="token string">\'bar\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>第二个辅助函数也接受 bytes 或 str 实例，但它返回的是 bytes：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21316824942818034000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def to_bytes(bytes_or_str):\n    if isinstance(bytes_or_str, str):\n        value = bytes_or_str.encode(\'utf-8\')\n    else:\n        value = bytes_or_str\n    return value # Instance of bytes\n\nprint(repr(to_bytes(b\'foo\')))\nprint(repr(to_bytes(\'bar\')))\n\n>>>\nb\'foo\'\nb\'bar\'`, `21316824942818034000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">to_bytes</span><span class="token punctuation">(</span>bytes_or_str<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>bytes_or_str<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        value <span class="token operator">=</span> bytes_or_str<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">\'utf-8\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        value <span class="token operator">=</span> bytes_or_str\n    <span class="token keyword">return</span> value <span class="token comment"># Instance of bytes</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">repr</span><span class="token punctuation">(</span>to_bytes<span class="token punctuation">(</span><span class="token string">b\'foo\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">repr</span><span class="token punctuation">(</span>to_bytes<span class="token punctuation">(</span><span class="token string">\'bar\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token string">b\'foo\'</span>\n<span class="token string">b\'bar\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 Python 中使用原始的 8 位值与 Unicode 字符串时，有两个问题要注意。</p>\n<p>第一个问题是，bytes 与 str 这两种类型似乎是以相同的方式工作的，但其实例并不相互兼容，所以在传递字符序列的时候必须考虑好其类型。</p>\n<p>可以用 + 操作符将 bytes 添加到 bytes，str 也可以这样。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69428799594274750000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`print(b\'one\' + b\'two\')\nprint(\'one\' + \'two\')\n\n>>>\nb\'onetwo\'\nonetwo`, `69428799594274750000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">b\'one\'</span> <span class="token operator">+</span> <span class="token string">b\'two\'</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'one\'</span> <span class="token operator">+</span> <span class="token string">\'two\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token string">b\'onetwo\'</span>\nonetwo</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是不能将 str 实例添加到 bytes 实例：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25480554112696852000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`b\'one\' + \'two\'\n\n>>>\nTraceback ...\nTypeError: can\'t concat str to bytes`, `25480554112696852000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token string">b\'one\'</span> <span class="token operator">+</span> <span class="token string">\'two\'</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> can\'t concat <span class="token builtin">str</span> to <span class="token builtin">bytes</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>也不能将 bytes 实例添加到 str 实例：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98585564874436020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\'one\' + b\'two\'\n\n>>>\nTraceback ...\nTypeError: can only concatenate str (not &quot;bytes&quot;) to str`, `98585564874436020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token string">\'one\'</span> <span class="token operator">+</span> <span class="token string">b\'two\'</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> can only concatenate <span class="token builtin">str</span> <span class="token punctuation">(</span><span class="token keyword">not</span> <span class="token string">"bytes"</span><span class="token punctuation">)</span> to <span class="token builtin">str</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>bytes 与 bytes 之间可以用二元操作符（binary operator）来比较大小，str 与 str 之间也可以：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94283459030668030000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`assert b\'red\' > b\'blue\'\nassert \'red\' > \'blue\'`, `94283459030668030000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">assert</span> <span class="token string">b\'red\'</span> <span class="token operator">></span> <span class="token string">b\'blue\'</span>\n<span class="token keyword">assert</span> <span class="token string">\'red\'</span> <span class="token operator">></span> <span class="token string">\'blue\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>但是 str 实例不能与 bytes 实例比较：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17228769199743121000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`assert \'red\' > b\'blue\'\n\n>>>\nTraceback ...\nTypeError: \'>\' not supported between instances of \'str\' and \'bytes\'`, `17228769199743121000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">assert</span> <span class="token string">\'red\'</span> <span class="token operator">></span> <span class="token string">b\'blue\'</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> <span class="token string">\'>\'</span> <span class="token keyword">not</span> supported between instances of <span class="token string">\'str\'</span> <span class="token keyword">and</span> <span class="token string">\'bytes\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>反过来也一样，也就是说 bytes 实例不能与 str 实例比较：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33400703577449840000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`assert b\'blue\' < \'red\'\n\n>>>\nTraceback ...\nTypeError: \'<\' not supported between instances of \'bytes\' and \'str\'`, `33400703577449840000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">assert</span> <span class="token string">b\'blue\'</span> <span class="token operator">&lt;</span> <span class="token string">\'red\'</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> <span class="token string">\'&lt;\'</span> <span class="token keyword">not</span> supported between instances of <span class="token string">\'bytes\'</span> <span class="token keyword">and</span> <span class="token string">\'str\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>判断 bytes 与 str 实例是否相等，总是会评估为假（False），即便这两个实例表示的字符完全相同，它们也不相等。例如，在下面这个例子里，它们表示的字符串都相当于 ASCII 编码之中的 foo。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18421673346878697000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`print(b\'foo\' == \'foo\')\n\n>>>\nFalse`, `18421673346878697000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">b\'foo\'</span> <span class="token operator">==</span> <span class="token string">\'foo\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token boolean">False</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>两种类型的实例都可以出现在 % 操作符的右侧，用来替换左侧那个格式字符串（format string）里面的 %s。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99320717257910630000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`print(b\'red %s\' % b\'blue\')\nprint(\'red %s\' % \'blue\')\n\n>>>\nb\'red blue\'\nred blue`, `99320717257910630000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">b\'red %s\'</span> <span class="token operator">%</span> <span class="token string">b\'blue\'</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'red %s\'</span> <span class="token operator">%</span> <span class="token string">\'blue\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token string">b\'red blue\'</span>\nred blue</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果格式字符串是 bytes 类型，那么不能用 str 实例来替换其中的 %s，因为 Python 不知道这个 str 应该按照什么方案来编码。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64435687017928880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`print(b\'red %s\' % \'blue\')\n\n>>>\nTraceback ...\nTypeError: %b requires a bytes-like object, or an object that implements _bytes_, not \'str\'`, `64435687017928880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">b\'red %s\'</span> <span class="token operator">%</span> <span class="token string">\'blue\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> <span class="token operator">%</span>b requires a <span class="token builtin">bytes</span><span class="token operator">-</span>like <span class="token builtin">object</span><span class="token punctuation">,</span> <span class="token keyword">or</span> an <span class="token builtin">object</span> that implements _bytes_<span class="token punctuation">,</span> <span class="token keyword">not</span> <span class="token string">\'str\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但反过来却可以，也就是说如果格式字符串是 str 类型，则可以用 bytes 实例来替换其中的 %s，问题是这可能跟你想要的结果不一样。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71695517326075330000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`print(\'red %s\' % b\'blue\')\n\n>>>\nred b\'blue\'`, `71695517326075330000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'red %s\'</span> <span class="token operator">%</span> <span class="token string">b\'blue\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nred <span class="token string">b\'blue\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样做，会让系统在 bytes 实例上面调用 <code class="language-text">__repr__</code> 方法（参见第 75 条），然后用这次调用所得到的结果替换格式字符串里的 %s，因此程序会直接输出 <code class="language-text">b&#39;blue&#39;</code>，而不是像你想的那样，输出 blue 本身。</p>\n<p>第二个问题发生在操作文件句柄的时候，这里的句柄指由内置的 open 函数返回的句柄。这样的句柄默认需要使用 Unicode 字符串操作，而不能采用原始的 bytes。习惯了 Python 2 的开发者，尤其容易碰到这个问题，进而导致程序出现奇怪的错误。例如，向文件写入二进制数据的时候，下面这种写法其实是错误的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54886775737983040000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`with open(\'data.bin\', \'w\') as f:\n   f.write(b\'\\xf1\\xf2\\xf3\\xf4\\xf5\')\n\n>>>\nTraceback ...\nTypeError: write() argument must be str, not bytes`, `54886775737983040000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'data.bin\'</span><span class="token punctuation">,</span> <span class="token string">\'w\'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>\n   f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">b\'\\xf1\\xf2\\xf3\\xf4\\xf5\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> write<span class="token punctuation">(</span><span class="token punctuation">)</span> argument must be <span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token keyword">not</span> <span class="token builtin">bytes</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>程序发生异常是因为在调用 open 函数时，指定的是 <code class="language-text">&#39;w&#39;</code> 模式，所以系统要求必须以文本模式写入。如果想用二进制模式，那应该指定 <code class="language-text">&#39;wb&#39;</code> 才对。在文本模式下，write 方法接受的是包含 Unicode 数据的 str 实例，不是包含二进制数据的 bytes 实例。所以，我们得把模式改成 <code class="language-text">&#39;wb&#39;</code> 来解决该问题。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82420267524226960000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`with open(\'data.bin\', \'wb\') as f:\n   f.write(b\'\\xf1\\xf2\\xf3\\xf4\\xf5\')`, `82420267524226960000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'data.bin\'</span><span class="token punctuation">,</span> <span class="token string">\'wb\'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>\n   f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">b\'\\xf1\\xf2\\xf3\\xf4\\xf5\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>读取文件的时候也有类似的问题。例如，如果要把刚才写入的二进制文件读出来，那么不能用下面这种写法，同样需要改成 <code class="language-text">&#39;rb&#39;</code></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96519481315158770000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`with open(\'data.bin\', \'r\') as f:\n   data = f.read()\n\n>>>\nTraceback ...\nUnicodeDecodeError: \'utf-8\' codec can\'t decode byte 0xf1 in position 0: invalid continuation byte`, `96519481315158770000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'data.bin\'</span><span class="token punctuation">,</span> <span class="token string">\'r\'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>\n   data <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nUnicodeDecodeError<span class="token punctuation">:</span> <span class="token string">\'utf-8\'</span> codec can\'t decode byte <span class="token number">0xf1</span> <span class="token keyword">in</span> position <span class="token number">0</span><span class="token punctuation">:</span> invalid continuation byte</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>另一种改法是在调用 open 函数的时候，通过 encoding 参数明确指定编码标准，以确保平台特有的一些行为不会干扰代码的运行效果。例如，假设刚才写到文件里的那些二进制数据表示的是一个采用 ‘cp1252’ 标准（cp1252 是一种老式的 Windows 编码方案）来编码的字符串，则可以这样写</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86063829392300870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`with open(\'data.bin\', \'r\', encoding=\'cp1252\') as f:\n   data f.read()\n\nassert data == \'ioooδ\'`, `86063829392300870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'data.bin\'</span><span class="token punctuation">,</span> <span class="token string">\'r\'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">\'cp1252\'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>\n   data f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token keyword">assert</span> data <span class="token operator">==</span> <span class="token string">\'ioooδ\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样程序就不会出现异常了，但返回的字符串也与读取原始字节数据所返回的有很大区别。通过这个例子，我们要提醒自己注意当前操作系统默认的编码标准（可以执行 <code class="language-text">python3 -c &#39;import locale; print(locale.getpreferredencoding())&#39;</code> 命令查看），了解它与你所期望的是否一致。如果不确定，那就在调用 open 时明确指定 encoding 参数。</p>\n<h2 id="第-4-条：用支持插值的-f-string-取代-c-风格的格式字符串与-strformat-方法"><a href="#%E7%AC%AC-4-%E6%9D%A1%EF%BC%9A%E7%94%A8%E6%94%AF%E6%8C%81%E6%8F%92%E5%80%BC%E7%9A%84-f-string-%E5%8F%96%E4%BB%A3-c-%E9%A3%8E%E6%A0%BC%E7%9A%84%E6%A0%BC%E5%BC%8F%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%B8%8E-strformat-%E6%96%B9%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 4 条：用支持插值的 f-string 取代 C 风格的格式字符串与 str.format 方法</h2>\n<p>Python 里面最常用的字符串格式化方式是采用 % 格式化操作符。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69104388684948280000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = 0b10111011\nb = 0xc5f\nprint(\'Binary is %d, hex is %d\' % (a, b))\n\n>>>\nBinary is 187, hex is 3167`, `69104388684948280000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token number">0b10111011</span>\nb <span class="token operator">=</span> <span class="token number">0xc5f</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Binary is %d, hex is %d\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBinary <span class="token keyword">is</span> <span class="token number">187</span><span class="token punctuation">,</span> <span class="token builtin">hex</span> <span class="token keyword">is</span> <span class="token number">3167</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是 C 风格的格式字符串，在 Python 里有四个缺点。</p>\n<ol>\n<li>\n<p>如果 % 右侧那个元组里面的值在类型或顺序上有变化，那么程序可能会因为转换类型时发生不兼容问题而出现错误。例如，下面这个简单的格式化表达式是正确的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16070024027495088000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`key = \'my_var\'\nvalue = 1.234\nformatted = \'%-10s = %.2f\' % (key, value)\nprint(formatted)\n\n>>>\nmy_var     = 1.23`, `16070024027495088000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">key <span class="token operator">=</span> <span class="token string">\'my_var\'</span>\nvalue <span class="token operator">=</span> <span class="token number">1.234</span>\nformatted <span class="token operator">=</span> <span class="token string">\'%-10s = %.2f\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>formatted<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nmy_var     <span class="token operator">=</span> <span class="token number">1.23</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但如果把 key 跟 value 互换位置，那么程序就会在运行时出现异常。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11023379895531549000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`reordered_tuple = \'%-10s = %.2f\' % (value, key)\n\n>>>\nTraceback ...\nTypeError: must be real number, not str`, `11023379895531549000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">reordered_tuple <span class="token operator">=</span> <span class="token string">\'%-10s = %.2f\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>value<span class="token punctuation">,</span> key<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> must be real number<span class="token punctuation">,</span> <span class="token keyword">not</span> <span class="token builtin">str</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果 % 右侧的写法不变，但左侧那个格式字符串里面的两个说明符对调了顺序，那么程序同样会发生这个错误。</p>\n</li>\n<li>\n<p>在填充模板之前，经常要先对准备填写进去的这个值稍微做一些处理，但这样一来，整个表达式可能就会写得很长，让人觉得比较混乱。下面这段代码用来罗列厨房里的各种食材，现在的这种写法并没有对填入格式字符串里面的那三个值（也就是食材的编号 i、食材的名称 item，以及食材的数量 count）预先做出调整。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78938318150108920000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pantry = [\n  (\'avocados\', 1.25),\n  (\'bananas\', 2.5),\n  (\'cherries\', 15),\n]\n\nfor i, (item, count) in enumerate(pantry):\n  print(\'#%d: %-10s = %.2f\' % (i, item, count))\n\n>>>\n#0: avocados   = 1.25\n#1: bananas    = 2.50\n#2: cherries   = 15.00`, `78938318150108920000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">pantry <span class="token operator">=</span> <span class="token punctuation">[</span>\n  <span class="token punctuation">(</span><span class="token string">\'avocados\'</span><span class="token punctuation">,</span> <span class="token number">1.25</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n  <span class="token punctuation">(</span><span class="token string">\'bananas\'</span><span class="token punctuation">,</span> <span class="token number">2.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n  <span class="token punctuation">(</span><span class="token string">\'cherries\'</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">]</span>\n\n<span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>item<span class="token punctuation">,</span> count<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>pantry<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'#%d: %-10s = %.2f\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> item<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token comment">#0: avocados   = 1.25</span>\n<span class="token comment">#1: bananas    = 2.50</span>\n<span class="token comment">#2: cherries   = 15.00</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果想让打印出来的信息更好懂，那可能得把这几个值稍微调整一下，但是调整之后，% 操作符右侧的那个三元组就特别长，所以需要多行拆分才能写得下，这会影响程序的可读性。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49441524431734150000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pantry = [\n  (\'avocados\', 1.25),\n  (\'bananas\', 2.5),\n  (\'cherries\', 15),\n]\n\nfor i, (item, count) in enumerate(pantry):\n  print(\'#%d: %-10s = %d\' % (\n     i + 1,\n     item.title(),\n     round(count)))\n\n>>>\n#1: Avocados   = 1\n#2: Bananas    = 2\n#3: Cherries   = 15`, `49441524431734150000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">pantry <span class="token operator">=</span> <span class="token punctuation">[</span>\n  <span class="token punctuation">(</span><span class="token string">\'avocados\'</span><span class="token punctuation">,</span> <span class="token number">1.25</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n  <span class="token punctuation">(</span><span class="token string">\'bananas\'</span><span class="token punctuation">,</span> <span class="token number">2.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n  <span class="token punctuation">(</span><span class="token string">\'cherries\'</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">]</span>\n\n<span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>item<span class="token punctuation">,</span> count<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>pantry<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'#%d: %-10s = %d\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>\n     i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>\n     item<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n     <span class="token builtin">round</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token comment">#1: Avocados   = 1</span>\n<span class="token comment">#2: Bananas    = 2</span>\n<span class="token comment">#3: Cherries   = 15</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>如果想用同一个值来填充格式字符串里的多个位置，那么必须在 % 操作符右侧的元组中相应地多次重复该值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87792525880768270000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`template = \'%s loves food. See %s cook.\'\nname = \'Max\'\nformatted = template % (name, name)\nprint(formatted)\n\n>>>\nMax loves food. See Max cook.`, `87792525880768270000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">template <span class="token operator">=</span> <span class="token string">\'%s loves food. See %s cook.\'</span>\nname <span class="token operator">=</span> <span class="token string">\'Max\'</span>\nformatted <span class="token operator">=</span> template <span class="token operator">%</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> name<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>formatted<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nMax loves food<span class="token punctuation">.</span> See Max cook<span class="token punctuation">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果想在填充之前把这个值修改一下，那么必须同时修改多处才行，这尤其烦人，且容易出错。例如，如果这次要填的不是 name 而是 name.title()，那就必须提醒自己，要把所有的 name 都改成 name.title()。若是有的地方改了，有的地方没改，那输出的信息可能就不一致了。</p>\n<p>为了解决上面提到的一些问题，Python 的 % 操作符允许我们用 dict 取代 tuple，这样的话，我们就可以让格式字符串里面的说明符与 dict 里面的键以相应的名称对应起来，例如 %(key)s 这个说明符，意思就是用字符串（s）来表示 dict 里面名为 key 的那个键所保存的值。下面通过这种办法解决刚才讲的第一个缺点，也就是 % 操作符两侧的顺序不匹配问题。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81517857984243090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`key = \'my_var\'\nvalue = 1.234\nold_way = \'%-10s = %.2f\' % (key, value)\n\nnew_way = \'%(key)-10s = %(value).2f\' % {\n  \'key\': key, \'value\': value}  # Original\n\nreordered = \'%(key)-10s = %(value).2f\' % {\n  \'value\': value, \'key\': key}  # Swapped\n\nassert old_way == new_way == reordered`, `81517857984243090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">key <span class="token operator">=</span> <span class="token string">\'my_var\'</span>\nvalue <span class="token operator">=</span> <span class="token number">1.234</span>\nold_way <span class="token operator">=</span> <span class="token string">\'%-10s = %.2f\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n\nnew_way <span class="token operator">=</span> <span class="token string">\'%(key)-10s = %(value).2f\'</span> <span class="token operator">%</span> <span class="token punctuation">{</span>\n  <span class="token string">\'key\'</span><span class="token punctuation">:</span> key<span class="token punctuation">,</span> <span class="token string">\'value\'</span><span class="token punctuation">:</span> value<span class="token punctuation">}</span>  <span class="token comment"># Original</span>\n\nreordered <span class="token operator">=</span> <span class="token string">\'%(key)-10s = %(value).2f\'</span> <span class="token operator">%</span> <span class="token punctuation">{</span>\n  <span class="token string">\'value\'</span><span class="token punctuation">:</span> value<span class="token punctuation">,</span> <span class="token string">\'key\'</span><span class="token punctuation">:</span> key<span class="token punctuation">}</span>  <span class="token comment"># Swapped</span>\n\n<span class="token keyword">assert</span> old_way <span class="token operator">==</span> new_way <span class="token operator">==</span> reordered</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种写法还可以解决刚才讲的第三个缺点，也就是用同一个值替换多个格式说明符的问题。改用这种写法之后，我们就不用在 % 操作符右侧重复这个值了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44775801933274440000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`name = \'Max\'\ntemplate = \'%s loves food .See %s cook.\'\nbefore = template % (name, name)  # Tuple\ntemplate = \'%(name)s loves food .See %(name)s cook.\'\nafter = template % {\'name\': name}  # Dictionary\nassert before == after`, `44775801933274440000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">name <span class="token operator">=</span> <span class="token string">\'Max\'</span>\ntemplate <span class="token operator">=</span> <span class="token string">\'%s loves food .See %s cook.\'</span>\nbefore <span class="token operator">=</span> template <span class="token operator">%</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> name<span class="token punctuation">)</span>  <span class="token comment"># Tuple</span>\ntemplate <span class="token operator">=</span> <span class="token string">\'%(name)s loves food .See %(name)s cook.\'</span>\nafter <span class="token operator">=</span> template <span class="token operator">%</span> <span class="token punctuation">{</span><span class="token string">\'name\'</span><span class="token punctuation">:</span> name<span class="token punctuation">}</span>  <span class="token comment"># Dictionary</span>\n<span class="token keyword">assert</span> before <span class="token operator">==</span> after</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是，这种写法会让刚才讲的第二个缺点变得更加严重，因为字典格式字符串的引入，我们必须给每一个值都定义键名，而且要在键名的右侧加冒号，格式化表达式变得更加冗长，看起来也更加混乱。我们把不采用 dict 的写法与采用 dict 的写法对比一下，可以更明确地意识到这种写法的缺点。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26527480968748306000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pantry = [\n(\'avocados\', 1.25),\n(\'bananas\', 2.5),\n(\'cherries\', 15),\n]\n\nfor i, (item, count) in enumerate(pantry):\n  before = \'#%d: %-10s = %d\' % (\n     i + 1,\n     item.title(),\n     round(count)\n  )\n  after = \'#%(loop)d: %(item)-10s = %(count)d\' % {\n     \'loop\': i + 1,\n     \'item\': item.title(),\n     \'count\': round(count),\n  }\n\n  assert before == after`, `26527480968748306000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">pantry <span class="token operator">=</span> <span class="token punctuation">[</span>\n<span class="token punctuation">(</span><span class="token string">\'avocados\'</span><span class="token punctuation">,</span> <span class="token number">1.25</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">(</span><span class="token string">\'bananas\'</span><span class="token punctuation">,</span> <span class="token number">2.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">(</span><span class="token string">\'cherries\'</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">]</span>\n\n<span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>item<span class="token punctuation">,</span> count<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>pantry<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  before <span class="token operator">=</span> <span class="token string">\'#%d: %-10s = %d\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>\n     i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>\n     item<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n     <span class="token builtin">round</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n  <span class="token punctuation">)</span>\n  after <span class="token operator">=</span> <span class="token string">\'#%(loop)d: %(item)-10s = %(count)d\'</span> <span class="token operator">%</span> <span class="token punctuation">{</span>\n     <span class="token string">\'loop\'</span><span class="token punctuation">:</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>\n     <span class="token string">\'item\'</span><span class="token punctuation">:</span> item<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n     <span class="token string">\'count\'</span><span class="token punctuation">:</span> <span class="token builtin">round</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">assert</span> before <span class="token operator">==</span> after</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>把 dict 写到格式化表达式里面会让代码变多。每个键都至少要写两次：一次是在格式说明符中，还有一次是在字典中作为键，另外，定义字典的时候，可能还要专门用一个变量来表示这个键所对应的值，而且这个变量的名称或许也和键名相同，这样算下来就是三次了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93704478579337840000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`soup = \'lentil\'\nformatted = \'Today\\\'s soup is %(soup)s.\' % {\'soup\': soup}\nprint(formatted)\n\n>>>\nToday\'s soup is lentil.`, `93704478579337840000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">soup <span class="token operator">=</span> <span class="token string">\'lentil\'</span>\nformatted <span class="token operator">=</span> <span class="token string">\'Today\\\'s soup is %(soup)s.\'</span> <span class="token operator">%</span> <span class="token punctuation">{</span><span class="token string">\'soup\'</span><span class="token punctuation">:</span> soup<span class="token punctuation">}</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>formatted<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nToday\'s soup <span class="token keyword">is</span> lentil<span class="token punctuation">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>除了要反复写键名，在格式化表达式里面使用 dict 的办法还会让表达式变得特别长，通常必须拆分为多行来写，同时，为了与格式字符串的多行写法相对应，定义字典的时候，也要一行一行地给每个键设定对应的值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2610800026379456000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`menu = {\n\'soup\': \'lentil\',\n\'oyster\': \'kumamoto\',\n\'special\': \'schnitzel\',\n}\n\ntemplate = (\'Today\\\'s soup is %(soup)s, \'\n           \'buy one get two %(oyster)s oysters, \'\n           \'and our special entree is %(special)s.\')\nformatted = template % menu\nprint(formatted)\n\n>>>\nToday\'s soup is lentil, buy one get two kumamoto oysters, and our special entree is schnitzel.`, `2610800026379456000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">menu <span class="token operator">=</span> <span class="token punctuation">{</span>\n<span class="token string">\'soup\'</span><span class="token punctuation">:</span> <span class="token string">\'lentil\'</span><span class="token punctuation">,</span>\n<span class="token string">\'oyster\'</span><span class="token punctuation">:</span> <span class="token string">\'kumamoto\'</span><span class="token punctuation">,</span>\n<span class="token string">\'special\'</span><span class="token punctuation">:</span> <span class="token string">\'schnitzel\'</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\ntemplate <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">\'Today\\\'s soup is %(soup)s, \'</span>\n           <span class="token string">\'buy one get two %(oyster)s oysters, \'</span>\n           <span class="token string">\'and our special entree is %(special)s.\'</span><span class="token punctuation">)</span>\nformatted <span class="token operator">=</span> template <span class="token operator">%</span> menu\n<span class="token keyword">print</span><span class="token punctuation">(</span>formatted<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nToday\'s soup <span class="token keyword">is</span> lentil<span class="token punctuation">,</span> buy one get two kumamoto oysters<span class="token punctuation">,</span> <span class="token keyword">and</span> our special entree <span class="token keyword">is</span> schnitzel<span class="token punctuation">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>为了查看格式字符串中的说明符究竟对应于字典里的哪个键，必须在这两段代码之间来回跳跃，这会令人难以发现其中的 bug。如果要对键名稍做修改，那么必须同步修改格式字符串里的说明符，这更让代码变得相当烦琐，可读性更差。</p>\n</li>\n</ol>\n<h3 id="内置的-format-函数与-str-类的-format-方法"><a href="#%E5%86%85%E7%BD%AE%E7%9A%84-format-%E5%87%BD%E6%95%B0%E4%B8%8E-str-%E7%B1%BB%E7%9A%84-format-%E6%96%B9%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>内置的 format 函数与 str 类的 format 方法</h3>\n<p>Python 3 添加了高级字符串格式化（advanced string formatting）机制，它的表达能力比老式 C 风格的格式字符串要强，且不再使用 % 操作符。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12004588591763255000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = 1234.5678\nformatted = format(a, \',.2f\')\nprint(formatted)\nb = \'my string\'\nformatted = format(b, \'^20s\')\nprint(\'*\', formatted, \'*\')\n\n>>>\n1,234.57\n*      my string       *`, `12004588591763255000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token number">1234.5678</span>\nformatted <span class="token operator">=</span> <span class="token builtin">format</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token string">\',.2f\'</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>formatted<span class="token punctuation">)</span>\nb <span class="token operator">=</span> <span class="token string">\'my string\'</span>\nformatted <span class="token operator">=</span> <span class="token builtin">format</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token string">\'^20s\'</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'*\'</span><span class="token punctuation">,</span> formatted<span class="token punctuation">,</span> <span class="token string">\'*\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">1</span><span class="token punctuation">,</span><span class="token number">234.57</span>\n<span class="token operator">*</span>      my string       <span class="token operator">*</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12955136718884618000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`key = \'my_var\'\nvalue = 1.234\n\nformatted = \'{} = {}\'.format(key, value)\nprint(formatted)\n\n>>>\nmy_var = 1.234`, `12955136718884618000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">key <span class="token operator">=</span> <span class="token string">\'my_var\'</span>\nvalue <span class="token operator">=</span> <span class="token number">1.234</span>\n\nformatted <span class="token operator">=</span> <span class="token string">\'{} = {}\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>formatted<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nmy_var <span class="token operator">=</span> <span class="token number">1.234</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>你可以在 {} 里写个冒号，然后把格式说明符写在冒号的右边，用以规定 format 方法所接收的这个值应该按照怎样的格式来调整。在 Python 解释器里输入 help(‘FORMATTING’)，可以详细查看 str.format 使用的这套格式说明符所依据的规则。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50181322931503284000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`key = \'my_var\'\nvalue = 1.234\n\nformatted = \'{:<10} = {:.2f}\'.format(key, value)\nprint(formatted)\n\n>>>\nmy_var     = 1.23`, `50181322931503284000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">key <span class="token operator">=</span> <span class="token string">\'my_var\'</span>\nvalue <span class="token operator">=</span> <span class="token number">1.234</span>\n\nformatted <span class="token operator">=</span> <span class="token string">\'{:&lt;10} = {:.2f}\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>formatted<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nmy_var     <span class="token operator">=</span> <span class="token number">1.23</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>运行过程：系统先把 str.format 方法接收到的每个值传给内置的 format 函数，并找到这个值在字符串里对应的 {}，同时将 {} 里面写的格式也传给 format 函数，例如系统在处理 value 的时候，传的就是 format(value, ‘.2f’)。然后，系统会把 format 函数所返回的结果写在整个格式化字符串 {} 所在的位置。另外，每个类都可以通过 <code class="language-text">__format__</code> 这个特殊的方法定制相应的逻辑，这样的话，format 函数在把该类实例转换成字符串时，就会按照这种逻辑来转换。</p>\n<p>C 风格的格式字符串采用 % 操作符来引导格式说明符，所以如果要将这个符号照原样输出，那就必须转义，也就是连写两个 %。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98001591707375760000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`print(\'%.2f%%\' % 12.5)\nprint(\'{} replaces {{}}\'.format(1.23))\n\n>>>\n12.50%\n1.23 replaces {}`, `98001591707375760000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'%.2f%%\'</span> <span class="token operator">%</span> <span class="token number">12.5</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'{} replaces {{}}\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token number">1.23</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">12.50</span><span class="token operator">%</span>\n<span class="token number">1.23</span> replaces <span class="token punctuation">{</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>调用 str.format 方法的时候，也可以给 str 的 {} 里面写上数字，用来指代 format 方法在这个位置所接收到的参数值位置索引。以后即使这些 {} 在格式字符串中的次序有所变动，也不用调换传给 format 方法的那些参数。于是，这就避免了前面讲的第一个缺点所提到的那个顺序问题。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90796155596725980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`key = \'my_var\'\nvalue = 1.234\n\nformatted = \'{1} = {0}\'.format(key, value)\nprint(formatted)\n\n>>>\n1.234 = my_var`, `90796155596725980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">key <span class="token operator">=</span> <span class="token string">\'my_var\'</span>\nvalue <span class="token operator">=</span> <span class="token number">1.234</span>\n\nformatted <span class="token operator">=</span> <span class="token string">\'{1} = {0}\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>formatted<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">1.234</span> <span class="token operator">=</span> my_var</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>同一个位置索引可以出现在 str 的多个 {} 里面，这些 {} 指代的都是 format 方法在对应位置所收到的值。这就不需要把这个值重复地传给 format 方法，于是就解决了前面提到的第三个缺点。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77011648711124390000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`name = \'Max\'\nformatted = \'{0} loves food. See {0} cook.\'.format(name)\nprint(formatted)\n\n>>>\nMax loves food. See Max cook.`, `77011648711124390000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">name <span class="token operator">=</span> <span class="token string">\'Max\'</span>\nformatted <span class="token operator">=</span> <span class="token string">\'{0} loves food. See {0} cook.\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>formatted<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nMax loves food<span class="token punctuation">.</span> See Max cook<span class="token punctuation">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然而，这个新的 str.format 方法并没有解决上面讲的第二个缺点。如果在对值做填充之前要先对这个值做出调整，那么用这种方法写出来的代码还是跟原来一样乱，阅读性差。把原来那种写法和现在的新写法对比一下，大家就会看到新写法并不比原来好多少。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66976865219643965000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pantry = [\n    (\'avocados\', 1.25),\n    (\'bananas\', 2.5),\n    (\'cherries\', 15),\n]\n\nfor i, (item, count) in enumerate(pantry):\n    old_style = \'#%d: %-10s = %d\' % (\n        i + 1,\n        item.title(),\n        round(count))\n    new_style = \'#{}: {:<10s} = {}\'.format(\n        i + 1,\n        item.title(),\n        round(count))\n    assert old_style == new_style`, `66976865219643965000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">pantry <span class="token operator">=</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">(</span><span class="token string">\'avocados\'</span><span class="token punctuation">,</span> <span class="token number">1.25</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">(</span><span class="token string">\'bananas\'</span><span class="token punctuation">,</span> <span class="token number">2.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">(</span><span class="token string">\'cherries\'</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">]</span>\n\n<span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>item<span class="token punctuation">,</span> count<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>pantry<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    old_style <span class="token operator">=</span> <span class="token string">\'#%d: %-10s = %d\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>\n        i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>\n        item<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        <span class="token builtin">round</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span>\n    new_style <span class="token operator">=</span> <span class="token string">\'#{}: {:&lt;10s} = {}\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>\n        i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>\n        item<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        <span class="token builtin">round</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token keyword">assert</span> old_style <span class="token operator">==</span> new_style</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当然，这种 {} 形式的说明符，还支持一些比较高级的用法，例如可以查询 dict 中某个键的值，可以访问 list 里某个位置的元素，还可以把值转化成 Unicode 或 repr 字符串。下面这段代码把这三项特性结合了起来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14528617269343336000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`menu = {\n    \'soup\': \'lentil\',\n    \'oyster\': \'kumamoto\',\n    \'special\': \'schnitzel\',\n}\n\nformatted = \'First letter is {menu[oyster][0]!r}\'.format(\n    menu=menu)\nprint(formatted)\n\n>>>\nFirst letter is \'k\'`, `14528617269343336000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">menu <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'soup\'</span><span class="token punctuation">:</span> <span class="token string">\'lentil\'</span><span class="token punctuation">,</span>\n    <span class="token string">\'oyster\'</span><span class="token punctuation">:</span> <span class="token string">\'kumamoto\'</span><span class="token punctuation">,</span>\n    <span class="token string">\'special\'</span><span class="token punctuation">:</span> <span class="token string">\'schnitzel\'</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\nformatted <span class="token operator">=</span> <span class="token string">\'First letter is {menu[oyster][0]!r}\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>\n    menu<span class="token operator">=</span>menu<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>formatted<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nFirst letter <span class="token keyword">is</span> <span class="token string">\'k\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是这些特性，依然不能解决前面提到的第四个缺点，也就是键名需要多次重复的那个问题。下面把 C 风格的格式化表达式与新的 str.format 方法对比一下，看看这两种写法在处理键值对形式的数据时有什么区别。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36762492695609140000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`old_template = (\n    \'Today\\\'s soup is %(soup)s, \'\n    \'buy one get two %(oyster)s oysters, \'\n    \'and our special entree is %(special)s.\')\nold_formatted = old_template % {\n    \'soup\': \'lentil\',\n    \'oyster\': \'kumamoto\',\n    \'special\': \'schnitzel\',\n}\n\nnew_template = (\n    \'Today\\\'s soup is {soup}, \'\n    \'buy one get two {oyster} oysters, \'\n    \'and our special entree is {special}.\')\nnew_formatted = new_template.format(\n    soup=\'lentil\',\n    oyster=\'kumamoto\',\n    special=\'schnitzel\',\n)\n\nassert old_formatted == new_formatted`, `36762492695609140000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">old_template <span class="token operator">=</span> <span class="token punctuation">(</span>\n    <span class="token string">\'Today\\\'s soup is %(soup)s, \'</span>\n    <span class="token string">\'buy one get two %(oyster)s oysters, \'</span>\n    <span class="token string">\'and our special entree is %(special)s.\'</span><span class="token punctuation">)</span>\nold_formatted <span class="token operator">=</span> old_template <span class="token operator">%</span> <span class="token punctuation">{</span>\n    <span class="token string">\'soup\'</span><span class="token punctuation">:</span> <span class="token string">\'lentil\'</span><span class="token punctuation">,</span>\n    <span class="token string">\'oyster\'</span><span class="token punctuation">:</span> <span class="token string">\'kumamoto\'</span><span class="token punctuation">,</span>\n    <span class="token string">\'special\'</span><span class="token punctuation">:</span> <span class="token string">\'schnitzel\'</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\nnew_template <span class="token operator">=</span> <span class="token punctuation">(</span>\n    <span class="token string">\'Today\\\'s soup is {soup}, \'</span>\n    <span class="token string">\'buy one get two {oyster} oysters, \'</span>\n    <span class="token string">\'and our special entree is {special}.\'</span><span class="token punctuation">)</span>\nnew_formatted <span class="token operator">=</span> new_template<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>\n    soup<span class="token operator">=</span><span class="token string">\'lentil\'</span><span class="token punctuation">,</span>\n    oyster<span class="token operator">=</span><span class="token string">\'kumamoto\'</span><span class="token punctuation">,</span>\n    special<span class="token operator">=</span><span class="token string">\'schnitzel\'</span><span class="token punctuation">,</span>\n<span class="token punctuation">)</span>\n\n<span class="token keyword">assert</span> old_formatted <span class="token operator">==</span> new_formatted</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>新写法稍微好一点儿，因为它不用定义 dict 了，所以不需要把键名用 <code class="language-text">&#39; &#39;</code> 给括起来。它的说明符也比旧写法的说明符要简单一些。然而这些优点并不突出。另外，虽然我们在新写法里面，可以访问字典中的键，也可以访问列表中的元素，但这些功能只涵盖了 Python 表达式的一小部分特性，str.format 方法还是没有能够把 Python 表达式的优势充分发挥出来。</p>\n<h3 id="插值格式字符串"><a href="#%E6%8F%92%E5%80%BC%E6%A0%BC%E5%BC%8F%E5%AD%97%E7%AC%A6%E4%B8%B2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>插值格式字符串</h3>\n<p>Python 3.6 添加了一种新的特性，叫作插值格式字符串（interpolatedformat string，简称 f-string），可以解决上面提到的所有问题。新语法特性要求在格式字符串的前面加字母 f 作为前缀，这跟字母 b 与字母 r 的用法类似，也就是分别表示字节形式的字符串与原始的（或者说未经转义的）字符串的前缀。</p>\n<p>f-string 把格式字符串的表达能力发挥到了极致，它彻底解决了上文提到的第四个缺点，也就是键名重复导致的程序冗余问题。我们不用再像使用 C 风格格式表达式时那样专门定义 dict，也不用再像调用 str.format 方法时那样专门把值传给某个参数，这次可以直接在 f-string 的 {} 里面引用当前 Python 范围内的所有名称，进而达到简化的目的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86065824584195050000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`key = \'my_var\'\nvalue = 1.234\n\nformatted = f\'{key} = {value}\'\nprint(formatted)\n\n>>>\nmy_var = 1.234`, `86065824584195050000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">key <span class="token operator">=</span> <span class="token string">\'my_var\'</span>\nvalue <span class="token operator">=</span> <span class="token number">1.234</span>\n\nformatted <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>key<span class="token punctuation">}</span></span><span class="token string"> = </span><span class="token interpolation"><span class="token punctuation">{</span>value<span class="token punctuation">}</span></span><span class="token string">\'</span></span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>formatted<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nmy_var <span class="token operator">=</span> <span class="token number">1.234</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>str.format 方法所支持的那套迷你语言，也就是在 {} 内的冒号右侧所采用的那套规则，现在也可以用到 f-string 里面，而且还可以像早前使用 str.format 时那样，通过 ! 符号把值转化成 Unicode 及 repr 形式的字符串。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7969540019825661000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`key = \'my_var\'\nvalue = 1.234\n\nformatted = f\'{key!r:<10} = {value:.2f}\'\nprint(formatted)\n\n>>>\n\'my_var\'   = 1.23`, `7969540019825661000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">key <span class="token operator">=</span> <span class="token string">\'my_var\'</span>\nvalue <span class="token operator">=</span> <span class="token number">1.234</span>\n\nformatted <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>key<span class="token conversion-option punctuation">!r</span><span class="token punctuation">:</span><span class="token format-spec">&lt;10</span><span class="token punctuation">}</span></span><span class="token string"> = </span><span class="token interpolation"><span class="token punctuation">{</span>value<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>formatted<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token string">\'my_var\'</span>   <span class="token operator">=</span> <span class="token number">1.23</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>同一个问题，使用 f-string 来解决总是比通过 % 操作符使用 C 风格的格式字符串简单，而且也比 str.format 方法简单。下面按照从短到长的顺序把这几种写法所占的篇幅对比一下，每种写法里面的那个赋值符号（=）左侧都对齐到同一个位置，这样很容易看出符号右边的代码到底有多少。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3358221878662703600"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`key = \'my_var\'\nvalue = 1.234\n\nf_string = f\'{key:<10} = {value:.2f}\'\nc_tuple = \'%-10s = %.2f\' % (key, value)\nstr_args = \'{:<10} = {:.2f}\'.format(key, value)\nstr_kw = \'{key:<10} = {value:.2f}\'.format(key=key,\n                                          value=value)\nc_dict = \'%(key)-10s = %(value).2f\' % {\'key\': key,\n                                       \'value\': value}\nassert c_tuple == c_dict == f_string\nassert str_args == str_kw == f_string`, `3358221878662703600`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">key <span class="token operator">=</span> <span class="token string">\'my_var\'</span>\nvalue <span class="token operator">=</span> <span class="token number">1.234</span>\n\nf_string <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>key<span class="token punctuation">:</span><span class="token format-spec">&lt;10</span><span class="token punctuation">}</span></span><span class="token string"> = </span><span class="token interpolation"><span class="token punctuation">{</span>value<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span>\nc_tuple <span class="token operator">=</span> <span class="token string">\'%-10s = %.2f\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\nstr_args <span class="token operator">=</span> <span class="token string">\'{:&lt;10} = {:.2f}\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\nstr_kw <span class="token operator">=</span> <span class="token string">\'{key:&lt;10} = {value:.2f}\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>key<span class="token operator">=</span>key<span class="token punctuation">,</span>\n                                          value<span class="token operator">=</span>value<span class="token punctuation">)</span>\nc_dict <span class="token operator">=</span> <span class="token string">\'%(key)-10s = %(value).2f\'</span> <span class="token operator">%</span> <span class="token punctuation">{</span><span class="token string">\'key\'</span><span class="token punctuation">:</span> key<span class="token punctuation">,</span>\n                                       <span class="token string">\'value\'</span><span class="token punctuation">:</span> value<span class="token punctuation">}</span>\n<span class="token keyword">assert</span> c_tuple <span class="token operator">==</span> c_dict <span class="token operator">==</span> f_string\n<span class="token keyword">assert</span> str_args <span class="token operator">==</span> str_kw <span class="token operator">==</span> f_string</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 f-string 方法中，各种 Python 表达式都可以出现在 {} 里，于是这就解决了前面提到的第二个缺点。我们现在可以用相当简洁的写法对需要填充到字符串里面的值做出微调。C 风格的写法与采用 str.format 方法的写法可能会让表达式变得很长，但如果改用 f-string，或许一行就能写完。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51039819830072330000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pantry = [\n    (\'avocados\', 1.25),\n    (\'bananas\', 2.5),\n    (\'cherries\', 15),\n]\n\nfor i, (item, count) in enumerate(pantry):\n    old_style = \'#%d: %-10s = %d\' % (\n        i + 1,\n        item.title(),\n        round(count))\n    new_style = \'#{}: {:<10s} = {}\'.format(\n        i + 1,\n        item.title(),\n        round(count))\n    f_string = f\'#{i + 1}: {item.title():<10s} = {round(count)}\'\n    assert old_style == new_style == f_string`, `51039819830072330000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">pantry <span class="token operator">=</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">(</span><span class="token string">\'avocados\'</span><span class="token punctuation">,</span> <span class="token number">1.25</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">(</span><span class="token string">\'bananas\'</span><span class="token punctuation">,</span> <span class="token number">2.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">(</span><span class="token string">\'cherries\'</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">]</span>\n\n<span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>item<span class="token punctuation">,</span> count<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>pantry<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    old_style <span class="token operator">=</span> <span class="token string">\'#%d: %-10s = %d\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>\n        i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>\n        item<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        <span class="token builtin">round</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span>\n    new_style <span class="token operator">=</span> <span class="token string">\'#{}: {:&lt;10s} = {}\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>\n        i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>\n        item<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        <span class="token builtin">round</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span>\n    f_string <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f\'#</span><span class="token interpolation"><span class="token punctuation">{</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>item<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token format-spec">&lt;10s</span><span class="token punctuation">}</span></span><span class="token string"> = </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">round</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span>\n    <span class="token keyword">assert</span> old_style <span class="token operator">==</span> new_style <span class="token operator">==</span> f_string</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>要是想表达得更清楚一些，可以把 f-string 写成多行的形式，类似于 C 语言的相邻字符串拼接（adjacent-string concatenation）。这样写虽然比单行的 f-string 要长，但仍然好过另外那两种多行的写法。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42352653046452216000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pantry = [\n    (\'avocados\', 1.25),\n    (\'bananas\', 2.5),\n    (\'cherries\', 15),\n]\n\nfor i, (item, count) in enumerate(pantry):\n    f_string = (\n        f\'# {i + 1}: \'\n        f\'{item.title():<10s} = \'\n        f\'{round(count)}\'\n    )\n    print(f_string)\n\n>>>\n# 1: Avocados   = 1\n# 2: Bananas    = 2\n# 3: Cherries   = 15`, `42352653046452216000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">pantry <span class="token operator">=</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">(</span><span class="token string">\'avocados\'</span><span class="token punctuation">,</span> <span class="token number">1.25</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">(</span><span class="token string">\'bananas\'</span><span class="token punctuation">,</span> <span class="token number">2.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">(</span><span class="token string">\'cherries\'</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">]</span>\n\n<span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>item<span class="token punctuation">,</span> count<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>pantry<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    f_string <span class="token operator">=</span> <span class="token punctuation">(</span>\n        <span class="token string-interpolation"><span class="token string">f\'# </span><span class="token interpolation"><span class="token punctuation">{</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">: \'</span></span>\n        <span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>item<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token format-spec">&lt;10s</span><span class="token punctuation">}</span></span><span class="token string"> = \'</span></span>\n        <span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">round</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span>\n    <span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span>f_string<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token comment"># 1: Avocados   = 1</span>\n<span class="token comment"># 2: Bananas    = 2</span>\n<span class="token comment"># 3: Cherries   = 15</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Python 表达式也可以出现在格式说明符中。例如，下面的代码把小数点之后的位数用变量来表示，然后把这个变量的名字 places 用 {} 括起来放到格式说明符中，这样写比采用硬代码更灵活。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80116526700427580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`places = 3\nnumber = 1.23456\nprint(f\'My number is {number:.{places}f}\')\n\n>>>\nMy number is 1.235`, `80116526700427580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">places <span class="token operator">=</span> <span class="token number">3</span>\nnumber <span class="token operator">=</span> <span class="token number">1.23456</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'My number is </span><span class="token interpolation"><span class="token punctuation">{</span>number<span class="token punctuation">:</span><span class="token punctuation">.</span><span class="token punctuation">{</span>places<span class="token punctuation">}</span>f<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nMy number <span class="token keyword">is</span> <span class="token number">1.235</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 Python 内置的四种字符串格式化办法里面，f-string 可以简洁而清晰地表达出许多种逻辑，这使它成为程序员的最佳选择。如果你想把值以适当的格式填充到字符串里面，那么首先应该考虑的就是采用 f-string 来实现。</p>\n<h3 id="总结"><a href="#%E6%80%BB%E7%BB%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>采用 % 操作符把值填充到 C 风格的格式字符串时会遇到许多问题，而且这种写法比较烦琐。</li>\n<li>str.format 方法专门用一套迷你语言来定义它的格式说明符，这套语言给我们提供了一些有用的概念，但是在其他方面，这个方法还是存在与 C 风格的格式字符串一样的多种缺点，所以我们也应该避免使用它。</li>\n<li>f-string 采用新的写法，将值填充到字符串之中，解决了 C 风格的格式字符串所带来的最大问题。f-string 是个简洁而强大的机制，可以直接在格式说明符里嵌入任意 Python 表达式。</li>\n</ol>\n<h2 id="第-5-条：用辅助函数取代复杂的表达式"><a href="#%E7%AC%AC-5-%E6%9D%A1%EF%BC%9A%E7%94%A8%E8%BE%85%E5%8A%A9%E5%87%BD%E6%95%B0%E5%8F%96%E4%BB%A3%E5%A4%8D%E6%9D%82%E7%9A%84%E8%A1%A8%E8%BE%BE%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 5 条：用辅助函数取代复杂的表达式</h2>\n<p>Python 的语法相当简明，所以有时只用一条表达式就能实现许多逻辑。例如，要把 URL 之中的查询字符串拆分成键值对，那么只需要使用 parse_qs 函数就可以了。下面的例子会解析查询字符串之中的每个参数，并把这些参数跟它们所对应的整数值放到一份字典（dict）里面。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9317323398252753000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from urllib.parse import parse_qs\nmy_values = parse_qs(\'red=5&blue=0&green=\',\n                     keep_blank_values=True)\nprint(repr(my_values))\n\n>>>\n{\'red\': [\'5\'], \'blue\': [\'0\'], \'green\': [\'\']}`, `9317323398252753000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> parse_qs\nmy_values <span class="token operator">=</span> parse_qs<span class="token punctuation">(</span><span class="token string">\'red=5&amp;blue=0&amp;green=\'</span><span class="token punctuation">,</span>\n                     keep_blank_values<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">repr</span><span class="token punctuation">(</span>my_values<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">{</span><span class="token string">\'red\'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'5\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">\'blue\'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'0\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">\'green\'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'\'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在解析查询字符串时，可以发现，有的参数可能带有多个值，有的参数可能只有一个值，还有的参数可能是空白值，另外也会遇到根本没提供这个参数的情况。下面这三行代码分别通过 get 方法查询结果字典里面的三个参数，这刚好对应三种不同的情况：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98177636592238660000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from urllib.parse import parse_qs\nmy_values = parse_qs(\'red=5&blue=0&green=\',\n                     keep_blank_values=True)\n\nprint(\'Red:         \', my_values.get(\'red\'))\nprint(\'Green:       \', my_values.get(\'green\'))\nprint(\'Opacity:     \', my_values.get(\'opacity\'))\n\n>>>\nRed:          [\'5\']\nGreen:        [\'\']\nOpacity:      None`, `98177636592238660000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> parse_qs\nmy_values <span class="token operator">=</span> parse_qs<span class="token punctuation">(</span><span class="token string">\'red=5&amp;blue=0&amp;green=\'</span><span class="token punctuation">,</span>\n                     keep_blank_values<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Red:         \'</span><span class="token punctuation">,</span> my_values<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'red\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Green:       \'</span><span class="token punctuation">,</span> my_values<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'green\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Opacity:     \'</span><span class="token punctuation">,</span> my_values<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'opacity\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nRed<span class="token punctuation">:</span>          <span class="token punctuation">[</span><span class="token string">\'5\'</span><span class="token punctuation">]</span>\nGreen<span class="token punctuation">:</span>        <span class="token punctuation">[</span><span class="token string">\'\'</span><span class="token punctuation">]</span>\nOpacity<span class="token punctuation">:</span>      <span class="token boolean">None</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果能把参数缺失与参数为空白值这两种情况都默认当成 0，那就更好了。但这样一个小小的逻辑，似乎不值得专门写 if 语句或辅助函数，所以有人会直接用 Boolean 表达式实现。</p>\n<p>Boolean 表达式用 Python 的语法写起来很简单，因为 Python 在对这种表达式求值的时候，会把空白字符串、空白 list 以及 0 值，全都当成 False 看待。所以，只需要把 get 方法查到的结果放在 or 操作符的左边，并且在右边写上 0 就行了。这样的话，只要左边的子表达式为 False，那么整个表达式的值自然就被评估为右边那个表达式的值，也就是 0。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53147022653268250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from urllib.parse import parse_qs\nmy_values = parse_qs(\'red=5&blue=0&green=\',\n                     keep_blank_values=True)\n\n# For query string \'red=5&blue=0&green=\'\nred = my_values.get(\'red\', [\'\'])[0] or 0\ngreen = my_values.get(\'green\', [\'\'])[0] or 0\nopacity = my_values.get(\'opacity\', [\'\'])[0] or 0\nprint(f\'Red:     {red!r}\')\nprint(f\'Green:   {green!r}\')\nprint(f\'Opacity: {opacity!r}\')\n\n>>>\nRed:     \'5\'\nGreen:   0\nOpacity: 0`, `53147022653268250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> parse_qs\nmy_values <span class="token operator">=</span> parse_qs<span class="token punctuation">(</span><span class="token string">\'red=5&amp;blue=0&amp;green=\'</span><span class="token punctuation">,</span>\n                     keep_blank_values<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\n\n<span class="token comment"># For query string \'red=5&amp;blue=0&amp;green=\'</span>\nred <span class="token operator">=</span> my_values<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'red\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">or</span> <span class="token number">0</span>\ngreen <span class="token operator">=</span> my_values<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'green\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">or</span> <span class="token number">0</span>\nopacity <span class="token operator">=</span> my_values<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'opacity\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">or</span> <span class="token number">0</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Red:     </span><span class="token interpolation"><span class="token punctuation">{</span>red<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Green:   </span><span class="token interpolation"><span class="token punctuation">{</span>green<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Opacity: </span><span class="token interpolation"><span class="token punctuation">{</span>opacity<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nRed<span class="token punctuation">:</span>     <span class="token string">\'5\'</span>\nGreen<span class="token punctuation">:</span>   <span class="token number">0</span>\nOpacity<span class="token punctuation">:</span> <span class="token number">0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>表达式写成这样，看起来很别扭，而且它并没有完全实现我们想要的效果，因为我们还得保证解析出来的参数值是能够直接参与数学运算的整数。于是，需要通过内置的 int() 把这种表达式所解析出来的字符串转换成整数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95959837227376200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`red = int(my_values.get(\'red\', [\'\'])[0] or 0)`, `95959837227376200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">red <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>my_values<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'red\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">or</span> <span class="token number">0</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>现在的代码比原来更难读了，因为看上去比原来还要乱。这种代码让人觉得很可怕：如果你是第一次阅读该代码，那必须得把整个表达式逐层拆分，才能明白这行代码的意思，这要花很长时间。代码当然应该写得短一些，但并不意味着非得挤成一行。</p>\n<p>Python 可以用 if/else 结构实现三元的条件表达式，这样写比刚才那种写法更清晰，且能保持代码简短。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36147239262422716000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`red_str = my_values.get(\'red\', [\'\'])\nred = int(red_str[0]) if red_str[0] else 0`, `36147239262422716000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">red_str <span class="token operator">=</span> my_values<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'red\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\nred <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>red_str<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">if</span> red_str<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">else</span> <span class="token number">0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>但在我们这个例子里，这种写法还是不如完整的多行 if/else 结构好，虽然要多写几行，但非常容易看懂。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16841617294513744000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`green_str = my_values.get(\'green\', [\'\'])\nif green_str[0]:\n    green = int(green_str[0])\nelse:\n    green = 0`, `16841617294513744000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">green_str <span class="token operator">=</span> my_values<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'green\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token keyword">if</span> green_str<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>\n    green <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>green_str<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    green <span class="token operator">=</span> <span class="token number">0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果要反复使用这套逻辑，那还是写成辅助函数比较好，即使像下面这个例子一样只用两三次，也还是值得这样做。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93944563252038660000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def get_first_int(values, key, default=0):\n    found = values.get(key, [\'\'])\n    if found[0]:\n        return int(found[0])\n    return default`, `93944563252038660000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">get_first_int</span><span class="token punctuation">(</span>values<span class="token punctuation">,</span> key<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    found <span class="token operator">=</span> values<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n    <span class="token keyword">if</span> found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token builtin">int</span><span class="token punctuation">(</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n    <span class="token keyword">return</span> default</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="总结-1"><a href="#%E6%80%BB%E7%BB%93-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>Python 的语法很容易把复杂的意思挤到同一行表达式里，这样写很难懂。</li>\n<li>复杂的表达式，尤其是那种需要重复使用的复杂表达式，应该写到辅助函数里面。</li>\n<li>用 if/else 结构写成的条件表达式，要比用 or 与 and 写成的 Boolean 表达式更好懂。</li>\n</ol>\n<h2 id="第-6-条：把数据结构直接拆分到多个变量里，不要专门通过下标访问"><a href="#%E7%AC%AC-6-%E6%9D%A1%EF%BC%9A%E6%8A%8A%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%9B%B4%E6%8E%A5%E6%8B%86%E5%88%86%E5%88%B0%E5%A4%9A%E4%B8%AA%E5%8F%98%E9%87%8F%E9%87%8C%EF%BC%8C%E4%B8%8D%E8%A6%81%E4%B8%93%E9%97%A8%E9%80%9A%E8%BF%87%E4%B8%8B%E6%A0%87%E8%AE%BF%E9%97%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 6 条：把数据结构直接拆分到多个变量里，不要专门通过下标访问</h2>\n<p>Python 内置的元组（tuple）类型可以创建不可变的序列，把许多元素依次保存起来。最简单的用法是只用元组保存两个值，例如字典里面的键值对。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19749205371009794000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`snack_calories = {\n    \'chips\': 140,\n    \'popcorn\': 80,\n    \'nuts\': 190,\n}\nitems = tuple(snack_calories.items())\nprint(items)\n\n>>>\n((\'chips\', 140), (\'popcorn\', 80), (\'nuts\', 190))`, `19749205371009794000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">snack_calories <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'chips\'</span><span class="token punctuation">:</span> <span class="token number">140</span><span class="token punctuation">,</span>\n    <span class="token string">\'popcorn\'</span><span class="token punctuation">:</span> <span class="token number">80</span><span class="token punctuation">,</span>\n    <span class="token string">\'nuts\'</span><span class="token punctuation">:</span> <span class="token number">190</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\nitems <span class="token operator">=</span> <span class="token builtin">tuple</span><span class="token punctuation">(</span>snack_calories<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">\'chips\'</span><span class="token punctuation">,</span> <span class="token number">140</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">\'popcorn\'</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">\'nuts\'</span><span class="token punctuation">,</span> <span class="token number">190</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们可以用整数作下标，通过下标来访问元组里面对应的元素。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44263376941915600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`item = (\'Peanut butter\', \'Jelly\')\nfirst = item[0]\nsecond = item[1]\nprint(first, \'and\', second)\n\n>>>\nPeanut butter and Jelly`, `44263376941915600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">item <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">\'Peanut butter\'</span><span class="token punctuation">,</span> <span class="token string">\'Jelly\'</span><span class="token punctuation">)</span>\nfirst <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>\nsecond <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span> <span class="token string">\'and\'</span><span class="token punctuation">,</span> second<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nPeanut butter <span class="token keyword">and</span> Jelly</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>创建好 tuple 之后，就不能通过下标给其中的元素赋新值了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57462356762684520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pair = (\'Chocolate\', \'Peanut butter\')\npair[0] = \'Honey\'\n\n>>>\nTraceback ...\nTypeError: \'tuple\' object does not support item assignment`, `57462356762684520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">pair <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">\'Chocolate\'</span><span class="token punctuation">,</span> <span class="token string">\'Peanut butter\'</span><span class="token punctuation">)</span>\npair<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">\'Honey\'</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> <span class="token string">\'tuple\'</span> <span class="token builtin">object</span> does <span class="token keyword">not</span> support item assignment</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Python 还有一种写法，叫作拆分（unpacking）。这种写法让我们只用一条语句，就可以把元组里面的元素分别赋给多个变量。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87126055402192100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`item = (\'Peanut butter\', \'Jelly\')\nfirst, second = item  # Unpacking\nprint(first, \'and\', second)\n\n>>>\nPeanut butter and Jelly`, `87126055402192100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">item <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">\'Peanut butter\'</span><span class="token punctuation">,</span> <span class="token string">\'Jelly\'</span><span class="token punctuation">)</span>\nfirst<span class="token punctuation">,</span> second <span class="token operator">=</span> item  <span class="token comment"># Unpacking</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span> <span class="token string">\'and\'</span><span class="token punctuation">,</span> second<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nPeanut butter <span class="token keyword">and</span> Jelly</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>通过 unpacking 来赋值要比通过下标去访问元组内的元素更清晰，而且这种写法所需的代码量通常比较少。当然，赋值操作的左边除了可以罗列单个变量，也可以写成列表、序列或任意深度的可迭代对象（iterable）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20595274225505202000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`favorite_snacks = {\n    \'salty\': (\'pretzels\', 100),\n    \'sweet\': (\'cookies\', 180),\n    \'veggie\': (\'carrots\', 20),\n}\n\n((type1, (name1, cals1)),\n (type2, (name2, cals2)),\n (type3, (name3, cals3))) = favorite_snacks.items()\nprint(f\'Favorite {type1} is {name1} with {cals1} calories\')\nprint(f\'Favorite {type2} is {name2} with {cals2} calories\')\nprint(f\'Favorite {type3} is {name3} with {cals3} calories\')\n\n>>>\nFavorite salty is pretzels with 100 calories\nFavorite sweet is cookies with 180 calories\nFavorite veggie is carrots with 20 calories`, `20595274225505202000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">favorite_snacks <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'salty\'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">\'pretzels\'</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token string">\'sweet\'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">\'cookies\'</span><span class="token punctuation">,</span> <span class="token number">180</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token string">\'veggie\'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">\'carrots\'</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\n<span class="token punctuation">(</span><span class="token punctuation">(</span>type1<span class="token punctuation">,</span> <span class="token punctuation">(</span>name1<span class="token punctuation">,</span> cals1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n <span class="token punctuation">(</span>type2<span class="token punctuation">,</span> <span class="token punctuation">(</span>name2<span class="token punctuation">,</span> cals2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n <span class="token punctuation">(</span>type3<span class="token punctuation">,</span> <span class="token punctuation">(</span>name3<span class="token punctuation">,</span> cals3<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> favorite_snacks<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Favorite </span><span class="token interpolation"><span class="token punctuation">{</span>type1<span class="token punctuation">}</span></span><span class="token string"> is </span><span class="token interpolation"><span class="token punctuation">{</span>name1<span class="token punctuation">}</span></span><span class="token string"> with </span><span class="token interpolation"><span class="token punctuation">{</span>cals1<span class="token punctuation">}</span></span><span class="token string"> calories\'</span></span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Favorite </span><span class="token interpolation"><span class="token punctuation">{</span>type2<span class="token punctuation">}</span></span><span class="token string"> is </span><span class="token interpolation"><span class="token punctuation">{</span>name2<span class="token punctuation">}</span></span><span class="token string"> with </span><span class="token interpolation"><span class="token punctuation">{</span>cals2<span class="token punctuation">}</span></span><span class="token string"> calories\'</span></span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Favorite </span><span class="token interpolation"><span class="token punctuation">{</span>type3<span class="token punctuation">}</span></span><span class="token string"> is </span><span class="token interpolation"><span class="token punctuation">{</span>name3<span class="token punctuation">}</span></span><span class="token string"> with </span><span class="token interpolation"><span class="token punctuation">{</span>cals3<span class="token punctuation">}</span></span><span class="token string"> calories\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nFavorite salty <span class="token keyword">is</span> pretzels <span class="token keyword">with</span> <span class="token number">100</span> calories\nFavorite sweet <span class="token keyword">is</span> cookies <span class="token keyword">with</span> <span class="token number">180</span> calories\nFavorite veggie <span class="token keyword">is</span> carrots <span class="token keyword">with</span> <span class="token number">20</span> calories</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32703495238082580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`snacks = [(\'bacon\', 350), (\'donut\', 240), (\'muffin\', 190)]\n\nfor rank, (name, calories) in enumerate(snacks, 1):\n    print(f\'#{rank}: {name} has {calories} calories\')\n\n>>>\n#1: bacon has 350 calories\n#2: donut has 240 calories\n#3: muffin has 190 calories`, `32703495238082580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">snacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'bacon\'</span><span class="token punctuation">,</span> <span class="token number">350</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">\'donut\'</span><span class="token punctuation">,</span> <span class="token number">240</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">\'muffin\'</span><span class="token punctuation">,</span> <span class="token number">190</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n\n<span class="token keyword">for</span> rank<span class="token punctuation">,</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> calories<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>snacks<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'#</span><span class="token interpolation"><span class="token punctuation">{</span>rank<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string"> has </span><span class="token interpolation"><span class="token punctuation">{</span>calories<span class="token punctuation">}</span></span><span class="token string"> calories\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token comment">#1: bacon has 350 calories</span>\n<span class="token comment">#2: donut has 240 calories</span>\n<span class="token comment">#3: muffin has 190 calories</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这才是符合 Python 风格的写法（Pythonic 式的写法），我们不需要再通过下标逐层访问了。这种写法可以节省篇幅，而且比较容易理解。</p>\n<p>Python 的 unpacking 机制可以用在许多方面，例如构建列表（参见第 13 条）、给函数设计参数列表（参见第 22 条）、传递关键字参数（参见第 23 条）、接收多个返回值（参见第 19 条）等。</p>\n<p>明智地使用 unpacking 机制，可以实现很多原来必须通过下标才能写出的功能，这让代码变得更加清晰，而且能充分发挥 Python 的优势。</p>\n<h3 id="总结-2"><a href="#%E6%80%BB%E7%BB%93-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>unpacking 是一种特殊的 Python 语法，只需要一行代码，就能把数据结构里面的多个值分别赋给相应的变量。</li>\n<li>unpacking 在 Python 中应用广泛，凡是可迭代的对象都能拆分，无论它里面还有多少层迭代结构。</li>\n<li>尽量通过 unpacking 来拆解序列之中的数据，而不要通过下标访问，这样可以让代码更简洁、更清晰。</li>\n</ol>\n<h2 id="第-7-条：尽量用-enumerate-取代-range"><a href="#%E7%AC%AC-7-%E6%9D%A1%EF%BC%9A%E5%B0%BD%E9%87%8F%E7%94%A8-enumerate-%E5%8F%96%E4%BB%A3-range" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 7 条：尽量用 enumerate 取代 range</h2>\n<p>Python 内置的 range 函数适合用来迭代一系列整数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62277037054429550000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from random import randint\n\nrandom_bits = 0\nfor i in range(32):\n    if randint(0, 1):\n        random_bits |= 1 << i\nprint(bin(random_bits))\n\n>>>\n0b100101010010000001011011010011`, `62277037054429550000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> random <span class="token keyword">import</span> randint\n\nrandom_bits <span class="token operator">=</span> <span class="token number">0</span>\n<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        random_bits <span class="token operator">|</span><span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> i\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">bin</span><span class="token punctuation">(</span>random_bits<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">0b100101010010000001011011010011</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果要迭代的是某种数据结构，例如字符串列表，那么可以直接在这个序列上面迭代，用不着专门通过 range 设定一个取值范围，然后把这个范围里的每个整数值，依次当成下标来访问列表中的元素。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85598712553672310000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`flavor_list = [\'vanilla\', \'chocolate\', \'pecan\', \'strawberry\']\n\nfor flavor in flavor_list:\n    print(f\'{flavor} is delicious\')\n\n>>>\nvanilla is delicious\nchocolate is delicious\npecan is delicious\nstrawberry is delicious`, `85598712553672310000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">flavor_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'vanilla\'</span><span class="token punctuation">,</span> <span class="token string">\'chocolate\'</span><span class="token punctuation">,</span> <span class="token string">\'pecan\'</span><span class="token punctuation">,</span> <span class="token string">\'strawberry\'</span><span class="token punctuation">]</span>\n\n<span class="token keyword">for</span> flavor <span class="token keyword">in</span> flavor_list<span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>flavor<span class="token punctuation">}</span></span><span class="token string"> is delicious\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nvanilla <span class="token keyword">is</span> delicious\nchocolate <span class="token keyword">is</span> delicious\npecan <span class="token keyword">is</span> delicious\nstrawberry <span class="token keyword">is</span> delicious</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当然有的时候，在迭代 list 的过程中也需要知道当前处理的这个元素在 list 里的位置。例如，我把爱吃的冰激淋口味写在 <code class="language-text">flavor_list</code> 列表里面，在打印每种口味时，我还想指出这种口味在自己心目中的排名。为了实现这样的功能，我们可以用传统的 range 方式来实现。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47724714767568610000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`flavor_list = [\'vanilla\', \'chocolate\', \'pecan\', \'strawberry\']\n\nfor i in range(len(flavor_list)):\n    flavor = flavor_list[i]\n    print(f\'{i+1}: {flavor}\')\n\n>>>\n1: vanilla\n2: chocolate\n3: pecan\n4: strawberry`, `47724714767568610000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">flavor_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'vanilla\'</span><span class="token punctuation">,</span> <span class="token string">\'chocolate\'</span><span class="token punctuation">,</span> <span class="token string">\'pecan\'</span><span class="token punctuation">,</span> <span class="token string">\'strawberry\'</span><span class="token punctuation">]</span>\n\n<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>flavor_list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    flavor <span class="token operator">=</span> flavor_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>flavor<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">1</span><span class="token punctuation">:</span> vanilla\n<span class="token number">2</span><span class="token punctuation">:</span> chocolate\n<span class="token number">3</span><span class="token punctuation">:</span> pecan\n<span class="token number">4</span><span class="token punctuation">:</span> strawberry</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><code class="language-text">range(len(flavor_list))</code> 的写法太过复杂，可以用 enumerate 代替。enumerate 能够把任何一种迭代器（iterator）封装成惰性生成器（lazy generator，参见第 30 条）</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86097851187721880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`flavor_list = [\'vanilla\', \'chocolate\', \'pecan\', \'strawberry\']\n\nit = enumerate(flavor_list)\nprint(next(it))\nprint(next(it))\n\n>>>\n(0, \'vanilla\')\n(1, \'chocolate\')`, `86097851187721880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">flavor_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'vanilla\'</span><span class="token punctuation">,</span> <span class="token string">\'chocolate\'</span><span class="token punctuation">,</span> <span class="token string">\'pecan\'</span><span class="token punctuation">,</span> <span class="token string">\'strawberry\'</span><span class="token punctuation">]</span>\n\nit <span class="token operator">=</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>flavor_list<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">next</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">next</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">\'vanilla\'</span><span class="token punctuation">)</span>\n<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'chocolate\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82427684346705950000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`flavor_list = [\'vanilla\', \'chocolate\', \'pecan\', \'strawberry\']\n\nfor i, flavor in enumerate(flavor_list):\n    print(f\'{i + 1}: {flavor}\')\n\n>>>\n1: vanilla\n2: chocolate\n3: pecan\n4: strawberry`, `82427684346705950000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">flavor_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'vanilla\'</span><span class="token punctuation">,</span> <span class="token string">\'chocolate\'</span><span class="token punctuation">,</span> <span class="token string">\'pecan\'</span><span class="token punctuation">,</span> <span class="token string">\'strawberry\'</span><span class="token punctuation">]</span>\n\n<span class="token keyword">for</span> i<span class="token punctuation">,</span> flavor <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>flavor_list<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>flavor<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">1</span><span class="token punctuation">:</span> vanilla\n<span class="token number">2</span><span class="token punctuation">:</span> chocolate\n<span class="token number">3</span><span class="token punctuation">:</span> pecan\n<span class="token number">4</span><span class="token punctuation">:</span> strawberry</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>另外，还可以通过 enumerate 的第二个参数指定起始序号，这样就不用在每次打印的时候去调整了。例如，本例可以从 1 开始计算。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56315630556938200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`for i, flavor in enumerate(flavor_list, 1):\n    print(f\'{i + 1}: {flavor}\')`, `56315630556938200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">for</span> i<span class="token punctuation">,</span> flavor <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>flavor_list<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>flavor<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h3 id="总结-3"><a href="#%E6%80%BB%E7%BB%93-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>enumerate 函数可以用简洁的代码迭代 iterator，而且可以指出当前这轮循环的序号。</li>\n<li>不要先通过 range 指定下标的取值范围，然后用下标去访问序列，而是应该直接用 enumerate 函数迭代。</li>\n<li>可以通过 enumerate 的第二个参数指定起始序号（默认为 0）。</li>\n</ol>\n<h2 id="第-8-条：用-zip-函数同时遍历两个迭代器"><a href="#%E7%AC%AC-8-%E6%9D%A1%EF%BC%9A%E7%94%A8-zip-%E5%87%BD%E6%95%B0%E5%90%8C%E6%97%B6%E9%81%8D%E5%8E%86%E4%B8%A4%E4%B8%AA%E8%BF%AD%E4%BB%A3%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 8 条：用 zip 函数同时遍历两个迭代器</h2>\n<p>写 Python 代码时，经常会根据某份列表中的对象创建许多与这份列表有关的新列表。下面这样的列表推导机制，可以把表达式运用到源列表的每个元素上面，从而生成一份派生列表（参见第 27 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42925205279100040000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`names = [\'Cecilia\', \'Lise\', \'Marie\']\ncounts = [len(n) for n in names]\nprint(counts)\n\n>>>\n[7, 4, 5]`, `42925205279100040000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'Cecilia\'</span><span class="token punctuation">,</span> <span class="token string">\'Lise\'</span><span class="token punctuation">,</span> <span class="token string">\'Marie\'</span><span class="token punctuation">]</span>\ncounts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token keyword">for</span> n <span class="token keyword">in</span> names<span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>counts<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>派生列表中的元素与源列表中对应位置上面的元素有着一定的关系。如果想同时遍历这两份列表，那可以根据源列表的长度做迭代。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9889838199526690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`names = [\'Cecilia\', \'Lise\', \'Marie\']\ncounts = [len(n) for n in names]\n\nlongest_name = None\nmax_count = 0\nfor i in range(len(names)):\n    count = counts[i]\n    if count > max_count:\n        longest_name = names[i]\n        max_count = count\n\nprint(longest_name)\n\n>>>\nCecilia`, `9889838199526690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'Cecilia\'</span><span class="token punctuation">,</span> <span class="token string">\'Lise\'</span><span class="token punctuation">,</span> <span class="token string">\'Marie\'</span><span class="token punctuation">]</span>\ncounts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token keyword">for</span> n <span class="token keyword">in</span> names<span class="token punctuation">]</span>\n\nlongest_name <span class="token operator">=</span> <span class="token boolean">None</span>\nmax_count <span class="token operator">=</span> <span class="token number">0</span>\n<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>names<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    count <span class="token operator">=</span> counts<span class="token punctuation">[</span>i<span class="token punctuation">]</span>\n    <span class="token keyword">if</span> count <span class="token operator">></span> max_count<span class="token punctuation">:</span>\n        longest_name <span class="token operator">=</span> names<span class="token punctuation">[</span>i<span class="token punctuation">]</span>\n        max_count <span class="token operator">=</span> count\n\n<span class="token keyword">print</span><span class="token punctuation">(</span>longest_name<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nCecilia</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种写法的问题在于，整个循环代码看起来很乱。我们要通过下标访问 names 与 counts 这两个列表里的元素，所以表示下标的那个循环变量 i 在循环体里必须出现两次，这让代码变得不太好懂。改用 enumerate 实现（参见第 7 条）会稍微好一些，但仍然不够理想。</p>\n<p>为了把代码写得更清楚，可以用 Python 内置的 zip 函数来实现。这个函数能把两个或更多的 iterator 封装成惰性生成器（lazy generator）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17576819583300196000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`for name, count in zip(names, counts):\n    if count > max_count:\n        longest_name = name\n        max_count = count`, `17576819583300196000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">for</span> name<span class="token punctuation">,</span> count <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> counts<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> count <span class="token operator">></span> max_count<span class="token punctuation">:</span>\n        longest_name <span class="token operator">=</span> name\n        max_count <span class="token operator">=</span> count</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>zip 每次只从它封装的那些迭代器里面各自取出一个元素，所以即便源列表很长，程序也不会因为占用内存过多而崩溃。但是，如果输入 zip 的那些列表的长度不一致，那就得小心了。例如，我给 names 列表里又添加了一个名字，但是忘了把它的长度更新到 counts 列表之中。在这种情况下，用 zip 同时遍历这两份列表，会产生奇怪的结果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56647043264648600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`names = [\'Cecilia\', \'Lise\', \'Marie\']\ncounts = [len(n) for n in names]\n\nlongest_name = None\nmax_count = 0\nfor name, count in zip(names, counts):\n    if count > max_count:\n        longest_name = name\n        max_count = count\n\nnames.append(\'Rosalind\')\nfor name, count in zip(names, counts):\n    print(name)\n\n>>>\nCecilia\nLise\nMarie`, `56647043264648600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'Cecilia\'</span><span class="token punctuation">,</span> <span class="token string">\'Lise\'</span><span class="token punctuation">,</span> <span class="token string">\'Marie\'</span><span class="token punctuation">]</span>\ncounts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token keyword">for</span> n <span class="token keyword">in</span> names<span class="token punctuation">]</span>\n\nlongest_name <span class="token operator">=</span> <span class="token boolean">None</span>\nmax_count <span class="token operator">=</span> <span class="token number">0</span>\n<span class="token keyword">for</span> name<span class="token punctuation">,</span> count <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> counts<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> count <span class="token operator">></span> max_count<span class="token punctuation">:</span>\n        longest_name <span class="token operator">=</span> name\n        max_count <span class="token operator">=</span> count\n\nnames<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">\'Rosalind\'</span><span class="token punctuation">)</span>\n<span class="token keyword">for</span> name<span class="token punctuation">,</span> count <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> counts<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nCecilia\nLise\nMarie</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>zip 函数只要其中任何一个迭代器处理完毕，它就不再往下走了。于是，循环的次数实际上等于最短的那份列表所具备的长度。一般情况下，我们都是根据某份列表推导出其他几份列表，然后把这些列表一起封装到 zip 里面，由于这些列表长度相同，因此不会遇到刚才的问题。</p>\n<p>在列表长度不同的情况下，zip 函数的提前终止行为可能跟你想实现的效果不一样。所以，如果无法确定这些列表的长度相同，那就不要把它们传给 zip，而是应该传给另一个叫作 <code class="language-text">zip_longest</code> 的函数，这个函数位于内置的 itertools 模块里。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62340352109888640000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\nnames = [\'Cecilia\', \'Lise\', \'Marie\']\ncounts = [len(n) for n in names]\n\nlongest_name = None\nmax_count = 0\nfor name, count in zip(names, counts):\n    if count > max_count:\n        longest_name = name\n        max_count = count\n\nnames.append(\'Rosalind\')\n\nfor name, count in itertools.zip_longest(names, counts):\n    print(f\'{name}: {count}\')\n\n>>>\nCecilia: 7\nLise: 4\nMarie: 5\nRosalind: None`, `62340352109888640000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\nnames <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'Cecilia\'</span><span class="token punctuation">,</span> <span class="token string">\'Lise\'</span><span class="token punctuation">,</span> <span class="token string">\'Marie\'</span><span class="token punctuation">]</span>\ncounts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token keyword">for</span> n <span class="token keyword">in</span> names<span class="token punctuation">]</span>\n\nlongest_name <span class="token operator">=</span> <span class="token boolean">None</span>\nmax_count <span class="token operator">=</span> <span class="token number">0</span>\n<span class="token keyword">for</span> name<span class="token punctuation">,</span> count <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> counts<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> count <span class="token operator">></span> max_count<span class="token punctuation">:</span>\n        longest_name <span class="token operator">=</span> name\n        max_count <span class="token operator">=</span> count\n\nnames<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">\'Rosalind\'</span><span class="token punctuation">)</span>\n\n<span class="token keyword">for</span> name<span class="token punctuation">,</span> count <span class="token keyword">in</span> itertools<span class="token punctuation">.</span>zip_longest<span class="token punctuation">(</span>names<span class="token punctuation">,</span> counts<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>count<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nCecilia<span class="token punctuation">:</span> <span class="token number">7</span>\nLise<span class="token punctuation">:</span> <span class="token number">4</span>\nMarie<span class="token punctuation">:</span> <span class="token number">5</span>\nRosalind<span class="token punctuation">:</span> <span class="token boolean">None</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果其中有些列表已经遍历完了，那么 <code class="language-text">zip_longest</code> 会用当初传给 fillvalue 参数的那个值来填补空缺（本例中空缺的为字符串 <code class="language-text">&#39;Rosalind&#39;</code> 的长度值），默认的参数值是 None。</p>\n<h3 id="总结-4"><a href="#%E6%80%BB%E7%BB%93-4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>内置的 zip 函数可以同时遍历多个迭代器。</li>\n<li>zip 会创建惰性生成器，让它每次只生成一个元组，所以无论输入的数据有多长，它都是一个一个处理的。</li>\n<li>如果提供的迭代器的长度不一致，那么只要其中任何一个迭代完毕，zip 就会停止。如果想按最长的那个迭代器来遍历，那就改用内置的 itertools 模块中的 <code class="language-text">zip_longest</code> 函数。</li>\n</ol>\n<h2 id="第-9-条：不要在-for-与-while-循环后面写-else-块"><a href="#%E7%AC%AC-9-%E6%9D%A1%EF%BC%9A%E4%B8%8D%E8%A6%81%E5%9C%A8-for-%E4%B8%8E-while-%E5%BE%AA%E7%8E%AF%E5%90%8E%E9%9D%A2%E5%86%99-else-%E5%9D%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 9 条：不要在 for 与 while 循环后面写 else 块</h2>\n<p>Python 的循环有一项大多数编程语言都不支持的特性，即可以把 else 块紧跟在整个循环结构的后面。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82643455193020940000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`for i in range(3):\n    print(\'Loop\', i)\nelse:\n    print(\'Else block!\')\n\n>>>\nLoop 0\nLoop 1\nLoop 2\nElse block!`, `82643455193020940000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Loop\'</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Else block!\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nLoop <span class="token number">0</span>\nLoop <span class="token number">1</span>\nLoop <span class="token number">2</span>\nElse block!</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果循环没有从头到尾执行完（也就是循环提前终止了），那么 else 块里的代码是不会执行的。在循环中使用 break 语句实际上会跳过 else 块。这个与实际想象中的功能差别较大</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62286072071610250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`for i in range(3):\n    print(\'Loop\', i)\n    if i == 1:\n        break\nelse:\n    print(\'Else block!\')\n\n>>>\nLoop 0\nLoop 1`, `62286072071610250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Loop\'</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>\n    <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>\n        <span class="token keyword">break</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Else block!\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nLoop <span class="token number">0</span>\nLoop <span class="token number">1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>还有一个奇怪的地方是，如果对空白序列做 for 循环，那么程序立刻就会执行 else 块。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2626070466566110700"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`for x in []:\n    print(\'Never runs\')\nelse:\n    print(\'For Else block!\')\n\n>>>\nFor Else block!`, `2626070466566110700`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Never runs\'</span><span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'For Else block!\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nFor Else block!</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>while 循环也是这样，如果首次循环就遇到 False，那么程序也会立刻运行 else 块。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60828456033533665000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`while False:\n    print(\'Never runs\')\nelse:\n    print(\'While Else block!\')\n\n>>>\nWhile Else block!`, `60828456033533665000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">while</span> <span class="token boolean">False</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Never runs\'</span><span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'While Else block!\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nWhile Else block!</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>把 else 设计成这样，是想让你利用它实现搜索逻辑。例如，如果要判断两个数是否互质（也就是除了 1 之外，是不是没有别的数能够同时整除它们），就可以用这种结构实现。先把有可能同时整除它们的数逐个试一遍，如果全都试过之后还是没找到这样的数，那么循环就会从头到尾执行完（这意味着循环没有因为 break 而提前跳出），然后程序就会执行 else 块里的代码。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17461090232343413000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = 4\nb = 9\n\nfor i in range(2, min(a, b) + 1):\n    print(\'Testing\', i)\n    if a % i == 0 and b % i == 0:\n        print(\'Not coprime\')\n        break\nelse:\n    print(\'Coprime\')\n\n>>>\nTesting 2\nTesting 3\nTesting 4\nCoprime`, `17461090232343413000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token number">4</span>\nb <span class="token operator">=</span> <span class="token number">9</span>\n\n<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Testing\'</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>\n    <span class="token keyword">if</span> a <span class="token operator">%</span> i <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">and</span> b <span class="token operator">%</span> i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Not coprime\'</span><span class="token punctuation">)</span>\n        <span class="token keyword">break</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Coprime\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTesting <span class="token number">2</span>\nTesting <span class="token number">3</span>\nTesting <span class="token number">4</span>\nCoprime</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>实际工作中，会改用辅助函数完成计算。这样的辅助函数有两种常见的写法。</p>\n<ol>\n<li>\n<p>只要发现某个条件成立，就立刻返回，如果始终都没碰到这种情况，那么循环就会完整地执行，让程序返回函数末尾的那个值作为默认返回值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64478123509200230000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def coprime(a, b):\n  for i in range(2, min(a, b) + 1):\n     if a % i == 0 and b % i == 0:\n           return False\n  return True\n\nassert coprime(4, 9)\nassert not coprime(3, 6)`, `64478123509200230000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">coprime</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n     <span class="token keyword">if</span> a <span class="token operator">%</span> i <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">and</span> b <span class="token operator">%</span> i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>\n           <span class="token keyword">return</span> <span class="token boolean">False</span>\n  <span class="token keyword">return</span> <span class="token boolean">True</span>\n\n<span class="token keyword">assert</span> coprime<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span>\n<span class="token keyword">assert</span> <span class="token keyword">not</span> coprime<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>用变量来记录循环过程中有没有碰到这样的情况，如果有，那就用 break 提前跳出循环，如果没有，循环就会完整地执行，无论如何，最后都返回这个变量的值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28001531342554407000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def coprime_alternate(a, b):\n  is_coprime = True\n  for i in range(2, min(a, b) + 1):\n     if a % i == 0 and b % i == 0:\n           is_coprime = False\n           break\n  return is_coprime\n\nassert coprime_alternate(4, 9)\nassert not coprime_alternate(3, 6)`, `28001531342554407000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">coprime_alternate</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  is_coprime <span class="token operator">=</span> <span class="token boolean">True</span>\n  <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n     <span class="token keyword">if</span> a <span class="token operator">%</span> i <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">and</span> b <span class="token operator">%</span> i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>\n           is_coprime <span class="token operator">=</span> <span class="token boolean">False</span>\n           <span class="token keyword">break</span>\n  <span class="token keyword">return</span> is_coprime\n\n<span class="token keyword">assert</span> coprime_alternate<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span>\n<span class="token keyword">assert</span> <span class="token keyword">not</span> coprime_alternate<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n</ol>\n<p>for/else 或 while/else 结构本身虽然可以实现某些逻辑表达，但它带来的困惑，已经盖过了它的好处。</p>\n<h3 id="总结-5"><a href="#%E6%80%BB%E7%BB%93-5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>Python 有种特殊的语法，可以把 else 块紧跟在整个 for 循环或 while 循环的后面。</li>\n<li>只有在整个循环没有因为 break 提前跳出的情况下，else 块才会执行</li>\n<li>把 else 块紧跟在整个循环后面，会让人不太容易看出这段代码的意思，所以要避免这样写。</li>\n</ol>\n<h2 id="第-10-条：用赋值表达式减少重复代码"><a href="#%E7%AC%AC-10-%E6%9D%A1%EF%BC%9A%E7%94%A8%E8%B5%8B%E5%80%BC%E8%A1%A8%E8%BE%BE%E5%BC%8F%E5%87%8F%E5%B0%91%E9%87%8D%E5%A4%8D%E4%BB%A3%E7%A0%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 10 条：用赋值表达式减少重复代码</h2>\n<p>赋值表达式（assignment expression）是 Python3.8 新引入的语法，它会用到海象操作符（walrus operator）。这种写法可以解决某些持续已久的代码重复问题。</p>\n<p>这种表达式很有用，可以在普通的赋值语句无法应用的场合实现赋值，例如可以用在条件表达式的 if 语句里面。赋值表达式的值，就是赋给海象操作符左侧那个标识符的值。</p>\n<p>举个例子。如果有一筐新鲜水果要给果汁店做食材，那我们就可以这样定义其中的内容：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36942610442891485000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`fresh_fruit = {\n    \'apple\': 10,\n    \'banana\': 8,\n    \'lemon\': 5,\n}\n\ndef make_lemonade(count):\n    pass\n\ndef out_of_stock():\n    pass\n\ncount = fresh_fruit.get(\'lemon\', 0)\nif count:\n    make_lemonade(count)\nelse:\n    out_of_stock()`, `36942610442891485000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">fresh_fruit <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'apple\'</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>\n    <span class="token string">\'banana\'</span><span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span>\n    <span class="token string">\'lemon\'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">def</span> <span class="token function">make_lemonade</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n<span class="token keyword">def</span> <span class="token function">out_of_stock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\ncount <span class="token operator">=</span> fresh_fruit<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'lemon\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\n<span class="token keyword">if</span> count<span class="token punctuation">:</span>\n    make_lemonade<span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    out_of_stock<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这段代码看上去虽然简单，但还是显得有点儿松散，因为 count 变量虽然定义在整个 if/else 结构之上，然而只有 if 语句才会用到它，else 块根本就不需要使用这个变量。所以，这种写法让人误以为 count 是个重要的变量，if 和 else 都要用到它，但实际上并非如此。</p>\n<p>我们在 Python 里面经常要先获取某个值，然后判断它是否非零，如果是就执行某段代码。对于这种用法，我们以前总是要通过各种技巧，来避免 count 这样的变量重复出现在代码之中，这些技巧有时会让代码变得比较难懂（参考第 5 条里面提到的那些技巧）。Python 引入赋值表达式正是为了解决这样的问题。下面改用海象操作符来写：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35182931912991510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if count := fresh_fruit.get(\'lemon\', 0):\n    make_lemonade(count)\nelse:\n    out_of_stock()`, `35182931912991510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">if</span> count <span class="token punctuation">:</span><span class="token operator">=</span> fresh_fruit<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'lemon\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    make_lemonade<span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    out_of_stock<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>新代码虽然只省了一行，但读起来却清晰很多，因为这种写法明确体现出 count 变量只与 if 块有关。这个赋值表达式先把 <code class="language-text">:=</code> 右边的值赋给左边的 count 变量，然后对自身求值，也就是把变量的值当成整个表达式的值。由于表达式紧跟着 if，程序会根据它的值是否非零来决定该不该执行 if 块。这种先赋值再判断的做法，正是海象操作符想要表达的意思。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="366794640623635500"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`fresh_fruit = {\n    \'apple\': 10,\n    \'banana\': 8,\n    \'lemon\': 5,\n}\n\ndef make_cider(count):\n    pass\n\ncount = fresh_fruit.get(\'apple\', 0)\n\nif count >= 4:\n    make_cider(count)\nelse:\n    out_of_stock()`, `366794640623635500`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">fresh_fruit <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'apple\'</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>\n    <span class="token string">\'banana\'</span><span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span>\n    <span class="token string">\'lemon\'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">def</span> <span class="token function">make_cider</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\ncount <span class="token operator">=</span> fresh_fruit<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'apple\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\n\n<span class="token keyword">if</span> count <span class="token operator">>=</span> <span class="token number">4</span><span class="token punctuation">:</span>\n    make_cider<span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    out_of_stock<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>同理以上代码可以修改如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34919264249596617000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if (count := fresh_fruit.get(\'apple\', 0)) >= 4:\n    make_lemonade(count)\nelse:\n    out_of_stock()`, `34919264249596617000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token punctuation">:</span><span class="token operator">=</span> fresh_fruit<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'apple\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">4</span><span class="token punctuation">:</span>\n    make_lemonade<span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    out_of_stock<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>与刚才那个例子一样，修改之后的代码也比原来少了一行。但是这次，我们还要注意另外一个现象：赋值表达式本身是放在一对括号里面的。为什么要这样做呢？因为我们要在 if 语句里面把这个表达式的结果跟 4 这个值相比较。刚才柠檬汁的例子没有加括号，因为那时只凭赋值表达式本身的值就能决定 if/else 的走向：只要表达式的值不是 0，程序就进入 if 分支。但是这次不行，这次要把这个赋值表达式放在更大的表达式里面，所以必须用括号把它括起来。当然，在没有必要加括号的情况下，还是尽量别加括号比较好。</p>\n<p>还有一种类似的逻辑也会出现刚才说的重复代码，这指的是：我们要根据情况给某个变量赋予不同的值，紧接着要用这个变量做参数来调用某个函数。例如，若顾客要点香蕉冰沙，那我们首先得把香蕉切成好几份，然后用其中的两份来制作这道冰沙。如果不够两份，那就抛出香蕉不足（OutOfBananas）异常。下面用传统的写法实现这种逻辑：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86818044872954770000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def slice_bananas(count):\n    pass\n\n\nclass OutofBananas(Exception):\n    pass\n\n\ndef make_smoothies(count):\n    pass\n\n\nfresh_fruit = {\n    \'apple\': 10,\n    \'banana\': 8,\n    \'lemon\': 5,\n}\n\npieces = 0\ncount = fresh_fruit.get(\'banana\', 0)\nif count >= 2:\n    pieces = slice_bananas(count)\n\ntry:\n    smoothies = make_smoothies(pieces)\nexcept OutofBananas:\n    out_of_stock()`, `86818044872954770000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">slice_bananas</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">OutofBananas</span><span class="token punctuation">(</span>Exception<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">def</span> <span class="token function">make_smoothies</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\nfresh_fruit <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'apple\'</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>\n    <span class="token string">\'banana\'</span><span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span>\n    <span class="token string">\'lemon\'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\npieces <span class="token operator">=</span> <span class="token number">0</span>\ncount <span class="token operator">=</span> fresh_fruit<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'banana\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\n<span class="token keyword">if</span> count <span class="token operator">>=</span> <span class="token number">2</span><span class="token punctuation">:</span>\n    pieces <span class="token operator">=</span> slice_bananas<span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    smoothies <span class="token operator">=</span> make_smoothies<span class="token punctuation">(</span>pieces<span class="token punctuation">)</span>\n<span class="token keyword">except</span> OutofBananas<span class="token punctuation">:</span>\n    out_of_stock<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>还有一种传统的写法也很常见，就是把 if/else 结构上方那条 pieces = 0 的赋值语句移动到 else 块中。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37694059457301840000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`count = fresh_fruit.get(\'banana\', 0)\nif count >= 2:\n    pieces = slice_bananas(count)\nelse:\n    pieces = 0\n\ntry:\n    smoothies = make_smoothies(pieces)\nexcept OutofBananas:\n    out_of_stock()`, `37694059457301840000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">count <span class="token operator">=</span> fresh_fruit<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'banana\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\n<span class="token keyword">if</span> count <span class="token operator">>=</span> <span class="token number">2</span><span class="token punctuation">:</span>\n    pieces <span class="token operator">=</span> slice_bananas<span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    pieces <span class="token operator">=</span> <span class="token number">0</span>\n\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    smoothies <span class="token operator">=</span> make_smoothies<span class="token punctuation">(</span>pieces<span class="token punctuation">)</span>\n<span class="token keyword">except</span> OutofBananas<span class="token punctuation">:</span>\n    out_of_stock<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种写法看上去稍微有点儿怪，因为 if 与 else 这两个分支都给 pieces 变量定义了初始值。根据 Python 的作用域规则，这种分别定义变量初始值的写法是成立的（参见第 21 条）。虽说成立，但这样写看起来比较别扭，所以很多人喜欢用第一种写法，也就是在进入 if/else 结构之前，先把 pieces 的初始值给设置好。</p>\n<p>改用海象操作符来实现，可以少写一行代码，而且能够压低 count 变量的地位，让它只出现在 if 块里，这样我们就能更清楚地意识到 pieces 变量才是整段代码的重点。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46124399269351326000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pieces = 0\nif (count := fresh_fruit.get(\'banana\', 0)) >= 2:\n    pieces = slice_bananas(count)\n\ntry:\n    smoothies = make_smoothies(pieces)\nexcept OutofBananas:\n    out_of_stock()`, `46124399269351326000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">pieces <span class="token operator">=</span> <span class="token number">0</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token punctuation">:</span><span class="token operator">=</span> fresh_fruit<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'banana\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">2</span><span class="token punctuation">:</span>\n    pieces <span class="token operator">=</span> slice_bananas<span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    smoothies <span class="token operator">=</span> make_smoothies<span class="token punctuation">(</span>pieces<span class="token punctuation">)</span>\n<span class="token keyword">except</span> OutofBananas<span class="token punctuation">:</span>\n    out_of_stock<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>对于在 if 与 else 分支里面分别定义 pieces 变量的写法来说，海象操作符也能让代码变得清晰，因为这次不用再把 count 变量放到整个 if/else 块的上方了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80881170731488460000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if (count := fresh_fruit.get(\'banana\', 0)) >= 2:\n    pieces = slice_bananas(count)\nelse:\n    pieces = 0\n\ntry:\n    smoothies = make_smoothies(pieces)\nexcept OutofBananas:\n    out_of_stock()`, `80881170731488460000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token punctuation">:</span><span class="token operator">=</span> fresh_fruit<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'banana\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">2</span><span class="token punctuation">:</span>\n    pieces <span class="token operator">=</span> slice_bananas<span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    pieces <span class="token operator">=</span> <span class="token number">0</span>\n\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    smoothies <span class="token operator">=</span> make_smoothies<span class="token punctuation">(</span>pieces<span class="token punctuation">)</span>\n<span class="token keyword">except</span> OutofBananas<span class="token punctuation">:</span>\n    out_of_stock<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Python 新手经常会遇到这样一种困难，就是找不到好办法来实现 switch/case 结构。最接近这种结构的做法是在 if/else 结构里面继续嵌套 if/else 结构，或者使用 if/elif/else 结构。</p>\n<p>例如，我们想按照一定的顺序自动给客人制作饮品，这样就不用点餐了。下面这段逻辑先判断能不能做香蕉冰沙，如果不能，就做苹果汁，还不行，就做柠檬汁：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84628373506660970000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`count = fresh_fruit.get(\'banana\', 0)\nif count >= 2:\n    pieces = slice_bananas(count)\n    to_enjoy = make_smoothies(pieces)\nelse:\n    count = fresh_fruit.get(\'apple\', 0)\n    if count >= 4:\n        to_enjoy = make_cider(count)\n    else:\n        count = fresh_fruit.get(\'lemon\', 0)\n        if count:\n            to_enjoy = make_lemonade(count)\n        else:\n            to_enjoy = \'Nothing\'`, `84628373506660970000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">count <span class="token operator">=</span> fresh_fruit<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'banana\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\n<span class="token keyword">if</span> count <span class="token operator">>=</span> <span class="token number">2</span><span class="token punctuation">:</span>\n    pieces <span class="token operator">=</span> slice_bananas<span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n    to_enjoy <span class="token operator">=</span> make_smoothies<span class="token punctuation">(</span>pieces<span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    count <span class="token operator">=</span> fresh_fruit<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'apple\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\n    <span class="token keyword">if</span> count <span class="token operator">>=</span> <span class="token number">4</span><span class="token punctuation">:</span>\n        to_enjoy <span class="token operator">=</span> make_cider<span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        count <span class="token operator">=</span> fresh_fruit<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'lemon\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\n        <span class="token keyword">if</span> count<span class="token punctuation">:</span>\n            to_enjoy <span class="token operator">=</span> make_lemonade<span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            to_enjoy <span class="token operator">=</span> <span class="token string">\'Nothing\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种难看的写法其实在 Python 代码里特别常见。幸好现在有了海象操作符，让我们能够轻松地模拟出很接近 switch/case 的方案。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63086993734210450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if (count := fresh_fruit.get(\'banana\', 0)) >= 2:\n    pieces = slice_bananas(count)\n    to_enjoy = make_smoothies(pieces)\nelif (count := fresh_fruit.get(\'apple\', 0)) >= 4:\n    to_enjoy = make_cider(count)\nelif count := fresh_fruit.get(\'lemon\', 0):\n    to_enjoy = make_lemonade(count)\nelse:\n    to_enjoy = \'Nothing\'`, `63086993734210450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token punctuation">:</span><span class="token operator">=</span> fresh_fruit<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'banana\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">2</span><span class="token punctuation">:</span>\n    pieces <span class="token operator">=</span> slice_bananas<span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n    to_enjoy <span class="token operator">=</span> make_smoothies<span class="token punctuation">(</span>pieces<span class="token punctuation">)</span>\n<span class="token keyword">elif</span> <span class="token punctuation">(</span>count <span class="token punctuation">:</span><span class="token operator">=</span> fresh_fruit<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'apple\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">4</span><span class="token punctuation">:</span>\n    to_enjoy <span class="token operator">=</span> make_cider<span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n<span class="token keyword">elif</span> count <span class="token punctuation">:</span><span class="token operator">=</span> fresh_fruit<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'lemon\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    to_enjoy <span class="token operator">=</span> make_lemonade<span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    to_enjoy <span class="token operator">=</span> <span class="token string">\'Nothing\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个版本只比原来短五行，但是看起来却清晰得多，因为嵌套深度与缩进层数都变少了。只要碰到刚才那种难看的结构，我们就应该考虑能不能改用海象操作符来写。</p>\n<p>Python 新手还会遇到一个困难，就是缺少 do/while 循环结构。例如，我们要把新来的水果做成果汁并且装到瓶子里面，直到水果用完为止。下面先用普通的 while 循环来实现：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71343124927443010000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def pick_fruit():\n    pass\n\n\ndef make_juice(fruit, count):\n    pass\n\n\nbottles = []\nfresh_fruit = pick_fruit()\nwhile fresh_fruit:\n    for fruit, count in fresh_fruit.items():\n        batch = make_juice(fruit, count)\n        bottles.extend(batch)\n    fresh_fruit = pick_fruit()`, `71343124927443010000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">pick_fruit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">def</span> <span class="token function">make_juice</span><span class="token punctuation">(</span>fruit<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\nbottles <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\nfresh_fruit <span class="token operator">=</span> pick_fruit<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">while</span> fresh_fruit<span class="token punctuation">:</span>\n    <span class="token keyword">for</span> fruit<span class="token punctuation">,</span> count <span class="token keyword">in</span> fresh_fruit<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        batch <span class="token operator">=</span> make_juice<span class="token punctuation">(</span>fruit<span class="token punctuation">,</span> count<span class="token punctuation">)</span>\n        bottles<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>batch<span class="token punctuation">)</span>\n    fresh_fruit <span class="token operator">=</span> pick_fruit<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种写法必须把 <code class="language-text">fresh_fruit = pick_fruit()</code> 写两次，第一次是在进入 while 循环之前，因为我们要给 <code class="language-text">fresh_fruit</code> 设定初始值，第二次是在 while 循环体的末尾，因为我们得把下一轮需要处理的水果列表填充到 <code class="language-text">fresh_fruit</code> 里面。如果想复用这行代码，可以考虑 loop-and-a-half 模式。这个模式虽然能消除重复，但是会让 while 循环看起来很笨，因为它成了无限循环，程序只能通过 break 语句跳出这个循环。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13583981330174755000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`bottles = []\nwhile True:\n   fresh_fruit = pick_fruit()\n   if not fresh_fruit:\n      break\n    for fruit, count in fresh_fruit.items():\n        batch = make_juice(fruit, count)\n        bottles.extend(batch)`, `13583981330174755000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">bottles <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>\n   fresh_fruit <span class="token operator">=</span> pick_fruit<span class="token punctuation">(</span><span class="token punctuation">)</span>\n   <span class="token keyword">if</span> <span class="token keyword">not</span> fresh_fruit<span class="token punctuation">:</span>\n      <span class="token keyword">break</span>\n    <span class="token keyword">for</span> fruit<span class="token punctuation">,</span> count <span class="token keyword">in</span> fresh_fruit<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        batch <span class="token operator">=</span> make_juice<span class="token punctuation">(</span>fruit<span class="token punctuation">,</span> count<span class="token punctuation">)</span>\n        bottles<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>batch<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>有了海象操作符，就不需要使用 <code class="language-text">loop-and-a-half</code> 模式了，我们可以在每轮循环的开头给 <code class="language-text">fresh_fruit</code> 变量赋值，并根据变量的值来决定要不要继续循环。这个写法简单易读，所以应该成为首选方案。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3238097753238156300"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`bottles = []\nwhile fresh_fruit := pick_fruit():\n    for fruit, count in fresh_fruit.items():\n        batch = make_juice(fruit, count)\n        bottles.extend(batch)`, `3238097753238156300`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">bottles <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n<span class="token keyword">while</span> fresh_fruit <span class="token punctuation">:</span><span class="token operator">=</span> pick_fruit<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> fruit<span class="token punctuation">,</span> count <span class="token keyword">in</span> fresh_fruit<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        batch <span class="token operator">=</span> make_juice<span class="token punctuation">(</span>fruit<span class="token punctuation">,</span> count<span class="token punctuation">)</span>\n        bottles<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>batch<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在其他一些场合，赋值表达式也能缩减重复代码（参见第 29 条）。总之，如果某个表达式或赋值操作多次出现在一组代码里面，那就可以考虑用赋值表达式把这段代码改得简单一些。</p>\n<h3 id="总结-6"><a href="#%E6%80%BB%E7%BB%93-6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>赋值表达式通过海象操作符（:=）给变量赋值，并且让这个值成为这条表达式的结果，于是，我们可以利用这项特性来缩减代码。如果赋值表达式是大表达式里的一部分，就得用一对括号把它括起来。</li>\n<li>虽说 Python 不支持 switch/case 与 do/while 结构，但可以利用赋值表达式清晰地模拟出这种逻辑。</li>\n</ol>\n<h1 id="列表与字典"><a href="#%E5%88%97%E8%A1%A8%E4%B8%8E%E5%AD%97%E5%85%B8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>列表与字典</h1>\n<h2 id="第-11-条：学会对序列做切片"><a href="#%E7%AC%AC-11-%E6%9D%A1%EF%BC%9A%E5%AD%A6%E4%BC%9A%E5%AF%B9%E5%BA%8F%E5%88%97%E5%81%9A%E5%88%87%E7%89%87" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 11 条：学会对序列做切片</h2>\n<p>Python 有这样一种写法，可以从序列里面切割（slice）出一部分内容，让我们能够轻松地获取原序列的某个子集合。最简单的用法就是切割内置的 list、str 与 bytes。其实，凡是实现了 <code class="language-text">__getitem__</code> 与 <code class="language-text">__setitem__</code> 这两个特殊方法的类都可以切割（参见第 43 条）。</p>\n<p>最基本的写法是用 <code class="language-text">somelist[start:end]</code> 这一形式来切割，也就是从 start 开始一直取到 end 这个位置，但不包含 end 本身的元素。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49731017169605220000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']\nprint(\'Middle two:   \', a[3:5])\nprint(\'All but ends: \', a[1:7])\n\n>>>\nMiddle two:    [\'d\', \'e\']\nAll but ends:  [\'b\', \'c\', \'d\', \'e\', \'f\', \'g\']`, `49731017169605220000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Middle two:   \'</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'All but ends: \'</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nMiddle two<span class="token punctuation">:</span>    <span class="token punctuation">[</span><span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">]</span>\nAll but ends<span class="token punctuation">:</span>  <span class="token punctuation">[</span><span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果是从头开始切割列表，那就应该省略冒号左侧的下标 0，这样看起来更清晰。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78982181344334600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`assert a[:5] == a[0:5]`, `78982181344334600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">assert</span> a<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">==</span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>如果一直取到列表末尾，那就应该省略冒号右侧的下标，因为用不着专门把它写出来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66614998896201105000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`assert a[5:] == a[5:len(a)]`, `66614998896201105000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">assert</span> a<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">==</span> a<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token builtin">len</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>用负数作下标表示从列表末尾往前算。下面这些切割方式，即便是刚看到这段代码的人也应该能明白是什么意思。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50405185760626650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']\nprint(a[:]) # [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']\nprint(a[:5]) # [\'a\', \'b\', \'c\', \'d\', \'e\']\nprint(a[:-1]) # [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\']\nprint(a[4:]) # [\'e\', \'f\', \'g\', \'h\']\nprint(a[-3:]) # [\'f\', \'g\', \'h\']\nprint(a[2:5]) # [\'c\', \'d\', \'e\']\nprint(a[2:-1]) # [\'c\', \'d\', \'e\', \'f\', \'g\']\nprint(a[-3:-1]) # [\'f\', \'g\']`, `50405185760626650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># [\'a\', \'b\', \'c\', \'d\', \'e\']</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\']</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># [\'e\', \'f\', \'g\', \'h\']</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># [\'f\', \'g\', \'h\']</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># [\'c\', \'d\', \'e\']</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># [\'c\', \'d\', \'e\', \'f\', \'g\']</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># [\'f\', \'g\']</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果起点与终点所确定的范围超出了列表的边界，那么系统会自动忽略不存在的元素。利用这项特性，很容易就能构造出一个最多只有若干元素的输入序列，例如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90793973867988600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`first_twenty_items = a[:20]\nlast_twenty_items = a[-20:]`, `90793973867988600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">first_twenty_items <span class="token operator">=</span> a<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">]</span>\nlast_twenty_items <span class="token operator">=</span> a<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">:</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>切割时所用的下标可以越界，但是直接访问列表时却不行，那样会让程序抛出异常。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31007997909279683000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a[20]\n\n>>>\nTraceback ...\nIndexError: list index out of range`, `31007997909279683000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nIndexError<span class="token punctuation">:</span> <span class="token builtin">list</span> index out of <span class="token builtin">range</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>切割出来的列表是一份全新的列表。即便把某个元素换掉，也不会影响原列表中的相应位置。那个位置上的元素还是旧值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79561134095183900000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']\nb = a[3:]\nprint(\'Before:\', b)\nb[1] = 99\nprint(\'After: \', b)\nprint(\'No change:\', a)\n\n>>>\nBefore: [\'d\', \'e\', \'f\', \'g\', \'h\']\nAfter:  [\'d\', 99, \'f\', \'g\', \'h\']\nNo change: [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']`, `79561134095183900000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span>\nb <span class="token operator">=</span> a<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Before:\'</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span>\nb<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">99</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After: \'</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'No change:\'</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span>\nAfter<span class="token punctuation">:</span>  <span class="token punctuation">[</span><span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span>\nNo change<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>切片可以出现在赋值符号的左侧，表示用右侧那些元素把原列表中位于这个范围之内的元素换掉。与 unpacking 形式的赋值不同，这种赋值不要求等号两边所指定的元素个数必须相同（如果是做 unpacking，那么等号左侧用来接收数值的变量个数必须与等号右边所提供的数值个数一致，例如 <code class="language-text">a, b = c[:2]</code>，参见第 6 条）。在原列表中，位于切片范围之前和之后的那些元素会予以保留，但是列表的长度可能有所变化。例如在下面这个例子中，列表会变短，因为赋值符号右侧只提供了 3 个值，但是左侧那个切片却涵盖了 5 个值，列表会比原来少两个元素。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12059245907166249000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']\nprint(\'Before \', a)\na[2:7] = [99, 22, 14]\nprint(\'After  \', a)\n\n>>>\nBefore  [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']\nAfter   [\'a\', \'b\', 99, 22, 14, \'h\']`, `12059245907166249000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Before \'</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>\na<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">99</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After  \'</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore  <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span>\nAfter   <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>下面这段代码会使列表变长，因为赋值符号右侧的元素数量比左侧那个切片所涵盖的元素数量要多。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14616476542739253000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']\nprint(\'Before \', a)\na[2:3] = [47, 11]\nprint(\'After  \', a)\n\n>>>\nBefore  [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']\nAfter   [\'a\', \'b\', 47, 11, \'d\', \'e\', \'f\', \'g\', \'h\']`, `14616476542739253000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Before \'</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>\na<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">47</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After  \'</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore  <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span>\nAfter   <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token number">47</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>起止位置都留空的切片，如果出现在赋值符号右侧，那么表示给这个列表做副本，这样制作出来的新列表内容和原列表相同，但身份不同。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98626818912268710000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`b = a[:]\nassert b == a and b is not a`, `98626818912268710000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">b <span class="token operator">=</span> a<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span>\n<span class="token keyword">assert</span> b <span class="token operator">==</span> a <span class="token keyword">and</span> b <span class="token keyword">is</span> <span class="token keyword">not</span> a</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>把不带起止下标的切片放在赋值符号左边，表示是用右边那个列表的副本把左侧列表的全部内容替换掉（注意，左侧列表依然保持原来的身份，系统不会分配新的列表）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91559540307518160000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']\nb = a\nc = a[:]\nprint(\'Before a\', a)\nprint(\'Before b\', b)\nprint(\'Before c\', b)\na[:] = [101, 102, 103]\nassert b is a and c is not a  # Still the same list object\nprint(\'After a \', a)  # Now has different contents\nprint(\'After b \', b)  # Same list, so same contents as a\nprint(\'After c \', c)  # Not same list, same contents as a\n\n>>>\nBefore a [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']\nBefore b [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']\nBefore c [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']\nAfter a  [101, 102, 103]\nAfter b  [101, 102, 103]\nAfter c  [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']`, `91559540307518160000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span>\nb <span class="token operator">=</span> a\nc <span class="token operator">=</span> a<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Before a\'</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Before b\'</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Before c\'</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span>\na<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">102</span><span class="token punctuation">,</span> <span class="token number">103</span><span class="token punctuation">]</span>\n<span class="token keyword">assert</span> b <span class="token keyword">is</span> a <span class="token keyword">and</span> c <span class="token keyword">is</span> <span class="token keyword">not</span> a  <span class="token comment"># Still the same list object</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After a \'</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>  <span class="token comment"># Now has different contents</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After b \'</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span>  <span class="token comment"># Same list, so same contents as a</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After c \'</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span>  <span class="token comment"># Not same list, same contents as a</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore a <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span>\nBefore b <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span>\nBefore c <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span>\nAfter a  <span class="token punctuation">[</span><span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">102</span><span class="token punctuation">,</span> <span class="token number">103</span><span class="token punctuation">]</span>\nAfter b  <span class="token punctuation">[</span><span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">102</span><span class="token punctuation">,</span> <span class="token number">103</span><span class="token punctuation">]</span>\nAfter c  <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="总结-7"><a href="#%E6%80%BB%E7%BB%93-7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>切片要尽可能写得简单一些：如果从头开始选取，就省略起始下标 0；如果选到序列末尾，就省略终止下标。</li>\n<li>切片允许起始下标或终止下标越界，所以很容易就能表达“取开头多少个元素”（例如 <code class="language-text">a[:20]</code>）或“取末尾多少个元素”（例如 <code class="language-text">a[-20:0]</code>）等含义，而不用担心切片是否真有这么多元素。</li>\n<li>把切片放在赋值符号的左侧可以将原列表中这段范围内的元素用赋值符号右侧的元素替换掉，但可能会改变原列表的长度。</li>\n</ol>\n<h2 id="第-12-条：不要在切片里同时指定起止下标与步进"><a href="#%E7%AC%AC-12-%E6%9D%A1%EF%BC%9A%E4%B8%8D%E8%A6%81%E5%9C%A8%E5%88%87%E7%89%87%E9%87%8C%E5%90%8C%E6%97%B6%E6%8C%87%E5%AE%9A%E8%B5%B7%E6%AD%A2%E4%B8%8B%E6%A0%87%E4%B8%8E%E6%AD%A5%E8%BF%9B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 12 条：不要在切片里同时指定起止下标与步进</h2>\n<p>除了基本的切片写法（参见第 11 条）外，Python 还有一种特殊的步进切片形式，也就是 somelist[start:end:stride]。这种形式会在每 n 个元素里面选取一个，这样很容易就能把奇数位置上的元素与偶数位置上的元素分别通过 <code class="language-text">x[::2]</code> 与 <code class="language-text">x[1::2]</code> 选取出来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51480396764639760000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`x = [\'red\', \'orange\', \'yellow\', \'green\', \'blue\', \'purple\']\nodds = x[::2]\nevens = x[1::2]\nprint(odds)\nprint(evens)\n\n>>>\n[\'red\', \'yellow\', \'blue\']\n[\'orange\', \'green\', \'purple\']`, `51480396764639760000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">x <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'red\'</span><span class="token punctuation">,</span> <span class="token string">\'orange\'</span><span class="token punctuation">,</span> <span class="token string">\'yellow\'</span><span class="token punctuation">,</span> <span class="token string">\'green\'</span><span class="token punctuation">,</span> <span class="token string">\'blue\'</span><span class="token punctuation">,</span> <span class="token string">\'purple\'</span><span class="token punctuation">]</span>\nodds <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>\nevens <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>odds<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>evens<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token string">\'red\'</span><span class="token punctuation">,</span> <span class="token string">\'yellow\'</span><span class="token punctuation">,</span> <span class="token string">\'blue\'</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token string">\'orange\'</span><span class="token punctuation">,</span> <span class="token string">\'green\'</span><span class="token punctuation">,</span> <span class="token string">\'purple\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>带有步进的切片经常会引发意外的效果，并且使程序出现 bug。例如，Python 里面有个常见的技巧，就是把 -1 当成步进值对 bytes 类型的字符串做切片，这样就能将字符串反转过来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85384044335872590000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`x = b\'mongoose\'\ny = x[::-1]\nprint(y)\n\n>>>\nb\'esoognom\'`, `85384044335872590000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">x <span class="token operator">=</span> <span class="token string">b\'mongoose\'</span>\ny <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token string">b\'esoognom\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Unicode 形式的字符串也可以这样反转（参见第 3 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9180148538263344000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`x = \'多喝水\'\ny = x[::-1]\nprint(y)\n\n>>>\n水喝多`, `9180148538263344000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">x <span class="token operator">=</span> <span class="token string">\'多喝水\'</span>\ny <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n水喝多</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但如果把这种字符串编码成 UTF-8 标准的字节数据，就不能用这个技巧来反转了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11204426098383014000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`x = \'多喝水\'\nx = x.encode(\'utf-8\')\ny = x[::-1]\nz = y.decode(\'utf-8\')\n\n>>>\nTraceback ...\nUnicodeDecodeError: \'utf-8\' codec can\'t decode byte 0xb4 in position 0: invalid start byte`, `11204426098383014000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">x <span class="token operator">=</span> <span class="token string">\'多喝水\'</span>\nx <span class="token operator">=</span> x<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">\'utf-8\'</span><span class="token punctuation">)</span>\ny <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>\nz <span class="token operator">=</span> y<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">\'utf-8\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nUnicodeDecodeError<span class="token punctuation">:</span> <span class="token string">\'utf-8\'</span> codec can\'t decode byte <span class="token number">0xb4</span> <span class="token keyword">in</span> position <span class="token number">0</span><span class="token punctuation">:</span> invalid start byte</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>除了 -1 之外，用其他负数做步进值，有没有意义呢？请看下面的例子：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43832130210567225000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`x = [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']\nprint(x[::2])  # [\'a\', \'c\', \'e\', \'g\']\nprint(x[::-2])  # [\'h\', \'f\', \'d\', \'b\']`, `43832130210567225000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">x <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># [\'a\', \'c\', \'e\', \'g\']</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># [\'h\', \'f\', \'d\', \'b\']</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>上例中，<code class="language-text">::2</code> 表示从头开始往后选，每两个元素里面选一个。<code class="language-text">::-2</code> 的含义稍微有点儿绕，表示从末尾开始往前选，每两个元素里面选一个。</p>\n<p>同时使用起止下标与步进会让切片很难懂。方括号里面写三个值显得太过拥挤，读起来不大容易，而且在指定了步进值（尤其是负数步进值）的时候，我们必须很仔细地考虑：这究竟是从前往后取，还是从后往前取？</p>\n<p>为了避免这个问题，笔者建议大家不要把起止下标和步进值同时写在切片里。如果必须指定步进，那么尽量采用正数，而且要把起止下标都留空。即便必须同时使用步进值与起止下标，也应该考虑分成两次来写。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41774462398237060000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`y = x[::2]  # [\'a\', \'c\', \'e\', \'g\']\nz = y[1:-1] # [\'c\', \'e\']`, `41774462398237060000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">y <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>  <span class="token comment"># [\'a\', \'c\', \'e\', \'g\']</span>\nz <span class="token operator">=</span> y<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token comment"># [\'c\', \'e\']</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>像刚才那样先隔位选取然后再切割，会让程序多做一次浅拷贝（shallow copy）。所以，应该把最能缩减列表长度的那个切片操作放在前面。如果程序实在没有那么多时间或内存去分两步操作，那么可以改用内置的 itertools 模块中的 islice 方法（参见第 36 条），这个方法用起来更清晰，因为它的起止位置与步进值都不能是负数。</p>\n<h3 id="总结-8"><a href="#%E6%80%BB%E7%BB%93-8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>同时指定切片的起止下标与步进值理解起来会很困难。</li>\n<li>如果要指定步进值，那就省略起止下标，而且最好采用正数作为步进值，尽量别用负数。</li>\n<li>不要把起始位置、终止位置与步进值全都写在同一个切片操作里。如果必须同时使用这三项指标，那就分两次来做（其中一次隔位选取，另一次做切割），也可以改用 itertools 内置模块里的 islice 方法。</li>\n</ol>\n<h2 id="第-13-条：通过带星号的-unpacking-操作来捕获多个元素，不要用切片"><a href="#%E7%AC%AC-13-%E6%9D%A1%EF%BC%9A%E9%80%9A%E8%BF%87%E5%B8%A6%E6%98%9F%E5%8F%B7%E7%9A%84-unpacking-%E6%93%8D%E4%BD%9C%E6%9D%A5%E6%8D%95%E8%8E%B7%E5%A4%9A%E4%B8%AA%E5%85%83%E7%B4%A0%EF%BC%8C%E4%B8%8D%E8%A6%81%E7%94%A8%E5%88%87%E7%89%87" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 13 条：通过带星号的 unpacking 操作来捕获多个元素，不要用切片</h2>\n<p>基本的 unpacking 操作（参见第 6 条）有一项限制，就是必须提前确定需要拆解的序列的长度。例如，销售汽车的时候，我们可能会把每辆车的车龄写在一份列表中，然后按照从大到小的顺序排列好。如果试着通过基本的 unpacking 操作获取其中最旧的两辆车，那么程序运行时会出现异常。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52091187552884870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`car_ages = [0, 9, 4, 8, 7, 20, 19, 1, 6, 15]\ncar_ages_descending = sorted(car_ages, reverse=True)\noldest, second_oldest = car_ages_descending\n\n>>>\nTraceback ...\nValueError: too many values to unpack (expected 2)`, `52091187552884870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">car_ages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">]</span>\ncar_ages_descending <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>car_ages<span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\noldest<span class="token punctuation">,</span> second_oldest <span class="token operator">=</span> car_ages_descending\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nValueError<span class="token punctuation">:</span> too many values to unpack <span class="token punctuation">(</span>expected <span class="token number">2</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Python 新手经常通过下标与切片（参见第 11 条）来处理这个问题。例如，可以明确通过下标把最旧和第二旧的那两辆车取出来，然后把其余的车放到另一份列表中。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14220022653534525000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`car_ages = [0, 9, 4, 8, 7, 20, 19, 1, 6, 15]\ncar_ages_descending = sorted(car_ages, reverse=True)\noldest = car_ages_descending[0]\nsecond_oldest = car_ages_descending[1]\nothers = car_ages_descending[2:]\nprint(oldest, second_oldest, others)\n\n>>>\n20 19 [15, 9, 8, 7, 6, 4, 1, 0]`, `14220022653534525000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">car_ages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">]</span>\ncar_ages_descending <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>car_ages<span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\noldest <span class="token operator">=</span> car_ages_descending<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>\nsecond_oldest <span class="token operator">=</span> car_ages_descending<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>\nothers <span class="token operator">=</span> car_ages_descending<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>oldest<span class="token punctuation">,</span> second_oldest<span class="token punctuation">,</span> others<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">20</span> <span class="token number">19</span> <span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样做没问题，但是下标与切片会让代码看起来很乱。而且，用这种办法把序列中的元素分成多个子集合，其实很容易出错，因为我们通常容易把下标多写或少写一个位置。例如，若修改了其中一行，但却忘了更新另一行，那就会遇到这种错误。</p>\n<p>这个问题通过带星号的表达式（starred expression）来解决会更好一些，这也是一种 unpacking 操作，它可以把无法由普通变量接收的那些元素全都囊括进去。下面用带星号的 unpacking 操作改写刚才那段代码，这次既不用取下标，也不用做切片。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31058714305642510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`car_ages = [0, 9, 4, 8, 7, 20, 19, 1, 6, 15]\ncar_ages_descending = sorted(car_ages, reverse=True)\noldest, second_oldest, *others = car_ages_descending\nprint(oldest, second_oldest, others)\n\n>>>\n20 19 [15, 9, 8, 7, 6, 4, 1, 0]`, `31058714305642510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">car_ages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">]</span>\ncar_ages_descending <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>car_ages<span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\noldest<span class="token punctuation">,</span> second_oldest<span class="token punctuation">,</span> <span class="token operator">*</span>others <span class="token operator">=</span> car_ages_descending\n<span class="token keyword">print</span><span class="token punctuation">(</span>oldest<span class="token punctuation">,</span> second_oldest<span class="token punctuation">,</span> others<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">20</span> <span class="token number">19</span> <span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写简短易读，而且不容易出错，因为它不要求我们在修改完其中一个下标之后，还必须记得同步更新其他的下标。</p>\n<p>这种带星号的表达式可以出现在任意位置，所以它能够捕获序列中的任何一段元素。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39144678787378280000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`car_ages = [0, 9, 4, 8, 7, 20, 19, 1, 6, 15]\ncar_ages_descending = sorted(car_ages, reverse=True)\noldest, *others, youngest = car_ages_descending\nprint(oldest, youngest, others)\n*others, second_youngest, youngest = car_ages_descending\nprint(youngest, second_youngest, others)\n\n>>>\n20 0 [19, 15, 9, 8, 7, 6, 4, 1]\n0 1 [20, 19, 15, 9, 8, 7, 6, 4]`, `39144678787378280000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">car_ages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">]</span>\ncar_ages_descending <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>car_ages<span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\noldest<span class="token punctuation">,</span> <span class="token operator">*</span>others<span class="token punctuation">,</span> youngest <span class="token operator">=</span> car_ages_descending\n<span class="token keyword">print</span><span class="token punctuation">(</span>oldest<span class="token punctuation">,</span> youngest<span class="token punctuation">,</span> others<span class="token punctuation">)</span>\n<span class="token operator">*</span>others<span class="token punctuation">,</span> second_youngest<span class="token punctuation">,</span> youngest <span class="token operator">=</span> car_ages_descending\n<span class="token keyword">print</span><span class="token punctuation">(</span>youngest<span class="token punctuation">,</span> second_youngest<span class="token punctuation">,</span> others<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">20</span> <span class="token number">0</span> <span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>\n<span class="token number">0</span> <span class="token number">1</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>只不过，在使用这种写法时，至少要有一个普通的接收变量与它搭配，否则就会出现 SyntaxError。例如不能像下面这样，只使用带星号的表达式而不搭配普通变量。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35082861982112834000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`car_ages = [0, 9, 4, 8, 7, 20, 19, 1, 6, 15]\ncar_ages_descending = sorted(car_ages, reverse=True)\n*others = car_ages_descending\n\n>>>\nSyntaxError: starred assignment target must be in a list or tuple`, `35082861982112834000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">car_ages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">]</span>\ncar_ages_descending <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>car_ages<span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\n<span class="token operator">*</span>others <span class="token operator">=</span> car_ages_descending\n\n<span class="token operator">>></span><span class="token operator">></span>\nSyntaxError<span class="token punctuation">:</span> starred assignment target must be <span class="token keyword">in</span> a <span class="token builtin">list</span> <span class="token keyword">or</span> <span class="token builtin">tuple</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>另外，对于单层结构来说，同一级里面最多只能出现一次带星号的 unpacking。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51642498965818655000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`first, *middle, *second_middle, last = [1, 2, 3, 4]\n\n>>>\nSyntaxError: two starred expressions in assignment`, `51642498965818655000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">first<span class="token punctuation">,</span> <span class="token operator">*</span>middle<span class="token punctuation">,</span> <span class="token operator">*</span>second_middle<span class="token punctuation">,</span> last <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nSyntaxError<span class="token punctuation">:</span> two starred expressions <span class="token keyword">in</span> assignment</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果要拆解的结构有很多层，那么同一级的不同部分里面可以各自出现带星号的 unpacking 操作。当然笔者并不推荐这种写法（类似的建议参见第 19 条）。这里举这样一个例子，是想帮助大家理解这种带星号的表达式可以实现怎样的拆分效果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27324126666719883000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`car_inventory = {\n    \'Downtown\': (\'Silver Shadow\', \'Pinto\', \'DMC\'),\n    \'Airport\': (\'Skyline\', \'Viper\', \'Gremlin\', \'Nova\'),\n}\n\n((loc1, (best1, *rest1)),\n (loc2, (best2, *rest2))) = car_inventory.items()\nprint(f\'Best at {loc1} is {best1}, {len(rest1)} others\')\nprint(f\'Best at {loc2} is {best2}, {len(rest2)} others\')\n\n>>>\nBest at Downtown is Silver Shadow, 2 others\nBest at Airport is Skyline, 3 others`, `27324126666719883000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">car_inventory <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'Downtown\'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">\'Silver Shadow\'</span><span class="token punctuation">,</span> <span class="token string">\'Pinto\'</span><span class="token punctuation">,</span> <span class="token string">\'DMC\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token string">\'Airport\'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">\'Skyline\'</span><span class="token punctuation">,</span> <span class="token string">\'Viper\'</span><span class="token punctuation">,</span> <span class="token string">\'Gremlin\'</span><span class="token punctuation">,</span> <span class="token string">\'Nova\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\n<span class="token punctuation">(</span><span class="token punctuation">(</span>loc1<span class="token punctuation">,</span> <span class="token punctuation">(</span>best1<span class="token punctuation">,</span> <span class="token operator">*</span>rest1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n <span class="token punctuation">(</span>loc2<span class="token punctuation">,</span> <span class="token punctuation">(</span>best2<span class="token punctuation">,</span> <span class="token operator">*</span>rest2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> car_inventory<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Best at </span><span class="token interpolation"><span class="token punctuation">{</span>loc1<span class="token punctuation">}</span></span><span class="token string"> is </span><span class="token interpolation"><span class="token punctuation">{</span>best1<span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>rest1<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> others\'</span></span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Best at </span><span class="token interpolation"><span class="token punctuation">{</span>loc2<span class="token punctuation">}</span></span><span class="token string"> is </span><span class="token interpolation"><span class="token punctuation">{</span>best2<span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>rest2<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> others\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBest at Downtown <span class="token keyword">is</span> Silver Shadow<span class="token punctuation">,</span> <span class="token number">2</span> others\nBest at Airport <span class="token keyword">is</span> Skyline<span class="token punctuation">,</span> <span class="token number">3</span> others</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>带星号的表达式总会形成一份列表实例。如果要拆分的序列里已经没有元素留给它了，那么列表就是空白的。如果能提前确定有待处理的序列里至少会有 N 个元素，那么这项特性就相当有用。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56290379657715510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`short_list = [1, 2]\nfirst, second, *rest = short_list\nprint(first, second, rest)\n\n>>>\n1 2 []`, `56290379657715510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">short_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>\nfirst<span class="token punctuation">,</span> second<span class="token punctuation">,</span> <span class="token operator">*</span>rest <span class="token operator">=</span> short_list\n<span class="token keyword">print</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span> second<span class="token punctuation">,</span> rest<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">1</span> <span class="token number">2</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>unpacking 操作也可以用在迭代器上，但是这样写与把数据拆分到多个变量里面的那种基本写法相比，并没有太大优势。例如，我可以先构造长度为 2 的取值范围（range），并把它封装在 it 这个迭代器里，然后将其中的值拆分到 first 与 second 这两个变量里。但这样写还不如直接使用形式相符的静态列表（例如[1, 2]），那样更简单。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39408911934816170000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`it = iter(range(1, 3))\nfirst, second = it\nprint(f\'{first} and {second}\')\n\n>>>\n1 and 2`, `39408911934816170000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">it <span class="token operator">=</span> <span class="token builtin">iter</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\nfirst<span class="token punctuation">,</span> second <span class="token operator">=</span> it\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>first<span class="token punctuation">}</span></span><span class="token string"> and </span><span class="token interpolation"><span class="token punctuation">{</span>second<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">1</span> <span class="token keyword">and</span> <span class="token number">2</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>对迭代器做 unpacking 操作的好处，主要体现在带星号的用法上面，它使迭代器的拆分值更清晰。例如，这里有个生成器，每次可以从含有整个一周的汽车订单的 CSV 文件中取出一行数据。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14601557190345239000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def generate_csv():\n    yield (\'Date\', \'Make\', \'Model\', \'Year\', \'Price\')\n    # ...`, `14601557190345239000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">generate_csv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">yield</span> <span class="token punctuation">(</span><span class="token string">\'Date\'</span><span class="token punctuation">,</span> <span class="token string">\'Make\'</span><span class="token punctuation">,</span> <span class="token string">\'Model\'</span><span class="token punctuation">,</span> <span class="token string">\'Year\'</span><span class="token punctuation">,</span> <span class="token string">\'Price\'</span><span class="token punctuation">)</span>\n    <span class="token comment"># ...</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>我们可以用下标和切片来处理这个生成器所给出的结果，但这样写需要很多行代码，而且看着比较混乱。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19823496960167965000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def generate_csv():\n    yield (\'Date\', \'Make\', \'Model\', \'Year\', \'Price\')\n    yield (\'Date\', \'Make\', \'Model\', \'Year\', \'Price\')\n    yield (\'Date\', \'Make\', \'Model\', \'Year\', \'Price\')\n    yield (\'Date\', \'Make\', \'Model\', \'Year\', \'Price\')\n    yield (\'Date\', \'Make\', \'Model\', \'Year\', \'Price\')\n    # ...\n\n\nall_csv_rows = list(generate_csv())\nheader = all_csv_rows[0]\nrows = all_csv_rows[1:]\nprint(\'CSV Header:\', header)\nprint(\'Row count:\', len(rows))\n\n>>>\nCSV Header: (\'Date\', \'Make\', \'Model\', \'Year\', \'Price\')\nRow count: 4`, `19823496960167965000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">generate_csv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">yield</span> <span class="token punctuation">(</span><span class="token string">\'Date\'</span><span class="token punctuation">,</span> <span class="token string">\'Make\'</span><span class="token punctuation">,</span> <span class="token string">\'Model\'</span><span class="token punctuation">,</span> <span class="token string">\'Year\'</span><span class="token punctuation">,</span> <span class="token string">\'Price\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token punctuation">(</span><span class="token string">\'Date\'</span><span class="token punctuation">,</span> <span class="token string">\'Make\'</span><span class="token punctuation">,</span> <span class="token string">\'Model\'</span><span class="token punctuation">,</span> <span class="token string">\'Year\'</span><span class="token punctuation">,</span> <span class="token string">\'Price\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token punctuation">(</span><span class="token string">\'Date\'</span><span class="token punctuation">,</span> <span class="token string">\'Make\'</span><span class="token punctuation">,</span> <span class="token string">\'Model\'</span><span class="token punctuation">,</span> <span class="token string">\'Year\'</span><span class="token punctuation">,</span> <span class="token string">\'Price\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token punctuation">(</span><span class="token string">\'Date\'</span><span class="token punctuation">,</span> <span class="token string">\'Make\'</span><span class="token punctuation">,</span> <span class="token string">\'Model\'</span><span class="token punctuation">,</span> <span class="token string">\'Year\'</span><span class="token punctuation">,</span> <span class="token string">\'Price\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token punctuation">(</span><span class="token string">\'Date\'</span><span class="token punctuation">,</span> <span class="token string">\'Make\'</span><span class="token punctuation">,</span> <span class="token string">\'Model\'</span><span class="token punctuation">,</span> <span class="token string">\'Year\'</span><span class="token punctuation">,</span> <span class="token string">\'Price\'</span><span class="token punctuation">)</span>\n    <span class="token comment"># ...</span>\n\n\nall_csv_rows <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>generate_csv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\nheader <span class="token operator">=</span> all_csv_rows<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>\nrows <span class="token operator">=</span> all_csv_rows<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'CSV Header:\'</span><span class="token punctuation">,</span> header<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Row count:\'</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>rows<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nCSV Header<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">\'Date\'</span><span class="token punctuation">,</span> <span class="token string">\'Make\'</span><span class="token punctuation">,</span> <span class="token string">\'Model\'</span><span class="token punctuation">,</span> <span class="token string">\'Year\'</span><span class="token punctuation">,</span> <span class="token string">\'Price\'</span><span class="token punctuation">)</span>\nRow count<span class="token punctuation">:</span> <span class="token number">4</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>利用带星号的 unpacking 操作，我们可以把第一行（表头）单独放在 header 变量里，同时把迭代器所给出的其余内容合起来表示成 rows 变量。这样写就清楚多了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68948756432011395000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def generate_csv():\n    yield (\'Date\', \'Make\', \'Model\', \'Year\', \'Price\')\n    yield (\'Date\', \'Make\', \'Model\', \'Year\', \'Price\')\n    yield (\'Date\', \'Make\', \'Model\', \'Year\', \'Price\')\n    yield (\'Date\', \'Make\', \'Model\', \'Year\', \'Price\')\n    yield (\'Date\', \'Make\', \'Model\', \'Year\', \'Price\')\n    # ...\n\n\nit = list(generate_csv())\nheader, *rows = it\nprint(\'CSV Header:\', header)\nprint(\'Row count:\', len(rows))\n\n>>>\nCSV Header: (\'Date\', \'Make\', \'Model\', \'Year\', \'Price\')\nRow count: 4`, `68948756432011395000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">generate_csv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">yield</span> <span class="token punctuation">(</span><span class="token string">\'Date\'</span><span class="token punctuation">,</span> <span class="token string">\'Make\'</span><span class="token punctuation">,</span> <span class="token string">\'Model\'</span><span class="token punctuation">,</span> <span class="token string">\'Year\'</span><span class="token punctuation">,</span> <span class="token string">\'Price\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token punctuation">(</span><span class="token string">\'Date\'</span><span class="token punctuation">,</span> <span class="token string">\'Make\'</span><span class="token punctuation">,</span> <span class="token string">\'Model\'</span><span class="token punctuation">,</span> <span class="token string">\'Year\'</span><span class="token punctuation">,</span> <span class="token string">\'Price\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token punctuation">(</span><span class="token string">\'Date\'</span><span class="token punctuation">,</span> <span class="token string">\'Make\'</span><span class="token punctuation">,</span> <span class="token string">\'Model\'</span><span class="token punctuation">,</span> <span class="token string">\'Year\'</span><span class="token punctuation">,</span> <span class="token string">\'Price\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token punctuation">(</span><span class="token string">\'Date\'</span><span class="token punctuation">,</span> <span class="token string">\'Make\'</span><span class="token punctuation">,</span> <span class="token string">\'Model\'</span><span class="token punctuation">,</span> <span class="token string">\'Year\'</span><span class="token punctuation">,</span> <span class="token string">\'Price\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token punctuation">(</span><span class="token string">\'Date\'</span><span class="token punctuation">,</span> <span class="token string">\'Make\'</span><span class="token punctuation">,</span> <span class="token string">\'Model\'</span><span class="token punctuation">,</span> <span class="token string">\'Year\'</span><span class="token punctuation">,</span> <span class="token string">\'Price\'</span><span class="token punctuation">)</span>\n    <span class="token comment"># ...</span>\n\n\nit <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>generate_csv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\nheader<span class="token punctuation">,</span> <span class="token operator">*</span>rows <span class="token operator">=</span> it\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'CSV Header:\'</span><span class="token punctuation">,</span> header<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Row count:\'</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>rows<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nCSV Header<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">\'Date\'</span><span class="token punctuation">,</span> <span class="token string">\'Make\'</span><span class="token punctuation">,</span> <span class="token string">\'Model\'</span><span class="token punctuation">,</span> <span class="token string">\'Year\'</span><span class="token punctuation">,</span> <span class="token string">\'Price\'</span><span class="token punctuation">)</span>\nRow count<span class="token punctuation">:</span> <span class="token number">4</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>带星号的这部分总是会形成一份列表，所以要注意，这有可能耗尽计算机的全部内存并导致程序崩溃。首先必须确定系统有足够的内存可以存储拆分出来的结果数据，然后才可以对迭代器使用带星号的 unpacking 操作（还有另一种做法，参见第 31 条）。</p>\n<h3 id="总结-9"><a href="#%E6%80%BB%E7%BB%93-9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>拆分数据结构并把其中的数据赋给变量时，可以用带星号的表达式，将结构中无法与普通变量相匹配的内容捕获到一份列表里。</li>\n<li>这种带星号的表达式可以出现在赋值符号左侧的任意位置，它总是会形成一份含有零个或多个值的列表。</li>\n<li>在把列表拆解成互相不重叠的多个部分时，这种带星号的 unpacking 方式比较清晰，而通过下标与切片来实现的方式则很容易出错。</li>\n</ol>\n<h2 id="第-14-条：用-sort-方法的-key-参数来表示复杂的排序逻辑"><a href="#%E7%AC%AC-14-%E6%9D%A1%EF%BC%9A%E7%94%A8-sort-%E6%96%B9%E6%B3%95%E7%9A%84-key-%E5%8F%82%E6%95%B0%E6%9D%A5%E8%A1%A8%E7%A4%BA%E5%A4%8D%E6%9D%82%E7%9A%84%E6%8E%92%E5%BA%8F%E9%80%BB%E8%BE%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 14 条：用 sort 方法的 key 参数来表示复杂的排序逻辑</h2>\n<p>内置的列表类型提供了名叫 sort 的方法，可以根据多项指标给 list 实例中的元素排序。在默认情况下，sort 方法总是按照自然升序排列列表内的元素。例如，如果列表中的元素都是整数，那么它就按数值从小到大排列。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54651177935940500000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`numbers = [93, 86, 11, 68, 70]\nnumbers.sort()\nprint(numbers)\n\n>>>\n[11, 68, 70, 86, 93]`, `54651177935940500000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">numbers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">93</span><span class="token punctuation">,</span> <span class="token number">86</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">68</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">]</span>\nnumbers<span class="token punctuation">.</span>sort<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">68</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">,</span> <span class="token number">86</span><span class="token punctuation">,</span> <span class="token number">93</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里定义了一个 Tool 类表示各种建筑工具，它带有 <code class="language-text">__repr__</code> 方法，因此我们能把这个类的实例打印成字符串。</p>\n<p>如果仅仅这样写，那么这个由该类的对象所构成的列表是没办法用 sort 方法排序的，因为 sort 方法发现，排序所需要的特殊方法并没有定义在 Tool 类中。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83880949061569280000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Tool:\n    def __init__(self, name, weight):\n        self.name = name\n        self.weight = weight\n\n    def __repr__(self):\n        return f\'Tool({self.name!r}, {self.weight})\'\n\n\ntools = [\n    Tool(\'level\', 3.5),\n    Tool(\'hammer\', 1.25),\n    Tool(\'screwdriver\', 0.5),\n    Tool(\'chisel\', 0.25),\n]\n\ntools.sort()\n\n>>>\nTraceback ...\nTypeError: \'<\' not supported between instances of \'Tool\' and \'Tool\'`, `83880949061569280000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Tool</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> weight<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name\n        self<span class="token punctuation">.</span>weight <span class="token operator">=</span> weight\n\n    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f\'Tool(</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>weight<span class="token punctuation">}</span></span><span class="token string">)\'</span></span>\n\n\ntools <span class="token operator">=</span> <span class="token punctuation">[</span>\n    Tool<span class="token punctuation">(</span><span class="token string">\'level\'</span><span class="token punctuation">,</span> <span class="token number">3.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    Tool<span class="token punctuation">(</span><span class="token string">\'hammer\'</span><span class="token punctuation">,</span> <span class="token number">1.25</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    Tool<span class="token punctuation">(</span><span class="token string">\'screwdriver\'</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    Tool<span class="token punctuation">(</span><span class="token string">\'chisel\'</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">]</span>\n\ntools<span class="token punctuation">.</span>sort<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> <span class="token string">\'&lt;\'</span> <span class="token keyword">not</span> supported between instances of <span class="token string">\'Tool\'</span> <span class="token keyword">and</span> <span class="token string">\'Tool\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>下面用 lambda 关键字定义这样的一个函数，把它传给 sort 方法的 key 参数，让我们能够按照 name 的字母顺序排列这些 Tool 对象。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69526823113907430000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Tool:\n    def __init__(self, name, weight):\n        self.name = name\n        self.weight = weight\n\n    def __repr__(self):\n        return f\'Tool({self.name!r}, {self.weight})\'\n\n\ntools = [\n    Tool(\'level\', 3.5),\n    Tool(\'hammer\', 1.25),\n    Tool(\'screwdriver\', 0.5),\n    Tool(\'chisel\', 0.25),\n]\n\nprint(\'Unsorted:\', repr(tools))\ntools.sort(key=lambda x: x.name)\nprint(\'\\nSorted:\', tools)\n\n>>>\nUnsorted: [Tool(\'level\', 3.5), Tool(\'hammer\', 1.25), Tool(\'screwdriver\', 0.5), Tool(\'chisel\', 0.25)]\n\nSorted: [Tool(\'chisel\', 0.25), Tool(\'hammer\', 1.25), Tool(\'level\', 3.5), Tool(\'screwdriver\', 0.5)]`, `69526823113907430000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Tool</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> weight<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name\n        self<span class="token punctuation">.</span>weight <span class="token operator">=</span> weight\n\n    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f\'Tool(</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>weight<span class="token punctuation">}</span></span><span class="token string">)\'</span></span>\n\n\ntools <span class="token operator">=</span> <span class="token punctuation">[</span>\n    Tool<span class="token punctuation">(</span><span class="token string">\'level\'</span><span class="token punctuation">,</span> <span class="token number">3.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    Tool<span class="token punctuation">(</span><span class="token string">\'hammer\'</span><span class="token punctuation">,</span> <span class="token number">1.25</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    Tool<span class="token punctuation">(</span><span class="token string">\'screwdriver\'</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    Tool<span class="token punctuation">(</span><span class="token string">\'chisel\'</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">]</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Unsorted:\'</span><span class="token punctuation">,</span> <span class="token builtin">repr</span><span class="token punctuation">(</span>tools<span class="token punctuation">)</span><span class="token punctuation">)</span>\ntools<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">.</span>name<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'\\nSorted:\'</span><span class="token punctuation">,</span> tools<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nUnsorted<span class="token punctuation">:</span> <span class="token punctuation">[</span>Tool<span class="token punctuation">(</span><span class="token string">\'level\'</span><span class="token punctuation">,</span> <span class="token number">3.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Tool<span class="token punctuation">(</span><span class="token string">\'hammer\'</span><span class="token punctuation">,</span> <span class="token number">1.25</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Tool<span class="token punctuation">(</span><span class="token string">\'screwdriver\'</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Tool<span class="token punctuation">(</span><span class="token string">\'chisel\'</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n\nSorted<span class="token punctuation">:</span> <span class="token punctuation">[</span>Tool<span class="token punctuation">(</span><span class="token string">\'chisel\'</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Tool<span class="token punctuation">(</span><span class="token string">\'hammer\'</span><span class="token punctuation">,</span> <span class="token number">1.25</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Tool<span class="token punctuation">(</span><span class="token string">\'level\'</span><span class="token punctuation">,</span> <span class="token number">3.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Tool<span class="token punctuation">(</span><span class="token string">\'screwdriver\'</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>有时我们可能需要用多个标准来排序。可以利用元组的特性：如果两个元组的首个元素相等，就比较第二个元素，如果仍然相等，就继续往下比较。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58328613238323080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Tool:\n    def __init__(self, name, weight):\n        self.name = name\n        self.weight = weight\n\n    def __repr__(self):\n        return f\'Tool({self.name!r}, {self.weight})\'\n\n\npower_tools = [\n    Tool(\'drill\', 4),\n    Tool(\'circular saw\', 5),\n    Tool(\'jackhammer\', 40),\n    Tool(\'sander\', 4),\n]\n\npower_tools.sort(key=lambda x: (x.weight, x.name))\nprint(power_tools)\n\npower_tools.sort(key=lambda x: (x.weight, x.name), reverse=True)\nprint(power_tools)\n\n>>>\n[Tool(\'drill\', 4), Tool(\'sander\', 4), Tool(\'circular saw\', 5), Tool(\'jackhammer\', 40)]\n[Tool(\'jackhammer\', 40), Tool(\'circular saw\', 5), Tool(\'sander\', 4), Tool(\'drill\', 4)]`, `58328613238323080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Tool</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> weight<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name\n        self<span class="token punctuation">.</span>weight <span class="token operator">=</span> weight\n\n    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f\'Tool(</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>weight<span class="token punctuation">}</span></span><span class="token string">)\'</span></span>\n\n\npower_tools <span class="token operator">=</span> <span class="token punctuation">[</span>\n    Tool<span class="token punctuation">(</span><span class="token string">\'drill\'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    Tool<span class="token punctuation">(</span><span class="token string">\'circular saw\'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    Tool<span class="token punctuation">(</span><span class="token string">\'jackhammer\'</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    Tool<span class="token punctuation">(</span><span class="token string">\'sander\'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">]</span>\n\npower_tools<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>weight<span class="token punctuation">,</span> x<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>power_tools<span class="token punctuation">)</span>\n\npower_tools<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>weight<span class="token punctuation">,</span> x<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>power_tools<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span>Tool<span class="token punctuation">(</span><span class="token string">\'drill\'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Tool<span class="token punctuation">(</span><span class="token string">\'sander\'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Tool<span class="token punctuation">(</span><span class="token string">\'circular saw\'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Tool<span class="token punctuation">(</span><span class="token string">\'jackhammer\'</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span>Tool<span class="token punctuation">(</span><span class="token string">\'jackhammer\'</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Tool<span class="token punctuation">(</span><span class="token string">\'circular saw\'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Tool<span class="token punctuation">(</span><span class="token string">\'sander\'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Tool<span class="token punctuation">(</span><span class="token string">\'drill\'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种做法有个缺点，就是 key 函数所构造的这个元组只能按同一个排序方向来对比它所表示的各项指标（要是升序，就都得是升序；要是降序，就都得是降序），可以利用以下方法实现不同方向的排序</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6405519538772264000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`power_tools.sort(key=lambda x: (-x.weight, x.name))\nprint(power_tools)`, `6405519538772264000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">power_tools<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token operator">-</span>x<span class="token punctuation">.</span>weight<span class="token punctuation">,</span> x<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>power_tools<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>但是 str 类型不支持一元减操作符，可以通过多次调用 sort 方法实现不同方向的排序，这里利用了 sort 方法是稳定排序算法的原理</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72642692735934930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`power_tools.sort(key=lambda x: x.name)  # Name ascending\npower_tools.sort(key=lambda x: x.weight, reverse=True)  # Weight descending\nprint(power_tools)`, `72642692735934930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">power_tools<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">.</span>name<span class="token punctuation">)</span>  <span class="token comment"># Name ascending</span>\npower_tools<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">.</span>weight<span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># Weight descending</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>power_tools<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>无论有多少项排序指标都可以按照这种思路来实现，而且每项指标可以分别按照各自的方向来排，不用全都是升序或全都是降序。只需要倒着写即可，也就是把最主要的那项排序指标放在最后一轮处理。在上面的例子中，首要指标是重量降序，次要指标是名称升序，所以先按名称升序排列，然后按重量降序排列。</p>\n<p>尽管这两种思路都能实现同样的效果，但只调用一次 sort，还是要比多次调用 sort 更为简单。所以，在实现多个指标按不同方向排序时，应该优先考虑让 key 函数返回元组，并对元组中的相应指标取相反数。只有在万不得已的时候，才可以考虑多次调用 sort 方法。</p>\n<h3 id="总结-10"><a href="#%E6%80%BB%E7%BB%93-10" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>列表的 sort 方法可以根据自然顺序给其中的字符串、整数、元组等内置类型的元素进行排序。</li>\n<li>普通对象如果通过特殊方法定义了自然顺序，那么也可以用 sort 方法来排列，但这样的对象并不多见。</li>\n<li>可以把辅助函数传给 sort 方法的 key 参数，让 sort 根据这个函数所返回的值来排列元素顺序，而不是根据元素本身来排列。</li>\n<li>如果排序时要依据的指标有很多项，可以把它们放在一个元组中，让 key 函数返回这样的元组。对于支持一元减操作符的类型来说，可以单独给这项指标取反，让排序算法在这项指标上按照相反的方向处理。</li>\n<li>如果这些指标不支持一元减操作符，可以多次调用 sort 方法，并在每次调用时分别指定 key 函数与 reverse 参数。最次要的指标放在第一轮处理，然后逐步处理更为重要的指标，首要指标放在最后一轮处理。</li>\n</ol>\n<h2 id="第-15-条：不要过分依赖给字典添加条目时所用的顺序"><a href="#%E7%AC%AC-15-%E6%9D%A1%EF%BC%9A%E4%B8%8D%E8%A6%81%E8%BF%87%E5%88%86%E4%BE%9D%E8%B5%96%E7%BB%99%E5%AD%97%E5%85%B8%E6%B7%BB%E5%8A%A0%E6%9D%A1%E7%9B%AE%E6%97%B6%E6%89%80%E7%94%A8%E7%9A%84%E9%A1%BA%E5%BA%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 15 条：不要过分依赖给字典添加条目时所用的顺序</h2>\n<p>在 Python 3.5 与之前的版本中，迭代字典（dict）时所看到的顺序好像是任意的，不一定与当初把这些键值对添加到字典时的顺序相同。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76993822651036530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# Python 3.5\nbaby_names = {\n    \'cat\': \'kitten\',\n    \'dog\': \'puppy\',\n}\n\nprint(baby_names)\n\n>>>\n{\'dog\': \'puppy\', \'cat\': \'kitten\'}`, `76993822651036530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment"># Python 3.5</span>\nbaby_names <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'cat\'</span><span class="token punctuation">:</span> <span class="token string">\'kitten\'</span><span class="token punctuation">,</span>\n    <span class="token string">\'dog\'</span><span class="token punctuation">:</span> <span class="token string">\'puppy\'</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span>baby_names<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">{</span><span class="token string">\'dog\'</span><span class="token punctuation">:</span> <span class="token string">\'puppy\'</span><span class="token punctuation">,</span> <span class="token string">\'cat\'</span><span class="token punctuation">:</span> <span class="token string">\'kitten\'</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>之所以出现这种效果，是因为字典类型以前是用哈希表算法来实现的（这个算法通过内置的 hash 函数与一个随机的种子数来运行，而该种子数会在每次启动 Python 解释器时确定）。所以，这样的机制导致这些键值对在字典中的存放顺序不一定会与添加时的顺序相同，而且每次运行程序的时候，存放顺序可能都不一样。</p>\n<p>从 Python 3.6 开始，字典会保留这些键值对在添加时所用的顺序，而且 Python 3.7 版的语言规范正式确立了这条规则。于是，在新版的 Python 里，总是能够按照当初创建字典时的那套顺序来遍历这些键值对。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12044286005778293000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`baby_names = {\n    \'cat\': \'kitten\',\n    \'dog\': \'puppy\',\n}\n\nprint(baby_names)\n\n>>>\n{\'cat\': \'kitten\', \'dog\': \'puppy\'}`, `12044286005778293000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">baby_names <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'cat\'</span><span class="token punctuation">:</span> <span class="token string">\'kitten\'</span><span class="token punctuation">,</span>\n    <span class="token string">\'dog\'</span><span class="token punctuation">:</span> <span class="token string">\'puppy\'</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span>baby_names<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">{</span><span class="token string">\'cat\'</span><span class="token punctuation">:</span> <span class="token string">\'kitten\'</span><span class="token punctuation">,</span> <span class="token string">\'dog\'</span><span class="token punctuation">:</span> <span class="token string">\'puppy\'</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 Python 3.5 与之前的版本中，dict 所提供的许多方法（包括 keys、values、items 与 popitem 等）都不保证固定的顺序，所以让人觉得好像是随机处理的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89519313323909410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`baby_names = {\n    \'cat\': \'kitten\',\n    \'dog\': \'puppy\',\n}\n\n# Python 3.5\nprint(list(baby_names.keys()))\nprint(list(baby_names.values()))\nprint(list(baby_names.items()))\nprint(baby_names.popitem())  # Randomly chooses an item\n\n>>>\n[\'dog\', \'cat\']\n[\'puppy\', \'kitten\']\n[(\'dog\', \'puppy\'), (\'cat\', \'kitten\')]\n(\'dog\', \'puppy\')`, `89519313323909410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">baby_names <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'cat\'</span><span class="token punctuation">:</span> <span class="token string">\'kitten\'</span><span class="token punctuation">,</span>\n    <span class="token string">\'dog\'</span><span class="token punctuation">:</span> <span class="token string">\'puppy\'</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment"># Python 3.5</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>baby_names<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>baby_names<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>baby_names<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>baby_names<span class="token punctuation">.</span>popitem<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># Randomly chooses an item</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token string">\'dog\'</span><span class="token punctuation">,</span> <span class="token string">\'cat\'</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token string">\'puppy\'</span><span class="token punctuation">,</span> <span class="token string">\'kitten\'</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'dog\'</span><span class="token punctuation">,</span> <span class="token string">\'puppy\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">\'cat\'</span><span class="token punctuation">,</span> <span class="token string">\'kitten\'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n<span class="token punctuation">(</span><span class="token string">\'dog\'</span><span class="token punctuation">,</span> <span class="token string">\'puppy\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在新版的 Python 中，这些方法已经可以按照当初添加键值对时的顺序来处理了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91219581675184100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`baby_names = {\n    \'cat\': \'kitten\',\n    \'dog\': \'puppy\',\n}\n\nprint(list(baby_names.keys()))\nprint(list(baby_names.values()))\nprint(list(baby_names.items()))\nprint(baby_names.popitem())  # Randomly chooses an item\n\n>>>\n[\'cat\', \'dog\']\n[\'kitten\', \'puppy\']\n[(\'cat\', \'kitten\'), (\'dog\', \'puppy\')]\n(\'dog\', \'puppy\')`, `91219581675184100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">baby_names <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'cat\'</span><span class="token punctuation">:</span> <span class="token string">\'kitten\'</span><span class="token punctuation">,</span>\n    <span class="token string">\'dog\'</span><span class="token punctuation">:</span> <span class="token string">\'puppy\'</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>baby_names<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>baby_names<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>baby_names<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>baby_names<span class="token punctuation">.</span>popitem<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># Randomly chooses an item</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token string">\'cat\'</span><span class="token punctuation">,</span> <span class="token string">\'dog\'</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token string">\'kitten\'</span><span class="token punctuation">,</span> <span class="token string">\'puppy\'</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'cat\'</span><span class="token punctuation">,</span> <span class="token string">\'kitten\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">\'dog\'</span><span class="token punctuation">,</span> <span class="token string">\'puppy\'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n<span class="token punctuation">(</span><span class="token string">\'dog\'</span><span class="token punctuation">,</span> <span class="token string">\'puppy\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这项变化对 Python 中那些依赖字典类型及其实现细节的特性产生了很多影响。</p>\n<p>函数的关键字参数（包括万能的 <code class="language-text">**kwargs</code> 参数，参见第 23 条），以前是按照近乎随机的顺序出现的，这使函数调用操作变得很难调试。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70273940942670365000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# Python 3.5\ndef my_func(**kwargs):\n    for key, value in kwargs.items():\n        print(\'%s = %s\' % (key, value))\n\n\nmy_func(goose=\'gosling\', kangaroo=\'joey\')\n\n>>>\nkangaroo = joey\ngoose = gosling`, `70273940942670365000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment"># Python 3.5</span>\n<span class="token keyword">def</span> <span class="token function">my_func</span><span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> kwargs<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'%s = %s\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n\nmy_func<span class="token punctuation">(</span>goose<span class="token operator">=</span><span class="token string">\'gosling\'</span><span class="token punctuation">,</span> kangaroo<span class="token operator">=</span><span class="token string">\'joey\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nkangaroo <span class="token operator">=</span> joey\ngoose <span class="token operator">=</span> gosling</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在，这些关键字参数总是能够保留调用函数时所指定的那套顺序。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15166760438016346000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def my_func(**kwargs):\n    for key, value in kwargs.items():\n        print(\'%s = %s\' % (key, value))\n\n\nmy_func(goose=\'gosling\', kangaroo=\'joey\')\n\n>>>\ngoose = gosling\nkangaroo = joey`, `15166760438016346000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">my_func</span><span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> kwargs<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'%s = %s\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n\nmy_func<span class="token punctuation">(</span>goose<span class="token operator">=</span><span class="token string">\'gosling\'</span><span class="token punctuation">,</span> kangaroo<span class="token operator">=</span><span class="token string">\'joey\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\ngoose <span class="token operator">=</span> gosling\nkangaroo <span class="token operator">=</span> joey</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>另外，类也会利用字典来保存这个类的实例所具备的一些数据。在早前版本的 Python 中，对象（object）中的字段看上去好像是按随机顺序出现的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68601855621921140000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyClass:\n    def __init__(self):\n        self.alligator = \'hatchling\'\n        self.elephant = \'calf\'\n\n\na = MyClass()\nfor key, value in a.__dict__.items():\n    print(\'%s = %s\' % (key, value))\n\n>>>\n# Python 3.5\nelephant = calf\nalligator = hatchling\n\n# Python > 3.5\nalligator = hatchling\nelephant = calf`, `68601855621921140000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyClass</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>alligator <span class="token operator">=</span> <span class="token string">\'hatchling\'</span>\n        self<span class="token punctuation">.</span>elephant <span class="token operator">=</span> <span class="token string">\'calf\'</span>\n\n\na <span class="token operator">=</span> MyClass<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> a<span class="token punctuation">.</span>__dict__<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'%s = %s\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token comment"># Python 3.5</span>\nelephant <span class="token operator">=</span> calf\nalligator <span class="token operator">=</span> hatchling\n\n<span class="token comment"># Python > 3.5</span>\nalligator <span class="token operator">=</span> hatchling\nelephant <span class="token operator">=</span> calf</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在的 Python 语言规范已经要求，字典必须保留添加键值对时所依照的顺序。所以，我们可以利用这样的特征来实现一些功能，而且可以把它融入自己给类和函数所设计的 API 中。</p>\n<blockquote>\n<p>其实，内置的 collections 模块早就提供了这种能够保留插入顺序的字典，叫作 OrderedDict。它的行为跟（Python 3.7 以来的）标准 dict 类型很像，但性能上有很大区别。如果要频繁插入或弹出键值对（例如要实现 least-recently-used 缓存），那么 OrderedDict 可能比标准的 Python dict 类型更合适（如何判断是否应该换用这种类型，请参见第 70 条）。</p>\n</blockquote>\n<p>处理字典的时候，不能总是假设所有的字典都能保留键值对插入时的顺序。在 Python 中，我们很容易就能定义出特制的容器类型，并且让这些容器也像标准的 list 与 dict 等类型那样遵守相关的协议（参见第 43 条）。Python 不是静态类型的语言，大多数代码都以鸭子类型（duck typing）机制运作（也就是说，对象支持什么样的行为，就可以当成什么样的数据使用，而不用执着于它在类体系中的地位）。这种特性可能会产生意想不到的问题。</p>\n<p>例如，现在要写一个程序，统计各种小动物的受欢迎程度。我们可以设定一个字典，把每种动物和它得到的票数关联起来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49415612632759575000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`votes = {\n    \'otter\': 1281,\n    \'polar bear\': 587,\n    \'fox\': 863,\n}`, `49415612632759575000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">votes <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'otter\'</span><span class="token punctuation">:</span> <span class="token number">1281</span><span class="token punctuation">,</span>\n    <span class="token string">\'polar bear\'</span><span class="token punctuation">:</span> <span class="token number">587</span><span class="token punctuation">,</span>\n    <span class="token string">\'fox\'</span><span class="token punctuation">:</span> <span class="token number">863</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在定义一个函数来处理投票数据。用户可以把空的字典传给这个函数，这样的话，它就会把每个动物及其排名放到这个字典中。这种字典可以充当数据模型，给带有用户界面（UI）的元素提供数据。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34829920142330350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def populate_ranks(votes, ranks):\n    names = list(votes.keys())\n    names.sort(key=votes.get, reverse=True)\n    for i, name in enumerate(names, 1):\n        ranks[name] = i`, `34829920142330350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">populate_ranks</span><span class="token punctuation">(</span>votes<span class="token punctuation">,</span> ranks<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    names <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>votes<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    names<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span>votes<span class="token punctuation">.</span>get<span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\n    <span class="token keyword">for</span> i<span class="token punctuation">,</span> name <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        ranks<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> i</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们还需要写一个函数来查出人气最高的动物。这个函数假定 populate_ranks 总是会按照升序向字典写入键值对，这样第一个出现在字典里的就应该是排名最靠前的动物。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84873306755224350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def get_winner(ranks):\n    return next(iter(ranks))`, `84873306755224350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">get_winner</span><span class="token punctuation">(</span>ranks<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> <span class="token builtin">next</span><span class="token punctuation">(</span><span class="token builtin">iter</span><span class="token punctuation">(</span>ranks<span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>下面来验证刚才设计的函数，看它们能不能实现想要的结果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42908800433655920000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`votes = {\n    \'otter\': 1281,\n    \'polar bear\': 587,\n    \'fox\': 863,\n}\n\n\ndef populate_ranks(votes, ranks):\n    names = list(votes.keys())\n    names.sort(key=votes.get, reverse=True)\n    for i, name in enumerate(names, 1):\n        ranks[name] = i\n\n\ndef get_winner(ranks):\n    return next(iter(ranks))\n\n\nranks = {}\npopulate_ranks(votes, ranks)\nprint(ranks)\nwinner = get_winner(ranks)\nprint(winner)\n\n>>>\n{\'otter\': 1, \'fox\': 2, \'polar bear\': 3}\notter`, `42908800433655920000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">votes <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'otter\'</span><span class="token punctuation">:</span> <span class="token number">1281</span><span class="token punctuation">,</span>\n    <span class="token string">\'polar bear\'</span><span class="token punctuation">:</span> <span class="token number">587</span><span class="token punctuation">,</span>\n    <span class="token string">\'fox\'</span><span class="token punctuation">:</span> <span class="token number">863</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\n\n<span class="token keyword">def</span> <span class="token function">populate_ranks</span><span class="token punctuation">(</span>votes<span class="token punctuation">,</span> ranks<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    names <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>votes<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    names<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span>votes<span class="token punctuation">.</span>get<span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\n    <span class="token keyword">for</span> i<span class="token punctuation">,</span> name <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        ranks<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> i\n\n\n<span class="token keyword">def</span> <span class="token function">get_winner</span><span class="token punctuation">(</span>ranks<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> <span class="token builtin">next</span><span class="token punctuation">(</span><span class="token builtin">iter</span><span class="token punctuation">(</span>ranks<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n\nranks <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\npopulate_ranks<span class="token punctuation">(</span>votes<span class="token punctuation">,</span> ranks<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>ranks<span class="token punctuation">)</span>\nwinner <span class="token operator">=</span> get_winner<span class="token punctuation">(</span>ranks<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>winner<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">{</span><span class="token string">\'otter\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'fox\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">\'polar bear\'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">}</span>\notter</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>结果没有问题。但是，假设现在的需求变了，我们现在想要按照字母顺序在 UI 中显示，而不是像原来那样按照名次显示。为了实现这种效果，我们用内置的 collections.abc 模块定义这样一个类。这个类的功能和字典一样，而且会按照字母顺序迭代其中的内容。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8364647489854593000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from collections.abc import MutableMapping\n\n\nclass SortedDict(MutableMapping):\n    def __init__(self):\n        self.data = {}\n\n    def __getitem__(self, key):\n        return self.data[key]\n\n    def __setitem__(self, key, value):\n        self.data[key] = value\n\n    def __delitem__(self, key):\n        del self.data[key]\n\n    def __iter__(self):\n        keys = list(self.data.keys())\n        keys.sort()\n        for key in keys:\n            yield key\n\n    def __len__(self):\n        return len(self.data)\n\n\nvotes = {\n    \'otter\': 1281,\n    \'polar bear\': 587,\n    \'fox\': 863,\n}\n\n\ndef populate_ranks(votes, ranks):\n    names = list(votes.keys())\n    names.sort(key=votes.get, reverse=True)\n    for i, name in enumerate(names, 1):\n        ranks[name] = i\n\n\ndef get_winner(ranks):\n    return next(iter(ranks))\n\n\nsorted_ranks = SortedDict()\npopulate_ranks(votes, sorted_ranks)\nprint(sorted_ranks.data)\nwinner = get_winner(sorted_ranks)\nprint(winner)\n\n>>>\n{\'otter\': 1, \'fox\': 2, \'polar bear\': 3}\nfox`, `8364647489854593000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> collections<span class="token punctuation">.</span>abc <span class="token keyword">import</span> MutableMapping\n\n\n<span class="token keyword">class</span> <span class="token class-name">SortedDict</span><span class="token punctuation">(</span>MutableMapping<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>data<span class="token punctuation">[</span>key<span class="token punctuation">]</span>\n\n    <span class="token keyword">def</span> <span class="token function">__setitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>data<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value\n\n    <span class="token keyword">def</span> <span class="token function">__delitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">del</span> self<span class="token punctuation">.</span>data<span class="token punctuation">[</span>key<span class="token punctuation">]</span>\n\n    <span class="token keyword">def</span> <span class="token function">__iter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        keys <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n        keys<span class="token punctuation">.</span>sort<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">for</span> key <span class="token keyword">in</span> keys<span class="token punctuation">:</span>\n            <span class="token keyword">yield</span> key\n\n    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">)</span>\n\n\nvotes <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'otter\'</span><span class="token punctuation">:</span> <span class="token number">1281</span><span class="token punctuation">,</span>\n    <span class="token string">\'polar bear\'</span><span class="token punctuation">:</span> <span class="token number">587</span><span class="token punctuation">,</span>\n    <span class="token string">\'fox\'</span><span class="token punctuation">:</span> <span class="token number">863</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\n\n<span class="token keyword">def</span> <span class="token function">populate_ranks</span><span class="token punctuation">(</span>votes<span class="token punctuation">,</span> ranks<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    names <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>votes<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    names<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span>votes<span class="token punctuation">.</span>get<span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\n    <span class="token keyword">for</span> i<span class="token punctuation">,</span> name <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        ranks<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> i\n\n\n<span class="token keyword">def</span> <span class="token function">get_winner</span><span class="token punctuation">(</span>ranks<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> <span class="token builtin">next</span><span class="token punctuation">(</span><span class="token builtin">iter</span><span class="token punctuation">(</span>ranks<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n\nsorted_ranks <span class="token operator">=</span> SortedDict<span class="token punctuation">(</span><span class="token punctuation">)</span>\npopulate_ranks<span class="token punctuation">(</span>votes<span class="token punctuation">,</span> sorted_ranks<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>sorted_ranks<span class="token punctuation">.</span>data<span class="token punctuation">)</span>\nwinner <span class="token operator">=</span> get_winner<span class="token punctuation">(</span>sorted_ranks<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>winner<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">{</span><span class="token string">\'otter\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'fox\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">\'polar bear\'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">}</span>\nfox</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>没有得到预期的结果，为什么会这样呢？因为 <code class="language-text">get_winner</code> 函数总是假设，迭代字典时的顺序应该跟 <code class="language-text">populate_ranks</code> 函数当初向字典中插入数据时的顺序一样。但是这次，我们用的是 SortedDict 实例，而不是标准的 dict 实例，所以这项假设不成立。因此，函数返回的数据是按字母顺序排列时最先出现的那个数据，也就是 <code class="language-text">&#39;fox&#39;</code>，有以下 3 种解决方案：</p>\n<ol>\n<li>\n<p>重新实现 <code class="language-text">get_winner</code> 函数，使它不再假设 ranks 字典总是能按照固定的顺序来迭代。这是最保险、最稳妥的一种方案。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49141679298388930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def get_winner(ranks):\n  for name, rank in ranks.items():\n     if rank == 1:\n           return name\n\nwinner = get_winner(sorted_ranks)\nprint(winner)\n\n>>>\notter`, `49141679298388930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">get_winner</span><span class="token punctuation">(</span>ranks<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  <span class="token keyword">for</span> name<span class="token punctuation">,</span> rank <span class="token keyword">in</span> ranks<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n     <span class="token keyword">if</span> rank <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>\n           <span class="token keyword">return</span> name\n\nwinner <span class="token operator">=</span> get_winner<span class="token punctuation">(</span>sorted_ranks<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>winner<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\notter</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>在函数开头先判断 ranks 是不是预期的那种标准字典（dict）。如果不是，就抛出异常。这个办法的运行性能要比刚才那种好。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46833109122509110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def get_winner(ranks):\n  if not isinstance(ranks, dict):\n     raise TypeError(\'must provide a dict instance\')\n  return next(iter(ranks))\n\nget_winner(sorted_ranks)\n\n>>>\nTraceback ...\nTypeError: must provide a dict instance`, `46833109122509110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">get_winner</span><span class="token punctuation">(</span>ranks<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>ranks<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n     <span class="token keyword">raise</span> TypeError<span class="token punctuation">(</span><span class="token string">\'must provide a dict instance\'</span><span class="token punctuation">)</span>\n  <span class="token keyword">return</span> <span class="token builtin">next</span><span class="token punctuation">(</span><span class="token builtin">iter</span><span class="token punctuation">(</span>ranks<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\nget_winner<span class="token punctuation">(</span>sorted_ranks<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> must provide a <span class="token builtin">dict</span> instance</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>通过类型注解（type annotation）来保证传给 <code class="language-text">get_winner</code> 函数的确实是个真正的 dict 实例，而不是那种行为跟标准字典类似的 MutableMapping（参见第 90 条）。下面就采用严格（strict）模式，针对含有注解的代码运行 mypy 工具。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50145071827431730000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from typing import Dict, MutableMapping\n\ndef populate_ranks(votes: Dict[str, int],\n                 ranks: Dict[str, int]) -> None:\n  names = list(votes.keys())\n  names.sort(key=votes.get, reverse=True)\n  for i, name in enumerate(names, 1):\n     ranks[name] = i\n\ndef get_winner(ranks: Dict[str, int]) -> str:\n  return next(iter(ranks))\n\nclass SortedDict(MutableMapping[str, int]):\n  def __init__(self):\n     self.data = {}\n\n  def __getitem__(self, key):\n     return self.data[key]\n\n  def __setitem__(self, key, value):\n     self.data[key] = value\n\n  def __delitem__(self, key):\n     del self.data[key]\n\n  def __iter__(self):\n     keys = list(self.data.keys())\n     keys.sort()\n     for key in keys:\n           yield key\n\n  def __len__(self):\n     return len(self.data)\n\nvotes = {\n  \'otter\': 1281,\n  \'polar bear\': 587,\n  \'fox\': 863,\n}\n\nsorted_ranks = SortedDict()\npopulate_ranks(votes, sorted_ranks)\nprint(sorted_ranks.data)\nwinner = get_winner(sorted_ranks)\nprint(winner)\n\n\\$ python3 -m mypy --strict test.py\ntest.py:42: error: Argument 2 to &quot;populate_ranks&quot; has incompatible type &quot;SortedDict&quot;; expected &quot;Dict[str, int]&quot;\ntest.py:44: error: Argument 1 to &quot;get_winner&quot; has incompatible type &quot;SortedDict&quot;; expected &quot;Dict[str, int]&quot;`, `50145071827431730000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> typing <span class="token keyword">import</span> Dict<span class="token punctuation">,</span> MutableMapping\n\n<span class="token keyword">def</span> <span class="token function">populate_ranks</span><span class="token punctuation">(</span>votes<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n                 ranks<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n  names <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>votes<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n  names<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span>votes<span class="token punctuation">.</span>get<span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\n  <span class="token keyword">for</span> i<span class="token punctuation">,</span> name <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n     ranks<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> i\n\n<span class="token keyword">def</span> <span class="token function">get_winner</span><span class="token punctuation">(</span>ranks<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">str</span><span class="token punctuation">:</span>\n  <span class="token keyword">return</span> <span class="token builtin">next</span><span class="token punctuation">(</span><span class="token builtin">iter</span><span class="token punctuation">(</span>ranks<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token keyword">class</span> <span class="token class-name">SortedDict</span><span class="token punctuation">(</span>MutableMapping<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n  <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n     self<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n  <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">:</span>\n     <span class="token keyword">return</span> self<span class="token punctuation">.</span>data<span class="token punctuation">[</span>key<span class="token punctuation">]</span>\n\n  <span class="token keyword">def</span> <span class="token function">__setitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n     self<span class="token punctuation">.</span>data<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value\n\n  <span class="token keyword">def</span> <span class="token function">__delitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">:</span>\n     <span class="token keyword">del</span> self<span class="token punctuation">.</span>data<span class="token punctuation">[</span>key<span class="token punctuation">]</span>\n\n  <span class="token keyword">def</span> <span class="token function">__iter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n     keys <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n     keys<span class="token punctuation">.</span>sort<span class="token punctuation">(</span><span class="token punctuation">)</span>\n     <span class="token keyword">for</span> key <span class="token keyword">in</span> keys<span class="token punctuation">:</span>\n           <span class="token keyword">yield</span> key\n\n  <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n     <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">)</span>\n\nvotes <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token string">\'otter\'</span><span class="token punctuation">:</span> <span class="token number">1281</span><span class="token punctuation">,</span>\n  <span class="token string">\'polar bear\'</span><span class="token punctuation">:</span> <span class="token number">587</span><span class="token punctuation">,</span>\n  <span class="token string">\'fox\'</span><span class="token punctuation">:</span> <span class="token number">863</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\nsorted_ranks <span class="token operator">=</span> SortedDict<span class="token punctuation">(</span><span class="token punctuation">)</span>\npopulate_ranks<span class="token punctuation">(</span>votes<span class="token punctuation">,</span> sorted_ranks<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>sorted_ranks<span class="token punctuation">.</span>data<span class="token punctuation">)</span>\nwinner <span class="token operator">=</span> get_winner<span class="token punctuation">(</span>sorted_ranks<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>winner<span class="token punctuation">)</span>\n\n$ python3 <span class="token operator">-</span>m mypy <span class="token operator">-</span><span class="token operator">-</span>strict test<span class="token punctuation">.</span>py\ntest<span class="token punctuation">.</span>py<span class="token punctuation">:</span><span class="token number">42</span><span class="token punctuation">:</span> error<span class="token punctuation">:</span> Argument <span class="token number">2</span> to <span class="token string">"populate_ranks"</span> has incompatible <span class="token builtin">type</span> <span class="token string">"SortedDict"</span><span class="token punctuation">;</span> expected <span class="token string">"Dict[str, int]"</span>\ntest<span class="token punctuation">.</span>py<span class="token punctuation">:</span><span class="token number">44</span><span class="token punctuation">:</span> error<span class="token punctuation">:</span> Argument <span class="token number">1</span> to <span class="token string">"get_winner"</span> has incompatible <span class="token builtin">type</span> <span class="token string">"SortedDict"</span><span class="token punctuation">;</span> expected <span class="token string">"Dict[str, int]"</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样可以检查出类型不相符的问题，mypy 会标出错误的用法，指出函数要求的是 dict，但传入的却是 MutableMapping。这个方案既能保证静态类型准确，又不会影响程序的运行效率。</p>\n</li>\n</ol>\n<h3 id="总结-11"><a href="#%E6%80%BB%E7%BB%93-11" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>\n<p>从 Python 3.7 版开始，我们就可以确信迭代标准的字典时所看到的顺序跟这些键值对插入字典时的顺序一致。</p>\n</li>\n<li>\n<p>在 Python 代码中，我们很容易就能定义跟标准的字典很像但本身并不是 dict 实例的对象。对于这种类型的对象，不能假设迭代时看到的顺序必定与插入时的顺序相同。</p>\n</li>\n<li>\n<p>如果不想把这种跟标准字典很相似的类型也当成标准字典来处理，那么可以考虑这样三种办法。</p>\n<ol>\n<li>不要依赖插入时的顺序编写代码；</li>\n<li>在程序运行时明确判断它是不是标准的字典；</li>\n<li>给代码添加类型注解并做静态分析。</li>\n</ol>\n</li>\n</ol>\n<h2 id="第-16-条：用-get-处理键不在字典中的情况，不要使用-in-与-keyerror"><a href="#%E7%AC%AC-16-%E6%9D%A1%EF%BC%9A%E7%94%A8-get-%E5%A4%84%E7%90%86%E9%94%AE%E4%B8%8D%E5%9C%A8%E5%AD%97%E5%85%B8%E4%B8%AD%E7%9A%84%E6%83%85%E5%86%B5%EF%BC%8C%E4%B8%8D%E8%A6%81%E4%BD%BF%E7%94%A8-in-%E4%B8%8E-keyerror" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 16 条：用 get 处理键不在字典中的情况，不要使用 in 与 KeyError</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90890992969443800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`counters = {\n    \'pumpernickel\': 2,\n    \'sourdough\': 1,\n}\n\nkey = \'wheat\'\n\nif key not in counters:\n    counters[key] = 0\ncounters[key] += 1\n\nif key in counters:\n    counters[key] += 1\nelse:\n    counters[key] = 1\n\ntry:\n    counters[key] += 1\nexcept KeyError:\n    counters[key] = 1`, `90890992969443800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">counters <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'pumpernickel\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>\n    <span class="token string">\'sourdough\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\nkey <span class="token operator">=</span> <span class="token string">\'wheat\'</span>\n\n<span class="token keyword">if</span> key <span class="token keyword">not</span> <span class="token keyword">in</span> counters<span class="token punctuation">:</span>\n    counters<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>\ncounters<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>\n\n<span class="token keyword">if</span> key <span class="token keyword">in</span> counters<span class="token punctuation">:</span>\n    counters<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    counters<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>\n\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    counters<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>\n<span class="token keyword">except</span> KeyError<span class="token punctuation">:</span>\n    counters<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用 get 来优化</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80125258829082590000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`counters = {\n    \'pumpernickel\': 2,\n    \'sourdough\': 1,\n}\n\nkey = \'wheat\'\n\ncount = counters.get(key, 0)\ncounters[key] = count + 1`, `80125258829082590000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">counters <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'pumpernickel\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>\n    <span class="token string">\'sourdough\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\nkey <span class="token operator">=</span> <span class="token string">\'wheat\'</span>\n\ncount <span class="token operator">=</span> counters<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\ncounters<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> count <span class="token operator">+</span> <span class="token number">1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果使用 setdefault 改写是有问题的，这会有一次访问、两次赋值操作</p>\n<p>而且 setdefault 不管是否有这个键，都会执行默认值的分配，这会造成比较大的性能开销</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15427664179513844000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`count = counters.setdefault(key, 0)\ncounters[key] = count + 1`, `15427664179513844000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">count <span class="token operator">=</span> counters<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\ncounters<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> count <span class="token operator">+</span> <span class="token number">1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>缓解性能问题的话，可以用 get 方法加赋值表达式，也可以直接用 defaultdict</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41489800059276090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`names = votes.get(key)\nif names is None:\n    votes[key] = names = []\nnames.append(who)\n\n# 或者使用赋值表达式\nif (names := votes.get(key)) is None:\n    votes[key] = names = []\nnames.append(who)`, `41489800059276090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">names <span class="token operator">=</span> votes<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">)</span>\n<span class="token keyword">if</span> names <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n    votes<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\nnames<span class="token punctuation">.</span>append<span class="token punctuation">(</span>who<span class="token punctuation">)</span>\n\n<span class="token comment"># 或者使用赋值表达式</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>names <span class="token punctuation">:</span><span class="token operator">=</span> votes<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n    votes<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\nnames<span class="token punctuation">.</span>append<span class="token punctuation">(</span>who<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>只有与键相关联的默认值构造起来开销很低且可以变化，而且不用担心异常问题（例如 list 实例）。在这种情况下可以使用 setdefault，然而一般也优先考虑使用 defaultdict 取代 dict</p>\n<h3 id="总结-12"><a href="#%E6%80%BB%E7%BB%93-12" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>有四种办法可以处理键不在字典中的情况：in 表达式、KeyError 异常、get 方法与 setdefault 方法。</li>\n<li>如果跟键相关联的值是像计数器这样的基本类型，那么 get 方法就是最好的方案；如果是那种构造起来开销比较大，或是容易出异常的类型，那么可以把这个方法与赋值表达式结合起来使用。</li>\n<li>即使看上去最应该使用 setdefault 方案，也不一定要真的使用 setdefault 方案，而是可以考虑用 defaultdict 取代普通的 dict。</li>\n</ol>\n<h2 id="第-17-条：用-defaultdict-处理内部状态中缺失的元素，而不要用-setdefault"><a href="#%E7%AC%AC-17-%E6%9D%A1%EF%BC%9A%E7%94%A8-defaultdict-%E5%A4%84%E7%90%86%E5%86%85%E9%83%A8%E7%8A%B6%E6%80%81%E4%B8%AD%E7%BC%BA%E5%A4%B1%E7%9A%84%E5%85%83%E7%B4%A0%EF%BC%8C%E8%80%8C%E4%B8%8D%E8%A6%81%E7%94%A8-setdefault" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 17 条：用 defaultdict 处理内部状态中缺失的元素，而不要用 setdefault</h2>\n<p>通过 setdefault 方案把新的城市添加到对应的集合里，这要比利用 get 方法与赋值表达式（Python3.8 的新特性）来实现的方案短很多。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84914321086427220000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`visits = {\n    \'Mexico\': {\'Tulum\', \'Puerto Vallarta\'},\n    \'Japan\': {\'Hakone\'},\n}\n\nvisits.setdefault(\'France\', set()).add(\'Arles\')  # Short\nif (japan := visits.get(\'Japan\')) is None:  # Long\n    visits[\'Japan\'] = japan = set()\njapan.add(\'Kyoto\')\n\nprint(visits)\n\n>>>\n{\'Mexico\': {\'Tulum\', \'Puerto Vallarta\'}, \'Japan\': {\'Kyoto\', \'Hakone\'}, \'France\': {\'Arles\'}}`, `84914321086427220000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">visits <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'Mexico\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'Tulum\'</span><span class="token punctuation">,</span> <span class="token string">\'Puerto Vallarta\'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token string">\'Japan\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'Hakone\'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\nvisits<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span><span class="token string">\'France\'</span><span class="token punctuation">,</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token string">\'Arles\'</span><span class="token punctuation">)</span>  <span class="token comment"># Short</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>japan <span class="token punctuation">:</span><span class="token operator">=</span> visits<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'Japan\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>  <span class="token comment"># Long</span>\n    visits<span class="token punctuation">[</span><span class="token string">\'Japan\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> japan <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\njapan<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token string">\'Kyoto\'</span><span class="token punctuation">)</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span>visits<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">{</span><span class="token string">\'Mexico\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'Tulum\'</span><span class="token punctuation">,</span> <span class="token string">\'Puerto Vallarta\'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'Japan\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'Kyoto\'</span><span class="token punctuation">,</span> <span class="token string">\'Hakone\'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'France\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'Arles\'</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果程序所访问的这个字典需要由你自己明确地创建，那又该怎么写？</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17469695147631237000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Visits:\n    def __init__(self):\n        self.data = {}\n\n    def add(self, country, city):\n        city_set = self.data.setdefault(country, set())\n        city_set.add(city)\n\n\nvisits = Visits()\nvisits.add(\'Russia\', \'Yekaterinburg\')\nvisits.add(\'Tanzania\', \'Zanzibar\')\nprint(visits.data)\n\n>>>\n{\'Russia\': {\'Yekaterinburg\'}, \'Tanzania\': {\'Zanzibar\'}}`, `17469695147631237000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Visits</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n    <span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> country<span class="token punctuation">,</span> city<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        city_set <span class="token operator">=</span> self<span class="token punctuation">.</span>data<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span>country<span class="token punctuation">,</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n        city_set<span class="token punctuation">.</span>add<span class="token punctuation">(</span>city<span class="token punctuation">)</span>\n\n\nvisits <span class="token operator">=</span> Visits<span class="token punctuation">(</span><span class="token punctuation">)</span>\nvisits<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token string">\'Russia\'</span><span class="token punctuation">,</span> <span class="token string">\'Yekaterinburg\'</span><span class="token punctuation">)</span>\nvisits<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token string">\'Tanzania\'</span><span class="token punctuation">,</span> <span class="token string">\'Zanzibar\'</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>visits<span class="token punctuation">.</span>data<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">{</span><span class="token string">\'Russia\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'Yekaterinburg\'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'Tanzania\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'Zanzibar\'</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>以上代码有以下问题</p>\n<ol>\n<li>调用了名字很怪的 setdefault 方法，很难让人理解发生了什么</li>\n<li>每次调用 add 方法，都会构造新的 set 实例</li>\n</ol>\n<p>改用 defaultdict 可以解决以上问题，它会在键缺失的情况下，自动添加这个键以及键所对应的默认值，每次发现键不存在时，该字典都会调用这个函数返回一份新的默认值</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51551702956283640000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from collections import defaultdict\n\n\nclass Visits:\n    def __init__(self):\n        self.data = defaultdict(set)\n\n    def add(self, country, city):\n        self.data[country].add(city)\n\n\nvisits = Visits()\nvisits.add(\'England\', \'Bath\')\nvisits.add(\'England\', \'London\')\nprint(visits.data)\n\n>>>\ndefaultdict(<class \'set\'>, {\'England\': {\'Bath\', \'London\'}})`, `51551702956283640000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> collections <span class="token keyword">import</span> defaultdict\n\n\n<span class="token keyword">class</span> <span class="token class-name">Visits</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>data <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">set</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> country<span class="token punctuation">,</span> city<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>data<span class="token punctuation">[</span>country<span class="token punctuation">]</span><span class="token punctuation">.</span>add<span class="token punctuation">(</span>city<span class="token punctuation">)</span>\n\n\nvisits <span class="token operator">=</span> Visits<span class="token punctuation">(</span><span class="token punctuation">)</span>\nvisits<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token string">\'England\'</span><span class="token punctuation">,</span> <span class="token string">\'Bath\'</span><span class="token punctuation">)</span>\nvisits<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token string">\'England\'</span><span class="token punctuation">,</span> <span class="token string">\'London\'</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>visits<span class="token punctuation">.</span>data<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\ndefaultdict<span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'set\'</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">\'England\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'Bath\'</span><span class="token punctuation">,</span> <span class="token string">\'London\'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="总结-13"><a href="#%E6%80%BB%E7%BB%93-13" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>如果你管理的字典可能需要添加任意的键，那么应该考虑能否用内置的 collections 模块中的 defaultdict 实例来解决问题。</li>\n<li>如果这种键名比较随意的字典是别人传给你的，你无法把它创建成 defaultdict，那么应该考虑通过 get 方法访问其中的键值。然而，在个别情况下，也可以考虑改用 setdefault 方法，因为那样写更短。</li>\n</ol>\n<h2 id="第-18-条：学会利用-__missing__-构造依赖键的默认值"><a href="#%E7%AC%AC-18-%E6%9D%A1%EF%BC%9A%E5%AD%A6%E4%BC%9A%E5%88%A9%E7%94%A8-__missing__-%E6%9E%84%E9%80%A0%E4%BE%9D%E8%B5%96%E9%94%AE%E7%9A%84%E9%BB%98%E8%AE%A4%E5%80%BC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 18 条：学会利用 <code class="language-text">__missing__</code> 构造依赖键的默认值</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87473422647450190000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pictures = {}\npath = \'profile_1234.png\'\nif (handle := pictures.get(path)) is None:\n    try:\n        handle = open(path, \'a+b\')\n    except OSError:\n        print(f\'Failed to open path {path}\')\n        raise\n    else:\n        pictures[path] = handle\n\nhandle.seek(0)\nimage_data = handle.read()`, `87473422647450190000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">pictures <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\npath <span class="token operator">=</span> <span class="token string">\'profile_1234.png\'</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>handle <span class="token punctuation">:</span><span class="token operator">=</span> pictures<span class="token punctuation">.</span>get<span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        handle <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">\'a+b\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">except</span> OSError<span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Failed to open path </span><span class="token interpolation"><span class="token punctuation">{</span>path<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n        <span class="token keyword">raise</span>\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        pictures<span class="token punctuation">[</span>path<span class="token punctuation">]</span> <span class="token operator">=</span> handle\n\nhandle<span class="token punctuation">.</span>seek<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>\nimage_data <span class="token operator">=</span> handle<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果改成 setdefault</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67082717223024320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pictures = {}\npath = \'profile_1234.png\'\ntry:\n    handle = pictures.setdefault(path, open(path, \'a+b\'))\nexcept OSError:\n    print(f\'Failed to open path {path}\')\n    raise\nelse:\n    handle.seek(0)\n\nimage_data = handle.read()`, `67082717223024320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">pictures <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\npath <span class="token operator">=</span> <span class="token string">\'profile_1234.png\'</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    handle <span class="token operator">=</span> pictures<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token builtin">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">\'a+b\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">except</span> OSError<span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Failed to open path </span><span class="token interpolation"><span class="token punctuation">{</span>path<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n    <span class="token keyword">raise</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    handle<span class="token punctuation">.</span>seek<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>\n\nimage_data <span class="token operator">=</span> handle<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然而使用 setdefault 实现会有以下问题</p>\n<ol>\n<li>即便图片的路径名已经在字典里了，程序也还是得调用内置的 open 函数创建文件句柄，于是导致这个程序要给已经创建过 handle 的那份文件再度创建 handle（两者可能相互冲突）</li>\n<li>如果 try 块抛出异常，那我们可能无法判断这个异常是 open 函数导致的，还是 setdefault 方法导致的，因为这两次调用全都写在了同一行代码里</li>\n</ol>\n<p>理论上可以使用 defaultdict 优化，但是 defaultdict 的第二个函数不能传参</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46129507533988520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from collections import defaultdict\n\n\ndef open_picture(profile_path):\n    try:\n        return open(profile_path, \'a+b\')\n    except OSError:\n        print(f\'Failed to open path {profile_path}\')\n        raise\n\n\npath = \'profile_1234.png\'\npictures = defaultdict(open_picture)\nhandle = pictures[path]\nhandle.seek(0)\nimage_data = handle.read()\n\n>>>\nTraceback ...\nTypeError: open_picture() missing 1 required positional argument: \'profile_path\'`, `46129507533988520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> collections <span class="token keyword">import</span> defaultdict\n\n\n<span class="token keyword">def</span> <span class="token function">open_picture</span><span class="token punctuation">(</span>profile_path<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token builtin">open</span><span class="token punctuation">(</span>profile_path<span class="token punctuation">,</span> <span class="token string">\'a+b\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">except</span> OSError<span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Failed to open path </span><span class="token interpolation"><span class="token punctuation">{</span>profile_path<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n        <span class="token keyword">raise</span>\n\n\npath <span class="token operator">=</span> <span class="token string">\'profile_1234.png\'</span>\npictures <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span>open_picture<span class="token punctuation">)</span>\nhandle <span class="token operator">=</span> pictures<span class="token punctuation">[</span>path<span class="token punctuation">]</span>\nhandle<span class="token punctuation">.</span>seek<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>\nimage_data <span class="token operator">=</span> handle<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> open_picture<span class="token punctuation">(</span><span class="token punctuation">)</span> missing <span class="token number">1</span> required positional argument<span class="token punctuation">:</span> <span class="token string">\'profile_path\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以通过继承 dict 类型并实现 <code class="language-text">__missing__</code> 特殊方法来解决这个问题</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8537367537532892000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def open_picture(profile_path):\n    try:\n        return open(profile_path, \'a+b\')\n    except OSError:\n        print(f\'Failed to open path {profile_path}\')\n        raise\n\n\nclass Pictures(dict):\n    def __missing__(self, key):\n        value = open_picture(key)\n        self[key] = value\n        return value\n\n\npath = \'profile_1234.png\'\npictures = Pictures()\nhandle = pictures[path]\nhandle.seek(0)\nimage_data = handle.read()`, `8537367537532892000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">open_picture</span><span class="token punctuation">(</span>profile_path<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token builtin">open</span><span class="token punctuation">(</span>profile_path<span class="token punctuation">,</span> <span class="token string">\'a+b\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">except</span> OSError<span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Failed to open path </span><span class="token interpolation"><span class="token punctuation">{</span>profile_path<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n        <span class="token keyword">raise</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Pictures</span><span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__missing__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        value <span class="token operator">=</span> open_picture<span class="token punctuation">(</span>key<span class="token punctuation">)</span>\n        self<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value\n        <span class="token keyword">return</span> value\n\n\npath <span class="token operator">=</span> <span class="token string">\'profile_1234.png\'</span>\npictures <span class="token operator">=</span> Pictures<span class="token punctuation">(</span><span class="token punctuation">)</span>\nhandle <span class="token operator">=</span> pictures<span class="token punctuation">[</span>path<span class="token punctuation">]</span>\nhandle<span class="token punctuation">.</span>seek<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>\nimage_data <span class="token operator">=</span> handle<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="总结-14"><a href="#%E6%80%BB%E7%BB%93-14" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>如果创建默认值需要较大的开销，或者可能抛出异常，那就不适合用 dict 类型的 setdefault 方法实现。</li>\n<li>传给 defaultdict 的函数必须是不需要参数的函数，所以无法创建出需要依赖键名的默认值。</li>\n<li>如果要构造的默认值必须根据键名来确定，那么可以定义自己的 dict 子类并实现 <code class="language-text">__missing__</code> 方法。</li>\n</ol>\n<h1 id="函数"><a href="#%E5%87%BD%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>函数</h1>\n<h2 id="第-19-条：不要把函数返回的多个数值拆分到三个以上的变量中"><a href="#%E7%AC%AC-19-%E6%9D%A1%EF%BC%9A%E4%B8%8D%E8%A6%81%E6%8A%8A%E5%87%BD%E6%95%B0%E8%BF%94%E5%9B%9E%E7%9A%84%E5%A4%9A%E4%B8%AA%E6%95%B0%E5%80%BC%E6%8B%86%E5%88%86%E5%88%B0%E4%B8%89%E4%B8%AA%E4%BB%A5%E4%B8%8A%E7%9A%84%E5%8F%98%E9%87%8F%E4%B8%AD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 19 条：不要把函数返回的多个数值拆分到三个以上的变量中</h2>\n<p>unpacking 机制允许 Python 函数返回一个以上的值（参见第 6 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1144202170774533100"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def get_stats(numbers):\n    minimum = min(numbers)\n    maximum = max(numbers)\n    return minimum, maximum\n\n\nlengths = [63, 73, 72, 60, 67, 66, 71, 61, 72, 70]\nminimum, maximum = get_stats(lengths)  # Two return values\nprint(f\'Min: {minimum}, Max: {maximum}\')\n\n>>>\nMin: 60, Max: 73`, `1144202170774533100`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">def <span class="token function">get_stats</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    minimum <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n    maximum <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> minimum<span class="token punctuation">,</span> maximum\n\n\nlengths <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">63</span><span class="token punctuation">,</span> <span class="token number">73</span><span class="token punctuation">,</span> <span class="token number">72</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">67</span><span class="token punctuation">,</span> <span class="token number">66</span><span class="token punctuation">,</span> <span class="token number">71</span><span class="token punctuation">,</span> <span class="token number">61</span><span class="token punctuation">,</span> <span class="token number">72</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">]</span>\nminimum<span class="token punctuation">,</span> maximum <span class="token operator">=</span> <span class="token function">get_stats</span><span class="token punctuation">(</span>lengths<span class="token punctuation">)</span>  # Two <span class="token keyword">return</span> values\n<span class="token function">print</span><span class="token punctuation">(</span>f<span class="token string">\'Min: {minimum}, Max: {maximum}\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>>></span>\nMin<span class="token punctuation">:</span> <span class="token number">60</span><span class="token punctuation">,</span> Max<span class="token punctuation">:</span> <span class="token number">73</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77769912929221020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`first, second = 1, 2\nassert first == 1\nassert second == 2\n\n\ndef my_function():\n    return 1, 2\n\n\nfirst, second = my_function()\nassert first == 1\nassert second == 2`, `77769912929221020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">first<span class="token punctuation">,</span> second <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span>\nassert first <span class="token operator">==</span> <span class="token number">1</span>\nassert second <span class="token operator">==</span> <span class="token number">2</span>\n\n\ndef <span class="token function">my_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span>\n\n\nfirst<span class="token punctuation">,</span> second <span class="token operator">=</span> <span class="token function">my_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\nassert first <span class="token operator">==</span> <span class="token number">1</span>\nassert second <span class="token operator">==</span> <span class="token number">2</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在返回多个值的时候，可以用带星号的表达式接收那些没有被普通变量捕获到的值（参见第 13 条）</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81977070100254670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def get_avg_ratio(numbers):\n    average = sum(numbers) / len(numbers)\n    scaled = [x / average for x in numbers]\n    scaled.sort(reverse=True)\n    return scaled\n\n\nlengths = [63, 73, 72, 60, 67, 66, 71, 61, 72, 70]\nlongest, *middle, shortest = get_avg_ratio(lengths)\nprint(f\'Longest:  {longest:>4.0%}\')\nprint(f\'Shortest: {shortest:>4.0%}\')\n\n>>>\nLongest:  108%\nShortest:  89%`, `81977070100254670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">get_avg_ratio</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    average <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n    scaled <span class="token operator">=</span> <span class="token punctuation">[</span>x <span class="token operator">/</span> average <span class="token keyword">for</span> x <span class="token keyword">in</span> numbers<span class="token punctuation">]</span>\n    scaled<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\n    <span class="token keyword">return</span> scaled\n\n\nlengths <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">63</span><span class="token punctuation">,</span> <span class="token number">73</span><span class="token punctuation">,</span> <span class="token number">72</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">67</span><span class="token punctuation">,</span> <span class="token number">66</span><span class="token punctuation">,</span> <span class="token number">71</span><span class="token punctuation">,</span> <span class="token number">61</span><span class="token punctuation">,</span> <span class="token number">72</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">]</span>\nlongest<span class="token punctuation">,</span> <span class="token operator">*</span>middle<span class="token punctuation">,</span> shortest <span class="token operator">=</span> get_avg_ratio<span class="token punctuation">(</span>lengths<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Longest:  </span><span class="token interpolation"><span class="token punctuation">{</span>longest<span class="token punctuation">:</span><span class="token format-spec">>4.0%</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Shortest: </span><span class="token interpolation"><span class="token punctuation">{</span>shortest<span class="token punctuation">:</span><span class="token format-spec">>4.0%</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nLongest<span class="token punctuation">:</span>  <span class="token number">108</span><span class="token operator">%</span>\nShortest<span class="token punctuation">:</span>  <span class="token number">89</span><span class="token operator">%</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59405060383014300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def get_stats(numbers):\n    minimum = min(numbers)\n    maximum = max(numbers)\n    count = len(numbers)\n    average = sum(numbers)/count\n    sorted_numbers = sorted(numbers)\n    middle = count // 2\n    if count % 2 == 0:\n        lower = sorted_numbers[middle - 1]\n        upper = sorted_numbers[middle]\n        median = (lower + upper)/2\n    else:\n        median = sorted_numbers[middle]\n    return minimum, maximum, average, median, count\n\n\nlengths = [63, 73, 72, 60, 67, 66, 71, 61, 72, 70]\nminimum, maximum, average, median, count = get_stats(lengths)\nprint(f\'Min: {minimum}, Max: {maximum}\')\nprint(f\'Average: {average}, Median: {median}, Count: {count}\')\n\n>>>\nMin: 60, Max: 73\nAverage: 67.5, Median: 68.5, Count: 10`, `59405060383014300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">get_stats</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    minimum <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n    maximum <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n    count <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n    average <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span><span class="token operator">/</span>count\n    sorted_numbers <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n    middle <span class="token operator">=</span> count <span class="token operator">//</span> <span class="token number">2</span>\n    <span class="token keyword">if</span> count <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>\n        lower <span class="token operator">=</span> sorted_numbers<span class="token punctuation">[</span>middle <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>\n        upper <span class="token operator">=</span> sorted_numbers<span class="token punctuation">[</span>middle<span class="token punctuation">]</span>\n        median <span class="token operator">=</span> <span class="token punctuation">(</span>lower <span class="token operator">+</span> upper<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span>\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        median <span class="token operator">=</span> sorted_numbers<span class="token punctuation">[</span>middle<span class="token punctuation">]</span>\n    <span class="token keyword">return</span> minimum<span class="token punctuation">,</span> maximum<span class="token punctuation">,</span> average<span class="token punctuation">,</span> median<span class="token punctuation">,</span> count\n\n\nlengths <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">63</span><span class="token punctuation">,</span> <span class="token number">73</span><span class="token punctuation">,</span> <span class="token number">72</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">67</span><span class="token punctuation">,</span> <span class="token number">66</span><span class="token punctuation">,</span> <span class="token number">71</span><span class="token punctuation">,</span> <span class="token number">61</span><span class="token punctuation">,</span> <span class="token number">72</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">]</span>\nminimum<span class="token punctuation">,</span> maximum<span class="token punctuation">,</span> average<span class="token punctuation">,</span> median<span class="token punctuation">,</span> count <span class="token operator">=</span> get_stats<span class="token punctuation">(</span>lengths<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Min: </span><span class="token interpolation"><span class="token punctuation">{</span>minimum<span class="token punctuation">}</span></span><span class="token string">, Max: </span><span class="token interpolation"><span class="token punctuation">{</span>maximum<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Average: </span><span class="token interpolation"><span class="token punctuation">{</span>average<span class="token punctuation">}</span></span><span class="token string">, Median: </span><span class="token interpolation"><span class="token punctuation">{</span>median<span class="token punctuation">}</span></span><span class="token string">, Count: </span><span class="token interpolation"><span class="token punctuation">{</span>count<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nMin<span class="token punctuation">:</span> <span class="token number">60</span><span class="token punctuation">,</span> Max<span class="token punctuation">:</span> <span class="token number">73</span>\nAverage<span class="token punctuation">:</span> <span class="token number">67.5</span><span class="token punctuation">,</span> Median<span class="token punctuation">:</span> <span class="token number">68.5</span><span class="token punctuation">,</span> Count<span class="token punctuation">:</span> <span class="token number">10</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面的写法有 2 个问题：</p>\n<ol>\n<li>函数返回的五个值都是数字，所以很容易就会搞错顺序</li>\n<li>调用函数并拆分返回值的那行代码会写得比较长</li>\n</ol>\n<p>为避免这些问题，我们不应该把函数返回的多个值拆分到三个以上的变量里。一个三元组最多只拆成三个普通变量，或两个普通变量与一个万能变量（带星号的变量）。当然用于接收的变量个数也可以比这更少。假如要拆分的值确实很多，那最好还是定义一个轻便的类或 namedtuple（参见第 37 条），并让函数返回这样的实例。</p>\n<h3 id="总结-15"><a href="#%E6%80%BB%E7%BB%93-15" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>函数可以把多个值合起来通过一个元组返回给调用者，以便利用 Python 的 unpacking 机制去拆分。</li>\n<li>对于函数返回的多个值，可以把普通变量没有捕获到的那些值全都捕获到一个带星号的变量里。</li>\n<li>把返回的值拆分到四个或四个以上的变量是很容易出错的，所以最好不要那么写，而是应该通过小类或 namedtuple 实例完成。</li>\n</ol>\n<h2 id="第-20-条：遇到意外状况时应该抛出异常，不要返回-none"><a href="#%E7%AC%AC-20-%E6%9D%A1%EF%BC%9A%E9%81%87%E5%88%B0%E6%84%8F%E5%A4%96%E7%8A%B6%E5%86%B5%E6%97%B6%E5%BA%94%E8%AF%A5%E6%8A%9B%E5%87%BA%E5%BC%82%E5%B8%B8%EF%BC%8C%E4%B8%8D%E8%A6%81%E8%BF%94%E5%9B%9E-none" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 20 条：遇到意外状况时应该抛出异常，不要返回 None</h2>\n<p>编写工具函数（utility function）时，许多 Python 程序员都爱用 None 这个返回值来表示特殊情况。对于某些函数来说，这或许有几分道理。</p>\n<p>例如，我们要编写一个辅助函数计算两数相除的结果。在除数是 0 的情况下，返回 None 似乎相当合理，因为这种除法的结果是没有意义的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15205695606209368000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def careful_divide(a, b):\n    try:\n        return a / b\n    except ZeroDivisionError:\n        return None`, `15205695606209368000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">careful_divide</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> a <span class="token operator">/</span> b\n    <span class="token keyword">except</span> ZeroDivisionError<span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token boolean">None</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>调用这个函数时，可以按自己的方式处理这样的返回值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4062089950524794400"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def careful_divide(a, b):\n    try:\n        return a / b\n    except ZeroDivisionError:\n        return None\n\n\nx, y = 1, 0\nresult = careful_divide(x, y)\nif result is None:\n    print(\'Invalid inputs\')\n\n>>>\nInvalid inputs`, `4062089950524794400`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">careful_divide</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> a <span class="token operator">/</span> b\n    <span class="token keyword">except</span> ZeroDivisionError<span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token boolean">None</span>\n\n\nx<span class="token punctuation">,</span> y <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span>\nresult <span class="token operator">=</span> careful_divide<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>\n<span class="token keyword">if</span> result <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Invalid inputs\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nInvalid inputs</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果传给 <code class="language-text">careful_divide</code> 函数的被除数为 0，会怎么样呢？在这种情况下，只要除数不为 0，函数返回的结果就应该是 0。</p>\n<p>问题是，这个函数的返回值有时可能会用在 if 条件语句里面，那时可能会根据值本身是否相当于 False 来做判断，而不像刚才那样明确判断这个值是否为 None（第 5 条也列举了类似的例子）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75544406269192780000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def careful_divide(a, b):\n    try:\n        return a / b\n    except ZeroDivisionError:\n        return None\n\n\nx, y = 0, 5\nresult = careful_divide(x, y)\nif not result:\n    print(\'Invalid inputs\')  # This runs! But shouldn\'t\n\n>>>\nInvalid inputs`, `75544406269192780000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">careful_divide</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> a <span class="token operator">/</span> b\n    <span class="token keyword">except</span> ZeroDivisionError<span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token boolean">None</span>\n\n\nx<span class="token punctuation">,</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span>\nresult <span class="token operator">=</span> careful_divide<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>\n<span class="token keyword">if</span> <span class="token keyword">not</span> result<span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Invalid inputs\'</span><span class="token punctuation">)</span>  <span class="token comment"># This runs! But shouldn\'t</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nInvalid inputs</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面这种 if 语句，会把函数返回 0 时的情况，也当成函数返回 None 时那样来处理。这种写法经常出现在 Python 代码里，因此像 <code class="language-text">careful_divide</code> 这样，用 None 来表示特殊状况的函数是很容易出错的。有两种办法可以减少这样的错误。</p>\n<ol>\n<li>\n<p>利用二元组把计算结果分成两部分返回（与这种写法有关的基础知识，参见第 19 条）。元组的首个元素表示操作是否成功，第二个元素表示计算的实际值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21487563872153403000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def careful_divide(a, b):\ntry:\n    return True, a / b\nexcept ZeroDivisionError:\n    return False, None`, `21487563872153403000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">careful_divide</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> <span class="token boolean">True</span><span class="token punctuation">,</span> a <span class="token operator">/</span> b\n<span class="token keyword">except</span> ZeroDivisionError<span class="token punctuation">:</span>\n    <span class="token keyword">return</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">None</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写，会促使调用函数者去拆分返回值，他可以先看看这次运算是否成功，然后再决定怎么处理运算结果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65939765767682700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`success, result = careful_divide(x, y)\nif not success:\n  print(\'Invalid inputs\')`, `65939765767682700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">success<span class="token punctuation">,</span> result <span class="token operator">=</span> careful_divide<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>\n<span class="token keyword">if</span> <span class="token keyword">not</span> success<span class="token punctuation">:</span>\n  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Invalid inputs\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>但问题是，有些调用方总喜欢忽略返回元组的第一个部分（在 Python 代码里，习惯用下划线表示用不到的变量）。这样写成的代码，乍一看似乎没问题，但实际上还是无法区分返回 0 与返回 None 这两种情况。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39086008968731820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`_, result = careful_divide(x, y)\nif not result:\n  print(\'Invalid inputs\')`, `39086008968731820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">_<span class="token punctuation">,</span> result <span class="token operator">=</span> careful_divide<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>\n<span class="token keyword">if</span> <span class="token keyword">not</span> result<span class="token punctuation">:</span>\n  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Invalid inputs\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>不采用 None 表示特例，而是向调用方抛出异常（Exception），让他自己去处理。下面我们把执行除法时发生的 ZeroDivisionError 转化成 ValueError，告诉调用方输入的值不对（什么时候应该使用 Exception 类的子类，可参见第 87 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75360977597732390000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def careful_divide(a, b):\ntry:\n    return a / b\nexcept ZeroDivisionError:\n    raise ValueError(\'Invalid inputs\')`, `75360977597732390000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">careful_divide</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> a <span class="token operator">/</span> b\n<span class="token keyword">except</span> ZeroDivisionError<span class="token punctuation">:</span>\n    <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Invalid inputs\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在，调用方拿到函数的返回值之后，不用先判断操作是否成功了。因为这次可以假设，只要能拿到返回值，就说明函数肯定顺利执行完了，所以只需要用 try 把函数包起来并在 else 块里处理运算结果就好（这种结构的详细用法，参见第 65 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12667330727410820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def careful_divide(a, b):\ntry:\n    return a / b\nexcept ZeroDivisionError:\n    raise ValueError(\'Invalid inputs\')\n\nx, y = 5, 2\ntry:\n  result = careful_divide(x, y)\nexcept ValueError:\n  print(\'Invalid inputs\')\nelse:\n  print(\'Result is %.1f\' % result)\n\n>>>\nResult is 2.5`, `12667330727410820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">careful_divide</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> a <span class="token operator">/</span> b\n<span class="token keyword">except</span> ZeroDivisionError<span class="token punctuation">:</span>\n    <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Invalid inputs\'</span><span class="token punctuation">)</span>\n\nx<span class="token punctuation">,</span> y <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">2</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n  result <span class="token operator">=</span> careful_divide<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>\n<span class="token keyword">except</span> ValueError<span class="token punctuation">:</span>\n  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Invalid inputs\'</span><span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Result is %.1f\'</span> <span class="token operator">%</span> result<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nResult <span class="token keyword">is</span> <span class="token number">2.5</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n</ol>\n<p>这个办法也可以扩展到那些使用类型注解的代码中（参见第 90 条），我们可以把函数的返回值指定为 float 类型，这样它就不可能返回 None 了。然而，Python 采用的是动态类型与静态类型相搭配的 gradual 类型系统，我们不能在函数的接口上指定函数可能抛出哪些异常（有的编程语言支持这样的受检异常（checked exception），调用方必须应对这些异常）。所以，我们只好把有可能抛出的异常写在文档里面，并希望调用方能够根据这份文档适当地捕获相关的异常（参见第 84 条）。</p>\n<p>下面我们给刚才那个函数加类型注解，并为它编写 docstring。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63411399200439700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def careful_divide(a: float, b: float) -> float:\n    &quot;&quot;&quot;Divides a by b.\n\n    Raises:\n      ValueError: When the inputs cannot be divided.\n    &quot;&quot;&quot;\n    try:\n        return a / b\n    except ZeroDivisionError as e:\n        raise ValueError(\'Invalid inputs\')`, `63411399200439700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">careful_divide</span><span class="token punctuation">(</span>a<span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">,</span> b<span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">float</span><span class="token punctuation">:</span>\n    <span class="token triple-quoted-string string">"""Divides a by b.\n\n    Raises:\n      ValueError: When the inputs cannot be divided.\n    """</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> a <span class="token operator">/</span> b\n    <span class="token keyword">except</span> ZeroDivisionError <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Invalid inputs\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写，输入、输出与异常都显得很清晰，所以调用方出错的概率就变得很小了。</p>\n<h3 id="总结-16"><a href="#%E6%80%BB%E7%BB%93-16" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>用返回值 None 表示特殊情况是很容易出错的，因为这样的值在条件表达式里面，没办法与 0 和空白字符串之类的值区分，这些值都相当于 False。</li>\n<li>用异常表示特殊的情况，而不要返回 None。让调用这个函数的程序根据文档里写的异常情况做出处理。</li>\n<li>通过类型注解可以明确禁止函数返回 None，即便在特殊情况下，它也不能返回这个值。</li>\n</ol>\n<h2 id="第-21-条：了解如何在闭包里面使用外围作用域中的变量"><a href="#%E7%AC%AC-21-%E6%9D%A1%EF%BC%9A%E4%BA%86%E8%A7%A3%E5%A6%82%E4%BD%95%E5%9C%A8%E9%97%AD%E5%8C%85%E9%87%8C%E9%9D%A2%E4%BD%BF%E7%94%A8%E5%A4%96%E5%9B%B4%E4%BD%9C%E7%94%A8%E5%9F%9F%E4%B8%AD%E7%9A%84%E5%8F%98%E9%87%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 21 条：了解如何在闭包里面使用外围作用域中的变量</h2>\n<p>有时，我们要给列表中的元素排序，而且要优先把某个群组之中的元素放在其他元素的前面。例如，渲染用户界面时，可能就需要这样做，因为关键的消息和特殊的事件应该优先显示在其他信息之前。</p>\n<p>实现这种做法的一种常见方案，是把辅助函数通过 key 参数传给列表的 sort 方法（参见第 14 条），让这个方法根据辅助函数所返回的值来决定元素在列表中的先后顺序。辅助函数先判断当前元素是否处在重要群组里，如果在，就把返回值的第一项写成 0，让它能够排在不属于这个组的那些元素之前。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="662952522992443800"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def sort_priority(values, group):\n    def helper(x):\n        if x in group:\n            return (0, x)\n        return (1, x)\n    values.sort(key=helper)`, `662952522992443800`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">sort_priority</span><span class="token punctuation">(</span>values<span class="token punctuation">,</span> group<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">helper</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> x <span class="token keyword">in</span> group<span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>\n    values<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span>helper<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个函数可以处理比较简单的输入数据。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15471795539071963000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def sort_priority(values, group):\n    def helper(x):\n        if x in group:\n            return (0, x)\n        return (1, x)\n    values.sort(key=helper)\n\n\nnumbers = [8, 3, 1, 2, 5, 4, 7, 6]\ngroup = {2, 3, 5, 7}\nsort_priority(numbers, group)\nprint(numbers)\n\n>>>\n[2, 3, 5, 7, 1, 4, 6, 8]`, `15471795539071963000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">sort_priority</span><span class="token punctuation">(</span>values<span class="token punctuation">,</span> group<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">helper</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> x <span class="token keyword">in</span> group<span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>\n    values<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span>helper<span class="token punctuation">)</span>\n\n\nnumbers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span>\ngroup <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">}</span>\nsort_priority<span class="token punctuation">(</span>numbers<span class="token punctuation">,</span> group<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>它为什么能够实现这个功能呢？这要分三个原因来讲：</p>\n<ol>\n<li>Python 支持闭包（closure），这让定义在大函数里面的小函数也能引用大函数之中的变量。具体到这个例子，<code class="language-text">sort_priority</code> 函数里面的那个 helper 函数也能够引用前者的 group 参数。</li>\n<li>函数在 Python 里是头等对象（first-class object），所以你可以像操作其他对象那样，直接引用它们、把它们赋给变量、将它们当成参数传给其他函数，或是在 in 表达式与 if 语句里面对它做比较，等等。闭包函数也是函数，所以，同样可以传给 sort 方法的 key 参数。</li>\n<li>Python 在判断两个序列（包括元组）的大小时，有自己的一套规则。它首先比较 0 号位置的那两个元素，如果相等，那就比较 1 号位置的那两个元素；如果还相等，那就比较 2 号位置的那两个元素；依此类推，直到得出结论为止。所以，我们可以利用这套规则让 helper 这个闭包函数返回一个元组，并把关键指标写为元组的首个元素以表示当前排序的值是否属于重要群组（0 表示属于，1 表示不属于）。</li>\n</ol>\n<p>如果这个 <code class="language-text">sort_priority</code> 函数还能告诉我们，列表里面有没有位于重要群组之中的元素，那就更好了，因为这样可以让用户界面开发者更方便地做出相应处理。添加这样一个功能似乎相当简单，因为闭包函数本身就需要判断当前值是否处在重要群组之中，既然这样，那么不妨让它在发现这种值时，顺便把标志变量翻转过来。最后，让闭包外的大函数（即 <code class="language-text">sort_priority</code> 函数）返回这个标志变量，如果闭包函数当时遇到过这样的值，那么这个标志肯定是 True。</p>\n<p>下面，试着用最直接的写法来实现。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90668103546592230000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def sort_priority2(numbers, group):\n    found = False\n\n    def helper(x):\n        if x in group:\n            found = True  # Seems simple\n            return (0, x)\n        return (1, x)\n    numbers.sort(key=helper)\n    return found\n\n\nnumbers = [8, 3, 1, 2, 5, 4, 7, 6]\ngroup = {2, 3, 5, 7}\nfound = sort_priority2(numbers, group)\nprint(\'Found:\', found)\nprint(numbers)\n\n>>>\nFound: False\n[2, 3, 5, 7, 1, 4, 6, 8]`, `90668103546592230000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">sort_priority2</span><span class="token punctuation">(</span>numbers<span class="token punctuation">,</span> group<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    found <span class="token operator">=</span> <span class="token boolean">False</span>\n\n    <span class="token keyword">def</span> <span class="token function">helper</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> x <span class="token keyword">in</span> group<span class="token punctuation">:</span>\n            found <span class="token operator">=</span> <span class="token boolean">True</span>  <span class="token comment"># Seems simple</span>\n            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>\n    numbers<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span>helper<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> found\n\n\nnumbers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span>\ngroup <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">}</span>\nfound <span class="token operator">=</span> sort_priority2<span class="token punctuation">(</span>numbers<span class="token punctuation">,</span> group<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Found:\'</span><span class="token punctuation">,</span> found<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nFound<span class="token punctuation">:</span> <span class="token boolean">False</span>\n<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>排序结果没有问题，可以看到：在排过序的 numbers 里面，重要群组 group 里的那些元素（2、3、5、7），确实出现在了其他元素前面。既然这样，那表示函数返回值的 found 变量就应该是 True，但我们看到的却是 False，这是为什么？</p>\n<p>在表达式中引用某个变量时，Python 解释器会按照下面的顺序，在各个作用域（scope）里面查找这个变量，以解析（resolve）这次引用</p>\n<ol>\n<li>当前函数的作用域。</li>\n<li>外围作用域（例如包含当前函数的其他函数所对应的作用域）。</li>\n<li>包含当前代码的那个模块所对应的作用域（也叫全局作用域，global scope）。</li>\n<li>内置作用域（built-in scope，也就是包含 len 与 str 等函数的那个作用域）。</li>\n</ol>\n<p>如果这些作用域中都没有定义名称相符的变量，那么程序就抛出 NameError 异常。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81426890956993500000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`foo = does_not_exist * 5\n\n>>>\nTraceback...\nNameError: name \'does_not_exist\' is not defined`, `81426890956993500000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">foo <span class="token operator">=</span> does_not_exist <span class="token operator">*</span> <span class="token number">5</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nNameError<span class="token punctuation">:</span> name <span class="token string">\'does_not_exist\'</span> <span class="token keyword">is</span> <span class="token keyword">not</span> defined</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>刚才讲的是怎么引用变量，现在我们来讲怎么给变量赋值，这要分两种情况处理。</p>\n<ol>\n<li>如果变量已经定义在当前作用域中，那么直接把新值交给它就行了。</li>\n<li>如果当前作用域中不存在这个变量，那么即便外围作用域里有同名的变量，Python 也还是会把这次的赋值操作当成变量的定义来处理</li>\n</ol>\n<p>这会产生一个重要的效果，也就是说，Python 会把包含赋值操作的这个函数当成新定义的这个变量的作用域。</p>\n<p>这可以解释刚才那种写法错在何处。<code class="language-text">sort_priority2</code> 函数里面的 helper 闭包函数是把 True 赋给了 found 变量。当前作用域里没有这样一个叫作 found 的变量，所以就算外围的 <code class="language-text">sort_priority2</code> 函数里面有 found 变量，系统也还是会把这次赋值当成定义，也就是会在 helper 里面定义一个新的 found 变量，而不是把它当成给 <code class="language-text">sort_priority2</code> 已有的那个 found 变量赋值。</p>\n<p>这种问题有时也称作作用域 bug（scoping bug），Python 新手可能认为这样的赋值规则很奇怪，但实际上 Python 是故意这么设计的。因为这样可以防止函数中的局部变量污染外围模块。假如不这样做，那么函数里的每条赋值语句都有可能影响全局作用域的变量，这样不仅混乱，而且会让全局变量之间彼此交互影响，从而导致很多难以探查的 bug。</p>\n<p>Python 有一种特殊的写法，可以把闭包里面的数据赋给闭包外面的变量。用 nonlocal 语句描述变量，就可以让系统在处理针对这个变量的赋值操作时，去外围作用域查找。然而，nonlocal 有个限制，就是不能侵入模块级别的作用域（以防污染全局作用域）。</p>\n<p>下面，用 nonlocal 改写刚才那个函数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69397320959177370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def sort_priority2(numbers, group):\n    found = False\n\n    def helper(x):\n        nonlocal found\n        if x in group:\n            found = True  # Seems simple\n            return (0, x)\n        return (1, x)\n    numbers.sort(key=helper)\n    return found\n\n\nnumbers = [8, 3, 1, 2, 5, 4, 7, 6]\ngroup = {2, 3, 5, 7}\nfound = sort_priority2(numbers, group)\nprint(\'Found:\', found)\nprint(numbers)\n\n>>>\nFound: True\n[2, 3, 5, 7, 1, 4, 6, 8]`, `69397320959177370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{5}"\n              >\n                <span class="gatsby-code-button-language">py{5}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">sort_priority2</span><span class="token punctuation">(</span>numbers<span class="token punctuation">,</span> group<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    found <span class="token operator">=</span> <span class="token boolean">False</span>\n\n    <span class="token keyword">def</span> <span class="token function">helper</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="gatsby-highlight-code-line">        <span class="token keyword">nonlocal</span> found</span>        <span class="token keyword">if</span> x <span class="token keyword">in</span> group<span class="token punctuation">:</span>\n            found <span class="token operator">=</span> <span class="token boolean">True</span>  <span class="token comment"># Seems simple</span>\n            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>\n    numbers<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span>helper<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> found\n\n\nnumbers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span>\ngroup <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">}</span>\nfound <span class="token operator">=</span> sort_priority2<span class="token punctuation">(</span>numbers<span class="token punctuation">,</span> group<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Found:\'</span><span class="token punctuation">,</span> found<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nFound<span class="token punctuation">:</span> <span class="token boolean">True</span>\n<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>nonlocal 语句清楚地表明，我们要把数据赋给闭包之外的变量。有一种跟它互补的语句，叫作 global，用这种语句描述某个变量后，在给这个变量赋值时，系统会直接把它放到模块作用域（或者说全局作用域）中。</p>\n<p>我们都知道全局变量不应该滥用，其实 nonlocal 也这样。除比较简单的函数外，大家尽量不要用这个语句，因为它造成的副作用有时很难发现。尤其是在那种比较长的函数里，nonlocal 语句与其关联变量的赋值操作之间可能隔得很远。</p>\n<p>如果 nonlocal 的用法比较复杂，那最好是改用辅助类来封装状态。下面就定义了这样一个类，用来实现与刚才那种写法相同的效果。这样虽然稍微长一点，但看起来更清晰易读（<code class="language-text">__call__</code> 这个特殊方法，请参见第 38 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47484025893258084000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Sorter:\n    def __init__(self, group):\n        self.group = group\n        self.found = False\n\n    def __call__(self, x):\n        if x in self.group:\n            self.found = True\n            return (0, x)\n        return (1, x)\n\n\nnumbers = [8, 3, 1, 2, 5, 4, 7, 6]\ngroup = {2, 3, 5, 7}\nsorter = Sorter(group)\nnumbers.sort(key=sorter)\nassert sorter.found is True`, `47484025893258084000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Sorter</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> group<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>group <span class="token operator">=</span> group\n        self<span class="token punctuation">.</span>found <span class="token operator">=</span> <span class="token boolean">False</span>\n\n    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> x <span class="token keyword">in</span> self<span class="token punctuation">.</span>group<span class="token punctuation">:</span>\n            self<span class="token punctuation">.</span>found <span class="token operator">=</span> <span class="token boolean">True</span>\n            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>\n\n\nnumbers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span>\ngroup <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">}</span>\nsorter <span class="token operator">=</span> Sorter<span class="token punctuation">(</span>group<span class="token punctuation">)</span>\nnumbers<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span>sorter<span class="token punctuation">)</span>\n<span class="token keyword">assert</span> sorter<span class="token punctuation">.</span>found <span class="token keyword">is</span> <span class="token boolean">True</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="总结-17"><a href="#%E6%80%BB%E7%BB%93-17" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>闭包函数可以引用定义它们的那个外围作用域之中的变量。</li>\n<li>按照默认的写法，在闭包里面给变量赋值并不会改变外围作用域中的同名变量。</li>\n<li>先用 nonlocal 语句说明，然后赋值，可以修改外围作用域中的变量。</li>\n<li>除特别简单的函数外，尽量少用 nonlocal 语句。</li>\n</ol>\n<h2 id="第-22-条：用数量可变的位置参数给函数设计清晰的参数列表"><a href="#%E7%AC%AC-22-%E6%9D%A1%EF%BC%9A%E7%94%A8%E6%95%B0%E9%87%8F%E5%8F%AF%E5%8F%98%E7%9A%84%E4%BD%8D%E7%BD%AE%E5%8F%82%E6%95%B0%E7%BB%99%E5%87%BD%E6%95%B0%E8%AE%BE%E8%AE%A1%E6%B8%85%E6%99%B0%E7%9A%84%E5%8F%82%E6%95%B0%E5%88%97%E8%A1%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 22 条：用数量可变的位置参数给函数设计清晰的参数列表</h2>\n<p>让函数接受数量可变的位置参数（positional argument），可以把函数设计得更加清晰（这些位置参数通常简称 var args，或者叫作 star args，因为我们习惯用 <code class="language-text">*args</code> 指代）。例如，假设我们要记录调试信息。如果采用参数数量固定的方案来设计，那么函数应该接受一个表示信息的 message 参数和一个 values 列表（这个列表用于存放需要填充到信息里的那些值）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31960884054253523000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def log(message, values):\n    if not values:\n        print(message)\n    else:\n        values_str = \', \'.join(str(x) for x in values)\n        print(f\'{message}: {values_str}\')\n\n\nlog(\'My numbers are\', [1, 2])\nlog(\'Hi there\', [])\n\n>>>\nMy numbers are: 1, 2\nHi there`, `31960884054253523000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">log</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> <span class="token keyword">not</span> values<span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        values_str <span class="token operator">=</span> <span class="token string">\', \'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> values<span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>message<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>values_str<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n\nlog<span class="token punctuation">(</span><span class="token string">\'My numbers are\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\nlog<span class="token punctuation">(</span><span class="token string">\'Hi there\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nMy numbers are<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span>\nHi there</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>即便没有值需要填充到信息里面，也必须专门传一个空白的列表进去，这样显得多余，而且让代码看起来比较乱。最好是能允许调用者把第二个参数留空。在 Python 里，可以给最后一个位置参数加前缀 <code class="language-text">*</code>，这样调用者就只需要提供不带星号的那些参数，然后可以不再指其他参数，也可以继续指定任意数量的位置参数。函数的主体代码不用改，只修改调用代码即可。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35803895488781644000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def log(message, *values):  # The only difference\n    if not values:\n        print(message)\n    else:\n        values_str = \', \'.join(str(x) for x in values)\n        print(f\'{message}: {values_str}\')\n\n\nlog(\'My numbers are\', 1, 2)\nlog(\'Hi there\')  # Much better\n\n>>>\nMy numbers are: 1, 2\nHi there`, `35803895488781644000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">log</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token operator">*</span>values<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># The only difference</span>\n    <span class="token keyword">if</span> <span class="token keyword">not</span> values<span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        values_str <span class="token operator">=</span> <span class="token string">\', \'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> values<span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>message<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>values_str<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n\nlog<span class="token punctuation">(</span><span class="token string">\'My numbers are\'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>\nlog<span class="token punctuation">(</span><span class="token string">\'Hi there\'</span><span class="token punctuation">)</span>  <span class="token comment"># Much better</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nMy numbers are<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span>\nHi there</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种写法与拆解数据时用在赋值语句左边带星号的 unpacking 操作非常类似（参见第 13 条）。</p>\n<p>如果想把已有序列（例如某列表）里面的元素当成参数传给像 log 这样的参数个数可变的函数（variadic function），那么可以在传递序列的时采用 <code class="language-text">*</code> 操作符。这会让 Python 把序列中的元素都当成位置参数传给这个函数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47356514134262120000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`favorites = [7, 33, 99]\nlog(\'Favorite colors\', *favorites)\n\n>>>\nFavorite colors: 7, 33, 99`, `47356514134262120000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">favorites <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">]</span>\nlog<span class="token punctuation">(</span><span class="token string">\'Favorite colors\'</span><span class="token punctuation">,</span> <span class="token operator">*</span>favorites<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nFavorite colors<span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">,</span> <span class="token number">99</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>令函数接受数量可变的位置参数，可能导致两个问题。</p>\n<ol>\n<li>\n<p>程序总是必须先把这些参数转化成一个元组，然后才能把它们当成可选的位置参数传给函数。这意味着，如果调用函数时，把带 <code class="language-text">*</code> 操作符的生成器传了过去，那么程序必须先把这个生成器里的所有元素迭代完（以便形成元组），然后才能继续往下执行（相关知识，参见第 30 条）。这个元组包含生成器所给出的每个值，这可能耗费大量内存，甚至会让程序崩溃。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39456788116552690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def my_generator():\nfor i in range(10):\n    yield i\n\ndef my_func(*args):\n  print(args)\n\nit = my_generator()\nmy_func(*it)\n\n>>>\n(0, 1, 2, 3, 4, 5, 6, 7, 8, 9)`, `39456788116552690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">my_generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">yield</span> i\n\n<span class="token keyword">def</span> <span class="token function">my_func</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  <span class="token keyword">print</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>\n\nit <span class="token operator">=</span> my_generator<span class="token punctuation">(</span><span class="token punctuation">)</span>\nmy_func<span class="token punctuation">(</span><span class="token operator">*</span>it<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>接受 <code class="language-text">*args</code> 参数的函数，适合处理输入值不太多，而且数量可以提前预估的情况。在调用这种函数时，传给 <code class="language-text">*args</code> 这一部分的应该是许多个字面值或变量名才对。这种机制，主要是为了让代码写起来更方便、读起来更清晰。</p>\n</li>\n<li>\n<p>如果用了 <code class="language-text">*args</code> 之后，又要给函数添加新的位置参数，那么原有的调用操作就需要全都更新。例如给参数列表开头添加新的位置参数 sequence，那么没有据此更新的那些调用代码就会出错。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26703127037545447000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def log(sequence, message, *values):\nif not values:\n    print(f\'{sequence} - {message}\')\nelse:\n    values_str = \', \'.join(str(x) for x in values)\n    print(f\'{sequence} - {message}: {values_str}\')\n\nlog(1, \'Favorites\', 7, 33)  # New with *args OK\nlog(1, \'Hi there\')  # New message only OK\nlog(\'Favorite numbers\', 7, 33)  # old usage breaks\n\n>>>\n1 - Favorites: 7, 33\n1 - Hi there\nFavorite numbers - 7: 33`, `26703127037545447000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">log</span><span class="token punctuation">(</span>sequence<span class="token punctuation">,</span> message<span class="token punctuation">,</span> <span class="token operator">*</span>values<span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token keyword">if</span> <span class="token keyword">not</span> values<span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>sequence<span class="token punctuation">}</span></span><span class="token string"> - </span><span class="token interpolation"><span class="token punctuation">{</span>message<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    values_str <span class="token operator">=</span> <span class="token string">\', \'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> values<span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>sequence<span class="token punctuation">}</span></span><span class="token string"> - </span><span class="token interpolation"><span class="token punctuation">{</span>message<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>values_str<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\nlog<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'Favorites\'</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">)</span>  <span class="token comment"># New with *args OK</span>\nlog<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'Hi there\'</span><span class="token punctuation">)</span>  <span class="token comment"># New message only OK</span>\nlog<span class="token punctuation">(</span><span class="token string">\'Favorite numbers\'</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">)</span>  <span class="token comment"># old usage breaks</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">1</span> <span class="token operator">-</span> Favorites<span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">33</span>\n<span class="token number">1</span> <span class="token operator">-</span> Hi there\nFavorite numbers <span class="token operator">-</span> <span class="token number">7</span><span class="token punctuation">:</span> <span class="token number">33</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>问题在于：第三次调用 log 函数的那个地方并没有根据新的参数列表传入 sequence 参数，所以 Favorite numbers 就成了 sequence 参数，7 就成了 message 参数。这样的 bug 很难排查，因为程序不会抛出异常，只会采用错误的数据继续运行下去。为了彻底避免这种漏洞，在给这种 <code class="language-text">*arg</code> 函数添加参数时，应该使用只能通过关键字来指定的参数（keyword-only argument，参见第 25 条）。要是想做得更稳妥一些，可以考虑添加类型注解（参见第 90 条）。</p>\n</li>\n</ol>\n<h3 id="总结-18"><a href="#%E6%80%BB%E7%BB%93-18" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>用 def 定义函数时，可以通过 <code class="language-text">*args</code> 的写法让函数接受数量可变的位置参数。</li>\n<li>调用函数时，可以在序列左边加上 <code class="language-text">*</code> 操作符，把其中的元素当成位置参数传给 <code class="language-text">*args</code> 所表示的这一部分。</li>\n<li>如果 <code class="language-text">*</code> 操作符加在生成器前，那么传递参数时，程序有可能因为耗尽内存而崩溃。</li>\n<li>给接受 <code class="language-text">*args</code> 的函数添加新位置参数，可能导致难以排查的 bug。</li>\n</ol>\n<h2 id="第-23-条：用关键字参数来表示可选的行为"><a href="#%E7%AC%AC-23-%E6%9D%A1%EF%BC%9A%E7%94%A8%E5%85%B3%E9%94%AE%E5%AD%97%E5%8F%82%E6%95%B0%E6%9D%A5%E8%A1%A8%E7%A4%BA%E5%8F%AF%E9%80%89%E7%9A%84%E8%A1%8C%E4%B8%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 23 条：用关键字参数来表示可选的行为</h2>\n<p>与大多数其他编程语言一样，Python 允许在调用函数时，按照位置传递参数</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42108731893312725000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def remainder(number, divisor):\n    return number % divisor\n\n\nassert remainder(20, 7) == 6`, `42108731893312725000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">remainder</span><span class="token punctuation">(</span>number<span class="token punctuation">,</span> divisor<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> number <span class="token operator">%</span> divisor\n\n\n<span class="token keyword">assert</span> remainder<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">6</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Python 函数里面的所有普通参数，除了按位置传递外，还可以按关键字传递。调用函数时，在调用括号内可以把关键字的名称写在 = 左边，把参数值写在右边。这种写法不在乎参数的顺序，只要把必须指定的所有位置参数全都传过去即可。另外，关键字形式与位置形式也可以混用。下面这四种写法的效果相同：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80461213342177200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`remainder(20, 7)\nremainder(20, divisor=7)\nremainder(number=20, divisor=7)\nremainder(divisor=7, number=20)`, `80461213342177200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">remainder<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span>\nremainder<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> divisor<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">)</span>\nremainder<span class="token punctuation">(</span>number<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> divisor<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">)</span>\nremainder<span class="token punctuation">(</span>divisor<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">,</span> number<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果混用，那么位置参数必须出现在关键字参数之前，否则就会出错。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70279983652389010000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`remainder(number=20, 7)\n\n>>>\nTraceback ...\nSyntaxError: positional argument follows keyword argument`, `70279983652389010000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">remainder<span class="token punctuation">(</span>number<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nSyntaxError<span class="token punctuation">:</span> positional argument follows keyword argument</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>每个参数只能指定一次，不能既通过位置形式指定，又通过关键字形式指定。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70508893493372100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`remainder(20, number=7)\n\n>>>\nTraceback ...\nTypeError: remainder() got multiple values for argument number`, `70508893493372100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">remainder<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> number<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> remainder<span class="token punctuation">(</span><span class="token punctuation">)</span> got multiple values <span class="token keyword">for</span> argument number</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果有一份字典，而且字典里面的内容能够用来调用 remainder 这样的函数，那么可以把 <code class="language-text">**</code> 运算符加在字典前面，这会让 Python 把字典里面的键值以关键字参数的形式传给函数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50435632288690140000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`my_kwargs = {\n    \'number\': 20,\n    \'divisor\': 7,\n}\nassert remainder(**my_kwargs) == 6`, `50435632288690140000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">my_kwargs <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'number\'</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span>\n    <span class="token string">\'divisor\'</span><span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">assert</span> remainder<span class="token punctuation">(</span><span class="token operator">**</span>my_kwargs<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">6</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>调用函数时，带 <code class="language-text">**</code> 操作符的参数可以和位置参数或关键字参数混用，只要不重复指定就行。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98126683253297480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`my_kwargs = {\n    \'divisor\': 7,\n}\nassert remainder(number=20, **my_kwargs) == 6`, `98126683253297480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">my_kwargs <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'divisor\'</span><span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">assert</span> remainder<span class="token punctuation">(</span>number<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token operator">**</span>my_kwargs<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">6</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>也可以对多个字典分别施加 <code class="language-text">**</code> 操作，只要这些字典所提供的参数不重叠就好。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15263356928436922000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`my_kwargs = {\n    \'number\': 20,\n}\nother_kwargs = {\n    \'divisor\': 7,\n}\nassert remainder(**my_kwargs, **other_kwargs) == 6`, `15263356928436922000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">my_kwargs <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'number\'</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\nother_kwargs <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'divisor\'</span><span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">assert</span> remainder<span class="token punctuation">(</span><span class="token operator">**</span>my_kwargs<span class="token punctuation">,</span> <span class="token operator">**</span>other_kwargs<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">6</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>定义函数时，如果想让这个函数接受任意数量的关键字参数，那么可以在参数列表里写上万能形参 <code class="language-text">**kwargs</code>，它会把调用者传进来的参数收集合到一个字典里面稍后处理（第 26 条讲了一种特别适合这么做的情况）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3793260249159203000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def print_parameters(**kwargs):\n    for key, value in kwargs.items():\n        print(f\'{key} = {value}\')\n\n\nprint_parameters(alpha=1.5, beta=9, gamma=4)\n\n>>>\nalpha = 1.5\nbeta = 9\ngamma = 4`, `3793260249159203000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">print_parameters</span><span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> kwargs<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>key<span class="token punctuation">}</span></span><span class="token string"> = </span><span class="token interpolation"><span class="token punctuation">{</span>value<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n\nprint_parameters<span class="token punctuation">(</span>alpha<span class="token operator">=</span><span class="token number">1.5</span><span class="token punctuation">,</span> beta<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">,</span> gamma<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nalpha <span class="token operator">=</span> <span class="token number">1.5</span>\nbeta <span class="token operator">=</span> <span class="token number">9</span>\ngamma <span class="token operator">=</span> <span class="token number">4</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>关键字参数的灵活用法可以带来三个好处。</p>\n<ol>\n<li>\n<p>用关键字参数调用函数可以让初次阅读代码的人更容易看懂。例如，读到 remainder(20, 7) 这样的调用代码，就不太容易看出谁是被除数 number，谁是除数 divisor，只有去查看 remainder 的具体实现方法才能明白。但如果改用关键字形式来调用，例如 remainder(number=20, divisor=7)，那么每个参数的含义就相当明了。</p>\n</li>\n<li>\n<p>它可以带有默认值，该值是在定义函数时指定的。在大多数情况下，调用者只需要沿用这个值就好，但有时也可以明确指定自己想要传的值。这样能够减少重复代码，让程序看上去干净一些。</p>\n<p>例如，我们要计算液体流入容器的速率。如果这个容器带刻度，那么可以取前后两个时间点的刻度差（<code class="language-text">weight_diff</code>），并把它跟这两个时间点的时间差（<code class="language-text">time_diff</code>）相除，就可以算出流速了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12043342263290358000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def flow_rate(weight_diff, time_diff):\n   return weight_diff / time_diff\n\nweight_diff = 0.5\ntime_diff = 3\nflow = flow_rate(weight_diff, time_diff)\nprint(f\'{flow:.3} kg per second\')`, `12043342263290358000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">flow_rate</span><span class="token punctuation">(</span>weight_diff<span class="token punctuation">,</span> time_diff<span class="token punctuation">)</span><span class="token punctuation">:</span>\n   <span class="token keyword">return</span> weight_diff <span class="token operator">/</span> time_diff\n\nweight_diff <span class="token operator">=</span> <span class="token number">0.5</span>\ntime_diff <span class="token operator">=</span> <span class="token number">3</span>\nflow <span class="token operator">=</span> flow_rate<span class="token punctuation">(</span>weight_diff<span class="token punctuation">,</span> time_diff<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>flow<span class="token punctuation">:</span><span class="token format-spec">.3</span><span class="token punctuation">}</span></span><span class="token string"> kg per second\'</span></span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>一般来说，我们会用每秒的千克数表示流速。但有的时候，我们还想估算更长的时间段（例如几小时或几天）内的流速结果。只需给同一个函数加一个 period 参数来表示那个时间段相当于多少秒即可。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20392270626382426000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def flow_rate(weight_diff, time_diff, period):\n   return (weight_diff / time_diff) * period`, `20392270626382426000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">flow_rate</span><span class="token punctuation">(</span>weight_diff<span class="token punctuation">,</span> time_diff<span class="token punctuation">,</span> period<span class="token punctuation">)</span><span class="token punctuation">:</span>\n   <span class="token keyword">return</span> <span class="token punctuation">(</span>weight_diff <span class="token operator">/</span> time_diff<span class="token punctuation">)</span> <span class="token operator">*</span> period</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>这样写有个问题，就是每次调用函数时，都得明确指定 period 参数。即便我们想计算每秒钟的流速，也还是得明确指定 period 为 1。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89434703451867730000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`flow_per_second = flow_rate(weight_diff, time_diff, 1)`, `89434703451867730000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">flow_per_second <span class="token operator">=</span> flow_rate<span class="token punctuation">(</span>weight_diff<span class="token punctuation">,</span> time_diff<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>为了简化这种用法，我们可以给 period 参数设定默认值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2546463451679814700"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def flow_rate(weight_diff, time_diff, period=1):\n   return (weight_diff / time_diff) * period\n\nflow_per_second = flow_rate(weight_diff, time_diff)\nflow_per_hour = flow_rate(weight_diff, time_diff, 3600)`, `2546463451679814700`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">flow_rate</span><span class="token punctuation">(</span>weight_diff<span class="token punctuation">,</span> time_diff<span class="token punctuation">,</span> period<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n   <span class="token keyword">return</span> <span class="token punctuation">(</span>weight_diff <span class="token operator">/</span> time_diff<span class="token punctuation">)</span> <span class="token operator">*</span> period\n\nflow_per_second <span class="token operator">=</span> flow_rate<span class="token punctuation">(</span>weight_diff<span class="token punctuation">,</span> time_diff<span class="token punctuation">)</span>\nflow_per_hour <span class="token operator">=</span> flow_rate<span class="token punctuation">(</span>weight_diff<span class="token punctuation">,</span> time_diff<span class="token punctuation">,</span> <span class="token number">3600</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个办法适用于默认值比较简单的情况。如果默认值本身要根据比较复杂的逻辑来确定（可参考第 24 条），那就得仔细考虑一下了。</p>\n</li>\n<li>\n<p>我们可以很灵活地扩充函数的参数，而不用担心会影响原有的函数调用代码。这样的话，我们就可以通过这些新参数在函数里面实现许多新的功能，同时又无须修改早前写好的调用代码，这也让程序不容易因此出现 bug。</p>\n<p>例如，我们想继续扩充上述 <code class="language-text">flow_rate</code> 函数的功能，让它可以用千克之外的其他重量单位来计算流速。那只需要再添加一个可选参数，用来表示 1 千克相当于多少个那样的单位即可。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3256513672020689000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def flow_rate(weight_diff, time_diff, period=1, units_per_kg=1):\n  return ((weight_diff * units_per_kg) / time_diff) * period`, `3256513672020689000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">flow_rate</span><span class="token punctuation">(</span>weight_diff<span class="token punctuation">,</span> time_diff<span class="token punctuation">,</span> period<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> units_per_kg<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>weight_diff <span class="token operator">*</span> units_per_kg<span class="token punctuation">)</span> <span class="token operator">/</span> time_diff<span class="token punctuation">)</span> <span class="token operator">*</span> period</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>新参数 <code class="language-text">units_per_kg</code> 的默认值为 1，这表示默认情况下，依然以千克为重量单位来计算。于是，以前写好的那些调用代码就不用修改了。以后调用 <code class="language-text">flow_rate</code> 时，可以通过关键字形式给这个参数指定值，以表示他们想用的那种单位（例如磅，1 千克约等于 2.2 磅）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62041382503557505000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pounds_per_hour = flow_rate(weight_diff, time_diff,\n                        period=3600, units_per_kg=2.2)`, `62041382503557505000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">pounds_per_hour <span class="token operator">=</span> flow_rate<span class="token punctuation">(</span>weight_diff<span class="token punctuation">,</span> time_diff<span class="token punctuation">,</span>\n                        period<span class="token operator">=</span><span class="token number">3600</span><span class="token punctuation">,</span> units_per_kg<span class="token operator">=</span><span class="token number">2.2</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>可选的关键字参数有助于维护向后兼容（backward compatibility）。这是个相当重要的问题，对于接受带 <code class="language-text">*args</code> 参数的函数，也要注意向后兼容（参见第 22 条）。</p>\n<p>像 period 和 <code class="language-text">units_per_kg</code> 这样可选的关键字参数，只有一个缺点，就是调用者仍然能够按照位置来指定。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38685318326700590000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pounds_per_hour = flow_rate(weight_diff, time_diff, 3600, 2.2)`, `38685318326700590000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">pounds_per_hour <span class="token operator">=</span> flow_rate<span class="token punctuation">(</span>weight_diff<span class="token punctuation">,</span> time_diff<span class="token punctuation">,</span> <span class="token number">3600</span><span class="token punctuation">,</span> <span class="token number">2.2</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>通过位置来指定可选参数，可能会让读代码的人有点儿糊涂，因为他不太清楚 3600 和 2.2 这两个值分别指哪个量的缩放系数。所以，最好是能以关键字的形式给这些参数传值，而不要按位置去传。从设计函数的角度来说，还可以考虑用更加明确的方案以降低出错概率（参见第 25 条）。</p>\n</li>\n</ol>\n<h3 id="总结-19"><a href="#%E6%80%BB%E7%BB%93-19" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>函数的参数可以按位置指定，也可以用关键字的形式指定。</li>\n<li>关键字可以让每个参数的作用更加明了，因为在调用函数时只按位置指定参数，可能导致这些参数的含义不够明确。</li>\n<li>应该通过带默认值的关键字参数来扩展函数的行为，因为这不会影响原有的函数调用代码。</li>\n<li>可选的关键字参数总是应该通过参数名来传递，而不应按位置传递。</li>\n</ol>\n<h2 id="第-24-条：用-none-和-docstring-来描述默认值会变的参数"><a href="#%E7%AC%AC-24-%E6%9D%A1%EF%BC%9A%E7%94%A8-none-%E5%92%8C-docstring-%E6%9D%A5%E6%8F%8F%E8%BF%B0%E9%BB%98%E8%AE%A4%E5%80%BC%E4%BC%9A%E5%8F%98%E7%9A%84%E5%8F%82%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 24 条：用 None 和 docstring 来描述默认值会变的参数</h2>\n<p>有时，我们想把那种不能够提前固定的值，当作关键字参数的默认值。例如，记录日志消息时，默认的时间应该是触发事件的那一刻。所以，如果调用者没有明确指定时间，那么就默认把调用函数的那一刻当成这条日志的记录时间。现在试试下面这种写法，假定它能让 when 参数的默认值随着这个函数每次的执行时间而发生变化。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6320556386388487000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from time import sleep\nfrom datetime import datetime\n\n\ndef log(message, when=datetime.now()):\n    print(f\'{when}: {message}\')\n\n\nlog(\'Hi there!\')\nsleep(0.1)\nlog(\'Hello again!\')\n\n>>>\n2022-09-16 11:39:58.577119: Hi there!\n2022-09-16 11:39:58.577119: Hello again!`, `6320556386388487000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> time <span class="token keyword">import</span> sleep\n<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime\n\n\n<span class="token keyword">def</span> <span class="token function">log</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> when<span class="token operator">=</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>when<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>message<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n\nlog<span class="token punctuation">(</span><span class="token string">\'Hi there!\'</span><span class="token punctuation">)</span>\nsleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>\nlog<span class="token punctuation">(</span><span class="token string">\'Hello again!\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">2022</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">16</span> <span class="token number">11</span><span class="token punctuation">:</span><span class="token number">39</span><span class="token punctuation">:</span><span class="token number">58.577119</span><span class="token punctuation">:</span> Hi there!\n<span class="token number">2022</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">16</span> <span class="token number">11</span><span class="token punctuation">:</span><span class="token number">39</span><span class="token punctuation">:</span><span class="token number">58.577119</span><span class="token punctuation">:</span> Hello again!</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写不行。因为 datetime.now 只执行了一次，所以每条日志的时间戳（timestamp）相同。参数的默认值只会在系统加载这个模块的时候，计算一遍，而不会在每次执行时都重新计算，这通常意味着这些默认值在程序启动后，就已经定下来了。只要包含这段代码的那个模块已经加载进来，那么 when 参数的默认值就是加载时计算的那个 datetime.now()，系统不会重新计算。</p>\n<p>要想在 Python 里实现这种效果，惯用的办法是把参数的默认值设为 None，同时在 docstring 文档里面写清楚，这个参数为 None 时，函数会怎么运作（参见第 84 条）。给函数写实现代码时，要判断该参数是不是 None，如果是，就把它改成相应的默认值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29792027508495946000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from time import sleep\nfrom datetime import datetime\n\n\ndef log(message, when=None):\n    &quot;&quot;&quot;Log a message with a timestamp.\n\n    Args:\n        message: Message to print.\n        when: datetime of when the message occurred.\n            Defaults to the present time.\n    &quot;&quot;&quot;\n    if when is None:\n        when = datetime.now()\n    print(f\'{when}: {message}\')\n\n\nlog(\'Hi there!\')\nsleep(0.1)\nlog(\'Hello again!\')\n\n>>>\n2022-09-16 11:52:02.810552: Hi there!\n2022-09-16 11:52:02.910765: Hello again!`, `29792027508495946000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> time <span class="token keyword">import</span> sleep\n<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime\n\n\n<span class="token keyword">def</span> <span class="token function">log</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> when<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token triple-quoted-string string">"""Log a message with a timestamp.\n\n    Args:\n        message: Message to print.\n        when: datetime of when the message occurred.\n            Defaults to the present time.\n    """</span>\n    <span class="token keyword">if</span> when <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n        when <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>when<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>message<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n\nlog<span class="token punctuation">(</span><span class="token string">\'Hi there!\'</span><span class="token punctuation">)</span>\nsleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>\nlog<span class="token punctuation">(</span><span class="token string">\'Hello again!\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">2022</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">16</span> <span class="token number">11</span><span class="token punctuation">:</span><span class="token number">52</span><span class="token punctuation">:</span><span class="token number">02.810552</span><span class="token punctuation">:</span> Hi there!\n<span class="token number">2022</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">16</span> <span class="token number">11</span><span class="token punctuation">:</span><span class="token number">52</span><span class="token punctuation">:</span><span class="token number">02.910765</span><span class="token punctuation">:</span> Hello again!</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>把参数的默认值写成 None 还有个重要的意义，就是用来表示那种以后可能由调用者修改内容的默认值（例如某个可变的容器）。例如，我们要写一个函数对采用 JSON 格式编码的数据做解码。如果无法解码，那么就返回调用时所指定的默认结果，假如调用者当时没有明确指定，那就返回空白的字典。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97512671975547320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import json\n\n\ndef decode(data, default={}):\n    try:\n        return json.loads(data)\n    except ValueError:\n        return default`, `97512671975547320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> json\n\n\n<span class="token keyword">def</span> <span class="token function">decode</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">)</span>\n    <span class="token keyword">except</span> ValueError<span class="token punctuation">:</span>\n        <span class="token keyword">return</span> default</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样的写法与前面 datetime.now 的例子有着同样的问题。系统只会计算一次 default 参数（在加载这个模块的时候），所以每次调用这个函数时，给调用者返回的都是一开始分配的那个字典，这就相当于凡是以默认值调用这个函数的代码都共用同一份字典。这会使程序出现很奇怪的效果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87750015847965950000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import json\n\n\ndef decode(data, default={}):\n    try:\n        return json.loads(data)\n    except ValueError:\n        return default\n\n\nfoo = decode(\'bad data\')\nfoo[\'stuff\'] = 5\nbar = decode(\'also bad\')\nbar[\'meep\'] = 1\nprint(\'Foo:\', foo)\nprint(\'Bar:\', bar)\n\n>>>\nFoo: {\'stuff\': 5, \'meep\': 1}\nBar: {\'stuff\': 5, \'meep\': 1}`, `87750015847965950000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> json\n\n\n<span class="token keyword">def</span> <span class="token function">decode</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">)</span>\n    <span class="token keyword">except</span> ValueError<span class="token punctuation">:</span>\n        <span class="token keyword">return</span> default\n\n\nfoo <span class="token operator">=</span> decode<span class="token punctuation">(</span><span class="token string">\'bad data\'</span><span class="token punctuation">)</span>\nfoo<span class="token punctuation">[</span><span class="token string">\'stuff\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">5</span>\nbar <span class="token operator">=</span> decode<span class="token punctuation">(</span><span class="token string">\'also bad\'</span><span class="token punctuation">)</span>\nbar<span class="token punctuation">[</span><span class="token string">\'meep\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Foo:\'</span><span class="token punctuation">,</span> foo<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Bar:\'</span><span class="token punctuation">,</span> bar<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nFoo<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'stuff\'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">\'meep\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span>\nBar<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'stuff\'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">\'meep\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们本意是想让这两次调用操作得到两个不同的空白字典，每个字典都可以分别用来存放不同的键值。但实际上，只要修改其中一个字典，另一个字典的内容就会受到影响。这种错误的根源在于，foo 和 bar 实际上是同一个字典，都等于系统一开始给 default 参数确定默认值时所分配的那个字典。它们表示的是同一个字典对象。</p>\n<p>要解决这个问题，可以把默认值设成 None，并且在 docstring 文档里面说明，函数在这个值为 None 时会怎么做。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50458176618103680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import json\n\n\ndef decode(data, default=None):\n    &quot;&quot;&quot;Load JSON data from a string.\n\n    Args:\n        data: JSON data to decode.\n        default: Value to return if decoding fails.\n            Defaults to an empty dictionary.\n    &quot;&quot;&quot;\n    try:\n        return json.loads(data)\n    except ValueError:\n        if default is None:\n            default = {}\n        return default\n\n\nfoo = decode(\'bad data\')\nfoo[\'stuff\'] = 5\nbar = decode(\'also bad\')\nbar[\'meep\'] = 1\nprint(\'Foo:\', foo)\nprint(\'Bar:\', bar)\nassert foo is not bar\n\n>>>\nFoo: {\'stuff\': 5}\nBar: {\'meep\': 1}`, `50458176618103680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> json\n\n\n<span class="token keyword">def</span> <span class="token function">decode</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token triple-quoted-string string">"""Load JSON data from a string.\n\n    Args:\n        data: JSON data to decode.\n        default: Value to return if decoding fails.\n            Defaults to an empty dictionary.\n    """</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">)</span>\n    <span class="token keyword">except</span> ValueError<span class="token punctuation">:</span>\n        <span class="token keyword">if</span> default <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n            default <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n        <span class="token keyword">return</span> default\n\n\nfoo <span class="token operator">=</span> decode<span class="token punctuation">(</span><span class="token string">\'bad data\'</span><span class="token punctuation">)</span>\nfoo<span class="token punctuation">[</span><span class="token string">\'stuff\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">5</span>\nbar <span class="token operator">=</span> decode<span class="token punctuation">(</span><span class="token string">\'also bad\'</span><span class="token punctuation">)</span>\nbar<span class="token punctuation">[</span><span class="token string">\'meep\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Foo:\'</span><span class="token punctuation">,</span> foo<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Bar:\'</span><span class="token punctuation">,</span> bar<span class="token punctuation">)</span>\n<span class="token keyword">assert</span> foo <span class="token keyword">is</span> <span class="token keyword">not</span> bar\n\n<span class="token operator">>></span><span class="token operator">></span>\nFoo<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'stuff\'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">}</span>\nBar<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'meep\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个思路可以跟类型注解搭配起来（参见第 90 条）。下面这种写法把 when 参数标注成可选（Optional）值，并限定其类型为 datetime。于是，它的取值就只有两种可能，要么是 None，要么是 datetime 对象。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39741411661480890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from typing import Optional\n\n\ndef log_typed(message: str, when: Optional[datetime] = None) -> None:\n    &quot;&quot;&quot;Log a message with a timestamp.\n\n        Args:\n            message: Message to print.\n            when: datetime of when the message occurred.\n                Defaults to the present time.\n    &quot;&quot;&quot;\n    if when is None:\n        when = datetime.now()\n    print(f\'{when}: {message}\')`, `39741411661480890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> typing <span class="token keyword">import</span> Optional\n\n\n<span class="token keyword">def</span> <span class="token function">log_typed</span><span class="token punctuation">(</span>message<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> when<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>datetime<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n    <span class="token triple-quoted-string string">"""Log a message with a timestamp.\n\n        Args:\n            message: Message to print.\n            when: datetime of when the message occurred.\n                Defaults to the present time.\n    """</span>\n    <span class="token keyword">if</span> when <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n        when <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>when<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>message<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="总结-20"><a href="#%E6%80%BB%E7%BB%93-20" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>参数的默认值只会计算一次，也就是在系统把定义函数的那个模块加载进来的时候。所以，如果默认值将来可能由调用方修改（例如 {}、[]）或者要随着调用时的情况变化（例如 datetime.now()），那么程序就会出现奇怪的效果。</li>\n<li>如果关键字参数的默认值属于这种会发生变化的值，那就应该写成 None，并且要在 docstring 里面描述函数此时的默认行为。</li>\n<li>默认值为 None 的关键字参数，也可以添加类型注解。</li>\n</ol>\n<h2 id="第-25-条：用只能以关键字指定和只能按位置传入的参数来设计清晰的参数列表"><a href="#%E7%AC%AC-25-%E6%9D%A1%EF%BC%9A%E7%94%A8%E5%8F%AA%E8%83%BD%E4%BB%A5%E5%85%B3%E9%94%AE%E5%AD%97%E6%8C%87%E5%AE%9A%E5%92%8C%E5%8F%AA%E8%83%BD%E6%8C%89%E4%BD%8D%E7%BD%AE%E4%BC%A0%E5%85%A5%E7%9A%84%E5%8F%82%E6%95%B0%E6%9D%A5%E8%AE%BE%E8%AE%A1%E6%B8%85%E6%99%B0%E7%9A%84%E5%8F%82%E6%95%B0%E5%88%97%E8%A1%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 25 条：用只能以关键字指定和只能按位置传入的参数来设计清晰的参数列表</h2>\n<p>按关键字传递参数是 Python 函数的一项强大特性（参见第 23 条）。这种关键字参数特别灵活，在很多情况下，都能让我们写出一看就懂的函数代码。例如，计算两数相除的结果时，可能需要仔细考虑各种特殊情况。</p>\n<p>例如，在除数为 0 的情况下，是抛出 ZeroDivisionError 异常，还是返回无穷（infinity）；在结果溢出的情况下，是抛出 OverflowError 异常，还是返回 0。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14862749139606612000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def safe_division(number, divisor,\n                  ignore_overflow,\n                  ignore_zero_division):\n    try:\n        return number / divisor\n    except OverflowError:\n        if ignore_overflow:\n            return 0\n        else:\n            raise\n    except ZeroDivisionError:\n        if ignore_zero_division:\n            return float(\'inf\')\n        else:\n            raise`, `14862749139606612000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">safe_division</span><span class="token punctuation">(</span>number<span class="token punctuation">,</span> divisor<span class="token punctuation">,</span>\n                  ignore_overflow<span class="token punctuation">,</span>\n                  ignore_zero_division<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> number <span class="token operator">/</span> divisor\n    <span class="token keyword">except</span> OverflowError<span class="token punctuation">:</span>\n        <span class="token keyword">if</span> ignore_overflow<span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token number">0</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span>\n    <span class="token keyword">except</span> ZeroDivisionError<span class="token punctuation">:</span>\n        <span class="token keyword">if</span> ignore_zero_division<span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">\'inf\'</span><span class="token punctuation">)</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个函数用起来很直观。如果想在结果溢出的情况下，让它返回 0，那么可以像下面这样调用函数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86534335029716430000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`result = safe_division(1.0, 10**500, True, False)\nprint(result)\n\n>>>\n0`, `86534335029716430000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">result <span class="token operator">=</span> safe_division<span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token operator">**</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果想在除数是 0 的情况下，让函数返回无穷，那么就按下面这样来写。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40170074240787850000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`result = safe_division(1.0, 0, False, True)\nprint(result)\n\n>>>\ninf`, `40170074240787850000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">result <span class="token operator">=</span> safe_division<span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\ninf</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>表示要不要忽略异常的那两个参数都是 Boolean 值，所以容易弄错位置，这会让程序出现难以查找的 bug。要想让代码看起来更清晰，一种办法是给这两个参数都指定默认值。按照默认值，该函数只要遇到特殊情况，就会抛出异常。</p>\n<p>调用者可以用关键字参数指定覆盖其中某个参数的默认值，以调整函数在遇到那种特殊情况时的处理方式，同时让另一个参数依然取那个参数自己的默认值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63792724603190970000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def safe_division_b(number, divisor,\n                    ignore_overflow=False,\n                    ignore_zero_division=False):\n    try:\n        return number / divisor\n    except OverflowError:\n        if ignore_overflow:\n            return 0\n        else:\n            raise\n    except ZeroDivisionError:\n        if ignore_zero_division:\n            return float(\'inf\')\n        else:\n            raise\n\n\nresult = safe_division_b(1.0, 10**500, ignore_overflow=True)\nprint(result)\nresult = safe_division_b(1.0, 0, ignore_zero_division=True)\nprint(result)\n\n>>>\n0\ninf`, `63792724603190970000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{2-3}"\n              >\n                <span class="gatsby-code-button-language">py{2-3}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">safe_division_b</span><span class="token punctuation">(</span>number<span class="token punctuation">,</span> divisor<span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">                    ignore_overflow<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">                    ignore_zero_division<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> number <span class="token operator">/</span> divisor\n    <span class="token keyword">except</span> OverflowError<span class="token punctuation">:</span>\n        <span class="token keyword">if</span> ignore_overflow<span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token number">0</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span>\n    <span class="token keyword">except</span> ZeroDivisionError<span class="token punctuation">:</span>\n        <span class="token keyword">if</span> ignore_zero_division<span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">\'inf\'</span><span class="token punctuation">)</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span>\n\n\nresult <span class="token operator">=</span> safe_division_b<span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token operator">**</span><span class="token number">500</span><span class="token punctuation">,</span> ignore_overflow<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>\nresult <span class="token operator">=</span> safe_division_b<span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ignore_zero_division<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">0</span>\ninf</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然而，由于这些关键参数是可选的，我们没办法要求调用者必须按照关键字形式来指定这两个参数。他们还是可以用传统的写法，按位置给这个新定义的 <code class="language-text">safe_division_b</code> 函数传递参数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84344084214599480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`assert safe_division_b(1.0, 10**500, True, False) == 0`, `84344084214599480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">assert</span> safe_division_b<span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token operator">**</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>对于这种参数比较复杂的函数，我们可以声明只能通过关键字指定的参数（keyword-only argument），这样的话，写出来的代码就能清楚地反映调用者的想法了。这种参数只能用关键字来指定，不能按位置传递。</p>\n<p>下面就重新定义 <code class="language-text">safe_division</code> 函数，让它接受这样的参数。参数列表里的 <code class="language-text">*</code> 符号把参数分成两组，左边是位置参数，右边是只能用关键字指定的参数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47172387520788600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def safe_division_c(number, divisor, *,\n                    ignore_overflow=False,\n                    ignore_zero_division=False):\n    try:\n        return number / divisor\n    except OverflowError:\n        if ignore_overflow:\n            return 0\n        else:\n            raise\n    except ZeroDivisionError:\n        if ignore_zero_division:\n            return float(\'inf\')\n        else:\n            raise\n\n\nassert safe_division_c(1.0, 10**500, True, False) == 0\n\n>>>\nTraceback ...\nTypeError: safe_division_c() takes 2 positional arguments but 4 were given`, `47172387520788600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{1}"\n              >\n                <span class="gatsby-code-button-language">py{1}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="gatsby-highlight-code-line"><span class="token keyword">def</span> <span class="token function">safe_division_c</span><span class="token punctuation">(</span>number<span class="token punctuation">,</span> divisor<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span></span>                    ignore_overflow<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>\n                    ignore_zero_division<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> number <span class="token operator">/</span> divisor\n    <span class="token keyword">except</span> OverflowError<span class="token punctuation">:</span>\n        <span class="token keyword">if</span> ignore_overflow<span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token number">0</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span>\n    <span class="token keyword">except</span> ZeroDivisionError<span class="token punctuation">:</span>\n        <span class="token keyword">if</span> ignore_zero_division<span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">\'inf\'</span><span class="token punctuation">)</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span>\n\n\n<span class="token keyword">assert</span> safe_division_c<span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token operator">**</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> safe_division_c<span class="token punctuation">(</span><span class="token punctuation">)</span> takes <span class="token number">2</span> positional arguments but <span class="token number">4</span> were given</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当然我们还是可以像前面那样，用关键字参数指定覆盖其中一个参数的默认值（即忽略其中一种特殊情况，并让函数在遇到另一种特殊情况时抛出异常）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5046135840612509000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`result = safe_division_c(1.0, 0, ignore_zero_division=True)\nassert result == float(\'inf\')\ntry:\n    result = safe_division_c(1.0, 0)\nexcept ZeroDivisionError:\n    pass  # Expected`, `5046135840612509000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">result <span class="token operator">=</span> safe_division_c<span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ignore_zero_division<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\n<span class="token keyword">assert</span> result <span class="token operator">==</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">\'inf\'</span><span class="token punctuation">)</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    result <span class="token operator">=</span> safe_division_c<span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\n<span class="token keyword">except</span> ZeroDivisionError<span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>  <span class="token comment"># Expected</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样改依然有问题，因为在 <code class="language-text">safe_division_c</code> 版本的函数里面，有两个参数（也就是 number 和 divisor）必须由调用者提供。然而，调用者在提供这两个参数时，既可以按位置提供，也可以按关键字提供，还可以把这两种方式混起来用。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47856366198965080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`assert safe_division_c(number=2, divisor=5) == 0.4\nassert safe_division_c(divisor=5, number=2) == 0.4\nassert safe_division_c(2, divisor=5) == 0.4`, `47856366198965080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">assert</span> safe_division_c<span class="token punctuation">(</span>number<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> divisor<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0.4</span>\n<span class="token keyword">assert</span> safe_division_c<span class="token punctuation">(</span>divisor<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> number<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0.4</span>\n<span class="token keyword">assert</span> safe_division_c<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> divisor<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0.4</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>在未来也许因为扩展函数的需要，甚至是因为代码风格的变化，或许要修改这两个参数的名字。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74341257739035000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def safe_division_c(numerator, denominator, *,\n                    ignore_overflow=False,\n                    ignore_zero_division=False):`, `74341257739035000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{1}"\n              >\n                <span class="gatsby-code-button-language">py{1}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="gatsby-highlight-code-line"><span class="token keyword">def</span> <span class="token function">safe_division_c</span><span class="token punctuation">(</span>numerator<span class="token punctuation">,</span> denominator<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span></span>                    ignore_overflow<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>\n                    ignore_zero_division<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>这看起来只是文字上面的微调，但之前所有通过关键字形式来指定这两个参数的调用代码，都会出错。</p>\n<p>其实最重要的问题在于，我们根本就没打算把 number 和 divisor 这两个名称纳入函数的接口；我们只是在编写函数的实现代码时，随意挑了这两个比较顺口的名称而已。也并不期望调用者也非得采用这种称呼来指定这两个参数。</p>\n<p>Python 3.8 引入了一项新特性，可以解决这个问题，这就是只能按位置传递的参数（positional-only argument）。这种参数与刚才的只能通过关键字指定的参数（keyword-only argument）相反，它们必须按位置指定，绝不能通过关键字形式指定。下面来重新定义 <code class="language-text">safe_division</code> 函数，使其前两个必须由调用者提供的参数只能按位置来提供。参数列表中的 <code class="language-text">/</code> 符号，表示它左边的那些参数只能按位置指定。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78745346734481150000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def safe_division_d(numerator, denominator, /, *,\n                    ignore_overflow=False,\n                    ignore_zero_division=False):\n    try:\n        return numerator / denominator\n    except OverflowError:\n        if ignore_overflow:\n            return 0\n        else:\n            raise\n    except ZeroDivisionError:\n        if ignore_zero_division:\n            return float(\'inf\')\n        else:\n            raise\n\n\nassert safe_division_d(2, 5) == 0.4 # 正常运行\nassert safe_division_d(numerator=2, denominator=5) == 0.4 # 报错`, `78745346734481150000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{1}"\n              >\n                <span class="gatsby-code-button-language">py{1}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="gatsby-highlight-code-line"><span class="token keyword">def</span> <span class="token function">safe_division_d</span><span class="token punctuation">(</span>numerator<span class="token punctuation">,</span> denominator<span class="token punctuation">,</span> <span class="token operator">/</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span></span>                    ignore_overflow<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>\n                    ignore_zero_division<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> numerator <span class="token operator">/</span> denominator\n    <span class="token keyword">except</span> OverflowError<span class="token punctuation">:</span>\n        <span class="token keyword">if</span> ignore_overflow<span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token number">0</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span>\n    <span class="token keyword">except</span> ZeroDivisionError<span class="token punctuation">:</span>\n        <span class="token keyword">if</span> ignore_zero_division<span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">\'inf\'</span><span class="token punctuation">)</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span>\n\n\n<span class="token keyword">assert</span> safe_division_d<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0.4</span> <span class="token comment"># 正常运行</span>\n<span class="token keyword">assert</span> safe_division_d<span class="token punctuation">(</span>numerator<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> denominator<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0.4</span> <span class="token comment"># 报错</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在我们可以确信：给 <code class="language-text">safe_division_d</code> 函数的前两个参数（也就是那两个必备的参数）所挑选的名称，已经与调用者的代码解耦了。即便以后再次修改这两个参数的名称，也不会影响已经写好的调用代码。</p>\n<p>在函数的参数列表之中，<code class="language-text">/</code> 符号左侧的参数是只能按位置指定的参数，<code class="language-text">*</code> 符号右侧的参数则是只能按关键字形式指定的参数。那么，这两个符号如果同时出现在参数列表中，会有什么效果呢？这是个值得注意的问题。这意味着，这两个符号之间的参数，既可以按位置提供，又可以用关键字形式指定（其实，如果不特别说明 Python 函数的参数全都属于这种参数）。在设计 API 时，为了体现某编程风格或者实现某些需求，可能会允许某些参数既可以按位置传递，也可以用关键字形式指定，这样可以让代码简单易读。例如，给下面这个 <code class="language-text">safe_division</code> 函数的参数列表添加一个可选的 ndigits 参数，允许调用者指定这次除法应该精确到小数点后第几位。</p>\n<p>下面我们用三种方式来调用这个 <code class="language-text">safe_division_e</code> 函数。ndigits 是个带默认值的普通参数，因此，它既可以按位置传递，也可以用关键字来指定，还可以直接省略。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53077012006385730000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def safe_division_e(numerator, denominator, /,\n                    ndigits=10, *,\n                    ignore_overflow=False,\n                    ignore_zero_division=False):\n    try:\n        fraction = numerator / denominator\n        return round(fraction, ndigits)\n    except OverflowError:\n        if ignore_overflow:\n            return 0\n        else:\n            raise\n    except ZeroDivisionError:\n        if ignore_zero_division:\n            return float(\'inf\')\n        else:\n            raise\n\n\nresult = safe_division_e(22, 7)\nprint(result)\nresult = safe_division_e(22, 7, 5)\nprint(result)\nresult = safe_division_e(22, 7, ndigits=2)\nprint(result)\n\n>>>\n3.1428571429\n3.14286\n3.14`, `53077012006385730000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">safe_division_e</span><span class="token punctuation">(</span>numerator<span class="token punctuation">,</span> denominator<span class="token punctuation">,</span> <span class="token operator">/</span><span class="token punctuation">,</span>\n                    ndigits<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span>\n                    ignore_overflow<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>\n                    ignore_zero_division<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        fraction <span class="token operator">=</span> numerator <span class="token operator">/</span> denominator\n        <span class="token keyword">return</span> <span class="token builtin">round</span><span class="token punctuation">(</span>fraction<span class="token punctuation">,</span> ndigits<span class="token punctuation">)</span>\n    <span class="token keyword">except</span> OverflowError<span class="token punctuation">:</span>\n        <span class="token keyword">if</span> ignore_overflow<span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token number">0</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span>\n    <span class="token keyword">except</span> ZeroDivisionError<span class="token punctuation">:</span>\n        <span class="token keyword">if</span> ignore_zero_division<span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">\'inf\'</span><span class="token punctuation">)</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span>\n\n\nresult <span class="token operator">=</span> safe_division_e<span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>\nresult <span class="token operator">=</span> safe_division_e<span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>\nresult <span class="token operator">=</span> safe_division_e<span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> ndigits<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">3.1428571429</span>\n<span class="token number">3.14286</span>\n<span class="token number">3.14</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="总结-21"><a href="#%E6%80%BB%E7%BB%93-21" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>Keyword-only argument 是一种只能通过关键字指定而不能通过位置指定的参数。这迫使调用者必须指明，这个值是传给哪一个参数的。在函数的参数列表中，这种参数位于 <code class="language-text">*</code> 符号的右侧。</li>\n<li>Positional-only argument 是这样一种参数，它不允许调用者通过关键字来指定，而是要求必须按位置传递。这可以降低调用代码与参数名称之间的耦合程度。在函数的参数列表中，这些参数位于 <code class="language-text">/</code> 符号的左侧。</li>\n<li>在参数列表中，位于 <code class="language-text">/</code> 与 <code class="language-text">*</code> 之间的参数，可以按位置指定，也可以用关键字来指定。这也是 Python 普通参数的默认指定方式。</li>\n</ol>\n<h2 id="第-26-条：用-functoolswraps-定义函数修饰器"><a href="#%E7%AC%AC-26-%E6%9D%A1%EF%BC%9A%E7%94%A8-functoolswraps-%E5%AE%9A%E4%B9%89%E5%87%BD%E6%95%B0%E4%BF%AE%E9%A5%B0%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 26 条：用 functools.wraps 定义函数修饰器</h2>\n<p>Python 中有一种特殊的写法，可以用修饰器（decorator）来封装某个函数，从而让程序在执行这个函数之前与执行完这个函数之后，分别运行某些代码。这意味着，调用者传给函数的参数值、函数返回给调用者的值，以及函数抛出的异常，都可以由修饰器访问并修改。这是个很有用的机制，能够确保用户以正确的方式使用函数，也能够用来调试程序或实现函数注册功能，此外还有许多用途。</p>\n<p>例如，假设我们要把函数执行时收到的参数与返回的值记录下来。这在调试递归函数时是很有用的，因为我们需要知道，这个函数执行每一层递归时，输入的是什么参数，返回的是什么值。下面我们就定义这样一个修饰器，在实现这个修饰器时，用 <code class="language-text">*args</code> 与 <code class="language-text">**kwargs</code> 表示受修饰的原函数 func 所收到的参数（参见第 22 条与第 23 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55575205798537855000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def trace(func):\n    def wrapper(*args, **kwargs):\n        result = func(*args, **kwargs)\n        print(f\'{func.__name__}({args!r}，{kwargs!r})\'\n              f\'-> {result!r}\')\n        return result\n    return wrapper\n\n\n@trace # 相当于 fibonacci = trace(fibonacci)\ndef fibonacci(n):\n    &quot;&quot;&quot;Return the n-th Fibonacci number&quot;&quot;&quot;\n    if n in (0, 1):\n        return n\n    return fibonacci(n - 2) + fibonacci(n - 1)\n\nfibonacci(4)\n\n>>>\nfibonacci((0,)，{})-> 0\nfibonacci((1,)，{})-> 1\nfibonacci((2,)，{})-> 1\nfibonacci((1,)，{})-> 1\nfibonacci((0,)，{})-> 0\nfibonacci((1,)，{})-> 1\nfibonacci((2,)，{})-> 1\nfibonacci((3,)，{})-> 2\nfibonacci((4,)，{})-> 3`, `55575205798537855000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">trace</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        result <span class="token operator">=</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>func<span class="token punctuation">.</span>__name__<span class="token punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token punctuation">{</span>args<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">，</span><span class="token interpolation"><span class="token punctuation">{</span>kwargs<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">)\'</span></span>\n              <span class="token string-interpolation"><span class="token string">f\'-> </span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> result\n    <span class="token keyword">return</span> wrapper\n\n\n@trace <span class="token comment"># 相当于 fibonacci = trace(fibonacci)</span>\n<span class="token keyword">def</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token triple-quoted-string string">"""Return the n-th Fibonacci number"""</span>\n    <span class="token keyword">if</span> n <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> n\n    <span class="token keyword">return</span> fibonacci<span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> fibonacci<span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>\n\nfibonacci<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nfibonacci<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">)</span>，<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span> <span class="token number">0</span>\nfibonacci<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">)</span>，<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span> <span class="token number">1</span>\nfibonacci<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token punctuation">)</span>，<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span> <span class="token number">1</span>\nfibonacci<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">)</span>，<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span> <span class="token number">1</span>\nfibonacci<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">)</span>，<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span> <span class="token number">0</span>\nfibonacci<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">)</span>，<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span> <span class="token number">1</span>\nfibonacci<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token punctuation">)</span>，<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span> <span class="token number">1</span>\nfibonacci<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token punctuation">)</span>，<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span> <span class="token number">2</span>\nfibonacci<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token punctuation">)</span>，<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span> <span class="token number">3</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写确实能满足需求，但是会带来一个我们不愿意看到的副作用。修饰器返回的那个值，也就是刚才调用的 fibonacci，它的名字并不叫 <code class="language-text">fibonacci</code>。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40381450825634630000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`print(fibonacci)\n\n>>>\n<function trace.<locals>.wrapper at 0x108955dcO>`, `40381450825634630000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">print</span><span class="token punctuation">(</span>fibonacci<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token operator">&lt;</span>function trace<span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token builtin">locals</span><span class="token operator">></span><span class="token punctuation">.</span>wrapper at 0x108955dcO<span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种现象解释起来并不困难。trace 函数返回的，是它里面定义的 wrapper 函数，所以，当我们把这个返回值赋给 fibonacci 之后，fibonacci 这个名称所表示的自然就是 wrapper 了。问题在于，这样可能会干扰那些需要利用 introspection 机制来运作的工具，例如调试器（debugger）（参见第 80 条）。</p>\n<p>例如，如果用内置的 help 函数来查看修饰后的 fibonacci，那么打印出来的并不是我们想看的帮助文档，它本来应该打印前面定义时写的那行 <code class="language-text">Return the n-th Fibonacci number</code> 文本才对。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53539570324039330000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`help(fibonacci)\n\n>>>\nHelp on function wrapper in module __main__:\n\nwrapper(*args, **kwargs)`, `53539570324039330000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token builtin">help</span><span class="token punctuation">(</span>fibonacci<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nHelp on function wrapper <span class="token keyword">in</span> module __main__<span class="token punctuation">:</span>\n\nwrapper<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>对象序列化器（object serializer，参见第 68 条）也无法正常运作，因为它不能确定受修饰的那个原始函数的位置。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28842078403753857000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import pickle\n\npickle.dumps(fibonacci)\n\n>>>\nTraceback ...\nAttributeError: Can\'t pickle local object \'trace.<locals>.wrapper\'`, `28842078403753857000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> pickle\n\npickle<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>fibonacci<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nAttributeError<span class="token punctuation">:</span> Can<span class="token string">\'t pickle local object \'</span>trace<span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token builtin">locals</span><span class="token operator">></span><span class="token punctuation">.</span>wrapper\'</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>要想解决这些问题，可以改用 functools 内置模块之中的 wraps 辅助函数来实现。wraps 本身也是个修饰器，它可以帮助你编写自己的修饰器。把它运用到 wrapper 函数上面，它就会将重要的元数据（metadata）全都从内部函数复制到外部函数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63408179511550110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import pickle\nfrom functools import wraps\n\n\ndef trace(func):\n    @wraps(func)\n    def wrapper(*args, **kwargs):\n        result = func(*args, **kwargs)\n        print(f\'{func.__name__}({args!r}，{kwargs!r})\'\n              f\'-> {result!r}\')\n        return result\n    return wrapper\n\n\n@trace\ndef fibonacci(n):\n    &quot;&quot;&quot;Return the n-th Fibonacci number&quot;&quot;&quot;\n    if n in (0, 1):\n        return n\n    return fibonacci(n - 2) + fibonacci(n - 1)\n\n\npickle.dumps(fibonacci)\nhelp(fibonacci)`, `63408179511550110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{2,6}"\n              >\n                <span class="gatsby-code-button-language">py{2,6}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> pickle\n<span class="gatsby-highlight-code-line"><span class="token keyword">from</span> functools <span class="token keyword">import</span> wraps</span>\n\n<span class="token keyword">def</span> <span class="token function">trace</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="gatsby-highlight-code-line">    @wraps<span class="token punctuation">(</span>func<span class="token punctuation">)</span></span>    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        result <span class="token operator">=</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>func<span class="token punctuation">.</span>__name__<span class="token punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token punctuation">{</span>args<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">，</span><span class="token interpolation"><span class="token punctuation">{</span>kwargs<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">)\'</span></span>\n              <span class="token string-interpolation"><span class="token string">f\'-> </span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> result\n    <span class="token keyword">return</span> wrapper\n\n\n@trace\n<span class="token keyword">def</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token triple-quoted-string string">"""Return the n-th Fibonacci number"""</span>\n    <span class="token keyword">if</span> n <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> n\n    <span class="token keyword">return</span> fibonacci<span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> fibonacci<span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>\n\n\npickle<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>fibonacci<span class="token punctuation">)</span>\n<span class="token builtin">help</span><span class="token punctuation">(</span>fibonacci<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在我们就可以通过 help 函数看到正确的文档了。虽然原来的 fibonacci 函数现在封装在修饰器里面，但我们还是可以看到它的文档。</p>\n<p>除了这里讲到的几个方面之外，Python 函数还有很多标准属性（例如 <code class="language-text">__name__</code>、<code class="language-text">__module__</code>、<code class="language-text">__annotations__</code>）也应该在受到封装时得以保留，这样才能让相关的接口正常运作。wraps 可以帮助保留这些属性，使程序表现出正确的行为。</p>\n<h3 id="总结-22"><a href="#%E6%80%BB%E7%BB%93-22" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>修饰器是 Python 中的一种写法，能够把一个函数封装在另一个函数里面，这样程序在执行原函数之前与执行完毕之后，就有机会执行其他一些逻辑了。</li>\n<li>修饰器可能会让那些利用 introspection 机制运作的工具（例如调试器）产生奇怪的行为。</li>\n<li>Python 内置的 functools 模块里有个叫作 wraps 的修饰器，可以帮助我们正确定义自己的修饰器，从而避开相关的问题。</li>\n</ol>\n<h1 id="推导与生成"><a href="#%E6%8E%A8%E5%AF%BC%E4%B8%8E%E7%94%9F%E6%88%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>推导与生成</h1>\n<h2 id="第-27-条：用列表推导取代-map-与-filter"><a href="#%E7%AC%AC-27-%E6%9D%A1%EF%BC%9A%E7%94%A8%E5%88%97%E8%A1%A8%E6%8E%A8%E5%AF%BC%E5%8F%96%E4%BB%A3-map-%E4%B8%8E-filter" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 27 条：用列表推导取代 map 与 filter</h2>\n<p>Python 里面有一种很精简的写法，可以根据某个序列或可迭代对象派生出一份新的列表。用这种写法写成的表达式，叫作列表推导（list comprehension）。假设我们要用列表中每个元素的平方值构建一份新的列表。传统的写法是，采用下面这个简单的 for 循环来实现。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94249798830559310000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]\nsquares = []\nfor x in a:\n    squares.append(x**2)\nprint(squares)\n\n>>>\n[1, 4, 9, 16, 25, 36, 49, 64, 81, 100]`, `94249798830559310000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\nsquares <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n<span class="token keyword">for</span> x <span class="token keyword">in</span> a<span class="token punctuation">:</span>\n    squares<span class="token punctuation">.</span>append<span class="token punctuation">(</span>x<span class="token operator">**</span><span class="token number">2</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>squares<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">49</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">81</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面那段代码可以改用列表推导来写，这样可以在迭代列表的过程中，根据表达式算出新列表中的对应元素。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73003086209848190000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]\nsquares = [x**2 for x in a]\nprint(squares)`, `73003086209848190000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\nsquares <span class="token operator">=</span> <span class="token punctuation">[</span>x<span class="token operator">**</span><span class="token number">2</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> a<span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>squares<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>这种功能当然也可以用内置函数 map 实现，它能够从多个列表中分别取出当前位置上的元素，并把它们当作参数传给映射函数，以求出新列表在这个位置上的元素值。如果映射关系比较简单（例如只是把一个列表映射到另一个列表），那么用列表推导来写还是比用 map 简单一些，因为用 map 的时候，必须先把映射逻辑定义成 lambda 函数，这看上去稍微有点烦琐。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11668100214631893000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]\nsquares = list(map(lambda x: x ** 2, a))\nprint(squares)`, `11668100214631893000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\nsquares <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>squares<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>列表推导还有一个地方比 map 好，就是它能够方便地过滤原列表，把某些输入值对应的计算结果从输出结果中排除。例如，假设新列表只需要纳入原列表中那些偶数的平方值，那我们可以在推导的时候，在 for x in a 这一部分的右侧写一个条件表达式：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97675956640705360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]\neven_squares = [x**2 for x in a if x % 2 == 0]\nprint(even_squares)\n\n>>>\n[4, 16, 36, 64, 100]`, `97675956640705360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\neven_squares <span class="token operator">=</span> <span class="token punctuation">[</span>x<span class="token operator">**</span><span class="token number">2</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> a <span class="token keyword">if</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>even_squares<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种功能也可以通过内置的 filter 与 map 函数来实现，但是这两个函数相结合的写法要比列表推导难懂一些。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4322789091902845400"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]\neven_squares = [x**2 for x in a if x % 2 == 0]\nalt = map(lambda x: x**2, filter(lambda x: x % 2 == 0, a))\nassert even_squares == list(alt)`, `4322789091902845400`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\neven_squares <span class="token operator">=</span> <span class="token punctuation">[</span>x<span class="token operator">**</span><span class="token number">2</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> a <span class="token keyword">if</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">]</span>\nalt <span class="token operator">=</span> <span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token operator">**</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">assert</span> even_squares <span class="token operator">==</span> <span class="token builtin">list</span><span class="token punctuation">(</span>alt<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>字典与集合也有相应的推导机制，分别叫作字典推导（dictionary comprehension）与集合推导（set comprehension）。编写算法时，可以利用这些机制根据原字典与原集合创建新字典与新集合。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83309296851350980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]\neven_squares_dict = {x: x**2 for x in a if x % 2 == 0}\nthrees_cubed_set = {x**3 for x in a if x % 3 == 0}\nprint(even_squares_dict)\nprint(threes_cubed_set)\n\n>>>\n{2: 4, 4: 16, 6: 36, 8: 64, 10: 100}\n{216, 729, 27}`, `83309296851350980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\neven_squares_dict <span class="token operator">=</span> <span class="token punctuation">{</span>x<span class="token punctuation">:</span> x<span class="token operator">**</span><span class="token number">2</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> a <span class="token keyword">if</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">}</span>\nthrees_cubed_set <span class="token operator">=</span> <span class="token punctuation">{</span>x<span class="token operator">**</span><span class="token number">3</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> a <span class="token keyword">if</span> x <span class="token operator">%</span> <span class="token number">3</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">}</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>even_squares_dict<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>threes_cubed_set<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">:</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">:</span> <span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">:</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">}</span>\n<span class="token punctuation">{</span><span class="token number">216</span><span class="token punctuation">,</span> <span class="token number">729</span><span class="token punctuation">,</span> <span class="token number">27</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果改用 map 与 filter 实现，那么还必须调用相应的构造器（constructor），这会让代码变得很长，需要分成多行才能写得下。这样看起来比较乱，不如使用推导机制的代码清晰。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63474963478649225000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]\neven_squares_dict = {x: x**2 for x in a if x % 2 == 0}\nthrees_cubed_set = {x**3 for x in a if x % 3 == 0}\n\nalt_dict = dict(map(lambda x: (x, x**2),\n                    filter(lambda x: x % 2 == 0, a)))\nalt_set = set(map(lambda x: x**3,\n                  filter(lambda x: x % 3 == 0, a)))\n\nassert even_squares_dict == alt_dict\nassert threes_cubed_set == alt_set`, `63474963478649225000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\neven_squares_dict <span class="token operator">=</span> <span class="token punctuation">{</span>x<span class="token punctuation">:</span> x<span class="token operator">**</span><span class="token number">2</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> a <span class="token keyword">if</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">}</span>\nthrees_cubed_set <span class="token operator">=</span> <span class="token punctuation">{</span>x<span class="token operator">**</span><span class="token number">3</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> a <span class="token keyword">if</span> x <span class="token operator">%</span> <span class="token number">3</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">}</span>\n\nalt_dict <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> x<span class="token operator">**</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n                    <span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\nalt_set <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token operator">**</span><span class="token number">3</span><span class="token punctuation">,</span>\n                  <span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x <span class="token operator">%</span> <span class="token number">3</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token keyword">assert</span> even_squares_dict <span class="token operator">==</span> alt_dict\n<span class="token keyword">assert</span> threes_cubed_set <span class="token operator">==</span> alt_set</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="总结-23"><a href="#%E6%80%BB%E7%BB%93-23" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>列表推导要比内置的 map 与 filter 函数清晰，因为它不用另外定义 lambda 表达式。</li>\n<li>列表推导可以很容易地跳过原列表中的某些数据，假如改用 map 实现，那么必须搭配 filter 才能实现。</li>\n<li>字典与集合也可以通过推导来创建。</li>\n</ol>\n<h2 id="第-28-条：控制推导逻辑的子表达式不要超过两个"><a href="#%E7%AC%AC-28-%E6%9D%A1%EF%BC%9A%E6%8E%A7%E5%88%B6%E6%8E%A8%E5%AF%BC%E9%80%BB%E8%BE%91%E7%9A%84%E5%AD%90%E8%A1%A8%E8%BE%BE%E5%BC%8F%E4%B8%8D%E8%A6%81%E8%B6%85%E8%BF%87%E4%B8%A4%E4%B8%AA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 28 条：控制推导逻辑的子表达式不要超过两个</h2>\n<p>除了最基本的用法（参见第 27 条）外，列表推导还支持多层循环。例如，要把矩阵（一种二维列表，它的每个元素本身也是列表）转化成普通的一维列表，那么可以在推导时，使用两条 for 子表达式。这些子表达式会按照从左到右的顺序解读。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27095499830655910000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`matrix = [[1, 2, 3], [4, 5, 6], [7, 8, 9]]\nflat = [x for row in matrix for x in row]\nprint(flat)\n\n>>>\n[1, 2, 3, 4, 5, 6, 7, 8, 9]`, `27095499830655910000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">matrix <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">]</span>\nflat <span class="token operator">=</span> <span class="token punctuation">[</span>x <span class="token keyword">for</span> row <span class="token keyword">in</span> matrix <span class="token keyword">for</span> x <span class="token keyword">in</span> row<span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>flat<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写简单易懂，这也正是多层循环在列表推导之中的合理用法。多层循环还可以用来重制那种两层深的结构。例如，如果要根据二维矩阵里每个元素的平方值构建一个新的二维矩阵，那么可以采用下面这种写法。这看上去有点儿复杂，因为它把小的推导逻辑 <code class="language-text">[x**2 for x in row]</code> 嵌到了大的推导逻辑里面，不过，这行语句总体上不难理解。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11813372549459177000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`matrix = [[1, 2, 3], [4, 5, 6], [7, 8, 9]]\nsquared = [[x**2 for x in row] for row in matrix]\nprint(squared)\n\n>>>\n[[1, 4, 9], [16, 25, 36], [49, 64, 81]]`, `11813372549459177000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">matrix <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">]</span>\nsquared <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>x<span class="token operator">**</span><span class="token number">2</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> row<span class="token punctuation">]</span> <span class="token keyword">for</span> row <span class="token keyword">in</span> matrix<span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>squared<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">49</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">81</span><span class="token punctuation">]</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果推导过程中还要再加一层循环，那么语句就会变得很长，必须把它分成多行来写，例如下面是把一个三维矩阵转化成普通一维列表的代码。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68928731666709250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`my_lists = [\n    [[1, 2, 3], [4, 5, 6]]\n]\nflat = [x for sublist1 in my_lists\n        for sublist2 in sublist1\n        for x in sublist2]\nprint(flat)\n\n>>>\n[1, 2, 3, 4, 5, 6]`, `68928731666709250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">my_lists <span class="token operator">=</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">]</span>\n<span class="token punctuation">]</span>\nflat <span class="token operator">=</span> <span class="token punctuation">[</span>x <span class="token keyword">for</span> sublist1 <span class="token keyword">in</span> my_lists\n        <span class="token keyword">for</span> sublist2 <span class="token keyword">in</span> sublist1\n        <span class="token keyword">for</span> x <span class="token keyword">in</span> sublist2<span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>flat<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在这种情况下，采用列表推导来实现，其实并不会比传统的 for 循环节省多少代码。下面用常见的 for 循环改写刚才的例子。这次我们通过级别不同的缩进表示每一层循环的深度，这要比刚才那种三层矩阵的列表推导更加清晰。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87120929010470680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`my_lists = [\n    [[1, 2, 3], [4, 5, 6]]\n]\nflat = []\nfor sublistl in my_lists:\n    for sublist2 in sublistl:\n        flat.extend(sublist2)`, `87120929010470680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">my_lists <span class="token operator">=</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">]</span>\n<span class="token punctuation">]</span>\nflat <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n<span class="token keyword">for</span> sublistl <span class="token keyword">in</span> my_lists<span class="token punctuation">:</span>\n    <span class="token keyword">for</span> sublist2 <span class="token keyword">in</span> sublistl<span class="token punctuation">:</span>\n        flat<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>sublist2<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>推导的时候，可以使用多个 if 条件。如果这些 if 条件出现在同一层循环内，那么它们之间默认是 and 关系，也就是必须同时成立。例如，如果要用原列表中大于 4 且是偶数的值来构建新列表，那么既可以连用两个 if，也可以只用一个 if，下面两种写法效果相同。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32848782694898926000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]\nb = [x for x in a if x > 4 if x % 2 == 0]\nc = [x for x in a if x > 4 and x % 2 == 0]`, `32848782694898926000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\nb <span class="token operator">=</span> <span class="token punctuation">[</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> a <span class="token keyword">if</span> x <span class="token operator">></span> <span class="token number">4</span> <span class="token keyword">if</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">]</span>\nc <span class="token operator">=</span> <span class="token punctuation">[</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> a <span class="token keyword">if</span> x <span class="token operator">></span> <span class="token number">4</span> <span class="token keyword">and</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>在推导时，每一层的 for 子表达式都可以带有 if 条件。例如，要根据原矩阵构建新的矩阵，把其中各元素之和大于等于 10 的那些行选出来，而且只保留其中能够被 3 整除的那些元素。这个逻辑用列表推导来写，并不需要太多的代码，但是这些代码理解起来会很困难。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40970146767457230000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`matrix = [[1, 2, 3], [4, 5, 6], [7, 8, 9]]\nfiltered = [[x for x in row if x % 3 == 0]\n            for row in matrix if sum(row) >= 10]\nprint(filtered)\n\n>>>\n[[6], [9]]`, `40970146767457230000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">matrix <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">]</span>\nfiltered <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> row <span class="token keyword">if</span> x <span class="token operator">%</span> <span class="token number">3</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">]</span>\n            <span class="token keyword">for</span> row <span class="token keyword">in</span> matrix <span class="token keyword">if</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>row<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">10</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>filtered<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>虽然这个例子是笔者专门构造出来的，但在实际中，我们确实会碰到很多类似的需求。有人可能觉得，这些需求应该通过推导来实现。然而，笔者强烈建议大家不要用刚才的写法来推导新的 list、dict 或 set，因为这样写出来的代码很难让初次阅读这段程序的人看懂。对于 dict 来说，问题尤其严重，因为必须得把键与值的推导逻辑都表达出来才行。</p>\n<p>总之，在表示推导逻辑时，最多只应该写两个子表达式（例如两个 if 条件、两个 for 循环，或者一个 if 条件与一个 for 循环）。只要实现的逻辑比这还复杂，那就应该采用普通的 if 与 for 语句来实现，并且可以考虑编写辅助函数（参见第 30 条）。</p>\n<h3 id="总结-24"><a href="#%E6%80%BB%E7%BB%93-24" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>推导的时候可以使用多层循环，每层循环可以带有多个条件。</li>\n<li>控制推导逻辑的子表达式不要超过两个，否则代码很难读懂。</li>\n</ol>\n<h2 id="第-29-条：用赋值表达式消除推导中的重复代码"><a href="#%E7%AC%AC-29-%E6%9D%A1%EF%BC%9A%E7%94%A8%E8%B5%8B%E5%80%BC%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B6%88%E9%99%A4%E6%8E%A8%E5%AF%BC%E4%B8%AD%E7%9A%84%E9%87%8D%E5%A4%8D%E4%BB%A3%E7%A0%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 29 条：用赋值表达式消除推导中的重复代码</h2>\n<p>推导 list、dict 与 set 等变体结构时，经常要在多个地方用到同一个计算结果。例如，我们要给制作紧固件的公司编写程序以管理订单。顾客下单后，我们要判断当前的库存能否满足这份订单，也就是说，要核查每种产品的数量有没有达到可以发货的最低限制（8 个为一批，至少要有一批，才能发货）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62177914683382450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`stock = {\n    \'nails\': 125,\n    \'screws\': 35,\n    \'wingnuts\': 8,\n    \'washers\': 24,\n}\norder = [\'screws\', \'wingnuts\', \'clips\']\n\n\ndef get_batches(count, size):\n    return count // size\n\n\nresult = {}\nfor name in order:\n    count = stock.get(name, 0)\n    batches = get_batches(count, 8)\n    if batches:\n        result[name] = batches\n\nprint(result)\n\n>>>\n{\'screws\': 4, \'wingnuts\': 1}`, `62177914683382450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">stock <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'nails\'</span><span class="token punctuation">:</span> <span class="token number">125</span><span class="token punctuation">,</span>\n    <span class="token string">\'screws\'</span><span class="token punctuation">:</span> <span class="token number">35</span><span class="token punctuation">,</span>\n    <span class="token string">\'wingnuts\'</span><span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span>\n    <span class="token string">\'washers\'</span><span class="token punctuation">:</span> <span class="token number">24</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\norder <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'screws\'</span><span class="token punctuation">,</span> <span class="token string">\'wingnuts\'</span><span class="token punctuation">,</span> <span class="token string">\'clips\'</span><span class="token punctuation">]</span>\n\n\n<span class="token keyword">def</span> <span class="token function">get_batches</span><span class="token punctuation">(</span>count<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> count <span class="token operator">//</span> size\n\n\nresult <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n<span class="token keyword">for</span> name <span class="token keyword">in</span> order<span class="token punctuation">:</span>\n    count <span class="token operator">=</span> stock<span class="token punctuation">.</span>get<span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\n    batches <span class="token operator">=</span> get_batches<span class="token punctuation">(</span>count<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span>\n    <span class="token keyword">if</span> batches<span class="token punctuation">:</span>\n        result<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> batches\n\n<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">{</span><span class="token string">\'screws\'</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">\'wingnuts\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这段循环逻辑，如果改用字典推导来写，会简单一些（参见第 27 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51388209818262580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`found = {name: get_batches(stock.get(name, 0), 8)\n         for name in order\n         if get_batches(stock.get(name, 0), 8)}\nprint(found)`, `51388209818262580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">found <span class="token operator">=</span> <span class="token punctuation">{</span>name<span class="token punctuation">:</span> get_batches<span class="token punctuation">(</span>stock<span class="token punctuation">.</span>get<span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span>\n         <span class="token keyword">for</span> name <span class="token keyword">in</span> order\n         <span class="token keyword">if</span> get_batches<span class="token punctuation">(</span>stock<span class="token punctuation">.</span>get<span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">}</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>found<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写虽然比刚才简短，但问题是，它把 <code class="language-text">get_batches(stock.get(name, 0), 8)</code> 写了两遍。这样会让代码看起来比较乱，而且实际上，程序也没有必要把这个结果计算两遍。另外，如果这两个地方忘了同步更新，那么程序就会出现 bug。例如，我们决定每一批不是 8 个，而是 4 个，那么需要把 <code class="language-text">get_batches</code> 的第二个参数从 8 改成 4，但是，万一我们忘了同步修改另一个地方，那么代码就可能会出问题（它会把大于等于 4 但是小于 8 的情况给漏掉）。</p>\n<p>有个简单的办法可以解决这个问题，那就是在推导的过程中使用 Python 3.8 新引入的 <code class="language-text">:=</code> 操作符进行赋值表达（参见第 10 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96345888407321480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`found = {name: batches for name in order\n         if (batches := get_batches(stock.get(name, 0), 8))}`, `96345888407321480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">found <span class="token operator">=</span> <span class="token punctuation">{</span>name<span class="token punctuation">:</span> batches <span class="token keyword">for</span> name <span class="token keyword">in</span> order\n         <span class="token keyword">if</span> <span class="token punctuation">(</span>batches <span class="token punctuation">:</span><span class="token operator">=</span> get_batches<span class="token punctuation">(</span>stock<span class="token punctuation">.</span>get<span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>这条 <code class="language-text">batches := get_batches(...)</code> 赋值表达式，能够从 stock 字典里查到对应产品一共有几批，并把这个批数放在 batches 变量里。这样的话，我们推导这个产品所对应批数时，就不用再通过 <code class="language-text">get_batches</code> 计算了，因为结果已经保存到 batches 里面了。这种写法只需要把 get 与 <code class="language-text">get_batches</code> 调用一次即可，这样能够提升效率，因为我们不需要针对 order 列表中的每件产品都多做一次 get 与 <code class="language-text">get_batches</code>。</p>\n<p>在推导过程中，描述新值的那一部分也可以出现赋值表达式。但如果在其他部分引用了定义在那一部分的变量，那么程序可能就会在运行时出错。例如，如果写成了下面这样，那么程序就必须先考虑 <code class="language-text">for name, count in stock.items() if tenth &gt; 0</code>，而这个时候，其中的 tenth 还没有得到定义。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50101553531942660000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`result = {name: (tenth := count // 10)\n          for name, count in stock.items() if tenth > 0}\nprint(result)\n\n>>>\nTraceback ...\nNameError: name \'tenth\' is not defined`, `50101553531942660000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">result <span class="token operator">=</span> <span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token punctuation">(</span>tenth <span class="token punctuation">:</span><span class="token operator">=</span> count <span class="token operator">//</span> <span class="token number">10</span><span class="token punctuation">)</span>\n          <span class="token keyword">for</span> name<span class="token punctuation">,</span> count <span class="token keyword">in</span> stock<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> tenth <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">}</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nNameError<span class="token punctuation">:</span> name <span class="token string">\'tenth\'</span> <span class="token keyword">is</span> <span class="token keyword">not</span> defined</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>为了解决这个问题，可以把赋值表达式移动到 if 条件里面，然后在描述新值的这一部分引用已经定义过的 tenth 变量。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51762508777960450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`result = {name: tenth for name, count in stock.items()\n          if (tenth := count // 10) > 0}\nprint(result)\n\n>>>\n{\'nails\': 12, \'screws\': 3, \'washers\': 2}`, `51762508777960450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">result <span class="token operator">=</span> <span class="token punctuation">{</span>name<span class="token punctuation">:</span> tenth <span class="token keyword">for</span> name<span class="token punctuation">,</span> count <span class="token keyword">in</span> stock<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span>tenth <span class="token punctuation">:</span><span class="token operator">=</span> count <span class="token operator">//</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">}</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">{</span><span class="token string">\'nails\'</span><span class="token punctuation">:</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token string">\'screws\'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">\'washers\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果推导逻辑不带条件，而表示新值的那一部分又使用了 <code class="language-text">:=</code> 操作符，那么操作符左边的变量就会泄漏到包含这条推导语句的那个作用域里（参见第 21 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3215742444396463000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`half = [(last := count // 2) for count in stock.values()]\nprint(f\'Last item of {half} is {last}\')\n\n>>>\nLast item of [62, 17, 4, 12] is 12`, `3215742444396463000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">half <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>last <span class="token punctuation">:</span><span class="token operator">=</span> count <span class="token operator">//</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">for</span> count <span class="token keyword">in</span> stock<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Last item of </span><span class="token interpolation"><span class="token punctuation">{</span>half<span class="token punctuation">}</span></span><span class="token string"> is </span><span class="token interpolation"><span class="token punctuation">{</span>last<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nLast item of <span class="token punctuation">[</span><span class="token number">62</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">]</span> <span class="token keyword">is</span> <span class="token number">12</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这与普通的 for 循环所用的那个循环变量类似</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50796782999045554000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`for count in stock.values():  # Leaks loop variable\n    pass\nprint(f\'Last item of {list(stock.values())} is {count}\')\n\n>>>\nLast item of [125, 35, 8, 24] is 24`, `50796782999045554000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">for</span> count <span class="token keyword">in</span> stock<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># Leaks loop variable</span>\n    <span class="token keyword">pass</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Last item of </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">list</span><span class="token punctuation">(</span>stock<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> is </span><span class="token interpolation"><span class="token punctuation">{</span>count<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nLast item of <span class="token punctuation">[</span><span class="token number">125</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">]</span> <span class="token keyword">is</span> <span class="token number">24</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然而，推导语句中的 for 循环所使用的循环变量，是不会像刚才那样泄漏到外面的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33958889384978952000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`half = [count // 2 for count in stock.values()]\nprint(half)\n# Works\nprint(count)  # Exception because loop variable didn\'t leak\n\n>>>\n[62, 17, 4, 12]\nTraceback ...\nNameError: name \'count\' is not defined`, `33958889384978952000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">half <span class="token operator">=</span> <span class="token punctuation">[</span>count <span class="token operator">//</span> <span class="token number">2</span> <span class="token keyword">for</span> count <span class="token keyword">in</span> stock<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>half<span class="token punctuation">)</span>\n<span class="token comment"># Works</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span>  <span class="token comment"># Exception because loop variable didn\'t leak</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">62</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">]</span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nNameError<span class="token punctuation">:</span> name <span class="token string">\'count\'</span> <span class="token keyword">is</span> <span class="token keyword">not</span> defined</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>最好不要泄漏循环变量，所以，建议赋值表达式只出现在推导逻辑的条件之中。</p>\n<p>赋值表达式不仅可以用在推导过程中，而且可以用来编写生成器表达式（generator expression，参见第 32 条）。下面这种写法创建的是迭代器，而不是字典实例，该迭代器每次会给出一对数值，其中第一个元素为产品的名字，第二个元素为这种产品的库存。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33892339218937995000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`found = ((name, batches) for name in order\n         if (batches := get_batches(stock.get(name, 0), 8)))\nprint(next(found))\nprint(next(found))\n\n>>>\n(\'screws\', 4)\n(\'wingnuts\', 1)`, `33892339218937995000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">found <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> batches<span class="token punctuation">)</span> <span class="token keyword">for</span> name <span class="token keyword">in</span> order\n         <span class="token keyword">if</span> <span class="token punctuation">(</span>batches <span class="token punctuation">:</span><span class="token operator">=</span> get_batches<span class="token punctuation">(</span>stock<span class="token punctuation">.</span>get<span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">next</span><span class="token punctuation">(</span>found<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">next</span><span class="token punctuation">(</span>found<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">(</span><span class="token string">\'screws\'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>\n<span class="token punctuation">(</span><span class="token string">\'wingnuts\'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="总结-25"><a href="#%E6%80%BB%E7%BB%93-25" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>编写推导式与生成器表达式时，可以在描述条件的那一部分通过赋值表达式定义变量，并在其他部分复用该变量，可使程序简单易读。</li>\n<li>对于推导式与生成器表达式来说，虽然赋值表达式也可以出现在描述条件的那一部分之外，但最好别这么写。</li>\n</ol>\n<h2 id="第-30-条：不要让函数直接返回列表，应该让它逐个生成列表里的值"><a href="#%E7%AC%AC-30-%E6%9D%A1%EF%BC%9A%E4%B8%8D%E8%A6%81%E8%AE%A9%E5%87%BD%E6%95%B0%E7%9B%B4%E6%8E%A5%E8%BF%94%E5%9B%9E%E5%88%97%E8%A1%A8%EF%BC%8C%E5%BA%94%E8%AF%A5%E8%AE%A9%E5%AE%83%E9%80%90%E4%B8%AA%E7%94%9F%E6%88%90%E5%88%97%E8%A1%A8%E9%87%8C%E7%9A%84%E5%80%BC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 30 条：不要让函数直接返回列表，应该让它逐个生成列表里的值</h2>\n<p>如果函数要返回的是个包含许多结果的序列，那么最简单的办法就是把这些结果放到列表中。例如，我们要返回字符串里每个单词的首字母所对应的下标。下面这种写法，会把每次遇到的新单词所在的位置追加（append）到存放结果的 result 列表中，在函数末尾返回这份列表。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42017416839849100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def index_words(text):\n    result = []\n    if text:\n        result.append(0)\n    for index, letter in enumerate(text):\n        if letter == \' \':\n            result.append(index + 1)\n    return result`, `42017416839849100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">index_words</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n    <span class="token keyword">if</span> text<span class="token punctuation">:</span>\n        result<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>\n    <span class="token keyword">for</span> index<span class="token punctuation">,</span> letter <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> letter <span class="token operator">==</span> <span class="token string">\' \'</span><span class="token punctuation">:</span>\n            result<span class="token punctuation">.</span>append<span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>\n    <span class="token keyword">return</span> result</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们把一段范例文本传给这个函数，它可以返回正确的结果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25522843722887954000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`address = \'Four score and seven years ago...\'\nresult = index_words(address)\nprint(result)\n\n>>>\n[0, 5, 11, 15, 21, 27]`, `25522843722887954000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">address <span class="token operator">=</span> <span class="token string">\'Four score and seven years ago...\'</span>\nresult <span class="token operator">=</span> index_words<span class="token punctuation">(</span>address<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token number">27</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>index_words 函数有两个缺点。</p>\n<ol>\n<li>\n<p>它的代码看起来有点杂乱。每找到一个新单词，它都要调用 append 方法，而调用这个方法时，必须写上 result.append 这样一串字符，这就把我们想要强调的重点，也就是这个新单词在字符串中的位置（index + 1）淡化了。另外，函数还必须专门用一行代码创建这个保存结果的 result 列表，并且要用一条 return 语句把它返回给调用者。这样算下来，虽然函数的主体部分大约有 130 个字符（非空白的），但真正重要的只有 75 个左右。</p>\n<p>这种函数改用生成器（generator）来实现会比较好。生成器由包含 yield 表达式的函数创建。下面就定义一个生成器函数，实现与刚才那个函数相同的效果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27304107794099864000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def index_words_iter(text):\n  if text:\n     yield 0\n  for index, letter in enumerate(text):\n     if letter == \' \':\n           yield index + 1\n\naddress = \'Four score and seven years ago...\'\nresult = index_words_iter(address)\nprint(list(result))`, `27304107794099864000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">index_words_iter</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  <span class="token keyword">if</span> text<span class="token punctuation">:</span>\n     <span class="token keyword">yield</span> <span class="token number">0</span>\n  <span class="token keyword">for</span> index<span class="token punctuation">,</span> letter <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">:</span>\n     <span class="token keyword">if</span> letter <span class="token operator">==</span> <span class="token string">\' \'</span><span class="token punctuation">:</span>\n           <span class="token keyword">yield</span> index <span class="token operator">+</span> <span class="token number">1</span>\n\naddress <span class="token operator">=</span> <span class="token string">\'Four score and seven years ago...\'</span>\nresult <span class="token operator">=</span> index_words_iter<span class="token punctuation">(</span>address<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>它必须把所有的结果都保存到列表中，然后才能返回列表。如果输入的数据特别多，那么程序可能会因为耗尽内存而崩溃。</p>\n<p>相反，用生成器函数来实现，就不会有这个问题了。它可以接受长度任意的输入信息，并把内存消耗量压得比较低。例如下面这个生成器，只需要把当前这行文字从文件中读进来就行，每次推进的时候，它都只处理一个单词，直到把当前这行文字处理完毕，才读入下一行文字。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71193011834831420000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\ndef index_file(handle):\n  offset = 0\n  for line in handle:\n     if line:\n           yield offset\n     for letter in line:\n           offset += 1\n           if letter == \' \':\n              yield offset\n\nwith open(\'address.txt\', \'r\') as f:\n  it = index_file(f)\n  results = itertools.islice(it, 0, 10)\n  print(list(results))`, `71193011834831420000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\n<span class="token keyword">def</span> <span class="token function">index_file</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  offset <span class="token operator">=</span> <span class="token number">0</span>\n  <span class="token keyword">for</span> line <span class="token keyword">in</span> handle<span class="token punctuation">:</span>\n     <span class="token keyword">if</span> line<span class="token punctuation">:</span>\n           <span class="token keyword">yield</span> offset\n     <span class="token keyword">for</span> letter <span class="token keyword">in</span> line<span class="token punctuation">:</span>\n           offset <span class="token operator">+=</span> <span class="token number">1</span>\n           <span class="token keyword">if</span> letter <span class="token operator">==</span> <span class="token string">\' \'</span><span class="token punctuation">:</span>\n              <span class="token keyword">yield</span> offset\n\n<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'address.txt\'</span><span class="token punctuation">,</span> <span class="token string">\'r\'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>\n  it <span class="token operator">=</span> index_file<span class="token punctuation">(</span>f<span class="token punctuation">)</span>\n  results <span class="token operator">=</span> itertools<span class="token punctuation">.</span>islice<span class="token punctuation">(</span>it<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>\n  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>该函数运行时所耗的内存，取决于文件中最长的那一行所包含的字符数。把刚才那份输入数据存放到 address.txt 文件，让这个函数去读取并用它所返回的生成器构建一份列表，可以看到跟原来相同的结果（islice 函数的详细用法，参见第 36 条）。</p>\n<p>定义这种生成器函数的时候，只有一个地方需要注意，就是调用者无法重复使用函数所返回的迭代器，因为这些迭代器是有状态的（参见第 31 条）。</p>\n</li>\n</ol>\n<h3 id="总结-26"><a href="#%E6%80%BB%E7%BB%93-26" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>用生成器来实现比让函数把结果收集合到列表里再返回，要更加清晰一些。</li>\n<li>生成器函数所返回的迭代器可以产生一系列值，每次产生的那个值都是由函数体的下一条 yield 表达式所决定的。</li>\n<li>不管输入的数据量有多大，生成器函数每次都只需要根据其中的一小部分来计算当前这次的输出值。它不用把整个输入值全都读取进来，也不用一次就把所有的输出值全都算好。</li>\n</ol>\n<h2 id="第-31-条：谨慎地迭代函数所收到的参数"><a href="#%E7%AC%AC-31-%E6%9D%A1%EF%BC%9A%E8%B0%A8%E6%85%8E%E5%9C%B0%E8%BF%AD%E4%BB%A3%E5%87%BD%E6%95%B0%E6%89%80%E6%94%B6%E5%88%B0%E7%9A%84%E5%8F%82%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 31 条：谨慎地迭代函数所收到的参数</h2>\n<p>如果函数接受的参数是个包含许多对象的列表，那么这份列表有可能要迭代多次。例如，我们要分析美国得克萨斯州的游客数量。原始数据保存在一份列表中，其中的每个元素表示每年有多少游客到这个城市旅游（单位是百万）。我们现在要统计每个城市的游客数占游客总数的百分比。</p>\n<p>为了求出这份数据，先把列表里的所有元素加起来求出游客总数，然后，分别用每个城市的游客数除以游客总数计算出该城市在总数据中所占的百分比。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91075592712565340000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def normalize(numbers):\n    total = sum(numbers)\n    result = []\n    for value in numbers:\n        percent = 100 * value / total\n        result.append(percent)\n    return result`, `91075592712565340000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">normalize</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    total <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n    result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n    <span class="token keyword">for</span> value <span class="token keyword">in</span> numbers<span class="token punctuation">:</span>\n        percent <span class="token operator">=</span> <span class="token number">100</span> <span class="token operator">*</span> value <span class="token operator">/</span> total\n        result<span class="token punctuation">.</span>append<span class="token punctuation">(</span>percent<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> result</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>把一份范例数据放到列表中传给这个函数，可以得到正确的结果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79362304051409260000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def normalize(numbers):\n    total = sum(numbers)\n    result = []\n    for value in numbers:\n        percent = 100 * value / total\n        result.append(percent)\n    return result\n\n\nvisits = [15, 35, 80]\npercentages = normalize(visits)\nprint(percentages)\nassert sum(percentages) == 100.0\n\n>>>\n[11.538461538461538, 26.923076923076923, 61.53846153846154]`, `79362304051409260000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">normalize</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    total <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n    result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n    <span class="token keyword">for</span> value <span class="token keyword">in</span> numbers<span class="token punctuation">:</span>\n        percent <span class="token operator">=</span> <span class="token number">100</span> <span class="token operator">*</span> value <span class="token operator">/</span> total\n        result<span class="token punctuation">.</span>append<span class="token punctuation">(</span>percent<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> result\n\n\nvisits <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">]</span>\npercentages <span class="token operator">=</span> normalize<span class="token punctuation">(</span>visits<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>percentages<span class="token punctuation">)</span>\n<span class="token keyword">assert</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>percentages<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">100.0</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">11.538461538461538</span><span class="token punctuation">,</span> <span class="token number">26.923076923076923</span><span class="token punctuation">,</span> <span class="token number">61.53846153846154</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>为了应对规模更大的数据，我们现在需要让程序能够从文件中读取信息，并假设得克萨斯州所有城市的游客数都放在这份文件中。笔者决定用生成器实现，因为这样做可以让我们把同样的功能套用在其他数据上面，例如分析全世界（而不仅仅是得克萨斯一州）各城市的游客数。那些场合的数据量与内存用量可能会比现在大得多（参见第 30 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59986003976547205000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def read_visits(data_path):\n    with open(data_path)as f:\n        for line in f:\n            yield int(line)`, `59986003976547205000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">read_visits</span><span class="token punctuation">(</span>data_path<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>data_path<span class="token punctuation">)</span><span class="token keyword">as</span> f<span class="token punctuation">:</span>\n        <span class="token keyword">for</span> line <span class="token keyword">in</span> f<span class="token punctuation">:</span>\n            <span class="token keyword">yield</span> <span class="token builtin">int</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>奇怪的是，对 <code class="language-text">read_visits</code> 所返回的迭代器调用 normalize 函数后，并没有得到结果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47109205006046940000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`it = read_visits(\'my_numbers.txt\')\npercentages = normalize(it)\nprint(percentages)\n\n>>>\n[]`, `47109205006046940000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">it <span class="token operator">=</span> read_visits<span class="token punctuation">(</span><span class="token string">\'my_numbers.txt\'</span><span class="token punctuation">)</span>\npercentages <span class="token operator">=</span> normalize<span class="token punctuation">(</span>it<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>percentages<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>出现这种状况的原因在于，迭代器只能产生一次结果。假如迭代器或生成器已经抛出过 StopIteration 异常，继续用它来构造列表或是像 normalize 那样对它做 for 循环，那它不会给出任何结果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45166473753037595000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`it = read_visits(\'my_numbers.txt\')\nprint(list(it))\nprint(list(it))  # Already exhausted\n\n>>>\n[15, 35, 80]\n[]`, `45166473753037595000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">it <span class="token operator">=</span> read_visits<span class="token punctuation">(</span><span class="token string">\'my_numbers.txt\'</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># Already exhausted</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>还有个因素也很令人迷惑，那就是：在已经把数据耗完的迭代器上面继续迭代，程序居然不报错。for 循环、list 构造器以及 Python 标准库的其他许多函数，都认为迭代器在正常的操作过程中抛出 StopIteration 异常是很自然的。它们没办法区分，这个迭代器是本身就没有数据可以提供，还是虽然有数据，但现在已经耗尽了。</p>\n<p>为了解决这个问题，我们可以把外界传入的迭代器特意遍历一整轮，从而将其中的内容复制到一份列表里。这样的话，以后就可以用这份列表来处理数据了，那时想迭代多少遍都可以。下面的函数与原来的 normalize 函数功能相同，但是它会把收到的那个 numbers 迭代器所能提供的数据明确地复制到 <code class="language-text">numbers_copy</code> 列表里。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42989914808044750000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def normalize_copy(numbers):\n    numbers_copy = list(numbers)  # Copy the iterator\n    total = sum(numbers_copy)\n    result = []\n    for value in numbers_copy:\n        percent = 100 * value / total\n        result.append(percent)\n    return result`, `42989914808044750000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">normalize_copy</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    numbers_copy <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>  <span class="token comment"># Copy the iterator</span>\n    total <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>numbers_copy<span class="token punctuation">)</span>\n    result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n    <span class="token keyword">for</span> value <span class="token keyword">in</span> numbers_copy<span class="token punctuation">:</span>\n        percent <span class="token operator">=</span> <span class="token number">100</span> <span class="token operator">*</span> value <span class="token operator">/</span> total\n        result<span class="token punctuation">.</span>append<span class="token punctuation">(</span>percent<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> result</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在的这个函数就可以正确处理 <code class="language-text">read_visits</code> 生成器函数所返回的 it 值了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23303368651379495000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`it = read_visits(\'my_numbers.txt\')\npercentages = normalize_copy(it)\nprint(percentages)\nassert sum(percentages) == 100.0`, `23303368651379495000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">it <span class="token operator">=</span> read_visits<span class="token punctuation">(</span><span class="token string">\'my_numbers.txt\'</span><span class="token punctuation">)</span>\npercentages <span class="token operator">=</span> normalize_copy<span class="token punctuation">(</span>it<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>percentages<span class="token punctuation">)</span>\n<span class="token keyword">assert</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>percentages<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">100.0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个办法虽然能解决问题，但如果输入给它的迭代器所要提供的数据量相当庞大，那么有可能导致程序在复制迭代器时，因耗尽内存而崩溃。所以，把这个方案用在大规模的数据集合上面，会抵消掉 <code class="language-text">read_visits</code> 的好处。编写那样一个函数，就是不想让程序把整套数据全都读取进来，而是可以一条一条地处理。为了应对大规模的数据，其中一个变通方案是让 normalize 函数接受另外一个函数（也就是下面的 <code class="language-text">get_iter</code>），使它每次要使用迭代器时，都去向那个函数索要。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33052808298050820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def normalize_func(get_iter):\n    total = sum(get_iter())  # New iterator\n    result = []\n    for value in get_iter():  # New iterator\n        percent = 100 * value / total\n        result.append(percent)\n    return result`, `33052808298050820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">normalize_func</span><span class="token punctuation">(</span>get_iter<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    total <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>get_iter<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># New iterator</span>\n    result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n    <span class="token keyword">for</span> value <span class="token keyword">in</span> get_iter<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># New iterator</span>\n        percent <span class="token operator">=</span> <span class="token number">100</span> <span class="token operator">*</span> value <span class="token operator">/</span> total\n        result<span class="token punctuation">.</span>append<span class="token punctuation">(</span>percent<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> result</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用 <code class="language-text">normalize_func</code> 函数时，需要传入一条 <code class="language-text">lambda</code> 表达式，让这个表达式去调用 <code class="language-text">read_visits</code> 生成器函数。这样 <code class="language-text">normalize_func</code> 每次向 <code class="language-text">get_iter</code> 索要迭代器时，程序都会给出一个新的迭代器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92071655977650440000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`path = \'my_numbers.txt\'\npercentages = normalize_func(lambda: read_visits(path))\nprint(percentages)\nassert sum(percentages) == 100.0`, `92071655977650440000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">path <span class="token operator">=</span> <span class="token string">\'my_numbers.txt\'</span>\npercentages <span class="token operator">=</span> normalize_func<span class="token punctuation">(</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> read_visits<span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>percentages<span class="token punctuation">)</span>\n<span class="token keyword">assert</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>percentages<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">100.0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样做虽然可行，但传入这么一个 lambda 表达式显得有点儿生硬。要想用更好的办法解决这个问题，可以新建一种容器类，让它实现迭代器协议（iterator protocol）。</p>\n<p>Python 的 for 循环及相关的表达式，正是按照迭代器协议来遍历容器内容的。Python 执行 <code class="language-text">for x in foo</code> 这样的语句时，实际上会调用 iter(foo)，也就是把 foo 传给内置的 iter 函数。这个函数会触发名为 <code class="language-text">foo.__iter__</code> 的特殊方法，该方法必须返回迭代器对象（这个迭代器对象本身要实现 <code class="language-text">__next__</code> 特殊方法）。最后，Python 会用迭代器对象反复调用内置的 next 函数，直到数据耗尽为止（如果抛出 StopIteration 异常，就表示数据已经迭代完了）。</p>\n<p>这个过程听上去比较复杂，但总结起来，其实只需要让你的类在实现 <code class="language-text">__iter__</code> 方法时，按照生成器的方式来写就好。下面定义这样一种可迭代的容器类，用来读取文件中的游客数据。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14290479680113277000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class ReadVisits:\n    def __init__(self, data_path):\n        self.data_path = data_path\n\n    def __iter__(self):\n        with open(self.data_path) as f:\n            for line in f:\n                yield int(line)`, `14290479680113277000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">ReadVisits</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data_path<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>data_path <span class="token operator">=</span> data_path\n\n    <span class="token keyword">def</span> <span class="token function">__iter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_path<span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>\n            <span class="token keyword">for</span> line <span class="token keyword">in</span> f<span class="token punctuation">:</span>\n                <span class="token keyword">yield</span> <span class="token builtin">int</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们只需要把新的容器传给最早的那个 normalize 函数运行即可，函数本身的代码不需要修改。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28529981823852868000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def normalize(numbers):\n    total = sum(numbers)\n    result = []\n    for value in numbers:\n        percent = 100 * value / total\n        result.append(percent)\n    return result\n\n\nclass ReadVisits:\n    def __init__(self, data_path):\n        self.data_path = data_path\n\n    def __iter__(self):\n        with open(self.data_path) as f:\n            for line in f:\n                yield int(line)\n\n\npath = \'my_numbers.txt\'\nvisits = ReadVisits(path)\npercentages = normalize(visits)\nprint(percentages)\nassert sum(percentages) == 100.0`, `28529981823852868000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">normalize</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    total <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n    result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n    <span class="token keyword">for</span> value <span class="token keyword">in</span> numbers<span class="token punctuation">:</span>\n        percent <span class="token operator">=</span> <span class="token number">100</span> <span class="token operator">*</span> value <span class="token operator">/</span> total\n        result<span class="token punctuation">.</span>append<span class="token punctuation">(</span>percent<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> result\n\n\n<span class="token keyword">class</span> <span class="token class-name">ReadVisits</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data_path<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>data_path <span class="token operator">=</span> data_path\n\n    <span class="token keyword">def</span> <span class="token function">__iter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_path<span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>\n            <span class="token keyword">for</span> line <span class="token keyword">in</span> f<span class="token punctuation">:</span>\n                <span class="token keyword">yield</span> <span class="token builtin">int</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span>\n\n\npath <span class="token operator">=</span> <span class="token string">\'my_numbers.txt\'</span>\nvisits <span class="token operator">=</span> ReadVisits<span class="token punctuation">(</span>path<span class="token punctuation">)</span>\npercentages <span class="token operator">=</span> normalize<span class="token punctuation">(</span>visits<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>percentages<span class="token punctuation">)</span>\n<span class="token keyword">assert</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>percentages<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">100.0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样做为什么可行呢？因为 normalize 函数里面的 sum 会触发 <code class="language-text">ReadVisits.__iter__</code>，让系统分配一个新的迭代器对象给它。接下来，normalize 通过 for 循环计算每项数据占总值的百分比时，又会触发 <code class="language-text">__iter__</code>，于是系统会分配另一个迭代器对象。这些迭代器各自推进，其中一个迭代器把数据耗尽，并不会影响其他迭代器。所以，在每一个迭代器上面遍历，都可以分别看到一套完整的数据。这种方案的唯一缺点，就是多次读取输入数据。</p>\n<p>明白了 ReadVisits 这种容器的工作原理后，我们就可以在编写函数和方法时先确认一下，收到的应该是像 ReadVisits 这样的容器，而不是普通的迭代器。按照协议，如果将普通的迭代器传给内置的 iter 函数，那么函数会把迭代器本身返回给调用者。反之，如果传来的是容器类型，那么 iter 函数就会返回一个新的迭代器对象。我们可以借助这条规律，判断输入值是不是这种容器。如果不是，就抛出 TypeError 异常，因为我们没办法在那样的值上面重复遍历。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73776979554025050000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def normalize_defensive(numbers):\n    if iter(numbers) is numbers:  # An iterator -- bad!\n        raise TypeError(\'Must supply a container\')\n    total = sum(numbers)\n    result = []\n    for value in numbers:\n        percent = 100 * value / total\n        result.append(percent)\n    return result`, `73776979554025050000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">normalize_defensive</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> <span class="token builtin">iter</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span> <span class="token keyword">is</span> numbers<span class="token punctuation">:</span>  <span class="token comment"># An iterator -- bad!</span>\n        <span class="token keyword">raise</span> TypeError<span class="token punctuation">(</span><span class="token string">\'Must supply a container\'</span><span class="token punctuation">)</span>\n    total <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n    result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n    <span class="token keyword">for</span> value <span class="token keyword">in</span> numbers<span class="token punctuation">:</span>\n        percent <span class="token operator">=</span> <span class="token number">100</span> <span class="token operator">*</span> value <span class="token operator">/</span> total\n        result<span class="token punctuation">.</span>append<span class="token punctuation">(</span>percent<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> result</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>还有一种写法也可以检测出这样的问题。collections.abc 内置模块里定义了名为 Iterator 的类，它用在 isinstance 函数中，可以判断自己收到的参数是不是这种实例。如果是，就抛出异常（参见第 43 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16536756997311252000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def normalize_defensive(numbers):\n    if isinstance(numbers, Iterator):  # Another way to check\n        raise TypeError(\'Must supply a container\')\n    total = sum(numbers)\n    result = []\n    for value in numbers:\n        percent = 100 * value / total\n        result.append(percent)\n    return result`, `16536756997311252000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">normalize_defensive</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>numbers<span class="token punctuation">,</span> Iterator<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># Another way to check</span>\n        <span class="token keyword">raise</span> TypeError<span class="token punctuation">(</span><span class="token string">\'Must supply a container\'</span><span class="token punctuation">)</span>\n    total <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n    result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n    <span class="token keyword">for</span> value <span class="token keyword">in</span> numbers<span class="token punctuation">:</span>\n        percent <span class="token operator">=</span> <span class="token number">100</span> <span class="token operator">*</span> value <span class="token operator">/</span> total\n        result<span class="token punctuation">.</span>append<span class="token punctuation">(</span>percent<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> result</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种自定义容器的方案，最适合于既不想像 <code class="language-text">normalize_copy</code> 函数一样，把迭代器提供的这套数据全部复制一份，同时又要多次遍历这套数据的情况。该方案不仅支持自定义容器，还支持系统自带的列表类型，因为这些全都属于遵循迭代器协议的可迭代容器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87432568649725330000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`visits = [15, 35, 80]\npercentages = normalize_defensive(visits)\nassert sum(percentages) == 100.0\n\npath = \'my_numbers.txt\'\nvisits = ReadVisits(path)\npercentages = normalize_defensive(visits)\nassert sum(percentages) == 100.0`, `87432568649725330000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">visits <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">]</span>\npercentages <span class="token operator">=</span> normalize_defensive<span class="token punctuation">(</span>visits<span class="token punctuation">)</span>\n<span class="token keyword">assert</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>percentages<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">100.0</span>\n\npath <span class="token operator">=</span> <span class="token string">\'my_numbers.txt\'</span>\nvisits <span class="token operator">=</span> ReadVisits<span class="token punctuation">(</span>path<span class="token punctuation">)</span>\npercentages <span class="token operator">=</span> normalize_defensive<span class="token punctuation">(</span>visits<span class="token punctuation">)</span>\n<span class="token keyword">assert</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>percentages<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">100.0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果输入的是普通迭代器而不是容器，那么 <code class="language-text">normalize_defensive</code> 就会抛出异常。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79257680826754350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`visits = [15, 35, 80]\nit = iter(visits)\nnormalize_defensive(it)\n\n>>>\nTraceback ...\nTypeError: Must supply a container`, `79257680826754350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">visits <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">]</span>\nit <span class="token operator">=</span> <span class="token builtin">iter</span><span class="token punctuation">(</span>visits<span class="token punctuation">)</span>\nnormalize_defensive<span class="token punctuation">(</span>it<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> Must supply a container</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种思路也适用于异步的迭代器（示例参见第 61 条）。</p>\n<h3 id="总结-27"><a href="#%E6%80%BB%E7%BB%93-27" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>函数和方法如果要把收到的参数遍历很多遍，那就必须特别小心。因为如果这些参数为迭代器，那么程序可能得不到预期的值，从而出现奇怪的效果。</li>\n<li>Python 的迭代器协议确定了容器与迭代器应该怎样跟内置的 iter 及 next 函数、for 循环及相关的表达式交互。</li>\n<li>要想让自定义的容器类型可以迭代，只需要把 <code class="language-text">__iter__</code> 方法实现为生成器即可。</li>\n<li>可以把值传给 iter 函数，检测它返回的是不是那个值本身。如果是，就说明这是个普通的迭代器，而不是一个可以迭代的容器。另外，也可以用内置的 isinstance 函数判断该值是不是 collections.abc.Iterator 类的实例。</li>\n</ol>\n<h2 id="第-32-条：考虑用生成器表达式改写数据量较大的列表推导"><a href="#%E7%AC%AC-32-%E6%9D%A1%EF%BC%9A%E8%80%83%E8%99%91%E7%94%A8%E7%94%9F%E6%88%90%E5%99%A8%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%94%B9%E5%86%99%E6%95%B0%E6%8D%AE%E9%87%8F%E8%BE%83%E5%A4%A7%E7%9A%84%E5%88%97%E8%A1%A8%E6%8E%A8%E5%AF%BC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 32 条：考虑用生成器表达式改写数据量较大的列表推导</h2>\n<p>列表推导可以根据输入序列中的每个元素创建一个包含派生元素的新列表（参见第 27 条）。如果输入的数据量比较小，那么这样做没问题，但如果数据量很大，那么程序就有可能因为内存耗尽而崩溃。</p>\n<p>例如，我们要读取一份文件并返回每行的字符数。假如采用列表推导来实现，那需要把文件中的每行文本都载入内存，并统计长度。对于庞大的文件，或者像 network socket 这样无休止的输入来说，这么写恐怕有问题。下面就是采用列表推导写的代码，它只能处理输入数据量比较少的情况。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61022599495994065000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`value = [len(x) for x in open(\'my_file.txt\')]\nprint(value)`, `61022599495994065000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">value <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'my_file.txt\'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>要想处理大规模的数据，可以使用生成器表达式（generator expression）来做，它扩展了列表推导式与生成器机制。程序在对生成器表达式求值时，并不会让它把包含输出结果的那个序列立刻构建出来，而是会把它当成一个迭代器，该迭代器每次可以根据表达式中的逻辑给出一项结果。</p>\n<p>生成器表达式的写法，与列表推导式语法类似，但它是写在一对圆括号内，而不是方括号里面。下面这种写法的效果与刚才一样，但是程序并不会立刻给出全部结果，而是先将生成器表达式表示成一个迭代器返回。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99136469438443540000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`it = (len(x) for x in open(\'my_file.txt\'))\nprint(it)\n\n>>>\n<generator object <genexpr> at 0x7f13063e03c0>`, `99136469438443540000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">it <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'my_file.txt\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token operator">&lt;</span>generator <span class="token builtin">object</span> <span class="token operator">&lt;</span>genexpr<span class="token operator">></span> at <span class="token number">0x7f13063e03c0</span><span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>返回的迭代器每次可以推进一步，这时它会根据生成表达式的逻辑计算出下一项输出结果（这项结果可以通过内置的 next 函数取得）。需要多少项结果，就把迭代器推进多少次，这种采用生成器表达式来实现的写法不会消耗太多内存。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75939221495494750000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`print(next(it))\nprint(next(it))`, `75939221495494750000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">next</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">next</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>生成器表达式还有个强大的特性，就是可以组合起来。例如，可以用刚才那条生成器表达式所形成的 it 迭代器作为输入，编写一条新的生成器表达式。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6259140713847034000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`it = (len(x) for x in open(\'my_file.txt\'))\nroots = ((x, x ** 0.5) for x in it)\nprint(roots)`, `6259140713847034000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">it <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'my_file.txt\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\nroots <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> x <span class="token operator">**</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> it<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>roots<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>这条表达式所形成的 roots 迭代器每次推进时，会引发连锁反应：它也推进内部迭代器 it 以判断当前是否还能在 it 上面继续迭代，如果可以，就把 it 所返回的值代入 <code class="language-text">(x, x ** 0.5)</code> 里面求出结果。这种写法使用的内存同样不会太多。</p>\n<p>多个生成器嵌套而成的代码，执行起来还是相当快的。所以，如果要对数据量很大的输入流做一系列处理，那么生成器表达式应该是个很好的选择。唯一需要注意的是，生成器表达式返回的迭代器是有状态的，跑完一整轮之后，就不能继续使用了（参见第 31 条）。</p>\n<h3 id="总结-28"><a href="#%E6%80%BB%E7%BB%93-28" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>通过列表推导来处理大量的输入数据，可能会占用许多内存。</li>\n<li>改用生成器表达式来做，可以避免内存使用量过大的问题，因为这种表达式所形成的迭代器每次只会计算一项结果。</li>\n<li>生成器表达式所形成的迭代器可以当成 for 语句的子表达式出现在另一个生成器表达式里。</li>\n<li>把生成器表达式组合起来使用，能够写出执行速度快且占用内存少的代码。</li>\n</ol>\n<h2 id="第-33-条：通过-yield-from-把多个生成器连起来用"><a href="#%E7%AC%AC-33-%E6%9D%A1%EF%BC%9A%E9%80%9A%E8%BF%87-yield-from-%E6%8A%8A%E5%A4%9A%E4%B8%AA%E7%94%9F%E6%88%90%E5%99%A8%E8%BF%9E%E8%B5%B7%E6%9D%A5%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 33 条：通过 yield from 把多个生成器连起来用</h2>\n<p>生成器有很多好处（参见第 30 条），而且能够解决许多常见的问题（参见第 31 条）。生成器的用途特别广，所以许多程序都会频繁使用它们，而且是一个连着一个地用。</p>\n<p>例如，我们要编写一个图形程序，让它在屏幕上面移动图像，从而形成动画效果。假设要实现这样一段动画：图片先快速移动一段时间，然后暂停，接下来慢速移动一段时间。为了把移动与暂停表示出来，笔者定义了下面两个生成器函数，让它们分别给出图片在当前时间段内应该保持的速度。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3744253449139156500"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def move(period, speed):\n    for _ in range(period):\n        yield speed\n\n\ndef pause(delay):\n    for _ in range(delay):\n        yield 0`, `3744253449139156500`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">move</span><span class="token punctuation">(</span>period<span class="token punctuation">,</span> speed<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">yield</span> speed\n\n\n<span class="token keyword">def</span> <span class="token function">pause</span><span class="token punctuation">(</span>delay<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>delay<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">yield</span> <span class="token number">0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>为了把完整的动画制作出来，需要将 move 与 pause 连起来使用，从而算出这张图片当前的位置与上一个位置之差。下面的函数用三个 for 循环来表示动画的三个环节，在每一个环节里，它都通过 yield 把图片当前的位置与上一次的位置之差 delta 返回给调用者。根据 animate 函数返回的 delta 值，即可把整段动画做好。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65399686345066960000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def animate():\n    for delta in move(4, 5.0):\n        yield delta\n    for delta in pause(3):\n        yield delta\n    for delta in move(2, 3.0):\n        yield delta`, `65399686345066960000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">animate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> delta <span class="token keyword">in</span> move<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5.0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">yield</span> delta\n    <span class="token keyword">for</span> delta <span class="token keyword">in</span> pause<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">yield</span> delta\n    <span class="token keyword">for</span> delta <span class="token keyword">in</span> move<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">yield</span> delta</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>接下来，我们就根据 animate 生成器所给出的 delta 值，把整个动画效果渲染出来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98002463320660870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def render(delta):\n    print(f\'Delta: {delta:.1f}\')\n    # Move the images onscreen\n\n\ndef run(func):\n    for delta in func():\n        render(delta)\n\n\nrun(animate)\n\n>>>\nDelta: 5.0\nDelta: 5.0\nDelta: 5.0\nDelta: 5.0\nDelta: 0.0\nDelta: 0.0\nDelta: 0.0\nDelta: 3.0\nDelta: 3.0`, `98002463320660870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">render</span><span class="token punctuation">(</span>delta<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Delta: </span><span class="token interpolation"><span class="token punctuation">{</span>delta<span class="token punctuation">:</span><span class="token format-spec">.1f</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n    <span class="token comment"># Move the images onscreen</span>\n\n\n<span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> delta <span class="token keyword">in</span> func<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        render<span class="token punctuation">(</span>delta<span class="token punctuation">)</span>\n\n\nrun<span class="token punctuation">(</span>animate<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nDelta<span class="token punctuation">:</span> <span class="token number">5.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">5.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">5.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">5.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">0.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">0.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">0.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">3.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">3.0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种写法的问题在于，animate 函数里有很多重复的地方。比如它反复使用 for 结构来操纵生成器，而且每个 for 结构都使用相同的 yield 表达式，这样看上去很啰唆。这个例子仅仅连用了三个生成器，就让代码变得如此烦琐，若是动画里面有十几或几十个环节，那么代码读起来会更加困难。</p>\n<p>为了解决这个问题，我们可以改用 yield from 形式的表达式来实现。这种形式，会先从嵌套进去的小生成器里面取值，如果该生成器已经用完，那么程序的控制流程就会回到 yield from 所在的这个函数之中，然后它有可能进入下一套 yield from 逻辑。下面这段代码，用 yield from 语句重新实现了 animate 函数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51042901751180000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def animate_composed():\n    yield from move(4, 5.0)\n    yield from pause(3)\n    yield from move(2, 3.0)\n\nrun(animate_composed)\n\n>>>\nDelta: 5.0\nDelta: 5.0\nDelta: 5.0\nDelta: 5.0\nDelta: 0.0\nDelta: 0.0\nDelta: 0.0\nDelta: 3.0\nDelta: 3.0`, `51042901751180000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">animate_composed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">yield</span> <span class="token keyword">from</span> move<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5.0</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token keyword">from</span> pause<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token keyword">from</span> move<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token punctuation">)</span>\n\nrun<span class="token punctuation">(</span>animate_composed<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nDelta<span class="token punctuation">:</span> <span class="token number">5.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">5.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">5.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">5.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">0.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">0.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">0.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">3.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">3.0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>它的运行结果与刚才一样，但是代码看上去更清晰、更直观了。Python 解释器看到 yield from 形式的表达式后，会自己想办法实现与带有普通 yield 语句的 for 循环相同的效果，而且这种实现方式要更快。下面采用内置的 timeit 模块编写并运行一个 micro-benchmark 试试。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90403230504532870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import timeit\n\n\ndef child():\n    for i in range(1_000_000):\n        yield i\n\n\ndef slow():\n    for i in child():\n        yield i\n\n\ndef fast():\n    yield from child()\n\n\nbaseline = timeit.timeit(\n    stmt=\'for _ in slow(): pass\',\n    globals=globals(),\n    number=50)\nprint(f\'Manual nesting {baseline:.2f}s\')\ncomparison = timeit.timeit(\n    stmt=\'for _ in fast(): pass\',\n    globals=globals(),\n    number=50)\nprint(f\'Composed nesting {comparison:2f}s\')\nreduction = -(comparison - baseline)/baseline\nprint(f\'{reduction:.1%} less time\')\n\n>>>\nManual nesting 3.70s\nComposed nesting 3.319963s\n10.2% less time`, `90403230504532870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> timeit\n\n\n<span class="token keyword">def</span> <span class="token function">child</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>1_000_000<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">yield</span> i\n\n\n<span class="token keyword">def</span> <span class="token function">slow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> i <span class="token keyword">in</span> child<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">yield</span> i\n\n\n<span class="token keyword">def</span> <span class="token function">fast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">yield</span> <span class="token keyword">from</span> child<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n\nbaseline <span class="token operator">=</span> timeit<span class="token punctuation">.</span>timeit<span class="token punctuation">(</span>\n    stmt<span class="token operator">=</span><span class="token string">\'for _ in slow(): pass\'</span><span class="token punctuation">,</span>\n    <span class="token builtin">globals</span><span class="token operator">=</span><span class="token builtin">globals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    number<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Manual nesting </span><span class="token interpolation"><span class="token punctuation">{</span>baseline<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">s\'</span></span><span class="token punctuation">)</span>\ncomparison <span class="token operator">=</span> timeit<span class="token punctuation">.</span>timeit<span class="token punctuation">(</span>\n    stmt<span class="token operator">=</span><span class="token string">\'for _ in fast(): pass\'</span><span class="token punctuation">,</span>\n    <span class="token builtin">globals</span><span class="token operator">=</span><span class="token builtin">globals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    number<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Composed nesting </span><span class="token interpolation"><span class="token punctuation">{</span>comparison<span class="token punctuation">:</span><span class="token format-spec">2f</span><span class="token punctuation">}</span></span><span class="token string">s\'</span></span><span class="token punctuation">)</span>\nreduction <span class="token operator">=</span> <span class="token operator">-</span><span class="token punctuation">(</span>comparison <span class="token operator">-</span> baseline<span class="token punctuation">)</span><span class="token operator">/</span>baseline\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>reduction<span class="token punctuation">:</span><span class="token format-spec">.1%</span><span class="token punctuation">}</span></span><span class="token string"> less time\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nManual nesting <span class="token number">3.</span>70s\nComposed nesting <span class="token number">3.</span>319963s\n<span class="token number">10.2</span><span class="token operator">%</span> less time</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>所以，如果要把多个生成器连起来用，那么笔者强烈建议优先考虑 yield from 表达式。</p>\n<h3 id="总结-29"><a href="#%E6%80%BB%E7%BB%93-29" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>如果要连续使用多个生成器，那么可以通过 yield from 表达式来分别使用这些生成器，这样做能够免去重复的 for 结构。</li>\n<li>yield from 的性能要胜过那种在 for 循环里手工编写 yield 表达式的方案。</li>\n</ol>\n<h2 id="第-34-条：不要用-send-给生成器注入数据"><a href="#%E7%AC%AC-34-%E6%9D%A1%EF%BC%9A%E4%B8%8D%E8%A6%81%E7%94%A8-send-%E7%BB%99%E7%94%9F%E6%88%90%E5%99%A8%E6%B3%A8%E5%85%A5%E6%95%B0%E6%8D%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 34 条：不要用 send 给生成器注入数据</h2>\n<p>yield 表达式让我们能够轻松地写出生成器函数，使得调用者可以每次只获取输出序列中的一项结果（参见第 30 条）。但问题是，这种通道是单向的，也就是说，无法让生成器在其一端接收数据流，同时在另一端给出计算结果。假如能实现双向通信，那么生成器的适用面会更广。</p>\n<p>例如，我们想用软件实现无线电广播，用它来发送信号。为了编写这个程序，我们必须用一个函数来模拟正弦波，让它能够给出一系列按照正弦方式分布的点。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40851092403614220000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import math\n\n\ndef wave(amplitude, steps):\n    step_size = 2 * math.pi / steps\n    for step in range(steps):\n        radians = step * step_size\n        fraction = math.sin(radians)\n        output = amplitude * fraction\n        yield output`, `40851092403614220000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> math\n\n\n<span class="token keyword">def</span> <span class="token function">wave</span><span class="token punctuation">(</span>amplitude<span class="token punctuation">,</span> steps<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    step_size <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> math<span class="token punctuation">.</span>pi <span class="token operator">/</span> steps\n    <span class="token keyword">for</span> step <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>steps<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        radians <span class="token operator">=</span> step <span class="token operator">*</span> step_size\n        fraction <span class="token operator">=</span> math<span class="token punctuation">.</span>sin<span class="token punctuation">(</span>radians<span class="token punctuation">)</span>\n        output <span class="token operator">=</span> amplitude <span class="token operator">*</span> fraction\n        <span class="token keyword">yield</span> output</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>有了这个 wave 函数，我们可以让它按照某个固定的振幅生成一系列可供传输的值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31369254869024820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def transmit(output):\n    if output is None:\n        print(f\'Output is None\')\n    else:\n        print(f\'Output: {output:>5.1f}\')\n\n\ndef run(it):\n    for output in it:\n        transmit(output)\n\n\nrun(wave(3.0, 8))\n\n>>>\nOutput:   0.0\nOutput:   2.1\nOutput:   3.0\nOutput:   2.1\nOutput:   0.0\nOutput:  -2.1\nOutput:  -3.0\nOutput:  -2.1`, `31369254869024820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">transmit</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> output <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Output is None\'</span></span><span class="token punctuation">)</span>\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Output: </span><span class="token interpolation"><span class="token punctuation">{</span>output<span class="token punctuation">:</span><span class="token format-spec">>5.1f</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> output <span class="token keyword">in</span> it<span class="token punctuation">:</span>\n        transmit<span class="token punctuation">(</span>output<span class="token punctuation">)</span>\n\n\nrun<span class="token punctuation">(</span>wave<span class="token punctuation">(</span><span class="token number">3.0</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">2.1</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">3.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">2.1</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">2.1</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">3.0</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">2.1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写可以生成基本的波形，但问题是，该函数在产生这些值的时候，只能按照刚开始给定的振幅来计算，而没办法使振幅在整个生成过程中根据某个因素发生变化（例如在发送调幅广播信号时，我们就需要这么做）。现在，我们要让生成器在计算每个值的时候，都能考虑到振幅的变化，从而实现调幅。</p>\n<p>Python 的生成器支持 send 方法，这可以让生成器变为双向通道。send 方法可以把参数发给生成器，让它成为上一条 yield 表达式的求值结果，并将生成器推进到下一条 yield 表达式，然后把 yield 右边的值返回给 send 方法的调用者。然而在一般情况下，我们还是会通过内置的 next 函数来推进生成器，按照这种写法，上一条 yield 表达式的求值结果总是 None。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22083977712314364000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def my_generator():\n    received = yield 1\n    print(f\'received {received}\')\n\n\nit = iter(my_generator())\noutput = next(it)  # Get first generator output\nprint(f\'output = {output}\')\ntry:\n    next(it)  # Run generator until it exits\nexcept StopIteration:\n    pass\n\n>>>\noutput = 1\nreceived None`, `22083977712314364000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">my_generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    received <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token number">1</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'received </span><span class="token interpolation"><span class="token punctuation">{</span>received<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n\nit <span class="token operator">=</span> <span class="token builtin">iter</span><span class="token punctuation">(</span>my_generator<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\noutput <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span>  <span class="token comment"># Get first generator output</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'output = </span><span class="token interpolation"><span class="token punctuation">{</span>output<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    <span class="token builtin">next</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span>  <span class="token comment"># Run generator until it exits</span>\n<span class="token keyword">except</span> StopIteration<span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\noutput <span class="token operator">=</span> <span class="token number">1</span>\nreceived <span class="token boolean">None</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果不通过 for 循环或内置的 next 函数推进生成器，而是改用 send 方法，那么调用方法时传入的参数就会成为上一条 yield 表达式的值，生成器拿到这个值后，会继续运行到下一条 yield 表达式那里。可是，刚开始推进生成器的时候，它是从头执行的，而不是从某一条 yield 表达式那里继续的，所以，首次调用 send 方法时，只能传 None，要是传入其他值，程序运行时就会抛出异常。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28681449520031486000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def my_generator():\n    received = yield 1\n    print(f\'received {received}\')\n\n\nit = iter(my_generator())\noutput = it.send(None)  # Get first generator output\nprint(f\'output {output}\')\ntry:\n    it.send(\'hello!\')  # Send value into the generator\nexcept StopIteration:\n    pass\n\n>>>\noutput 1\nreceived hello!`, `28681449520031486000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">my_generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    received <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token number">1</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'received </span><span class="token interpolation"><span class="token punctuation">{</span>received<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n\nit <span class="token operator">=</span> <span class="token builtin">iter</span><span class="token punctuation">(</span>my_generator<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\noutput <span class="token operator">=</span> it<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span>  <span class="token comment"># Get first generator output</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'output </span><span class="token interpolation"><span class="token punctuation">{</span>output<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    it<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">\'hello!\'</span><span class="token punctuation">)</span>  <span class="token comment"># Send value into the generator</span>\n<span class="token keyword">except</span> StopIteration<span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\noutput <span class="token number">1</span>\nreceived hello!</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们可以利用这种机制让调用者把振幅发送过来，这样函数就能根据这个输入值调整生成的正弦波幅值了。首先修改 wave 函数的代码，让它把 yield 表达式的求值结果（也就是调用者通过 send 发过来的振幅）保存到 amplitude 变量里，这样就能根据该变量计算出下次应该生成的值。</p>\n<p>然后，要修改 run 函数调用 <code class="language-text">wave_modulating</code> 函数的方式。它现在必须把每次所要使用的振幅发给 <code class="language-text">wave_modulating</code> 生成器。首次必须发送 None，因为此时生成器还没有遇到过 yield 表达式，它不需要知道上一条 yield 表达式的求值结果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46114035464575530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import math\n\n\ndef transmit(output):\n    if output is None:\n        print(f\'Output is None\')\n    else:\n        print(f\'Output: {output:>5.1f}\')\n\n\ndef wave_modulating(steps):\n    step_size = 2 * math.pi / steps\n    amplitude = yield  # Receive initial amplitude\n    for step in range(steps):\n        radians = step * step_size\n        fraction = math.sin(radians)\n        output = amplitude * fraction\n        amplitude = yield output  # Receive next amplitude\n\n\ndef run_modulating(it):\n    amplitudes = [None, 7, 7, 7, 2, 2, 2, 2, 10, 10, 10, 10, 10]\n    for amplitude in amplitudes:\n        output = it.send(amplitude)\n        transmit(output)\n\n\nrun_modulating(wave_modulating(12))\n\n>>>\nOutput is None\nOutput:   0.0\nOutput:   3.5\nOutput:   6.1\nOutput:   2.0\nOutput:   1.7\nOutput:   1.0\nOutput:   0.0\nOutput:  -5.0\nOutput:  -8.7\nOutput: -10.0\nOutput:  -8.7\nOutput:  -5.0`, `46114035464575530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> math\n\n\n<span class="token keyword">def</span> <span class="token function">transmit</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> output <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Output is None\'</span></span><span class="token punctuation">)</span>\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Output: </span><span class="token interpolation"><span class="token punctuation">{</span>output<span class="token punctuation">:</span><span class="token format-spec">>5.1f</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">def</span> <span class="token function">wave_modulating</span><span class="token punctuation">(</span>steps<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    step_size <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> math<span class="token punctuation">.</span>pi <span class="token operator">/</span> steps\n    amplitude <span class="token operator">=</span> <span class="token keyword">yield</span>  <span class="token comment"># Receive initial amplitude</span>\n    <span class="token keyword">for</span> step <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>steps<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        radians <span class="token operator">=</span> step <span class="token operator">*</span> step_size\n        fraction <span class="token operator">=</span> math<span class="token punctuation">.</span>sin<span class="token punctuation">(</span>radians<span class="token punctuation">)</span>\n        output <span class="token operator">=</span> amplitude <span class="token operator">*</span> fraction\n        amplitude <span class="token operator">=</span> <span class="token keyword">yield</span> output  <span class="token comment"># Receive next amplitude</span>\n\n\n<span class="token keyword">def</span> <span class="token function">run_modulating</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    amplitudes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\n    <span class="token keyword">for</span> amplitude <span class="token keyword">in</span> amplitudes<span class="token punctuation">:</span>\n        output <span class="token operator">=</span> it<span class="token punctuation">.</span>send<span class="token punctuation">(</span>amplitude<span class="token punctuation">)</span>\n        transmit<span class="token punctuation">(</span>output<span class="token punctuation">)</span>\n\n\nrun_modulating<span class="token punctuation">(</span>wave_modulating<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nOutput <span class="token keyword">is</span> <span class="token boolean">None</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">3.5</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">6.1</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">2.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">1.7</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">1.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">5.0</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">8.7</span>\nOutput<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">10.0</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">8.7</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">5.0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写没问题，程序可以按照每次输入的值调整输出信号的振幅。首次输出的肯定是 None，因为此时 <code class="language-text">wave_modulating</code> 函数并不知道 amplitude 是多少，它只有在运行第一条 yield 表达式后，才能把调用者通过 send 发来的值保存到这个变量里。</p>\n<p>这种写法有个缺点，就是它很难让初次阅读这段代码的人立刻理解它的意思。把 yield 放在赋值语句的右侧，本身就不太直观，因为我们必须先了解生成器的这项高级特性，才能明白 yield 与 send 是如何相互配合的。</p>\n<p>现在假设程序的需求变得更复杂了。这次要生成的载波不是简单的正弦波，而是由多个信号序列构成的复合波形（complex waveform）。要实现这个需求，可以连用几条 yield from 语句，把多个生成器串接起来（参见第 33 条）。下面先验证一下，这种写法能否处理振幅固定的简单情况。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85914545498685920000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def complex_wave():\n    yield from wave(7.0, 3)\n    yield from wave(2.0, 4)\n    yield from wave(10.0, 5)\n\n\nrun(complex_wave())\n\n>>>\nOutput:   0.0\nOutput:   6.1\nOutput:  -6.1\nOutput:   0.0\nOutput:   2.0\nOutput:   0.0\nOutput:  -2.0\nOutput:   0.0\nOutput:   9.5\nOutput:   5.9\nOutput:  -5.9\nOutput:  -9.5`, `85914545498685920000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">complex_wave</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">yield</span> <span class="token keyword">from</span> wave<span class="token punctuation">(</span><span class="token number">7.0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token keyword">from</span> wave<span class="token punctuation">(</span><span class="token number">2.0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token keyword">from</span> wave<span class="token punctuation">(</span><span class="token number">10.0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>\n\n\nrun<span class="token punctuation">(</span>complex_wave<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">6.1</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">6.1</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">2.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">2.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">9.5</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">5.9</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">5.9</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">9.5</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，利用 yield from 表达式确实可以处理比较简单的情况。那既然这样，我们再试试看，它能否处理那种采用 send 方法写成的函数。下面就用这种写法，接连多次调用 <code class="language-text">wave_modulating</code> 生成器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52151156796017870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def complex_wave_modulating():\n    yield from wave_modulating(3)\n    yield from wave_modulating(4)\n    yield from wave_modulating(5)\n\n\nrun_modulating(complex_wave_modulating())\n\n>>>\nOutput is None\nOutput:   0.0\nOutput:   6.1\nOutput:  -6.1\nOutput is None\nOutput:   0.0\nOutput:   2.0\nOutput:   0.0\nOutput: -10.0\nOutput is None\nOutput:   0.0\nOutput:   9.5\nOutput:   5.9`, `52151156796017870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">complex_wave_modulating</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">yield</span> <span class="token keyword">from</span> wave_modulating<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token keyword">from</span> wave_modulating<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token keyword">from</span> wave_modulating<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>\n\n\nrun_modulating<span class="token punctuation">(</span>complex_wave_modulating<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nOutput <span class="token keyword">is</span> <span class="token boolean">None</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">6.1</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">6.1</span>\nOutput <span class="token keyword">is</span> <span class="token boolean">None</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">2.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">10.0</span>\nOutput <span class="token keyword">is</span> <span class="token boolean">None</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">9.5</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">5.9</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写在大方向上是对的，但问题在于：程序竟然输出了那么多 None！这是为什么呢？因为每条 yield from 表达式其实都在遍历一个嵌套进去的生成器，所以每个嵌套生成器都必须分别执行它们各自的第一条 yield 语句（也就是什么值都不带的那条 yield 语句），只有执行过这条语句之后，这些生成器才能通过 send 方法所传来的值决定这条语句的求值结果，并把这个结果放在 amplitude 变量里以计算下一次应该输出的值。所以，<code class="language-text">complex_wave_modulating</code> 函数处理完前一个嵌套的生成器之后，会进入下一个嵌套的生成器，而这时就必须先把该生成器的第一条 yield 语句运行过去，这就导致后面两个嵌套生成器会各自从 amplitudes 列表里浪费掉一个，并使得每个嵌套生成器所拿到的第一个结果必定是 None，还会让最后那个嵌套生成器少执行两次。</p>\n<p>这意味着，虽然 yield from 语句与 send 方法单独用着都没问题，然而结合使用的效果却不太让人满意。当然也可以在 <code class="language-text">run_modulating</code> 函数里添加一些代码，使得计算波形的步调与 amplitudes 列表提供振幅值的步调相一致，但这只能使程序越写越复杂，因为利用 send 方法写成的 <code class="language-text">wave_modulating</code> 函数本身已经不太直观了，而我们又把这个生成器函数通过 yield from 语句套到了 <code class="language-text">complex_wave_modulating</code> 里面，这理解起来就更加困难了。所以，笔者建议彻底抛开 send 方法，改用更简单的方案来做。</p>\n<p>最简单的一种写法，是把迭代器传给 wave 函数，让 wave 每次用到振幅的时候，通过 Python 内置的 next 函数推进这个迭代器并返回一个输入振幅。于是，这就促使多个生成器之间，产生连环反应（其他类似案例参见第 32 条）。</p>\n<p>这样，我们只需要把同一个迭代器分别传给这几条 yield from 语句里的 <code class="language-text">wave_cascading</code> 就行。迭代器是有状态的（参见第 31 条），所以下一个 <code class="language-text">wave_cascading</code> 会从上一个 <code class="language-text">wave_cascading</code> 使用完的地方，继续往下使用 <code class="language-text">amplitude_it</code> 迭代器。</p>\n<p>要想触发这个组合的生成器，只需要把振幅值放在列表中，并把针对列表制作的迭代器传给 <code class="language-text">complex_wave_cascading</code> 就好。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55113865711412570000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import math\n\n\ndef transmit(output):\n    if output is None:\n        print(f\'Output is None\')\n    else:\n        print(f\'Output: {output:>5.1f}\')\n\n\ndef wave_cascading(amplitude_it, steps):\n    step_size = 2 * math.pi / steps\n    for step in range(steps):\n        radians = step * step_size\n        fraction = math.sin(radians)\n        amplitude = next(amplitude_it)  # Get next input\n        output = amplitude * fraction\n        yield output\n\n\ndef complex_wave_cascading(amplitude_it):\n    yield from wave_cascading(amplitude_it, 3)\n    yield from wave_cascading(amplitude_it, 4)\n    yield from wave_cascading(amplitude_it, 5)\n\n\ndef run_cascading():\n    amplitudes = [7, 7, 7, 2, 2, 2, 2, 10, 10, 10, 10, 10]\n    it = complex_wave_cascading(iter(amplitudes))\n    for amplitude in amplitudes:\n        output = next(it)\n        transmit(output)\n\n\nrun_cascading()\n\n>>>\nOutput:   0.0\nOutput:   6.1\nOutput:  -6.1\nOutput:   0.0\nOutput:   2.0\nOutput:   0.0\nOutput:  -2.0\nOutput:   0.0\nOutput:   9.5\nOutput:   5.9\nOutput:  -5.9\nOutput:  -9.5`, `55113865711412570000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> math\n\n\n<span class="token keyword">def</span> <span class="token function">transmit</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> output <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Output is None\'</span></span><span class="token punctuation">)</span>\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Output: </span><span class="token interpolation"><span class="token punctuation">{</span>output<span class="token punctuation">:</span><span class="token format-spec">>5.1f</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">def</span> <span class="token function">wave_cascading</span><span class="token punctuation">(</span>amplitude_it<span class="token punctuation">,</span> steps<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    step_size <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> math<span class="token punctuation">.</span>pi <span class="token operator">/</span> steps\n    <span class="token keyword">for</span> step <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>steps<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        radians <span class="token operator">=</span> step <span class="token operator">*</span> step_size\n        fraction <span class="token operator">=</span> math<span class="token punctuation">.</span>sin<span class="token punctuation">(</span>radians<span class="token punctuation">)</span>\n        amplitude <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span>amplitude_it<span class="token punctuation">)</span>  <span class="token comment"># Get next input</span>\n        output <span class="token operator">=</span> amplitude <span class="token operator">*</span> fraction\n        <span class="token keyword">yield</span> output\n\n\n<span class="token keyword">def</span> <span class="token function">complex_wave_cascading</span><span class="token punctuation">(</span>amplitude_it<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">yield</span> <span class="token keyword">from</span> wave_cascading<span class="token punctuation">(</span>amplitude_it<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token keyword">from</span> wave_cascading<span class="token punctuation">(</span>amplitude_it<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token keyword">from</span> wave_cascading<span class="token punctuation">(</span>amplitude_it<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">def</span> <span class="token function">run_cascading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    amplitudes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\n    it <span class="token operator">=</span> complex_wave_cascading<span class="token punctuation">(</span><span class="token builtin">iter</span><span class="token punctuation">(</span>amplitudes<span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token keyword">for</span> amplitude <span class="token keyword">in</span> amplitudes<span class="token punctuation">:</span>\n        output <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span>\n        transmit<span class="token punctuation">(</span>output<span class="token punctuation">)</span>\n\n\nrun_cascading<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">6.1</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">6.1</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">2.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">2.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">9.5</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">5.9</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">5.9</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">9.5</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种写法最大的优点在于，迭代器可以来自任何地方，而且完全可以是动态的（例如可以用生成器函数来实现迭代器）。此方案只有一个缺陷，就是必须假设负责输入的生成器绝对能保证线程安全，但有时其实保证不了这一点。如果代码要跨越线程边界，那么用 async 函数实现可能更好（参见第 62 条）。</p>\n<h3 id="总结-30"><a href="#%E6%80%BB%E7%BB%93-30" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>send 方法可以把数据注入生成器，让它成为上一条 yield 表达式的求值结果，生成器可以把这个结果赋给变量。</li>\n<li>把 send 方法与 yield from 表达式搭配起来使用，可能导致奇怪的结果，例如会让程序在本该输出有效值的地方输出 None。</li>\n<li>通过迭代器向组合起来的生成器输入数据，要比采用 send 方法的那种方案好，所以尽量避免使用 send 方法。</li>\n</ol>\n<h2 id="第-35-条：不要通过-throw-变换生成器的状态"><a href="#%E7%AC%AC-35-%E6%9D%A1%EF%BC%9A%E4%B8%8D%E8%A6%81%E9%80%9A%E8%BF%87-throw-%E5%8F%98%E6%8D%A2%E7%94%9F%E6%88%90%E5%99%A8%E7%9A%84%E7%8A%B6%E6%80%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 35 条：不要通过 throw 变换生成器的状态</h2>\n<p>除 yield from 表达式（参见第 33 条）与 send 方法（参见第 34 条）外，生成器还有一项高级功能，就是可以把调用者通过 throw 方法传来的 Exception 实例重新抛出。这个 throw 方法用起来很简单：如果调用了这个方法，那么生成器下次推进时，就不会像平常那样，直接走到下一条 yield 表达式那里，而是会把通过 throw 方法传入的异常重新抛出。下面用代码演示这种效果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6890547919481360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyError(Exception):\n    pass\n\n\ndef my_generator():\n    yield 1\n    yield 2\n    yield 3\n\n\nit = my_generator()\nprint(next(it))  # Yield 1\nprint(next(it))  # Yield 2\nprint(it.throw(MyError(\'test error\')))\n\n>>>\n1\n2\nTraceback ...\n__main__.MyError: test error`, `6890547919481360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyError</span><span class="token punctuation">(</span>Exception<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">def</span> <span class="token function">my_generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">yield</span> <span class="token number">1</span>\n    <span class="token keyword">yield</span> <span class="token number">2</span>\n    <span class="token keyword">yield</span> <span class="token number">3</span>\n\n\nit <span class="token operator">=</span> my_generator<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">next</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># Yield 1</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">next</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># Yield 2</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span>throw<span class="token punctuation">(</span>MyError<span class="token punctuation">(</span><span class="token string">\'test error\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">1</span>\n<span class="token number">2</span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n__main__<span class="token punctuation">.</span>MyError<span class="token punctuation">:</span> test error</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>生成器函数可以用标准的 try/except 复合语句把 yield 表达式包裹起来，如果函数上次执行到了这条表达式这里，而这次即将继续执行时，又发现外界通过 throw 方法给自己注入了异常，那么这个异常就会被 try 结构捕获下来，如果捕获之后不继续抛异常，那么生成器函数会推进到下一条 yield 表达式（更多异常处理，参见第 65 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43766428785675360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyError(Exception):\n    pass\n\n\ndef my_generator():\n    yield 1\n    try:\n        yield 2\n    except MyError:\n        print(\'Got MyError!\')\n    else:\n        yield 3\n    yield 4\n\n\nit = my_generator()\nprint(next(it))  # Yield 1\nprint(next(it))  # Yield 2\nprint(it.throw(MyError(\'test error\')))\n\n>>>\n1\n2\nGot MyError!\n4`, `43766428785675360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyError</span><span class="token punctuation">(</span>Exception<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">def</span> <span class="token function">my_generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">yield</span> <span class="token number">1</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">yield</span> <span class="token number">2</span>\n    <span class="token keyword">except</span> MyError<span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Got MyError!\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        <span class="token keyword">yield</span> <span class="token number">3</span>\n    <span class="token keyword">yield</span> <span class="token number">4</span>\n\n\nit <span class="token operator">=</span> my_generator<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">next</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># Yield 1</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">next</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># Yield 2</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span>throw<span class="token punctuation">(</span>MyError<span class="token punctuation">(</span><span class="token string">\'test error\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">1</span>\n<span class="token number">2</span>\nGot MyError!\n<span class="token number">4</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这项机制会在生成器与调用者之间形成双向通信通道（另一种双向通信通道，参见第 34 条），这在某些情况下是有用的。例如，要编写一个偶尔可以重置的计时器程序。笔者定义下面的 Reset 异常与 timer 生成器方法，让调用者可以在 timer 给出的迭代器上通过 throw 方法注入 Reset 异常，令计时器重置。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18615290714237485000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Reset(Exception):\n    pass\n\n\ndef timer(period):\n    current = period\n    while current:\n        current -= 1\n        try:\n            yield current\n        except Reset:\n            current = period`, `18615290714237485000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Reset</span><span class="token punctuation">(</span>Exception<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">def</span> <span class="token function">timer</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    current <span class="token operator">=</span> period\n    <span class="token keyword">while</span> current<span class="token punctuation">:</span>\n        current <span class="token operator">-=</span> <span class="token number">1</span>\n        <span class="token keyword">try</span><span class="token punctuation">:</span>\n            <span class="token keyword">yield</span> current\n        <span class="token keyword">except</span> Reset<span class="token punctuation">:</span>\n            current <span class="token operator">=</span> period</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>按照这种写法，如果 timer 正准备从 yield 表达式往下推进时，发现有人注入了 Reset 异常，那么它就会把这个异常捕获下来，并进入 except 分支，在这里它会把表示倒计时的 current 变量重新调整成最初的 period 值。</p>\n<p>这个计时器可以与外界某个按秒轮询的输入机制对接起来。为此，笔者定义一个 run 函数以驱动 timer 生成器所给出的那个 it 迭代器，并根据外界的情况做处理，如果外界要求重置，那就通过 it 迭代器的 throw 方法给计时器注入 Reset 变量，如果外界没有这样要求，那就调用 announce 函数打印生成器所给的倒计时值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93254818818606630000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Reset(Exception):\n    pass\n\n\ndef timer(period):\n    current = period\n    while current:\n        current -= 1\n        try:\n            yield current\n        except Reset:\n            current = period\n\n\ndef check_for_reset():\n    # Poll for external event\n    # ...\n    pass\n\n\ndef announce(remaining):\n    print(f\'{remaining} ticks remaining\')\n\n\ndef run():\n    it = timer(4)\n    while True:\n        try:\n            if check_for_reset():\n                current = it.throw(Reset())\n            else:\n                current = next(it)\n        except StopIteration:\n            break\n        else:\n            announce(current)\n\n\nrun()\n\n>>>\n3 ticks remaining\n2 ticks remaining\n1 ticks remaining\n0 ticks remaining`, `93254818818606630000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Reset</span><span class="token punctuation">(</span>Exception<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">def</span> <span class="token function">timer</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    current <span class="token operator">=</span> period\n    <span class="token keyword">while</span> current<span class="token punctuation">:</span>\n        current <span class="token operator">-=</span> <span class="token number">1</span>\n        <span class="token keyword">try</span><span class="token punctuation">:</span>\n            <span class="token keyword">yield</span> current\n        <span class="token keyword">except</span> Reset<span class="token punctuation">:</span>\n            current <span class="token operator">=</span> period\n\n\n<span class="token keyword">def</span> <span class="token function">check_for_reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token comment"># Poll for external event</span>\n    <span class="token comment"># ...</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">def</span> <span class="token function">announce</span><span class="token punctuation">(</span>remaining<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>remaining<span class="token punctuation">}</span></span><span class="token string"> ticks remaining\'</span></span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    it <span class="token operator">=</span> timer<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>\n    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>\n        <span class="token keyword">try</span><span class="token punctuation">:</span>\n            <span class="token keyword">if</span> check_for_reset<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n                current <span class="token operator">=</span> it<span class="token punctuation">.</span>throw<span class="token punctuation">(</span>Reset<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n            <span class="token keyword">else</span><span class="token punctuation">:</span>\n                current <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span>\n        <span class="token keyword">except</span> StopIteration<span class="token punctuation">:</span>\n            <span class="token keyword">break</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            announce<span class="token punctuation">(</span>current<span class="token punctuation">)</span>\n\n\nrun<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">3</span> ticks remaining\n<span class="token number">2</span> ticks remaining\n<span class="token number">1</span> ticks remaining\n<span class="token number">0</span> ticks remaining</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写没错，但是有点儿难懂，因为用了许多层嵌套结构。我们要判断 <code class="language-text">check_for_reset</code> 函数的返回值，以确定是应该通过 it.throw 注入 Reset 异常，还是应该通过 next 推进迭代器。如果是要推进迭代器，那么还得捕获 StopIteration 异常：若是捕获到了这种异常，那说明迭代器已经走到终点，则要执行 break 跳出 while 循环；若没捕获到，则需要调用 announce 函数打印倒计时值。这会让代码变得很乱。</p>\n<p>有个简单的办法，能够改写这段代码，那就是用可迭代的容器对象（参见第 31 条）定义一个有状态的闭包（参见第 38 条）。下面的代码就写了这样一个 Timer 类，并通过它重新实现刚才的 timer 生成器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34992762256854372000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Timer:\n    def __init__(self, period):\n        self.current = period\n        self.period = period\n\n    def reset(self):\n        self.current = self.period\n\n    def __iter__(self):\n        while self.current:\n            self.current -= 1\n            yield self.current`, `34992762256854372000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Timer</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> period<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>current <span class="token operator">=</span> period\n        self<span class="token punctuation">.</span>period <span class="token operator">=</span> period\n\n    <span class="token keyword">def</span> <span class="token function">reset</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>current <span class="token operator">=</span> self<span class="token punctuation">.</span>period\n\n    <span class="token keyword">def</span> <span class="token function">__iter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">while</span> self<span class="token punctuation">.</span>current<span class="token punctuation">:</span>\n            self<span class="token punctuation">.</span>current <span class="token operator">-=</span> <span class="token number">1</span>\n            <span class="token keyword">yield</span> self<span class="token punctuation">.</span>current</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在，run 函数就好写多了，因为它只需要用 for 循环迭代这个 timer 即可。这样写出来的代码，不像刚才那样有那么多层嵌套，所以读起来很容易懂。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65870240331568185000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Reset(Exception):\n    pass\n\n\ndef check_for_reset():\n    # Poll for external event\n    # ...\n    pass\n\n\ndef announce(remaining):\n    print(f\'{remaining} ticks remaining\')\n\n\nclass Timer:\n    def __init__(self, period):\n        self.current = period\n        self.period = period\n\n    def reset(self):\n        self.current = self.period\n\n    def __iter__(self):\n        while self.current:\n            self.current -= 1\n            yield self.current\n\n\ndef run():\n    timer = Timer(4)\n    for current in timer:\n        if check_for_reset():\n            timer.reset()\n        announce(current)\n\n\nrun()\n\n>>>\n3 ticks remaining\n2 ticks remaining\n1 ticks remaining\n0 ticks remaining`, `65870240331568185000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{29-37}"\n              >\n                <span class="gatsby-code-button-language">py{29-37}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Reset</span><span class="token punctuation">(</span>Exception<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">def</span> <span class="token function">check_for_reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token comment"># Poll for external event</span>\n    <span class="token comment"># ...</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">def</span> <span class="token function">announce</span><span class="token punctuation">(</span>remaining<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>remaining<span class="token punctuation">}</span></span><span class="token string"> ticks remaining\'</span></span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Timer</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> period<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>current <span class="token operator">=</span> period\n        self<span class="token punctuation">.</span>period <span class="token operator">=</span> period\n\n    <span class="token keyword">def</span> <span class="token function">reset</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>current <span class="token operator">=</span> self<span class="token punctuation">.</span>period\n\n    <span class="token keyword">def</span> <span class="token function">__iter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">while</span> self<span class="token punctuation">.</span>current<span class="token punctuation">:</span>\n            self<span class="token punctuation">.</span>current <span class="token operator">-=</span> <span class="token number">1</span>\n            <span class="token keyword">yield</span> self<span class="token punctuation">.</span>current\n\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">    timer <span class="token operator">=</span> Timer<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">for</span> current <span class="token keyword">in</span> timer<span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">if</span> check_for_reset<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">            timer<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">        announce<span class="token punctuation">(</span>current<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">run<span class="token punctuation">(</span><span class="token punctuation">)</span></span>\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">3</span> ticks remaining\n<span class="token number">2</span> ticks remaining\n<span class="token number">1</span> ticks remaining\n<span class="token number">0</span> ticks remaining</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写所输出的结果与前面一样，但是这种实现方案理解起来要容易得多，即便是初次阅读这段代码的人也很容易就能读懂。凡是想用生成器与异常来实现的功能，通常都可以改用异步机制去做（参见第 60 条），那样会更好。如果确实遇到了这里讲到的这种需求，那么应该通过可迭代的类来实现生成器，而不要用 throw 方法注入异常。</p>\n<h3 id="总结-31"><a href="#%E6%80%BB%E7%BB%93-31" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>throw 方法可以把异常发送到生成器刚执行过的那条 yield 表达式那里，让这个异常在生成器下次推进时重新抛出。</li>\n<li>通过 throw 方法注入异常，会让代码变得难懂，因为需要用多层嵌套的模板结构来抛出并捕获这种异常。</li>\n<li>如果确实遇到了这样的特殊情况，那么应该通过类的 <code class="language-text">__iter__</code> 方法实现生成器，并且专门提供一个方法，让调用者通过这个方法来触发这种特殊的状态变换逻辑。</li>\n</ol>\n<h2 id="第-36-条：考虑用-itertools-拼装迭代器与生成器"><a href="#%E7%AC%AC-36-%E6%9D%A1%EF%BC%9A%E8%80%83%E8%99%91%E7%94%A8-itertools-%E6%8B%BC%E8%A3%85%E8%BF%AD%E4%BB%A3%E5%99%A8%E4%B8%8E%E7%94%9F%E6%88%90%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 36 条：考虑用 itertools 拼装迭代器与生成器</h2>\n<p>Python 内置的 itertools 模块里有很多函数，可以用来安排迭代器之间的交互关系（相关的基础知识，参见第 30 条与第 31 条）。</p>\n<p>如果要实现比较难写的迭代逻辑，那么应该先查看 itertools 的文档（在 Python 解释器界面输入 help(itertools)），说不定里面就有你能用到的函数。下面分三大类，列出其中最重要的函数。</p>\n<h3 id="连接多个迭代器"><a href="#%E8%BF%9E%E6%8E%A5%E5%A4%9A%E4%B8%AA%E8%BF%AD%E4%BB%A3%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>连接多个迭代器</h3>\n<p>内置的 itertools 模块有一些函数可以把多个迭代器连成一个使用。</p>\n<h4 id="chain"><a href="#chain" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>chain</h4>\n<p>chain 可以把多个迭代器从头到尾连成一个迭代器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24813088043233698000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\nit = itertools.chain([1, 2, 3], [4, 5, 6])\nprint(list(it))\n\n>>>\n[1, 2, 3, 4, 5, 6]`, `24813088043233698000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\nit <span class="token operator">=</span> itertools<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="repeat"><a href="#repeat" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>repeat</h4>\n<p>repeat 可以制作这样一个迭代器，它会不停地输出某个值。调用 repeat 时，也可以通过第二个参数指定迭代器最多能输出几次。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44638188458436540000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\nit = itertools.repeat(\'hello\', 3)\nprint(list(it))\n\n>>>\n[\'hello\', \'hello\', \'hello\']`, `44638188458436540000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\nit <span class="token operator">=</span> itertools<span class="token punctuation">.</span>repeat<span class="token punctuation">(</span><span class="token string">\'hello\'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token string">\'hello\'</span><span class="token punctuation">,</span> <span class="token string">\'hello\'</span><span class="token punctuation">,</span> <span class="token string">\'hello\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="cycle"><a href="#cycle" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>cycle</h4>\n<p>cycle 可以制作这样一个迭代器，它会循环地输出某段内容之中的各项元素。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42558792779717630000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\nit = itertools.cycle([1, 2])\nresult = [next(it) for _ in range(10)]\nprint(result)\n\n>>>\n[1, 2, 1, 2, 1, 2, 1, 2, 1, 2]`, `42558792779717630000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\nit <span class="token operator">=</span> itertools<span class="token punctuation">.</span>cycle<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\nresult <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">next</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="tee"><a href="#tee" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>tee</h4>\n<p>tee 可以让一个迭代器分裂成多个平行的迭代器，具体个数由第二个参数指定。如果这些迭代器推进的速度不一致，那么程序可能要用大量内存做缓冲，以存放进度落后的迭代器将来会用到的元素。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42683240442077010000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\nit1, it2, it3 = itertools.tee([\'first\', \'second\'], 3)\nprint(list(it1))\nprint(list(it2))\nprint(list(it3))\n\n>>>\n[\'first\', \'second\']\n[\'first\', \'second\']\n[\'first\', \'second\']`, `42683240442077010000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\nit1<span class="token punctuation">,</span> it2<span class="token punctuation">,</span> it3 <span class="token operator">=</span> itertools<span class="token punctuation">.</span>tee<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'first\'</span><span class="token punctuation">,</span> <span class="token string">\'second\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>it1<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>it2<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>it3<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token string">\'first\'</span><span class="token punctuation">,</span> <span class="token string">\'second\'</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token string">\'first\'</span><span class="token punctuation">,</span> <span class="token string">\'second\'</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token string">\'first\'</span><span class="token punctuation">,</span> <span class="token string">\'second\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="zip_longest"><a href="#zip_longest" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>zip_longest</h4>\n<p>它与 Python 内置的 zip 函数类似（参见第 8 条），但区别在于，如果源迭代器的长度不同，那么它会用 fillvalue 参数的值来填补提前耗尽的那些迭代器所留下的空缺。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47181806528134220000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\nkeys = [\'one\', \'two\', \'three\']\nvalues = [1, 2]\n\nnormal = list(zip(keys, values))\nprint(\'zip:        \', normal)\n\nit = itertools.zip_longest(keys, values, fillvalue=\'nope\')\nlongest = list(it)\nprint(\'zip_longest:\', longest)\n\n>>>\nzip:         [(\'one\', 1), (\'two\', 2)]\nzip_longest: [(\'one\', 1), (\'two\', 2), (\'three\', \'nope\')]`, `47181806528134220000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\nkeys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'one\'</span><span class="token punctuation">,</span> <span class="token string">\'two\'</span><span class="token punctuation">,</span> <span class="token string">\'three\'</span><span class="token punctuation">]</span>\nvalues <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>\n\nnormal <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span>keys<span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'zip:        \'</span><span class="token punctuation">,</span> normal<span class="token punctuation">)</span>\n\nit <span class="token operator">=</span> itertools<span class="token punctuation">.</span>zip_longest<span class="token punctuation">(</span>keys<span class="token punctuation">,</span> values<span class="token punctuation">,</span> fillvalue<span class="token operator">=</span><span class="token string">\'nope\'</span><span class="token punctuation">)</span>\nlongest <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'zip_longest:\'</span><span class="token punctuation">,</span> longest<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token builtin">zip</span><span class="token punctuation">:</span>         <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'one\'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">\'two\'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\nzip_longest<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'one\'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">\'two\'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">\'three\'</span><span class="token punctuation">,</span> <span class="token string">\'nope\'</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="过滤源迭代器中的元素"><a href="#%E8%BF%87%E6%BB%A4%E6%BA%90%E8%BF%AD%E4%BB%A3%E5%99%A8%E4%B8%AD%E7%9A%84%E5%85%83%E7%B4%A0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>过滤源迭代器中的元素</h3>\n<p>Python 内置的 itertools 模块里有一些函数可以过滤源迭代器中的元素。</p>\n<h4 id="islice"><a href="#islice" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>islice</h4>\n<p>islice 可以在不拷贝数据的前提下，按照下标切割源迭代器。可以只给出切割的终点，也可以同时给出起点与终点，还可以指定步进值。这种切割方式与标准的序列切片及步进机制类似（参见第 11 条与第 12 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39340276991642910000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\nvalues = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]\nfirst_five = itertools.islice(values, 5)\nprint(\'First five: \', list(first_five))\nmiddle_odds = itertools.islice(values, 2, 8, 2)\nprint(\'Middle odds:\', list(middle_odds))\n\n>>>\nFirst five:  [1, 2, 3, 4, 5]\nMiddle odds: [3, 5, 7]`, `39340276991642910000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\nvalues <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\nfirst_five <span class="token operator">=</span> itertools<span class="token punctuation">.</span>islice<span class="token punctuation">(</span>values<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'First five: \'</span><span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">(</span>first_five<span class="token punctuation">)</span><span class="token punctuation">)</span>\nmiddle_odds <span class="token operator">=</span> itertools<span class="token punctuation">.</span>islice<span class="token punctuation">(</span>values<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Middle odds:\'</span><span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">(</span>middle_odds<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nFirst five<span class="token punctuation">:</span>  <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span>\nMiddle odds<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="takewhile"><a href="#takewhile" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>takewhile</h4>\n<p>takewhile 会一直从源迭代器里获取元素，直到某元素让测试函数返回 False 为止。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32022531733079830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\nvalues = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]\n\n\ndef less_than_seven(x):\n    return x < 7\n\n\nit = itertools.takewhile(less_than_seven, values)\nprint(list(it))\n\n>>>\n[1, 2, 3, 4, 5, 6]`, `32022531733079830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\nvalues <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\n\n\n<span class="token keyword">def</span> <span class="token function">less_than_seven</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> x <span class="token operator">&lt;</span> <span class="token number">7</span>\n\n\nit <span class="token operator">=</span> itertools<span class="token punctuation">.</span>takewhile<span class="token punctuation">(</span>less_than_seven<span class="token punctuation">,</span> values<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="dropwhile"><a href="#dropwhile" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>dropwhile</h4>\n<p>与 takewhile 相反，dropwhile 会一直跳过源序列里的元素，直到某元素让测试函数返回 True 为止，然后它会从这个地方开始逐个取值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34238368460681355000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\nvalues = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]\n\n\ndef less_than_seven(x):\n    return x < 7\n\n\nit = itertools.dropwhile(less_than_seven, values)\nprint(list(it))\n\n>>>\n[7, 8, 9, 10]`, `34238368460681355000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\nvalues <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\n\n\n<span class="token keyword">def</span> <span class="token function">less_than_seven</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> x <span class="token operator">&lt;</span> <span class="token number">7</span>\n\n\nit <span class="token operator">=</span> itertools<span class="token punctuation">.</span>dropwhile<span class="token punctuation">(</span>less_than_seven<span class="token punctuation">,</span> values<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="filterfalse"><a href="#filterfalse" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>filterfalse</h4>\n<p>filterfalse 和内置的 filter 函数相反，它会逐个输出源迭代器里使得测试函数返回 False 的那些元素。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27823846417375500000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\nvalues = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]\n\n\ndef evens(x):\n    return x % 2 == 0\n\n\nfilter_result = filter(evens, values)\nprint(\'Filter:      \', list(filter_result))\nfilter_false_result = itertools.filterfalse(evens, values)\nprint(\'Filter false:\', list(filter_false_result))\n\n>>>\nFilter:       [2, 4, 6, 8, 10]\nFilter false: [1, 3, 5, 7, 9]`, `27823846417375500000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\nvalues <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\n\n\n<span class="token keyword">def</span> <span class="token function">evens</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span>\n\n\nfilter_result <span class="token operator">=</span> <span class="token builtin">filter</span><span class="token punctuation">(</span>evens<span class="token punctuation">,</span> values<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Filter:      \'</span><span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">(</span>filter_result<span class="token punctuation">)</span><span class="token punctuation">)</span>\nfilter_false_result <span class="token operator">=</span> itertools<span class="token punctuation">.</span>filterfalse<span class="token punctuation">(</span>evens<span class="token punctuation">,</span> values<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Filter false:\'</span><span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">(</span>filter_false_result<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nFilter<span class="token punctuation">:</span>       <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\nFilter false<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="用源迭代器中的元素合成新元素"><a href="#%E7%94%A8%E6%BA%90%E8%BF%AD%E4%BB%A3%E5%99%A8%E4%B8%AD%E7%9A%84%E5%85%83%E7%B4%A0%E5%90%88%E6%88%90%E6%96%B0%E5%85%83%E7%B4%A0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>用源迭代器中的元素合成新元素</h3>\n<p>Python 内置的 itertools 模块里，有一些函数可以根据源迭代器中的元素合成新的元素。</p>\n<h4 id="accumulate"><a href="#accumulate" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>accumulate</h4>\n<p>accumulate 会从源迭代器里取出一个元素，并把已经累计的结果与这个元素一起传给表示累加逻辑的函数，然后输出那个函数的计算结果，并把结果当成新的累计值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38426535888212480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\nvalues = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]\nsum_reduce = itertools.accumulate(values)\nprint(\'Sum:   \', list(sum_reduce))\n\n\ndef sum_modulo_20(first, second):\n    output = first + second\n    return output % 20\n\n\nmodulo_reduce = itertools.accumulate(values, sum_modulo_20)\nprint(\'Modulo:\', list(modulo_reduce))\n\n>>>\nSum:    [1, 3, 6, 10, 15, 21, 28, 36, 45, 55]\nModulo: [1, 3, 6, 10, 15, 1, 8, 16, 5, 15]`, `38426535888212480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\nvalues <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\nsum_reduce <span class="token operator">=</span> itertools<span class="token punctuation">.</span>accumulate<span class="token punctuation">(</span>values<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Sum:   \'</span><span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">(</span>sum_reduce<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">def</span> <span class="token function">sum_modulo_20</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span> second<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    output <span class="token operator">=</span> first <span class="token operator">+</span> second\n    <span class="token keyword">return</span> output <span class="token operator">%</span> <span class="token number">20</span>\n\n\nmodulo_reduce <span class="token operator">=</span> itertools<span class="token punctuation">.</span>accumulate<span class="token punctuation">(</span>values<span class="token punctuation">,</span> sum_modulo_20<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Modulo:\'</span><span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">(</span>modulo_reduce<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nSum<span class="token punctuation">:</span>    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">45</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">]</span>\nModulo<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这与内置的 functools 模块中 reduce 函数，实际上是一样的，只不过这个函数每次只给出一项累计值。如果调用者没有指定表示累加逻辑的双参数函数（binary function），那么默认的逻辑就是两值相加。</p>\n<h4 id="product"><a href="#product" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>product</h4>\n<p>product 会从一个或多个源迭代器里获取元素，并计算笛卡尔积（Cartesian product），它可以取代那种多层嵌套的列表推导代码（参见第 28 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9625613241301668000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\nsingle = itertools.product([1, 2], repeat=2)\nprint(\'Single:  \', list(single))\n\nmultiple = itertools.product([1, 2], [\'a\', \'b\'])\nprint(\'Multiple:\', list(multiple))\n\n>>>\nSingle:   [(1, 1), (1, 2), (2, 1), (2, 2)]\nMultiple: [(1, \'a\'), (1, \'b\'), (2, \'a\'), (2, \'b\')]`, `9625613241301668000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\nsingle <span class="token operator">=</span> itertools<span class="token punctuation">.</span>product<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> repeat<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Single:  \'</span><span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">(</span>single<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\nmultiple <span class="token operator">=</span> itertools<span class="token punctuation">.</span>product<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Multiple:\'</span><span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">(</span>multiple<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nSingle<span class="token punctuation">:</span>   <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\nMultiple<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'a\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">\'a\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="permutations"><a href="#permutations" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>permutations</h4>\n<p>permutations 会考虑源迭代器所能给出的全部元素，并逐个输出由其中 N 个元素形成的每种有序排列（permutation）方式，元素相同但顺序不同，算作两种排列。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41073539429153750000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\nit = itertools.permutations([1, 2, 3, 4], 2)\nprint(list(it))\n\n>>>\n[(1, 2), (1, 3), (1, 4), (2, 1), (2, 3), (2, 4), (3, 1), (3, 2), (3, 4), (4, 1), (4, 2), (4, 3)]`, `41073539429153750000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\nit <span class="token operator">=</span> itertools<span class="token punctuation">.</span>permutations<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="combinations"><a href="#combinations" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>combinations</h4>\n<p>combinations 会考虑源迭代器所能给出的全部元素，并逐个输出由其中 N 个元素形成的每种无序组合（combination）方式，元素相同但顺序不同，算作同一种组合。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14920673664953133000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\nit = itertools.combinations([1, 2, 3, 4], 2)\nprint(list(it))\n\n>>>\n[(1, 2), (1, 3), (1, 4), (2, 3), (2, 4), (3, 4)]`, `14920673664953133000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\nit <span class="token operator">=</span> itertools<span class="token punctuation">.</span>combinations<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="combinations_with_replacement"><a href="#combinations_with_replacement" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code class="language-text">combinations_with_replacement</code></h4>\n<p><code class="language-text">combinations_with_replacement</code> 与 combinations 类似，但它允许同一个元素在组合里多次出现。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68590920284194110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\nit = itertools.combinations_with_replacement([1, 2, 3, 4], 2)\nprint(list(it))\n\n>>>\n[(1, 1), (1, 2), (1, 3), (1, 4), (2, 2), (2, 3), (2, 4), (3, 3), (3, 4), (4, 4)]`, `68590920284194110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\nit <span class="token operator">=</span> itertools<span class="token punctuation">.</span>combinations_with_replacement<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="总结-32"><a href="#%E6%80%BB%E7%BB%93-32" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>itertools 包里面有三套函数可以拼装迭代器与生成器，它们分别能够连接多个迭代器，过滤源迭代器中的元素，以及用源迭代器中的元素合成新元素。</li>\n<li>通过 help(itertools) 查看文档，了解这些函数所支持的其他参数，以及许多更为高级的函数和实用的代码范例。</li>\n</ol>\n<h1 id="类与接口"><a href="#%E7%B1%BB%E4%B8%8E%E6%8E%A5%E5%8F%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>类与接口</h1>\n<h2 id="第-37-条：用组合起来的类来实现多层结构，不要用嵌套的内置类型"><a href="#%E7%AC%AC-37-%E6%9D%A1%EF%BC%9A%E7%94%A8%E7%BB%84%E5%90%88%E8%B5%B7%E6%9D%A5%E7%9A%84%E7%B1%BB%E6%9D%A5%E5%AE%9E%E7%8E%B0%E5%A4%9A%E5%B1%82%E7%BB%93%E6%9E%84%EF%BC%8C%E4%B8%8D%E8%A6%81%E7%94%A8%E5%B5%8C%E5%A5%97%E7%9A%84%E5%86%85%E7%BD%AE%E7%B1%BB%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 37 条：用组合起来的类来实现多层结构，不要用嵌套的内置类型</h2>\n<p>Python 内置的字典类型，很适合维护对象在生命期内的动态内部状态。所谓动态的（dynamic），是指我们无法获知那套状态会用到哪些标识符。例如，如果要用成绩册（Gradebook）记录学生的分数，而我们又没办法提前确定这些学生的名字，那么受到记录的每位学生与各自的分数，对于 Gradebook 对象来说，就属于动态的内部状态。为了实现这个需求，笔者定义下面这样一个类，让它把学生的名字当作键保存到 <code class="language-text">_grades</code> 字典中，因为我们无法提前确定要记录哪些学生，所以不能将每位学生的名字都设置成这个类的一项属性。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72109761023716180000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class SimpleGradebook:\n\n    def __init__(self):\n        self._grades = {}\n\n    def add_student(self, name):\n        self._grades[name] = []\n\n    def report_grade(self, name, score):\n        self._grades[name].append(score)\n\n    def average_grade(self, name):\n        grades = self._grades[name]\n        return sum(grades) / len(grades)\n\n\nbook = SimpleGradebook()\nbook.add_student(\'Isaac Newton\')\nbook.report_grade(\'Isaac Newton\', 90)\nbook.report_grade(\'Isaac Newton\', 95)\nbook.report_grade(\'Isaac Newton\', 85)\n\nprint(book.average_grade(\'Isaac Newton\'))\n\n>>>\n90.0`, `72109761023716180000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">SimpleGradebook</span><span class="token punctuation">:</span>\n\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_grades <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n    <span class="token keyword">def</span> <span class="token function">add_student</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_grades<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n\n    <span class="token keyword">def</span> <span class="token function">report_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> score<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_grades<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>score<span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">average_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        grades <span class="token operator">=</span> self<span class="token punctuation">.</span>_grades<span class="token punctuation">[</span>name<span class="token punctuation">]</span>\n        <span class="token keyword">return</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>grades<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>grades<span class="token punctuation">)</span>\n\n\nbook <span class="token operator">=</span> SimpleGradebook<span class="token punctuation">(</span><span class="token punctuation">)</span>\nbook<span class="token punctuation">.</span>add_student<span class="token punctuation">(</span><span class="token string">\'Isaac Newton\'</span><span class="token punctuation">)</span>\nbook<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token string">\'Isaac Newton\'</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">)</span>\nbook<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token string">\'Isaac Newton\'</span><span class="token punctuation">,</span> <span class="token number">95</span><span class="token punctuation">)</span>\nbook<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token string">\'Isaac Newton\'</span><span class="token punctuation">,</span> <span class="token number">85</span><span class="token punctuation">)</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span>book<span class="token punctuation">.</span>average_grade<span class="token punctuation">(</span><span class="token string">\'Isaac Newton\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">90.0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>字典与相关的内置类型用起来很方便，但同时也容易遭到滥用导致代码出问题。例如，我们现在要扩展这个 SimpleGradebook 类的功能，让它按照科目保存成绩，而不是把所有科目的成绩存在一起。通过修改 <code class="language-text">_grades</code> 字典的用法，使它必须把键（也就是学生的名字）与另一个小字典相对应，而不是像刚才那样，直接与列表对应起来。那份小字典以各科的名称作键与一份列表对应起来，以保存学生在这一科的全部考试成绩。这次笔者用 defaultdict 来实现这个小字典，这样可以方便地处理科目名称还不存在的那些情况（参见第 17 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97502868492944770000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from collections import defaultdict\n\n\nclass BySubjectGradebook:\n    def __init__(self):\n        self._grades = {}  # Outer dict\n\n    def add_student(self, name):\n        self._grades[name] = defaultdict(list)  # Inner dict`, `97502868492944770000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> collections <span class="token keyword">import</span> defaultdict\n\n\n<span class="token keyword">class</span> <span class="token class-name">BySubjectGradebook</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_grades <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token comment"># Outer dict</span>\n\n    <span class="token keyword">def</span> <span class="token function">add_student</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_grades<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">)</span>  <span class="token comment"># Inner dict</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>程序写到现在，还算比较直观。但是接下来，我们要编写 <code class="language-text">report_grade</code> 方法来记录某位学生在某科目上的一次成绩，并且要写 <code class="language-text">average_grade</code> 方法计算某位学生所有科目的平均成绩。这两个方法写起来就稍微有点复杂了，因为必须处理多层嵌套的字典结构，不过，这似乎还在可以把握的范围内。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92501433756251390000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from collections import defaultdict\n\n\nclass BySubjectGradebook:\n    def __init__(self):\n        self._grades = {}  # Outer dict\n\n    def add_student(self, name):\n        self._grades[name] = defaultdict(list)  # Inner dict\n\n    def report_grade(self, name, subject, grade):\n        by_subject = self._grades[name]\n        grade_list = by_subject[subject]\n        grade_list.append(grade)\n\n    def average_grade(self, name):\n        by_subject = self._grades[name]\n        total, count = 0, 0\n        for grades in by_subject.values():\n            total += sum(grades)\n            count += len(grades)\n        return total / count`, `92501433756251390000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{11-22}"\n              >\n                <span class="gatsby-code-button-language">py{11-22}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> collections <span class="token keyword">import</span> defaultdict\n\n\n<span class="token keyword">class</span> <span class="token class-name">BySubjectGradebook</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_grades <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token comment"># Outer dict</span>\n\n    <span class="token keyword">def</span> <span class="token function">add_student</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_grades<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">)</span>  <span class="token comment"># Inner dict</span>\n\n<span class="gatsby-highlight-code-line">    <span class="token keyword">def</span> <span class="token function">report_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> subject<span class="token punctuation">,</span> grade<span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">        by_subject <span class="token operator">=</span> self<span class="token punctuation">.</span>_grades<span class="token punctuation">[</span>name<span class="token punctuation">]</span></span><span class="gatsby-highlight-code-line">        grade_list <span class="token operator">=</span> by_subject<span class="token punctuation">[</span>subject<span class="token punctuation">]</span></span><span class="gatsby-highlight-code-line">        grade_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>grade<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">    <span class="token keyword">def</span> <span class="token function">average_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">        by_subject <span class="token operator">=</span> self<span class="token punctuation">.</span>_grades<span class="token punctuation">[</span>name<span class="token punctuation">]</span></span><span class="gatsby-highlight-code-line">        total<span class="token punctuation">,</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">for</span> grades <span class="token keyword">in</span> by_subject<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">            total <span class="token operator">+=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>grades<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">            count <span class="token operator">+=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>grades<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">return</span> total <span class="token operator">/</span> count</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>扩展后的类，用起来依然比较容易。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34357981161697014000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`book = BySubjectGradebook()\nbook.add_student(\'Albert Einstein\')\nbook.report_grade(\'Albert Einstein\', \'Math\', 75)\nbook.report_grade(\'Albert Einstein\', \'Math\', 65)\nbook.report_grade(\'Albert Einstein\', \'Gym\', 90)\nbook.report_grade(\'Albert Einstein\', \'Gym\', 95)\nprint(book.average_grade(\'Albert Einstein\'))\n\n>>>\n81.25`, `34357981161697014000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">book <span class="token operator">=</span> BySubjectGradebook<span class="token punctuation">(</span><span class="token punctuation">)</span>\nbook<span class="token punctuation">.</span>add_student<span class="token punctuation">(</span><span class="token string">\'Albert Einstein\'</span><span class="token punctuation">)</span>\nbook<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token string">\'Albert Einstein\'</span><span class="token punctuation">,</span> <span class="token string">\'Math\'</span><span class="token punctuation">,</span> <span class="token number">75</span><span class="token punctuation">)</span>\nbook<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token string">\'Albert Einstein\'</span><span class="token punctuation">,</span> <span class="token string">\'Math\'</span><span class="token punctuation">,</span> <span class="token number">65</span><span class="token punctuation">)</span>\nbook<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token string">\'Albert Einstein\'</span><span class="token punctuation">,</span> <span class="token string">\'Gym\'</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">)</span>\nbook<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token string">\'Albert Einstein\'</span><span class="token punctuation">,</span> <span class="token string">\'Gym\'</span><span class="token punctuation">,</span> <span class="token number">95</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>book<span class="token punctuation">.</span>average_grade<span class="token punctuation">(</span><span class="token string">\'Albert Einstein\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">81.25</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在假设需求又变了，我们还要记录每次考试在科目里的权重（weight），因为期中考试与期末考试及随堂举行的临时考试（pop quiz）在总成绩里占的比例是不同的。实现这项功能的一种办法是改变里面那个小字典的用法，让它不要把成绩（score）直接添加到与键名（也就科目名称）相对应的那份列表里，而是先用成绩与权重构造元组，然后把（score, weight）形式的元组添加到列表里。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6255586521496870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from collections import defaultdict\n\n\nclass WeightedGradebook:\n    def __init__(self):\n        self._grades = {}\n\n    def add_student(self, name):\n        self._grades[name] = defaultdict(list)\n\n    def report_grade(self, name, subject, score, weight):\n        by_subject = self._grades[name]\n        grade_list = by_subject[subject]\n        grade_list.append((score, weight))`, `6255586521496870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> collections <span class="token keyword">import</span> defaultdict\n\n\n<span class="token keyword">class</span> <span class="token class-name">WeightedGradebook</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_grades <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n    <span class="token keyword">def</span> <span class="token function">add_student</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_grades<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">report_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> subject<span class="token punctuation">,</span> score<span class="token punctuation">,</span> weight<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        by_subject <span class="token operator">=</span> self<span class="token punctuation">.</span>_grades<span class="token punctuation">[</span>name<span class="token punctuation">]</span>\n        grade_list <span class="token operator">=</span> by_subject<span class="token punctuation">[</span>subject<span class="token punctuation">]</span>\n        grade_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>score<span class="token punctuation">,</span> weight<span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><code class="language-text">report_grade</code> 方法改起来似乎挺简单的，只需要把原来的成绩变为带权重的元组保存到列表里面即可。但是 <code class="language-text">average_grade</code> 方法就比较难懂了，因为我们必须在循环里面再嵌套一个循环。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13308488374776273000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from collections import defaultdict\n\n\nclass WeightedGradebook:\n    def __init__(self):\n        self._grades = {}\n\n    def add_student(self, name):\n        self._grades[name] = defaultdict(list)\n\n    def report_grade(self, name, subject, score, weight):\n        by_subject = self._grades[name]\n        grade_list = by_subject[subject]\n        grade_list.append((score, weight))\n\n    def average_grade(self, name):\n        by_subject = self._grades[name]\n        score_sum, score_count = 0, 0\n        for subject, scores in by_subject.items():\n            subject_avg, total_weight = 0, 0\n            for score, weight in scores:\n                subject_avg += score * weight\n                total_weight += weight\n\n            score_sum += subject_avg / total_weight\n            score_count += 1\n        return score_sum / score_count\n\n\nbook = WeightedGradebook()\nbook.add_student(\'Albert Einstein\')\nbook.report_grade(\'Albert Einstein\', \'Math\', 75, 0.05)\nbook.report_grade(\'Albert Einstein\', \'Math\', 65, 0.15)\nbook.report_grade(\'Albert Einstein\', \'Math\', 70, 0.80)\nbook.report_grade(\'Albert Einstein\', \'Gym\', 100, 0.40)\nbook.report_grade(\'Albert Einstein\', \'Gym\', 85, 0.60)\nprint(book.average_grade(\'Albert Einstein\'))\n\n>>>\n80.25`, `13308488374776273000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> collections <span class="token keyword">import</span> defaultdict\n\n\n<span class="token keyword">class</span> <span class="token class-name">WeightedGradebook</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_grades <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n    <span class="token keyword">def</span> <span class="token function">add_student</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_grades<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">report_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> subject<span class="token punctuation">,</span> score<span class="token punctuation">,</span> weight<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        by_subject <span class="token operator">=</span> self<span class="token punctuation">.</span>_grades<span class="token punctuation">[</span>name<span class="token punctuation">]</span>\n        grade_list <span class="token operator">=</span> by_subject<span class="token punctuation">[</span>subject<span class="token punctuation">]</span>\n        grade_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>score<span class="token punctuation">,</span> weight<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">average_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        by_subject <span class="token operator">=</span> self<span class="token punctuation">.</span>_grades<span class="token punctuation">[</span>name<span class="token punctuation">]</span>\n        score_sum<span class="token punctuation">,</span> score_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>\n        <span class="token keyword">for</span> subject<span class="token punctuation">,</span> scores <span class="token keyword">in</span> by_subject<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            subject_avg<span class="token punctuation">,</span> total_weight <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>\n            <span class="token keyword">for</span> score<span class="token punctuation">,</span> weight <span class="token keyword">in</span> scores<span class="token punctuation">:</span>\n                subject_avg <span class="token operator">+=</span> score <span class="token operator">*</span> weight\n                total_weight <span class="token operator">+=</span> weight\n\n            score_sum <span class="token operator">+=</span> subject_avg <span class="token operator">/</span> total_weight\n            score_count <span class="token operator">+=</span> <span class="token number">1</span>\n        <span class="token keyword">return</span> score_sum <span class="token operator">/</span> score_count\n\n\nbook <span class="token operator">=</span> WeightedGradebook<span class="token punctuation">(</span><span class="token punctuation">)</span>\nbook<span class="token punctuation">.</span>add_student<span class="token punctuation">(</span><span class="token string">\'Albert Einstein\'</span><span class="token punctuation">)</span>\nbook<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token string">\'Albert Einstein\'</span><span class="token punctuation">,</span> <span class="token string">\'Math\'</span><span class="token punctuation">,</span> <span class="token number">75</span><span class="token punctuation">,</span> <span class="token number">0.05</span><span class="token punctuation">)</span>\nbook<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token string">\'Albert Einstein\'</span><span class="token punctuation">,</span> <span class="token string">\'Math\'</span><span class="token punctuation">,</span> <span class="token number">65</span><span class="token punctuation">,</span> <span class="token number">0.15</span><span class="token punctuation">)</span>\nbook<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token string">\'Albert Einstein\'</span><span class="token punctuation">,</span> <span class="token string">\'Math\'</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">,</span> <span class="token number">0.80</span><span class="token punctuation">)</span>\nbook<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token string">\'Albert Einstein\'</span><span class="token punctuation">,</span> <span class="token string">\'Gym\'</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">0.40</span><span class="token punctuation">)</span>\nbook<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token string">\'Albert Einstein\'</span><span class="token punctuation">,</span> <span class="token string">\'Gym\'</span><span class="token punctuation">,</span> <span class="token number">85</span><span class="token punctuation">,</span> <span class="token number">0.60</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>book<span class="token punctuation">.</span>average_grade<span class="token punctuation">(</span><span class="token string">\'Albert Einstein\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">80.25</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个类用起来也变得困难了，因为单看代码很难知道 <code class="language-text">report_grade</code> 里面那些数字形式的位置参数表示什么意思。</p>\n<p>如果遇到的是类似这种比较复杂的需求，那么不要再嵌套字典、元组、集合、列表等内置的类型了，而是应该编写一批新类并让这些类形成一套体系。</p>\n<p>拿这个成绩册的例子来说，一开始我们并不知道后来要考虑成绩权重，所以那个时候似乎没有必要专门创建这样一套类体系。后来，当要纳入权重因素时，有人认为，这可以继续通过 Python 内置的字典与元组来实现，因为只不过是要给保存内部状态的那个结构多添加一层而已。所以，才有了刚才那种复杂的写法。其实，在需要分科目统计成绩时，就不应该继续嵌套下去了，那样会让字典里出现小字典，而小字典里又会出现列表。这种超过两层的嵌套结构，其他开发者很难看懂，而且后面维护起来也很麻烦。</p>\n<p>只要发现记录内部状态的代码开始变得复杂起来，就应该及时把这些代码拆分到多个类里。这样可以定义良好的接口，并且能够合理地封装数据。这种写法可以在接口与具体实现之间创建一层抽象。</p>\n<h3 id="把多层嵌套的内置类型重构为类体系"><a href="#%E6%8A%8A%E5%A4%9A%E5%B1%82%E5%B5%8C%E5%A5%97%E7%9A%84%E5%86%85%E7%BD%AE%E7%B1%BB%E5%9E%8B%E9%87%8D%E6%9E%84%E4%B8%BA%E7%B1%BB%E4%BD%93%E7%B3%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>把多层嵌套的内置类型重构为类体系</h3>\n<p>有很多种办法可以实现重构（除了这里讲的这种，第 89 条还讲了另一种）。笔者这里采用的办法是，先从依赖树的最底层做起，也就是考虑怎么记录某科目的单次考试成绩与权重。这么简单的一条信息，似乎没必要专门写一个类来记录。由于分数不需要修改，因此元组已经足够用了。下面以（score, weight）形式的元组来记录单次考试成绩，并把这种元素添加到列表里面。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65104266246728580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`grades = []\ngrades.append((95, 0.45))\ngrades.append((85, 0.55))\ntotal = sum(score * weight for score, weight in grades)\ntotal_weight = sum(weight for _, weight in grades)\naverage_grade = total / total_weight`, `65104266246728580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">grades <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\ngrades<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">95</span><span class="token punctuation">,</span> <span class="token number">0.45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\ngrades<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">85</span><span class="token punctuation">,</span> <span class="token number">0.55</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\ntotal <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>score <span class="token operator">*</span> weight <span class="token keyword">for</span> score<span class="token punctuation">,</span> weight <span class="token keyword">in</span> grades<span class="token punctuation">)</span>\ntotal_weight <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>weight <span class="token keyword">for</span> _<span class="token punctuation">,</span> weight <span class="token keyword">in</span> grades<span class="token punctuation">)</span>\naverage_grade <span class="token operator">=</span> total <span class="token operator">/</span> total_weight</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>汇总每次考试的权重之和（<code class="language-text">total * weight</code>）时，不需要关注具体的成绩，所以在 <code class="language-text">for ... in ...</code> 结构中用下划线（<code class="language-text">*</code>）表示元组中的 score 那一部分，表示计算时忽略它。</p>\n<p>这种写法的问题在于，元组里的元素只能通过位置区分。例如，如果还要把老师的评语记在每次考试的成绩旁边，那么早前使用二元组的那些代码就全都需要修改，因为现在必须采用包含三个元素的元组才行。另外，统计成绩之和与权重之和时，还得分别用一个下划线跳过每个三元组里面表示评语的那一部分。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74081453694787270000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`grades = []\ngrades.append((95, 0.45, \'Great job\'))\ngrades.append((85, 0.55, \'Better next time\'))\ntotal = sum(score * weight for score, weight, _ in grades)\ntotal_weight = sum(weight for _, weight, _ in grades)\naverage_grade = total / total_weight`, `74081453694787270000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">grades <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\ngrades<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">95</span><span class="token punctuation">,</span> <span class="token number">0.45</span><span class="token punctuation">,</span> <span class="token string">\'Great job\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\ngrades<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">85</span><span class="token punctuation">,</span> <span class="token number">0.55</span><span class="token punctuation">,</span> <span class="token string">\'Better next time\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\ntotal <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>score <span class="token operator">*</span> weight <span class="token keyword">for</span> score<span class="token punctuation">,</span> weight<span class="token punctuation">,</span> _ <span class="token keyword">in</span> grades<span class="token punctuation">)</span>\ntotal_weight <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>weight <span class="token keyword">for</span> _<span class="token punctuation">,</span> weight<span class="token punctuation">,</span> _ <span class="token keyword">in</span> grades<span class="token punctuation">)</span>\naverage_grade <span class="token operator">=</span> total <span class="token operator">/</span> total_weight</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>元组拖得太长，就跟字典套得太深一样，都不好维护。所以只要发现元组里的元素超过两个，就应该考虑其他办法了。</p>\n<p>Python 内置的 collections 模块里有个具名元组（namedtuple）类型，恰好可以满足这样的需求，这种类型很容易就能定义出小型的类以表示不可变的数据。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48926914902387294000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from collections import namedtuple\n\nGrade = namedtuple(\'Grade\', (\'score\', \'weight\'))`, `48926914902387294000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> collections <span class="token keyword">import</span> namedtuple\n\nGrade <span class="token operator">=</span> namedtuple<span class="token punctuation">(</span><span class="token string">\'Grade\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">\'score\'</span><span class="token punctuation">,</span> <span class="token string">\'weight\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>这样的类，既可以通过位置参数构造，也可以用关键字参数来创建。每个属性都有名字，因此可以根据属性名称访问字段，如果将来需求发生变化（例如需要修改数据，或是要转变成一个简单的数据容器），也很容易就能把这种 namedtuple 改写成普通的类。</p>\n<h3 id="namedtuple-的局限"><a href="#namedtuple-%E7%9A%84%E5%B1%80%E9%99%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>namedtuple 的局限</h3>\n<p>虽然 namedtuple 可以用于许多场合，但我们一定要知道在哪些情况下不适合用它。</p>\n<ol>\n<li>namedtuple 类无法指定默认的参数值。如果数据的可选属性比较多，那么采用这种类来表示，会很不方便。在属性较多的情况下，应该改用内置的 dataclasses 模块实现。</li>\n<li>namedtuple 实例的属性值仍然可以通过数字下标与迭代来访问，所以可能还是会有人（尤其是那些通过你发布的 API 来编程的人）会采用这种方式访问这些属性，这样的话，将来就不太容易把它转成普通的类了。如果无法完全控制这些 namedtuple 实例的用法，那么最好还是明确定义一个新的类。</li>\n</ol>\n<p>有了叫作 Grade 的具名元组，我们就可以写出表示科目的 Subject 类，让它容纳许多个这样的元组。</p>\n<p>然后，就可以写一个表示学生的 Student 类，用它来记录某位学生各科目（Subject）的考试成绩。</p>\n<p>最后，写这样一个表示成绩册的 Gradebook 容器类，把每位学生的名字与表示这位学生的 Student 对象关联起来，如果成绩册里还没有记录过这位学生，那么在调用 <code class="language-text">get_student</code> 方法时，Gradebook 就会构造一个默认的 Student 对象给调用者使用。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96346864556382130000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from collections import namedtuple, defaultdict\n\nGrade = namedtuple(\'Grade\', (\'score\', \'weight\'))\n\n\nclass Subject:\n    def __init__(self):\n        self._grades = []\n\n    def report_grade(self, score, weight):\n        self._grades.append(Grade(score, weight))\n\n    def average_grade(self):\n        total, total_weight = 0, 0\n        for grade in self._grades:\n            total += grade.score * grade.weight\n            total_weight += grade.weight\n        return total / total_weight\n\n\nclass Student:\n    def __init__(self):\n        self._subjects = defaultdict(Subject)\n\n    def get_subject(self, name):\n        return self._subjects[name]\n\n    def average_grade(self):\n        total, count = 0, 0\n        for subject in self._subjects.values():\n            total += subject.average_grade()\n            count += 1\n        return total / count\n\n\nclass Gradebook:\n    def __init__(self):\n        self._students = defaultdict(Student)\n\n    def get_student(self, name):\n        return self._students[name]\n\n\nbook = Gradebook()\nalbert = book.get_student(\'Albert Einstein\')\nmath = albert.get_subject(\'Math\')\nmath.report_grade(75, 0.05)\nmath.report_grade(65, 0.15)\nmath.report_grade(70, 0.80)\ngym = albert.get_subject(\'Gym\')\ngym.report_grade(100, 0.40)\ngym.report_grade(85, 0.60)\nprint(albert.average_grade())\n\n>>>\n80.25`, `96346864556382130000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> collections <span class="token keyword">import</span> namedtuple<span class="token punctuation">,</span> defaultdict\n\nGrade <span class="token operator">=</span> namedtuple<span class="token punctuation">(</span><span class="token string">\'Grade\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">\'score\'</span><span class="token punctuation">,</span> <span class="token string">\'weight\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Subject</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_grades <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n\n    <span class="token keyword">def</span> <span class="token function">report_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> score<span class="token punctuation">,</span> weight<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_grades<span class="token punctuation">.</span>append<span class="token punctuation">(</span>Grade<span class="token punctuation">(</span>score<span class="token punctuation">,</span> weight<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">average_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        total<span class="token punctuation">,</span> total_weight <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>\n        <span class="token keyword">for</span> grade <span class="token keyword">in</span> self<span class="token punctuation">.</span>_grades<span class="token punctuation">:</span>\n            total <span class="token operator">+=</span> grade<span class="token punctuation">.</span>score <span class="token operator">*</span> grade<span class="token punctuation">.</span>weight\n            total_weight <span class="token operator">+=</span> grade<span class="token punctuation">.</span>weight\n        <span class="token keyword">return</span> total <span class="token operator">/</span> total_weight\n\n\n<span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_subjects <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span>Subject<span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">get_subject</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_subjects<span class="token punctuation">[</span>name<span class="token punctuation">]</span>\n\n    <span class="token keyword">def</span> <span class="token function">average_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        total<span class="token punctuation">,</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>\n        <span class="token keyword">for</span> subject <span class="token keyword">in</span> self<span class="token punctuation">.</span>_subjects<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            total <span class="token operator">+=</span> subject<span class="token punctuation">.</span>average_grade<span class="token punctuation">(</span><span class="token punctuation">)</span>\n            count <span class="token operator">+=</span> <span class="token number">1</span>\n        <span class="token keyword">return</span> total <span class="token operator">/</span> count\n\n\n<span class="token keyword">class</span> <span class="token class-name">Gradebook</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_students <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span>Student<span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">get_student</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_students<span class="token punctuation">[</span>name<span class="token punctuation">]</span>\n\n\nbook <span class="token operator">=</span> Gradebook<span class="token punctuation">(</span><span class="token punctuation">)</span>\nalbert <span class="token operator">=</span> book<span class="token punctuation">.</span>get_student<span class="token punctuation">(</span><span class="token string">\'Albert Einstein\'</span><span class="token punctuation">)</span>\nmath <span class="token operator">=</span> albert<span class="token punctuation">.</span>get_subject<span class="token punctuation">(</span><span class="token string">\'Math\'</span><span class="token punctuation">)</span>\nmath<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token number">75</span><span class="token punctuation">,</span> <span class="token number">0.05</span><span class="token punctuation">)</span>\nmath<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token number">65</span><span class="token punctuation">,</span> <span class="token number">0.15</span><span class="token punctuation">)</span>\nmath<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token number">70</span><span class="token punctuation">,</span> <span class="token number">0.80</span><span class="token punctuation">)</span>\ngym <span class="token operator">=</span> albert<span class="token punctuation">.</span>get_subject<span class="token punctuation">(</span><span class="token string">\'Gym\'</span><span class="token punctuation">)</span>\ngym<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">0.40</span><span class="token punctuation">)</span>\ngym<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token number">85</span><span class="token punctuation">,</span> <span class="token number">0.60</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>albert<span class="token punctuation">.</span>average_grade<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">80.25</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这些类的代码所占篇幅，虽然比原来那种写法长了一倍，但理解起来却要容易得多。而且用这些类写出来的调用代码，也比原来更清晰、更便于扩展。</p>\n<p>另外，还可以提供一些向后兼容的方法，帮助大家把采用旧式 API 所写的代码迁移到这种通过对象体系所设计的方案之中。</p>\n<h3 id="总结-33"><a href="#%E6%80%BB%E7%BB%93-33" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>不要在字典里嵌套字典、长元组，以及用其他内置类型构造的复杂结构。</li>\n<li>namedtuple 能够实现出轻量级的容器，以存放不可变的数据，而且将来可以灵活地转化成普通的类。</li>\n<li>如果发现用字典来维护内部状态的那些代码已经越写越复杂了，那么就应该考虑改用多个类来实现。</li>\n</ol>\n<h2 id="第-38-条：让简单的接口接受函数，而不是类的实例"><a href="#%E7%AC%AC-38-%E6%9D%A1%EF%BC%9A%E8%AE%A9%E7%AE%80%E5%8D%95%E7%9A%84%E6%8E%A5%E5%8F%A3%E6%8E%A5%E5%8F%97%E5%87%BD%E6%95%B0%EF%BC%8C%E8%80%8C%E4%B8%8D%E6%98%AF%E7%B1%BB%E7%9A%84%E5%AE%9E%E4%BE%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 38 条：让简单的接口接受函数，而不是类的实例</h2>\n<p>Python 有许多内置的 API，都允许我们传入某个函数来定制它的行为。这种函数可以叫作挂钩（hook），API 在执行过程中，会回调（call back）这些挂钩函数。例如，list 类型的 sort 方法就带有可选的 key 参数，如果明确指定了这个参数，那么它就会按照你提供的挂钩函数来决定列表中每个元素的先后顺序（参见第 14 条）。下面的代码把内置的 len 函数当成挂钩传给 key 参数，让 sort 方法根据长度排列这些名字。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35346045143491465000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`names = [\'Socrates\', \'Archimedes\', \'Plato\', \'Aristotle\']\nnames.sort(key=len)\nprint(names)\n\n>>>\n[\'Plato\', \'Socrates\', \'Aristotle\', \'Archimedes\']`, `35346045143491465000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'Socrates\'</span><span class="token punctuation">,</span> <span class="token string">\'Archimedes\'</span><span class="token punctuation">,</span> <span class="token string">\'Plato\'</span><span class="token punctuation">,</span> <span class="token string">\'Aristotle\'</span><span class="token punctuation">]</span>\nnames<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>names<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token string">\'Plato\'</span><span class="token punctuation">,</span> <span class="token string">\'Socrates\'</span><span class="token punctuation">,</span> <span class="token string">\'Aristotle\'</span><span class="token punctuation">,</span> <span class="token string">\'Archimedes\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在其他编程语言中，挂钩可能会用抽象类（abstract class）来定义。但在 Python 中，许多挂钩都是无状态的函数（stateless function），带有明确的参数与返回值。挂钩用函数来描述，要比定义成类更简单。用作挂钩的函数与别的函数一样，都是 Python 里的头等（first-class）对象，也就是说，这些函数与方法可以像 Python 中其他值那样传递与引用。</p>\n<p>例如，我们要定制 defaultdict 类的行为（相关的知识，参见第 17 条）。这种 defaultdict 数据结构允许调用者提供一个函数，用来在键名缺失的情况下，创建与这个键相对应的值。只要字典发现调用者想要访问的键不存在，就会触发这个函数，以返回应该与键相关联的默认值。下面定义一个 <code class="language-text">log_missing</code> 函数作为键名缺失时的挂钩，该函数总是会把这种键的默认值设为 0。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27540891122785860000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def log_missing():\n    print(\'Key added\')\n    return 0`, `27540891122785860000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">log_missing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Key added\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">return</span> <span class="token number">0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>下面这段代码通过定制的 defaultdict 字典，把 increments 列表里面描述的增量添加到 current 这个普通字典所提供的初始量上面，但字典里一开始没有 red 和 orange 这两个键，因此 <code class="language-text">log_missing</code> 这个挂钩函数会触发两次，每次它都会打印 Key added 信息。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63139769059205460000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from collections import defaultdict\n\n\ndef log_missing():\n    print(\'Key added\')\n    return 0\n\n\ncurrent = {\'green\': 12, \'blue\': 3}\nincrements = [\n    (\'red\', 5),\n    (\'blue\', 17),\n    (\'orange\', 9),\n]\nresult = defaultdict(log_missing, current)\nprint(\'Before:\', dict(result))\nfor key, amount in increments:\n    result[key] += amount\nprint(\'After:\', dict(result))\n\n>>>\nBefore: {\'green\': 12, \'blue\': 3}\nKey added\nKey added\nAfter: {\'green\': 12, \'blue\': 20, \'red\': 5, \'orange\': 9}`, `63139769059205460000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> collections <span class="token keyword">import</span> defaultdict\n\n\n<span class="token keyword">def</span> <span class="token function">log_missing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Key added\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">return</span> <span class="token number">0</span>\n\n\ncurrent <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">\'green\'</span><span class="token punctuation">:</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token string">\'blue\'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">}</span>\nincrements <span class="token operator">=</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">(</span><span class="token string">\'red\'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">(</span><span class="token string">\'blue\'</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">(</span><span class="token string">\'orange\'</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">]</span>\nresult <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span>log_missing<span class="token punctuation">,</span> current<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Before:\'</span><span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">for</span> key<span class="token punctuation">,</span> amount <span class="token keyword">in</span> increments<span class="token punctuation">:</span>\n    result<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">+=</span> amount\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After:\'</span><span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'green\'</span><span class="token punctuation">:</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token string">\'blue\'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">}</span>\nKey added\nKey added\nAfter<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'green\'</span><span class="token punctuation">:</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token string">\'blue\'</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">\'red\'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">\'orange\'</span><span class="token punctuation">:</span> <span class="token number">9</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>通过 <code class="language-text">log_missing</code> 这样的挂钩函数，我们很容易构建出便于测试的 API，这种 API 可以把挂钩所实现的附加效果（side effect）与数据本身所应具备的确定行为分开。例如，假设我们要在传给 defaultdict 的挂钩里面，统计它总共遇到了多少次键名缺失的情况。要实现这项功能，其中一个办法是采用有状态的闭包（stateful closure，参见第 21 条）。下面就定义一个辅助函数，把 missing 闭包当作挂钩传给 defaultdict 字典，以便为缺失的键提供默认值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56553682761349000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def increment_with_report(current, increments):\n    added_count = 0\n\n    def missing():\n        nonlocal added_count  # Stateful closure\n        added_count += 1\n        return 0\n\n    result = defaultdict(missing, current)\n    for key, amount in increments:\n        result[key] += amount\n\n    return result, added_count`, `56553682761349000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">increment_with_report</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> increments<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    added_count <span class="token operator">=</span> <span class="token number">0</span>\n\n    <span class="token keyword">def</span> <span class="token function">missing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">nonlocal</span> added_count  <span class="token comment"># Stateful closure</span>\n        added_count <span class="token operator">+=</span> <span class="token number">1</span>\n        <span class="token keyword">return</span> <span class="token number">0</span>\n\n    result <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span>missing<span class="token punctuation">,</span> current<span class="token punctuation">)</span>\n    <span class="token keyword">for</span> key<span class="token punctuation">,</span> amount <span class="token keyword">in</span> increments<span class="token punctuation">:</span>\n        result<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">+=</span> amount\n\n    <span class="token keyword">return</span> result<span class="token punctuation">,</span> added_count</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>运行这个辅助函数处理前面的数据，可以得到预期的结果（可以看到，键名缺失的情况确实出现了两次，函数返回的 count 值也为 2）。统计键名缺失次数所用的 <code class="language-text">added_count</code> 状态是由 missing 挂钩维护的，采用挂钩来运作的 defaultdict 字典并不需要关注这个细节。于是，这就体现了把简单函数传给接口的另一个好处，也就是方便稍后添加新的功能，因为我们可以把实现这项功能所用的状态隐藏在这个简单的闭包里面。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69883551923980810000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from collections import defaultdict\n\n\ndef increment_with_report(current, increments):\n    added_count = 0\n\n    def missing():\n        nonlocal added_count  # Stateful closure\n        added_count += 1\n        return 0\n\n    result = defaultdict(missing, current)\n    for key, amount in increments:\n        result[key] += amount\n\n    return result, added_count\n\n\ncurrent = {\'green\': 12, \'blue\': 3}\nincrements = [\n    (\'red\', 5),\n    (\'blue\', 17),\n    (\'orange\', 9),\n]\nresult, count = increment_with_report(current, increments)\nassert count == 2`, `69883551923980810000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{25-26}"\n              >\n                <span class="gatsby-code-button-language">py{25-26}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> collections <span class="token keyword">import</span> defaultdict\n\n\n<span class="token keyword">def</span> <span class="token function">increment_with_report</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> increments<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    added_count <span class="token operator">=</span> <span class="token number">0</span>\n\n    <span class="token keyword">def</span> <span class="token function">missing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">nonlocal</span> added_count  <span class="token comment"># Stateful closure</span>\n        added_count <span class="token operator">+=</span> <span class="token number">1</span>\n        <span class="token keyword">return</span> <span class="token number">0</span>\n\n    result <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span>missing<span class="token punctuation">,</span> current<span class="token punctuation">)</span>\n    <span class="token keyword">for</span> key<span class="token punctuation">,</span> amount <span class="token keyword">in</span> increments<span class="token punctuation">:</span>\n        result<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">+=</span> amount\n\n    <span class="token keyword">return</span> result<span class="token punctuation">,</span> added_count\n\n\ncurrent <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">\'green\'</span><span class="token punctuation">:</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token string">\'blue\'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">}</span>\nincrements <span class="token operator">=</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">(</span><span class="token string">\'red\'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">(</span><span class="token string">\'blue\'</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">(</span><span class="token string">\'orange\'</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">]</span>\n<span class="gatsby-highlight-code-line">result<span class="token punctuation">,</span> count <span class="token operator">=</span> increment_with_report<span class="token punctuation">(</span>current<span class="token punctuation">,</span> increments<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">assert</span> count <span class="token operator">==</span> <span class="token number">2</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>与无状态的闭包函数相比，用有状态的闭包作为挂钩写出来的代码会难懂一些。为了让代码更清晰，可以专门定义一个小类，把原本由闭包所维护的状态给封装起来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10705255127180968000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class CountMissing:\n    def __init__(self):\n        self.added = 0\n\n    def missing(self):\n        self.added += 1\n        return 0`, `10705255127180968000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">CountMissing</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>added <span class="token operator">=</span> <span class="token number">0</span>\n\n    <span class="token keyword">def</span> <span class="token function">missing</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>added <span class="token operator">+=</span> <span class="token number">1</span>\n        <span class="token keyword">return</span> <span class="token number">0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在其他编程语言中，可能需要修改 defaultdict 以便与 CountMissing 接口相适应。但在 Python 中，方法与函数都是头等的（first-class）对象，因此可以直接通过对象引用它所属的 CountMissing 类里的 missing 方法，并把这个方法传给 defaultdict 充当挂钩，让字典可以用这个挂钩制作默认值。在 Python 中，这种通过对象实例而引用的方法，很容易就能满足函数的接口</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38932299168852170000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from collections import defaultdict\n\n\nclass CountMissing:\n    def __init__(self):\n        self.added = 0\n\n    def missing(self):\n        self.added += 1\n        return 0\n\n\ncurrent = {\'green\': 12, \'blue\': 3}\nincrements = [\n    (\'red\', 5),\n    (\'blue\', 17),\n    (\'orange\', 9),\n]\ncounter = CountMissing()\nresult = defaultdict(counter.missing, current)  # Method ref\nfor key, amount in increments:\n    result[key] += amount\nassert counter.added == 2`, `38932299168852170000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{19-23}"\n              >\n                <span class="gatsby-code-button-language">py{19-23}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> collections <span class="token keyword">import</span> defaultdict\n\n\n<span class="token keyword">class</span> <span class="token class-name">CountMissing</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>added <span class="token operator">=</span> <span class="token number">0</span>\n\n    <span class="token keyword">def</span> <span class="token function">missing</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>added <span class="token operator">+=</span> <span class="token number">1</span>\n        <span class="token keyword">return</span> <span class="token number">0</span>\n\n\ncurrent <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">\'green\'</span><span class="token punctuation">:</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token string">\'blue\'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">}</span>\nincrements <span class="token operator">=</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">(</span><span class="token string">\'red\'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">(</span><span class="token string">\'blue\'</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">(</span><span class="token string">\'orange\'</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">]</span>\n<span class="gatsby-highlight-code-line">counter <span class="token operator">=</span> CountMissing<span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">result <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span>counter<span class="token punctuation">.</span>missing<span class="token punctuation">,</span> current<span class="token punctuation">)</span>  <span class="token comment"># Method ref</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">for</span> key<span class="token punctuation">,</span> amount <span class="token keyword">in</span> increments<span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">    result<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">+=</span> amount</span><span class="gatsby-highlight-code-line"><span class="token keyword">assert</span> counter<span class="token punctuation">.</span>added <span class="token operator">==</span> <span class="token number">2</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>把有状态的闭包所具备的行为，改用辅助类来实现，要比前面的 <code class="language-text">increment_with_report</code> 函数更清晰。但如果单看这个类，可能没办法立刻了解它的意图。CountMissing 对象应该由谁构造？missing 方法应该由谁调用？这个类将来还会不会再增加 public 方法？这些疑惑都必须在看到 defaultdict 的用法之后才能解开。</p>\n<p>为了让这个类的意义更加明确，可以给它定义名为 <code class="language-text">__call__</code> 的特殊方法。这会让这个类的对象能够像函数那样得到调用。同时，也让内置的 callable 函数能够针对这种实例返回 True 值，用以表示这个实例与普通的函数或方法类似，都是可调用的。凡是能够像这样（在后面加一对括号来）执行的对象，都叫作 callable。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81452601834957640000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class BetterCountMissing:\n    def __init__(self):\n        self.added = 0\n\n    def __call__(self):\n        self.added += 1\n        return 0\n\n\ncounter = BetterCountMissing()\nassert counter() == 0\nassert callable(counter)`, `81452601834957640000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">BetterCountMissing</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>added <span class="token operator">=</span> <span class="token number">0</span>\n\n    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>added <span class="token operator">+=</span> <span class="token number">1</span>\n        <span class="token keyword">return</span> <span class="token number">0</span>\n\n\ncounter <span class="token operator">=</span> BetterCountMissing<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">assert</span> counter<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>\n<span class="token keyword">assert</span> <span class="token builtin">callable</span><span class="token punctuation">(</span>counter<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>下面，就用这样的 BetterCountMissing 实例给 defaultdict 当挂钩，让它在字典里没有键名时，创建默认的键值，并把这种情况记入键名缺失的总次数里。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75608176928165480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from collections import defaultdict\n\n\nclass BetterCountMissing:\n    def __init__(self):\n        self.added = 0\n\n    def __call__(self):\n        self.added += 1\n        return 0\n\n\ncurrent = {\'green\': 12, \'blue\': 3}\nincrements = [\n    (\'red\', 5),\n    (\'blue\', 17),\n    (\'orange\', 9),\n]\ncounter = BetterCountMissing()\nresult = defaultdict(counter, current)\nfor key, amount in increments:\n    result[key] += amount\nassert counter.added == 2`, `75608176928165480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{19-23}"\n              >\n                <span class="gatsby-code-button-language">py{19-23}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> collections <span class="token keyword">import</span> defaultdict\n\n\n<span class="token keyword">class</span> <span class="token class-name">BetterCountMissing</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>added <span class="token operator">=</span> <span class="token number">0</span>\n\n    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>added <span class="token operator">+=</span> <span class="token number">1</span>\n        <span class="token keyword">return</span> <span class="token number">0</span>\n\n\ncurrent <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">\'green\'</span><span class="token punctuation">:</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token string">\'blue\'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">}</span>\nincrements <span class="token operator">=</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">(</span><span class="token string">\'red\'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">(</span><span class="token string">\'blue\'</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">(</span><span class="token string">\'orange\'</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">]</span>\n<span class="gatsby-highlight-code-line">counter <span class="token operator">=</span> BetterCountMissing<span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">result <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span>counter<span class="token punctuation">,</span> current<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">for</span> key<span class="token punctuation">,</span> amount <span class="token keyword">in</span> increments<span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">    result<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">+=</span> amount</span><span class="gatsby-highlight-code-line"><span class="token keyword">assert</span> counter<span class="token punctuation">.</span>added <span class="token operator">==</span> <span class="token number">2</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面这段代码要比 CountMissing 更清晰，因为它里面有 <code class="language-text">__call__</code> 方法，这说明这个类的实例可像普通的函数那样使用（例如可以传给 API 当挂钩）。即便是初次看到这段代码，也能明白这个类的主要目标。因为你应该会注意到那个比较显眼的 <code class="language-text">__call__</code> 方法。它强烈暗示着这个类可以像有状态的闭包那样使用。</p>\n<p>总之，最大的优势在于，defaultdict 仍然不需要关注 <code class="language-text">__call__</code> 方法触发之后究竟会做什么。它只知道自己可以用这样一个挂钩，来给缺失的键制作默认值。Python 很容易就能设计这种把挂钩函数当参数来用的接口，面对这种接口，调用者可以采用最适合自己的，把符合接口要求的东西传进去。</p>\n<h3 id="总结-34"><a href="#%E6%80%BB%E7%BB%93-34" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>如果想设计简单的 Python 接口，让组件之间能够通过接口交互，那么可以考虑让接口接受挂钩函数，而不一定非得定义新类，并要求使用者传入这种类的实例。</li>\n<li>Python 的函数与方法都是头等对象，这意味着它们可以像其他类型那样，用在表达式里。</li>\n<li>某个类如果定义了 <code class="language-text">__call__</code> 特殊方法，那么它的实例就可以像普通的 Python 函数那样调用。</li>\n<li>如果想用函数来维护状态，那么可以考虑定义一个带有 <code class="language-text">__call__</code> 方法的新类，而不要用有状态的闭包去实现。</li>\n</ol>\n<h2 id="第-39-条：通过-classmethod-多态来构造同一体系中的各类对象"><a href="#%E7%AC%AC-39-%E6%9D%A1%EF%BC%9A%E9%80%9A%E8%BF%87-classmethod-%E5%A4%9A%E6%80%81%E6%9D%A5%E6%9E%84%E9%80%A0%E5%90%8C%E4%B8%80%E4%BD%93%E7%B3%BB%E4%B8%AD%E7%9A%84%E5%90%84%E7%B1%BB%E5%AF%B9%E8%B1%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 39 条：通过 @classmethod 多态来构造同一体系中的各类对象</h2>\n<p>在 Python 中，不仅对象支持多态，类也支持多态。类的多态是什么意思，这样做有什么好处？</p>\n<p>多态机制使同一体系中的多个类可以按照各自独有的方式来实现同一个方法，这意味着这些类都可以满足同一套接口，或者都可以当作某个抽象类来使用，同时，它们又能在这个前提下，实现各自的功能（参见第 43 条）。</p>\n<p>例如，要实现一套 MapReduce（映射-归纳/映射-化简）流程，并且以一个通用的类来表示输入数据。于是，笔者就定义了这样一个 InputData 类，并把 read 方法留给子类去实现。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95925045014898050000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class InputData:\n    def read(self):\n        raise NotImplementedError`, `95925045014898050000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">InputData</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">read</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> NotImplementedError</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>然后，编写一个具体的 InputData 子类，例如，可以从磁盘文件中读取数据的 PathInputData 类。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49755368345459065000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class PathInputData(InputData):\n    def __init__(self, path):\n        super().__init__()\n        self.path = path\n\n    def read(self):\n        with open(self.path) as f:\n            return f.read()`, `49755368345459065000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">PathInputData</span><span class="token punctuation">(</span>InputData<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>path <span class="token operator">=</span> path\n\n    <span class="token keyword">def</span> <span class="token function">read</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>\n            <span class="token keyword">return</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>通用的 InputData 类以后可能会有很多个像 PathInputData 这样的子类，每个子类都会实现标准的 read 接口，并按照各自的方式把需要处理的数据读取进来。例如，有的 InputData 子类可从网上读取数据，有的 InputData 可读取压缩格式的数据并将其解压成普通数据，等等。</p>\n<p>除了输入数据要通用，我们还想让处理 MapReduce 任务的工作节点（Worker）也能有一套通用的抽象接口，这样不同的 Worker 就可以通过这套标准的接口来消耗输入数据。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40466942402907290000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Worker:\n    def __init__(self, input_data):\n        self.input_data = input_data\n        self.result = None\n\n    def map(self):\n        raise NotImplementedError\n\n    def reduce(self, other):\n        raise NotImplementedError`, `40466942402907290000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Worker</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> input_data<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>input_data <span class="token operator">=</span> input_data\n        self<span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token boolean">None</span>\n\n    <span class="token keyword">def</span> <span class="token function">map</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> NotImplementedError\n\n    <span class="token keyword">def</span> <span class="token function">reduce</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> other<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> NotImplementedError</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>下面，我们定义一种具体的 Worker 子类，使它按照特定的方式实现 MapReduce。也就是统计每份数据里的换行符个数，然后把所有的统计值汇总起来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55098147818821075000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class LineCountWorker(Worker):\n    def map(self):\n        data = self.input_data.read()\n        self.result = data.count(\'\\n\')\n\n    def reduce(self, other):\n        self.result += other.result`, `55098147818821075000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">LineCountWorker</span><span class="token punctuation">(</span>Worker<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">map</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        data <span class="token operator">=</span> self<span class="token punctuation">.</span>input_data<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>result <span class="token operator">=</span> data<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">\'\\n\'</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">reduce</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> other<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>result <span class="token operator">+=</span> other<span class="token punctuation">.</span>result</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样实现似乎不错，但接下来会碰到一个大难题，也就是如何把这些组件拼接起来。输入数据与工作节点都有各自的类体系，而且这两套体系也抽象出了合理的接口，然而，它们都必须落实到具体的对象上面，只有构造出了具体对象，才能写出有用的程序。问题是，这些对象由谁来构造？构造出来之后，怎么编排 MapReduce 流程？</p>\n<p>最简单的办法，是编写几个辅助函数，手动构建这些对象并把它们连接起来。例如，可以采用下面的辅助函数读取目录中的内容，并给目录下每份文件构造一个 PathInputData 实例。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18861223084280488000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import os\n\n\ndef generate_inputs(data_dir):\n    for name in os.listdir(data_dir):\n        yield PathInputData(os.path.join(data_dir, name))`, `18861223084280488000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> os\n\n\n<span class="token keyword">def</span> <span class="token function">generate_inputs</span><span class="token punctuation">(</span>data_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> name <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>data_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">yield</span> PathInputData<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>data_dir<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>接下来，再编写一个辅助函数，针对 <code class="language-text">generate_inputs</code> 返回的每个 InputData 实例分别创建相应的 LineCountWorker 对象。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36570933924775596000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def create_workers(input_list):\n    workers = []\n    for input_data in input_list:\n        workers.append(LineCountWorker(input_data))\n    return workers`, `36570933924775596000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">create_workers</span><span class="token punctuation">(</span>input_list<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    workers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n    <span class="token keyword">for</span> input_data <span class="token keyword">in</span> input_list<span class="token punctuation">:</span>\n        workers<span class="token punctuation">.</span>append<span class="token punctuation">(</span>LineCountWorker<span class="token punctuation">(</span>input_data<span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token keyword">return</span> workers</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后，将这些 Worker 实例的映射（map）工作分发到多个线程中去执行（参见第 53 条）。反复调用 reduce，把这些 Worker 计算出的结果合并成一个值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48242595344997620000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from threading import Thread\n\n\ndef execute(workers):\n    threads = [Thread(target=w.map) for w in workers]\n    for thread in threads:\n        thread.start()\n    for thread in threads:\n        thread.join()\n\n    first, *rest = workers\n    for worker in rest:\n        first.reduce(worker)\n    return first.result`, `48242595344997620000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread\n\n\n<span class="token keyword">def</span> <span class="token function">execute</span><span class="token punctuation">(</span>workers<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    threads <span class="token operator">=</span> <span class="token punctuation">[</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>w<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">)</span> <span class="token keyword">for</span> w <span class="token keyword">in</span> workers<span class="token punctuation">]</span>\n    <span class="token keyword">for</span> thread <span class="token keyword">in</span> threads<span class="token punctuation">:</span>\n        thread<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">for</span> thread <span class="token keyword">in</span> threads<span class="token punctuation">:</span>\n        thread<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n    first<span class="token punctuation">,</span> <span class="token operator">*</span>rest <span class="token operator">=</span> workers\n    <span class="token keyword">for</span> worker <span class="token keyword">in</span> rest<span class="token punctuation">:</span>\n        first<span class="token punctuation">.</span><span class="token builtin">reduce</span><span class="token punctuation">(</span>worker<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> first<span class="token punctuation">.</span>result</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>最后，编写一个函数，将刚才那三个环节串起来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="937045842274275600"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def mapreduce(data_dir):\n    inputs = generate_inputs(data_dir)\n    workers = create_workers(inputs)\n    return execute(workers)`, `937045842274275600`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">mapreduce</span><span class="token punctuation">(</span>data_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    inputs <span class="token operator">=</span> generate_inputs<span class="token punctuation">(</span>data_dir<span class="token punctuation">)</span>\n    workers <span class="token operator">=</span> create_workers<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> execute<span class="token punctuation">(</span>workers<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，该函数可以很好地处理随机制造出的这批输入文件。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15481548129590573000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import random\nfrom threading import Thread\nimport os\n\n\nclass InputData:\n    def read(self):\n        raise NotImplementedError\n\n\nclass PathInputData(InputData):\n    def __init__(self, path):\n        super().__init__()\n        self.path = path\n\n    def read(self):\n        with open(self.path) as f:\n            return f.read()\n\n\nclass Worker:\n    def __init__(self, input_data):\n        self.input_data = input_data\n        self.result = None\n\n    def map(self):\n        raise NotImplementedError\n\n    def reduce(self, other):\n        raise NotImplementedError\n\n\nclass LineCountWorker(Worker):\n    def map(self):\n        data = self.input_data.read()\n        self.result = data.count(\'\\n\')\n\n    def reduce(self, other):\n        self.result += other.result\n\n\ndef generate_inputs(data_dir):\n    for name in os.listdir(data_dir):\n        yield PathInputData(os.path.join(data_dir, name))\n\n\ndef create_workers(input_list):\n    workers = []\n    for input_data in input_list:\n        workers.append(LineCountWorker(input_data))\n    return workers\n\n\ndef mapreduce(data_dir):\n    inputs = generate_inputs(data_dir)\n    workers = create_workers(inputs)\n    return execute(workers)\n\n\ndef execute(workers):\n    threads = [Thread(target=w.map) for w in workers]\n    for thread in threads:\n        thread.start()\n    for thread in threads:\n        thread.join()\n\n    first, *rest = workers\n    for worker in rest:\n        first.reduce(worker)\n    return first.result\n\n\ndef write_test_files(tmpdir):\n    os.makedirs(tmpdir)\n    print(\'generate dir is:\', os.path.abspath(tmpdir))\n    for i in range(100):\n        with open(os.path.join(tmpdir, str(i)), \'w\') as f:\n            f.write(\'\\n\' * random.randint(0, 100))\n\n\ntmpdir = \'test_inputs\'\nwrite_test_files(tmpdir)\nresult = mapreduce(tmpdir)\nprint(f\'There are {result} lines\')\n\n>>>\ngenerate dir is: /home/123/Desktop/test_inputs\nThere are 4884 lines`, `15481548129590573000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{73-84}"\n              >\n                <span class="gatsby-code-button-language">py{73-84}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> random\n<span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread\n<span class="token keyword">import</span> os\n\n\n<span class="token keyword">class</span> <span class="token class-name">InputData</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">read</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> NotImplementedError\n\n\n<span class="token keyword">class</span> <span class="token class-name">PathInputData</span><span class="token punctuation">(</span>InputData<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>path <span class="token operator">=</span> path\n\n    <span class="token keyword">def</span> <span class="token function">read</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>\n            <span class="token keyword">return</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Worker</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> input_data<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>input_data <span class="token operator">=</span> input_data\n        self<span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token boolean">None</span>\n\n    <span class="token keyword">def</span> <span class="token function">map</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> NotImplementedError\n\n    <span class="token keyword">def</span> <span class="token function">reduce</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> other<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> NotImplementedError\n\n\n<span class="token keyword">class</span> <span class="token class-name">LineCountWorker</span><span class="token punctuation">(</span>Worker<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">map</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        data <span class="token operator">=</span> self<span class="token punctuation">.</span>input_data<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>result <span class="token operator">=</span> data<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">\'\\n\'</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">reduce</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> other<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>result <span class="token operator">+=</span> other<span class="token punctuation">.</span>result\n\n\n<span class="token keyword">def</span> <span class="token function">generate_inputs</span><span class="token punctuation">(</span>data_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> name <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>data_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">yield</span> PathInputData<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>data_dir<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">def</span> <span class="token function">create_workers</span><span class="token punctuation">(</span>input_list<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    workers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n    <span class="token keyword">for</span> input_data <span class="token keyword">in</span> input_list<span class="token punctuation">:</span>\n        workers<span class="token punctuation">.</span>append<span class="token punctuation">(</span>LineCountWorker<span class="token punctuation">(</span>input_data<span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token keyword">return</span> workers\n\n\n<span class="token keyword">def</span> <span class="token function">mapreduce</span><span class="token punctuation">(</span>data_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    inputs <span class="token operator">=</span> generate_inputs<span class="token punctuation">(</span>data_dir<span class="token punctuation">)</span>\n    workers <span class="token operator">=</span> create_workers<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> execute<span class="token punctuation">(</span>workers<span class="token punctuation">)</span>\n\n\n<span class="token keyword">def</span> <span class="token function">execute</span><span class="token punctuation">(</span>workers<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    threads <span class="token operator">=</span> <span class="token punctuation">[</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>w<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">)</span> <span class="token keyword">for</span> w <span class="token keyword">in</span> workers<span class="token punctuation">]</span>\n    <span class="token keyword">for</span> thread <span class="token keyword">in</span> threads<span class="token punctuation">:</span>\n        thread<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">for</span> thread <span class="token keyword">in</span> threads<span class="token punctuation">:</span>\n        thread<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n    first<span class="token punctuation">,</span> <span class="token operator">*</span>rest <span class="token operator">=</span> workers\n    <span class="token keyword">for</span> worker <span class="token keyword">in</span> rest<span class="token punctuation">:</span>\n        first<span class="token punctuation">.</span><span class="token builtin">reduce</span><span class="token punctuation">(</span>worker<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> first<span class="token punctuation">.</span>result\n\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">def</span> <span class="token function">write_test_files</span><span class="token punctuation">(</span>tmpdir<span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">    os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>tmpdir<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'generate dir is:\'</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>tmpdir<span class="token punctuation">)</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>tmpdir<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'w\'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">\'\\n\'</span> <span class="token operator">*</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">tmpdir <span class="token operator">=</span> <span class="token string">\'test_inputs\'</span></span><span class="gatsby-highlight-code-line">write_test_files<span class="token punctuation">(</span>tmpdir<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">result <span class="token operator">=</span> mapreduce<span class="token punctuation">(</span>tmpdir<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'There are </span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token punctuation">}</span></span><span class="token string"> lines\'</span></span><span class="token punctuation">)</span></span>\n<span class="token operator">>></span><span class="token operator">></span>\ngenerate <span class="token builtin">dir</span> <span class="token keyword">is</span><span class="token punctuation">:</span> <span class="token operator">/</span>home<span class="token operator">/</span><span class="token number">123</span><span class="token operator">/</span>Desktop<span class="token operator">/</span>test_inputs\nThere are <span class="token number">4884</span> lines</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然而这样做有个大问题，就是 mapreduce 函数根本不通用。假如要使用其他的 InputData 或 Worker 子类，那就必须修改 <code class="language-text">generate_inputs</code>、<code class="language-text">create_workers</code> 与 mapreduce 的代码，以匹配新类的用法。</p>\n<p>这个问题的根本原因在于，构造对象的办法不够通用。在其他编程语言中，可以利用构造函数多态（constructor polymorphism）来解决，也就是子类不仅要具备与超类一致的构造函数，而且还必须各自提供一个特殊的构造函数以实现和自身有关的构造逻辑。这样，刚才那些辅助方法在编排 MapReduce 流程时，就可以按照超类的形式统一地构造这些对象，并使其根据所属的子类分别去触发相关的特殊构造函数（类似工厂模式）。但是我们在 Python 里不能这样做，因为 Python 的类只能有一个构造方法（即 <code class="language-text">__init__</code> 方法），没办法要求所有的 InputData 子类都采用同一种写法来定义 <code class="language-text">__init__</code>（因为它们必须用各自不同的数据来完成构造）。</p>\n<p>这个问题，最好是能够通过类方法多态（class method polymorphism）来解决。这种多态与 InputData.read 所体现的实例方法多态（instance method polymorphism）很像，只不过它针对的是类，而不是这些类的对象。</p>\n<p>我们现在运用方法多态来实现 MapReduce 流程所用到的这些类。首先改写 InputData 类，把 <code class="language-text">generate_inputs</code> 方法放到该类里面并声明成通用的 @classmethod，这样它的所有子类都可以通过同一个接口来新建具体的 InputData 实例。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63444847180021040000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class GenericInputData:\n    def read(self):\n        raise NotImplementedError\n\n    @classmethod\n    def generate_inputs(cls, config):\n        raise NotImplementedError`, `63444847180021040000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">GenericInputData</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">read</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> NotImplementedError\n\n    @<span class="token builtin">classmethod</span>\n    <span class="token keyword">def</span> <span class="token function">generate_inputs</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> NotImplementedError</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>新的 <code class="language-text">generate_inputs</code> 方法带有一个叫作 config 的字典参数，调用者可以把一系列配置信息放到字典里中，让具体的 GenericInputData 子类去解读。例如 PathInputData 这个子类就会通过 <code class="language-text">data_dir</code> 键从字典里寻找含有输入文件的那个目录。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12501640522946445000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class PathInputData(GenericInputData):\n    @classmethod\n    def generate_inputs(cls, config):\n        data_dir = config[\'data_dir\']\n        for name in os.listdir(data_dir):\n            yield cls(os.path.join(data_dir, name))`, `12501640522946445000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">PathInputData</span><span class="token punctuation">(</span>GenericInputData<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    @<span class="token builtin">classmethod</span>\n    <span class="token keyword">def</span> <span class="token function">generate_inputs</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        data_dir <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">\'data_dir\'</span><span class="token punctuation">]</span>\n        <span class="token keyword">for</span> name <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>data_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">yield</span> cls<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>data_dir<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后，可以用类似的思路改写前面的 Worker 类。把名叫 <code class="language-text">create_workers</code> 的辅助方法移到这个类里面并且也声明成 @classmethod。新方法的 <code class="language-text">input_class</code> 参数将会是 GenericInputData 的某个子类，我们要通过这个参数触发那个子类的 <code class="language-text">generate_inputs</code> 方法，以创建出 Worker 所需的输入信息。有了输入信息之后，通过 <code class="language-text">cls(input_data)</code> 这个通用的形式来调用构造函数，这样创建的实例，其类型是 cls 所表示的具体 GenericWorker 子类。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7644419767607680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class GenericWorker:\n    def __init__(self, input_data):\n        self.input_data = input_data\n        self.result = None\n\n    def map(self):\n        raise NotImplementedError\n\n    def reduce(self, other):\n        raise NotImplementedError\n\n    @classmethod\n    def create_workers(cls, input_class, config):\n        workers = []\n        for input_data in input_class.generate_inputs(config):\n            workers.append(cls(input_data))\n        return workers`, `7644419767607680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">GenericWorker</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> input_data<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>input_data <span class="token operator">=</span> input_data\n        self<span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token boolean">None</span>\n\n    <span class="token keyword">def</span> <span class="token function">map</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> NotImplementedError\n\n    <span class="token keyword">def</span> <span class="token function">reduce</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> other<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> NotImplementedError\n\n    @<span class="token builtin">classmethod</span>\n    <span class="token keyword">def</span> <span class="token function">create_workers</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> input_class<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        workers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n        <span class="token keyword">for</span> input_data <span class="token keyword">in</span> input_class<span class="token punctuation">.</span>generate_inputs<span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            workers<span class="token punctuation">.</span>append<span class="token punctuation">(</span>cls<span class="token punctuation">(</span>input_data<span class="token punctuation">)</span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> workers</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>请注意，上面的代码创建输入信息时，用的是 <code class="language-text">input_class.generate_inputs</code> 这样的写法，这么写正是为了触发类多态机制，以便将 <code class="language-text">generate_inputs</code> 派发到 <code class="language-text">input_class</code> 所表示的那个实际子类上面。另外还要注意，在构造 GenericWorker 的子类对象时，用的是 <code class="language-text">cls(...)</code> 这样的通用写法，而没有直接调用 <code class="language-text">__init__</code> 方法。</p>\n<p>接下来要修改具体的 Worker 类，这其实很简单，只需要把超类的名称改为 GenericWorker 就好。</p>\n<p>最后，重新编写 mapreduce 函数，让它通过 <code class="language-text">worker_class.create_workers</code> 来创建工作节点，这样它就变得通用了。</p>\n<p>把原来那套实现方案所处理的随机文件，再采用这套新的工作节点来处理，可以产生相同的结果。区别只在于，这次调用 mapreduce 时，必须多传几个参数，因为它现在是个通用的函数，必须把实际的输入数据与实际的工作节点告诉它。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75088513219376680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import random\nfrom threading import Thread\nimport os\n\n\nclass GenericInputData:\n    def read(self):\n        raise NotImplementedError\n\n    @classmethod\n    def generate_inputs(cls, config):\n        raise NotImplementedError\n\n\nclass PathInputData(GenericInputData):\n    def __init__(self, path):\n        super().__init__()\n        self.path = path\n\n    def read(self):\n        with open(self.path) as f:\n            return f.read()\n\n    @classmethod\n    def generate_inputs(cls, config):\n        data_dir = config[\'data_dir\']\n        for name in os.listdir(data_dir):\n            yield cls(os.path.join(data_dir, name))\n\n\nclass GenericWorker:\n    def __init__(self, input_data):\n        self.input_data = input_data\n        self.result = None\n\n    def map(self):\n        raise NotImplementedError\n\n    def reduce(self, other):\n        raise NotImplementedError\n\n    @classmethod\n    def create_workers(cls, input_class, config):\n        workers = []\n        for input_data in input_class.generate_inputs(config):\n            workers.append(cls(input_data))\n        return workers\n\n\nclass LineCountWorker(GenericWorker):\n    def map(self):\n        data = self.input_data.read()\n        self.result = data.count(\'\\n\')\n\n    def reduce(self, other):\n        self.result += other.result\n\n\ndef mapreduce(worker_class, input_class, config):\n    workers = worker_class.create_workers(input_class, config)\n    return execute(workers)\n\n\ndef execute(workers):\n    threads = [Thread(target=w.map) for w in workers]\n    for thread in threads:\n        thread.start()\n    for thread in threads:\n        thread.join()\n\n    first, *rest = workers\n    for worker in rest:\n        first.reduce(worker)\n    return first.result\n\n\ndef write_test_files(tmpdir):\n    os.makedirs(tmpdir)\n    print(\'generate dir is:\', os.path.abspath(tmpdir))\n    for i in range(100):\n        with open(os.path.join(tmpdir, str(i)), \'w\') as f:\n            f.write(\'\\n\' * random.randint(0, 100))\n\n\ntmpdir = \'test_inputs\'\nwrite_test_files(tmpdir)\nconfig = {\n    \'data_dir\': tmpdir\n}\nresult = mapreduce(LineCountWorker, PathInputData, config)\nprint(f\'There are {result} lines\')\n\n>>>\ngenerate dir is: /home/123/Desktop/test_inputs\nThere are 5373 lines`, `75088513219376680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{6,10-12,15,24-28,31,42-47,50,59-61,87-90}"\n              >\n                <span class="gatsby-code-button-language">py{6,10-12,15,24-28,31,42-47,50,59-61,87-90}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> random\n<span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread\n<span class="token keyword">import</span> os\n\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">class</span> <span class="token class-name">GenericInputData</span><span class="token punctuation">:</span></span>    <span class="token keyword">def</span> <span class="token function">read</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> NotImplementedError\n\n<span class="gatsby-highlight-code-line">    @<span class="token builtin">classmethod</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">def</span> <span class="token function">generate_inputs</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">raise</span> NotImplementedError</span>\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">class</span> <span class="token class-name">PathInputData</span><span class="token punctuation">(</span>GenericInputData<span class="token punctuation">)</span><span class="token punctuation">:</span></span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>path <span class="token operator">=</span> path\n\n    <span class="token keyword">def</span> <span class="token function">read</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>\n            <span class="token keyword">return</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="gatsby-highlight-code-line">    @<span class="token builtin">classmethod</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">def</span> <span class="token function">generate_inputs</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">        data_dir <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">\'data_dir\'</span><span class="token punctuation">]</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">for</span> name <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>data_dir<span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">            <span class="token keyword">yield</span> cls<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>data_dir<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span></span>\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">class</span> <span class="token class-name">GenericWorker</span><span class="token punctuation">:</span></span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> input_data<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>input_data <span class="token operator">=</span> input_data\n        self<span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token boolean">None</span>\n\n    <span class="token keyword">def</span> <span class="token function">map</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> NotImplementedError\n\n    <span class="token keyword">def</span> <span class="token function">reduce</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> other<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> NotImplementedError\n\n<span class="gatsby-highlight-code-line">    @<span class="token builtin">classmethod</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">def</span> <span class="token function">create_workers</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> input_class<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">        workers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">for</span> input_data <span class="token keyword">in</span> input_class<span class="token punctuation">.</span>generate_inputs<span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">            workers<span class="token punctuation">.</span>append<span class="token punctuation">(</span>cls<span class="token punctuation">(</span>input_data<span class="token punctuation">)</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">return</span> workers</span>\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">class</span> <span class="token class-name">LineCountWorker</span><span class="token punctuation">(</span>GenericWorker<span class="token punctuation">)</span><span class="token punctuation">:</span></span>    <span class="token keyword">def</span> <span class="token function">map</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        data <span class="token operator">=</span> self<span class="token punctuation">.</span>input_data<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>result <span class="token operator">=</span> data<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">\'\\n\'</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">reduce</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> other<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>result <span class="token operator">+=</span> other<span class="token punctuation">.</span>result\n\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">def</span> <span class="token function">mapreduce</span><span class="token punctuation">(</span>worker_class<span class="token punctuation">,</span> input_class<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">    workers <span class="token operator">=</span> worker_class<span class="token punctuation">.</span>create_workers<span class="token punctuation">(</span>input_class<span class="token punctuation">,</span> config<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">return</span> execute<span class="token punctuation">(</span>workers<span class="token punctuation">)</span></span>\n\n<span class="token keyword">def</span> <span class="token function">execute</span><span class="token punctuation">(</span>workers<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    threads <span class="token operator">=</span> <span class="token punctuation">[</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>w<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">)</span> <span class="token keyword">for</span> w <span class="token keyword">in</span> workers<span class="token punctuation">]</span>\n    <span class="token keyword">for</span> thread <span class="token keyword">in</span> threads<span class="token punctuation">:</span>\n        thread<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">for</span> thread <span class="token keyword">in</span> threads<span class="token punctuation">:</span>\n        thread<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n    first<span class="token punctuation">,</span> <span class="token operator">*</span>rest <span class="token operator">=</span> workers\n    <span class="token keyword">for</span> worker <span class="token keyword">in</span> rest<span class="token punctuation">:</span>\n        first<span class="token punctuation">.</span><span class="token builtin">reduce</span><span class="token punctuation">(</span>worker<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> first<span class="token punctuation">.</span>result\n\n\n<span class="token keyword">def</span> <span class="token function">write_test_files</span><span class="token punctuation">(</span>tmpdir<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>tmpdir<span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'generate dir is:\'</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>tmpdir<span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>tmpdir<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'w\'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>\n            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">\'\\n\'</span> <span class="token operator">*</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n\ntmpdir <span class="token operator">=</span> <span class="token string">\'test_inputs\'</span>\nwrite_test_files<span class="token punctuation">(</span>tmpdir<span class="token punctuation">)</span>\n<span class="gatsby-highlight-code-line">config <span class="token operator">=</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token string">\'data_dir\'</span><span class="token punctuation">:</span> tmpdir</span><span class="gatsby-highlight-code-line"><span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">result <span class="token operator">=</span> mapreduce<span class="token punctuation">(</span>LineCountWorker<span class="token punctuation">,</span> PathInputData<span class="token punctuation">,</span> config<span class="token punctuation">)</span></span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'There are </span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token punctuation">}</span></span><span class="token string"> lines\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\ngenerate <span class="token builtin">dir</span> <span class="token keyword">is</span><span class="token punctuation">:</span> <span class="token operator">/</span>home<span class="token operator">/</span><span class="token number">123</span><span class="token operator">/</span>Desktop<span class="token operator">/</span>test_inputs\nThere are <span class="token number">5373</span> lines</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这套方案让我们能够随意编写其他的 GenericInputData 与 GenericWorker 子类，而不用再花时间去调整它们之间的拼接代码（glue code）。</p>\n<h3 id="总结-35"><a href="#%E6%80%BB%E7%BB%93-35" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>Python 只允许每个类有一个构造方法，也就是 <code class="language-text">__init__</code> 方法。</li>\n<li>如果想在超类中用通用的代码构造子类实例，那么可以考虑定义 @classmethod 方法，并在里面用 <code class="language-text">cls(...)</code> 的形式构造具体的子类对象。</li>\n<li>通过类方法多态机制，我们能够以通用的形式构造并拼接具体的子类对象。</li>\n</ol>\n<h2 id="第-40-条：通过-super-初始化超类"><a href="#%E7%AC%AC-40-%E6%9D%A1%EF%BC%9A%E9%80%9A%E8%BF%87-super-%E5%88%9D%E5%A7%8B%E5%8C%96%E8%B6%85%E7%B1%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 40 条：通过 super 初始化超类</h2>\n<p>以前有种简单的写法，能在子类里面执行超类的初始化逻辑，那就是直接在超类名称上调用 <code class="language-text">__init__</code> 方法并把子类实例传进去。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12779248183060754000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyBaseClass:\n    def __init__(self, value):\n        self.value = value\n\n\nclass MyChildClass(MyBaseClass):\n    def __init__(self):\n        MyBaseClass.__init__(self, 5)`, `12779248183060754000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyBaseClass</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value\n\n\n<span class="token keyword">class</span> <span class="token class-name">MyChildClass</span><span class="token punctuation">(</span>MyBaseClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        MyBaseClass<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个办法能够应对比较简单的类体系，但是在其他的情况下容易出现问题。</p>\n<p>假如某个类继承了多个超类（一般来说不应该采用多重继承，笔者这里只是举例而已，参见第 41 条），那么直接调用超类的 <code class="language-text">__init__</code> 方法会让代码产生误会。</p>\n<p>直接调用 <code class="language-text">__init__</code> 方法所产生的第一个问题在于，超类的构造逻辑不一定会按照它们在子类 class 语句中的声明顺序执行。例如，在 MyBaseClass 之外再定义两个类，让它们也分别去操纵本实例的 value 字段。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57519561398039200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class TimesTwo:\n    def __init__(self):\n        self.value *= 2\n\n\nclass PlusFive:\n    def __init__(self):\n        self.value += 5`, `57519561398039200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">TimesTwo</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">*=</span> <span class="token number">2</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">PlusFive</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">+=</span> <span class="token number">5</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>下面这个子类继承了刚才那三个类，而且它在 class 语句里指定的超类顺序与它执行那些超类的 <code class="language-text">__init__</code> 时所用的顺序一致。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89038484371410930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class OneWay(MyBaseClass, TimesTwo, PlusFive):\n    def __init__(self, value):\n        MyBaseClass.__init__(self, value)\n        TimesTwo.__init__(self)\n        PlusFive.__init__(self)`, `89038484371410930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">OneWay</span><span class="token punctuation">(</span>MyBaseClass<span class="token punctuation">,</span> TimesTwo<span class="token punctuation">,</span> PlusFive<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        MyBaseClass<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n        TimesTwo<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">)</span>\n        PlusFive<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写，程序会按正常顺序初始化那几个超类。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47861946286530070000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyBaseClass:\n    def __init__(self, value):\n        self.value = value\n\n\nclass TimesTwo:\n    def __init__(self):\n        self.value *= 2\n\n\nclass PlusFive:\n    def __init__(self):\n        self.value += 5\n\n\nclass OneWay(MyBaseClass, TimesTwo, PlusFive):\n    def __init__(self, value):\n        MyBaseClass.__init__(self, value)\n        TimesTwo.__init__(self)\n        PlusFive.__init__(self)\n\n\nfoo = OneWay(5)\nprint(\'First ordering value is (5 * 2) + 5 =\', foo.value)\n\n>>>\nFirst ordering value is (5 * 2) + 5 = 15`, `47861946286530070000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{23-24}"\n              >\n                <span class="gatsby-code-button-language">py{23-24}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyBaseClass</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value\n\n\n<span class="token keyword">class</span> <span class="token class-name">TimesTwo</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">*=</span> <span class="token number">2</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">PlusFive</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">+=</span> <span class="token number">5</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">OneWay</span><span class="token punctuation">(</span>MyBaseClass<span class="token punctuation">,</span> TimesTwo<span class="token punctuation">,</span> PlusFive<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        MyBaseClass<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n        TimesTwo<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">)</span>\n        PlusFive<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">)</span>\n\n\n<span class="gatsby-highlight-code-line">foo <span class="token operator">=</span> OneWay<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'First ordering value is (5 * 2) + 5 =\'</span><span class="token punctuation">,</span> foo<span class="token punctuation">.</span>value<span class="token punctuation">)</span></span>\n<span class="token operator">>></span><span class="token operator">></span>\nFirst ordering value <span class="token keyword">is</span> <span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">5</span> <span class="token operator">=</span> <span class="token number">15</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但如果子类在 class 语句里指定的超类顺序，与它执行那些超类的 <code class="language-text">__init__</code> 时的顺序不同，那么运行结果就会让人困惑（例如这次先声明它继承 PlusFive 类，然后才声明它继承 TimesTwo 类，但执行 <code class="language-text">__init__</code> 的顺序却刚好相反）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33525720160399274000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class AnotherWay(MyBaseClass, PlusFive, TimesTwo):\n    def __init__(self, value):\n        MyBaseClass.__init__(self, value)\n        TimesTwo.__init_(self)\n        PlusFive.__init_(self)`, `33525720160399274000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">AnotherWay</span><span class="token punctuation">(</span>MyBaseClass<span class="token punctuation">,</span> PlusFive<span class="token punctuation">,</span> TimesTwo<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        MyBaseClass<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n        TimesTwo<span class="token punctuation">.</span>__init_<span class="token punctuation">(</span>self<span class="token punctuation">)</span>\n        PlusFive<span class="token punctuation">.</span>__init_<span class="token punctuation">(</span>self<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>该子类调整了两个超类的声明顺序，但没有相应调整构造逻辑的执行顺序，因此它还是会跟前面那个子类一样，先初始化 TimesTwo，然后初始化 PlusFive。这样写，就让初次看到这段代码的人很难理解程序的运行结果，他们以为程序先加 5，再乘 2，这样算出来是 20；但实际上，程序依照的是 <code class="language-text">__init__</code> 的调用顺序，而不是 class 语句中的声明顺序，这是个很难察觉的问题。</p>\n<p>直接调用 <code class="language-text">__init__</code> 所产生的第二个问题在于，无法正确处理菱形继承（diamond inheritance）。这种继承指的是子类通过类体系里两条不同路径的类继承了同一个超类。如果采用刚才那种常见的写法来调用超类的 <code class="language-text">__init__</code>，那么会让超类的初始化逻辑重复执行，从而引发混乱。例如，下面先从 MyBaseClass 派生出两个子类。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59711989811642630000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyBaseClass:\n    def __init__(self, value):\n        self.value = value\n\n\nclass TimesSeven(MyBaseClass):\n    def __init__(self, value):\n        MyBaseClass.__init__(self, value)\n        self.value *= 7\n\n\nclass PlusNine(MyBaseClass):\n    def __init__(self, value):\n        MyBaseClass.__init__(self, value)\n        self.value += 9`, `59711989811642630000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyBaseClass</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value\n\n\n<span class="token keyword">class</span> <span class="token class-name">TimesSeven</span><span class="token punctuation">(</span>MyBaseClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        MyBaseClass<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">*=</span> <span class="token number">7</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">PlusNine</span><span class="token punctuation">(</span>MyBaseClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        MyBaseClass<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">+=</span> <span class="token number">9</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后，定义最终的子类，让它分别继承刚才那两个类，这样 MyBaseClass 就会出现在菱形体系的顶端。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52206631560449114000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyBaseClass:\n    def __init__(self, value):\n        self.value = value\n\n\nclass TimesSeven(MyBaseClass):\n    def __init__(self, value):\n        MyBaseClass.__init__(self, value)\n        self.value *= 7\n\n\nclass PlusNine(MyBaseClass):\n    def __init__(self, value):\n        MyBaseClass.__init__(self, value)\n        self.value += 9\n\n\nclass ThisWay(TimesSeven, PlusNine):\n    def __init__(self, value):\n        TimesSeven.__init__(self, value)\n        PlusNine.__init__(self, value)\n\n\nfoo = ThisWay(5)\nprint(\'Should be (5 * 7) + 9 = 44 but is\', foo.value)\n\n>>>\nShould be (5 * 7) + 9 = 44 but is 14`, `52206631560449114000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{18-25}"\n              >\n                <span class="gatsby-code-button-language">py{18-25}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyBaseClass</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value\n\n\n<span class="token keyword">class</span> <span class="token class-name">TimesSeven</span><span class="token punctuation">(</span>MyBaseClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        MyBaseClass<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">*=</span> <span class="token number">7</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">PlusNine</span><span class="token punctuation">(</span>MyBaseClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        MyBaseClass<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">+=</span> <span class="token number">9</span>\n\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">class</span> <span class="token class-name">ThisWay</span><span class="token punctuation">(</span>TimesSeven<span class="token punctuation">,</span> PlusNine<span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">        TimesSeven<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">        PlusNine<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">foo <span class="token operator">=</span> ThisWay<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Should be (5 * 7) + 9 = 44 but is\'</span><span class="token punctuation">,</span> foo<span class="token punctuation">.</span>value<span class="token punctuation">)</span></span>\n<span class="token operator">>></span><span class="token operator">></span>\nShould be <span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">9</span> <span class="token operator">=</span> <span class="token number">44</span> but <span class="token keyword">is</span> <span class="token number">14</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当 ThisWay 调用第二个超类的 <code class="language-text">__init__</code> 时，那个方法会再度触发 MyBaseClass 的 <code class="language-text">__init__</code>，导致 self.value 重新变成 5。所以，最后的结果是 5 + 9 = 14，而不是 <code class="language-text">(5 * 7) + 9 = 44</code>，因为早前由 <code class="language-text">TimesSeven.__init__</code> 所做的初始化效果已经被第二次执行的 <code class="language-text">MyBaseClass.__init__</code> 覆盖了。这是个违背直觉的结果，如果情况更为复杂，那么调试起来会特别困难。</p>\n<p>为了解决这些问题，Python 内置了 super 函数并且规定了标准的方法解析顺序（method resolution order，MRO）。super 能够确保菱形继承体系中的共同超类只初始化一次（其他案例参见第 48 条）。MRO 可以确定超类之间的初始化顺序，它遵循 C3 线性化（C3 linearization）算法。</p>\n<p>下面再创建一套菱形的类体系，但是这次，我们改用 <code class="language-text">super()</code> 来调用超类的初始化逻辑。</p>\n<p>位于菱形结构顶端的 MyBaseClass，会率先初始化，而且只会初始化一次。接下来，程序会参照菱形底端那个子类在 class 语句里声明超类时的顺序，来执行菱形结构中部的那两个超类。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52035657600384660000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyBaseClass:\n    def __init__(self, value):\n        self.value = value\n\n\nclass TimesSevenCorrect(MyBaseClass):\n    def __init__(self, value):\n        super().__init__(value)\n        self.value *= 7\n\n\nclass PlusNineCorrect(MyBaseClass):\n    def __init__(self, value):\n        super().__init__(value)\n        self.value += 9\n\n\nclass GoodWay(TimesSevenCorrect, PlusNineCorrect):\n    def __init__(self, value):\n        super().__init__(value)\n\n\nfoo = GoodWay(5)\nprint(\'Should be 7 * (5 + 9) = 98 but is\', foo.value)\n\n>>>\nShould be 7 * (5 + 9) = 98 but is 98`, `52035657600384660000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyBaseClass</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value\n\n\n<span class="token keyword">class</span> <span class="token class-name">TimesSevenCorrect</span><span class="token punctuation">(</span>MyBaseClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">*=</span> <span class="token number">7</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">PlusNineCorrect</span><span class="token punctuation">(</span>MyBaseClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">+=</span> <span class="token number">9</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">GoodWay</span><span class="token punctuation">(</span>TimesSevenCorrect<span class="token punctuation">,</span> PlusNineCorrect<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n\n\nfoo <span class="token operator">=</span> GoodWay<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Should be 7 * (5 + 9) = 98 but is\'</span><span class="token punctuation">,</span> foo<span class="token punctuation">.</span>value<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nShould be <span class="token number">7</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">+</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">98</span> but <span class="token keyword">is</span> <span class="token number">98</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个执行顺序，似乎与看上去的相反。既然 GoodWay 在指定超类时，先写的是 TimesSevenCorrect，那就应该先执行 <code class="language-text">TimesSevenCorrect.__init__</code> 才对，这样结果应该是 <code class="language-text">(5 * 7) + 9 = 44</code>。但实际上并非如此。这两个超类之间的初始化顺序，要由子类的 MRO 确定，它可以通过 mro 方法来查询。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84913195091961250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`mro_str = \'\\n\'.join(repr(cls) for cls in GoodWay.mro())\nprint(mro_str)\n\n>>>\n<class \'__main__.GoodWay\'>\n<class \'__main__.TimesSevenCorrect\'>\n<class \'__main__.PlusNineCorrect\'>\n<class \'__main__.MyBaseClass\'>\n<class \'object\'>`, `84913195091961250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">mro_str <span class="token operator">=</span> <span class="token string">\'\\n\'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token builtin">repr</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span> <span class="token keyword">for</span> cls <span class="token keyword">in</span> GoodWay<span class="token punctuation">.</span>mro<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>mro_str<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.GoodWay\'</span><span class="token operator">></span>\n<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.TimesSevenCorrect\'</span><span class="token operator">></span>\n<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.PlusNineCorrect\'</span><span class="token operator">></span>\n<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.MyBaseClass\'</span><span class="token operator">></span>\n<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'object\'</span><span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>调用 GoodWay(5) 时，会先触发 <code class="language-text">TimesSevenCorrect.__init__</code>，进而触发 <code class="language-text">PlusNineCorrect.__init__</code>，而这又会触发 <code class="language-text">MyBaseClass.__init__</code>。程序到达菱形结构的顶端后，开始执行 MyBaseClass 的初始化逻辑，然后按照与刚才相反的顺序，依次执行 PlusNineCorrect、TimesSevenCorrect 与 GoodWay 的初始化逻辑。所以，程序首先会在 <code class="language-text">MyBaseClass.__init__</code> 中，把 value 设为 5，然后在 <code class="language-text">PlusNineCorrect.__init__</code> 里面给它加 9，这样就成了 14，接着又会在 <code class="language-text">TimesSevenCorrect.__init__</code> 里面将它乘 7，于是等于 98。</p>\n<p>除了可以应对菱形继承结构，通过 super() 调用 <code class="language-text">__init__</code>，与在子类内通过类名直接调用 <code class="language-text">__init__</code> 相比，可使代码更容易维护。现在不用从子类里面指名调用 <code class="language-text">MyBaseClass.__init__</code> 方法了，因此可以把 MyBaseClass 改成其他名字，或者让 TimesSevenCorrect 与 PlusNineCorrect 从另外一个超类里面继承，这些改动都无须调整 super 这一部分的代码。假如像原来那样写，那就必须手工修改 <code class="language-text">__init__</code> 方法前面的类名。</p>\n<p>super 函数也可以用双参数的形式调用。第一个参数表示从这个类型开始（不含该类型本身）按照方法解析顺序（MRO）向上搜索，而解析顺序则要由第二个参数所在类型的 <code class="language-text">__mro__</code> 决定。例如，按照下面这种写法，如果在 super 所返回的内容上调用 <code class="language-text">__init__</code> 方法，那么程序会从 ExplicitTrisect 类型开始（不含该类型本身）按照 MRO 向上搜索，直至找到这样的 <code class="language-text">__init__</code> 方法为止，而解析顺序是由第二个参数（self）所属的类型（ExplicitTrisect）决定的，所以解析顺序是 <code class="language-text">ExplicitTrisect -&gt; MyBaseClass -&gt; object</code>。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76488200322235940000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class ExplicitTrisect(MyBaseClass):\n    def __init__(self, value):\n        super(ExplicitTrisect, self).__init__(value)\n        self.value /= 3`, `76488200322235940000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">ExplicitTrisect</span><span class="token punctuation">(</span>MyBaseClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span>ExplicitTrisect<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">/=</span> <span class="token number">3</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>一般来说，在类的 <code class="language-text">__init__</code> 方法里面通过 super 初始化实例时，不需要采用双参数的形式，而是可以直接采用不带参数的写法调用 super，这样 Python 编译器会自动将 <code class="language-text">__class__</code> 和 self 当成参数传递进去。所以，下面这两种写法跟刚才那种写法是同一个意思。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2171920463243126500"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyBaseClass:\n    def __init__(self, value):\n        self.value = value\n\n\nclass ExplicitTrisect(MyBaseClass):\n    def __init__(self, value):\n        super(ExplicitTrisect, self).__init__(value)\n        self.value /= 3\n\n\nclass AutomaticTrisect(MyBaseClass):\n    def __init__(self, value):\n        super(__class__, self).__init__(value)\n        self.value /= 3\n\n\nclass ImplicitTrisect(MyBaseClass):\n    def __init__(self, value):\n        super().__init__(value)\n        self.value /= 3\n\n\nassert ExplicitTrisect(9).value == 3\nassert AutomaticTrisect(9).value == 3\nassert ImplicitTrisect(9).value == 3`, `2171920463243126500`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyBaseClass</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value\n\n\n<span class="token keyword">class</span> <span class="token class-name">ExplicitTrisect</span><span class="token punctuation">(</span>MyBaseClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span>ExplicitTrisect<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">/=</span> <span class="token number">3</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">AutomaticTrisect</span><span class="token punctuation">(</span>MyBaseClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span>__class__<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">/=</span> <span class="token number">3</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">ImplicitTrisect</span><span class="token punctuation">(</span>MyBaseClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">/=</span> <span class="token number">3</span>\n\n\n<span class="token keyword">assert</span> ExplicitTrisect<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">==</span> <span class="token number">3</span>\n<span class="token keyword">assert</span> AutomaticTrisect<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">==</span> <span class="token number">3</span>\n<span class="token keyword">assert</span> ImplicitTrisect<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">==</span> <span class="token number">3</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>只有一种情况需要明确给 super 指定参数，这就是：我们想从子类里面访问超类对某项功能所做的实现方案，而那种方案可能已经被子类覆盖掉了（例如，在封装或复用功能时，就会遇到这样的情况）。</p>\n<h3 id="总结-36"><a href="#%E6%80%BB%E7%BB%93-36" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>Python 有标准的方法解析顺序（MRO）规则，可以用来判定超类之间的初始化顺序，并解决菱形继承问题。</li>\n<li>可以通过 Python 内置的 super 函数正确触发超类的 <code class="language-text">__init__</code> 逻辑。一般情况下，不需要给这个函数指定参数。</li>\n</ol>\n<h2 id="第-41-条：考虑用-mix-in-类来表示可组合的功能"><a href="#%E7%AC%AC-41-%E6%9D%A1%EF%BC%9A%E8%80%83%E8%99%91%E7%94%A8-mix-in-%E7%B1%BB%E6%9D%A5%E8%A1%A8%E7%A4%BA%E5%8F%AF%E7%BB%84%E5%90%88%E7%9A%84%E5%8A%9F%E8%83%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 41 条：考虑用 mix-in 类来表示可组合的功能</h2>\n<p>Python 是面向对象的编程语言，而且内置了相关的机制，使开发者能够正确处理多重继承（参见第 40 条）。尽管如此，但还是应该尽量少用多重继承。</p>\n<p>如果既要通过多重继承来方便地封装逻辑，又想避开可能出现的问题，那么就应该把有待继承的类写成 mix-in 类。这种类只提供一小套方法给子类去沿用，而不定义自己实例级别的属性，也不需要 <code class="language-text">__init__</code> 构造函数。</p>\n<p>在 Python 里很容易编写 mix-in，因为无论对象是什么类型，我们都可以方便地检视（inspect）它当前的状态。这种动态检测机制，让我们只需要把通用的功能在 mix-in 实现一遍即可，将来也可以把这项功能应用到其他许多类里面。可以把这些 mix-in 类有层次地组合起来，从而用相当少的代码表达出丰富的功能。</p>\n<p>例如，现在要实现这样一个功能，把内存中的 Python 对象表示成字典形式以便做序列化（serialization）处理。不妨将这项功能写为通用代码，以供其他类使用。</p>\n<p>为了演示这种做法，笔者定义下面这个 mix-in，让它提供名为 <code class="language-text">to_dict</code> 的 public 方法。凡是想支持这项功能的类，都可以从 mix-in 继承。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85040240444565130000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class ToDictMixin:\n    def to_dict(self):\n        return self._traverse_dict(self.__dict__)`, `85040240444565130000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">ToDictMixin</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">to_dict</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_traverse_dict<span class="token punctuation">(</span>self<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>具体的实现代码写得很直观，我们可以通过 isinstance 函数动态地检视值的类型，并利用 hasattr 函数判断值里面有没有叫作 <code class="language-text">__dict__</code> 的字典。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83642518649046320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def _traverse_dict(self, instance_dict):\n    output = {}\n    for key, value in instance_dict.items():\n        output[key] = self._traverse(key, value)\n    return output\n\n\ndef _traverse(self, key, value):\n    if isinstance(value, ToDictMixin):\n        return value.to_dict()\n    elif isinstance(value, dict):\n        return self._traverse_dict(value)\n    elif isinstance(value, list):\n        return [self._traverse(key, i) for i in value]\n    elif hasattr(value, \'__dict__\'):\n        return self._traverse_dict(value.__dict__)\n    else:\n        return value`, `83642518649046320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">_traverse_dict</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    output <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n    <span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> instance_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        output<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> output\n\n\n<span class="token keyword">def</span> <span class="token function">_traverse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> ToDictMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> value<span class="token punctuation">.</span>to_dict<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_traverse_dict<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n    <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span>key<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> value<span class="token punctuation">]</span>\n    <span class="token keyword">elif</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token string">\'__dict__\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_traverse_dict<span class="token punctuation">(</span>value<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> value</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>下面以二叉树为例，演示如何使表示二叉树的 BinaryTree 类具备刚才那个 mix-in 所提供的功能。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7732632183069787000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class BinaryTree(ToDictMixin):\n    def __init__(self, value, left=None, right=None):\n        self.value = value\n        self.left = left\n        self.right = right`, `7732632183069787000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">BinaryTree</span><span class="token punctuation">(</span>ToDictMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">,</span> left<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> right<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value\n        self<span class="token punctuation">.</span>left <span class="token operator">=</span> left\n        self<span class="token punctuation">.</span>right <span class="token operator">=</span> right</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>定义了这样的 BinaryTree 类后，很容易就能把二叉树里面那些相互关联的 Python 对象转换成字典的形式。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68784577216493896000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class ToDictMixin:\n    def _traverse_dict(self, instance_dict):\n        output = {}\n        for key, value in instance_dict.items():\n            output[key] = self._traverse(key, value)\n        return output\n\n    def _traverse(self, key, value):\n        if isinstance(value, ToDictMixin):\n            return value.to_dict()\n        elif isinstance(value, dict):\n            return self._traverse_dict(value)\n        elif isinstance(value, list):\n            return [self._traverse(key, i) for i in value]\n        elif hasattr(value, \'__dict__\'):\n            return self._traverse_dict(value.__dict__)\n        else:\n            return value\n\n    def to_dict(self):\n        return self._traverse_dict(self.__dict__)\n\n\nclass BinaryTree(ToDictMixin):\n    def __init__(self, value, left=None, right=None):\n        self.value = value\n        self.left = left\n        self.right = right\n\n\ntree = BinaryTree(10,\n                  left=BinaryTree(7, right=BinaryTree(9)),\n                  right=BinaryTree(13, left=BinaryTree(11)))\nprint(tree.to_dict())\n\n>>>\n{\'value\': 10, \'left\': {\'value\': 7, \'left\': None, \'right\': {\'value\': 9, \'left\': None, \'right\': None}}, \'right\': {\'value\': 13, \'left\': {\'value\': 11, \'left\': None, \'right\': None}, \'right\': None}}`, `68784577216493896000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{31-34}"\n              >\n                <span class="gatsby-code-button-language">py{31-34}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">ToDictMixin</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">_traverse_dict</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        output <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n        <span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> instance_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            output<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> output\n\n    <span class="token keyword">def</span> <span class="token function">_traverse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> ToDictMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> value<span class="token punctuation">.</span>to_dict<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_traverse_dict<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n        <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span>key<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> value<span class="token punctuation">]</span>\n        <span class="token keyword">elif</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token string">\'__dict__\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_traverse_dict<span class="token punctuation">(</span>value<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> value\n\n    <span class="token keyword">def</span> <span class="token function">to_dict</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_traverse_dict<span class="token punctuation">(</span>self<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">BinaryTree</span><span class="token punctuation">(</span>ToDictMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">,</span> left<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> right<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value\n        self<span class="token punctuation">.</span>left <span class="token operator">=</span> left\n        self<span class="token punctuation">.</span>right <span class="token operator">=</span> right\n\n\n<span class="gatsby-highlight-code-line">tree <span class="token operator">=</span> BinaryTree<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">                  left<span class="token operator">=</span>BinaryTree<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> right<span class="token operator">=</span>BinaryTree<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">                  right<span class="token operator">=</span>BinaryTree<span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">,</span> left<span class="token operator">=</span>BinaryTree<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">print</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span>to_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">{</span><span class="token string">\'value\'</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">\'left\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'value\'</span><span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">\'left\'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">\'right\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'value\'</span><span class="token punctuation">:</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token string">\'left\'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">\'right\'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'right\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'value\'</span><span class="token punctuation">:</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token string">\'left\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'value\'</span><span class="token punctuation">:</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token string">\'left\'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">\'right\'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'right\'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>mix-in 最妙的地方在于，子类既可以沿用它所提供的功能，又可以对其中一些地方做自己的处理。例如，我们从普通的二叉树（BinaryTree）派生了一个子类，让这种特殊的 BinaryTreeWithParent 二叉树能够把指向上级节点的引用保留下来。但问题是，这种二叉树的 <code class="language-text">to_dict</code> 方法是从 ToDictMixin 继承来的，它所触发的 <code class="language-text">_traverse</code> 方法，在面对循环引用时，会无休止地递归下去。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99215091678311270000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class BinaryTreeWithParent(BinaryTree):\n    def __init__(self, value, left=None,\n                 right=None, parent=None):\n        super().__init__(value, left=left, right=right)\n        self.parent = parent`, `99215091678311270000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">BinaryTreeWithParent</span><span class="token punctuation">(</span>BinaryTree<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">,</span> left<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>\n                 right<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> parent<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>value<span class="token punctuation">,</span> left<span class="token operator">=</span>left<span class="token punctuation">,</span> right<span class="token operator">=</span>right<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>parent <span class="token operator">=</span> parent</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>为了避免无限循环，我们可以覆盖 <code class="language-text">BinaryTreeWithParent._traverse</code> 方法，让它对指向上级节点的引用做专门处理，而对于其他的值，则继续沿用从 mix-in 继承的 <code class="language-text">_traverse</code> 逻辑。下面这段代码，首先判断当前值是不是指向上级节点的引用。如果是，就直接返回上级节点的 value 值；如果不是，那就通过内置的 super 函数沿用由 mix-in 超类所给出默认实现方案。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97113064916876920000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def _traverse(self, key, value):\n   if (isinstance(value, BinaryTreeWithParent) and\n            key == \'parent\'):\n      return value.value  # Prevent cycles\n   else:\n      return super()._traverse(key, value)`, `97113064916876920000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">_traverse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> BinaryTreeWithParent<span class="token punctuation">)</span> <span class="token keyword">and</span>\n            key <span class="token operator">==</span> <span class="token string">\'parent\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n      <span class="token keyword">return</span> value<span class="token punctuation">.</span>value  <span class="token comment"># Prevent cycles</span>\n   <span class="token keyword">else</span><span class="token punctuation">:</span>\n      <span class="token keyword">return</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在调用 <code class="language-text">BinaryTreeWithParent.to_dict</code> 就没有问题了，因为它所触发的是 BinaryTreeWithParent 自己的 <code class="language-text">_traverse</code> 方法，该方法不会再递归地处理循环引用。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32986538054421200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class ToDictMixin:\n    def _traverse_dict(self, instance_dict):\n        output = {}\n        for key, value in instance_dict.items():\n            output[key] = self._traverse(key, value)\n        return output\n\n    def _traverse(self, key, value):\n        if isinstance(value, ToDictMixin):\n            return value.to_dict()\n        elif isinstance(value, dict):\n            return self._traverse_dict(value)\n        elif isinstance(value, list):\n            return [self._traverse(key, i) for i in value]\n        elif hasattr(value, \'__dict__\'):\n            return self._traverse_dict(value.__dict__)\n        else:\n            return value\n\n    def to_dict(self):\n        return self._traverse_dict(self.__dict__)\n\n\nclass BinaryTree(ToDictMixin):\n    def __init__(self, value, left=None, right=None):\n        self.value = value\n        self.left = left\n        self.right = right\n\n\nclass BinaryTreeWithParent(BinaryTree):\n    def __init__(self, value, left=None,\n                 right=None, parent=None):\n        super().__init__(value, left=left, right=right)\n        self.parent = parent\n\n    def _traverse(self, key, value):\n        if (isinstance(value, BinaryTreeWithParent) and\n                key == \'parent\'):\n            return value.value  # Prevent cycles\n        else:\n            return super()._traverse(key, value)\n\n\nroot = BinaryTreeWithParent(10)\nroot.left = BinaryTreeWithParent(7, parent=root)\nroot.left.right = BinaryTreeWithParent(9, parent=root.left)\nprint(root.to_dict())\n\n>>>\n{\'value\': 10, \'left\': {\'value\': 7, \'left\': None, \'right\': {\'value\': 9, \'left\': None, \'right\': None, \'parent\': 7}, \'parent\': 10}, \'right\': None, \'parent\': None}`, `32986538054421200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{37-42}"\n              >\n                <span class="gatsby-code-button-language">py{37-42}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">ToDictMixin</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">_traverse_dict</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        output <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n        <span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> instance_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            output<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> output\n\n    <span class="token keyword">def</span> <span class="token function">_traverse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> ToDictMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> value<span class="token punctuation">.</span>to_dict<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_traverse_dict<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n        <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span>key<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> value<span class="token punctuation">]</span>\n        <span class="token keyword">elif</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token string">\'__dict__\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_traverse_dict<span class="token punctuation">(</span>value<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> value\n\n    <span class="token keyword">def</span> <span class="token function">to_dict</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_traverse_dict<span class="token punctuation">(</span>self<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">BinaryTree</span><span class="token punctuation">(</span>ToDictMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">,</span> left<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> right<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value\n        self<span class="token punctuation">.</span>left <span class="token operator">=</span> left\n        self<span class="token punctuation">.</span>right <span class="token operator">=</span> right\n\n\n<span class="token keyword">class</span> <span class="token class-name">BinaryTreeWithParent</span><span class="token punctuation">(</span>BinaryTree<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">,</span> left<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>\n                 right<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> parent<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>value<span class="token punctuation">,</span> left<span class="token operator">=</span>left<span class="token punctuation">,</span> right<span class="token operator">=</span>right<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>parent <span class="token operator">=</span> parent\n\n<span class="gatsby-highlight-code-line">    <span class="token keyword">def</span> <span class="token function">_traverse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> BinaryTreeWithParent<span class="token punctuation">)</span> <span class="token keyword">and</span></span><span class="gatsby-highlight-code-line">                key <span class="token operator">==</span> <span class="token string">\'parent\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">            <span class="token keyword">return</span> value<span class="token punctuation">.</span>value  <span class="token comment"># Prevent cycles</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">else</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">            <span class="token keyword">return</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span></span>\n\nroot <span class="token operator">=</span> BinaryTreeWithParent<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>\nroot<span class="token punctuation">.</span>left <span class="token operator">=</span> BinaryTreeWithParent<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> parent<span class="token operator">=</span>root<span class="token punctuation">)</span>\nroot<span class="token punctuation">.</span>left<span class="token punctuation">.</span>right <span class="token operator">=</span> BinaryTreeWithParent<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> parent<span class="token operator">=</span>root<span class="token punctuation">.</span>left<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>to_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">{</span><span class="token string">\'value\'</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">\'left\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'value\'</span><span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">\'left\'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">\'right\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'value\'</span><span class="token punctuation">:</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token string">\'left\'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">\'right\'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">\'parent\'</span><span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'parent\'</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'right\'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">\'parent\'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>只要 <code class="language-text">BinaryTreeWithParent._traverse</code> 没问题，带有 BinaryTreeWithParent 属性的其他类就可以直接继承 ToDictMixin，这样的话，程序在把这种对象转化成字典时，会自动对其中的 BinaryTreeWithParent 属性做出正确处理。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82043078200573720000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class ToDictMixin:\n    def _traverse_dict(self, instance_dict):\n        output = {}\n        for key, value in instance_dict.items():\n            output[key] = self._traverse(key, value)\n        return output\n\n    def _traverse(self, key, value):\n        if isinstance(value, ToDictMixin):\n            return value.to_dict()\n        elif isinstance(value, dict):\n            return self._traverse_dict(value)\n        elif isinstance(value, list):\n            return [self._traverse(key, i) for i in value]\n        elif hasattr(value, \'__dict__\'):\n            return self._traverse_dict(value.__dict__)\n        else:\n            return value\n\n    def to_dict(self):\n        return self._traverse_dict(self.__dict__)\n\n\nclass BinaryTree(ToDictMixin):\n    def __init__(self, value, left=None, right=None):\n        self.value = value\n        self.left = left\n        self.right = right\n\n\nclass BinaryTreeWithParent(BinaryTree):\n    def __init__(self, value, left=None,\n                 right=None, parent=None):\n        super().__init__(value, left=left, right=right)\n        self.parent = parent\n\n    def _traverse(self, key, value):\n        if (isinstance(value, BinaryTreeWithParent) and\n                key == \'parent\'):\n            return value.value  # Prevent cycles\n        else:\n            return super()._traverse(key, value)\n\n\nclass NamedSubTree(ToDictMixin):\n    def __init__(self, name, tree_with_parent):\n        self.name = name\n        self.tree_with_parent = tree_with_parent\n\n\nroot = BinaryTreeWithParent(10)\nroot.left = BinaryTreeWithParent(7, parent=root)\nroot.left.right = BinaryTreeWithParent(9, parent=root.left)\n\nmy_tree = NamedSubTree(\'foobar\', root.left.right)\nprint(my_tree.to_dict())  # No infinite loop\n\n>>>\n{\'name\': \'foobar\', \'tree_with_parent\': {\'value\': 9, \'left\': None, \'right\': None, \'parent\': 7}}`, `82043078200573720000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{45-48,55-56}"\n              >\n                <span class="gatsby-code-button-language">py{45-48,55-56}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">ToDictMixin</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">_traverse_dict</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        output <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n        <span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> instance_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            output<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> output\n\n    <span class="token keyword">def</span> <span class="token function">_traverse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> ToDictMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> value<span class="token punctuation">.</span>to_dict<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_traverse_dict<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n        <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span>key<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> value<span class="token punctuation">]</span>\n        <span class="token keyword">elif</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token string">\'__dict__\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_traverse_dict<span class="token punctuation">(</span>value<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> value\n\n    <span class="token keyword">def</span> <span class="token function">to_dict</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_traverse_dict<span class="token punctuation">(</span>self<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">BinaryTree</span><span class="token punctuation">(</span>ToDictMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">,</span> left<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> right<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value\n        self<span class="token punctuation">.</span>left <span class="token operator">=</span> left\n        self<span class="token punctuation">.</span>right <span class="token operator">=</span> right\n\n\n<span class="token keyword">class</span> <span class="token class-name">BinaryTreeWithParent</span><span class="token punctuation">(</span>BinaryTree<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">,</span> left<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>\n                 right<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> parent<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>value<span class="token punctuation">,</span> left<span class="token operator">=</span>left<span class="token punctuation">,</span> right<span class="token operator">=</span>right<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>parent <span class="token operator">=</span> parent\n\n    <span class="token keyword">def</span> <span class="token function">_traverse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> BinaryTreeWithParent<span class="token punctuation">)</span> <span class="token keyword">and</span>\n                key <span class="token operator">==</span> <span class="token string">\'parent\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> value<span class="token punctuation">.</span>value  <span class="token comment"># Prevent cycles</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">class</span> <span class="token class-name">NamedSubTree</span><span class="token punctuation">(</span>ToDictMixin<span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> tree_with_parent<span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name</span><span class="gatsby-highlight-code-line">        self<span class="token punctuation">.</span>tree_with_parent <span class="token operator">=</span> tree_with_parent</span>\n\nroot <span class="token operator">=</span> BinaryTreeWithParent<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>\nroot<span class="token punctuation">.</span>left <span class="token operator">=</span> BinaryTreeWithParent<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> parent<span class="token operator">=</span>root<span class="token punctuation">)</span>\nroot<span class="token punctuation">.</span>left<span class="token punctuation">.</span>right <span class="token operator">=</span> BinaryTreeWithParent<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> parent<span class="token operator">=</span>root<span class="token punctuation">.</span>left<span class="token punctuation">)</span>\n\n<span class="gatsby-highlight-code-line">my_tree <span class="token operator">=</span> NamedSubTree<span class="token punctuation">(</span><span class="token string">\'foobar\'</span><span class="token punctuation">,</span> root<span class="token punctuation">.</span>left<span class="token punctuation">.</span>right<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">print</span><span class="token punctuation">(</span>my_tree<span class="token punctuation">.</span>to_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># No infinite loop</span></span>\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">{</span><span class="token string">\'name\'</span><span class="token punctuation">:</span> <span class="token string">\'foobar\'</span><span class="token punctuation">,</span> <span class="token string">\'tree_with_parent\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'value\'</span><span class="token punctuation">:</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token string">\'left\'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">\'right\'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">\'parent\'</span><span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>多个 mix-in 可以组合起来用。例如，我们要再写一个 mix-in，让所有的类都可以通过继承它来实现 JSON 序列化功能。在编写这个 mix-in 时，假设继承了它的那个类肯定有自己的 <code class="language-text">to_dict</code> 方法（这个方法有可能是从另一个 mix-in（如 ToDictMixin）继承的）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21642143731360640000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import json\n\n\nclass JsonMixin:\n    @classmethod\n    def from_json(cls, data):\n        kwargs = json.loads(data)\n        return cls(**kwargs)\n\n    def to_json(self):\n        return json.dumps(self.to_dict())`, `21642143731360640000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> json\n\n\n<span class="token keyword">class</span> <span class="token class-name">JsonMixin</span><span class="token punctuation">:</span>\n    @<span class="token builtin">classmethod</span>\n    <span class="token keyword">def</span> <span class="token function">from_json</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        kwargs <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> cls<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">to_json</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>self<span class="token punctuation">.</span>to_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>请注意，JsonMixin 既定义了实例方法，也定义了类方法。于是，继承了这个 mix-in 的其他类也会拥有这两种行为。在本例中，继承 JsonMixin 的类只需要提供 <code class="language-text">to_dict</code> 方法以及能够接受关键字参数的 <code class="language-text">__init__</code> 方法即可（参见第 23 条）。</p>\n<p>有了这样两个 mix-in，我们很容易就能创建一套含有工具类的体系，让其中的各种类型都可以把对象序列化成 JSON 格式并且能够根据 JSON 格式的数据创建这样的对象。而这只需要开发者按照固定的样式多写一点点代码即可。例如，可以用这样一套由数据类所构成的体系表示数据中心的各种设备与它们之间的结构关系。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13168794905463742000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import json\n\n\nclass ToDictMixin:\n    def _traverse_dict(self, instance_dict):\n        output = {}\n        for key, value in instance_dict.items():\n            output[key] = self._traverse(key, value)\n        return output\n\n    def _traverse(self, key, value):\n        if isinstance(value, ToDictMixin):\n            return value.to_dict()\n        elif isinstance(value, dict):\n            return self._traverse_dict(value)\n        elif isinstance(value, list):\n            return [self._traverse(key, i) for i in value]\n        elif hasattr(value, \'__dict__\'):\n            return self._traverse_dict(value.__dict__)\n        else:\n            return value\n\n    def to_dict(self):\n        return self._traverse_dict(self.__dict__)\n\n\nclass JsonMixin:\n    @classmethod\n    def from_json(cls, data):\n        kwargs = json.loads(data)\n        return cls(**kwargs)\n\n    def to_json(self):\n        return json.dumps(self.to_dict())\n\n\nclass Switch(ToDictMixin, JsonMixin):\n    def __init__(self, ports=None, speed=None):\n        self.ports = ports\n        self.speed = speed\n\n\nclass Machine(ToDictMixin, JsonMixin):\n    def __init__(self, cores=None, ram=None, disk=None):\n        self.cores = cores\n        self.ram = ram\n        self.disk = disk\n\n\nclass DatacenterRack(ToDictMixin, JsonMixin):\n    def __init__(self, switch=None, machines=None):\n        self.switch = Switch(**switch)\n        self.machines = [\n            Machine(**kwargs) for kwargs in machines]\n\n\nserialized = &quot;&quot;&quot;{\n    &quot;switch&quot;: {&quot;ports&quot;: 5, &quot;speed&quot;: 1e9},\n    &quot;machines&quot;: [\n        {&quot;cores&quot;: 8, &quot;ram&quot;: 32e9, &quot;disk&quot;: 5e12},\n        {&quot;cores&quot;: 4, &quot;ram&quot;: 16e9, &quot;disk&quot;: 1e12},\n        {&quot;cores&quot;: 2, &quot;ram&quot;: 4e9, &quot;disk&quot;: 500e9}\n    ]\n}\n&quot;&quot;&quot;\n\ndeserialized = DatacenterRack.from_json(serialized)\nroundtrip = deserialized.to_json()\nassert json.loads(serialized) == json.loads(roundtrip)`, `13168794905463742000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> json\n\n\n<span class="token keyword">class</span> <span class="token class-name">ToDictMixin</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">_traverse_dict</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        output <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n        <span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> instance_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            output<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> output\n\n    <span class="token keyword">def</span> <span class="token function">_traverse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> ToDictMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> value<span class="token punctuation">.</span>to_dict<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_traverse_dict<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n        <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span>key<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> value<span class="token punctuation">]</span>\n        <span class="token keyword">elif</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token string">\'__dict__\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_traverse_dict<span class="token punctuation">(</span>value<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> value\n\n    <span class="token keyword">def</span> <span class="token function">to_dict</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_traverse_dict<span class="token punctuation">(</span>self<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">JsonMixin</span><span class="token punctuation">:</span>\n    @<span class="token builtin">classmethod</span>\n    <span class="token keyword">def</span> <span class="token function">from_json</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        kwargs <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> cls<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">to_json</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>self<span class="token punctuation">.</span>to_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Switch</span><span class="token punctuation">(</span>ToDictMixin<span class="token punctuation">,</span> JsonMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ports<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> speed<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>ports <span class="token operator">=</span> ports\n        self<span class="token punctuation">.</span>speed <span class="token operator">=</span> speed\n\n\n<span class="token keyword">class</span> <span class="token class-name">Machine</span><span class="token punctuation">(</span>ToDictMixin<span class="token punctuation">,</span> JsonMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> cores<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> ram<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> disk<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>cores <span class="token operator">=</span> cores\n        self<span class="token punctuation">.</span>ram <span class="token operator">=</span> ram\n        self<span class="token punctuation">.</span>disk <span class="token operator">=</span> disk\n\n\n<span class="token keyword">class</span> <span class="token class-name">DatacenterRack</span><span class="token punctuation">(</span>ToDictMixin<span class="token punctuation">,</span> JsonMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> switch<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> machines<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>switch <span class="token operator">=</span> Switch<span class="token punctuation">(</span><span class="token operator">**</span>switch<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>machines <span class="token operator">=</span> <span class="token punctuation">[</span>\n            Machine<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span> <span class="token keyword">for</span> kwargs <span class="token keyword">in</span> machines<span class="token punctuation">]</span>\n\n\nserialized <span class="token operator">=</span> <span class="token triple-quoted-string string">"""{\n    "switch": {"ports": 5, "speed": 1e9},\n    "machines": [\n        {"cores": 8, "ram": 32e9, "disk": 5e12},\n        {"cores": 4, "ram": 16e9, "disk": 1e12},\n        {"cores": 2, "ram": 4e9, "disk": 500e9}\n    ]\n}\n"""</span>\n\ndeserialized <span class="token operator">=</span> DatacenterRack<span class="token punctuation">.</span>from_json<span class="token punctuation">(</span>serialized<span class="token punctuation">)</span>\nroundtrip <span class="token operator">=</span> deserialized<span class="token punctuation">.</span>to_json<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">assert</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>serialized<span class="token punctuation">)</span> <span class="token operator">==</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>roundtrip<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写之后，我们很容易就能根据 JSON 格式的信息把这些对象还原出来，另外，也可以把它们再序列化成 JSON 格式。下面我们就先把 serialized 变量所指的一段 JSON 信息反序列化（也就是还原）成 DatacenterRack 对象，然后再把这个对象序列化成 JSON 信息并保存到 roundtrip 变量，最后通过 json.loads 方法验证这两个变量中的信息是否等效。</p>\n<p>对于 JsonMixin 这样的 mix-in 来说，即便直接继承它的那个类还通过类体系中的其他更高层类型间接地继承了它，程序也依然能够正常运行，因为 Python 可以把相关的方法正确地派发给 JsonMixin 类。</p>\n<h3 id="总结-37"><a href="#%E6%80%BB%E7%BB%93-37" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>超类最好能写成不带实例属性与 <code class="language-text">__init__</code> 方法的 mix-in 类，以避免由多重继承所引发的一些问题。</li>\n<li>如果子类要定制（或者说修改）mix-in 所提供的功能，那么可以在自己的代码里面覆盖相关的实例方法。</li>\n<li>根据需求，mix-in 可以只提供实例方法，也可以只提供类方法，还可以同时提供这两种方法。</li>\n<li>把每个 mix-in 所提供的简单功能组合起来，可以实现比较复杂的功能。</li>\n</ol>\n<h2 id="第-42-条：优先考虑用-public-属性表示应受保护的数据，不要用-private-属性表示"><a href="#%E7%AC%AC-42-%E6%9D%A1%EF%BC%9A%E4%BC%98%E5%85%88%E8%80%83%E8%99%91%E7%94%A8-public-%E5%B1%9E%E6%80%A7%E8%A1%A8%E7%A4%BA%E5%BA%94%E5%8F%97%E4%BF%9D%E6%8A%A4%E7%9A%84%E6%95%B0%E6%8D%AE%EF%BC%8C%E4%B8%8D%E8%A6%81%E7%94%A8-private-%E5%B1%9E%E6%80%A7%E8%A1%A8%E7%A4%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 42 条：优先考虑用 public 属性表示应受保护的数据，不要用 private 属性表示</h2>\n<p>Python 类的属性只有两种访问级别，也就是 public 与 private。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11199370356691319000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyObject:\n    def __init__(self):\n        self.public_field = 5\n        self.__private_field = 10\n\n    def get_private_field(self):\n        return self.__private_field`, `11199370356691319000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyObject</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>public_field <span class="token operator">=</span> <span class="token number">5</span>\n        self<span class="token punctuation">.</span>__private_field <span class="token operator">=</span> <span class="token number">10</span>\n\n    <span class="token keyword">def</span> <span class="token function">get_private_field</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>__private_field</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>public 属性能够公开访问，只需要在对象后面加上圆点操作符（dot operator），并写出属性的名称即可。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18404281840251046000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyObject:\n    def __init__(self):\n        self.public_field = 5\n        self.__private_field = 10\n\n    def get_private_field(self):\n        return self.__private_field\n\n\nfoo = MyObject()\nassert foo.public_field == 5`, `18404281840251046000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{10-11}"\n              >\n                <span class="gatsby-code-button-language">py{10-11}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyObject</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>public_field <span class="token operator">=</span> <span class="token number">5</span>\n        self<span class="token punctuation">.</span>__private_field <span class="token operator">=</span> <span class="token number">10</span>\n\n    <span class="token keyword">def</span> <span class="token function">get_private_field</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>__private_field\n\n\n<span class="gatsby-highlight-code-line">foo <span class="token operator">=</span> MyObject<span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">assert</span> foo<span class="token punctuation">.</span>public_field <span class="token operator">==</span> <span class="token number">5</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果属性名以两个下划线开头，那么即为 private 字段。属性所在的类可以通过实例方法访问该属性。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6646287446471489000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyObject:\n    def __init__(self):\n        self.public_field = 5\n        self.__private_field = 10\n\n    def get_private_field(self):\n        return self.__private_field\n\n\nfoo = MyObject()\nassert foo.get_private_field() == 10`, `6646287446471489000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{11}"\n              >\n                <span class="gatsby-code-button-language">py{11}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyObject</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>public_field <span class="token operator">=</span> <span class="token number">5</span>\n        self<span class="token punctuation">.</span>__private_field <span class="token operator">=</span> <span class="token number">10</span>\n\n    <span class="token keyword">def</span> <span class="token function">get_private_field</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>__private_field\n\n\nfoo <span class="token operator">=</span> MyObject<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">assert</span> foo<span class="token punctuation">.</span>get_private_field<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">10</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但如果在类的外面直接通过对象访问 private 字段，那么程序就会抛出异常。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17654083115722875000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyObject:\n    def __init__(self):\n        self.public_field = 5\n        self.__private_field = 10\n\n    def get_private_field(self):\n        return self.__private_field\n\n\nfoo = MyObject()\nfoo.__private_field\n\n>>>\nTraceback ...\nAttributeError: \'MyObject\' object has no attribute \'__private_field\'`, `17654083115722875000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{11}"\n              >\n                <span class="gatsby-code-button-language">py{11}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyObject</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>public_field <span class="token operator">=</span> <span class="token number">5</span>\n        self<span class="token punctuation">.</span>__private_field <span class="token operator">=</span> <span class="token number">10</span>\n\n    <span class="token keyword">def</span> <span class="token function">get_private_field</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>__private_field\n\n\nfoo <span class="token operator">=</span> MyObject<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="gatsby-highlight-code-line">foo<span class="token punctuation">.</span>__private_field</span>\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nAttributeError<span class="token punctuation">:</span> <span class="token string">\'MyObject\'</span> <span class="token builtin">object</span> has no attribute <span class="token string">\'__private_field\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>类方法（@classmethod）可以访问本类的 private 属性，因为这种方法也是在这个类（class）的范围里面声明的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91611949408236730000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyOtherObject:\n    def __init__(self):\n        self.__private_field = 71\n\n    @classmethod\n    def get_private_field_of_instance(cls, instance):\n        return instance.__private_field\n\n\nbar = MyOtherObject()\nassert MyOtherObject.get_private_field_of_instance(bar) == 71`, `91611949408236730000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyOtherObject</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>__private_field <span class="token operator">=</span> <span class="token number">71</span>\n\n    @<span class="token builtin">classmethod</span>\n    <span class="token keyword">def</span> <span class="token function">get_private_field_of_instance</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> instance<span class="token punctuation">.</span>__private_field\n\n\nbar <span class="token operator">=</span> MyOtherObject<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">assert</span> MyOtherObject<span class="token punctuation">.</span>get_private_field_of_instance<span class="token punctuation">(</span>bar<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">71</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>private 字段只给这个类自己使用，子类不能访问超类的 private 字段。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13003676493506089000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyParentObject:\n    def __init__(self):\n        self.__private_field = 71\n\n\nclass MyChildObject(MyParentObject):\n    def get_private_field(self):\n        return self.__private_field\n\n\nbaz = MyChildObject()\nbaz.get_private_field()\n\n>>>\nTraceback ...\nAttributeError: \'MyChildObject\' object has no attribute \'_MyChildObject__private_field\'`, `13003676493506089000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyParentObject</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>__private_field <span class="token operator">=</span> <span class="token number">71</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">MyChildObject</span><span class="token punctuation">(</span>MyParentObject<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">get_private_field</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>__private_field\n\n\nbaz <span class="token operator">=</span> MyChildObject<span class="token punctuation">(</span><span class="token punctuation">)</span>\nbaz<span class="token punctuation">.</span>get_private_field<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nAttributeError<span class="token punctuation">:</span> <span class="token string">\'MyChildObject\'</span> <span class="token builtin">object</span> has no attribute <span class="token string">\'_MyChildObject__private_field\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种防止其他类访问 private 属性的功能，其实仅仅是通过变换属性名称而实现的。当 Python 编译器看到 <code class="language-text">MyChildObject.get_private_field</code> 这样的方法想要访问 <code class="language-text">__private_field</code> 属性时，它会把下划线和类名加在这个属性名称的前面，所以代码实际上访问的是 <code class="language-text">_MyChildObject__private_field</code>。在上面的例子中，<code class="language-text">__private_field</code> 是在 MyParentObject 的 <code class="language-text">__init__</code> 里面定义的，所以，它变换之后的真实名称是 <code class="language-text">_MyParentObject__private_field</code>。子类不能通过 <code class="language-text">__private_field</code> 来访问这个属性，因为这样写实际上是在访问不存在的 <code class="language-text">_MyChildObject__private_field</code>，而不是 <code class="language-text">_MyParentObject__private_field</code>。</p>\n<p>了解名称变换规则后，我们就可以从任何一个类里面访问 private 属性。无论是子类还是外部的类，都可以不经许可就访问到这些属性。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37435569206543630000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyParentObject:\n    def __init__(self):\n        self.__private_field = 71\n\n\nclass MyChildObject(MyParentObject):\n    def get_private_field(self):\n        return self.__private_field\n\n\nbaz = MyChildObject()\nassert baz._MyParentObject__private_field == 71`, `37435569206543630000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{12}"\n              >\n                <span class="gatsby-code-button-language">py{12}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyParentObject</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>__private_field <span class="token operator">=</span> <span class="token number">71</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">MyChildObject</span><span class="token punctuation">(</span>MyParentObject<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">get_private_field</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>__private_field\n\n\nbaz <span class="token operator">=</span> MyChildObject<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">assert</span> baz<span class="token punctuation">.</span>_MyParentObject__private_field <span class="token operator">==</span> <span class="token number">71</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>查看该对象的属性字典，就会发现 private 属性的名称其实是以变换后的名称存储的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26602637361149650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`print(baz.__dict__)\n\n>>>\n{\'_MyParentObject__private_field\': 71}`, `26602637361149650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">print</span><span class="token punctuation">(</span>baz<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">{</span><span class="token string">\'_MyParentObject__private_field\'</span><span class="token punctuation">:</span> <span class="token number">71</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>为什么 Python 不从语法上严格禁止其他类访问 private 属性呢？这可以用一句常见的 Python 格言来回答：我们都是成年人了（We are all consenting adults here）。意思是说，我们用不着让编程语言把自己给拦住。你可以按照自己的想法扩展某个类的功能，同时也必须考虑到这样做的风险，并为此负责。Python 开发者相信，虽然开放访问权限可能导致别人不按默认方式扩展这个类，但总比封闭起来要好。</p>\n<p>另外，Python 里面还有一些挂钩函数可以访问到这种属性（参见第 47 条），我们可以通过这些机制按需操纵对象的内部数据。既然这样，那即便 Python 阻止我们通过圆点加名称的办法访问 private 属性，我们也还是有其他办法能访问到，那么 Python 阻止 private 属性访问又有何意义？</p>\n<p>为了减少在不知情情况下访问内部数据而造成的损伤，Python 开发者会按照风格指南里面建议的方式来给字段命名（参见第 2 条）。以单下划线开头的字段（例如 <code class="language-text">_protected_field</code>），习惯上叫作受保护的（protected）字段，表示这个类以外的用户在使用这种字段时必须慎重。</p>\n<p>尽管如此，有许多 Python 新手还是喜欢把内部的 API 设计成 private 字段，想通过这种写法防止子类或外部类访问这些字段。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15542449937009283000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyStringClass:\n    def __init__(self, value):\n        self.__value = value\n\n    def get_value(self):\n        return str(self.__value)\n\n\nfoo = MyStringClass(5)\nassert foo.get_value() == \'5\'`, `15542449937009283000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyStringClass</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>__value <span class="token operator">=</span> value\n\n    <span class="token keyword">def</span> <span class="token function">get_value</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>__value<span class="token punctuation">)</span>\n\n\nfoo <span class="token operator">=</span> MyStringClass<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>\n<span class="token keyword">assert</span> foo<span class="token punctuation">.</span>get_value<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">\'5\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这么写不对。因为总会有开发者（也包括你自己）想要继承这个类，并给里面添加新的行为，或采用更高效的办法来实现已有的行为（例如他可能觉得，<code class="language-text">MyStringClass.get_value</code> 总是返回字符串的方式的效率不高）。如果把属性设为 private，那么子类在覆盖或扩充这个类的时候，就必须采用变换之后的名称来访问那个属性，这会让代码变得很容易出错。例如，在写这样一个子类时，就不得不去访问超类中的 private 字段。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8143832419197827000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyStringClass:\n    def __init__(self, value):\n        self.__value = value\n\n    def get_value(self):\n        return str(self.__value)\n\n\nclass MyIntegerSubclass(MyStringClass):\n    def get_value(self):\n        return int(self._MyStringClass__value)\n\n\nfoo = MyIntegerSubclass(\'5\')\nassert foo.get_value() == 5`, `8143832419197827000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyStringClass</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>__value <span class="token operator">=</span> value\n\n    <span class="token keyword">def</span> <span class="token function">get_value</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>__value<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">MyIntegerSubclass</span><span class="token punctuation">(</span>MyStringClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">get_value</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token builtin">int</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_MyStringClass__value<span class="token punctuation">)</span>\n\n\nfoo <span class="token operator">=</span> MyIntegerSubclass<span class="token punctuation">(</span><span class="token string">\'5\'</span><span class="token punctuation">)</span>\n<span class="token keyword">assert</span> foo<span class="token punctuation">.</span>get_value<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">5</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写的问题是，如果类体系发生变动，那么引用 private 属性的那些代码就失效了。例如，MyIntegerSubclass 类的直接超类（也就是 MyStringClass）本身现在也继承自一个类（叫作 MyBaseClass），而且它把早前的 <code class="language-text">__value</code> 属性移到了那个类里面。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25872651876286423000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyBaseClass:\n    def __init__(self, value):\n        self.__value = value\n\n    def get_value(self):\n        return self.__value\n\n\nclass MyStringClass(MyBaseClass):\n    def get_value(self):\n        return str(super().get_value())  # Updated\n\n\nclass MyIntegerSubclass(MyStringClass):\n    def get_value(self):\n        return int(self._MyStringClass__value)  # Not updated\n\n\nfoo = MyIntegerSubclass(5)\nfoo.get_value()\n\n>>>\nTraceback ...\nAttributeError: \'MyIntegerSubclass\' object has no attribute \'_MyStringClass__value\'`, `25872651876286423000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyBaseClass</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>__value <span class="token operator">=</span> value\n\n    <span class="token keyword">def</span> <span class="token function">get_value</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>__value\n\n\n<span class="token keyword">class</span> <span class="token class-name">MyStringClass</span><span class="token punctuation">(</span>MyBaseClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">get_value</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_value<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># Updated</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">MyIntegerSubclass</span><span class="token punctuation">(</span>MyStringClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">get_value</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token builtin">int</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_MyStringClass__value<span class="token punctuation">)</span>  <span class="token comment"># Not updated</span>\n\n\nfoo <span class="token operator">=</span> MyIntegerSubclass<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>\nfoo<span class="token punctuation">.</span>get_value<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nAttributeError<span class="token punctuation">:</span> <span class="token string">\'MyIntegerSubclass\'</span> <span class="token builtin">object</span> has no attribute <span class="token string">\'_MyStringClass__value\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在的 <code class="language-text">__value</code> 属性，是在 MyBaseClass 里面设置的，而不是在 MyStringClass 里面，所以 MyIntegerSubclass 没办法再通过 <code class="language-text">self._MyStringClass__value</code> 访问这个属性。</p>\n<p>一般来说，这种属性应该设置成 protected 字段，这样虽然有可能导致子类误用，但还是要比直接设为 private 好。我们可以在每个 protected 字段的文档里面详细解释，告诉用户这是属于可以由子类来操作的内部 API，还是属于完全不应该触碰的数据。这样的文档，既可以给别人提供建议，也可以指导自己安全地扩充代码。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42272529237967380000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyStringClass:\n    def __init__(self, value):\n        # This stores the user-supplied value for the object.\n        # It should be coercible to a string. Once assigned in\n        # the object it should be treated as immutable.\n        self._value = value`, `42272529237967380000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyStringClass</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token comment"># This stores the user-supplied value for the object.</span>\n        <span class="token comment"># It should be coercible to a string. Once assigned in</span>\n        <span class="token comment"># the object it should be treated as immutable.</span>\n        self<span class="token punctuation">.</span>_value <span class="token operator">=</span> value</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>只有一种情况是可以考虑用 private 属性解决的，就是子类属性有可能与超类重名的情况。如果子类定义属性时使用的名称，恰巧与超类相同，那就会出现这个问题。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59338407946401480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class ApiClass:\n    def __init__(self):\n        self._value = 5\n\n    def get(self):\n        return self._value\n\n\nclass Child(ApiClass):\n    def __init__(self):\n        super().__init__()\n        self._value = \'hello\'  # Conflicts\n\n\na = Child()\nprint(f\'{a.get()} and {a._value} should be different\')`, `59338407946401480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">ApiClass</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_value <span class="token operator">=</span> <span class="token number">5</span>\n\n    <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_value\n\n\n<span class="token keyword">class</span> <span class="token class-name">Child</span><span class="token punctuation">(</span>ApiClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>_value <span class="token operator">=</span> <span class="token string">\'hello\'</span>  <span class="token comment"># Conflicts</span>\n\n\na <span class="token operator">=</span> Child<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>a<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> and </span><span class="token interpolation"><span class="token punctuation">{</span>a<span class="token punctuation">.</span>_value<span class="token punctuation">}</span></span><span class="token string"> should be different\'</span></span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果超类属于开放给外界使用的 API，那么你就没办法预料哪些子类会继承它，也不知道那些子类会添加什么属性，此时很有可能出现这个问题，而且你无法通过重构代码来解决。属性名越常见（如本例中的 value），越容易发生冲突。为了减少冲突，我们可以把超类的属性设计成 private 属性，使子类的属性名不太可能与超类重复。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42352989554737500000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class ApiClass:\n    def __init__(self):\n        self.__value = 5  # Double underscore\n\n    def get(self):\n        return self.__value  # Double underscore\n\n\nclass Child(ApiClass):\n    def __init__(self):\n        super().__init__()\n        self._value = \'hello\'  # OK!\n\n\na = Child()\nprint(f\'{a.get()} and {a._value} are different\')`, `42352989554737500000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">ApiClass</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>__value <span class="token operator">=</span> <span class="token number">5</span>  <span class="token comment"># Double underscore</span>\n\n    <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>__value  <span class="token comment"># Double underscore</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Child</span><span class="token punctuation">(</span>ApiClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>_value <span class="token operator">=</span> <span class="token string">\'hello\'</span>  <span class="token comment"># OK!</span>\n\n\na <span class="token operator">=</span> Child<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>a<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> and </span><span class="token interpolation"><span class="token punctuation">{</span>a<span class="token punctuation">.</span>_value<span class="token punctuation">}</span></span><span class="token string"> are different\'</span></span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="总结-38"><a href="#%E6%80%BB%E7%BB%93-38" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>Python 编译器无法绝对禁止外界访问 private 属性。</li>\n<li>从一开始就应该考虑允许其他类能继承这个类，并利用其中的内部 API 与属性去实现更多功能，而不是把它们藏起来。</li>\n<li>把需要保护的数据设计成 protected 字段，并用文档加以解释，而不要通过 private 属性限制访问。</li>\n<li>只有在子类不受控制且名称有可能与超类冲突时，才可以考虑给超类设计 private 属性。</li>\n</ol>\n<h2 id="第-43-条：自定义的容器类型应该从-collectionsabc-继承"><a href="#%E7%AC%AC-43-%E6%9D%A1%EF%BC%9A%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84%E5%AE%B9%E5%99%A8%E7%B1%BB%E5%9E%8B%E5%BA%94%E8%AF%A5%E4%BB%8E-collectionsabc-%E7%BB%A7%E6%89%BF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 43 条：自定义的容器类型应该从 collections.abc 继承</h2>\n<p>编写 Python 程序时，要花很多精力来定义类，以存放数据并描述这种对象与其他对象之间的关系。每个 Python 类其实都是某种容器，可以把属性与功能封装进来。除了自定义的类之外，Python 本身还提供了一些内置的容器类型，例如列表（list）、元组（tuple）、集合（set）、字典（dict）等，也可以用来管理数据。</p>\n<p>如果要定义的是那种用法比较简单的类，那么我们自然就会想到直接从 Python 内置的容器类型里面继承，例如通过继承 list 类型实现某种序列。下面就是笔者自己定制的一种 list 类型，它在 list 的基础上提供了 frequency 方法，用来计算每个元素出现的次数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79490457767537870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class FrequencyList(list):\n    def __init__(self, members):\n        super().__init__(members)\n\n    def frequency(self):\n        counts = {}\n        for item in self:\n            counts[item] = counts.get(item, 0) + 1\n        return counts`, `79490457767537870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">FrequencyList</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> members<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>members<span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">frequency</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        counts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n        <span class="token keyword">for</span> item <span class="token keyword">in</span> self<span class="token punctuation">:</span>\n            counts<span class="token punctuation">[</span>item<span class="token punctuation">]</span> <span class="token operator">=</span> counts<span class="token punctuation">.</span>get<span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>\n        <span class="token keyword">return</span> counts</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>继承 list 类，可以自动获得标准的 Python 列表所具备的各项功能。这样的话，其他开发者就可以像使用普通列表那样使用 FrequencyList 了。此外，我们还可以定义其他一些方法，来提供想要实现的各种行为。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30711328070580660000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class FrequencyList(list):\n    def __init__(self, members):\n        super().__init__(members)\n\n    def frequency(self):\n        counts = {}\n        for item in self:\n            counts[item] = counts.get(item, 0) + 1\n        return counts\n\n\nfoo = FrequencyList([\'a\', \'b\', \'a\', \'c\', \'b\', \'a\', \'d\'])\nprint(\'Length is\', len(foo))\n\nprint(foo.pop())\nprint(\'After pop:\', repr(foo))\nprint(\'Frequency:\', foo.frequency())\n\n>>>\nLength is 7\nd\nAfter pop: [\'a\', \'b\', \'a\', \'c\', \'b\', \'a\']\nFrequency: {\'a\': 3, \'b\': 2, \'c\': 1}`, `30711328070580660000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{12-17}"\n              >\n                <span class="gatsby-code-button-language">py{12-17}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">FrequencyList</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> members<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>members<span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">frequency</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        counts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n        <span class="token keyword">for</span> item <span class="token keyword">in</span> self<span class="token punctuation">:</span>\n            counts<span class="token punctuation">[</span>item<span class="token punctuation">]</span> <span class="token operator">=</span> counts<span class="token punctuation">.</span>get<span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>\n        <span class="token keyword">return</span> counts\n\n\n<span class="gatsby-highlight-code-line">foo <span class="token operator">=</span> FrequencyList<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Length is\'</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line"><span class="token keyword">print</span><span class="token punctuation">(</span>foo<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After pop:\'</span><span class="token punctuation">,</span> <span class="token builtin">repr</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Frequency:\'</span><span class="token punctuation">,</span> foo<span class="token punctuation">.</span>frequency<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>\n<span class="token operator">>></span><span class="token operator">></span>\nLength <span class="token keyword">is</span> <span class="token number">7</span>\nd\nAfter pop<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'a\'</span><span class="token punctuation">]</span>\nFrequency<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'a\'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>有的时候，某个对象所属的类本身虽然不是 list 的子类，但我们还是想让它能像 list 那样，可以通过下标来访问。例如，下面这个表示二叉树节点的 BinaryNode 类就不是 list 的子类，但我们想让它能够像序列（list 或 tuple 等）那样，通过下标来访问。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5255902384942268000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class BinaryNode:\n    def __init__(self, value, left=None, right=None):\n        self.value = value\n        self.left = left\n        self.right = right`, `5255902384942268000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">BinaryNode</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">,</span> left<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> right<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value\n        self<span class="token punctuation">.</span>left <span class="token operator">=</span> left\n        self<span class="token punctuation">.</span>right <span class="token operator">=</span> right</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们需要怎么做，才能让这个类可以像序列一样访问呢？答案是，需要实现一些名称特殊的实例方法。当通过下标访问序列中的元素时：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46629198206424330000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`bar = [1, 2, 3]\nbar[0]`, `46629198206424330000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">bar <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>\nbar<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>Python 会把访问操作解读为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6680716905761596000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`bar.__getitem__(0)`, `6680716905761596000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">bar<span class="token punctuation">.</span>__getitem__<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>所以，为了让 BinaryNode 类能像序列那样使用，我们可以定义 <code class="language-text">__getitem__</code> 方法（一般叫作 dunder getitem，其中的 dunder 为 double underscore（双下划线）的简称）。这个方法可以按照深度优先的方式遍历 BinaryNode 对象所表示的二叉树。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78494163495916850000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class BinaryNode:\n    def __init__(self, value, left=None, right=None):\n        self.value = value\n        self.left = left\n        self.right = right\n\n\nclass IndexableNode(BinaryNode):\n    def _traverse(self):\n        if self.left is not None:\n            yield from self.left._traverse()\n        yield self\n        if self.right is not None:\n            yield from self.right._traverse()\n\n    def __getitem__(self, index):\n        for i, item in enumerate(self._traverse()):\n            if i == index:\n                return item.value\n        raise IndexError(f\'Index {index} is out of range\')\n\n\ntree = IndexableNode(\n    10,\n    left=IndexableNode(\n        5,\n        left=IndexableNode(2),\n        right=IndexableNode(\n            6,\n            right=IndexableNode(7))),\n    right=IndexableNode(\n        15,\n        left=IndexableNode(11)))\n\nprint(\'LRR is\', tree.left.right.right.value)\nprint(\'Index 0 is\', tree[0])\nprint(\'Index 1 is\', tree[1])\nprint(\'11 in the tree?\', 11 in tree)\nprint(\'17 in the tree?\', 17 in tree)\nprint(\'Tree is\', list(tree))\n\n>>>\nLRR is 7\nIndex 0 is 2\nIndex 1 is 5\n11 in the tree? True\n17 in the tree? False\nTree is [2, 5, 6, 7, 10, 11, 15]`, `78494163495916850000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">BinaryNode</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">,</span> left<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> right<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value\n        self<span class="token punctuation">.</span>left <span class="token operator">=</span> left\n        self<span class="token punctuation">.</span>right <span class="token operator">=</span> right\n\n\n<span class="token keyword">class</span> <span class="token class-name">IndexableNode</span><span class="token punctuation">(</span>BinaryNode<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">_traverse</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> self<span class="token punctuation">.</span>left <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n            <span class="token keyword">yield</span> <span class="token keyword">from</span> self<span class="token punctuation">.</span>left<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">yield</span> self\n        <span class="token keyword">if</span> self<span class="token punctuation">.</span>right <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n            <span class="token keyword">yield</span> <span class="token keyword">from</span> self<span class="token punctuation">.</span>right<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">for</span> i<span class="token punctuation">,</span> item <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">if</span> i <span class="token operator">==</span> index<span class="token punctuation">:</span>\n                <span class="token keyword">return</span> item<span class="token punctuation">.</span>value\n        <span class="token keyword">raise</span> IndexError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Index </span><span class="token interpolation"><span class="token punctuation">{</span>index<span class="token punctuation">}</span></span><span class="token string"> is out of range\'</span></span><span class="token punctuation">)</span>\n\n\ntree <span class="token operator">=</span> IndexableNode<span class="token punctuation">(</span>\n    <span class="token number">10</span><span class="token punctuation">,</span>\n    left<span class="token operator">=</span>IndexableNode<span class="token punctuation">(</span>\n        <span class="token number">5</span><span class="token punctuation">,</span>\n        left<span class="token operator">=</span>IndexableNode<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        right<span class="token operator">=</span>IndexableNode<span class="token punctuation">(</span>\n            <span class="token number">6</span><span class="token punctuation">,</span>\n            right<span class="token operator">=</span>IndexableNode<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    right<span class="token operator">=</span>IndexableNode<span class="token punctuation">(</span>\n        <span class="token number">15</span><span class="token punctuation">,</span>\n        left<span class="token operator">=</span>IndexableNode<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'LRR is\'</span><span class="token punctuation">,</span> tree<span class="token punctuation">.</span>left<span class="token punctuation">.</span>right<span class="token punctuation">.</span>right<span class="token punctuation">.</span>value<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Index 0 is\'</span><span class="token punctuation">,</span> tree<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Index 1 is\'</span><span class="token punctuation">,</span> tree<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'11 in the tree?\'</span><span class="token punctuation">,</span> <span class="token number">11</span> <span class="token keyword">in</span> tree<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'17 in the tree?\'</span><span class="token punctuation">,</span> <span class="token number">17</span> <span class="token keyword">in</span> tree<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Tree is\'</span><span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">(</span>tree<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nLRR <span class="token keyword">is</span> <span class="token number">7</span>\nIndex <span class="token number">0</span> <span class="token keyword">is</span> <span class="token number">2</span>\nIndex <span class="token number">1</span> <span class="token keyword">is</span> <span class="token number">5</span>\n<span class="token number">11</span> <span class="token keyword">in</span> the tree? <span class="token boolean">True</span>\n<span class="token number">17</span> <span class="token keyword">in</span> the tree? <span class="token boolean">False</span>\nTree <span class="token keyword">is</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们可以像使用 BinaryNode 那样，用这种定制过的 IndexableNode 对象来构造二叉树。</p>\n<p>我们既可以像访问列表那样来访问二叉树中的节点，也可以明确通过 left 与 right 属性来访问。</p>\n<p>但问题是，除了下标索引，list 实例还支持其他一些功能，所以只实现 <code class="language-text">__getitem__</code> 这样一个特殊方法是不够的。例如，我们现在还是没办法像查询 list 长度那样查询这种二叉树的长度（元素总数）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8722691083686818000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`len(tree)\n\n>>>\nTraceback ...\nTypeError: object of type \'IndexableNode\' has no len()`, `8722691083686818000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token builtin">len</span><span class="token punctuation">(</span>tree<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> <span class="token builtin">object</span> of <span class="token builtin">type</span> <span class="token string">\'IndexableNode\'</span> has no <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>要想让定制的二叉树支持内置的 len 函数，必须再实现一个特殊方法，也就是 <code class="language-text">__len__</code> 方法。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45033380603699765000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class BinaryNode:\n    def __init__(self, value, left=None, right=None):\n        self.value = value\n        self.left = left\n        self.right = right\n\n\nclass SequenceNode(BinaryNode):\n    def _traverse(self):\n        if self.left is not None:\n            yield from self.left._traverse()\n        yield self\n        if self.right is not None:\n            yield from self.right._traverse()\n\n    def __getitem__(self, index):\n        for i, item in enumerate(self._traverse()):\n            if i == index:\n                return item.value\n        raise IndexError(f\'Index {index} is out of range\')\n\n    def __len__(self):\n        for count, _ in enumerate(self._traverse(), 1):\n            pass\n        return count\n\n\ntree = SequenceNode(\n    10,\n    left=SequenceNode(\n        5,\n        left=SequenceNode(2),\n        right=SequenceNode(\n            6,\n            right=SequenceNode(7))),\n    right=SequenceNode(\n        15,\n        left=SequenceNode(11)))\n\nprint(\'Tree length is\', len(tree))\n\n>>>\nTree length is 7`, `45033380603699765000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{22-25}"\n              >\n                <span class="gatsby-code-button-language">py{22-25}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">BinaryNode</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">,</span> left<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> right<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value\n        self<span class="token punctuation">.</span>left <span class="token operator">=</span> left\n        self<span class="token punctuation">.</span>right <span class="token operator">=</span> right\n\n\n<span class="token keyword">class</span> <span class="token class-name">SequenceNode</span><span class="token punctuation">(</span>BinaryNode<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">_traverse</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> self<span class="token punctuation">.</span>left <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n            <span class="token keyword">yield</span> <span class="token keyword">from</span> self<span class="token punctuation">.</span>left<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">yield</span> self\n        <span class="token keyword">if</span> self<span class="token punctuation">.</span>right <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n            <span class="token keyword">yield</span> <span class="token keyword">from</span> self<span class="token punctuation">.</span>right<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">for</span> i<span class="token punctuation">,</span> item <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">if</span> i <span class="token operator">==</span> index<span class="token punctuation">:</span>\n                <span class="token keyword">return</span> item<span class="token punctuation">.</span>value\n        <span class="token keyword">raise</span> IndexError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Index </span><span class="token interpolation"><span class="token punctuation">{</span>index<span class="token punctuation">}</span></span><span class="token string"> is out of range\'</span></span><span class="token punctuation">)</span>\n\n<span class="gatsby-highlight-code-line">    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">for</span> count<span class="token punctuation">,</span> _ <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">            <span class="token keyword">pass</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">return</span> count</span>\n\ntree <span class="token operator">=</span> SequenceNode<span class="token punctuation">(</span>\n    <span class="token number">10</span><span class="token punctuation">,</span>\n    left<span class="token operator">=</span>SequenceNode<span class="token punctuation">(</span>\n        <span class="token number">5</span><span class="token punctuation">,</span>\n        left<span class="token operator">=</span>SequenceNode<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        right<span class="token operator">=</span>SequenceNode<span class="token punctuation">(</span>\n            <span class="token number">6</span><span class="token punctuation">,</span>\n            right<span class="token operator">=</span>SequenceNode<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    right<span class="token operator">=</span>SequenceNode<span class="token punctuation">(</span>\n        <span class="token number">15</span><span class="token punctuation">,</span>\n        left<span class="token operator">=</span>SequenceNode<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Tree length is\'</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>tree<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTree length <span class="token keyword">is</span> <span class="token number">7</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>实现完这样两个方法之后，我们仍然没办法让这种二叉树具备列表所应支持的全套功能。因为，有些 Python 开发者可能还想在二叉树上面调用 count 与 index 等方法，他们觉得，既然 list 或 tuple 这样的序列支持这些方法，那二叉树也应该支持才对。这样看来，要定制一个与标准容器兼容的类，似乎比想象中麻烦。</p>\n<p>为了方便大家定制容器，Python 内置的 collections.abc 模块定义了一系列抽象基类（abstract base class），把每种容器类型应该提供的所有常用方法都写了出来。我们只需要从这样的抽象基类里面继承就好。同时，如果忘了实现某些必备的方法，那么程序会报错，提醒我们这些方法必须实现。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40983783211181430000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from collections.abc import Sequence\n\n\nclass BadType(Sequence):\n    pass\n\n\nfoo = BadType()\n\n>>>\nTraceback ...\nTypeError: Can\'t instantiate abstract class BadType with abstract methods __getitem__, __len__`, `40983783211181430000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> collections<span class="token punctuation">.</span>abc <span class="token keyword">import</span> Sequence\n\n\n<span class="token keyword">class</span> <span class="token class-name">BadType</span><span class="token punctuation">(</span>Sequence<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\nfoo <span class="token operator">=</span> BadType<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> Can\'t instantiate abstract <span class="token keyword">class</span> <span class="token class-name">BadType</span> <span class="token keyword">with</span> abstract methods __getitem__<span class="token punctuation">,</span> __len__</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果这些必备的方法都已经实现好了，那我们就可以从 collections.abc 模块的抽象基类里面继承了。例如，下面这个 BetterNode 二叉树类就是正确的，因为它已经通过继承前面的 SequenceNode 类实现了序列容器所应支持的全部必备方法，至于其他一些方法（例如 index 与 count）则会由 Sequence 这个抽象基类自动帮我们实现（它在实现的时候，会借助 BetterNode 从 SequenceNode 继承的那些必备方法）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47531301238601470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from collections.abc import Sequence\n\n\nclass BinaryNode:\n    def __init__(self, value, left=None, right=None):\n        self.value = value\n        self.left = left\n        self.right = right\n\n\nclass SequenceNode(BinaryNode):\n    def _traverse(self):\n        if self.left is not None:\n            yield from self.left._traverse()\n        yield self\n        if self.right is not None:\n            yield from self.right._traverse()\n\n    def __getitem__(self, index):\n        for i, item in enumerate(self._traverse()):\n            if i == index:\n                return item.value\n        raise IndexError(f\'Index {index} is out of range\')\n\n    def __len__(self):\n        for count, _ in enumerate(self._traverse(), 1):\n            pass\n        return count\n\n\nclass BetterNode(SequenceNode, Sequence):\n    pass\n\n\ntree = BetterNode(\n    10,\n    left=BetterNode(\n        5,\n        left=BetterNode(2),\n        right=BetterNode(\n            6,\n            right=BetterNode(7))),\n    right=BetterNode(\n        15,\n        left=BetterNode(11))\n)\n\nprint(\'Index of 7 is\', tree.index(7))\nprint(\'Count of 10 is\', tree.count(10))\n\n>>>\nIndex of 7 is 3\nCount of 10 is 1`, `47531301238601470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> collections<span class="token punctuation">.</span>abc <span class="token keyword">import</span> Sequence\n\n\n<span class="token keyword">class</span> <span class="token class-name">BinaryNode</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">,</span> left<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> right<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value\n        self<span class="token punctuation">.</span>left <span class="token operator">=</span> left\n        self<span class="token punctuation">.</span>right <span class="token operator">=</span> right\n\n\n<span class="token keyword">class</span> <span class="token class-name">SequenceNode</span><span class="token punctuation">(</span>BinaryNode<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">_traverse</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> self<span class="token punctuation">.</span>left <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n            <span class="token keyword">yield</span> <span class="token keyword">from</span> self<span class="token punctuation">.</span>left<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">yield</span> self\n        <span class="token keyword">if</span> self<span class="token punctuation">.</span>right <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n            <span class="token keyword">yield</span> <span class="token keyword">from</span> self<span class="token punctuation">.</span>right<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">for</span> i<span class="token punctuation">,</span> item <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">if</span> i <span class="token operator">==</span> index<span class="token punctuation">:</span>\n                <span class="token keyword">return</span> item<span class="token punctuation">.</span>value\n        <span class="token keyword">raise</span> IndexError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Index </span><span class="token interpolation"><span class="token punctuation">{</span>index<span class="token punctuation">}</span></span><span class="token string"> is out of range\'</span></span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">for</span> count<span class="token punctuation">,</span> _ <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">pass</span>\n        <span class="token keyword">return</span> count\n\n\n<span class="token keyword">class</span> <span class="token class-name">BetterNode</span><span class="token punctuation">(</span>SequenceNode<span class="token punctuation">,</span> Sequence<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\ntree <span class="token operator">=</span> BetterNode<span class="token punctuation">(</span>\n    <span class="token number">10</span><span class="token punctuation">,</span>\n    left<span class="token operator">=</span>BetterNode<span class="token punctuation">(</span>\n        <span class="token number">5</span><span class="token punctuation">,</span>\n        left<span class="token operator">=</span>BetterNode<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        right<span class="token operator">=</span>BetterNode<span class="token punctuation">(</span>\n            <span class="token number">6</span><span class="token punctuation">,</span>\n            right<span class="token operator">=</span>BetterNode<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    right<span class="token operator">=</span>BetterNode<span class="token punctuation">(</span>\n        <span class="token number">15</span><span class="token punctuation">,</span>\n        left<span class="token operator">=</span>BetterNode<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token punctuation">)</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Index of 7 is\'</span><span class="token punctuation">,</span> tree<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Count of 10 is\'</span><span class="token punctuation">,</span> tree<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nIndex of <span class="token number">7</span> <span class="token keyword">is</span> <span class="token number">3</span>\nCount of <span class="token number">10</span> <span class="token keyword">is</span> <span class="token number">1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>对于定制集合或可变映射等复杂的容器类型来说，继承 collections.abc 模块里的 Set 或 MutableMapping 等抽象基类所带来的好处会更加明显。假如自己从头开始实现，那必须编写大量的特殊方法才能让这些容器类的对象也能像标准的 Python 容器那样使用。</p>\n<p>collections.abc 模块要求子类必须实现某些特殊方法，另外，Python 在比较或排列对象时，还会用到其他一些特殊方法，无论定制的是不是容器类，有时为了支持某些功能，你都必须定义相关的特殊方法才行（案例参见第 73 条）。</p>\n<h3 id="总结-39"><a href="#%E6%80%BB%E7%BB%93-39" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>如果要编写的新类比较简单，那么可以直接从 Python 的容器类型（例如 list 或 dict）里面继承。</li>\n<li>如果想让定制的容器类型能像标准的 Python 容器那样使用，那么有可能要编写许多特殊方法。</li>\n<li>可以从 collections.abc 模块里的抽象基类之中派生自己的容器类型，这样可以让容器自动具备相关的功能，同时又可以保证没有把实现这些功能所必备的方法给漏掉。</li>\n</ol>\n<h1 id="元类与属性"><a href="#%E5%85%83%E7%B1%BB%E4%B8%8E%E5%B1%9E%E6%80%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>元类与属性</h1>\n<h2 id="第-44-条：用纯属性与修饰器取代旧式的-setter-与-getter-方法"><a href="#%E7%AC%AC-44-%E6%9D%A1%EF%BC%9A%E7%94%A8%E7%BA%AF%E5%B1%9E%E6%80%A7%E4%B8%8E%E4%BF%AE%E9%A5%B0%E5%99%A8%E5%8F%96%E4%BB%A3%E6%97%A7%E5%BC%8F%E7%9A%84-setter-%E4%B8%8E-getter-%E6%96%B9%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 44 条：用纯属性与修饰器取代旧式的 setter 与 getter 方法</h2>\n<p>从其他编程语言转入 Python 的开发者，可能想在类里面明确地实现 getter 与 setter 方法。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82894982614452080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class OldResistor:\n    def __init__(self, ohms):\n        self._ohms = ohms\n\n    def get_ohms(self):\n        return self._ohms\n\n    def set_ohms(self, ohms):\n        self._ohms = ohms`, `82894982614452080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">OldResistor</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ohms<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_ohms <span class="token operator">=</span> ohms\n\n    <span class="token keyword">def</span> <span class="token function">get_ohms</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_ohms\n\n    <span class="token keyword">def</span> <span class="token function">set_ohms</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ohms<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_ohms <span class="token operator">=</span> ohms</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>虽然这些 setter 与 getter 用起来很简单，但这并不符合 Python 的风格。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83805077772144080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`r0 = OldResistor(50e3)\nprint(\'Before:\', r0.get_ohms())\nr0.set_ohms(10e3)\nprint(\'After: \', r0.get_ohms())\n\n>>>\nBefore: 50000.0\nAfter:  10000.0`, `83805077772144080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">r0 <span class="token operator">=</span> OldResistor<span class="token punctuation">(</span><span class="token number">50e3</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Before:\'</span><span class="token punctuation">,</span> r0<span class="token punctuation">.</span>get_ohms<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\nr0<span class="token punctuation">.</span>set_ohms<span class="token punctuation">(</span><span class="token number">10e3</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After: \'</span><span class="token punctuation">,</span> r0<span class="token punctuation">.</span>get_ohms<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore<span class="token punctuation">:</span> <span class="token number">50000.0</span>\nAfter<span class="token punctuation">:</span>  <span class="token number">10000.0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>例如，想让属性值变大或者变小，采用这些方法来写会特别麻烦。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22036060337864405000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`r0.set_ohms(r0.get_ohms() - 4e3)\nassert r0.get_ohms() == 6e3`, `22036060337864405000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">r0<span class="token punctuation">.</span>set_ohms<span class="token punctuation">(</span>r0<span class="token punctuation">.</span>get_ohms<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">4e3</span><span class="token punctuation">)</span>\n<span class="token keyword">assert</span> r0<span class="token punctuation">.</span>get_ohms<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">6e3</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>这种工具方法确实有助于将类的接口定义得更加清晰，并方便开发者封装功能、验证用法、划定界限。这些都是在设计类时应该考虑的目标，实现这些目标可以确保我们在完善这个类的过程中不影响已经写好的调用代码。</p>\n<p>可是，在 Python 中实现这些目标时，没必要明确定义 setter 与 getter 方法。而是应该从最简单的 public 属性开始写起，例如像下面这样：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42738383148291820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Resistor:\n    def __init__(self, ohms):\n        self.ohms = ohms\n        self.voltage = 0\n        self.current = 0\n\n\nr1 = Resistor(50e3)\nr1.ohms = 10e3`, `42738383148291820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Resistor</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ohms<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>ohms <span class="token operator">=</span> ohms\n        self<span class="token punctuation">.</span>voltage <span class="token operator">=</span> <span class="token number">0</span>\n        self<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token number">0</span>\n\n\nr1 <span class="token operator">=</span> Resistor<span class="token punctuation">(</span><span class="token number">50e3</span><span class="token punctuation">)</span>\nr1<span class="token punctuation">.</span>ohms <span class="token operator">=</span> <span class="token number">10e3</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>按照这种写法，很容易就能实现原地增减属性值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6538488131330666000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`r1.ohms += 5e3`, `6538488131330666000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">r1<span class="token punctuation">.</span>ohms <span class="token operator">+=</span> <span class="token number">5e3</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>将来如果想在设置属性时，实现特别的功能，那么可以先通过 @property 修饰器来封装获取属性的那个方法，并在封装出来的修饰器上面通过 setter 属性来封装设置属性的那个方法（参见第 26 条）。下面这个新类继承自刚才的 Resistor 类，它允许我们通过设置 voltage（电压）属性来改变 current（电流）。为了正确实现这项功能，必须保证设置属性与获取属性所用的那两个方法都跟属性同名。</p>\n<p>按照这种写法，给 voltage 属性赋值会触发同名的 setter 方法，该方法会根据新的 voltage 计算本对象的 current 属性。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73568167275501890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Resistor:\n    def __init__(self, ohms):\n        self.ohms = ohms\n        self.voltage = 0\n        self.current = 0\n\n\nclass VoltageResistance(Resistor):\n    def __init__(self, ohms):\n        super().__init__(ohms)\n        self._voltage = 0\n\n    @property\n    def voltage(self):\n        return self._voltage\n\n    @voltage.setter\n    def voltage(self, voltage):\n        self._voltage = voltage\n        self.current = self._voltage / self.ohms\n\n\nr2 = VoltageResistance(1e3)\nprint(f\'Before: {r2.current: .2f} amps\')\nr2.voltage = 10\nprint(f\'After:  {r2.current: .2f} amps\')\n\n>>>\nBefore:  0.00 amps\nAfter:   0.01 amps`, `73568167275501890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Resistor</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ohms<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>ohms <span class="token operator">=</span> ohms\n        self<span class="token punctuation">.</span>voltage <span class="token operator">=</span> <span class="token number">0</span>\n        self<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token number">0</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">VoltageResistance</span><span class="token punctuation">(</span>Resistor<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ohms<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>ohms<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>_voltage <span class="token operator">=</span> <span class="token number">0</span>\n\n    @<span class="token builtin">property</span>\n    <span class="token keyword">def</span> <span class="token function">voltage</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_voltage\n\n    @voltage<span class="token punctuation">.</span>setter\n    <span class="token keyword">def</span> <span class="token function">voltage</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> voltage<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_voltage <span class="token operator">=</span> voltage\n        self<span class="token punctuation">.</span>current <span class="token operator">=</span> self<span class="token punctuation">.</span>_voltage <span class="token operator">/</span> self<span class="token punctuation">.</span>ohms\n\n\nr2 <span class="token operator">=</span> VoltageResistance<span class="token punctuation">(</span><span class="token number">1e3</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Before: </span><span class="token interpolation"><span class="token punctuation">{</span>r2<span class="token punctuation">.</span>current<span class="token punctuation">:</span><span class="token format-spec"> .2f</span><span class="token punctuation">}</span></span><span class="token string"> amps\'</span></span><span class="token punctuation">)</span>\nr2<span class="token punctuation">.</span>voltage <span class="token operator">=</span> <span class="token number">10</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'After:  </span><span class="token interpolation"><span class="token punctuation">{</span>r2<span class="token punctuation">.</span>current<span class="token punctuation">:</span><span class="token format-spec"> .2f</span><span class="token punctuation">}</span></span><span class="token string"> amps\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore<span class="token punctuation">:</span>  <span class="token number">0.00</span> amps\nAfter<span class="token punctuation">:</span>   <span class="token number">0.01</span> amps</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>为属性指定 setter 方法还可以用来检查调用方所传入的值在类型与范围上是否符合要求。例如，下面这个 Resistor 子类可以确保用户设置的电阻值总是大于 0 的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69951296243027470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Resistor:\n    def __init__(self, ohms):\n        self.ohms = ohms\n        self.voltage = 0\n        self.current = 0\n\n\nclass BoundedResistance(Resistor):\n    def __init__(self, ohms):\n        super().__init__(ohms)\n\n    @property\n    def ohms(self):\n        return self._ohms\n\n    @ohms.setter\n    def ohms(self, ohms):\n        if ohms <= 0:\n            raise ValueError(f\'ohms must be > 0; got {ohms}\')\n        self._ohms = ohms\n\n\nr3 = BoundedResistance(1e3)\nr3.ohms = 0\n\n>>>\nTraceback ...\nValueError: ohms must be > 0; got 0`, `69951296243027470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Resistor</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ohms<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>ohms <span class="token operator">=</span> ohms\n        self<span class="token punctuation">.</span>voltage <span class="token operator">=</span> <span class="token number">0</span>\n        self<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token number">0</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">BoundedResistance</span><span class="token punctuation">(</span>Resistor<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ohms<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>ohms<span class="token punctuation">)</span>\n\n    @<span class="token builtin">property</span>\n    <span class="token keyword">def</span> <span class="token function">ohms</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_ohms\n\n    @ohms<span class="token punctuation">.</span>setter\n    <span class="token keyword">def</span> <span class="token function">ohms</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ohms<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> ohms <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'ohms must be > 0; got </span><span class="token interpolation"><span class="token punctuation">{</span>ohms<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>_ohms <span class="token operator">=</span> ohms\n\n\nr3 <span class="token operator">=</span> BoundedResistance<span class="token punctuation">(</span><span class="token number">1e3</span><span class="token punctuation">)</span>\nr3<span class="token punctuation">.</span>ohms <span class="token operator">=</span> <span class="token number">0</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nValueError<span class="token punctuation">:</span> ohms must be <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span> got <span class="token number">0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果构造时所用的值无效，那么同样会触发异常。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33532826486497825000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`BoundedResistance(-5)\n\n>>>\nValueError: ohms must be > 0; got -5`, `33532826486497825000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">BoundedResistance<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nValueError<span class="token punctuation">:</span> ohms must be <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span> got <span class="token operator">-</span><span class="token number">5</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>之所以会出现这种效果，是因为子类的构造器（<code class="language-text">BoundedResistance.__init__</code>）会调用超类的构造器（<code class="language-text">Resistor.__init__</code>），而超类的构造器会把 self.ohms 设置成 -5。于是，就会触发 BoundedResistance 里面的 <code class="language-text">@ohms.setter</code> 方法，该方法立刻发现属性值无效，所以程序在对象还没有构造完之前，就会抛出异常。</p>\n<p>我们还可以利用 @property 阻止用户修改超类中的属性。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38700339080260520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Resistor:\n    def __init__(self, ohms):\n        self.ohms = ohms\n        self.voltage = 0\n        self.current = 0\n\n\nclass FixedResistance(Resistor):\n    def __init__(self, ohms):\n        super().__init__(ohms)\n\n    @property\n    def ohms(self):\n        return self._ohms\n\n    @ohms.setter\n    def ohms(self, ohms):\n        if hasattr(self, \'_ohms\'):\n            raise AttributeError(&quot;Ohms is immutable&quot;)\n        self._ohms = ohms\n\n\nr4 = FixedResistance(1e3)\nr4.ohms = 2e3\n\n>>>\nTraceback ...\nAttributeError: Ohms is immutable`, `38700339080260520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Resistor</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ohms<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>ohms <span class="token operator">=</span> ohms\n        self<span class="token punctuation">.</span>voltage <span class="token operator">=</span> <span class="token number">0</span>\n        self<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token number">0</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">FixedResistance</span><span class="token punctuation">(</span>Resistor<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ohms<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>ohms<span class="token punctuation">)</span>\n\n    @<span class="token builtin">property</span>\n    <span class="token keyword">def</span> <span class="token function">ohms</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_ohms\n\n    @ohms<span class="token punctuation">.</span>setter\n    <span class="token keyword">def</span> <span class="token function">ohms</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ohms<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">\'_ohms\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span> AttributeError<span class="token punctuation">(</span><span class="token string">"Ohms is immutable"</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>_ohms <span class="token operator">=</span> ohms\n\n\nr4 <span class="token operator">=</span> FixedResistance<span class="token punctuation">(</span><span class="token number">1e3</span><span class="token punctuation">)</span>\nr4<span class="token punctuation">.</span>ohms <span class="token operator">=</span> <span class="token number">2e3</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nAttributeError<span class="token punctuation">:</span> Ohms <span class="token keyword">is</span> immutable</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>构造好对象之后，如果试图给属性赋值，那么程序就会抛出异常。</p>\n<p>用 @property 实现 setter 与 getter 时，还应该注意不要让对象产生反常的行为。例如，不要在某属性的 getter 方法里面设置其他属性的值。</p>\n<p>假如在获取属性的 getter 方法里面修改了其他属性的值，那么用户查询这个属性时，就会觉得相当奇怪，他可能不理解为什么另外一个属性会在我查询这个属性时发生变化。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35233029968933870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Resistor:\n    def __init__(self, ohms):\n        self.ohms = ohms\n        self.voltage = 0\n        self.current = 0\n\n\nclass MysteriousResistor(Resistor):\n    @property\n    def ohms(self):\n        self.voltage = self._ohms * self.current\n        return self._ohms\n\n    @ohms.setter\n    def ohms(self, ohms):\n        self._ohms = ohms\n\n\nr7 = MysteriousResistor(10)\nr7.current = 0.01\nprint(f\'Before: {r7.voltage:.2f}\')\nr7.ohms\nprint(f\'After: {r7.voltage: .2f}\')\n\n>>>\nBefore: 0.00\nAfter:  0.10`, `35233029968933870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Resistor</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ohms<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>ohms <span class="token operator">=</span> ohms\n        self<span class="token punctuation">.</span>voltage <span class="token operator">=</span> <span class="token number">0</span>\n        self<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token number">0</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">MysteriousResistor</span><span class="token punctuation">(</span>Resistor<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    @<span class="token builtin">property</span>\n    <span class="token keyword">def</span> <span class="token function">ohms</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>voltage <span class="token operator">=</span> self<span class="token punctuation">.</span>_ohms <span class="token operator">*</span> self<span class="token punctuation">.</span>current\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_ohms\n\n    @ohms<span class="token punctuation">.</span>setter\n    <span class="token keyword">def</span> <span class="token function">ohms</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ohms<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_ohms <span class="token operator">=</span> ohms\n\n\nr7 <span class="token operator">=</span> MysteriousResistor<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>\nr7<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token number">0.01</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Before: </span><span class="token interpolation"><span class="token punctuation">{</span>r7<span class="token punctuation">.</span>voltage<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\nr7<span class="token punctuation">.</span>ohms\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'After: </span><span class="token interpolation"><span class="token punctuation">{</span>r7<span class="token punctuation">.</span>voltage<span class="token punctuation">:</span><span class="token format-spec"> .2f</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore<span class="token punctuation">:</span> <span class="token number">0.00</span>\nAfter<span class="token punctuation">:</span>  <span class="token number">0.10</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>最好的办法是，只在 @property.setter 方法里面修改状态，而且只应该修改对象之中与当前属性有关的状态。同时还得注意不要产生让调用者感到意外的其他一些副作用，例如，不要动态地引入模块，不要运行速度较慢的辅助函数，不要做 I/O，不要执行开销较大的数据库查询操作等。类的属性用起来应该跟其他的 Python 对象一样方便而快捷。如果确实要执行比较复杂或比较缓慢的操作，那么应该用普通的方法来做，而不应该把这些操作放在获取及设置属性的这两个方法里面。</p>\n<p>@property 最大的缺点是，通过它而编写的属性获取及属性设置方法只能由子类共享。与此无关的类不能共用这份逻辑。但是没关系，Python 还支持描述符（descriptor，参见第 46 条），我们可以利用这种机制把早前编写的属性获取与属性设置逻辑复用到其他许多地方。</p>\n<h3 id="总结-40"><a href="#%E6%80%BB%E7%BB%93-40" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>给新类定义接口时，应该先从简单的 public 属性写起，避免定义 setter 与 getter 方法。</li>\n<li>如果在访问属性时确实有必要做特殊的处理，那就通过 @property 来定义获取属性与设置属性的方法。</li>\n<li>实现 @property 方法时，应该遵循最小惊讶原则，不要引发奇怪的副作用。</li>\n<li>@property 方法必须执行得很快。复杂或缓慢的任务，尤其是涉及 I/O 或者会引发副作用的那些任务，还是用普通的方法来实现比较好。</li>\n</ol>\n<h2 id="第-45-条：考虑用-property-实现新的属性访问逻辑，不要急着重构原有的代码"><a href="#%E7%AC%AC-45-%E6%9D%A1%EF%BC%9A%E8%80%83%E8%99%91%E7%94%A8-property-%E5%AE%9E%E7%8E%B0%E6%96%B0%E7%9A%84%E5%B1%9E%E6%80%A7%E8%AE%BF%E9%97%AE%E9%80%BB%E8%BE%91%EF%BC%8C%E4%B8%8D%E8%A6%81%E6%80%A5%E7%9D%80%E9%87%8D%E6%9E%84%E5%8E%9F%E6%9C%89%E7%9A%84%E4%BB%A3%E7%A0%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 45 条：考虑用 @property 实现新的属性访问逻辑，不要急着重构原有的代码</h2>\n<p>Python 内置的 @property 修饰器使开发者很容易就能实现出灵活的逻辑，使得程序在获取或设置相关属性时，触发这些逻辑（参见第 44 条）。@property 还有一种更为高级的用法，其实也很常见，这就是把简单的数值属性迁移成那种实时计算的属性。这个用法的意义特别大，因为它可以确保，按照旧写法来访问属性的那些代码依然有效，而且会自动按照新逻辑执行，也不需要重写原来那些访问代码（这一点相当关键，因为那些代码未必都在你控制之下）。@property 可以说是一种重要的缓冲机制，使开发者能够逐渐改善接口而不影响已经写好的代码。</p>\n<p>例如，下面我们用普通的 Python 对象实现带有配额（quota）的漏桶（leaky bucket）。这个类可以记录当前的配额以及这份配额在多长时间内有效。</p>\n<p>漏桶算法要求在添加配额时，不能把已有的额度带到下一个时段。如果想使用额度，那么首先必须确保漏桶当前所剩的配额足够使用。</p>\n<p>现在我们来使用这个类。首先填充额度，然后根据自己的需要使用额度，这样用下去，最终会遇到额度不够的情况。从这时开始，额度就不会再变了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78399066120209370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from datetime import datetime, timedelta\n\n\nclass Bucket:\n    def __init__(self, period):\n        self.period_delta = timedelta(seconds=period)\n        self.reset_time = datetime.now()\n        self.quota = 0\n\n    def __repr__(self):\n        return f\'Bucket (quota={self.quota})\'\n\n\ndef fill(bucket, amount):\n    now = datetime.now()\n    if (now - bucket.reset_time) > bucket.period_delta:\n        bucket.quota = 0\n        bucket.reset_time = now\n    bucket.quota += amount\n\n\ndef deduct(bucket, amount):\n    now = datetime.now()\n    if (now - bucket.reset_time) > bucket.period_delta:\n        return False  # Bucket hasn\'t been filled this period\n    if bucket.quota - amount < 0:\n        return False  # Bucket was filled, but not enough\n    bucket.quota -= amount\n    return True  # Bucket had enough, quota consumed\n\n\nbucket = Bucket(60)\nfill(bucket, 100)\nprint(bucket)\n\nif deduct(bucket, 99):\n    print(\'Had 99 quota\')\nelse:\n    print(\'Not enough for 99 quota\')\nprint(bucket)\n\nif deduct(bucket, 3):\n    print(\'Had 3 quota\')\nelse:\n    print(\'Not enough for 3 quota\')\nprint(bucket)\n\n>>>\nBucket (quota=100)\nHad 99 quota\nBucket (quota=1)\nNot enough for 3 quota\nBucket (quota=1)`, `78399066120209370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timedelta\n\n\n<span class="token keyword">class</span> <span class="token class-name">Bucket</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> period<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>period_delta <span class="token operator">=</span> timedelta<span class="token punctuation">(</span>seconds<span class="token operator">=</span>period<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>reset_time <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>quota <span class="token operator">=</span> <span class="token number">0</span>\n\n    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f\'Bucket (quota=</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>quota<span class="token punctuation">}</span></span><span class="token string">)\'</span></span>\n\n\n<span class="token keyword">def</span> <span class="token function">fill</span><span class="token punctuation">(</span>bucket<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    now <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> bucket<span class="token punctuation">.</span>reset_time<span class="token punctuation">)</span> <span class="token operator">></span> bucket<span class="token punctuation">.</span>period_delta<span class="token punctuation">:</span>\n        bucket<span class="token punctuation">.</span>quota <span class="token operator">=</span> <span class="token number">0</span>\n        bucket<span class="token punctuation">.</span>reset_time <span class="token operator">=</span> now\n    bucket<span class="token punctuation">.</span>quota <span class="token operator">+=</span> amount\n\n\n<span class="token keyword">def</span> <span class="token function">deduct</span><span class="token punctuation">(</span>bucket<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    now <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> bucket<span class="token punctuation">.</span>reset_time<span class="token punctuation">)</span> <span class="token operator">></span> bucket<span class="token punctuation">.</span>period_delta<span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token boolean">False</span>  <span class="token comment"># Bucket hasn\'t been filled this period</span>\n    <span class="token keyword">if</span> bucket<span class="token punctuation">.</span>quota <span class="token operator">-</span> amount <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token boolean">False</span>  <span class="token comment"># Bucket was filled, but not enough</span>\n    bucket<span class="token punctuation">.</span>quota <span class="token operator">-=</span> amount\n    <span class="token keyword">return</span> <span class="token boolean">True</span>  <span class="token comment"># Bucket had enough, quota consumed</span>\n\n\nbucket <span class="token operator">=</span> Bucket<span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span>\nfill<span class="token punctuation">(</span>bucket<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>\n\n<span class="token keyword">if</span> deduct<span class="token punctuation">(</span>bucket<span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Had 99 quota\'</span><span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Not enough for 99 quota\'</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>\n\n<span class="token keyword">if</span> deduct<span class="token punctuation">(</span>bucket<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Had 3 quota\'</span><span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Not enough for 3 quota\'</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBucket <span class="token punctuation">(</span>quota<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span>\nHad <span class="token number">99</span> quota\nBucket <span class="token punctuation">(</span>quota<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>\nNot enough <span class="token keyword">for</span> <span class="token number">3</span> quota\nBucket <span class="token punctuation">(</span>quota<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种实现方式有个问题，就是没办法知道第一次填充漏桶时，给它分配的额度。我们只知道额度会越用越少直到不够用为止。如果当前这段时间内的额度已经降到 0，那么不管你想使用多少额度，deduct 函数都会返回 False，除非通过 fill 函数再往里面补充额度。所以，当 deduct 函数返回 False 时，了解这究竟是因为 Bucket 没有足够的额度可以扣减，还是说它一开始根本就没分配到任何额度，这一点很重要。</p>\n<p>为了解决这个问题，可以修改这个类，把当前时间段内的初始额度（max<em>quota）与已经使用的额度（quota</em>consumed）明确记录下来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60504857107926370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from datetime import datetime, timedelta\n\n\nclass NewBucket:\n    def __init__(self, period):\n        self.period_delta = timedelta(seconds=period)\n        self.reset_time = datetime.now()\n        self.max_quota = 0\n        self.quota_consumed = 0\n\n    def __repr__(self):\n        return f\'NewBucket (max_quota={self.max_quota}, quota_consumed={self.quota_consumed})\'\n\n    @property\n    def quota(self):\n        return self.max_quota - self.quota_consumed\n\n    @quota.setter\n    def quota(self, amount):\n        delta = self.max_quota - amount\n        if amount == 0:\n            # Quota being reset for a new period\n            self.quota_consumed = 0\n            self.max_quota = 0\n        elif delta < 0:\n            # Quota being filled for the new period\n            assert self.quota_consumed == 0\n            self.max_quota = amount\n        else:\n            # Quota being consumed during the period\n            assert amount > 0\n            self.quota_consumed = delta\n\n\ndef fill(bucket, amount):\n    now = datetime.now()\n    if (now - bucket.reset_time) > bucket.period_delta:\n        bucket.quota = 0\n        bucket.reset_time = now\n    bucket.quota += amount\n\n\ndef deduct(bucket, amount):\n    now = datetime.now()\n    if (now - bucket.reset_time) > bucket.period_delta:\n        return False  # Bucket hasn\'t been filled this period\n    if bucket.quota - amount < 0:\n        return False  # Bucket was filled, but not enough\n    bucket.quota -= amount\n    return True  # Bucket had enough, quota consumed\n\n\nbucket = NewBucket(60)\nfill(bucket, 100)\nprint(bucket)\n\nif deduct(bucket, 99):\n    print(\'Had 99 quota\')\nelse:\n    print(\'Not enough for 99 quota\')\nprint(bucket)\n\nif deduct(bucket, 3):\n    print(\'Had 3 quota\')\nelse:\n    print(\'Not enough for 3 quota\')\nprint(bucket)\n\n>>>\nNewBucket (max_quota=100, quota_consumed=0)\nHad 99 quota\nNewBucket (max_quota=100, quota_consumed=99)\nNot enough for 3 quota\nNewBucket (max_quota=100, quota_consumed=99)`, `60504857107926370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timedelta\n\n\n<span class="token keyword">class</span> <span class="token class-name">NewBucket</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> period<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>period_delta <span class="token operator">=</span> timedelta<span class="token punctuation">(</span>seconds<span class="token operator">=</span>period<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>reset_time <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>max_quota <span class="token operator">=</span> <span class="token number">0</span>\n        self<span class="token punctuation">.</span>quota_consumed <span class="token operator">=</span> <span class="token number">0</span>\n\n    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f\'NewBucket (max_quota=</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>max_quota<span class="token punctuation">}</span></span><span class="token string">, quota_consumed=</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>quota_consumed<span class="token punctuation">}</span></span><span class="token string">)\'</span></span>\n\n    <span class="token decorator annotation punctuation">@property</span>\n    <span class="token keyword">def</span> <span class="token function">quota</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>max_quota <span class="token operator">-</span> self<span class="token punctuation">.</span>quota_consumed\n\n    @quota<span class="token punctuation">.</span>setter\n    <span class="token keyword">def</span> <span class="token function">quota</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        delta <span class="token operator">=</span> self<span class="token punctuation">.</span>max_quota <span class="token operator">-</span> amount\n        <span class="token keyword">if</span> amount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>\n            <span class="token comment"># Quota being reset for a new period</span>\n            self<span class="token punctuation">.</span>quota_consumed <span class="token operator">=</span> <span class="token number">0</span>\n            self<span class="token punctuation">.</span>max_quota <span class="token operator">=</span> <span class="token number">0</span>\n        <span class="token keyword">elif</span> delta <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">:</span>\n            <span class="token comment"># Quota being filled for the new period</span>\n            <span class="token keyword">assert</span> self<span class="token punctuation">.</span>quota_consumed <span class="token operator">==</span> <span class="token number">0</span>\n            self<span class="token punctuation">.</span>max_quota <span class="token operator">=</span> amount\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token comment"># Quota being consumed during the period</span>\n            <span class="token keyword">assert</span> amount <span class="token operator">></span> <span class="token number">0</span>\n            self<span class="token punctuation">.</span>quota_consumed <span class="token operator">=</span> delta\n\n\n<span class="token keyword">def</span> <span class="token function">fill</span><span class="token punctuation">(</span>bucket<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    now <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> bucket<span class="token punctuation">.</span>reset_time<span class="token punctuation">)</span> <span class="token operator">></span> bucket<span class="token punctuation">.</span>period_delta<span class="token punctuation">:</span>\n        bucket<span class="token punctuation">.</span>quota <span class="token operator">=</span> <span class="token number">0</span>\n        bucket<span class="token punctuation">.</span>reset_time <span class="token operator">=</span> now\n    bucket<span class="token punctuation">.</span>quota <span class="token operator">+=</span> amount\n\n\n<span class="token keyword">def</span> <span class="token function">deduct</span><span class="token punctuation">(</span>bucket<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    now <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> bucket<span class="token punctuation">.</span>reset_time<span class="token punctuation">)</span> <span class="token operator">></span> bucket<span class="token punctuation">.</span>period_delta<span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token boolean">False</span>  <span class="token comment"># Bucket hasn\'t been filled this period</span>\n    <span class="token keyword">if</span> bucket<span class="token punctuation">.</span>quota <span class="token operator">-</span> amount <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token boolean">False</span>  <span class="token comment"># Bucket was filled, but not enough</span>\n    bucket<span class="token punctuation">.</span>quota <span class="token operator">-=</span> amount\n    <span class="token keyword">return</span> <span class="token boolean">True</span>  <span class="token comment"># Bucket had enough, quota consumed</span>\n\n\nbucket <span class="token operator">=</span> NewBucket<span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span>\nfill<span class="token punctuation">(</span>bucket<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>\n\n<span class="token keyword">if</span> deduct<span class="token punctuation">(</span>bucket<span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Had 99 quota\'</span><span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Not enough for 99 quota\'</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>\n\n<span class="token keyword">if</span> deduct<span class="token punctuation">(</span>bucket<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Had 3 quota\'</span><span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Not enough for 3 quota\'</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nNewBucket <span class="token punctuation">(</span>max_quota<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span> quota_consumed<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>\nHad <span class="token number">99</span> quota\nNewBucket <span class="token punctuation">(</span>max_quota<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span> quota_consumed<span class="token operator">=</span><span class="token number">99</span><span class="token punctuation">)</span>\nNot enough <span class="token keyword">for</span> <span class="token number">3</span> quota\nNewBucket <span class="token punctuation">(</span>max_quota<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span> quota_consumed<span class="token operator">=</span><span class="token number">99</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个方案最大的好处是，原来根据 Bucket.quota 所写的那些代码可以继续沿用，而且无须考虑 Bucket 现在已经换成了新的 NewBucket。至于以后的代码，则可以直接操纵漏桶的额度（quota），因为可以通过访问 <code class="language-text">max_quota</code> 与 <code class="language-text">quota_consumed</code> 字段正确地获取及设置该额度。</p>\n<p>笔者特别喜欢 @property 属性的地方在于，它让我们能够逐渐完善数据模型而不影响已经写好的代码。观看刚才那个 Bucket 范例时，有人可能会想，为什么不把 fill 与 deduct 直接设计成实例方法呢？嗯，这样想确实有道理（参见第 37 条），但实际上，我们不可能每次都想得这么周到，还是会遇到很多相当糟糕的接口，或者遇到那种纯粹当成数据容器来写的类。之所以出现那样的情况，可能有许多原因，例如代码不断膨胀，项目的范围也越来越广，而给同一个项目提交程序的开发者又全都没有考虑到以后的维护工作。</p>\n<p>@property 可以帮助解决实际工作中的许多问题，但不应该遭到滥用。如果你发现自己总是在扩充 @property 方法，那可能说明这个类确实应该重构了。在这种情况下，就不要再沿着糟糕的方案继续往下写了。</p>\n<h3 id="总结-41"><a href="#%E6%80%BB%E7%BB%93-41" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>可以利用 @property 给已有的实例属性增加新的功能。</li>\n<li>可以利用 @property 逐渐改善数据模型而不影响已经写好的代码。</li>\n<li>如果发现 @property 使用太过频繁，那可能就该考虑重构这个类了，同时按照旧办法使用这个类的那些代码可能也要重构。</li>\n</ol>\n<h2 id="第-46-条：用描述符来改写需要复用的-property-方法"><a href="#%E7%AC%AC-46-%E6%9D%A1%EF%BC%9A%E7%94%A8%E6%8F%8F%E8%BF%B0%E7%AC%A6%E6%9D%A5%E6%94%B9%E5%86%99%E9%9C%80%E8%A6%81%E5%A4%8D%E7%94%A8%E7%9A%84-property-%E6%96%B9%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 46 条：用描述符来改写需要复用的 @property 方法</h2>\n<p>Python 内置的 @property 机制的最大的缺点就是不方便复用（参见第 44 条与第 45 条）。我们不能把它修饰的方法所使用的逻辑，套用在同一个类的其他属性上面，也不能在无关的类里面复用。</p>\n<p>例如，我们要编写一个类来记录学生的家庭作业成绩，而且要确保设置的成绩位于 0 到 100 之间，受 @property 修饰的属性用起来很简单。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83018505551357050000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Homework:\n    def __init__(self):\n        self._grade = 0\n\n    @property\n    def grade(self):\n        return self._grade\n\n    @grade.setter\n    def grade(self, value):\n        if not (0 <= value <= 100):\n            raise ValueError(\'Grade must be between 0 and 100\')\n        self._grade = value\n\n\ngalileo = Homework()\ngalileo.grade = 95`, `83018505551357050000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Homework</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_grade <span class="token operator">=</span> <span class="token number">0</span>\n\n    @<span class="token builtin">property</span>\n    <span class="token keyword">def</span> <span class="token function">grade</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_grade\n\n    @grade<span class="token punctuation">.</span>setter\n    <span class="token keyword">def</span> <span class="token function">grade</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;=</span> value <span class="token operator">&lt;=</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Grade must be between 0 and 100\'</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>_grade <span class="token operator">=</span> value\n\n\ngalileo <span class="token operator">=</span> Homework<span class="token punctuation">(</span><span class="token punctuation">)</span>\ngalileo<span class="token punctuation">.</span>grade <span class="token operator">=</span> <span class="token number">95</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>假设，我们还需要写一个类记录学生的考试成绩，而且要把每科的成绩分别记录下来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95748660052656500000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Exam:\n    def __init__(self):\n        self._writing_grade = 0\n        self._math_grade = 0\n\n    @staticmethod\n    def _check_grade(value):\n        if not (0 <= value <= 100):\n            raise ValueError(\'Grade must be between 0 and 100\')`, `95748660052656500000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Exam</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_writing_grade <span class="token operator">=</span> <span class="token number">0</span>\n        self<span class="token punctuation">.</span>_math_grade <span class="token operator">=</span> <span class="token number">0</span>\n\n    @<span class="token builtin">staticmethod</span>\n    <span class="token keyword">def</span> <span class="token function">_check_grade</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;=</span> value <span class="token operator">&lt;=</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Grade must be between 0 and 100\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写很费事，因为每科的成绩都需要一套 @property 方法，而且其中设置属性值的那个方法还必须调用 <code class="language-text">_check_grade</code> 验证新值是否位于合理的范围内。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20332954199194477000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@property\ndef writing_grade(self):\n    return self._writing_grade\n\n\n@writing_grade.setter\ndef writing_grade(self, value):\n    self._check_grade(value)\n    self._writing_grade = value\n\n\n@property\ndef math_grade(self):\n    return self._math_grade\n\n\n@math_grade.setter\ndef math_grade(self, value):\n    self._check_grade(value)\n    self._math_grade = value`, `20332954199194477000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token decorator annotation punctuation">@property</span>\n<span class="token keyword">def</span> <span class="token function">writing_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> self<span class="token punctuation">.</span>_writing_grade\n\n\n@writing_grade<span class="token punctuation">.</span>setter\n<span class="token keyword">def</span> <span class="token function">writing_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    self<span class="token punctuation">.</span>_check_grade<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n    self<span class="token punctuation">.</span>_writing_grade <span class="token operator">=</span> value\n\n\n@<span class="token builtin">property</span>\n<span class="token keyword">def</span> <span class="token function">math_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> self<span class="token punctuation">.</span>_math_grade\n\n\n@math_grade<span class="token punctuation">.</span>setter\n<span class="token keyword">def</span> <span class="token function">math_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    self<span class="token punctuation">.</span>_check_grade<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n    self<span class="token punctuation">.</span>_math_grade <span class="token operator">=</span> value</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种写法不仅烦琐，而且无法复用。如果想把这个百分制验证逻辑运用到 Homework 与 Exam 以外的类，那么必须反复编写例行的 @property 方法与 <code class="language-text">_check_grade</code> 逻辑。</p>\n<p>在 Python 里，这样的功能最好通过描述符（descriptor）实现。描述符协议（descriptor protocol）规定了程序应该如何处理属性访问操作。充当描述符的那个类能够实现 <code class="language-text">__get__</code> 与 <code class="language-text">__set__</code> 方法，这样其他类就可以共用这个描述符所实现的逻辑而无须把这套逻辑分别重写一遍。在这一点上，描述符要比 <code class="language-text">mix-in</code> 好（参见第 41 条），因为即便在同一个类里，我们也可以反复使用这个描述符来设计不同的属性。</p>\n<p>下面重新定义 Exam 类，这次我们采用类级别的属性来实现每科成绩的访问功能，这些属性指向下面这个 Grade 类的实例，而这个 Grade 类则实现刚才提到的描述符协议。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69351077714413330000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Grade:\n    def __get__(self, instance, instance_type):\n        return ()\n\n    def __set__(self, instance, value):\n        return ()\n\n\nclass Exam:\n    # Class attributes\n    math_grade = Grade()\n    writing_grade = Grade()\n    science_grade = Grade()`, `69351077714413330000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Grade</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__get__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> instance_type<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__set__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Exam</span><span class="token punctuation">:</span>\n    <span class="token comment"># Class attributes</span>\n    math_grade <span class="token operator">=</span> Grade<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    writing_grade <span class="token operator">=</span> Grade<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    science_grade <span class="token operator">=</span> Grade<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在解释 Grade 类的工作原理之前，我们首先要知道，当程序访问 Exam 实例的某个属性时，Python 如何将访问操作派发到 Exam 类的描述符属性上面。例如，如果要给 Exam 实例的 <code class="language-text">writing_grade</code> 属性赋值：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49234843239598900000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`exam = Exam()\nexam.writing_grade = 40`, `49234843239598900000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">exam <span class="token operator">=</span> Exam<span class="token punctuation">(</span><span class="token punctuation">)</span>\nexam<span class="token punctuation">.</span>writing_grade <span class="token operator">=</span> <span class="token number">40</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>那么 Python 会把这次赋值操作转译为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47067328410103060000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Exam.__dict__[\'writing_grade\'].__set__(exam, 40)`, `47067328410103060000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">Exam<span class="token punctuation">.</span>__dict__<span class="token punctuation">[</span><span class="token string">\'writing_grade\'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__set__<span class="token punctuation">(</span>exam<span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>获取这个属性时也一样：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33087710524903690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`exam.writing_grade`, `33087710524903690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">exam<span class="token punctuation">.</span>writing_grade</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>Python 会把它相应地转译为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81174334005485060000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Exam.__dict__[\'writing_grade\'].__get__(exam, Exam)`, `81174334005485060000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">Exam<span class="token punctuation">.</span>__dict__<span class="token punctuation">[</span><span class="token string">\'writing_grade\'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__get__<span class="token punctuation">(</span>exam<span class="token punctuation">,</span> Exam<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这样的转译效果是由 object 的 <code class="language-text">__getattribute__</code> 方法促成的（参见第 47 条）。简单地说，就是当 Exam 实例里面没有名为 <code class="language-text">writing_grade</code> 的属性时，Python 会转而在类的层面查找，查询 Exam 类里面有没有这样一个属性。如果有，而且还是个实现了 <code class="language-text">__get__</code> 与 <code class="language-text">__set__</code> 方法的对象，那么系统就认定你想通过描述符协议定义这个属性的访问行为。</p>\n<p>知道了这条规则之后，我们来尝试把 Homework 类早前用 <code class="language-text">@property</code> 实现的成绩验证逻辑搬到 Grade 描述符里面。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43968220564789810000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Grade:\n    def __init__(self):\n        self._value = 0\n\n    def __get__(self, instance, instance_type):\n        return self._value\n\n    def __set__(self, instance, value):\n        if not (0 <= value <= 100):\n            raise ValueError(\'Grade must be between 0 and 100\')\n        self._value = value`, `43968220564789810000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Grade</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_value <span class="token operator">=</span> <span class="token number">0</span>\n\n    <span class="token keyword">def</span> <span class="token function">__get__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> instance_type<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_value\n\n    <span class="token keyword">def</span> <span class="token function">__set__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;=</span> value <span class="token operator">&lt;=</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Grade must be between 0 and 100\'</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>_value <span class="token operator">=</span> value</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写其实不对，而且会让程序出现混乱。但在同一个 Exam 实例上面访问不同的属性是没有问题的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70353496474822320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Exam:\n    math_grade = Grade()\n    writing_grade = Grade()\n    science_grade = Grade()\n\n\nfirst_exam = Exam()\nfirst_exam.writing_grade = 82\nfirst_exam.science_grade = 99\nprint(\'Writing\', first_exam.writing_grade)\nprint(\'Science\', first_exam.science_grade)\n\n>>>\nWriting 82\nScience 99`, `70353496474822320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Exam</span><span class="token punctuation">:</span>\n    math_grade <span class="token operator">=</span> Grade<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    writing_grade <span class="token operator">=</span> Grade<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    science_grade <span class="token operator">=</span> Grade<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n\nfirst_exam <span class="token operator">=</span> Exam<span class="token punctuation">(</span><span class="token punctuation">)</span>\nfirst_exam<span class="token punctuation">.</span>writing_grade <span class="token operator">=</span> <span class="token number">82</span>\nfirst_exam<span class="token punctuation">.</span>science_grade <span class="token operator">=</span> <span class="token number">99</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Writing\'</span><span class="token punctuation">,</span> first_exam<span class="token punctuation">.</span>writing_grade<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Science\'</span><span class="token punctuation">,</span> first_exam<span class="token punctuation">.</span>science_grade<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nWriting <span class="token number">82</span>\nScience <span class="token number">99</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是，在不同的 Exam 实例上分别访问同一个属性却会看到奇怪的结果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51732560828487830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`second_exam = Exam()\nsecond_exam.writing_grade = 75\nprint(f\'Second {second_exam.writing_grade} is right\')\nprint(f\'First {first_exam.writing_grade} is wrong; should be 82\')\n\n>>>\nSecond 75 is right\nFirst 75 is wrong; should be 82`, `51732560828487830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">second_exam <span class="token operator">=</span> Exam<span class="token punctuation">(</span><span class="token punctuation">)</span>\nsecond_exam<span class="token punctuation">.</span>writing_grade <span class="token operator">=</span> <span class="token number">75</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Second </span><span class="token interpolation"><span class="token punctuation">{</span>second_exam<span class="token punctuation">.</span>writing_grade<span class="token punctuation">}</span></span><span class="token string"> is right\'</span></span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'First </span><span class="token interpolation"><span class="token punctuation">{</span>first_exam<span class="token punctuation">.</span>writing_grade<span class="token punctuation">}</span></span><span class="token string"> is wrong; should be 82\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nSecond <span class="token number">75</span> <span class="token keyword">is</span> right\nFirst <span class="token number">75</span> <span class="token keyword">is</span> wrong<span class="token punctuation">;</span> should be <span class="token number">82</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>出现这种问题的原因在于，这些 Exam 实例之中的 <code class="language-text">writing_grade</code> 属性实际上是在共享同一个 Grade 实例。在整个程序的运行过程中，这个 Grade 只会于定义 Exam 类时构造一次，而不是每创建一个 Exam 实例都有一个新的 Grade 来与 <code class="language-text">writing_grade</code> 属性相搭配。</p>\n<p>为解决此问题，我们必须把每个 Exam 实例在这个属性上面的取值都记录下来。可以通过字典实现每个实例的状态保存。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11497172082164074000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Grade:\n    def __init__(self):\n        self._values = {}\n\n    def __get__(self, instance, instance_type):\n        if instance is None:\n            return self\n        return self._values.get(instance, 0)\n\n    def __set__(self, instance, value):\n        if not (0 <= value <= 100):\n            raise ValueError(\'Grade must be between 0 and 100\')\n        self._values[instance] = value`, `11497172082164074000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Grade</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_values <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n    <span class="token keyword">def</span> <span class="token function">__get__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> instance_type<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> instance <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_values<span class="token punctuation">.</span>get<span class="token punctuation">(</span>instance<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__set__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;=</span> value <span class="token operator">&lt;=</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Grade must be between 0 and 100\'</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>_values<span class="token punctuation">[</span>instance<span class="token punctuation">]</span> <span class="token operator">=</span> value</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种实现方案很简单，而且能得到正确结果，但仍然有一个缺陷，就是会泄漏内存。在程序运行过程中，传给 <code class="language-text">__set__</code> 方法的那些 Exam 实例全都会被 Grade 之中的 <code class="language-text">_values</code> 字典所引用。于是，指向那些实例的引用数量就永远不会降到 0，这导致垃圾回收器没办法把那些实例清理掉（第 81 条会介绍怎样才能发现这种问题）。</p>\n<p>为了解决这个问题，我们可以求助于 Python 内置的 weakref 模块。该模块里有一种特殊的字典，名为 WeakKeyDictionary，它可以取代刚才实现 <code class="language-text">_values</code> 时所用的普通字典。这个字典的特殊之处在于：如果运行时系统发现，指向 Exam 实例的引用只剩一个，而这个引用又是由 WeakKeyDictionary 的键所发起的，那么系统会将该引用从这个特殊的字典里删掉，于是指向那个 Exam 实例的引用数量就会降为 0。总之，改用这种字典来实现 <code class="language-text">_values</code> 会让 Python 系统自动把内存泄漏问题处理好，如果所有的 Exam 实例都不再使用了，那么 <code class="language-text">_values</code> 字典肯定是空的。</p>\n<p>用这种字典改写 Grade 描述符之后，Exam 就能够正常运作了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24479598955876860000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from weakref import WeakKeyDictionary\n\n\nclass Grade:\n    def __init__(self):\n        self._values = WeakKeyDictionary()\n\n    def __get__(self, instance, instance_type):\n        if instance is None:\n            return self\n        return self._values.get(instance, 0)\n\n    def __set__(self, instance, value):\n        if not (0 <= value <= 100):\n            raise ValueError(\'Grade must be between 0 and 100\')\n        self._values[instance] = value\n\n\nclass Exam:\n    math_grade = Grade()\n    writing_grade = Grade()\n    science_grade = Grade()\n\n\nfirst_exam = Exam()\nfirst_exam.writing_grade = 82\nsecond_exam = Exam()\nsecond_exam.writing_grade = 75\nprint(f\'First {first_exam.writing_grade} is right\')\nprint(f\'Second {second_exam.writing_grade} is right\')\n\n>>>\nFirst 82 is right\nSecond 75 is right`, `24479598955876860000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> weakref <span class="token keyword">import</span> WeakKeyDictionary\n\n\n<span class="token keyword">class</span> <span class="token class-name">Grade</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_values <span class="token operator">=</span> WeakKeyDictionary<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__get__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> instance_type<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> instance <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_values<span class="token punctuation">.</span>get<span class="token punctuation">(</span>instance<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__set__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;=</span> value <span class="token operator">&lt;=</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Grade must be between 0 and 100\'</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>_values<span class="token punctuation">[</span>instance<span class="token punctuation">]</span> <span class="token operator">=</span> value\n\n\n<span class="token keyword">class</span> <span class="token class-name">Exam</span><span class="token punctuation">:</span>\n    math_grade <span class="token operator">=</span> Grade<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    writing_grade <span class="token operator">=</span> Grade<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    science_grade <span class="token operator">=</span> Grade<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n\nfirst_exam <span class="token operator">=</span> Exam<span class="token punctuation">(</span><span class="token punctuation">)</span>\nfirst_exam<span class="token punctuation">.</span>writing_grade <span class="token operator">=</span> <span class="token number">82</span>\nsecond_exam <span class="token operator">=</span> Exam<span class="token punctuation">(</span><span class="token punctuation">)</span>\nsecond_exam<span class="token punctuation">.</span>writing_grade <span class="token operator">=</span> <span class="token number">75</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'First </span><span class="token interpolation"><span class="token punctuation">{</span>first_exam<span class="token punctuation">.</span>writing_grade<span class="token punctuation">}</span></span><span class="token string"> is right\'</span></span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Second </span><span class="token interpolation"><span class="token punctuation">{</span>second_exam<span class="token punctuation">.</span>writing_grade<span class="token punctuation">}</span></span><span class="token string"> is right\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nFirst <span class="token number">82</span> <span class="token keyword">is</span> right\nSecond <span class="token number">75</span> <span class="token keyword">is</span> right</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="总结-42"><a href="#%E6%80%BB%E7%BB%93-42" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>如果想复用 @property 方法所实现的行为与验证逻辑，则可以考虑自己定义描述符类。</li>\n<li>为了防止内存泄漏，可以在描述符类中用 WeakKeyDictionary 取代普通的字典。</li>\n<li>不要太纠结于 <code class="language-text">__getattribute__</code> 是怎么通过描述符协议来获取并设置属性的。</li>\n</ol>\n<h2 id="第-47-条：针对惰性属性使用-__getattr__、__getattribute__-及-__setattr__"><a href="#%E7%AC%AC-47-%E6%9D%A1%EF%BC%9A%E9%92%88%E5%AF%B9%E6%83%B0%E6%80%A7%E5%B1%9E%E6%80%A7%E4%BD%BF%E7%94%A8-__getattr__%E3%80%81__getattribute__-%E5%8F%8A-__setattr__" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 47 条：针对惰性属性使用 <code class="language-text">__getattr__</code>、<code class="language-text">__getattribute__</code> 及 <code class="language-text">__setattr__</code></h2>\n<p>Python 的 object 提供了一套挂钩，使开发者很容易就能写出通用的代码，将不同的系统粘合到一起。例如，我们想把数据库中的记录表示为 Python 对象。数据库当然有它自己的模式（schema），而程序在把记录表示成对象时，必须知道数据库是按照什么样的 schema 来组织这些记录的。同时，我们又要注意，连接 Python 对象与数据库的代码应该写得通用一些，而不应该明确限定这些记录必须使用哪种 schema。</p>\n<p>这个功能如何实现才好呢？普通的实例属性、经过 <code class="language-text">@property</code> 修饰的方法以及上一条里提到的描述符，都做不到这一点，因为它们都必须得提前定义好。在 Python 中，这种动态的行为可以通过名为 <code class="language-text">__getattr__</code> 的特殊方法来实现。如果类中定义了 <code class="language-text">__getattr__</code>，那么每当访问该类对象的属性，而且实例字典里又找不到这个属性时，系统就会触发 <code class="language-text">__getattr__</code> 方法。</p>\n<p>下面我们试着访问 foo 属性。data 实例中并没有这样一个属性，因此 Python 会触发上面定义的 <code class="language-text">__getattr__</code> 方法，而该方法又会通过 setattr 修改本实例的 <code class="language-text">__dict__</code> 字典。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41467752419431730000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class LazyRecord:\n    def __init__(self):\n        self.exists = 5\n\n    def __getattr__(self, name):\n        value = f\'Value for {name}\'\n        setattr(self, name, value)\n        return value\n\n\ndata = LazyRecord()\nprint(\'Before:\', data.__dict__)\nprint(\'foo:   \', data.foo)\nprint(\'After: \', data.__dict__)\n\n>>>\nBefore: {\'exists\': 5}\nfoo:    Value for foo\nAfter:  {\'exists\': 5, \'foo\': \'Value for foo\'}`, `41467752419431730000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">LazyRecord</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>exists <span class="token operator">=</span> <span class="token number">5</span>\n\n    <span class="token keyword">def</span> <span class="token function">__getattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        value <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f\'Value for </span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">\'</span></span>\n        <span class="token builtin">setattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> value\n\n\ndata <span class="token operator">=</span> LazyRecord<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Before:\'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'foo:   \'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>foo<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After: \'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'exists\'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">}</span>\nfoo<span class="token punctuation">:</span>    Value <span class="token keyword">for</span> foo\nAfter<span class="token punctuation">:</span>  <span class="token punctuation">{</span><span class="token string">\'exists\'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">\'foo\'</span><span class="token punctuation">:</span> <span class="token string">\'Value for foo\'</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>下面，我们通过子类给 LazyRecord 增加日志功能，用来观察程序在什么样的情况下才会调用 <code class="language-text">__getattr__</code> 方法。我们先写入第一条日志，然后通过 super() 调用超类所实现的 <code class="language-text">__getattr__</code> 方法，并把那个方法返回的结果记录到第二条日志里面。假如不加 super()，那么程序就会无限递归，因为那样调用的是本类所写的 <code class="language-text">__getattr__</code> 方法（参见第 40 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32400453337253986000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class LazyRecord:\n    def __init__(self):\n        self.exists = 5\n\n    def __getattr__(self, name):\n        value = f\'Value for {name}\'\n        setattr(self, name, value)\n        return value\n\n\nclass LoggingLazyRecord(LazyRecord):\n    def __getattr__(self, name):\n        print(\n            f\'* Called __getattr__({name!r}), populating instance dictionary\')\n        result = super() .__getattr__(name)\n        print(f\'* Returning {result!r}\')\n        return result\n\n\ndata = LoggingLazyRecord()\nprint(\'exists:    \', data.exists)\nprint(\'First foo: \', data.foo)\nprint(\'Second foo:\', data.foo)\n\n>>>\nexists:     5\n* Called __getattr__(\'foo\'), populating instance dictionary\n* Returning \'Value for foo\'\nFirst foo:  Value for foo\nSecond foo: Value for foo`, `32400453337253986000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">LazyRecord</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>exists <span class="token operator">=</span> <span class="token number">5</span>\n\n    <span class="token keyword">def</span> <span class="token function">__getattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        value <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f\'Value for </span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">\'</span></span>\n        <span class="token builtin">setattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> value\n\n\n<span class="token keyword">class</span> <span class="token class-name">LoggingLazyRecord</span><span class="token punctuation">(</span>LazyRecord<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__getattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>\n            <span class="token string-interpolation"><span class="token string">f\'* Called __getattr__(</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">), populating instance dictionary\'</span></span><span class="token punctuation">)</span>\n        result <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">.</span>__getattr__<span class="token punctuation">(</span>name<span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'* Returning </span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> result\n\n\ndata <span class="token operator">=</span> LoggingLazyRecord<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'exists:    \'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>exists<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'First foo: \'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>foo<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Second foo:\'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>foo<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nexists<span class="token punctuation">:</span>     <span class="token number">5</span>\n<span class="token operator">*</span> Called __getattr__<span class="token punctuation">(</span><span class="token string">\'foo\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> populating instance dictionary\n<span class="token operator">*</span> Returning <span class="token string">\'Value for foo\'</span>\nFirst foo<span class="token punctuation">:</span>  Value <span class="token keyword">for</span> foo\nSecond foo<span class="token punctuation">:</span> Value <span class="token keyword">for</span> foo</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>exists 属性本来就在实例字典里，所以访问 data.exists 时不会触发 <code class="language-text">__getattr__</code>。接下来，开始访问 data.foo。foo 属性不在实例字典中，因此系统会触发 <code class="language-text">__getattr__</code> 方法，这个方法会通过 setattr 把 foo 属性添加到实例字典。然后，我们第二次访问 data.foo，这次 data 实例的 <code class="language-text">__dict__</code> 字典已经包含这个属性，所以不会触发 <code class="language-text">__getattr__</code>。</p>\n<p>如果要实现惰性的（lazy，也指按需的）数据访问机制，而这份数据又没有 schema，那么通过 <code class="language-text">__getattr__</code> 来做就相当合适。它只需要把属性加载一次即可，以后再访问这个属性时，系统会直接从实例字典中获取。</p>\n<p>假设我们现在还需要验证数据库系统的事务状态。也就是说，用户每次访问某属性时，我们都要确保数据库里面的那条记录依然有效，而且相应的事务也处在开启状态。这个需求没办法通过 <code class="language-text">__getattr__</code> 实现，因为一旦对象的实例字典里包含了这个属性，那么程序就会直接从字典获取，而不会再触发 <code class="language-text">__getattr__</code>。</p>\n<p>为了应对这种比较高级的用法，Python 的 object 还提供了另一个挂钩，叫作 <code class="language-text">__getattribute__</code>。只要访问对象中的属性，就会触发这个特殊方法，即便这项属性已经在 <code class="language-text">__dict__</code> 字典里，系统也还是会执行 <code class="language-text">__getattribute__</code> 方法。于是，我们可以在这个方法里面检测全局的事务状态，这样就能对每一次属性访问操作都进行验证了。同时，我们必须注意这种写法开销很大，而且会降低程序的效率，但有的时候确实值得这么做。下面就定义 ValidatingRecord 类，让它实现 <code class="language-text">__getattribute__</code> 方法，并在系统每次调用这个方法时，打印相关的日志消息。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3940878944863546400"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class ValidatingRecord:\n    def __init__(self):\n        self.exists = 5\n\n    def __getattribute__(self, name):\n        print(f\'* Called __getattribute__({name!r})\')\n        try:\n            value = super().__getattribute__(name)\n            print(f\'* Found {name!r}, returning {value!r}\')\n            return value\n        except AttributeError:\n            value = f\'Value for {name}\'\n            print(f\'* Setting {name!r} to {value!r}\')\n            setattr(self, name, value)\n            return value\n\n\ndata = ValidatingRecord()\nprint(\'exists:    \', data.exists)\nprint(\'First foo: \', data.foo)\nprint(\'Second foo:\', data.foo)\n\n>>>\n* Called __getattribute__(\'exists\')\n* Found \'exists\', returning 5\nexists:     5\n* Called __getattribute__(\'foo\')\n* Setting \'foo\' to \'Value for foo\'\nFirst foo:  Value for foo\n* Called __getattribute__(\'foo\')\n* Found \'foo\', returning \'Value for foo\'\nSecond foo: Value for foo`, `3940878944863546400`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">ValidatingRecord</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>exists <span class="token operator">=</span> <span class="token number">5</span>\n\n    <span class="token keyword">def</span> <span class="token function">__getattribute__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'* Called __getattribute__(</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">)\'</span></span><span class="token punctuation">)</span>\n        <span class="token keyword">try</span><span class="token punctuation">:</span>\n            value <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__getattribute__<span class="token punctuation">(</span>name<span class="token punctuation">)</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'* Found </span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">, returning </span><span class="token interpolation"><span class="token punctuation">{</span>value<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n            <span class="token keyword">return</span> value\n        <span class="token keyword">except</span> AttributeError<span class="token punctuation">:</span>\n            value <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f\'Value for </span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">\'</span></span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'* Setting </span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string"> to </span><span class="token interpolation"><span class="token punctuation">{</span>value<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n            <span class="token builtin">setattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n            <span class="token keyword">return</span> value\n\n\ndata <span class="token operator">=</span> ValidatingRecord<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'exists:    \'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>exists<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'First foo: \'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>foo<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Second foo:\'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>foo<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token operator">*</span> Called __getattribute__<span class="token punctuation">(</span><span class="token string">\'exists\'</span><span class="token punctuation">)</span>\n<span class="token operator">*</span> Found <span class="token string">\'exists\'</span><span class="token punctuation">,</span> returning <span class="token number">5</span>\nexists<span class="token punctuation">:</span>     <span class="token number">5</span>\n<span class="token operator">*</span> Called __getattribute__<span class="token punctuation">(</span><span class="token string">\'foo\'</span><span class="token punctuation">)</span>\n<span class="token operator">*</span> Setting <span class="token string">\'foo\'</span> to <span class="token string">\'Value for foo\'</span>\nFirst foo<span class="token punctuation">:</span>  Value <span class="token keyword">for</span> foo\n<span class="token operator">*</span> Called __getattribute__<span class="token punctuation">(</span><span class="token string">\'foo\'</span><span class="token punctuation">)</span>\n<span class="token operator">*</span> Found <span class="token string">\'foo\'</span><span class="token punctuation">,</span> returning <span class="token string">\'Value for foo\'</span>\nSecond foo<span class="token punctuation">:</span> Value <span class="token keyword">for</span> foo</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果要访问的属性根本就不应该存在，那么可以在 <code class="language-text">__getattr__</code> 方法里面拦截。无论是 <code class="language-text">__getattr__</code> 还是 <code class="language-text">__getattribute__</code>，都应该抛出标准的 AttributeError 来表示属性不存在或不适合存在的情况。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62693943699264680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MissingPropertyRecord:\n    def __getattr__(self, name):\n        if name == \'bad_name\':\n            raise AttributeError(f\'{name} is missing\')\n        return ()\n\n\ndata = MissingPropertyRecord()\ndata.bad_name\n\n>>>\nTraceback ...\nAttributeError: bad_name is missing`, `62693943699264680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MissingPropertyRecord</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__getattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> name <span class="token operator">==</span> <span class="token string">\'bad_name\'</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span> AttributeError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string"> is missing\'</span></span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n\ndata <span class="token operator">=</span> MissingPropertyRecord<span class="token punctuation">(</span><span class="token punctuation">)</span>\ndata<span class="token punctuation">.</span>bad_name\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nAttributeError<span class="token punctuation">:</span> bad_name <span class="token keyword">is</span> missing</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在编写通用的 Python 代码时，我们经常要依靠内置的 hasattr 函数判断属性是否存在，并且通过内置的 getattr 函数获取属性值。这些函数也会先在实例的 <code class="language-text">__dict__</code> 字典里面查找，如果找不到，则会触发 <code class="language-text">__getattr__</code>。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93631642236582230000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class LazyRecord:\n    def __init__(self):\n        self.exists = 5\n\n    def __getattr__(self, name):\n        value = f\'Value for {name}\'\n        setattr(self, name, value)\n        return value\n\n\nclass LoggingLazyRecord(LazyRecord):\n    def __getattr__(self, name):\n        print(\n            f\'* Called __getattr__({name!r}), populating instance dictionary\')\n        result = super().__getattr__(name)\n        print(f\'* Returning {result!r}\')\n        return result\n\n\ndata = LoggingLazyRecord()  # Implements __getattr__\nprint(\'Before:        \', data.__dict__)\nprint(\'Has first foo: \', hasattr(data, \'foo\'))\nprint(\'After:         \', data.__dict__)\nprint(\'Has second foo:\', hasattr(data, \'foo\'))\n\n>>>\nBefore:         {\'exists\': 5}\n* Called __getattr__(\'foo\'), populating instance dictionary\n* Returning \'Value for foo\'\nHas first foo:  True\nAfter:          {\'exists\': 5, \'foo\': \'Value for foo\'}\nHas second foo: True`, `93631642236582230000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">LazyRecord</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>exists <span class="token operator">=</span> <span class="token number">5</span>\n\n    <span class="token keyword">def</span> <span class="token function">__getattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        value <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f\'Value for </span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">\'</span></span>\n        <span class="token builtin">setattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> value\n\n\n<span class="token keyword">class</span> <span class="token class-name">LoggingLazyRecord</span><span class="token punctuation">(</span>LazyRecord<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__getattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>\n            <span class="token string-interpolation"><span class="token string">f\'* Called __getattr__(</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">), populating instance dictionary\'</span></span><span class="token punctuation">)</span>\n        result <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__getattr__<span class="token punctuation">(</span>name<span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'* Returning </span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> result\n\n\ndata <span class="token operator">=</span> LoggingLazyRecord<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># Implements __getattr__</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Before:        \'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Has first foo: \'</span><span class="token punctuation">,</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">\'foo\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After:         \'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Has second foo:\'</span><span class="token punctuation">,</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">\'foo\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore<span class="token punctuation">:</span>         <span class="token punctuation">{</span><span class="token string">\'exists\'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">}</span>\n<span class="token operator">*</span> Called __getattr__<span class="token punctuation">(</span><span class="token string">\'foo\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> populating instance dictionary\n<span class="token operator">*</span> Returning <span class="token string">\'Value for foo\'</span>\nHas first foo<span class="token punctuation">:</span>  <span class="token boolean">True</span>\nAfter<span class="token punctuation">:</span>          <span class="token punctuation">{</span><span class="token string">\'exists\'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">\'foo\'</span><span class="token punctuation">:</span> <span class="token string">\'Value for foo\'</span><span class="token punctuation">}</span>\nHas second foo<span class="token punctuation">:</span> <span class="token boolean">True</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在运行上面那段代码的过程中，<code class="language-text">__getattr__</code> 只触发了一次。假如 data 所属的类实现的不是 <code class="language-text">__getattr__</code>，而是 <code class="language-text">__getattribute__</code> 方法，那么效果就不一样了，程序每次对实例做 hasattr 与 getattr 操作时，都会触发这个方法。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95643931424881720000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class ValidatingRecord:\n    def __init__(self):\n        self.exists = 5\n\n    def __getattribute__(self, name):\n        print(f\'* Called __getattribute__({name!r})\')\n        try:\n            value = super().__getattribute__(name)\n            print(f\'* Found {name!r}, returning {value!r}\')\n            return value\n        except AttributeError:\n            value = f\'Value for {name}\'\n            print(f\'* Setting {name!r} to {value!r}\')\n            setattr(self, name, value)\n            return value\n\n\ndata = ValidatingRecord()  # Implements __getattribute__\nprint(\'Has first foo: \', hasattr(data, \'foo\'))\nprint(\'Has second foo:\', hasattr(data, \'foo\'))\n\n>>>\n* Called __getattribute__(\'foo\')\n* Setting \'foo\' to \'Value for foo\'\nHas first foo:  True\n* Called __getattribute__(\'foo\')\n* Found \'foo\', returning \'Value for foo\'\nHas second foo: True`, `95643931424881720000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">ValidatingRecord</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>exists <span class="token operator">=</span> <span class="token number">5</span>\n\n    <span class="token keyword">def</span> <span class="token function">__getattribute__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'* Called __getattribute__(</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">)\'</span></span><span class="token punctuation">)</span>\n        <span class="token keyword">try</span><span class="token punctuation">:</span>\n            value <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__getattribute__<span class="token punctuation">(</span>name<span class="token punctuation">)</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'* Found </span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">, returning </span><span class="token interpolation"><span class="token punctuation">{</span>value<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n            <span class="token keyword">return</span> value\n        <span class="token keyword">except</span> AttributeError<span class="token punctuation">:</span>\n            value <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f\'Value for </span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">\'</span></span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'* Setting </span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string"> to </span><span class="token interpolation"><span class="token punctuation">{</span>value<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n            <span class="token builtin">setattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n            <span class="token keyword">return</span> value\n\n\ndata <span class="token operator">=</span> ValidatingRecord<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># Implements __getattribute__</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Has first foo: \'</span><span class="token punctuation">,</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">\'foo\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Has second foo:\'</span><span class="token punctuation">,</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">\'foo\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token operator">*</span> Called __getattribute__<span class="token punctuation">(</span><span class="token string">\'foo\'</span><span class="token punctuation">)</span>\n<span class="token operator">*</span> Setting <span class="token string">\'foo\'</span> to <span class="token string">\'Value for foo\'</span>\nHas first foo<span class="token punctuation">:</span>  <span class="token boolean">True</span>\n<span class="token operator">*</span> Called __getattribute__<span class="token punctuation">(</span><span class="token string">\'foo\'</span><span class="token punctuation">)</span>\n<span class="token operator">*</span> Found <span class="token string">\'foo\'</span><span class="token punctuation">,</span> returning <span class="token string">\'Value for foo\'</span>\nHas second foo<span class="token punctuation">:</span> <span class="token boolean">True</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>假设程序给 Python 对象赋值时，我们不想立刻更新数据库，而是打算稍后再推送回去。这个功能可以通过 <code class="language-text">__setattr__</code> 实现，而它也是 object 提供的挂钩，可以拦截所有的属性赋值操作。属性的获取操作分别通过 <code class="language-text">__getattr__</code> 与 <code class="language-text">__getattribute__</code> 挂钩拦截，但设置操作只需要这一个挂钩就行。只要给实例中的属性赋值（不论是直接赋值，还是通过内置的 setattr 函数赋值），系统就触发 <code class="language-text">__setattr__</code> 方法。</p>\n<p>下面我们从 SavingRecord 中派生一个子类，让它的 <code class="language-text">__setattr__</code> 方法把每一次属性赋值操作都记录下来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76493087415938000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class SavingRecord:\n    def __setattr__(self, name, value):\n        # Save some data for the record\n        super().__setattr__(name, value)\n\n\nclass LoggingSavingRecord(SavingRecord):\n    def __setattr__(self, name, value):\n        print(f\'* Called setattr__({name!r}, {value!r})\')\n        super().__setattr__(name, value)\n\n\ndata = LoggingSavingRecord()\nprint(\'Before: \', data.__dict__)\ndata.foo = 5\nprint(\'After:  \', data.__dict__)\ndata.foo = 7\nprint(\'Finally:\', data.__dict__)\n\n>>>\nBefore:  {}\n* Called setattr__(\'foo\', 5)\nAfter:   {\'foo\': 5}\n* Called setattr__(\'foo\', 7)\nFinally: {\'foo\': 7}`, `76493087415938000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">SavingRecord</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__setattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token comment"># Save some data for the record</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__setattr__<span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">LoggingSavingRecord</span><span class="token punctuation">(</span>SavingRecord<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__setattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'* Called setattr__(</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{</span>value<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">)\'</span></span><span class="token punctuation">)</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__setattr__<span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n\n\ndata <span class="token operator">=</span> LoggingSavingRecord<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Before: \'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\ndata<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">5</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After:  \'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\ndata<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">7</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Finally:\'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore<span class="token punctuation">:</span>  <span class="token punctuation">{</span><span class="token punctuation">}</span>\n<span class="token operator">*</span> Called setattr__<span class="token punctuation">(</span><span class="token string">\'foo\'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>\nAfter<span class="token punctuation">:</span>   <span class="token punctuation">{</span><span class="token string">\'foo\'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">}</span>\n<span class="token operator">*</span> Called setattr__<span class="token punctuation">(</span><span class="token string">\'foo\'</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span>\nFinally<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'foo\'</span><span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><code class="language-text">__getattribute__</code> 与 <code class="language-text">__setattr__</code> 这样的方法有个问题，就是只要访问对象的属性，系统就会触发该方法。但有时候，我们其实并不希望出现这种效果。例如，我们想实现这样一个类，让它通过自制的字典而不是标准的 <code class="language-text">__dict__</code> 来保存属性，当在这个类的实例上面访问属性时，那么该实例会从自己的 <code class="language-text">_data</code> 字典里面查找。</p>\n<p>可是，这样就导致 <code class="language-text">__getattribute__</code> 方法必须访问 <code class="language-text">self._data</code> 才行。如果直接访问，那么程序就会一直递归下去，直到因为超过最大的递归层数而崩溃为止。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40285299409025250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class BrokenDictionaryRecord:\n    def __init__(self, data):\n        self._data = data\n\n    def __getattribute__(self, name):\n        print(f\'* Called __getattribute__({name!r})\')\n        return self._data[name]\n\n\ndata = BrokenDictionaryRecord({\'foo\': 3})\ndata.foo\n\n>>>\n* Called __getattribute__(\'foo\')\n* Called __getattribute__(\'_data\')\n...\nRecursionError: maximum recursion depth exceeded while calling a Python object`, `40285299409025250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">BrokenDictionaryRecord</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_data <span class="token operator">=</span> data\n\n    <span class="token keyword">def</span> <span class="token function">__getattribute__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'* Called __getattribute__(</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">)\'</span></span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_data<span class="token punctuation">[</span>name<span class="token punctuation">]</span>\n\n\ndata <span class="token operator">=</span> BrokenDictionaryRecord<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'foo\'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">)</span>\ndata<span class="token punctuation">.</span>foo\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token operator">*</span> Called __getattribute__<span class="token punctuation">(</span><span class="token string">\'foo\'</span><span class="token punctuation">)</span>\n<span class="token operator">*</span> Called __getattribute__<span class="token punctuation">(</span><span class="token string">\'_data\'</span><span class="token punctuation">)</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nRecursionError<span class="token punctuation">:</span> maximum recursion depth exceeded <span class="token keyword">while</span> calling a Python <span class="token builtin">object</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>为什么会这样呢？因为在 <code class="language-text">__getattribute__</code> 访问 <code class="language-text">self._data</code> 时，由于 <code class="language-text">_data</code> 是自身的一项属性，程序会触发 <code class="language-text">__getattribute__</code> 来获取这项属性，这又会访问到 <code class="language-text">self._data</code>，于是程序就一直递归下去。为解决这个问题，我们可以改用 <code class="language-text">super().__getattribute__</code> 方法获取 <code class="language-text">_data</code> 属性，由于超类的 <code class="language-text">__getattribute__</code> 是直接从实例的属性字典获取的，不会继续触发 <code class="language-text">__getattribute__</code>，这样就避开了递归。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47647623378052930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class DictionaryRecord:\n    def __init__(self, data):\n        self._data = data\n\n    def __getattribute__(self, name):\n        print(f\'* Called __getattribute__({name!r})\')\n        return super().__getattribute__(\'_data\')[name]\n\n\ndata = DictionaryRecord({\'foo\': 3})\nprint(\'foo\', data.foo)\n\n>>>\n* Called __getattribute__(\'foo\')\nfoo 3`, `47647623378052930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">DictionaryRecord</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_data <span class="token operator">=</span> data\n\n    <span class="token keyword">def</span> <span class="token function">__getattribute__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'* Called __getattribute__(</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">)\'</span></span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__getattribute__<span class="token punctuation">(</span><span class="token string">\'_data\'</span><span class="token punctuation">)</span><span class="token punctuation">[</span>name<span class="token punctuation">]</span>\n\n\ndata <span class="token operator">=</span> DictionaryRecord<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'foo\'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'foo\'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>foo<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token operator">*</span> Called __getattribute__<span class="token punctuation">(</span><span class="token string">\'foo\'</span><span class="token punctuation">)</span>\nfoo <span class="token number">3</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 <code class="language-text">__setattr__</code> 里面为这种对象实现属性修改逻辑时，也需要通过 <code class="language-text">super().__setattr__</code> 来获取 <code class="language-text">_data</code> 字典。</p>\n<h3 id="总结-43"><a href="#%E6%80%BB%E7%BB%93-43" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>如果想用自己的方式（例如惰性地或者按需地）加载并保存对象属性，那么可以在该对象所属的类里实现 <code class="language-text">__getattr__</code> 与 <code class="language-text">__setattr__</code> 特殊方法。</li>\n<li><code class="language-text">__getattr__</code> 只会在属性缺失时触发，而 <code class="language-text">__getattribute__</code> 则在每次访问属性时都要触发。</li>\n<li>在实现 <code class="language-text">__getattribute__</code> 与 <code class="language-text">__setattr__</code> 的过程中，如果要使用本对象的普通属性，那么应该通过 <code class="language-text">super()</code>（也就是 object 类）来使用，而不要直接使用，以避免无限递归。</li>\n</ol>\n<h2 id="第-48-条：用-__init_subclass__-验证子类写得是否正确"><a href="#%E7%AC%AC-48-%E6%9D%A1%EF%BC%9A%E7%94%A8-__init_subclass__-%E9%AA%8C%E8%AF%81%E5%AD%90%E7%B1%BB%E5%86%99%E5%BE%97%E6%98%AF%E5%90%A6%E6%AD%A3%E7%A1%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 48 条：用 <code class="language-text">__init_subclass__</code> 验证子类写得是否正确</h2>\n<p>元类最简单的一种用法是验证某个类定义得是否正确。如果要构建一套比较复杂的类体系，那我们可能得确保这套体系中的类采用的都是同一种风格，为此我们可能需要判断这些类有没有重写必要的方法，或者判断类属性之间的关系是否合理。元类提供了一种可靠的手段，只要根据这个元类来定义新类，就能用元类中的验证逻辑核查新类的代码写得是否正确。</p>\n<p>一般来说，我们会在类的 <code class="language-text">__init__</code> 方法里面检查新对象构造得是否正确（参见第 44 条）。但有的时候，整个类的写法可能都是错的，而不单单是该类的某个对象构造得有问题，所以我们想尽早拦住这种错误。例如，当程序刚刚启动并把包含这个类的模块加载进来时，我们就想验证这个类写得对不对，此时便可利用元类来实现。</p>\n<p>在讲解如何用自定义的元类验证子类之前，我们首先必须明白元类的标准用法。元类应该从 type 之中继承。在默认情况下，系统会把通过这个元类所定义的其他类发送给元类的 <code class="language-text">__new__</code> 方法，让该方法知道那个类的 class 语句是怎么写的。下面就定义这样一个元类，如果用户通过这个元类来定义其他类，那么在那个类真正构造出来之前，我们可以先在 <code class="language-text">__new__</code> 里面观察到它的写法并做出修改。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55775791410848810000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Meta(type):\n    def __new__(meta, name, bases, class_dict):\n        print(f\'* Running {meta}.__new__ for {name}\')\n        print(\'Bases:\', bases)\n        print(class_dict)\n        return type.__new__(meta, name, bases, class_dict)\n\n\nclass MyClass(metaclass=Meta):\n    stuff = 123\n\n    def foo(self):\n        pass\n\n\nclass MySubclass(MyClass):\n    other = 567\n\n    def bar(self):\n        pass\n\n>>>\n* Running <class \'__main__.Meta\'>.__new__ for MyClass\nBases: ()\n{\'__module__\': \'__main__\', \'__qualname__\': \'MyClass\', \'stuff\': 123, \'foo\': <function MyClass.foo at 0x7f7b6c15b9d0>}\n* Running <class \'__main__.Meta\'>.__new__ for MySubclass\nBases: (<class \'__main__.MyClass\'>,)\n{\'__module__\': \'__main__\', \'__qualname__\': \'MySubclass\', \'other\': 567, \'bar\': <function MySubclass.bar at 0x7f7b6c15ba60>}`, `55775791410848810000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'* Running </span><span class="token interpolation"><span class="token punctuation">{</span>meta<span class="token punctuation">}</span></span><span class="token string">.__new__ for </span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Bases:\'</span><span class="token punctuation">,</span> bases<span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>class_dict<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token builtin">type</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">MyClass</span><span class="token punctuation">(</span>metaclass<span class="token operator">=</span>Meta<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    stuff <span class="token operator">=</span> <span class="token number">123</span>\n\n    <span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">pass</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">MySubclass</span><span class="token punctuation">(</span>MyClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    other <span class="token operator">=</span> <span class="token number">567</span>\n\n    <span class="token keyword">def</span> <span class="token function">bar</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">pass</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token operator">*</span> Running <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.Meta\'</span><span class="token operator">></span><span class="token punctuation">.</span>__new__ <span class="token keyword">for</span> MyClass\nBases<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">{</span><span class="token string">\'__module__\'</span><span class="token punctuation">:</span> <span class="token string">\'__main__\'</span><span class="token punctuation">,</span> <span class="token string">\'__qualname__\'</span><span class="token punctuation">:</span> <span class="token string">\'MyClass\'</span><span class="token punctuation">,</span> <span class="token string">\'stuff\'</span><span class="token punctuation">:</span> <span class="token number">123</span><span class="token punctuation">,</span> <span class="token string">\'foo\'</span><span class="token punctuation">:</span> <span class="token operator">&lt;</span>function MyClass<span class="token punctuation">.</span>foo at <span class="token number">0x7f7b6c15b9d0</span><span class="token operator">></span><span class="token punctuation">}</span>\n<span class="token operator">*</span> Running <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.Meta\'</span><span class="token operator">></span><span class="token punctuation">.</span>__new__ <span class="token keyword">for</span> MySubclass\nBases<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.MyClass\'</span><span class="token operator">></span><span class="token punctuation">,</span><span class="token punctuation">)</span>\n<span class="token punctuation">{</span><span class="token string">\'__module__\'</span><span class="token punctuation">:</span> <span class="token string">\'__main__\'</span><span class="token punctuation">,</span> <span class="token string">\'__qualname__\'</span><span class="token punctuation">:</span> <span class="token string">\'MySubclass\'</span><span class="token punctuation">,</span> <span class="token string">\'other\'</span><span class="token punctuation">:</span> <span class="token number">567</span><span class="token punctuation">,</span> <span class="token string">\'bar\'</span><span class="token punctuation">:</span> <span class="token operator">&lt;</span>function MySubclass<span class="token punctuation">.</span>bar at <span class="token number">0x7f7b6c15ba60</span><span class="token operator">></span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>元类可以获知那个类的名称（name）、那个类的所有超类（bases）以及 class 语句体中定义的所有类属性（<code class="language-text">class_dict</code>）。因为每个类最终都要继承 object，所以这个 object 名字不会体现在罗列超类名称的 bases 元组之中。</p>\n<p>我们可以在元类的 <code class="language-text">__new__</code> 方法里面添加一些代码，用来判断根据这个元类所定义的类的各项参数是否合理。例如，要用不同的类来表示边数不同的多边形（polygon）。如果把这些类都纳入同一套体系，那么可以定义这样一个元类，让该体系内的所有类都受它约束。我们在这个元类的 <code class="language-text">__new__</code> 里面检查那些类的边数（sides）是否有效。注意，不要把检查逻辑运用到类体系的顶端，也就是基类 Polygon 上面。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25514086447174234000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class ValidatePolygon(type):\n    def __new__(meta, name, bases, class_dict):\n        # Only validate subclasses of the Polygon class\n        if bases:\n            if class_dict[\'sides\'] < 3:\n                raise ValueError(\'Polygons need 3+ sides\')\n        return type.__new__(meta, name, bases, class_dict)\n\n\nclass Polygon(metaclass=ValidatePolygon):\n    sides = None  # Must be specified by subclasses\n\n    @classmethod\n    def interior_angles(cls):\n        return (cls.sides - 2) * 180\n\n\nclass Triangle(Polygon):\n    sides = 3\n\n\nclass Rectangle(Polygon):\n    sides = 4\n\n\nclass Nonagon(Polygon):\n    sides = 9\n\n\nassert Triangle.interior_angles() == 180\nassert Rectangle.interior_angles() == 360\nassert Nonagon.interior_angles() == 1260`, `25514086447174234000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">ValidatePolygon</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token comment"># Only validate subclasses of the Polygon class</span>\n        <span class="token keyword">if</span> bases<span class="token punctuation">:</span>\n            <span class="token keyword">if</span> class_dict<span class="token punctuation">[</span><span class="token string">\'sides\'</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">:</span>\n                <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Polygons need 3+ sides\'</span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token builtin">type</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Polygon</span><span class="token punctuation">(</span>metaclass<span class="token operator">=</span>ValidatePolygon<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    sides <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># Must be specified by subclasses</span>\n\n    <span class="token decorator annotation punctuation">@classmethod</span>\n    <span class="token keyword">def</span> <span class="token function">interior_angles</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token punctuation">(</span>cls<span class="token punctuation">.</span>sides <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">180</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Triangle</span><span class="token punctuation">(</span>Polygon<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    sides <span class="token operator">=</span> <span class="token number">3</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Rectangle</span><span class="token punctuation">(</span>Polygon<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    sides <span class="token operator">=</span> <span class="token number">4</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Nonagon</span><span class="token punctuation">(</span>Polygon<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    sides <span class="token operator">=</span> <span class="token number">9</span>\n\n\n<span class="token keyword">assert</span> Triangle<span class="token punctuation">.</span>interior_angles<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">180</span>\n<span class="token keyword">assert</span> Rectangle<span class="token punctuation">.</span>interior_angles<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">360</span>\n<span class="token keyword">assert</span> Nonagon<span class="token punctuation">.</span>interior_angles<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1260</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果我们试着定义边数小于 3 的多边形子类，那么刚把那个子类的 class 语句体写完，元类就会通过 <code class="language-text">__new__</code> 方法察觉到这个问题。这意味着，只要定义了无效的多边形子类，程序就无法正常启动，除非那个类是在动态引入的模块里面定义的（参见第 88 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13011477078893208000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Line(Polygon):\n    sides = 2\n\n>>>\nTraceback ...\nValueError: Polygons need 3+ sides`, `13011477078893208000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Line</span><span class="token punctuation">(</span>Polygon<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    sides <span class="token operator">=</span> <span class="token number">2</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nValueError<span class="token punctuation">:</span> Polygons need <span class="token number">3</span><span class="token operator">+</span> sides</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样一项基本的任务竟然要写这么多代码才能实现。好在 Python 3.6 引入了一种简化的写法，能够直接通过 <code class="language-text">__init_subclass__</code> 这个特殊的类方法实现相同的功能，这样就不用专门定义元类了。下面我们改用这个机制来实现与刚才相同的验证逻辑。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82296504047739850000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class BetterPolygon:\n    sides = None  # Must be specified by subclasses\n\n    def __init_subclass__(cls):\n        super().__init_subclass__()\n        if cls.sides < 3:\n            raise ValueError(\'Polygons need 3+ sides\')\n\n    @classmethod\n    def interior_angles(cls):\n        return (cls.sides - 2) * 180\n\n\nclass Hexagon(BetterPolygon):\n    sides = 6\n\n\nassert Hexagon.interior_angles() == 720`, `82296504047739850000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">BetterPolygon</span><span class="token punctuation">:</span>\n    sides <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># Must be specified by subclasses</span>\n\n    <span class="token keyword">def</span> <span class="token function">__init_subclass__</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init_subclass__<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">if</span> cls<span class="token punctuation">.</span>sides <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Polygons need 3+ sides\'</span><span class="token punctuation">)</span>\n\n    @<span class="token builtin">classmethod</span>\n    <span class="token keyword">def</span> <span class="token function">interior_angles</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token punctuation">(</span>cls<span class="token punctuation">.</span>sides <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">180</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Hexagon</span><span class="token punctuation">(</span>BetterPolygon<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    sides <span class="token operator">=</span> <span class="token number">6</span>\n\n\n<span class="token keyword">assert</span> Hexagon<span class="token punctuation">.</span>interior_angles<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">720</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在的代码简短多了，完全不需要定义 ValidatePolygon 这样一个元类。在 <code class="language-text">__init_subclass__</code> 方法里面，我们可以直接通过 cls 实例来访问类级别的 sides 属性，而不用像原来那样，在存放类属性的 <code class="language-text">class_dict</code> 里面查询 sides 键。现在的多边形子类应该继承刚写的 BetterPolygon 基类。如果子类定义的边数无效，那么程序会抛出同样的异常。</p>\n<p>用标准的 Python 元类机制来实现验证还有个缺点，就是每个类只能定义一个元类。例如，这里还有一个元类，可以验证某个区域的填充色是否有效（这个区域有可能是多边形区域，也有可能不是）。</p>\n<p>如果想同时利用 Filled 的元类与 Polygon 的元类做验证，那么程序就会给出奇怪的错误消息。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14399700741032450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class ValidatePolygon(type):\n    def __new__(meta, name, bases, class_dict):\n        # Only validate subclasses of the Polygon class\n        if bases:\n            if class_dict[\'sides\'] < 3:\n                raise ValueError(\'Polygons need 3+ sides\')\n        return type.__new__(meta, name, bases, class_dict)\n\n\nclass Polygon(metaclass=ValidatePolygon):\n    sides = None  # Must be specified by subclasses\n\n    @classmethod\n    def interior_angles(cls):\n        return (cls.sides - 2) * 180\n\n\nclass ValidateFilled(type):\n    def __new__(meta, name, bases, class_dict):\n        # Only validate subclasses of the Filled class\n        if bases:\n            if class_dict[\'color\'] not in (\'red\', \'green\'):\n                raise ValueError(\'Fill color must be supported\')\n        return type.__new__(meta, name, bases, class_dict)\n\n\nclass Filled (metaclass=ValidateFilled):\n    color = None  # Must be specified by subclasses\n\n\nclass RedPentagon(Filled, Polygon):\n    color = \'red\'\n    sides = 5\n\n>>>\nTraceback ...\nTypeError: metaclass conflict: the metaclass of a derived class must be a (non-strict) subclass of the metaclasses of all its bases`, `14399700741032450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">ValidatePolygon</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token comment"># Only validate subclasses of the Polygon class</span>\n        <span class="token keyword">if</span> bases<span class="token punctuation">:</span>\n            <span class="token keyword">if</span> class_dict<span class="token punctuation">[</span><span class="token string">\'sides\'</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">:</span>\n                <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Polygons need 3+ sides\'</span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token builtin">type</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Polygon</span><span class="token punctuation">(</span>metaclass<span class="token operator">=</span>ValidatePolygon<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    sides <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># Must be specified by subclasses</span>\n\n    <span class="token decorator annotation punctuation">@classmethod</span>\n    <span class="token keyword">def</span> <span class="token function">interior_angles</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token punctuation">(</span>cls<span class="token punctuation">.</span>sides <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">180</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">ValidateFilled</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token comment"># Only validate subclasses of the Filled class</span>\n        <span class="token keyword">if</span> bases<span class="token punctuation">:</span>\n            <span class="token keyword">if</span> class_dict<span class="token punctuation">[</span><span class="token string">\'color\'</span><span class="token punctuation">]</span> <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token string">\'red\'</span><span class="token punctuation">,</span> <span class="token string">\'green\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n                <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Fill color must be supported\'</span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token builtin">type</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Filled</span> <span class="token punctuation">(</span>metaclass<span class="token operator">=</span>ValidateFilled<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    color <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># Must be specified by subclasses</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">RedPentagon</span><span class="token punctuation">(</span>Filled<span class="token punctuation">,</span> Polygon<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    color <span class="token operator">=</span> <span class="token string">\'red\'</span>\n    sides <span class="token operator">=</span> <span class="token number">5</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> metaclass conflict<span class="token punctuation">:</span> the metaclass of a derived <span class="token keyword">class</span> <span class="token class-name">must</span> be a <span class="token punctuation">(</span>non<span class="token operator">-</span>strict<span class="token punctuation">)</span> subclass of the metaclasses of <span class="token builtin">all</span> its bases</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>要解决这个问题，我们可以创建一套元类体系，让不同层面上的元类分别完成各自的验证逻辑（也就是先在下层元类里面验证填充色，如果验证无误，那么再去上层元类里面验证边数）。</p>\n<p>同时，这也要求我们必须设计一个支持填充色的多边形类（FilledPolygon），让它在多边形类（Polygon）的基础上增加填充色逻辑，而不能像刚才那样，把填充色与边数分别放在 Filled 与 Polygon 两个类中。现在，带有具体填充色与边数的多边形需要从这个 FilledPolygon 里面继承。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49912269921918640000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class ValidatePolygon(type):\n    def __new__(meta, name, bases, class_dict):\n        # Only validate non-root classes\n        if not class_dict.get(\'is_root\'):\n            if class_dict[\'sides\'] < 3:\n                raise ValueError(\'Polygons need 3+ sides\')\n        return type.__new__(meta, name, bases, class_dict)\n\n\nclass Polygon(metaclass=ValidatePolygon):\n    is_root = True\n    sides = None  # Must be specified by subclasses\n\n\nclass ValidateFilledPolygon(ValidatePolygon):\n    def __new__(meta, name, bases, class_dict):\n        # Only validate non-root classes\n        if not class_dict.get(\'is_root\'):\n            if class_dict[\'color\'] not in (\'red\', \'green\'):\n                raise ValueError(\'Fill color must be supported\')\n        return super().__new__(meta, name, bases, class_dict)\n\n\nclass FilledPolygon(Polygon, metaclass=ValidateFilledPolygon):\n    is_root = True\n    color = None  # Must be specified by subclasses\n\n\nclass GreenPentagon(FilledPolygon):\n    color = \'green\'\n    sides = 5\n\n\ngreenie = GreenPentagon()\nassert isinstance(greenie, Polygon)`, `49912269921918640000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">ValidatePolygon</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token comment"># Only validate non-root classes</span>\n        <span class="token keyword">if</span> <span class="token keyword">not</span> class_dict<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'is_root\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">if</span> class_dict<span class="token punctuation">[</span><span class="token string">\'sides\'</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">:</span>\n                <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Polygons need 3+ sides\'</span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token builtin">type</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Polygon</span><span class="token punctuation">(</span>metaclass<span class="token operator">=</span>ValidatePolygon<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    is_root <span class="token operator">=</span> <span class="token boolean">True</span>\n    sides <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># Must be specified by subclasses</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">ValidateFilledPolygon</span><span class="token punctuation">(</span>ValidatePolygon<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token comment"># Only validate non-root classes</span>\n        <span class="token keyword">if</span> <span class="token keyword">not</span> class_dict<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'is_root\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">if</span> class_dict<span class="token punctuation">[</span><span class="token string">\'color\'</span><span class="token punctuation">]</span> <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token string">\'red\'</span><span class="token punctuation">,</span> <span class="token string">\'green\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n                <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Fill color must be supported\'</span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">FilledPolygon</span><span class="token punctuation">(</span>Polygon<span class="token punctuation">,</span> metaclass<span class="token operator">=</span>ValidateFilledPolygon<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    is_root <span class="token operator">=</span> <span class="token boolean">True</span>\n    color <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># Must be specified by subclasses</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">GreenPentagon</span><span class="token punctuation">(</span>FilledPolygon<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    color <span class="token operator">=</span> <span class="token string">\'green\'</span>\n    sides <span class="token operator">=</span> <span class="token number">5</span>\n\n\ngreenie <span class="token operator">=</span> GreenPentagon<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">assert</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>greenie<span class="token punctuation">,</span> Polygon<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写虽然能实现验证，但却没办法组合。我们当时之所以把验证逻辑分别写在 ValidatePolygon 与 ValidateFilled 里面，就是想要让这些逻辑可以自由组合（类似 mix-in，参见第 41 条）。但是按照现在这种写法，如果想把颜色的验证逻辑施加在多边形之外的另一套类体系中，那么必须按照刚才的样板重复编写许多代码才行，而没办法很方便地复用已有的代码。</p>\n<p>这个问题，同样可以通过 <code class="language-text">__init_subclass__</code> 这个特殊的类方法来解决。在多层的类体系中，只要通过内置的 super() 函数来调用 <code class="language-text">__init_subclass__</code> 方法，系统就会按照适当的解析顺序触发超类或平级类的 <code class="language-text">__init_subclass__</code> 方法，以保证那些类在各自的 <code class="language-text">__init_subclass__</code> 里面所实现的验证逻辑也能够正确地执行（类似案例参见第 40 条）。这种写法可以正确应对多重继承。例如，下面这个 Filled 类就通过 <code class="language-text">__init_subclass__</code> 来验证填充色，这样的话，子类可以同时继承该类以及刚才的 BetterPolygon 类，从而把这两个类所实现的验证逻辑组合起来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34775042620518760000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Filled:\n    color = None  # Must be specified by subclasses\n\n    def __init_subclass__(cls):\n        super().__init_subclass__() # 调用下一个超类的方法\n        if cls.color not in (\'red\', \'green\', \'blue\'):\n            raise ValueError(\'Fills need a valid color\')\n\n\nclass BetterPolygon:\n    sides = None  # Must be specified by subclasses\n\n    def __init_subclass__(cls):\n        super().__init_subclass__() # 调用下一个超类的方法\n        if cls.sides < 3:\n            raise ValueError(\'Polygons need 3+ sides\')\n\n    @classmethod\n    def interior_angles(cls):\n        return (cls.sides - 2) * 180\n\n\nclass RedTriangle(Filled, BetterPolygon):\n    color = \'red\'\n    sides = 3\n\n\nruddy = RedTriangle()\nassert isinstance(ruddy, Filled)\nassert isinstance(ruddy, BetterPolygon)`, `34775042620518760000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Filled</span><span class="token punctuation">:</span>\n    color <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># Must be specified by subclasses</span>\n\n    <span class="token keyword">def</span> <span class="token function">__init_subclass__</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init_subclass__<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 调用下一个超类的方法</span>\n        <span class="token keyword">if</span> cls<span class="token punctuation">.</span>color <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token string">\'red\'</span><span class="token punctuation">,</span> <span class="token string">\'green\'</span><span class="token punctuation">,</span> <span class="token string">\'blue\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Fills need a valid color\'</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">BetterPolygon</span><span class="token punctuation">:</span>\n    sides <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># Must be specified by subclasses</span>\n\n    <span class="token keyword">def</span> <span class="token function">__init_subclass__</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init_subclass__<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 调用下一个超类的方法</span>\n        <span class="token keyword">if</span> cls<span class="token punctuation">.</span>sides <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Polygons need 3+ sides\'</span><span class="token punctuation">)</span>\n\n    @<span class="token builtin">classmethod</span>\n    <span class="token keyword">def</span> <span class="token function">interior_angles</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token punctuation">(</span>cls<span class="token punctuation">.</span>sides <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">180</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">RedTriangle</span><span class="token punctuation">(</span>Filled<span class="token punctuation">,</span> BetterPolygon<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    color <span class="token operator">=</span> <span class="token string">\'red\'</span>\n    sides <span class="token operator">=</span> <span class="token number">3</span>\n\n\nruddy <span class="token operator">=</span> RedTriangle<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">assert</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>ruddy<span class="token punctuation">,</span> Filled<span class="token punctuation">)</span>\n<span class="token keyword">assert</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>ruddy<span class="token punctuation">,</span> BetterPolygon<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78011959254168980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Top:\n    def __init_subclass__(cls):\n        super().__init_subclass__()\n        print(f\'Top for {cls}\')\n\n\nclass Left(Top):\n    def __init_subclass__(cls):\n        super().__init_subclass__()\n        print(f\'Left for {cls}\')\n\n\nclass Right(Top):\n    def __init_subclass__(cls):\n        super().__init_subclass__()\n        print(f\'Right for {cls}\')\n\n\nclass Bottom(Left, Right):\n    def __init_subclass__(cls):\n        super().__init_subclass__()\n        print(f\'Bottom for {cls}\')\n\n>>>\nTop for <class \'__main__.Left\'>\nTop for <class \'__main__.Right\'>\nTop for <class \'__main__.Bottom\'>\nRight for <class \'__main__.Bottom\'>\nLeft for <class \'__main__.Bottom\'>`, `78011959254168980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Top</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init_subclass__</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init_subclass__<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Top for </span><span class="token interpolation"><span class="token punctuation">{</span>cls<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Left</span><span class="token punctuation">(</span>Top<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init_subclass__</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init_subclass__<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Left for </span><span class="token interpolation"><span class="token punctuation">{</span>cls<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Right</span><span class="token punctuation">(</span>Top<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init_subclass__</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init_subclass__<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Right for </span><span class="token interpolation"><span class="token punctuation">{</span>cls<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Bottom</span><span class="token punctuation">(</span>Left<span class="token punctuation">,</span> Right<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init_subclass__</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init_subclass__<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Bottom for </span><span class="token interpolation"><span class="token punctuation">{</span>cls<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTop <span class="token keyword">for</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.Left\'</span><span class="token operator">></span>\nTop <span class="token keyword">for</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.Right\'</span><span class="token operator">></span>\nTop <span class="token keyword">for</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.Bottom\'</span><span class="token operator">></span>\nRight <span class="token keyword">for</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.Bottom\'</span><span class="token operator">></span>\nLeft <span class="token keyword">for</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.Bottom\'</span><span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，解决了菱形继承问题，体系底部的 Bottom 类通过 Left 与 Right 两条路径重复继承了体系顶端的 Top 类。然而，由于是通过 super() 触发 <code class="language-text">__init_subclass__</code>，系统在处理 Bottom 类的定义时，只会把 Top 类的 <code class="language-text">__init_subclass__</code> 执行一遍。</p>\n<h3 id="总结-44"><a href="#%E6%80%BB%E7%BB%93-44" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>如果某个类是根据元类所定义的，那么当系统把该类的 class 语句体全部处理完之后，就会将这个类的写法告诉元类的 <code class="language-text">__new__</code> 方法。</li>\n<li>可以利用元类在类创建完成前检视或修改开发者根据这个元类所定义的其他类，但这种机制通常显得有点笨重。</li>\n<li><code class="language-text">__init_subclass__</code> 能够用来检查子类定义得是否合理，如果不合理，那么可以提前报错，让程序无法创建出这种子类的对象。</li>\n<li>在分层的或者涉及多重继承的类体系里面，一定别忘了在你写的这些类的<code class="language-text">__init_subclass__</code> 内通过 super() 来调用超类的 <code class="language-text">__init_subclass__</code> 方法，以便按照正确的顺序触发各类的验证逻辑。</li>\n</ol>\n<h2 id="第-49-条：用-__init_subclass__-记录现有的子类"><a href="#%E7%AC%AC-49-%E6%9D%A1%EF%BC%9A%E7%94%A8-__init_subclass__-%E8%AE%B0%E5%BD%95%E7%8E%B0%E6%9C%89%E7%9A%84%E5%AD%90%E7%B1%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 49 条：用 <code class="language-text">__init_subclass__</code> 记录现有的子类</h2>\n<p>元类还有个常见的用途，是可以自动记录（或者说注册）程序之中的类型。利用这项功能，我们就能根据某个标识符反向查出它所对应的类。</p>\n<p>例如，笔者想按照自己的办法给 Python 对象做序列化处理，并将其表示成 JSON 格式的数据。要实现这个功能，首先得想办法把对象转换成 JSON 字符串。笔者在这里设计一套通用的方案，让那些想要支持这种序列化功能的类都来继承下面这个 Serializable 基类，并把构造时所用的参数上报给它，这样的话，它就可以把这些参数转换成一份 JSON 字典。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52725523278948150000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import json\n\n\nclass Serializable:\n    def __init__(self, *args):\n        self.args = args\n\n    def serialize(self):\n        return json.dumps({\'args\': self.args})`, `52725523278948150000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> json\n\n\n<span class="token keyword">class</span> <span class="token class-name">Serializable</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>args <span class="token operator">=</span> args\n\n    <span class="token keyword">def</span> <span class="token function">serialize</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'args\'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>args<span class="token punctuation">}</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>有了这个类，我们很容易就能把 Point2D 这样简单而不可变的数据转化成 JSON 字符串。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59922912316029575000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import json\n\n\nclass Serializable:\n    def __init__(self, *args):\n        self.args = args\n\n    def serialize(self):\n        return json.dumps({\'args\': self.args})\n\n\nclass Point2D(Serializable):\n    def __init__(self, x, y):\n        super().__init__(x, y)\n        self.x = x\n        self.y = y\n\n    def __repr__(self):\n        return f\'Point2D({self.x}, {self.y})\'\n\n\npoint = Point2D(5, 3)\nprint(\'Object:    \', point)\nprint(\'Serialized:\', point.serialize())\n\n>>>\nObject:     Point2D(5, 3)\nSerialized: {&quot;args&quot;: [5, 3]}`, `59922912316029575000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> json\n\n\n<span class="token keyword">class</span> <span class="token class-name">Serializable</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>args <span class="token operator">=</span> args\n\n    <span class="token keyword">def</span> <span class="token function">serialize</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'args\'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>args<span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Point2D</span><span class="token punctuation">(</span>Serializable<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>x <span class="token operator">=</span> x\n        self<span class="token punctuation">.</span>y <span class="token operator">=</span> y\n\n    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f\'Point2D(</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>x<span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>y<span class="token punctuation">}</span></span><span class="token string">)\'</span></span>\n\n\npoint <span class="token operator">=</span> Point2D<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Object:    \'</span><span class="token punctuation">,</span> point<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Serialized:\'</span><span class="token punctuation">,</span> point<span class="token punctuation">.</span>serialize<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nObject<span class="token punctuation">:</span>     Point2D<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>\nSerialized<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"args"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>假设还需要实现反序列化的功能，也就是把 JSON 格式的字符串还原成它所表示的那个 Point2D 对象。下面，我们定义这样一个类，让它继承自 Serializable，从而获得序列化的功能，并把反序列化的功能留给自己或自己的子类去实现，这样它就成了一个既支持序列化又支持反序列化的类。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80533191284451130000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Deserializable(Serializable):\n    @classmethod\n    def deserialize(cls, json_data):\n        params = json.loads(json_data)\n        return cls(*params[\'args\'])`, `80533191284451130000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Deserializable</span><span class="token punctuation">(</span>Serializable<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    @<span class="token builtin">classmethod</span>\n    <span class="token keyword">def</span> <span class="token function">deserialize</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> json_data<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        params <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>json_data<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> cls<span class="token punctuation">(</span><span class="token operator">*</span>params<span class="token punctuation">[</span><span class="token string">\'args\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们可以通过这样一套通用的方式，让比较简单的不可变数据同时具备序列化与反序列化的功能。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31539373189352450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import json\n\n\nclass Serializable:\n    def __init__(self, *args):\n        self.args = args\n\n    def serialize(self):\n        return json.dumps({\'args\': self.args})\n\n\nclass Deserializable(Serializable):\n    @classmethod\n    def deserialize(cls, json_data):\n        params = json.loads(json_data)\n        return cls(*params[\'args\'])\n\n\nclass BetterPoint2D(Deserializable):\n    def __init__(self, x, y):\n        super().__init__(x, y)\n        self.x = x\n        self.y = y\n\n    def __repr__(self):\n        return f\'Point2D({self.x}, {self.y})\'\n\n\nbefore = BetterPoint2D(5, 3)\nprint(\'Before:    \',  before)\ndata = before.serialize()\nprint(\'Serialized:\', data)\nafter = BetterPoint2D.deserialize(data)\nprint(\'After:     \', after)\n\n>>>\nBefore:     Point2D(5, 3)\nSerialized: {&quot;args&quot;: [5, 3]}\nAfter:      Point2D(5, 3)`, `31539373189352450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> json\n\n\n<span class="token keyword">class</span> <span class="token class-name">Serializable</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>args <span class="token operator">=</span> args\n\n    <span class="token keyword">def</span> <span class="token function">serialize</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'args\'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>args<span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Deserializable</span><span class="token punctuation">(</span>Serializable<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    @<span class="token builtin">classmethod</span>\n    <span class="token keyword">def</span> <span class="token function">deserialize</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> json_data<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        params <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>json_data<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> cls<span class="token punctuation">(</span><span class="token operator">*</span>params<span class="token punctuation">[</span><span class="token string">\'args\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">BetterPoint2D</span><span class="token punctuation">(</span>Deserializable<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>x <span class="token operator">=</span> x\n        self<span class="token punctuation">.</span>y <span class="token operator">=</span> y\n\n    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f\'Point2D(</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>x<span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>y<span class="token punctuation">}</span></span><span class="token string">)\'</span></span>\n\n\nbefore <span class="token operator">=</span> BetterPoint2D<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Before:    \'</span><span class="token punctuation">,</span>  before<span class="token punctuation">)</span>\ndata <span class="token operator">=</span> before<span class="token punctuation">.</span>serialize<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Serialized:\'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>\nafter <span class="token operator">=</span> BetterPoint2D<span class="token punctuation">.</span>deserialize<span class="token punctuation">(</span>data<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After:     \'</span><span class="token punctuation">,</span> after<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore<span class="token punctuation">:</span>     Point2D<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>\nSerialized<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"args"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">}</span>\nAfter<span class="token punctuation">:</span>      Point2D<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个方案的缺点是，我们必须提前知道 JSON 字符串所表示的类型（例如 Point2D 或 BetterPoint2D），然后才能把它还原成对象。如果只用一个函数就能把各种 JSON 字符串分别还原成对应类型的 Python 对象，那就更好了。</p>\n<p>为了实现这项功能，我们把对象所属的类名也添加到序列化之后的 JSON 数据里面。</p>\n<p>然后，我们用一份字典把支持序列化与反序列化的类记录下来，字典的键为类的名称，与还原这种对象时所要用到的构造函数相对应。这样的话，凡是经由 <code class="language-text">register_class</code> 注册的类，其 JSON 数据都可以通过 deserialize 函数还原成相应的对象。</p>\n<p>为确保 deserialize 函数能够正确还原 JSON 数据，我们必须把想要支持反序列化功能的类通过 <code class="language-text">register_class</code> 注册进去。</p>\n<p>这样就可以把任意的 JSON 字符串都还原为相应的对象，而不需要明确指出类名，因为 deserialize 函数会从注册字典里面查询。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68768386335935560000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import json\n\n\nclass BetterSerializable:\n    def __init__(self, *args):\n        self.args = args\n\n    def serialize(self):\n        return json.dumps({\n            \'class\': self.__class__.__name__,\n            \'args\': self.args,\n        })\n\n    def __repr__(self):\n        name = self.__class__.__name__\n        args_str = \', \'.join(str(x) for x in self.args)\n        return f\'{name}({args_str})\'\n\n\nregistry = {}\n\n\ndef register_class(target_class):\n    registry[target_class.__name__] = target_class\n\n\ndef deserialize(data):\n    params = json.loads(data)\n    name = params[\'class\']\n    target_class = registry[name]\n    return target_class(*params[\'args\'])\n\n\nclass EvenBetterPoint2D(BetterSerializable):\n    def __init__(self, x, y):\n        super().__init__(x, y)\n        self.x = x\n        self.y = y\n\n\nregister_class(EvenBetterPoint2D)\n\n\nbefore = EvenBetterPoint2D(5, 3)\nprint(\'Before:    \', before)\ndata = before.serialize()\nprint(\'Serialized:\', data)\nafter = deserialize(data)\nprint(\'After:     \', after)\n\n>>>\nBefore:     EvenBetterPoint2D(5, 3)\nSerialized: {&quot;class&quot;: &quot;EvenBetterPoint2D&quot;, &quot;args&quot;: [5, 3]}\nAfter:      EvenBetterPoint2D(5, 3)`, `68768386335935560000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> json\n\n\n<span class="token keyword">class</span> <span class="token class-name">BetterSerializable</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>args <span class="token operator">=</span> args\n\n    <span class="token keyword">def</span> <span class="token function">serialize</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span>\n            <span class="token string">\'class\'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__<span class="token punctuation">,</span>\n            <span class="token string">\'args\'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>args<span class="token punctuation">,</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        name <span class="token operator">=</span> self<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__\n        args_str <span class="token operator">=</span> <span class="token string">\', \'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> self<span class="token punctuation">.</span>args<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token punctuation">{</span>args_str<span class="token punctuation">}</span></span><span class="token string">)\'</span></span>\n\n\nregistry <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n\n<span class="token keyword">def</span> <span class="token function">register_class</span><span class="token punctuation">(</span>target_class<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    registry<span class="token punctuation">[</span>target_class<span class="token punctuation">.</span>__name__<span class="token punctuation">]</span> <span class="token operator">=</span> target_class\n\n\n<span class="token keyword">def</span> <span class="token function">deserialize</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    params <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">)</span>\n    name <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token string">\'class\'</span><span class="token punctuation">]</span>\n    target_class <span class="token operator">=</span> registry<span class="token punctuation">[</span>name<span class="token punctuation">]</span>\n    <span class="token keyword">return</span> target_class<span class="token punctuation">(</span><span class="token operator">*</span>params<span class="token punctuation">[</span><span class="token string">\'args\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">EvenBetterPoint2D</span><span class="token punctuation">(</span>BetterSerializable<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>x <span class="token operator">=</span> x\n        self<span class="token punctuation">.</span>y <span class="token operator">=</span> y\n\n\nregister_class<span class="token punctuation">(</span>EvenBetterPoint2D<span class="token punctuation">)</span>\n\n\nbefore <span class="token operator">=</span> EvenBetterPoint2D<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Before:    \'</span><span class="token punctuation">,</span> before<span class="token punctuation">)</span>\ndata <span class="token operator">=</span> before<span class="token punctuation">.</span>serialize<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Serialized:\'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>\nafter <span class="token operator">=</span> deserialize<span class="token punctuation">(</span>data<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After:     \'</span><span class="token punctuation">,</span> after<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore<span class="token punctuation">:</span>     EvenBetterPoint2D<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>\nSerialized<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"class"</span><span class="token punctuation">:</span> <span class="token string">"EvenBetterPoint2D"</span><span class="token punctuation">,</span> <span class="token string">"args"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">}</span>\nAfter<span class="token punctuation">:</span>      EvenBetterPoint2D<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当然这个方案也有不好的地方，那就是开发者可能会忘记调用 <code class="language-text">register_class</code>。</p>\n<p>如果没有注册就想还原数据，那么程序会在通过 deserialize 函数反序列化这份数据时出错。</p>\n<p>可以看到，尽管 Point3D 已经继承了 BetterSerializable，但这只能让它享有序列化的功能，至于反序列化，则必须得在定义完 class 语句体之后，手工调用 <code class="language-text">register_class</code> 函数进行注册后才能享有。所以，这个方案很容易出错，编程新手用起来尤其困难。类修饰器（class decorator）也会有这种问题（适用场合参见第 51 条）。</p>\n<p>那么，怎样才能让子类只需继承 BetterSerializable，就能同时获得序列化与反序列化功能，而不用专门手动通过 <code class="language-text">register_class</code> 注册呢？这可以利用元类实现，也就是让元类把子类的 class 定义拦截下来，然后自动调用 <code class="language-text">register_class</code> 去注册（参见第 48 条）。下面，我们就写这样一个元类，让它在得知开发者定义了 RegisteredSerializable 的某个子类之后，立刻通过 <code class="language-text">register_class</code> 注册。</p>\n<p>用户只要把 RegisteredSerializable 的子类定义完，就可以确信程序已经通过 <code class="language-text">register_class</code> 将这个子类注册过了，所以它肯定支持反序列化。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21477518295700260000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import json\n\n\nclass BetterSerializable:\n    def __init__(self, *args):\n        self.args = args\n\n    def serialize(self):\n        return json.dumps({\n            \'class\': self.__class__.__name__,\n            \'args\': self.args,\n        })\n\n    def __repr__(self):\n        name = self.__class__.__name__\n        args_str = \', \'.join(str(x) for x in self.args)\n        return f\'{name}({args_str})\'\n\n\nregistry = {}\n\n\ndef register_class(target_class):\n    registry[target_class.__name__] = target_class\n\n\ndef deserialize(data):\n    params = json.loads(data)\n    name = params[\'class\']\n    target_class = registry[name]\n    return target_class(*params[\'args\'])\n\n\nclass Meta(type):\n    def __new__(meta, name, bases, class_dict):\n        cls = type.__new__(meta, name, bases, class_dict)\n        register_class(cls)\n        return cls\n\n\nclass RegisteredSerializable(BetterSerializable,\n                             metaclass=Meta):\n    pass\n\n\nclass Vector3D(RegisteredSerializable):\n    def __init__(self, x, y, z):\n        super().__init__(x, y, z)\n        self.x, self.y, self.z = x, y, z\n\n\nbefore = Vector3D(10, -7, 3)\nprint(\'Before:    \', before)\ndata = before.serialize()\nprint(\'Serialized:\', data)\nprint(\'After:     \', deserialize(data))\n\n>>>\nBefore:     Vector3D(10, -7, 3)\nSerialized: {&quot;class&quot;: &quot;Vector3D&quot;, &quot;args&quot;: [10, -7, 3]}\nAfter:      Vector3D(10, -7, 3)`, `21477518295700260000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> json\n\n\n<span class="token keyword">class</span> <span class="token class-name">BetterSerializable</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>args <span class="token operator">=</span> args\n\n    <span class="token keyword">def</span> <span class="token function">serialize</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span>\n            <span class="token string">\'class\'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__<span class="token punctuation">,</span>\n            <span class="token string">\'args\'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>args<span class="token punctuation">,</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        name <span class="token operator">=</span> self<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__\n        args_str <span class="token operator">=</span> <span class="token string">\', \'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> self<span class="token punctuation">.</span>args<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token punctuation">{</span>args_str<span class="token punctuation">}</span></span><span class="token string">)\'</span></span>\n\n\nregistry <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n\n<span class="token keyword">def</span> <span class="token function">register_class</span><span class="token punctuation">(</span>target_class<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    registry<span class="token punctuation">[</span>target_class<span class="token punctuation">.</span>__name__<span class="token punctuation">]</span> <span class="token operator">=</span> target_class\n\n\n<span class="token keyword">def</span> <span class="token function">deserialize</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    params <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">)</span>\n    name <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token string">\'class\'</span><span class="token punctuation">]</span>\n    target_class <span class="token operator">=</span> registry<span class="token punctuation">[</span>name<span class="token punctuation">]</span>\n    <span class="token keyword">return</span> target_class<span class="token punctuation">(</span><span class="token operator">*</span>params<span class="token punctuation">[</span><span class="token string">\'args\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        cls <span class="token operator">=</span> <span class="token builtin">type</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span>\n        register_class<span class="token punctuation">(</span>cls<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> cls\n\n\n<span class="token keyword">class</span> <span class="token class-name">RegisteredSerializable</span><span class="token punctuation">(</span>BetterSerializable<span class="token punctuation">,</span>\n                             metaclass<span class="token operator">=</span>Meta<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Vector3D</span><span class="token punctuation">(</span>RegisteredSerializable<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>x<span class="token punctuation">,</span> self<span class="token punctuation">.</span>y<span class="token punctuation">,</span> self<span class="token punctuation">.</span>z <span class="token operator">=</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z\n\n\nbefore <span class="token operator">=</span> Vector3D<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Before:    \'</span><span class="token punctuation">,</span> before<span class="token punctuation">)</span>\ndata <span class="token operator">=</span> before<span class="token punctuation">.</span>serialize<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Serialized:\'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After:     \'</span><span class="token punctuation">,</span> deserialize<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore<span class="token punctuation">:</span>     Vector3D<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>\nSerialized<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"class"</span><span class="token punctuation">:</span> <span class="token string">"Vector3D"</span><span class="token punctuation">,</span> <span class="token string">"args"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">}</span>\nAfter<span class="token punctuation">:</span>      Vector3D<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>还有一种办法比上面的实现方式更简单，那就是通过名为 <code class="language-text">__init_subclass__</code> 的特殊类方法来实现。这是 Python 3.6 引入的新写法，我们只需要编很少的代码，就可以把自己的逻辑运用到子类上面。有些编程新手可能不太熟悉元类那种比较复杂的写法，但如果改用下面这种方案，他们应该很容易就能看懂。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74668005620883490000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import json\n\n\nclass BetterSerializable:\n    def __init__(self, *args):\n        self.args = args\n\n    def serialize(self):\n        return json.dumps({\n            \'class\': self.__class__.__name__,\n            \'args\': self.args,\n        })\n\n    def __repr__(self):\n        name = self.__class__.__name__\n        args_str = \', \'.join(str(x) for x in self.args)\n        return f\'{name}({args_str})\'\n\n\nregistry = {}\n\n\ndef register_class(target_class):\n    registry[target_class.__name__] = target_class\n\n\ndef deserialize(data):\n    params = json.loads(data)\n    name = params[\'class\']\n    target_class = registry[name]\n    return target_class(*params[\'args\'])\n\n\nclass BetterRegisteredSerializable(BetterSerializable):\n    def __init_subclass__(cls):\n        super().__init_subclass__()\n        register_class(cls)\n\n\nclass Vector1D(BetterRegisteredSerializable):\n    def __init__(self, magnitude):\n        super().__init__(magnitude)\n        self.magnitude = magnitude\n\n\nbefore = Vector1D(6)\nprint(\'Before:    \', before)\ndata = before.serialize()\nprint(\'Serialized:\', data)\nprint(\'After:     \', deserialize(data))\n\n>>>\nBefore:     Vector1D(6)\nSerialized: {&quot;class&quot;: &quot;Vector1D&quot;, &quot;args&quot;: [6]}\nAfter:      Vector1D(6)`, `74668005620883490000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> json\n\n\n<span class="token keyword">class</span> <span class="token class-name">BetterSerializable</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>args <span class="token operator">=</span> args\n\n    <span class="token keyword">def</span> <span class="token function">serialize</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span>\n            <span class="token string">\'class\'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__<span class="token punctuation">,</span>\n            <span class="token string">\'args\'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>args<span class="token punctuation">,</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        name <span class="token operator">=</span> self<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__\n        args_str <span class="token operator">=</span> <span class="token string">\', \'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> self<span class="token punctuation">.</span>args<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token punctuation">{</span>args_str<span class="token punctuation">}</span></span><span class="token string">)\'</span></span>\n\n\nregistry <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n\n<span class="token keyword">def</span> <span class="token function">register_class</span><span class="token punctuation">(</span>target_class<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    registry<span class="token punctuation">[</span>target_class<span class="token punctuation">.</span>__name__<span class="token punctuation">]</span> <span class="token operator">=</span> target_class\n\n\n<span class="token keyword">def</span> <span class="token function">deserialize</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    params <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">)</span>\n    name <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token string">\'class\'</span><span class="token punctuation">]</span>\n    target_class <span class="token operator">=</span> registry<span class="token punctuation">[</span>name<span class="token punctuation">]</span>\n    <span class="token keyword">return</span> target_class<span class="token punctuation">(</span><span class="token operator">*</span>params<span class="token punctuation">[</span><span class="token string">\'args\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">BetterRegisteredSerializable</span><span class="token punctuation">(</span>BetterSerializable<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init_subclass__</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init_subclass__<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        register_class<span class="token punctuation">(</span>cls<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Vector1D</span><span class="token punctuation">(</span>BetterRegisteredSerializable<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> magnitude<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>magnitude<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>magnitude <span class="token operator">=</span> magnitude\n\n\nbefore <span class="token operator">=</span> Vector1D<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Before:    \'</span><span class="token punctuation">,</span> before<span class="token punctuation">)</span>\ndata <span class="token operator">=</span> before<span class="token punctuation">.</span>serialize<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Serialized:\'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After:     \'</span><span class="token punctuation">,</span> deserialize<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore<span class="token punctuation">:</span>     Vector1D<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>\nSerialized<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"class"</span><span class="token punctuation">:</span> <span class="token string">"Vector1D"</span><span class="token punctuation">,</span> <span class="token string">"args"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">}</span>\nAfter<span class="token punctuation">:</span>      Vector1D<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在类体系正确无误的前提下，通过 <code class="language-text">__init_subclass__</code>（或元类）自动注册子类可以避免程序由于用户忘记注册而引发问题。这不仅适用于上述序列化与反序列化功能的实现，而且还可以用在数据库的对象关系映射（object-relational mapping，ORM）、可扩展的插件系统以及回调挂钩上面。</p>\n<h3 id="总结-45"><a href="#%E6%80%BB%E7%BB%93-45" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>类注册（Class registration）是个相当有用的模式，可以用来构建模块式的 Python 程序。</li>\n<li>我们可以通过基类的元类把用户从这个基类派生出来的子类自动注册给系统。</li>\n<li>利用元类实现类注册可以防止由于用户忘记注册而导致程序出现问题。</li>\n<li>优先考虑通过 <code class="language-text">__init_subclass__</code> 实现自动注册，而不要用标准的元类机制来实现，因为 <code class="language-text">__init_subclass__</code> 更清晰，更便于初学者理解。</li>\n</ol>\n<h2 id="第-50-条：用-__set_name__-给类属性加注解"><a href="#%E7%AC%AC-50-%E6%9D%A1%EF%BC%9A%E7%94%A8-__set_name__-%E7%BB%99%E7%B1%BB%E5%B1%9E%E6%80%A7%E5%8A%A0%E6%B3%A8%E8%A7%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 50 条：用 <code class="language-text">__set_name__</code> 给类属性加注解</h2>\n<p>元类还有一个更有用的功能，那就是可以在某个类真正投入使用之前，率先修改或注解这个类所定义的属性。这通常需要与描述符（descriptor）搭配使用（参见第 46 条），这样可以让我们更详细地了解这些属性在定义它们的那个类里是如何使用的。</p>\n<p>例如，我们要定义一个新的类，来表示客户数据库中的每一行数据。这个类需要定义一些属性，与数据表中的各列相对应，每个属性都分别表示这行数据在这一列的取值。下面用描述符类来实现这些属性，把它们和数据表中同名的列联系起来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81597927919148600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Field:\n    def __init__(self, name):\n        self.name = name\n        self.internal_name = \'_\' + self.name\n\n    def __get__(self, instance, instance_type):\n        if instance is None:\n            return self\n        return getattr(instance, self.internal_name, \'\')\n\n    def __set__(self, instance, value):\n        setattr(instance, self.internal_name, value)`, `81597927919148600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Field</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name\n        self<span class="token punctuation">.</span>internal_name <span class="token operator">=</span> <span class="token string">\'_\'</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>name\n\n    <span class="token keyword">def</span> <span class="token function">__get__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> instance_type<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> instance <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self\n        <span class="token keyword">return</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> self<span class="token punctuation">.</span>internal_name<span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__set__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">setattr</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> self<span class="token punctuation">.</span>internal_name<span class="token punctuation">,</span> value<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Field 描述符的 name 属性指的就是数据表中那一列的列名，所以，我们可以通过内置的 setattr 函数把每行数据在这个属性上面的取值保存到那行数据自己的状态字典里面去，只不过属性名应该稍加调整，我们给它前面加个下划线表示它是受到保护的属性。另外，我们通过 getattr 函数实现属性加载功能。这种写法，看上去似乎要比把每个实例在这项属性上面的取值都保存到 weakref 字典里面更简单（那种字典是 weakref 模块所提供的特殊字典，用以防止内存泄漏）。</p>\n<p>下面定义 Customer 类，每个 Customer 都表示数据表中的一行数据，其中的四个属性分别对应于这行数据在那四列上面的取值。</p>\n<p>这个类用起来很简单。可以看到，早前定义的 Field 描述符能够正确地修改 cust 实例中的 <code class="language-text">__dict__</code> 字典。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34169307511559820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Field:\n    def __init__(self, name):\n        self.name = name\n        self.internal_name = \'_\' + self.name\n\n    def __get__(self, instance, instance_type):\n        if instance is None:\n            return self\n        return getattr(instance, self.internal_name, \'\')\n\n    def __set__(self, instance, value):\n        setattr(instance, self.internal_name, value)\n\n\nclass Customer:\n    # Class attributes\n    first_name = Field(\'first_name\')\n    last_name = Field(\'last_name\')\n    prefix = Field(\'prefix\')\n    suffix = Field(\'suffix\')\n\n\ncust = Customer()\nprint(f\'Before: {cust.first_name!r} {cust.__dict__}\')\ncust.first_name = \'Euclid\'\nprint(f\'After:  {cust.first_name!r} {cust.__dict__}\')\n\n>>>\nBefore: \'\' {}\nAfter:  \'Euclid\' {\'_first_name\': \'Euclid\'}`, `34169307511559820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Field</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name\n        self<span class="token punctuation">.</span>internal_name <span class="token operator">=</span> <span class="token string">\'_\'</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>name\n\n    <span class="token keyword">def</span> <span class="token function">__get__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> instance_type<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> instance <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self\n        <span class="token keyword">return</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> self<span class="token punctuation">.</span>internal_name<span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__set__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">setattr</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> self<span class="token punctuation">.</span>internal_name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Customer</span><span class="token punctuation">:</span>\n    <span class="token comment"># Class attributes</span>\n    first_name <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token string">\'first_name\'</span><span class="token punctuation">)</span>\n    last_name <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token string">\'last_name\'</span><span class="token punctuation">)</span>\n    prefix <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token string">\'prefix\'</span><span class="token punctuation">)</span>\n    suffix <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token string">\'suffix\'</span><span class="token punctuation">)</span>\n\n\ncust <span class="token operator">=</span> Customer<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Before: </span><span class="token interpolation"><span class="token punctuation">{</span>cust<span class="token punctuation">.</span>first_name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>cust<span class="token punctuation">.</span>__dict__<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\ncust<span class="token punctuation">.</span>first_name <span class="token operator">=</span> <span class="token string">\'Euclid\'</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'After:  </span><span class="token interpolation"><span class="token punctuation">{</span>cust<span class="token punctuation">.</span>first_name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>cust<span class="token punctuation">.</span>__dict__<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore<span class="token punctuation">:</span> <span class="token string">\'\'</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\nAfter<span class="token punctuation">:</span>  <span class="token string">\'Euclid\'</span> <span class="token punctuation">{</span><span class="token string">\'_first_name\'</span><span class="token punctuation">:</span> <span class="token string">\'Euclid\'</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写虽然没错，但是类的定义似乎有点重复。在给 Customer 类定义字段时，既然等号左边已经写出了字段的名称（例如 <code class="language-text">first_name</code>），那为什么等号右边的 Field 构造函数里，还要再写一次呢？</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27840110783477613000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Customer:\n    # Left side is redundant with right side\n    first_name = Field(\'first_name\')\n    ...`, `27840110783477613000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Customer</span><span class="token punctuation">:</span>\n    <span class="token comment"># Left side is redundant with right side</span>\n    first_name <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token string">\'first_name\'</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这是因为，Customer 类在定义字段时，要按照从右到左的顺序解读，而不是像阅读代码时那样，从左到右阅读。所以，程序必须首先处理等号右边的部分，也就是 <code class="language-text">Field(&#39;first_name&#39;)</code>，然后才能把这个 Field 构造函数所返回的值赋给左边的 <code class="language-text">first_name</code>。等号右边的 Field 实例没办法提前知道，它将被赋给类的哪一个属性。</p>\n<p>这样的重复代码，可以利用元类来消除。元类可以当作 class 语句的挂钩，只要 class 语句体定义完毕，元类就会看到它的写法并尽快做出应对（具体原理参见第 48 条）。在本例中，我们可以让元类自动给每个 Field 描述符的 name 与 <code class="language-text">internal_name</code> 赋值，而不用再像原来那样，需要开发者把字段名称重复书写一遍并手动传给 Field 的构造函数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63152860018093420000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Meta(type):\n    def __new__(meta, name, bases, class_dict):\n        for key, value in class_dict.items():\n            if isinstance(value, Field):\n                value.name = key\n                value.internal_name = \'_\' + key\n        cls = type.__new__(meta, name, bases, class_dict)\n        return cls`, `63152860018093420000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> class_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> Field<span class="token punctuation">)</span><span class="token punctuation">:</span>\n                value<span class="token punctuation">.</span>name <span class="token operator">=</span> key\n                value<span class="token punctuation">.</span>internal_name <span class="token operator">=</span> <span class="token string">\'_\'</span> <span class="token operator">+</span> key\n        cls <span class="token operator">=</span> <span class="token builtin">type</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> cls</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>下面定义一个基类，让该基类把刚才定义好的 Meta 当成元类。凡是表示数据库某行的类都继承自该基类，以确保它们可以利用元类所提供的功能。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="957890289101182000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class DatabaseRow(metaclass=Meta):\n    pass`, `957890289101182000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">DatabaseRow</span><span class="token punctuation">(</span>metaclass<span class="token operator">=</span>Meta<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>为了跟元类配合，Field 描述符需要稍加调整。它的大部分代码都可以沿用，只是现在已经不用再要求调用者把名称传给构造函数了，因为这次元类的 <code class="language-text">__new__</code> 方法会自动设置名称。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8605591318870975000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Field:\n    def __init__(self):\n        # These will be assigned by the metaclass.\n        self.name = None\n        self.internal_name = None\n\n    def __get__(self, instance, instance_type):\n        if instance is None:\n            return self\n\n        return getattr(instance, self.internal_name, \'\')\n\n    def __set__(self, instance, value):\n        setattr(instance, self.internal_name, value)`, `8605591318870975000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Field</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token comment"># These will be assigned by the metaclass.</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token boolean">None</span>\n        self<span class="token punctuation">.</span>internal_name <span class="token operator">=</span> <span class="token boolean">None</span>\n\n    <span class="token keyword">def</span> <span class="token function">__get__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> instance_type<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> instance <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self\n\n        <span class="token keyword">return</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> self<span class="token punctuation">.</span>internal_name<span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__set__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">setattr</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> self<span class="token punctuation">.</span>internal_name<span class="token punctuation">,</span> value<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>有了元类、DatabaseRow 基类以及修改过的 Field 描述符，我们在给客户类定义字段时，就不用手工传入字段名了，代码也不像之前那样冗余了。</p>\n<p>这个新类的效果与早前那个类一样。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9804034243897174000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Field:\n    def __init__(self):\n        # These will be assigned by the metaclass.\n        self.name = None\n        self.internal_name = None\n\n    def __get__(self, instance, instance_type):\n        if instance is None:\n            return self\n        return getattr(instance, self.internal_name, \'\')\n\n    def __set__(self, instance, value):\n        setattr(instance, self.internal_name, value)\n\n\nclass Meta(type):\n    def __new__(meta, name, bases, class_dict):\n        for key, value in class_dict.items():\n            if isinstance(value, Field):\n                value.name = key\n                value.internal_name = \'_\' + key\n        cls = type.__new__(meta, name, bases, class_dict)\n        return cls\n\n\nclass DatabaseRow(metaclass=Meta):\n    pass\n\n\nclass BetterCustomer(DatabaseRow):\n    # Class attributes\n    first_name = Field()\n    last_name = Field()\n    prefix = Field()\n    suffix = Field()\n\n\ncust = BetterCustomer()\nprint(f\'Before: {cust.first_name!r} {cust.__dict__}\')\ncust.first_name = \'Euler\'\nprint(f\'After : {cust.first_name!r} {cust.__dict__}\')\n\n>>>\nBefore: \'\' {}\nAfter : \'Euler\' {\'_first_name\': \'Euler\'}`, `9804034243897174000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Field</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token comment"># These will be assigned by the metaclass.</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token boolean">None</span>\n        self<span class="token punctuation">.</span>internal_name <span class="token operator">=</span> <span class="token boolean">None</span>\n\n    <span class="token keyword">def</span> <span class="token function">__get__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> instance_type<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> instance <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self\n        <span class="token keyword">return</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> self<span class="token punctuation">.</span>internal_name<span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__set__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">setattr</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> self<span class="token punctuation">.</span>internal_name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> class_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> Field<span class="token punctuation">)</span><span class="token punctuation">:</span>\n                value<span class="token punctuation">.</span>name <span class="token operator">=</span> key\n                value<span class="token punctuation">.</span>internal_name <span class="token operator">=</span> <span class="token string">\'_\'</span> <span class="token operator">+</span> key\n        cls <span class="token operator">=</span> <span class="token builtin">type</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> cls\n\n\n<span class="token keyword">class</span> <span class="token class-name">DatabaseRow</span><span class="token punctuation">(</span>metaclass<span class="token operator">=</span>Meta<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">BetterCustomer</span><span class="token punctuation">(</span>DatabaseRow<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token comment"># Class attributes</span>\n    first_name <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    last_name <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    prefix <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    suffix <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n\ncust <span class="token operator">=</span> BetterCustomer<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Before: </span><span class="token interpolation"><span class="token punctuation">{</span>cust<span class="token punctuation">.</span>first_name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>cust<span class="token punctuation">.</span>__dict__<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\ncust<span class="token punctuation">.</span>first_name <span class="token operator">=</span> <span class="token string">\'Euler\'</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'After : </span><span class="token interpolation"><span class="token punctuation">{</span>cust<span class="token punctuation">.</span>first_name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>cust<span class="token punctuation">.</span>__dict__<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore<span class="token punctuation">:</span> <span class="token string">\'\'</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\nAfter <span class="token punctuation">:</span> <span class="token string">\'Euler\'</span> <span class="token punctuation">{</span><span class="token string">\'_first_name\'</span><span class="token punctuation">:</span> <span class="token string">\'Euler\'</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个办法的缺点是，要想在类中声明 Field 字段，这个类必须从 DatabaseRow 继承。假如忘了继承，或者所面对的类体系在结构上不方便这样继承，那么代码就无法正常运行。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60309595960610830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class BrokenCustomer:\n    first_name = Field()\n    last_name = Field()\n    prefix = Field()\n    suffix = Field()\n\n\ncust = BrokenCustomer()\ncust.first_name = \'Mersenne\'\n\n>>>\nTraceback ...\nTypeError: attribute name must be string, not \'NoneType\'`, `60309595960610830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">BrokenCustomer</span><span class="token punctuation">:</span>\n    first_name <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    last_name <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    prefix <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    suffix <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n\ncust <span class="token operator">=</span> BrokenCustomer<span class="token punctuation">(</span><span class="token punctuation">)</span>\ncust<span class="token punctuation">.</span>first_name <span class="token operator">=</span> <span class="token string">\'Mersenne\'</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> attribute name must be string<span class="token punctuation">,</span> <span class="token keyword">not</span> <span class="token string">\'NoneType\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个问题可以通过给描述符定义 <code class="language-text">__set_name__</code> 特殊方法来解决。这是 Python 3.6 引入的新功能：如果某个类用这种描述符的实例来定义字段，那么系统就会在描述符上面触发这个特殊方法。系统会把采用这个描述符实例作字段的那个类以及字段的名称，当成参数传给 <code class="language-text">__set_name__</code>。下面我们将 <code class="language-text">Meta.__new__</code> 之中的逻辑移动到 Field 描述符的 <code class="language-text">__set_name__</code> 里面，这样一来，就不用定义元类了。</p>\n<p>现在，我们可以直接在类里通过 Field 描述符来定义字段，而不用再让这个类继承某个基类，还能把元类给省掉。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66193174299055825000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Field:\n    def __init__(self):\n        self.name = None\n        self.internal_name = None\n\n    def __set_name__(self, owner, name):\n        # Called on class creation for each descriptor\n        self.name = name\n        self.internal_name = \'_\' + name\n\n    def __get__(self, instance, instance_type):\n        if instance is None:\n            return self\n        return getattr(instance, self.internal_name, \'\')\n\n    def __set__(self, instance, value):\n        setattr(instance, self.internal_name, value)\n\n\nclass FixedCustomer:\n    first_name = Field()\n    last_name = Field()\n    prefix = Field()\n    suffix = Field()\n\n\ncust = FixedCustomer()\nprint(f\'Before: {cust.first_name!r} {cust.__dict__}\')\ncust.first_name = \'Mersenne\'\nprint(f\'After : {cust.first_name!r} {cust.__dict__}\')\n\n>>>\nBefore: \'\' {}\nAfter : \'Mersenne\' {\'_first_name\': \'Mersenne\'}`, `66193174299055825000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Field</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token boolean">None</span>\n        self<span class="token punctuation">.</span>internal_name <span class="token operator">=</span> <span class="token boolean">None</span>\n\n    <span class="token keyword">def</span> <span class="token function">__set_name__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> owner<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token comment"># Called on class creation for each descriptor</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name\n        self<span class="token punctuation">.</span>internal_name <span class="token operator">=</span> <span class="token string">\'_\'</span> <span class="token operator">+</span> name\n\n    <span class="token keyword">def</span> <span class="token function">__get__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> instance_type<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> instance <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self\n        <span class="token keyword">return</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> self<span class="token punctuation">.</span>internal_name<span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__set__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">setattr</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> self<span class="token punctuation">.</span>internal_name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">FixedCustomer</span><span class="token punctuation">:</span>\n    first_name <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    last_name <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    prefix <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    suffix <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n\ncust <span class="token operator">=</span> FixedCustomer<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Before: </span><span class="token interpolation"><span class="token punctuation">{</span>cust<span class="token punctuation">.</span>first_name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>cust<span class="token punctuation">.</span>__dict__<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\ncust<span class="token punctuation">.</span>first_name <span class="token operator">=</span> <span class="token string">\'Mersenne\'</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'After : </span><span class="token interpolation"><span class="token punctuation">{</span>cust<span class="token punctuation">.</span>first_name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>cust<span class="token punctuation">.</span>__dict__<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore<span class="token punctuation">:</span> <span class="token string">\'\'</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\nAfter <span class="token punctuation">:</span> <span class="token string">\'Mersenne\'</span> <span class="token punctuation">{</span><span class="token string">\'_first_name\'</span><span class="token punctuation">:</span> <span class="token string">\'Mersenne\'</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="总结-46"><a href="#%E6%80%BB%E7%BB%93-46" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>我们可以通过元类把利用这个元类所定义的其他类拦截下来，从而在程序开始使用那些类之前，先对其中定义的属性做出修改。</li>\n<li>描述符与元类搭配起来，可以形成一套强大的机制，让我们既能采用声明式的写法来定义行为，又能在程序运行时检视这个行为的具体执行情况。</li>\n<li>你可以给描述符定义 <code class="language-text">__set_name__</code> 方法，让系统把使用这个描述符做属性的那个类以及它在类里的属性名通过方法的参数告诉你。</li>\n<li>用描述符直接操纵每个实例的属性字典，要比把所有实例的属性都放到一份字典里更好，因为后者要求我们必须使用 weakref 内置模块之中的特殊字典来记录每个实例的属性值以防止内存泄漏。</li>\n</ol>\n<h2 id="第-51-条：优先考虑通过类修饰器来提供可组合的扩充功能，不要使用元类"><a href="#%E7%AC%AC-51-%E6%9D%A1%EF%BC%9A%E4%BC%98%E5%85%88%E8%80%83%E8%99%91%E9%80%9A%E8%BF%87%E7%B1%BB%E4%BF%AE%E9%A5%B0%E5%99%A8%E6%9D%A5%E6%8F%90%E4%BE%9B%E5%8F%AF%E7%BB%84%E5%90%88%E7%9A%84%E6%89%A9%E5%85%85%E5%8A%9F%E8%83%BD%EF%BC%8C%E4%B8%8D%E8%A6%81%E4%BD%BF%E7%94%A8%E5%85%83%E7%B1%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 51 条：优先考虑通过类修饰器来提供可组合的扩充功能，不要使用元类</h2>\n<p>尽管元类（参见第 48 条与第 49 条）允许我们用各种方式来定制其他类的创建逻辑，但有些情况它未必能够处理得很好。</p>\n<p>例如，要写一个辅助函数来修饰类中的每个方法，把这些方法在执行时所用的参数、所返回的值以及所抛出的异常都打印出来，以便调试。这样的辅助函数可以定义成修饰器（参见第 26 条）。</p>\n<p>如果我们从标准的 dict 里面派生了下面这个子类（参见第 43 条），那就可以把刚才的 <code class="language-text">trace_func</code> 修饰器运用到这个子类所提供的那几个特殊方法上面。</p>\n<p>下面，通过 TraceDict 类的实例来验证刚才写的那几个特殊方法确实受到了修饰。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97124420500293040000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from functools import wraps\n\n\ndef trace_func(func):\n    if hasattr(func, \'tracing\'):  # Only decorate once\n        return func\n\n    @wraps(func)\n    def wrapper(*args, **kwargs):\n        result = None\n        try:\n            result = func(*args, **kwargs)\n            return result\n        except Exception as e:\n            result = e\n            raise\n        finally:\n            print(f\'{func.__name__}({args!r}, {kwargs!r}) -> \'\n                  f\'{result!r}\')\n\n    wrapper.tracing = True\n    return wrapper\n\n\nclass TraceDict(dict):\n    @trace_func\n    def __init__(self, *args, **kwargs):\n        super().__init__(*args, **kwargs)\n\n    @trace_func\n    def __setitem__(self, *args, **kwargs):\n        return super().__setitem__(*args, **kwargs)\n\n    @trace_func\n    def __getitem__(self, *args, **kwargs):\n        return super().__getitem__(*args, **kwargs)\n\n\ntrace_dict = TraceDict([(\'hi\', 1)])\ntrace_dict[\'there\'] = 2\ntrace_dict[\'hi\']\ntry:\n    trace_dict[\'does not exist\']\nexcept KeyError:\n    pass  # Expected\n\n>>>\n__init__(({\'hi\': 1}, [(\'hi\', 1)]), {}) -> None\n__setitem__(({\'hi\': 1, \'there\': 2}, \'there\', 2), {}) -> None\n__getitem__(({\'hi\': 1, \'there\': 2}, \'hi\'), {}) -> 1\n__getitem__(({\'hi\': 1, \'there\': 2}, \'does not exist\'), {}) -> KeyError(\'does not exist\')`, `97124420500293040000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> functools <span class="token keyword">import</span> wraps\n\n\n<span class="token keyword">def</span> <span class="token function">trace_func</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> <span class="token string">\'tracing\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># Only decorate once</span>\n        <span class="token keyword">return</span> func\n\n    @wraps<span class="token punctuation">(</span>func<span class="token punctuation">)</span>\n    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        result <span class="token operator">=</span> <span class="token boolean">None</span>\n        <span class="token keyword">try</span><span class="token punctuation">:</span>\n            result <span class="token operator">=</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>\n            <span class="token keyword">return</span> result\n        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n            result <span class="token operator">=</span> e\n            <span class="token keyword">raise</span>\n        <span class="token keyword">finally</span><span class="token punctuation">:</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>func<span class="token punctuation">.</span>__name__<span class="token punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token punctuation">{</span>args<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{</span>kwargs<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">) -> \'</span></span>\n                  <span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n    wrapper<span class="token punctuation">.</span>tracing <span class="token operator">=</span> <span class="token boolean">True</span>\n    <span class="token keyword">return</span> wrapper\n\n\n<span class="token keyword">class</span> <span class="token class-name">TraceDict</span><span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    @trace_func\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>\n\n    @trace_func\n    <span class="token keyword">def</span> <span class="token function">__setitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__setitem__<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>\n\n    @trace_func\n    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__getitem__<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>\n\n\ntrace_dict <span class="token operator">=</span> TraceDict<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'hi\'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\ntrace_dict<span class="token punctuation">[</span><span class="token string">\'there\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span>\ntrace_dict<span class="token punctuation">[</span><span class="token string">\'hi\'</span><span class="token punctuation">]</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    trace_dict<span class="token punctuation">[</span><span class="token string">\'does not exist\'</span><span class="token punctuation">]</span>\n<span class="token keyword">except</span> KeyError<span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>  <span class="token comment"># Expected</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n__init__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'hi\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'hi\'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span>\n__setitem__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'hi\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'there\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'there\'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span>\n__getitem__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'hi\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'there\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'hi\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token number">1</span>\n__getitem__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'hi\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'there\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'does not exist\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> KeyError<span class="token punctuation">(</span><span class="token string">\'does not exist\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写有个缺点，就是必须在子类之中把需要受 <code class="language-text">@trace_func</code> 修饰的方法全都重写一遍，即便子类只想沿用超类的实现方式，也还是得这样做才行。这导致子类里面出现大量的样板代码，让程序变得难以阅读，而且比较容易出错。另外，如果 dict 超类以后添加了新方法，那必须在 TraceDict 子类里面明确重写这个方法，否则它就不会为 <code class="language-text">@trace_func</code> 所修饰。</p>\n<p>要想解决这个问题，其中一个办法是通过元类自动修饰那个类的所有方法。例如，下面的就是这样一个元类，它可以拦截利用本类所写的新类型，并把那个类型里面的每个函数或方法都分别封装到 <code class="language-text">trace_func</code> 修饰器之中。</p>\n<p>现在，我们只需要让子类继承 dict，并把刚写的 TraceMeta 当作子类的 metaclass 就行了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74865397136818810000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import types\nfrom functools import wraps\n\n\ndef trace_func(func):\n    if hasattr(func, \'tracing\'):  # Only decorate once\n        return func\n\n    @wraps(func)\n    def wrapper(*args, **kwargs):\n        result = None\n        try:\n            result = func(*args, **kwargs)\n            return result\n        except Exception as e:\n            result = e\n            raise\n        finally:\n            print(f\'{func.__name__}({args!r}, {kwargs!r}) -> \'\n                  f\'{result!r}\')\n\n    wrapper.tracing = True\n    return wrapper\n\n\ntrace_types = (\n    types.MethodType,\n    types.FunctionType,\n    types.BuiltinFunctionType,\n    types.BuiltinMethodType,\n    types.MethodDescriptorType,\n    types.ClassMethodDescriptorType\n)\n\n\nclass TraceMeta(type):\n    def __new__(meta, name, bases, class_dict):\n        klass = super().__new__(meta, name, bases, class_dict)\n        for key in dir(klass):\n            value = getattr(klass, key)\n            if isinstance(value, trace_types):\n                wrapped = trace_func(value)\n                setattr(klass, key, wrapped)\n\n        return klass\n\n\nclass TraceDict(dict, metaclass=TraceMeta):\n    pass\n\n\ntrace_dict = TraceDict([(\'hi\', 1)])\ntrace_dict[\'there\'] = 2\ntrace_dict[\'hi\']\ntry:\n    trace_dict[\'does not exist\']\nexcept KeyError:\n    pass  # Expected\n\n>>>\n__new__((<class \'__main__.TraceDict\'>, [(\'hi\', 1)]), {}) -> {}\n__getitem__(({\'hi\': 1, \'there\': 2}, \'hi\'), {}) -> 1\n__getitem__(({\'hi\': 1, \'there\': 2}, \'does not exist\'), {}) -> KeyError(\'does not exist\')`, `74865397136818810000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> types\n<span class="token keyword">from</span> functools <span class="token keyword">import</span> wraps\n\n\n<span class="token keyword">def</span> <span class="token function">trace_func</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> <span class="token string">\'tracing\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># Only decorate once</span>\n        <span class="token keyword">return</span> func\n\n    @wraps<span class="token punctuation">(</span>func<span class="token punctuation">)</span>\n    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        result <span class="token operator">=</span> <span class="token boolean">None</span>\n        <span class="token keyword">try</span><span class="token punctuation">:</span>\n            result <span class="token operator">=</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>\n            <span class="token keyword">return</span> result\n        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n            result <span class="token operator">=</span> e\n            <span class="token keyword">raise</span>\n        <span class="token keyword">finally</span><span class="token punctuation">:</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>func<span class="token punctuation">.</span>__name__<span class="token punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token punctuation">{</span>args<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{</span>kwargs<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">) -> \'</span></span>\n                  <span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n    wrapper<span class="token punctuation">.</span>tracing <span class="token operator">=</span> <span class="token boolean">True</span>\n    <span class="token keyword">return</span> wrapper\n\n\ntrace_types <span class="token operator">=</span> <span class="token punctuation">(</span>\n    types<span class="token punctuation">.</span>MethodType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>FunctionType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>BuiltinFunctionType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>BuiltinMethodType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>MethodDescriptorType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>ClassMethodDescriptorType\n<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">TraceMeta</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        klass <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span>\n        <span class="token keyword">for</span> key <span class="token keyword">in</span> <span class="token builtin">dir</span><span class="token punctuation">(</span>klass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            value <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>klass<span class="token punctuation">,</span> key<span class="token punctuation">)</span>\n            <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> trace_types<span class="token punctuation">)</span><span class="token punctuation">:</span>\n                wrapped <span class="token operator">=</span> trace_func<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n                <span class="token builtin">setattr</span><span class="token punctuation">(</span>klass<span class="token punctuation">,</span> key<span class="token punctuation">,</span> wrapped<span class="token punctuation">)</span>\n\n        <span class="token keyword">return</span> klass\n\n\n<span class="token keyword">class</span> <span class="token class-name">TraceDict</span><span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">,</span> metaclass<span class="token operator">=</span>TraceMeta<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\ntrace_dict <span class="token operator">=</span> TraceDict<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'hi\'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\ntrace_dict<span class="token punctuation">[</span><span class="token string">\'there\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span>\ntrace_dict<span class="token punctuation">[</span><span class="token string">\'hi\'</span><span class="token punctuation">]</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    trace_dict<span class="token punctuation">[</span><span class="token string">\'does not exist\'</span><span class="token punctuation">]</span>\n<span class="token keyword">except</span> KeyError<span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>  <span class="token comment"># Expected</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n__new__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.TraceDict\'</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'hi\'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n__getitem__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'hi\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'there\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'hi\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token number">1</span>\n__getitem__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'hi\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'there\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'does not exist\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> KeyError<span class="token punctuation">(</span><span class="token string">\'does not exist\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种办法确实有效，而且还把前面的实现方案中忘记修饰的 <code class="language-text">__new__</code> 方法也自动修饰了。但如果子类所继承的那个超类本身已经指定了它自己的 metaclass，那会如何呢？</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82845454762545000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class OtherMeta(type):\n    pass\n\n\nclass SimpleDict(dict, metaclass=OtherMeta):\n    pass\n\n\nclass TraceDict(SimpleDict, metaclass=TraceMeta):\n    pass\n\n>>>\nTraceback ...\nTypeError: metaclass conflict: the metaclass of a derived class must be a (non-strict) subclass of the metaclasses of all its bases`, `82845454762545000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">OtherMeta</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">SimpleDict</span><span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">,</span> metaclass<span class="token operator">=</span>OtherMeta<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">TraceDict</span><span class="token punctuation">(</span>SimpleDict<span class="token punctuation">,</span> metaclass<span class="token operator">=</span>TraceMeta<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> metaclass conflict<span class="token punctuation">:</span> the metaclass of a derived <span class="token keyword">class</span> <span class="token class-name">must</span> be a <span class="token punctuation">(</span>non<span class="token operator">-</span>strict<span class="token punctuation">)</span> subclass of the metaclasses of <span class="token builtin">all</span> its bases</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这次程序无法运行，因为子类的 metaclass 是 TraceMeta，而超类的 metaclass 是 OtherMeta，但 TraceMeta 并不是从 OtherMeta 里面继承来的。从理论上讲，我们可以让 TraceMeta 继承 OtherMeta，从而解决这个问题。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25091816801614787000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import types\nfrom functools import wraps\n\n\ndef trace_func(func):\n    if hasattr(func, \'tracing\'):  # Only decorate once\n        return func\n\n    @wraps(func)\n    def wrapper(*args, **kwargs):\n        result = None\n        try:\n            result = func(*args, **kwargs)\n            return result\n        except Exception as e:\n            result = e\n            raise\n        finally:\n            print(f\'{func.__name__}({args!r}, {kwargs!r}) -> \'\n                  f\'{result!r}\')\n\n    wrapper.tracing = True\n    return wrapper\n\n\ntrace_types = (\n    types.MethodType,\n    types.FunctionType,\n    types.BuiltinFunctionType,\n    types.BuiltinMethodType,\n    types.MethodDescriptorType,\n    types.ClassMethodDescriptorType\n)\n\n\nclass OtherMeta(type):\n    pass\n\n\nclass TraceMeta(OtherMeta):\n    def __new__(meta, name, bases, class_dict):\n        klass = super().__new__(meta, name, bases, class_dict)\n        for key in dir(klass):\n            value = getattr(klass, key)\n            if isinstance(value, trace_types):\n                wrapped = trace_func(value)\n                setattr(klass, key, wrapped)\n\n        return klass\n\n\nclass SimpleDict(dict, metaclass=OtherMeta):\n    pass\n\n\nclass TraceDict(SimpleDict, metaclass=TraceMeta):\n    pass\n\n\ntrace_dict = TraceDict([(\'hi\', 1)])\ntrace_dict[\'there\'] = 2\ntrace_dict[\'hi\']\ntry:\n    trace_dict[\'does not exist\']\nexcept KeyError:\n    pass  # Expected\n\n>>>\n__new__((<class \'__main__.TraceDict\'>, [(\'hi\', 1)]), {}) -> {}\n__getitem__(({\'hi\': 1, \'there\': 2}, \'hi\'), {}) -> 1\n__getitem__(({\'hi\': 1, \'there\': 2}, \'does not exist\'), {}) -> KeyError(\'does not exist\')`, `25091816801614787000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> types\n<span class="token keyword">from</span> functools <span class="token keyword">import</span> wraps\n\n\n<span class="token keyword">def</span> <span class="token function">trace_func</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> <span class="token string">\'tracing\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># Only decorate once</span>\n        <span class="token keyword">return</span> func\n\n    @wraps<span class="token punctuation">(</span>func<span class="token punctuation">)</span>\n    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        result <span class="token operator">=</span> <span class="token boolean">None</span>\n        <span class="token keyword">try</span><span class="token punctuation">:</span>\n            result <span class="token operator">=</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>\n            <span class="token keyword">return</span> result\n        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n            result <span class="token operator">=</span> e\n            <span class="token keyword">raise</span>\n        <span class="token keyword">finally</span><span class="token punctuation">:</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>func<span class="token punctuation">.</span>__name__<span class="token punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token punctuation">{</span>args<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{</span>kwargs<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">) -> \'</span></span>\n                  <span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n    wrapper<span class="token punctuation">.</span>tracing <span class="token operator">=</span> <span class="token boolean">True</span>\n    <span class="token keyword">return</span> wrapper\n\n\ntrace_types <span class="token operator">=</span> <span class="token punctuation">(</span>\n    types<span class="token punctuation">.</span>MethodType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>FunctionType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>BuiltinFunctionType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>BuiltinMethodType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>MethodDescriptorType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>ClassMethodDescriptorType\n<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">OtherMeta</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">TraceMeta</span><span class="token punctuation">(</span>OtherMeta<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        klass <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span>\n        <span class="token keyword">for</span> key <span class="token keyword">in</span> <span class="token builtin">dir</span><span class="token punctuation">(</span>klass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            value <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>klass<span class="token punctuation">,</span> key<span class="token punctuation">)</span>\n            <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> trace_types<span class="token punctuation">)</span><span class="token punctuation">:</span>\n                wrapped <span class="token operator">=</span> trace_func<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n                <span class="token builtin">setattr</span><span class="token punctuation">(</span>klass<span class="token punctuation">,</span> key<span class="token punctuation">,</span> wrapped<span class="token punctuation">)</span>\n\n        <span class="token keyword">return</span> klass\n\n\n<span class="token keyword">class</span> <span class="token class-name">SimpleDict</span><span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">,</span> metaclass<span class="token operator">=</span>OtherMeta<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">TraceDict</span><span class="token punctuation">(</span>SimpleDict<span class="token punctuation">,</span> metaclass<span class="token operator">=</span>TraceMeta<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\ntrace_dict <span class="token operator">=</span> TraceDict<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'hi\'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\ntrace_dict<span class="token punctuation">[</span><span class="token string">\'there\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span>\ntrace_dict<span class="token punctuation">[</span><span class="token string">\'hi\'</span><span class="token punctuation">]</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    trace_dict<span class="token punctuation">[</span><span class="token string">\'does not exist\'</span><span class="token punctuation">]</span>\n<span class="token keyword">except</span> KeyError<span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>  <span class="token comment"># Expected</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n__new__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.TraceDict\'</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'hi\'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n__getitem__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'hi\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'there\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'hi\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token number">1</span>\n__getitem__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'hi\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'there\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'does not exist\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> KeyError<span class="token punctuation">(</span><span class="token string">\'does not exist\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然而，如果 TraceMeta 不是我们自己写的，而是来自某个程序库，那就没办法手工修改它了。另外，如果想同时使用多个像 TraceMeta 这样的元类所提供的逻辑，那么这套方案无法满足需求，因为在定义类的时候，metaclass 后面只能写一个元类。总之，这个方案对受元类控制的子类提出了过多的要求。</p>\n<p>为此，我们可以换一种方案，也就是改用类修饰器（class decorator）来实现。这种修饰器与函数修饰器相似，都通过 @ 符号来施加，但它并不施加在函数上面，而是施加在类的上面。编写类修饰器时，我们可以修改或重建它所修饰的类，并通过 return 语句返回处理结果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4043303411606813000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def my_class_decorator(klass):\n    klass.extra_param = \'hello\'\n    return klass\n\n\n@my_class_decorator\nclass MyClass:\n    pass\n\n\nprint(MyClass)\nprint(MyClass.extra_param)\n\n>>>\n<class \'__main__.MyClass\'>\nhello`, `4043303411606813000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">my_class_decorator</span><span class="token punctuation">(</span>klass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    klass<span class="token punctuation">.</span>extra_param <span class="token operator">=</span> <span class="token string">\'hello\'</span>\n    <span class="token keyword">return</span> klass\n\n\n@my_class_decorator\n<span class="token keyword">class</span> <span class="token class-name">MyClass</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">print</span><span class="token punctuation">(</span>MyClass<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>MyClass<span class="token punctuation">.</span>extra_param<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.MyClass\'</span><span class="token operator">></span>\nhello</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在就来实现这样一个类修饰器，它可以施加在类上面，让该类的所有方法与函数都能自动封装在 trace_func 之中。这个类修饰器本身是个独立的函数，它的代码基本上可以沿用早前所写的 <code class="language-text">TraceMeta.__new__</code>。这套方案要比采用元类实现的方案简单得多。</p>\n<p>我们把类修饰器运用到自定义的 dict 子类上面，这样它就有了与刚才那套元类方案相同的功能。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56031765439009690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import types\nfrom functools import wraps\n\n\ndef trace_func(func):\n    if hasattr(func, \'tracing\'):  # Only decorate once\n        return func\n\n    @wraps(func)\n    def wrapper(*args, **kwargs):\n        result = None\n        try:\n            result = func(*args, **kwargs)\n            return result\n        except Exception as e:\n            result = e\n            raise\n        finally:\n            print(f\'{func.__name__}({args!r}, {kwargs!r}) -> \'\n                  f\'{result!r}\')\n\n    wrapper.tracing = True\n    return wrapper\n\n\ntrace_types = (\n    types.MethodType,\n    types.FunctionType,\n    types.BuiltinFunctionType,\n    types.BuiltinMethodType,\n    types.MethodDescriptorType,\n    types.ClassMethodDescriptorType\n)\n\n\ndef trace(klass):\n    for key in dir(klass):\n        value = getattr(klass, key)\n        if isinstance(value, trace_types):\n            wrapped = trace_func(value)\n            setattr(klass, key, wrapped)\n    return klass\n\n\n@trace\nclass TraceDict(dict):\n    pass\n\n\ntrace_dict = TraceDict([(\'hi\', 1)])\ntrace_dict[\'there\'] = 2\ntrace_dict[\'hi\']\ntry:\n    trace_dict[\'does not exist\']\nexcept KeyError:\n    pass  # Expected\n\n>>>\n__new__((<class \'__main__.TraceDict\'>, [(\'hi\', 1)]), {}) -> {}\n__getitem__(({\'hi\': 1, \'there\': 2}, \'hi\'), {}) -> 1\n__getitem__(({\'hi\': 1, \'there\': 2}, \'does not exist\'), {}) -> KeyError(\'does not exist\')`, `56031765439009690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> types\n<span class="token keyword">from</span> functools <span class="token keyword">import</span> wraps\n\n\n<span class="token keyword">def</span> <span class="token function">trace_func</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> <span class="token string">\'tracing\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># Only decorate once</span>\n        <span class="token keyword">return</span> func\n\n    @wraps<span class="token punctuation">(</span>func<span class="token punctuation">)</span>\n    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        result <span class="token operator">=</span> <span class="token boolean">None</span>\n        <span class="token keyword">try</span><span class="token punctuation">:</span>\n            result <span class="token operator">=</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>\n            <span class="token keyword">return</span> result\n        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n            result <span class="token operator">=</span> e\n            <span class="token keyword">raise</span>\n        <span class="token keyword">finally</span><span class="token punctuation">:</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>func<span class="token punctuation">.</span>__name__<span class="token punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token punctuation">{</span>args<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{</span>kwargs<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">) -> \'</span></span>\n                  <span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n    wrapper<span class="token punctuation">.</span>tracing <span class="token operator">=</span> <span class="token boolean">True</span>\n    <span class="token keyword">return</span> wrapper\n\n\ntrace_types <span class="token operator">=</span> <span class="token punctuation">(</span>\n    types<span class="token punctuation">.</span>MethodType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>FunctionType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>BuiltinFunctionType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>BuiltinMethodType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>MethodDescriptorType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>ClassMethodDescriptorType\n<span class="token punctuation">)</span>\n\n\n<span class="token keyword">def</span> <span class="token function">trace</span><span class="token punctuation">(</span>klass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> key <span class="token keyword">in</span> <span class="token builtin">dir</span><span class="token punctuation">(</span>klass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        value <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>klass<span class="token punctuation">,</span> key<span class="token punctuation">)</span>\n        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> trace_types<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            wrapped <span class="token operator">=</span> trace_func<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n            <span class="token builtin">setattr</span><span class="token punctuation">(</span>klass<span class="token punctuation">,</span> key<span class="token punctuation">,</span> wrapped<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> klass\n\n\n@trace\n<span class="token keyword">class</span> <span class="token class-name">TraceDict</span><span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\ntrace_dict <span class="token operator">=</span> TraceDict<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'hi\'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\ntrace_dict<span class="token punctuation">[</span><span class="token string">\'there\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span>\ntrace_dict<span class="token punctuation">[</span><span class="token string">\'hi\'</span><span class="token punctuation">]</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    trace_dict<span class="token punctuation">[</span><span class="token string">\'does not exist\'</span><span class="token punctuation">]</span>\n<span class="token keyword">except</span> KeyError<span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>  <span class="token comment"># Expected</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n__new__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.TraceDict\'</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'hi\'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n__getitem__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'hi\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'there\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'hi\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token number">1</span>\n__getitem__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'hi\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'there\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'does not exist\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> KeyError<span class="token punctuation">(</span><span class="token string">\'does not exist\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>另外，类修饰器也能施加到那种已经有 metaclass 的类上面。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89564315995180090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import types\nfrom functools import wraps\n\n\ndef trace_func(func):\n    if hasattr(func, \'tracing\'):  # Only decorate once\n        return func\n\n    @wraps(func)\n    def wrapper(*args, **kwargs):\n        result = None\n        try:\n            result = func(*args, **kwargs)\n            return result\n        except Exception as e:\n            result = e\n            raise\n        finally:\n            print(f\'{func.__name__}({args!r}, {kwargs!r}) -> \'\n                  f\'{result!r}\')\n\n    wrapper.tracing = True\n    return wrapper\n\n\ntrace_types = (\n    types.MethodType,\n    types.FunctionType,\n    types.BuiltinFunctionType,\n    types.BuiltinMethodType,\n    types.MethodDescriptorType,\n    types.ClassMethodDescriptorType\n)\n\n\ndef trace(klass):\n    for key in dir(klass):\n        value = getattr(klass, key)\n        if isinstance(value, trace_types):\n            wrapped = trace_func(value)\n            setattr(klass, key, wrapped)\n    return klass\n\n\nclass OtherMeta(type):\n    pass\n\n\n@trace\nclass TraceDict(dict, metaclass=OtherMeta):\n    pass\n\n\ntrace_dict = TraceDict([(\'hi\', 1)])\ntrace_dict[\'there\'] = 2\ntrace_dict[\'hi\']\ntry:\n    trace_dict[\'does not exist\']\nexcept KeyError:\n    pass  # Expected\n\n>>>\n__new__((<class \'__main__.TraceDict\'>, [(\'hi\', 1)]), {}) -> {}\n__getitem__(({\'hi\': 1, \'there\': 2}, \'hi\'), {}) -> 1\n__getitem__(({\'hi\': 1, \'there\': 2}, \'does not exist\'), {}) -> KeyError(\'does not exist\')`, `89564315995180090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> types\n<span class="token keyword">from</span> functools <span class="token keyword">import</span> wraps\n\n\n<span class="token keyword">def</span> <span class="token function">trace_func</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> <span class="token string">\'tracing\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># Only decorate once</span>\n        <span class="token keyword">return</span> func\n\n    @wraps<span class="token punctuation">(</span>func<span class="token punctuation">)</span>\n    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        result <span class="token operator">=</span> <span class="token boolean">None</span>\n        <span class="token keyword">try</span><span class="token punctuation">:</span>\n            result <span class="token operator">=</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>\n            <span class="token keyword">return</span> result\n        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n            result <span class="token operator">=</span> e\n            <span class="token keyword">raise</span>\n        <span class="token keyword">finally</span><span class="token punctuation">:</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>func<span class="token punctuation">.</span>__name__<span class="token punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token punctuation">{</span>args<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{</span>kwargs<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">) -> \'</span></span>\n                  <span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n    wrapper<span class="token punctuation">.</span>tracing <span class="token operator">=</span> <span class="token boolean">True</span>\n    <span class="token keyword">return</span> wrapper\n\n\ntrace_types <span class="token operator">=</span> <span class="token punctuation">(</span>\n    types<span class="token punctuation">.</span>MethodType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>FunctionType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>BuiltinFunctionType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>BuiltinMethodType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>MethodDescriptorType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>ClassMethodDescriptorType\n<span class="token punctuation">)</span>\n\n\n<span class="token keyword">def</span> <span class="token function">trace</span><span class="token punctuation">(</span>klass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> key <span class="token keyword">in</span> <span class="token builtin">dir</span><span class="token punctuation">(</span>klass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        value <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>klass<span class="token punctuation">,</span> key<span class="token punctuation">)</span>\n        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> trace_types<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            wrapped <span class="token operator">=</span> trace_func<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n            <span class="token builtin">setattr</span><span class="token punctuation">(</span>klass<span class="token punctuation">,</span> key<span class="token punctuation">,</span> wrapped<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> klass\n\n\n<span class="token keyword">class</span> <span class="token class-name">OtherMeta</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n@trace\n<span class="token keyword">class</span> <span class="token class-name">TraceDict</span><span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">,</span> metaclass<span class="token operator">=</span>OtherMeta<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\ntrace_dict <span class="token operator">=</span> TraceDict<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'hi\'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\ntrace_dict<span class="token punctuation">[</span><span class="token string">\'there\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span>\ntrace_dict<span class="token punctuation">[</span><span class="token string">\'hi\'</span><span class="token punctuation">]</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    trace_dict<span class="token punctuation">[</span><span class="token string">\'does not exist\'</span><span class="token punctuation">]</span>\n<span class="token keyword">except</span> KeyError<span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>  <span class="token comment"># Expected</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n__new__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.TraceDict\'</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'hi\'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n__getitem__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'hi\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'there\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'hi\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token number">1</span>\n__getitem__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'hi\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'there\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'does not exist\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> KeyError<span class="token punctuation">(</span><span class="token string">\'does not exist\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>总之，如果想用一套可组合的机制来扩充类的功能，那么最好是通过类修饰器实现（第 73 条会讲到一种很有用的类修饰器，名为 <code class="language-text">functools.total_ordering</code>）。</p>\n<h3 id="总结-47"><a href="#%E6%80%BB%E7%BB%93-47" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>类修饰器其实就是个函数，只不过它可以通过参数获知自己所修饰的类，从而重建或调整这个类并返回修改结果。</li>\n<li>如果要给类中的每个方法或属性都施加一套逻辑，而且还想尽量少写一些例行代码，那么类修饰器是个很值得考虑的方案。</li>\n<li>元类之间很难组合，而类修饰器则比较灵活，它们可以施加在同一个类上，并且不会发生冲突。</li>\n</ol>\n<h1 id="并发与并行"><a href="#%E5%B9%B6%E5%8F%91%E4%B8%8E%E5%B9%B6%E8%A1%8C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>并发与并行</h1>\n<h2 id="第-52-条：用-subprocess-管理子进程"><a href="#%E7%AC%AC-52-%E6%9D%A1%EF%BC%9A%E7%94%A8-subprocess-%E7%AE%A1%E7%90%86%E5%AD%90%E8%BF%9B%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 52 条：用 subprocess 管理子进程</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14980615140299225000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import subprocess\n\nresult = subprocess.run(\n    [\'echo\', \'Hello from the child!\'],\n    capture_output=True,\n    encoding=\'utf-8\')\n\nresult.check_returncode()\nprint(result.stdout)\n# No exception means clean exit\n\n>>>\nHello from the child!`, `14980615140299225000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> subprocess\n\nresult <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>\n    <span class="token punctuation">[</span><span class="token string">\'echo\'</span><span class="token punctuation">,</span> <span class="token string">\'Hello from the child!\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n    capture_output<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>\n    encoding<span class="token operator">=</span><span class="token string">\'utf-8\'</span><span class="token punctuation">)</span>\n\nresult<span class="token punctuation">.</span>check_returncode<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span>\n<span class="token comment"># No exception means clean exit</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nHello <span class="token keyword">from</span> the child!</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>子进程可以独立于父进程而运行，这里的父进程指 Python 解释器所在的那条进程。假如刚才那条子进程不是通过 run 函数启动，而是由 Popen 类启动的，那么我们就可以在它启动之后，让 Python 程序去做别的任务，每做一段时间就来查询一次子进程的状态以决定要不要继续执行任务</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78239199915268230000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import subprocess\n\nproc = subprocess.Popen([\'sleep\', \'1\'])\nwhile proc.poll() is None:\n    print(\'Working...\')\n# Some time-consuming work here\nprint(\'Exit status\', proc.poll())\n\n>>>\nWorking...\nWorking...\nWorking...\nExit status 0`, `78239199915268230000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> subprocess\n\nproc <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'sleep\'</span><span class="token punctuation">,</span> <span class="token string">\'1\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token keyword">while</span> proc<span class="token punctuation">.</span>poll<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Working...\'</span><span class="token punctuation">)</span>\n<span class="token comment"># Some time-consuming work here</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Exit status\'</span><span class="token punctuation">,</span> proc<span class="token punctuation">.</span>poll<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nWorking<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nWorking<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nWorking<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nExit status <span class="token number">0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>把子进程从父进程中剥离，可以让程序平行地运行多条子进程。例如，我们可以像下面这样，先把需要运行的这些子进程用 Popen 启动起来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4624789127804441000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import subprocess\nimport time\n\nstart = time.time()\nsleep_procs = []\nfor _ in range(10):\n    proc = subprocess.Popen([\'sleep\', \'1\'])\n    sleep_procs.append(proc)\n\nfor proc in sleep_procs:\n    proc.communicate()\n\nend = time.time()\ndelta = end - start\nprint(f\'Finished in {delta:.3} seconds\')\n\n>>>\nFinished in 1.01 seconds`, `4624789127804441000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> subprocess\n<span class="token keyword">import</span> time\n\nstart <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>\nsleep_procs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n<span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    proc <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'sleep\'</span><span class="token punctuation">,</span> <span class="token string">\'1\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n    sleep_procs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>proc<span class="token punctuation">)</span>\n\n<span class="token keyword">for</span> proc <span class="token keyword">in</span> sleep_procs<span class="token punctuation">:</span>\n    proc<span class="token punctuation">.</span>communicate<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\nend <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>\ndelta <span class="token operator">=</span> end <span class="token operator">-</span> start\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Finished in </span><span class="token interpolation"><span class="token punctuation">{</span>delta<span class="token punctuation">:</span><span class="token format-spec">.3</span><span class="token punctuation">}</span></span><span class="token string"> seconds\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nFinished <span class="token keyword">in</span> <span class="token number">1.01</span> seconds</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>从统计结果可以看出，这 10 条子进程确实表现出了平行的效果。假如它们是按顺序执行的，那么程序耗费的总时长至少应该是 10 秒，而不是现在看到的 1 秒左右。</p>\n<p>我们还可以在 Python 程序里面把数据通过管道发送给子进程所运行的外部命令，然后将那条命令的输出结果获取到 Python 程序之中。而且，在执行外部命令的这个环节中，可以平行地运行多条命令。例如，要用 oepnssl 这样的命令行工具来加密数据。首先以适当的命令行参数构建一批子进程，并配置好相应的 I/O 管道，这在 Python 里很容易就能做到。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56171337903840810000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import subprocess\nimport os\n\n\ndef run_encrypt(data):\n    env = os.environ.copy()\n    env[\'password\'] = \'2f7ShyBhZOraQDdE/FiZpm/m/8f9X+MI\'\n    proc = subprocess.Popen(\n        [\'openssl\', \'enc\', \'-des3\', \'-pass\', \'env:password\'],\n        env=env,\n        stdin=subprocess.PIPE,\n        stdout=subprocess.PIPE\n    ) # 平行运行\n    proc.stdin.write(data)\n    proc.stdin.flush()  # Ensure that the child gets input\n    return proc\n\n\nprocs = []\nfor _ in range(3):\n    data = os.urandom(10)\n    proc = run_encrypt(data)\n    procs.append(proc)\n\nfor proc in procs:\n    out, _ = proc.communicate()\n    print(out[-10:])\n\n>>>\nb\'\\xc4G\\x01\\xf1\\x90Q\\xae\\xff\\x86\\xe1\'\nb\'>T~~R\\xbd\\xc3n\\x87\\xcc\'\nb\'\\xe9\\x02\\x18sE\\xa1W\\xcet\\xae\'`, `56171337903840810000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> subprocess\n<span class="token keyword">import</span> os\n\n\n<span class="token keyword">def</span> <span class="token function">run_encrypt</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    env <span class="token operator">=</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    env<span class="token punctuation">[</span><span class="token string">\'password\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">\'2f7ShyBhZOraQDdE/FiZpm/m/8f9X+MI\'</span>\n    proc <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span>\n        <span class="token punctuation">[</span><span class="token string">\'openssl\'</span><span class="token punctuation">,</span> <span class="token string">\'enc\'</span><span class="token punctuation">,</span> <span class="token string">\'-des3\'</span><span class="token punctuation">,</span> <span class="token string">\'-pass\'</span><span class="token punctuation">,</span> <span class="token string">\'env:password\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n        env<span class="token operator">=</span>env<span class="token punctuation">,</span>\n        stdin<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span>\n        stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE\n    <span class="token punctuation">)</span> <span class="token comment"># 平行运行</span>\n    proc<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span>write<span class="token punctuation">(</span>data<span class="token punctuation">)</span>\n    proc<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># Ensure that the child gets input</span>\n    <span class="token keyword">return</span> proc\n\n\nprocs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n<span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    data <span class="token operator">=</span> os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>\n    proc <span class="token operator">=</span> run_encrypt<span class="token punctuation">(</span>data<span class="token punctuation">)</span>\n    procs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>proc<span class="token punctuation">)</span>\n\n<span class="token keyword">for</span> proc <span class="token keyword">in</span> procs<span class="token punctuation">:</span>\n    out<span class="token punctuation">,</span> _ <span class="token operator">=</span> proc<span class="token punctuation">.</span>communicate<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span>out<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token string">b\'\\xc4G\\x01\\xf1\\x90Q\\xae\\xff\\x86\\xe1\'</span>\n<span class="token string">b\'>T~~R\\xbd\\xc3n\\x87\\xcc\'</span>\n<span class="token string">b\'\\xe9\\x02\\x18sE\\xa1W\\xcet\\xae\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这些平行运行的子进程还可以分别与另一套平行的子进程对接，形成许多条平行的管道（pipe）。这种管道与 UNIX 管道类似，能够把一条子进程的输出端同另一条子进程的输入端连接起来。下面，我们写这样一个函数，让它开启一条子进程来运行 openssl 命令，这条命令会根据输入端所发来的数据在输出端生成 Whirlpool 哈希。</p>\n<p>现在，我们可以先启动一批进程来加密数据，然后启动另一批进程根据前面那些进程的加密结果生成哈希码。请注意，前面那批进程（也就是上游进程）的 stdout 实例必须谨慎地处理，用它把相应的哈希进程（也就是下游进程）启动之后，就应该及时关闭（close）并将其设为 None。</p>\n<p>只要上、下游的子进程都启动起来，两者之间的 I/O 管道就会自动打通。我们所要做的仅仅是等待这两批子进程完工并把最终结果打印出来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93071585672686680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import subprocess\nimport os\n\n\ndef run_hash(input_stdin):\n    return subprocess.Popen(\n        [\'openssl\', \'dgst\', \'-whirlpool\', \'-binary\'],\n        stdin=input_stdin,\n        stdout=subprocess.PIPE)\n\n\ndef run_encrypt(data):\n    env = os.environ.copy()\n    env[\'password\'] = \'2f7ShyBhZOraQDdE/FiZpm/m/8f9X+MI\'\n    proc = subprocess.Popen(\n        [\'openssl\', \'enc\', \'-des3\', \'-pass\', \'env:password\'],\n        env=env,\n        stdin=subprocess.PIPE,\n        stdout=subprocess.PIPE\n    )  # 平行运行\n    proc.stdin.write(data)\n    proc.stdin.flush()  # Ensure that the child gets input\n    return proc\n\n\nencrypt_procs = []\nhash_procs = []\nfor _ in range(3):\n    data = os.urandom(100)\n    encrypt_proc = run_encrypt(data)\n    encrypt_procs.append(encrypt_proc)\n    hash_proc = run_hash(encrypt_proc.stdout)\n    hash_procs.append(hash_proc)\n    # Ensure that the child consumes the input stream and\n    # the communicate method doesn\'t inadvertently steal\n    # input from the child. Also lets SIGPIPE propagate to\n    # the upstream process if the downstream process dies.\n    encrypt_proc.stdout.close()\n    encrypt_proc.stdout = None\n\nfor proc in encrypt_procs:\n    proc.communicate()\n    assert proc.returncode == 0\n\nfor proc in hash_procs:\n    out, _ = proc.communicate()\n    print(out[-10:])\n    assert proc.returncode == 0\n\n>>>\nb\'\\xa7{\\xc8q\\xf9n#i\\x0b7\'\nb\'\\xb3\\x9aP\\x7f\\xa6N\\xc9\\x8b-Z\'\nb\'\\xe8F\\x94\\x1fQ\\x83L\\xf7\\xb3p\'`, `93071585672686680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> subprocess\n<span class="token keyword">import</span> os\n\n\n<span class="token keyword">def</span> <span class="token function">run_hash</span><span class="token punctuation">(</span>input_stdin<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span>\n        <span class="token punctuation">[</span><span class="token string">\'openssl\'</span><span class="token punctuation">,</span> <span class="token string">\'dgst\'</span><span class="token punctuation">,</span> <span class="token string">\'-whirlpool\'</span><span class="token punctuation">,</span> <span class="token string">\'-binary\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n        stdin<span class="token operator">=</span>input_stdin<span class="token punctuation">,</span>\n        stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">)</span>\n\n\n<span class="token keyword">def</span> <span class="token function">run_encrypt</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    env <span class="token operator">=</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    env<span class="token punctuation">[</span><span class="token string">\'password\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">\'2f7ShyBhZOraQDdE/FiZpm/m/8f9X+MI\'</span>\n    proc <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span>\n        <span class="token punctuation">[</span><span class="token string">\'openssl\'</span><span class="token punctuation">,</span> <span class="token string">\'enc\'</span><span class="token punctuation">,</span> <span class="token string">\'-des3\'</span><span class="token punctuation">,</span> <span class="token string">\'-pass\'</span><span class="token punctuation">,</span> <span class="token string">\'env:password\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n        env<span class="token operator">=</span>env<span class="token punctuation">,</span>\n        stdin<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span>\n        stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE\n    <span class="token punctuation">)</span>  <span class="token comment"># 平行运行</span>\n    proc<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span>write<span class="token punctuation">(</span>data<span class="token punctuation">)</span>\n    proc<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># Ensure that the child gets input</span>\n    <span class="token keyword">return</span> proc\n\n\nencrypt_procs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\nhash_procs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n<span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    data <span class="token operator">=</span> os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>\n    encrypt_proc <span class="token operator">=</span> run_encrypt<span class="token punctuation">(</span>data<span class="token punctuation">)</span>\n    encrypt_procs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>encrypt_proc<span class="token punctuation">)</span>\n    hash_proc <span class="token operator">=</span> run_hash<span class="token punctuation">(</span>encrypt_proc<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span>\n    hash_procs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>hash_proc<span class="token punctuation">)</span>\n    <span class="token comment"># Ensure that the child consumes the input stream and</span>\n    <span class="token comment"># the communicate method doesn\'t inadvertently steal</span>\n    <span class="token comment"># input from the child. Also lets SIGPIPE propagate to</span>\n    <span class="token comment"># the upstream process if the downstream process dies.</span>\n    encrypt_proc<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    encrypt_proc<span class="token punctuation">.</span>stdout <span class="token operator">=</span> <span class="token boolean">None</span>\n\n<span class="token keyword">for</span> proc <span class="token keyword">in</span> encrypt_procs<span class="token punctuation">:</span>\n    proc<span class="token punctuation">.</span>communicate<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">assert</span> proc<span class="token punctuation">.</span>returncode <span class="token operator">==</span> <span class="token number">0</span>\n\n<span class="token keyword">for</span> proc <span class="token keyword">in</span> hash_procs<span class="token punctuation">:</span>\n    out<span class="token punctuation">,</span> _ <span class="token operator">=</span> proc<span class="token punctuation">.</span>communicate<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span>out<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n    <span class="token keyword">assert</span> proc<span class="token punctuation">.</span>returncode <span class="token operator">==</span> <span class="token number">0</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token string">b\'\\xa7{\\xc8q\\xf9n#i\\x0b7\'</span>\n<span class="token string">b\'\\xb3\\x9aP\\x7f\\xa6N\\xc9\\x8b-Z\'</span>\n<span class="token string">b\'\\xe8F\\x94\\x1fQ\\x83L\\xf7\\xb3p\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果子进程有可能一直不结束，或者由于某种原因卡在输入端或输出端，那么可以在调用 communicate 方法时指定 timeout 参数。这样的话，子进程若是没能在指定时间内结束，程序就会抛出异常，让我们有机会把这条不正常的子进程停掉。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23463417667650986000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import subprocess\n\nproc = subprocess.Popen([\'sleep\', \'10\'])\ntry:\n    proc.communicate(timeout=0.1)\nexcept subprocess.TimeoutExpired:\n    proc.terminate()\n    proc.wait()\n\nprint(\'Exit status\', proc.poll())\n\n>>>\nExit status -15`, `23463417667650986000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> subprocess\n\nproc <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'sleep\'</span><span class="token punctuation">,</span> <span class="token string">\'10\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    proc<span class="token punctuation">.</span>communicate<span class="token punctuation">(</span>timeout<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span>\n<span class="token keyword">except</span> subprocess<span class="token punctuation">.</span>TimeoutExpired<span class="token punctuation">:</span>\n    proc<span class="token punctuation">.</span>terminate<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    proc<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Exit status\'</span><span class="token punctuation">,</span> proc<span class="token punctuation">.</span>poll<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nExit status <span class="token operator">-</span><span class="token number">15</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="总结-48"><a href="#%E6%80%BB%E7%BB%93-48" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>subprocess 模块可以运行子进程并管理它们的输入流与输出流。</li>\n<li>子进程能够跟 Python 解释器所在的进程并行，从而充分利用各 CPU 核心。</li>\n<li>要开启子进程，最简单的办法就是调用 run 函数，另外也可以通过 Popen 类实现类似 UNIX 管道的高级用法。</li>\n<li>调用 communicate 方法时可以指定 timeout 参数，让我们有机会把陷入死锁或已经卡住的子进程关掉。</li>\n</ol>\n<h2 id="第-53-条：可以用线程执行阻塞式-io，但不要用它做并行计算"><a href="#%E7%AC%AC-53-%E6%9D%A1%EF%BC%9A%E5%8F%AF%E4%BB%A5%E7%94%A8%E7%BA%BF%E7%A8%8B%E6%89%A7%E8%A1%8C%E9%98%BB%E5%A1%9E%E5%BC%8F-io%EF%BC%8C%E4%BD%86%E4%B8%8D%E8%A6%81%E7%94%A8%E5%AE%83%E5%81%9A%E5%B9%B6%E8%A1%8C%E8%AE%A1%E7%AE%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 53 条：可以用线程执行阻塞式 I/O，但不要用它做并行计算</h2>\n<p>Python 语言的标准实现叫作 CPython，，它分两步来运行 Python 程序。首先解析源代码文本，并将其编译成字节码（bytecode）。字节码是一种底层代码，可以把程序表示成 8 位的指令（从 Python 3.6 开始，这种底层代码实际上已经变成 16 位了，所以应该叫作 wordcode 才对，但基本原理依然相同）。然后，CPython 采用基于栈的解释器来运行字节码。这种字节码解释器在执行 Python 程序的过程中，必须确保相关的状态不受干扰，所以 CPython 会用一种叫作全局解释器锁（global interpreter lock，GIL）的机制来保证这一点。</p>\n<p>GIL 实际上就是一种互斥锁（mutual-exclusion lock，mutex），用来防止 CPython 的状态在抢占式的多线程环境（preemptive multithreading）之中受到干扰，因为在这种环境下，一条线程有可能突然打断另一条线程抢占程序的控制权。如果这种抢占行为来得不是时候，那么解释器的状态（例如为垃圾回收工作而设立的引用计数等）就会遭到破坏。所以，CPython 要通过 GIL 阻止这样的动作，以确保它自身以及它的那些 C 扩展模块能够正确地执行每一条字节码指令。</p>\n<p>但是，GIL 会产生一个很不好的影响。在 C++ 与 Java 这样的语言里面，如果程序之中有多个线程能够分头执行任务，那么就可以把 CPU 的各个核心充分地利用起来。尽管 Python 也支持多线程，但这些线程受 GIL 约束，所以每次或许只能有一条线程向前推进，而无法实现多头并进。所以，想通过多线程做并行计算或是给程序提速的开发者，恐怕要失望了。</p>\n<p>例如，我们要用 Python 程序执行一批计算量很大的任务。以最原始的办法实现这样一个因数分解算法，以模拟这种任务。</p>\n<p>我们试着分解几个数。如果必须把上一个数分解完才能开始分解下一个数，那么程序花的时间就比较长。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34519510351389270000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import time\n\n\ndef factorize(number):\n    for i in range(1, number + 1):\n        if number % i == 0:\n            yield i\n\n\nnumbers = [2139079, 1214759, 1516637, 1852285]\nstart = time.time()\nfor number in numbers:\n    list(factorize(number))\n\nend = time.time()\ndelta = end - start\nprint(f\'Took {delta:.3f} seconds\')\n\n>>>\nTook 0.428 seconds`, `34519510351389270000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> time\n\n\n<span class="token keyword">def</span> <span class="token function">factorize</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> number <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> number <span class="token operator">%</span> i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>\n            <span class="token keyword">yield</span> i\n\n\nnumbers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">2139079</span><span class="token punctuation">,</span> <span class="token number">1214759</span><span class="token punctuation">,</span> <span class="token number">1516637</span><span class="token punctuation">,</span> <span class="token number">1852285</span><span class="token punctuation">]</span>\nstart <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">for</span> number <span class="token keyword">in</span> numbers<span class="token punctuation">:</span>\n    <span class="token builtin">list</span><span class="token punctuation">(</span>factorize<span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\nend <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>\ndelta <span class="token operator">=</span> end <span class="token operator">-</span> start\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Took </span><span class="token interpolation"><span class="token punctuation">{</span>delta<span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string"> seconds\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTook <span class="token number">0.428</span> seconds</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>让每条线程各自分解一个数或许可以把计算机中的多个 CPU 核心充分利用起来。这种想法对于其他语言来说，可能有些道理，但是在 Python 中效果如何呢？我们试着定义这样一种 Python 线程，让它完成与刚才相同的因数分解任务。</p>\n<p>然后，针对每个待分解的数字都启动这样一条线程，让它们平行地运行下去。</p>\n<p>最后，等待所有线程执行完毕。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57343823503782490000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import time\n\nfrom threading import Thread\n\n\nclass FactorizeThread(Thread):\n    def __init__(self, number):\n        super().__init__()\n        self.number = number\n\n    def run(self):\n        self.factors = list(factorize(self.number))\n\n\ndef factorize(number):\n    for i in range(1, number + 1):\n        if number % i == 0:\n            yield i\n\n\nnumbers = [2139079, 1214759, 1516637, 1852285]\n\nstart = time.time()\nthreads = []\nfor number in numbers:\n    thread = FactorizeThread(number)\n    thread.start()\n    threads.append(thread)\n\nfor thread in threads:\n    thread.join()\n\nend = time.time()\ndelta = end - start\nprint(f\'Took {delta:.3f} seconds\')\n\n>>>\nTook 0.528 seconds`, `57343823503782490000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> time\n\n<span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread\n\n\n<span class="token keyword">class</span> <span class="token class-name">FactorizeThread</span><span class="token punctuation">(</span>Thread<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>number <span class="token operator">=</span> number\n\n    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>factors <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>factorize<span class="token punctuation">(</span>self<span class="token punctuation">.</span>number<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">def</span> <span class="token function">factorize</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> number <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> number <span class="token operator">%</span> i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>\n            <span class="token keyword">yield</span> i\n\n\nnumbers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">2139079</span><span class="token punctuation">,</span> <span class="token number">1214759</span><span class="token punctuation">,</span> <span class="token number">1516637</span><span class="token punctuation">,</span> <span class="token number">1852285</span><span class="token punctuation">]</span>\n\nstart <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>\nthreads <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n<span class="token keyword">for</span> number <span class="token keyword">in</span> numbers<span class="token punctuation">:</span>\n    thread <span class="token operator">=</span> FactorizeThread<span class="token punctuation">(</span>number<span class="token punctuation">)</span>\n    thread<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    threads<span class="token punctuation">.</span>append<span class="token punctuation">(</span>thread<span class="token punctuation">)</span>\n\n<span class="token keyword">for</span> thread <span class="token keyword">in</span> threads<span class="token punctuation">:</span>\n    thread<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\nend <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>\ndelta <span class="token operator">=</span> end <span class="token operator">-</span> start\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Took </span><span class="token interpolation"><span class="token punctuation">{</span>delta<span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string"> seconds\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTook <span class="token number">0.528</span> seconds</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>奇怪的是，这样做竟然比一个一个去分解还要慢。在其他语言中，像这样令 4 条线程分别执行各自的任务，应该比一条线程连续执行 4 份任务要快得多，考虑到创建线程与协调这些线程的开销，新程序的速度可能会比旧程序的 4 倍稍微低一点。即便 CPU 的核心数量不足 4 个，新程序也还是应该比原来更快才对（例如笔者的电脑是双核的，所以应该接近原来的 2 倍），但为什么它没有把多核心的优势发挥出来？这是因为，这种多线程的程序在标准的 CPython 解释器之中会受 GIL 牵制（例如 CPython 要通过 GIL 防止这些线程争抢全局锁，而且要花一些时间来协调）。</p>\n<p>若要 CPython 把多个核心充分利用起来，还是有一些办法的，但那些办法都不采用标准的 Thread 类（参见第 64 条），而且实现起来也需要大量的精力。既然有这么多限制，那 Python 还支持多线程干什么？这其实有两个原因。</p>\n<p>首先，这种机制让我们很容易就能实现出一种效果，也就是令人感觉程序似乎能在同一时间做许多件事。这样的效果采用手工方式很难编写（案例参见第 56 条），而通过线程来实现，则可以让 Python 自动替我们把这些问题处理好，让多项任务能够并发地执行。由于 GIL 机制，虽然每次还是只能有一个线程向前执行，但 CPython 会确保这些 Python 线程之间能够公平地轮换执行。</p>\n<p>其次，我们可以通过 Python 的多线程机制处理阻塞式的 I/O 任务，因为线程在执行某些系统调用的过程中会发生阻塞，假如只支持一条线程，那么整个程序就会卡在这里不动。Python 程序需要通过系统调用与外部环境交互，其中有一些调用属于阻塞式的 I/O 操作，例如读取文件、写入文件、联网以及与显示器等设备交互。多线程机制可以让程序中的其他线程继续执行各自的工作，只有发起调用请求的那条线程才需要卡在那里等待操作系统给出结果。</p>\n<p>例如，要通过串口（serial port）向遥控直升机发送信号。笔者以 select 这个系统调用来模拟这项操作。通过 select 函数让操作系统阻塞 0.1 秒，然后把控制权返还给本程序，这样就模拟出了使用串口通信的效果。</p>\n<p>通过这种方式依次执行系统调用，程序的执行时间会随着调用次数而上升。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48309853715553985000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import time\n\n\ndef slow_systemcall():\n    time.sleep(0.1)\n\n\nstart = time.time()\nfor _ in range(5):\n    slow_systemcall()\nend = time.time()\ndelta = end - start\nprint(f\'Took {delta:.3f} seconds\')\n\n>>>\nTook 0.501 seconds`, `48309853715553985000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> time\n\n\n<span class="token keyword">def</span> <span class="token function">slow_systemcall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>\n\n\nstart <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    slow_systemcall<span class="token punctuation">(</span><span class="token punctuation">)</span>\nend <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>\ndelta <span class="token operator">=</span> end <span class="token operator">-</span> start\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Took </span><span class="token interpolation"><span class="token punctuation">{</span>delta<span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string"> seconds\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTook <span class="token number">0.501</span> seconds</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写有个问题，就是程序在执行 <code class="language-text">slow_systemcall</code> 函数的过程中会彻底卡住，因为它的主线程会阻塞在 select 这里。在实际的程序里面，这是个相当糟糕的现象，因为我们向直升机发送信号的同时，还需要计算接下来的移动方式，不然直升机就会坠毁。所以，如果在执行阻塞式 I/O 的过程中还需要做计算，那么应该把系统调用放到另一条线程执行。</p>\n<p>下面把 <code class="language-text">slow_systemcall</code> 放在单独的线程里调用，这样能同时触发多项操作，于是我们可以在与多个串口（乃至多个直升机）通信的同时，在主线程里做其他必要的运算。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31374435438773520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import time\nfrom threading import Thread\n\n\ndef slow_systemcall():\n    time.sleep(0.1)\n\n\ndef compute_helicopter_location(i):\n    pass\n\n\nstart = time.time()\nthreads = []\nfor _ in range(5):\n    thread = Thread(target=slow_systemcall)\n    thread.start()\n    threads.append(thread)\n\nfor i in range(5):\n    compute_helicopter_location(i)\n\n\nfor thread in threads:\n    thread.join()\nend = time.time()\ndelta = end - start\nprint(f\'Took {delta:.3f} seconds\')\n\n>>>\nTook 0.101 seconds`, `31374435438773520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> time\n<span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread\n\n\n<span class="token keyword">def</span> <span class="token function">slow_systemcall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">def</span> <span class="token function">compute_helicopter_location</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\nstart <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>\nthreads <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n<span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    thread <span class="token operator">=</span> Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>slow_systemcall<span class="token punctuation">)</span>\n    thread<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    threads<span class="token punctuation">.</span>append<span class="token punctuation">(</span>thread<span class="token punctuation">)</span>\n\n<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    compute_helicopter_location<span class="token punctuation">(</span>i<span class="token punctuation">)</span>\n\n\n<span class="token keyword">for</span> thread <span class="token keyword">in</span> threads<span class="token punctuation">:</span>\n    thread<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>\nend <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>\ndelta <span class="token operator">=</span> end <span class="token operator">-</span> start\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Took </span><span class="token interpolation"><span class="token punctuation">{</span>delta<span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string"> seconds\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTook <span class="token number">0.101</span> seconds</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>与依次执行系统调用的那种写法相比，这种写法的速度几乎能达到原来的 5 倍。这说明，尽管那 5 条线程依然受 GIL 制约，但它们所发起的系统调用是可以各自向前执行的。GIL 只不过是让 Python 内部的代码无法平行推进而已，至于系统调用，则不会受到影响，因为 Python 线程在即将执行系统调用时，会释放 GIL，待完成调用之后，才会重新获取它。</p>\n<p>除了线程，还有很多办法也能处理阻塞式的 I/O（例如采用内置的 asyncio 模块等）。那些办法都很好，但你可能得花时间去重构代码适应它们所要求的执行模式（参见第 60 条与第 62 条）。与那些办法相比，用多线程处理阻塞式 I/O 是最简单的，而且只需要稍微调整代码就行。</p>\n<h3 id="总结-49"><a href="#%E6%80%BB%E7%BB%93-49" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>即便计算机具备多核的 CPU，Python 线程也无法真正实现并行，因为它们会受全局解释器锁（GIL）牵制。</li>\n<li>虽然 Python 的多线程机制受 GIL 影响，但还是非常有用的，因为我们很容易就能通过多线程模拟同时执行多项任务的效果。</li>\n<li>多条 Python 线程可以并行地执行多个系统调用，这样就能让程序在执行阻塞式的 I/O 任务时，继续做其他运算。</li>\n</ol>\n<p>// TODO 编写高质量 Python 待完成</p>',
excerpt:"培养 Pythonic 思维 第 1 条：查询自己使用的 Python 版本 Python 2 于 2020 年 1 月 1 日退场，到这一刻，所有的 bug 修复、安全补丁，以及特性向后移植都会停止。此后，如果你还坚持使用 Python…",frontmatter:{date:"2023-06-13 12:00:28",path:"/writing-high-quality-python/",tags:"后端, python, 读书笔记",title:"编写高质量Python",draft:null}},prePost:{html:'<h1 id="高并发架构"><a href="#%E9%AB%98%E5%B9%B6%E5%8F%91%E6%9E%B6%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>高并发架构</h1>\n<h2 id="消息队列"><a href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>消息队列</h2>\n<h3 id="为什么使用消息队列？"><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>为什么使用消息队列？</h3>\n<h4 id="优点"><a href="#%E4%BC%98%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>优点</h4>\n<ol>\n<li>解耦：通过一个 MQ，Pub/Sub 发布订阅消息这么一个模型，A 系统就跟其它系统彻底解耦了。</li>\n<li>异步：任务发到消息队列，由消费者异步消费</li>\n<li>削峰：任务发到消息队列，由消费者决定消费速度</li>\n</ol>\n<h4 id="缺点"><a href="#%E7%BC%BA%E7%82%B9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>缺点</h4>\n<ol>\n<li>系统可用性降低：MQ 挂了如何处理？即如何保证消息队列的高可用？</li>\n<li>系统复杂度提高：怎么保证消息没有重复消费？怎么处理消息丢失的情况？怎么保证消息传递的顺序性？</li>\n<li>一致性问题：A 系统处理完直接返回成功，发到消息队列后供 B、C、D 消费，如果 B、D 成功、C 失败怎么处理？</li>\n</ol>\n<h4 id="kafka、activemq、rabbitmq、rocketmq-有什么优缺点？"><a href="#kafka%E3%80%81activemq%E3%80%81rabbitmq%E3%80%81rocketmq-%E6%9C%89%E4%BB%80%E4%B9%88%E4%BC%98%E7%BC%BA%E7%82%B9%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Kafka、ActiveMQ、RabbitMQ、RocketMQ 有什么优缺点？</h4>\n<table>\n<thead>\n<tr>\n<th>特性</th>\n<th>ActiveMQ</th>\n<th>RabbitMQ</th>\n<th>RocketMQ</th>\n<th>Kafka</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>单机吞吐量</td>\n<td>万级，比 RocketMQ、Kafka 低一个数量级</td>\n<td>同 ActiveMQ</td>\n<td>10 万级，支撑高吞吐</td>\n<td>10 万级，高吞吐，一般配合大数据类的系统来进行实时数据计算、日志采集等场景</td>\n</tr>\n<tr>\n<td>topic 数量对吞吐量的影响</td>\n<td></td>\n<td></td>\n<td>topic 可以达到几百/几千的级别，吞吐量会有较小幅度的下降，这是 RocketMQ 的一大优势，在同等机器下，可以支撑大量的 topic</td>\n<td>topic 从几十到几百个时候，吞吐量会大幅度下降，在同等机器下，Kafka 尽量保证 topic 数量不要过多，如果要支撑大规模的 topic，需要增加更多的机器资源</td>\n</tr>\n<tr>\n<td>时效性</td>\n<td>ms 级</td>\n<td>微秒级，这是 RabbitMQ 的一大特点，延迟最低</td>\n<td>ms 级</td>\n<td>延迟在 ms 级以内</td>\n</tr>\n<tr>\n<td>可用性</td>\n<td>高，基于主从架构实现高可用</td>\n<td>同 ActiveMQ</td>\n<td>非常高，分布式架构</td>\n<td>非常高，分布式，一个数据多个副本，少数机器宕机，不会丢失数据，不会导致不可用</td>\n</tr>\n<tr>\n<td>消息可靠性</td>\n<td>有较低的概率丢失数据</td>\n<td>基本不丢</td>\n<td>经过参数优化配置，可以做到 0 丢失</td>\n<td>同 RocketMQ</td>\n</tr>\n<tr>\n<td>功能支持</td>\n<td>MQ 领域的功能极其完备</td>\n<td>基于 erlang 开发，并发能力很强，性能极好，延时很低</td>\n<td>MQ 功能较为完善，还是分布式的，扩展性好</td>\n<td>功能较为简单，主要支持简单的 MQ 功能，在大数据领域的实时计算以及日志采集被大规模使用</td>\n</tr>\n</tbody>\n</table>\n<p>综上，各种对比之后，有如下建议：</p>\n<p>一般的业务系统要引入 MQ，最早大家都用 ActiveMQ，但是现在确实大家用的不多了，没经过大规模吞吐量场景的验证，社区也不是很活跃，所以大家还是算了吧，我个人不推荐用这个了。</p>\n<p>后来大家开始用 RabbitMQ，但是确实 erlang 语言阻止了大量的 Java 工程师去深入研究和掌控它，对公司而言，几乎处于不可控的状态，但是确实人家是开源的，比较稳定的支持，活跃度也高。</p>\n<p>不过现在确实越来越多的公司会去用 RocketMQ，确实很不错，毕竟是阿里出品，但社区可能有突然黄掉的风险（目前 RocketMQ 已捐给 <a href="https://github.com/apache/rocketmq" target="_blank" rel="nofollow noreferrer noopener">Apache</a>，但 GitHub 上的活跃度其实不算高）对自己公司技术实力有绝对自信的，推荐用 RocketMQ，否则回去老老实实用 RabbitMQ 吧，人家有活跃的开源社区，绝对不会黄。</p>\n<p>所以<strong>中小型公司</strong>，技术实力较为一般，技术挑战不是特别高，用 RabbitMQ 是不错的选择；<strong>大型公司</strong>，基础架构研发实力较强，用 RocketMQ 是很好的选择。</p>\n<p>如果是<strong>大数据领域</strong>的实时计算、日志采集等场景，用 Kafka 是业内标准的，绝对没问题，社区活跃度很高，绝对不会黄，何况几乎是全世界这个领域的事实性规范。</p>\n<h3 id="如何保证消息队列的高可用？"><a href="#%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何保证消息队列的高可用？</h3>\n<h4 id="rabbitmq-的高可用性"><a href="#rabbitmq-%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RabbitMQ 的高可用性</h4>\n<p>RabbitMQ 是比较有代表性的，因为是基于主从（非分布式）做高可用性的，RabbitMQ 有三种模式：单机模式、普通集群模式、镜像集群模式。</p>\n<h5 id="单机模式"><a href="#%E5%8D%95%E6%9C%BA%E6%A8%A1%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>单机模式</h5>\n<p>单机模式，就是 Demo 级别的，一般就是你本地启动了玩玩儿的，没人生产用单机模式。</p>\n<h5 id="普通集群模式（无高可用性）"><a href="#%E6%99%AE%E9%80%9A%E9%9B%86%E7%BE%A4%E6%A8%A1%E5%BC%8F%EF%BC%88%E6%97%A0%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>普通集群模式（无高可用性）</h5>\n<p>普通集群模式，意思就是在多台机器上启动多个 RabbitMQ 实例，每台机器启动一个。你创建的 queue，只会放在一个 RabbitMQ 实例上，但是每个实例都同步 queue 的元数据（元数据可以认为是 queue 的一些配置信息，通过元数据，可以找到 queue 所在实例）。你消费的时候，实际上如果连接到了另外一个实例，那么那个实例会从 queue 所在实例上拉取数据过来。</p>\n<p>缺点如下：</p>\n<ol>\n<li>没做到分布式，就是个普通的集群：因为这导致你要么消费者每次随机连接一个实例然后拉取数据，要么固定连接那个 queue 所在实例消费数据，前者有数据拉取的开销，后者导致单实例性能瓶颈。</li>\n<li>可用性无保障：如果那个放 queue 的实例宕机了，会导致接下来其他实例就无法从那个实例拉取，如果你开启了消息持久化，让 RabbitMQ 落地存储消息的话，消息不一定会丢，得等这个实例恢复了，然后才可以继续从这个 queue 拉取数据</li>\n</ol>\n<p>唯一的好处就是提高在集群中多个节点服务某个 queue 的读写操作</p>\n<h5 id="镜像集群模式（高可用性）"><a href="#%E9%95%9C%E5%83%8F%E9%9B%86%E7%BE%A4%E6%A8%A1%E5%BC%8F%EF%BC%88%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7%EF%BC%89" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>镜像集群模式（高可用性）</h5>\n<p>这种模式，才是所谓的 RabbitMQ 的高可用模式。跟普通集群模式不一样的是，在镜像集群模式下，你创建的 queue，无论是元数据还是 queue 里的消息都会存在于多个实例上，就是说，每个 RabbitMQ 节点都有这个 queue 的一个完整镜像，包含 queue 的全部数据的意思。然后每次你写消息到 queue 的时候，都会自动把消息同步到多个实例的 queue 上。</p>\n<p>开启这个模式的方法：管理控制台新增镜像集群模式的策略，指定的时候是可以要求数据同步到所有节点，也可以要求同步到指定数量的节点，再次创建 queue 的时候，应用这个策略，就会自动将数据同步到其他的节点上去了。</p>\n<p>优点如下：</p>\n<ol>\n<li>可用性相对较高：你任何一个机器宕机了，没事儿，其它机器（节点）还包含了这个 queue 的完整数据，别的 consumer 都可以到其它节点上去消费数据。</li>\n</ol>\n<p>缺点如下：</p>\n<ol>\n<li>性能开销大：消息需要同步到所有机器上，导致网络带宽压力和消耗很重</li>\n<li>非分布式的，就没有扩展性可言：如果某个 queue 负载很重，你加机器，新增的机器也包含了这个 queue 的所有数据，并没有办法线性扩展你的 queue。你想，如果这个 queue 的数据量很大，大到这个机器上的容量无法容纳了，此时该怎么办呢？</li>\n</ol>\n<h4 id="kafka-的高可用性"><a href="#kafka-%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Kafka 的高可用性</h4>\n<p>基本架构：由多个 broker 组成，每个 broker 是一个节点；你创建一个 topic，这个 topic 可以划分为多个 partition，每个 partition 可以存在于不同的 broker 上，每个 partition 就放一部分数据。</p>\n<p>这就是天然的分布式消息队列，就是说一个 topic 的数据，是分散放在多个机器上的，每个机器就放一部分数据。</p>\n<p>实际上 RabbitMQ 之类的，并不是分布式消息队列，它就是传统的消息队列，只不过提供了一些集群、HA（High Availability, 高可用性） 的机制而已，因为无论怎么玩儿，RabbitMQ 一个 queue 的数据都是放在一个节点里的，镜像集群模式下，也是每个节点都放这个 queue 的完整数据。</p>\n<p>Kafka 0.8 以前，是没有 HA 机制的，就是任何一个 broker 宕机了，那个 broker 上的 partition 就废了，没法写也没法读，没有什么高可用性可言。</p>\n<p>比如说，我们假设创建了一个 topic，指定其 partition 数量是 3 个，分别在三台机器上。但是，如果第二台机器宕机了，会导致这个 topic 的 1/3 的数据就丢了，因此这个是做不到高可用的。</p>\n<p>Kafka 0.8 以后，提供了 HA 机制，就是 replica（复制品） 副本机制。每个 partition 的数据都会同步到其它机器上，形成自己的多个 replica 副本。所有 replica 会选举一个 leader 出来，那么生产和消费都跟这个 leader 打交道，然后其他 replica 就是 follower。写的时候，leader 会负责把数据同步到所有 follower 上去，读的时候就直接读 leader 上的数据即可。只能读写 leader？很简单，要是你可以随意读写每个 follower，那么就要关心数据一致性的问题，系统复杂度太高，很容易出问题。Kafka 会均匀地将一个 partition 的所有 replica 分布在不同的机器上，这样才可以提高容错性。</p>\n<p>这么搞，就有所谓的高可用性了，因为如果某个 broker 宕机了，没事儿，那个 broker 上面的 partition 在其他机器上都有副本的。如果这个宕机的 broker 上面有某个 partition 的 leader，那么此时会从 follower 中重新选举一个新的 leader 出来，大家继续读写那个新的 leader 即可。这就有所谓的高可用性了。</p>\n<p>写数据的时候，生产者就写 leader，然后 leader 将数据落地写本地磁盘，接着其他 follower 自己主动从 leader 来 pull 数据。一旦所有 follower 同步好数据了，就会发送 ack 给 leader，leader 收到所有 follower 的 ack 之后，就会返回写成功的消息给生产者。（当然，这只是其中一种模式，还可以适当调整这个行为）</p>\n<p>消费的时候，只会从 leader 去读，但是只有当一个消息已经被所有 follower 都同步成功返回 ack 的时候，这个消息才会被消费者读到。</p>\n<h3 id="如何保证消息不被重复消费？"><a href="#%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E6%B6%88%E6%81%AF%E4%B8%8D%E8%A2%AB%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何保证消息不被重复消费？</h3>\n<h4 id="背景"><a href="#%E8%83%8C%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>背景</h4>\n<p>首先，比如 RabbitMQ、RocketMQ、Kafka，都有可能会出现消息重复消费的问题，正常。因为这问题通常不是 MQ 自己保证的，是由我们开发来保证的。挑一个 Kafka 来举个例子，说说怎么重复消费吧。</p>\n<p>Kafka 实际上有个 offset 的概念，就是每个消息写进去，都有一个 offset，代表消息的序号，然后 consumer 消费了数据之后，每隔一段时间（定时定期），会把自己消费过的消息的 offset 提交一下，表示“我已经消费过了，下次我要是重启啥的，你就让我继续从上次消费到的 offset 来继续消费吧”。</p>\n<p>但是凡事总有意外，比如我们之前生产经常遇到的，就是你有时候重启系统，看你怎么重启了，如果碰到点着急的，直接 kill 进程了，再重启。这会导致 consumer 有些消息处理了，但是没来得及提交 offset，尴尬了。重启之后，少数消息会再次消费一次。</p>\n<p>有这么个场景。数据 1/2/3 依次进入 Kafka，Kafka 会给这三条数据每条分配一个 offset，代表这条数据的序号，我们就假设分配的 offset 依次是 152/153/154。消费者从 Kafka 去消费的时候，也是按照这个顺序去消费。假如当消费者消费了 offset=153 的这条数据，刚准备去提交 offset 到 Zookeeper，此时消费者进程被重启了。那么此时消费过的数据 1/2 的 offset 并没有提交，Kafka 也就不知道你已经消费了 offset=153 这条数据。那么重启之后，消费者会找 Kafka 说，嘿，哥儿们，你给我接着把上次我消费到的那个地方后面的数据继续给我传递过来。由于之前的 offset 没有提交成功，那么数据 1/2 会再次传过来，如果此时消费者没有去重的话，那么就会导致重复消费。</p>\n<p>如果消费者干的事儿是拿一条数据就往数据库里写一条，会导致说，你可能就把数据 1/2 在数据库里插入了 2 次，那么数据就错啦。</p>\n<h4 id="解决方案"><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解决方案</h4>\n<p>需要保证重复消费的幂等性，需要结合具体场景</p>\n<ol>\n<li>比如你拿个数据要写库，你先根据主键查一下，如果这数据都有了，你就别插入了，update 一下好吧。</li>\n<li>比如你是写 Redis，那没问题了，反正每次都是 set，天然幂等性。</li>\n<li>比如你不是上面两个场景，那做的稍微复杂一点，你需要让生产者发送每条数据的时候，里面加一个全局唯一的 id，类似订单 id 之类的东西，然后你这里消费到了之后，先根据这个 id 去比如 Redis 里查一下，之前消费过吗？如果没有消费过，你就处理，然后这个 id 写 Redis。如果消费过了，那你就别处理了，保证别重复处理相同的消息即可。</li>\n<li>比如基于数据库的唯一键来保证重复数据不会重复插入多条。因为有唯一键约束了，重复数据插入只会报错，不会导致数据库中出现脏数据。</li>\n</ol>\n<h3 id="如何保证消息的可靠性传输？"><a href="#%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E6%B6%88%E6%81%AF%E7%9A%84%E5%8F%AF%E9%9D%A0%E6%80%A7%E4%BC%A0%E8%BE%93%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何保证消息的可靠性传输？</h3>\n<p>数据的丢失问题，可能出现在生产者、MQ、消费者中，咱们从 RabbitMQ 和 Kafka 分别来分析一下吧。</p>\n<h4 id="rabbitmq"><a href="#rabbitmq" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RabbitMQ</h4>\n<h5 id="生产者弄丢了数据"><a href="#%E7%94%9F%E4%BA%A7%E8%80%85%E5%BC%84%E4%B8%A2%E4%BA%86%E6%95%B0%E6%8D%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>生产者弄丢了数据</h5>\n<p>生产者将数据发送到 RabbitMQ 的时候，可能数据就在半路给搞丢了，因为网络问题啥的，都有可能。</p>\n<p>此时可以选择用 RabbitMQ 提供的事务功能，就是生产者发送数据之前开启 RabbitMQ 事务 <code class="language-text">channel.txSelect()</code>，然后发送消息，如果消息没有成功被 RabbitMQ 接收到，那么生产者会收到异常报错，此时就可以回滚事务 <code class="language-text">channel.txRollback()</code>，然后重试发送消息；如果收到了消息，那么可以提交事务 channel.txCommit() 。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31984167161382150000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`try {\n    // 通过工厂创建连接\n    connection = factory.newConnection();\n    // 获取通道\n    channel = connection.createChannel();\n    // 开启事务\n    channel.txSelect();\n\n    // 这里发送消息\n    channel.basicPublish(exchange, routingKey, MessageProperties.PERSISTENT_TEXT_PLAIN, msg.getBytes());\n\n    // 模拟出现异常\n    int result = 1 / 0;\n\n    // 提交事务\n    channel.txCommit();\n} catch (IOException | TimeoutException e) {\n    // 捕捉异常，回滚事务\n    channel.txRollback();\n}`, `31984167161382150000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token keyword">try</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 通过工厂创建连接</span>\n    connection <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">newConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 获取通道</span>\n    channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 开启事务</span>\n    channel<span class="token punctuation">.</span><span class="token function">txSelect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 这里发送消息</span>\n    channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span>exchange<span class="token punctuation">,</span> routingKey<span class="token punctuation">,</span> <span class="token class-name">MessageProperties</span><span class="token punctuation">.</span>PERSISTENT_TEXT_PLAIN<span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 模拟出现异常</span>\n    <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 提交事务</span>\n    channel<span class="token punctuation">.</span><span class="token function">txCommit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> <span class="token operator">|</span> <span class="token class-name">TimeoutException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 捕捉异常，回滚事务</span>\n    channel<span class="token punctuation">.</span><span class="token function">txRollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是问题是，RabbitMQ 事务机制（同步）一搞，基本上吞吐量会下来，因为太耗性能。</p>\n<p>所以一般来说，如果你要确保说写 RabbitMQ 的消息别丢，可以开启 confirm 模式，在生产者那里设置开启 confirm 模式之后，你每次写的消息都会分配一个唯一的 id，然后如果写入了 RabbitMQ 中，RabbitMQ 会给你回传一个 ack 消息，告诉你说这个消息 ok 了。如果 RabbitMQ 没能处理这个消息，会回调你的一个 nack 接口，告诉你这个消息接收失败，你可以重试。而且你可以结合这个机制自己在内存里维护每个消息 id 的状态，如果超过一定时间还没接收到这个消息的回调，那么你可以重发。</p>\n<p>事务机制和 confirm 机制最大的不同在于，事务机制是同步的，你提交一个事务之后会阻塞在那儿，但是 confirm 机制是异步的，你发送个消息之后就可以发送下一个消息，然后那个消息 RabbitMQ 接收了之后会异步回调你的一个接口通知你这个消息接收到了。</p>\n<p>所以一般在生产者这块避免数据丢失，都是用 confirm 机制的。</p>\n<blockquote>\n<p>已经在 transaction 事务模式的 channel 是不能再设置成 confirm 模式的，即这两种模式是不能共存的。</p>\n</blockquote>\n<p>客户端实现生产者 confirm 有 3 种方式：</p>\n<ol>\n<li>\n<p>普通 confirm 模式：每发送一条消息后，调用 waitForConfirms() 方法，等待服务器端 confirm，如果服务端返回 false 或者在一段时间内都没返回，客户端可以进行消息重发。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75805728507349680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`channel.basicPublish(ConfirmConfig.exchangeName, ConfirmConfig.routingKey, MessageProperties.PERSISTENT_TEXT_PLAIN, ConfirmConfig.msg_10B.getBytes());\nif (!channel.waitForConfirms()) {\n   // 消息发送失败\n   // ...\n}`, `75805728507349680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java">channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token class-name">ConfirmConfig</span><span class="token punctuation">.</span>exchangeName<span class="token punctuation">,</span> <span class="token class-name">ConfirmConfig</span><span class="token punctuation">.</span>routingKey<span class="token punctuation">,</span> <span class="token class-name">MessageProperties</span><span class="token punctuation">.</span>PERSISTENT_TEXT_PLAIN<span class="token punctuation">,</span> <span class="token class-name">ConfirmConfig</span><span class="token punctuation">.</span>msg_10B<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>channel<span class="token punctuation">.</span><span class="token function">waitForConfirms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token comment">// 消息发送失败</span>\n   <span class="token comment">// ...</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>批量 confirm 模式：每发送一批消息后，调用 waitForConfirms() 方法，等待服务端 confirm。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86529613829262850000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`channel.confirmSelect();\nfor (int i = 0; i < batchCount; ++i) {\n   channel.basicPublish(ConfirmConfig.exchangeName, ConfirmConfig.routingKey, MessageProperties.PERSISTENT_TEXT_PLAIN, ConfirmConfig.msg_10B.getBytes());\n}\nif (!channel.waitForConfirms()) {\n   // 消息发送失败\n   // ...\n}`, `86529613829262850000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java">channel<span class="token punctuation">.</span><span class="token function">confirmSelect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> batchCount<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token class-name">ConfirmConfig</span><span class="token punctuation">.</span>exchangeName<span class="token punctuation">,</span> <span class="token class-name">ConfirmConfig</span><span class="token punctuation">.</span>routingKey<span class="token punctuation">,</span> <span class="token class-name">MessageProperties</span><span class="token punctuation">.</span>PERSISTENT_TEXT_PLAIN<span class="token punctuation">,</span> <span class="token class-name">ConfirmConfig</span><span class="token punctuation">.</span>msg_10B<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>channel<span class="token punctuation">.</span><span class="token function">waitForConfirms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token comment">// 消息发送失败</span>\n   <span class="token comment">// ...</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>异步 confirm 模式：提供一个回调方法，服务端 confirm 了一条或者多条消息后客户端会回调这个方法。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68792158032123085000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`SortedSet<Long> confirmSet = Collections.synchronizedSortedSet(new TreeSet<Long>());\nchannel.confirmSelect();\nchannel.addConfirmListener(new ConfirmListener() {\n   public void handleAck(long deliveryTag, boolean multiple) throws IOException {\n       if (multiple) {\n           confirmSet.headSet(deliveryTag + 1).clear();\n       } else {\n           confirmSet.remove(deliveryTag);\n       }\n   }\n\n   public void handleNack(long deliveryTag, boolean multiple) throws IOException {\n       System.out.println(&quot;Nack, SeqNo: &quot; + deliveryTag + &quot;, multiple: &quot; + multiple);\n       if (multiple) {\n           confirmSet.headSet(deliveryTag + 1).clear();\n       } else {\n           confirmSet.remove(deliveryTag);\n       }\n   }\n});\n\nwhile (true) {\n   long nextSeqNo = channel.getNextPublishSeqNo();\n   channel.basicPublish(ConfirmConfig.exchangeName, ConfirmConfig.routingKey, MessageProperties.PERSISTENT_TEXT_PLAIN, ConfirmConfig.msg_10B.getBytes());\n   confirmSet.add(nextSeqNo);\n}`, `68792158032123085000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="java"\n              >\n                <span class="gatsby-code-button-language">java</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="java"><pre style="counter-reset: linenumber NaN" class="language-java line-numbers"><code class="language-java"><span class="token class-name">SortedSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">></span></span> confirmSet <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">synchronizedSortedSet</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TreeSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nchannel<span class="token punctuation">.</span><span class="token function">confirmSelect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nchannel<span class="token punctuation">.</span><span class="token function">addConfirmListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ConfirmListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleAck</span><span class="token punctuation">(</span><span class="token keyword">long</span> deliveryTag<span class="token punctuation">,</span> <span class="token keyword">boolean</span> multiple<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>\n       <span class="token keyword">if</span> <span class="token punctuation">(</span>multiple<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n           confirmSet<span class="token punctuation">.</span><span class="token function">headSet</span><span class="token punctuation">(</span>deliveryTag <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n           confirmSet<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>deliveryTag<span class="token punctuation">)</span><span class="token punctuation">;</span>\n       <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleNack</span><span class="token punctuation">(</span><span class="token keyword">long</span> deliveryTag<span class="token punctuation">,</span> <span class="token keyword">boolean</span> multiple<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>\n       <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Nack, SeqNo: "</span> <span class="token operator">+</span> deliveryTag <span class="token operator">+</span> <span class="token string">", multiple: "</span> <span class="token operator">+</span> multiple<span class="token punctuation">)</span><span class="token punctuation">;</span>\n       <span class="token keyword">if</span> <span class="token punctuation">(</span>multiple<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n           confirmSet<span class="token punctuation">.</span><span class="token function">headSet</span><span class="token punctuation">(</span>deliveryTag <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n           confirmSet<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>deliveryTag<span class="token punctuation">)</span><span class="token punctuation">;</span>\n       <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n   <span class="token keyword">long</span> nextSeqNo <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">getNextPublishSeqNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token class-name">ConfirmConfig</span><span class="token punctuation">.</span>exchangeName<span class="token punctuation">,</span> <span class="token class-name">ConfirmConfig</span><span class="token punctuation">.</span>routingKey<span class="token punctuation">,</span> <span class="token class-name">MessageProperties</span><span class="token punctuation">.</span>PERSISTENT_TEXT_PLAIN<span class="token punctuation">,</span> <span class="token class-name">ConfirmConfig</span><span class="token punctuation">.</span>msg_10B<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   confirmSet<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>nextSeqNo<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n</ol>\n<h5 id="rabbitmq-弄丢了数据"><a href="#rabbitmq-%E5%BC%84%E4%B8%A2%E4%BA%86%E6%95%B0%E6%8D%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RabbitMQ 弄丢了数据</h5>\n<p>就是 RabbitMQ 自己弄丢了数据，这个你必须开启 RabbitMQ 的持久化，就是消息写入之后会持久化到磁盘，哪怕是 RabbitMQ 自己挂了，恢复之后会自动读取之前存储的数据，一般数据不会丢。除非极其罕见的是，RabbitMQ 还没持久化，自己就挂了，可能导致少量数据丢失，但是这个概率较小。</p>\n<p>设置持久化有两个步骤：</p>\n<ol>\n<li>创建 queue 的时候将其设置为持久化。这样就可以保证 RabbitMQ 持久化 queue 的元数据，但是它是不会持久化 queue 里的数据的。</li>\n<li>发送消息的时候将消息的 deliveryMode 设置为 2。就是将消息设置为持久化的，此时 RabbitMQ 就会将消息持久化到磁盘上去。</li>\n</ol>\n<p>必须要同时设置这两个持久化才行，RabbitMQ 哪怕是挂了，再次重启，也会从磁盘上重启恢复 queue，恢复这个 queue 里的数据。</p>\n<p>注意，哪怕是你给 RabbitMQ 开启了持久化机制，也有一种可能，就是这个消息写到了 RabbitMQ 中，但是还没来得及持久化到磁盘上，结果不巧，此时 RabbitMQ 挂了，就会导致内存里的一点点数据丢失。</p>\n<p>所以，持久化可以跟生产者那边的 confirm 机制配合起来，只有消息被持久化到磁盘之后，才会通知生产者 ack 了，所以哪怕是在持久化到磁盘之前，RabbitMQ 挂了，数据丢了，生产者收不到 ack ，你也是可以自己重发的。</p>\n<h5 id="消费端弄丢了数据"><a href="#%E6%B6%88%E8%B4%B9%E7%AB%AF%E5%BC%84%E4%B8%A2%E4%BA%86%E6%95%B0%E6%8D%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>消费端弄丢了数据</h5>\n<p>RabbitMQ 如果丢失了数据，主要是因为你消费的时候，刚消费到，还没处理，结果进程挂了，比如重启了，那么就尴尬了，RabbitMQ 认为你都消费了，这数据就丢了。</p>\n<p>这个时候得用 RabbitMQ 提供的 ack 机制，简单来说，就是你必须关闭 RabbitMQ 的自动 ack，可以通过一个 api 来调用就行，然后每次你自己代码里确保处理完的时候，再在程序里 ack 一把。这样的话，如果你还没处理完，不就没有 ack 了？那 RabbitMQ 就认为你还没处理完，这个时候 RabbitMQ 会把这个消费分配给别的 consumer 去处理，消息是不会丢的。</p>\n<blockquote>\n<p>为了保证消息从队列中可靠地到达消费者，RabbitMQ 提供了消息确认机制。消费者在声明队列时，可以指定 noAck 参数，当 noAck=false，RabbitMQ 会等待消费者显式发回 ack 信号后，才从内存（和磁盘，如果是持久化消息）中移去消息。否则，一旦消息被消费者消费，RabbitMQ 会在队列中立即删除它。</p>\n</blockquote>\n<h4 id="kafka"><a href="#kafka" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Kafka</h4>\n<h5 id="消费端弄丢了数据-1"><a href="#%E6%B6%88%E8%B4%B9%E7%AB%AF%E5%BC%84%E4%B8%A2%E4%BA%86%E6%95%B0%E6%8D%AE-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>消费端弄丢了数据</h5>\n<p>唯一可能导致消费者弄丢数据的情况，就是说，你消费到了这个消息，然后消费者那边自动提交了 offset，让 Kafka 以为你已经消费好了这个消息，但其实你才刚准备处理这个消息，你还没处理，你自己就挂了，此时这条消息就丢咯。</p>\n<p>这不是跟 RabbitMQ 差不多吗，大家都知道 Kafka 会自动提交 offset，那么只要关闭自动提交 offset，在处理完之后自己手动提交 offset，就可以保证数据不会丢。但是此时确实还是可能会有重复消费，比如你刚处理完，还没提交 offset，结果自己挂了，此时肯定会重复消费一次，自己保证幂等性就好了。</p>\n<p>生产环境碰到的一个问题，就是说我们的 Kafka 消费者消费到了数据之后是写到一个内存的 queue 里先缓冲一下，结果有的时候，你刚把消息写入内存 queue，然后消费者会自动提交 offset。然后此时我们重启了系统，就会导致内存 queue 里还没来得及处理的数据就丢失了。</p>\n<h5 id="kafka-弄丢了数据"><a href="#kafka-%E5%BC%84%E4%B8%A2%E4%BA%86%E6%95%B0%E6%8D%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Kafka 弄丢了数据</h5>\n<p>这块比较常见的一个场景，就是 Kafka 某个 broker 宕机，然后重新选举 partition 的 leader。大家想想，要是此时其他的 follower 刚好还有些数据没有同步，结果此时 leader 挂了，然后选举某个 follower 成 leader 之后，不就少了一些数据？这就丢了一些数据啊。</p>\n<p>生产环境也遇到过，之前 Kafka 的 leader 机器宕机了，将 follower 切换为 leader 之后，就会发现说这个数据就丢了。</p>\n<p>所以此时一般是要求起码设置如下 4 个参数：</p>\n<ol>\n<li>给 topic 设置 replication.factor 参数：这个值必须大于 1，要求每个 partition 必须有至少 2 个副本。</li>\n<li>在 Kafka 服务端设置 min.insync.replicas 参数：这个值必须大于 1，这个是要求一个 leader 至少感知到有至少一个 follower 还跟自己保持联系，没掉队，这样才能确保 leader 挂了还有一个 follower 吧。</li>\n<li>在 producer 端设置 acks=all：这个是要求每条数据，必须是写入所有 replica 之后，才能认为是写成功了。</li>\n<li>在 producer 端设置 retries=MAX（很大很大很大的一个值，无限次重试的意思）：这个是要求一旦写入失败，就无限重试，卡在这里了。我们生产环境就是按照上述要求配置的，这样配置之后，至少在 Kafka broker 端就可以保证在 leader 所在 broker 发生故障，进行 leader 切换时，数据不会丢失。</li>\n</ol>\n<h5 id="生产者会不会弄丢数据？"><a href="#%E7%94%9F%E4%BA%A7%E8%80%85%E4%BC%9A%E4%B8%8D%E4%BC%9A%E5%BC%84%E4%B8%A2%E6%95%B0%E6%8D%AE%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>生产者会不会弄丢数据？</h5>\n<p>如果按照上述的思路设置了 acks=all，一定不会丢，要求是你的 leader 接收到消息，所有的 follower 都同步到了消息之后，才认为本次写成功了。如果没满足这个条件，生产者会自动不断的重试，重试无限次。</p>\n<h4 id="rocketmq"><a href="#rocketmq" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RocketMQ</h4>\n<h5 id="消息丢失的场景"><a href="#%E6%B6%88%E6%81%AF%E4%B8%A2%E5%A4%B1%E7%9A%84%E5%9C%BA%E6%99%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>消息丢失的场景</h5>\n<ol>\n<li>生产者发送消息到 MQ 有可能丢失消息</li>\n<li>MQ 收到消息后写入硬盘可能丢失消息</li>\n<li>消息写入硬盘后，硬盘坏了丢失消息</li>\n<li>消费者消费 MQ 也可能丢失消息</li>\n<li>整个 MQ 节点挂了丢失消息</li>\n</ol>\n<h5 id="生产者发送消息时如何保证不丢失？"><a href="#%E7%94%9F%E4%BA%A7%E8%80%85%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF%E6%97%B6%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E4%B8%8D%E4%B8%A2%E5%A4%B1%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>生产者发送消息时如何保证不丢失？</h5>\n<p>解决发送时消息丢失的问题可以采用 RocketMQ 自带的事物消息机制</p>\n<p>事物消息原理：首先生产者会发送一个 half 消息(对原始消息的封装)，该消息对消费者不可见，MQ 通过 ACK 机制返回消息接受状态，生产者执行本地事务并且返回给 MQ 一个状态(Commit、RollBack 等)，如果是 Commit 的话 MQ 就会把消息给到下游，RollBack 的话就会丢弃该消息，状态如果为 UnKnow 的话会过一段时间回查本地事务状态，默认回查 15 次，一直是 UnKnow 状态的话就会丢弃此消息。</p>\n<p>为什么先发一个 half 消息，作用就是先判断下 MQ 有没有问题，服务正不正常。</p>\n<h5 id="mq-收到消息后写入硬盘如何保证不丢失？"><a href="#mq-%E6%94%B6%E5%88%B0%E6%B6%88%E6%81%AF%E5%90%8E%E5%86%99%E5%85%A5%E7%A1%AC%E7%9B%98%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E4%B8%8D%E4%B8%A2%E5%A4%B1%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>MQ 收到消息后写入硬盘如何保证不丢失？</h5>\n<p>数据存盘绕过缓存，改为同步刷盘，这一步需要修改 Broker 的配置文件，将 flushDiskType 改为 <code class="language-text">SYNC_FLUSH</code> 同步刷盘策略，默认的是 <code class="language-text">ASYNC_FLUSH</code> 异步刷盘，一旦同步刷盘返回成功，那么就一定保证消息已经持久化到磁盘中了。</p>\n<h5 id="消息写入硬盘后，硬盘坏了如何保证不丢失？"><a href="#%E6%B6%88%E6%81%AF%E5%86%99%E5%85%A5%E7%A1%AC%E7%9B%98%E5%90%8E%EF%BC%8C%E7%A1%AC%E7%9B%98%E5%9D%8F%E4%BA%86%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E4%B8%8D%E4%B8%A2%E5%A4%B1%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>消息写入硬盘后，硬盘坏了如何保证不丢失？</h5>\n<p>为了保证磁盘损坏导致丢失数据，RocketMQ 采用主从机构，集群部署，Leader 中的数据在多个 Follower 中都存有备份，防止单点故障导致数据丢失。</p>\n<p>Master 节点挂了怎么办？Master 节点挂了之后 DLedger 登场</p>\n<ul>\n<li>接管 MQ 的 commitLog</li>\n<li>选举从节点</li>\n<li>文件复制 uncommited 状态，多半从节点收到之后改为 commited</li>\n</ul>\n<h5 id="消费者消费-mq-如何保证不丢失？"><a href="#%E6%B6%88%E8%B4%B9%E8%80%85%E6%B6%88%E8%B4%B9-mq-%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E4%B8%8D%E4%B8%A2%E5%A4%B1%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>消费者消费 MQ 如何保证不丢失？</h5>\n<ol>\n<li>如果是网络问题导致的消费失败可以进行重试机制，默认每条消息重试 16 次</li>\n<li>多线程异步消费失败，MQ 认为已经消费成功但是实际上对于业务逻辑来说消息是没有落地的，解决方案就是按照 mq 官方推荐的先执行本地事务再返回成功状态。</li>\n</ol>\n<h5 id="整个-mq-节点挂了如何保证不丢失？"><a href="#%E6%95%B4%E4%B8%AA-mq-%E8%8A%82%E7%82%B9%E6%8C%82%E4%BA%86%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E4%B8%8D%E4%B8%A2%E5%A4%B1%EF%BC%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>整个 MQ 节点挂了如何保证不丢失？</h5>\n<p>这种极端情况可以消息发送失败之后先存入本地，例如放到缓存中，另外启动一个线程扫描缓存的消息去重试发送。</p>\n<p>// TODO <a href="https://doocs.github.io/advanced-java/#/docs/high-concurrency/how-to-ensure-the-order-of-messages" target="_blank" rel="nofollow noreferrer noopener">https://doocs.github.io/advanced-java/#/docs/high-concurrency/how-to-ensure-the-order-of-messages</a></p>',
excerpt:"高并发架构 消息队列 为什么使用消息队列？ 优点 解耦：通过一个 MQ，Pub/Sub 发布订阅消息这么一个模型，A 系统就跟其它系统彻底解耦了。 异步：任务发到消息队列，由消费者异步消费 削峰：任务发到消息队列，由消费者决定消费速度 缺点 系统可用性降低：MQ…",frontmatter:{date:"2023-09-14 13:47:01",path:"/system-design-deep-learn/",tags:"后端, 系统设计, 读书笔记",title:"系统设计深入学习",draft:null}}},pathContext:{mainPostPath:"/distributed-services-practice-learn/",nextPostPath:"/writing-high-quality-python/",prePostPath:"/system-design-deep-learn/"}}}});