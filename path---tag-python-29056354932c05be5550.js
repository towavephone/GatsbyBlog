webpackJsonp([0xdf3ab86e1980],{1452:function(n,s){n.exports={data:{site:{siteMetadata:{title:"女王控的博客",description:'前端工程师，黑猫女王控，欢迎勾搭，技术相关<a href="https://github.com/towavephone" target="_blank">@towavephone</a>，QQ闲聊<a href="tencent://AddContact/?fromId=45&fromSubId=1&subcmd=all&uin=634407147&website=www.oicqzone.com">@towave</a>，bili关注<a href="https://space.bilibili.com/11507708#/" target="_blank">@towave</a>',siteUrl:"https://blog.towavephone.com"}}},pathContext:{posts:[{excerpt:"培养 Pythonic 思维 第 1 条：查询自己使用的 Python 版本 Python 2 于 2020 年 1 月 1 日退场，到这一刻，所有的 bug 修复、安全补丁，以及特性向后移植都会停止。此后，如果你还坚持使用 Python 2，那么会面临很多不利因素，因为它不会再获得正式的维护了。深度依赖 Python 2 代码库的开发者可以考虑用 2to3（Python 预装的工具）与  six  这样的工具过渡到 Python 3。 第 2 条：遵循 PEP…",html:'<h1 id="培养-pythonic-思维"><a href="#%E5%9F%B9%E5%85%BB-pythonic-%E6%80%9D%E7%BB%B4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>培养 Pythonic 思维</h1>\n<h2 id="第-1-条：查询自己使用的-python-版本"><a href="#%E7%AC%AC-1-%E6%9D%A1%EF%BC%9A%E6%9F%A5%E8%AF%A2%E8%87%AA%E5%B7%B1%E4%BD%BF%E7%94%A8%E7%9A%84-python-%E7%89%88%E6%9C%AC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 1 条：查询自己使用的 Python 版本</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87825538899543080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ python --version\n\\$ python -V\n\\$ python3 --version\n\\$ python3 -V`, `87825538899543080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ python --version\n$ python -V\n$ python3 --version\n$ python3 -V</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46111043738085430000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> import sys\n>>> print(sys.version_info)\nsys.version_info(major=3, minor=6, micro=15, releaselevel=\'final\', serial=0)\n>>> print(sys.version)\n3.6.15 (default, Apr 20 2022, 13:05:41)\n[GCC 5.4.0 20160609]`, `46111043738085430000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> <span class="token function">import</span> sys\n<span class="token operator">>></span><span class="token operator">></span> print<span class="token punctuation">(</span>sys.version_info<span class="token punctuation">)</span>\nsys.version_info<span class="token punctuation">(</span>major<span class="token operator">=</span><span class="token number">3</span>, <span class="token assign-left variable">minor</span><span class="token operator">=</span><span class="token number">6</span>, <span class="token assign-left variable">micro</span><span class="token operator">=</span><span class="token number">15</span>, <span class="token assign-left variable">releaselevel</span><span class="token operator">=</span><span class="token string">\'final\'</span>, <span class="token assign-left variable">serial</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> print<span class="token punctuation">(</span>sys.version<span class="token punctuation">)</span>\n<span class="token number">3.6</span>.15 <span class="token punctuation">(</span>default, Apr <span class="token number">20</span> <span class="token number">2022</span>, <span class="token number">13</span>:05:41<span class="token punctuation">)</span>\n<span class="token punctuation">[</span>GCC <span class="token number">5.4</span>.0 <span class="token number">20160609</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Python 2 于 2020 年 1 月 1 日退场，到这一刻，所有的 bug 修复、安全补丁，以及特性向后移植都会停止。此后，如果你还坚持使用 Python 2，那么会面临很多不利因素，因为它不会再获得正式的维护了。深度依赖 Python 2 代码库的开发者可以考虑用 2to3（Python 预装的工具）与 <a href="https://six.readthedocs.io/" target="_blank" rel="nofollow noreferrer noopener">six</a> 这样的工具过渡到 Python 3。</p>\n<h2 id="第-2-条：遵循-pep-8-风格指南"><a href="#%E7%AC%AC-2-%E6%9D%A1%EF%BC%9A%E9%81%B5%E5%BE%AA-pep-8-%E9%A3%8E%E6%A0%BC%E6%8C%87%E5%8D%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 2 条：遵循 PEP 8 风格指南</h2>\n<h3 id="与空白有关的建议"><a href="#%E4%B8%8E%E7%A9%BA%E7%99%BD%E6%9C%89%E5%85%B3%E7%9A%84%E5%BB%BA%E8%AE%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>与空白有关的建议</h3>\n<p>在 Python 中，空白（whitespace）在语法上相当重要。Python 程序员对空白字符的用法尤其在意，因为它们会影响代码的清晰程度。在这方面，大家应该遵循以下几条建议。</p>\n<ul>\n<li>用空格（space）表示缩进，而不要用制表符（tab）。</li>\n<li>和语法相关的每一层缩进都用 4 个空格表示。</li>\n<li>每行不超过 79 个字符。</li>\n<li>对于占据多行的长表达式来说，除了首行之外的其余各行都应该在通常的缩进级别之上再加 4 个空格。</li>\n<li>在同一份文件中，函数与类之间用两个空行隔开。</li>\n<li>在同一个类中，方法与方法之间用一个空行隔开。</li>\n<li>使用字典时，键与冒号之间不加空格，写在同一行的冒号和值之间应该加一个空格。</li>\n<li>给变量赋值时，赋值符号的左边和右边各加一个空格，并且只加一个空格就好。</li>\n<li>给变量的类型做注解（annotation）时，不要把变量名和冒号隔开，但在类型信息前应该有一个空格。</li>\n</ul>\n<h3 id="与命名有关的建议"><a href="#%E4%B8%8E%E5%91%BD%E5%90%8D%E6%9C%89%E5%85%B3%E7%9A%84%E5%BB%BA%E8%AE%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>与命名有关的建议</h3>\n<p>PEP 8 建议采用不同的方式来给 Python 代码中的各个部分命名，这样在阅读代码时，就可以根据这些名称看出它们在 Python 语言中的角色。遵循以下与命名相关的建议。</p>\n<ul>\n<li>函数、变量及属性用小写字母来拼写，各单词之间用下划线相连，例如：<code class="language-text">lowercase_underscore</code>。</li>\n<li>受保护的实例属性，用一个下划线开头，例如：<code class="language-text">_leading_underscore</code>。</li>\n<li>私有的实例属性，用两个下划线开头，例如：<code class="language-text">__double_leading_underscore</code>。</li>\n<li>类（包括异常）命名时，每个单词的首字母均大写，例如：CapitalizedWord。</li>\n<li>模块级别的常量，所有字母都大写，各单词之间用下划线相连，例如：<code class="language-text">ALL_CAPS</code>。</li>\n<li>类中的实例方法，应该把第一个参数命名为 self，用来表示该对象本身。</li>\n<li>类方法的第一个参数，应该命名为 cls，用来表示这个类本身。</li>\n</ul>\n<h3 id="与表达式和语句有关的建议"><a href="#%E4%B8%8E%E8%A1%A8%E8%BE%BE%E5%BC%8F%E5%92%8C%E8%AF%AD%E5%8F%A5%E6%9C%89%E5%85%B3%E7%9A%84%E5%BB%BA%E8%AE%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>与表达式和语句有关的建议</h3>\n<p>The Zen of Python 中提到：<code class="language-text">每件事都应该有简单的做法，而且最好只有一种</code>。PEP 8 就试着运用这个理念，来规范表达式和语句的写法。</p>\n<ul>\n<li>采用行内否定，即把否定词直接写在要否定的内容前面，而不要放在整个表达式的前面，例如应该写 <code class="language-text">if a is not b</code>，而不是 <code class="language-text">if not a is b</code>。</li>\n<li>不要通过长度判断容器或序列是不是空的，例如不要通过 <code class="language-text">if len(somelist) == 0</code> 判断 somelist 是否为 <code class="language-text">[]</code> 或 <code class="language-text">&#39;&#39;</code> 等空值，而是应该采用 <code class="language-text">if not somelist</code> 这样的写法来判断，因为 Python 会把空值自动评估为 False。</li>\n<li>如果要判断容器或序列里面有没有内容（比如要判断 somelist 是否为 <code class="language-text">[1]</code> 或 <code class="language-text">&#39;hi&#39;</code> 这样非空的值），也不应该通过长度来判断，而是应该采用 <code class="language-text">if somelist</code> 语句，因为 Python 会把非空的值自动判定为 True。</li>\n<li>不要把 if 语句、for 循环、while 循环及 except 复合语句挤在一行。应该把这些语句分成多行来写，这样更加清晰。</li>\n<li>如果表达式一行写不下，可以用括号将其括起来，而且要适当地添加换行与缩进以便于阅读。多行的表达式，应该用括号括起来，而不要用 <code class="language-text">\\</code> 符号续行。</li>\n</ul>\n<h3 id="与引入有关的建议"><a href="#%E4%B8%8E%E5%BC%95%E5%85%A5%E6%9C%89%E5%85%B3%E7%9A%84%E5%BB%BA%E8%AE%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>与引入有关的建议</h3>\n<p>PEP 8 对于怎样在代码中引入并使用模块，给出了下面几条建议。</p>\n<ul>\n<li>import 语句（含 <code class="language-text">from x import y</code>）总是应该放在文件开头。</li>\n<li>引入模块时，总是应该使用绝对名称，而不应该根据当前模块路径来使用相对名称。例如，要引入 bar 包中的 foo 模块，应该完整地写出 <code class="language-text">from bar import foo</code>，即便当前路径为 bar 包里，也不应该简写为 <code class="language-text">import foo</code>。</li>\n<li>如果一定要用相对名称来编写 import 语句，那就应该明确地写成：<code class="language-text">from . import foo</code>。文件中的 import 语句应该按顺序划分成三个部分：首先引入标准库里的模块，然后引入第三方模块，最后引入自己的模块。属于同一个部分的 import 语句按字母顺序排列。</li>\n</ul>\n<h2 id="第-3-条：了解-bytes-与-str-的区别"><a href="#%E7%AC%AC-3-%E6%9D%A1%EF%BC%9A%E4%BA%86%E8%A7%A3-bytes-%E4%B8%8E-str-%E7%9A%84%E5%8C%BA%E5%88%AB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 3 条：了解 bytes 与 str 的区别</h2>\n<p>Python 有两种类型可以表示字符序列：一种是 bytes，另一种是 str。</p>\n<p>bytes 实例包含的是原始数据，即 8 位的无符号值（通常按照 ASCII 编码标准来显示）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34329536642295767000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = b\'h\\x65llo\'\nprint(list(a))\nprint(a)\n\n>>>\n[104, 101, 108, 108, 111]\nb\'hello\'`, `34329536642295767000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token string">b\'h\\x65llo\'</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">104</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">108</span><span class="token punctuation">,</span> <span class="token number">108</span><span class="token punctuation">,</span> <span class="token number">111</span><span class="token punctuation">]</span>\n<span class="token string">b\'hello\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>str 实例包含的是 Unicode 码点（code point，也叫作代码点），这些码点与人类语言之中的文本字符相对应。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78593472236218900000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = \'a\\u0300 propos\'\nprint(list(a))\nprint(a)\n\n>>>\n[\'a\', \'̀\', \' \', \'p\', \'r\', \'o\', \'p\', \'o\', \'s\']\nà propos`, `78593472236218900000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token string">\'a\\u0300 propos\'</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'̀\'</span><span class="token punctuation">,</span> <span class="token string">\' \'</span><span class="token punctuation">,</span> <span class="token string">\'p\'</span><span class="token punctuation">,</span> <span class="token string">\'r\'</span><span class="token punctuation">,</span> <span class="token string">\'o\'</span><span class="token punctuation">,</span> <span class="token string">\'p\'</span><span class="token punctuation">,</span> <span class="token string">\'o\'</span><span class="token punctuation">,</span> <span class="token string">\'s\'</span><span class="token punctuation">]</span>\nà propos</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>两种不同的字符类型与 Python 中两种常见的使用情况相对应：</p>\n<ul>\n<li>开发者需要操作原始的 8 位值序列，序列里面的这些 8 位值合起来表示一个应该按 UTF-8 或其他标准编码的字符串。</li>\n<li>开发者需要操作通用的 Unicode 字符串，而不是操作某种特定编码的字符串。</li>\n</ul>\n<p>我们通常需要编写两个辅助函数，以便在这两种情况之间转换，确保输入值类型符合开发者的预期形式。</p>\n<p>第一个辅助函数接受 bytes 或 str 实例，并返回 str：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6728111175474449000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def to_str(bytes_or_str):\n    if isinstance(bytes_or_str, bytes):\n        value = bytes_or_str.decode(\'utf-8\')\n    else:\n        value = bytes_or_str\n    return value # Instance of str\n\nprint(repr(to_str(b\'foo\')))\nprint(repr(to_str(\'bar\')))\n\n>>>\n\'foo\'\n\'bar\'`, `6728111175474449000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">to_str</span><span class="token punctuation">(</span>bytes_or_str<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>bytes_or_str<span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        value <span class="token operator">=</span> bytes_or_str<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">\'utf-8\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        value <span class="token operator">=</span> bytes_or_str\n    <span class="token keyword">return</span> value <span class="token comment"># Instance of str</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">repr</span><span class="token punctuation">(</span>to_str<span class="token punctuation">(</span><span class="token string">b\'foo\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">repr</span><span class="token punctuation">(</span>to_str<span class="token punctuation">(</span><span class="token string">\'bar\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token string">\'foo\'</span>\n<span class="token string">\'bar\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>第二个辅助函数也接受 bytes 或 str 实例，但它返回的是 bytes：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20272519217710694000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def to_bytes(bytes_or_str):\n    if isinstance(bytes_or_str, str):\n        value = bytes_or_str.encode(\'utf-8\')\n    else:\n        value = bytes_or_str\n    return value # Instance of bytes\n\nprint(repr(to_bytes(b\'foo\')))\nprint(repr(to_bytes(\'bar\')))\n\n>>>\nb\'foo\'\nb\'bar\'`, `20272519217710694000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">to_bytes</span><span class="token punctuation">(</span>bytes_or_str<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>bytes_or_str<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        value <span class="token operator">=</span> bytes_or_str<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">\'utf-8\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        value <span class="token operator">=</span> bytes_or_str\n    <span class="token keyword">return</span> value <span class="token comment"># Instance of bytes</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">repr</span><span class="token punctuation">(</span>to_bytes<span class="token punctuation">(</span><span class="token string">b\'foo\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">repr</span><span class="token punctuation">(</span>to_bytes<span class="token punctuation">(</span><span class="token string">\'bar\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token string">b\'foo\'</span>\n<span class="token string">b\'bar\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 Python 中使用原始的 8 位值与 Unicode 字符串时，有两个问题要注意。</p>\n<p>第一个问题是，bytes 与 str 这两种类型似乎是以相同的方式工作的，但其实例并不相互兼容，所以在传递字符序列的时候必须考虑好其类型。</p>\n<p>可以用 + 操作符将 bytes 添加到 bytes，str 也可以这样。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66998821746523120000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`print(b\'one\' + b\'two\')\nprint(\'one\' + \'two\')\n\n>>>\nb\'onetwo\'\nonetwo`, `66998821746523120000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">b\'one\'</span> <span class="token operator">+</span> <span class="token string">b\'two\'</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'one\'</span> <span class="token operator">+</span> <span class="token string">\'two\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token string">b\'onetwo\'</span>\nonetwo</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是不能将 str 实例添加到 bytes 实例：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9095008650272707000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`b\'one\' + \'two\'\n\n>>>\nTraceback ...\nTypeError: can\'t concat str to bytes`, `9095008650272707000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token string">b\'one\'</span> <span class="token operator">+</span> <span class="token string">\'two\'</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> can\'t concat <span class="token builtin">str</span> to <span class="token builtin">bytes</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>也不能将 bytes 实例添加到 str 实例：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26727603181018410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\'one\' + b\'two\'\n\n>>>\nTraceback ...\nTypeError: can only concatenate str (not &quot;bytes&quot;) to str`, `26727603181018410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token string">\'one\'</span> <span class="token operator">+</span> <span class="token string">b\'two\'</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> can only concatenate <span class="token builtin">str</span> <span class="token punctuation">(</span><span class="token keyword">not</span> <span class="token string">"bytes"</span><span class="token punctuation">)</span> to <span class="token builtin">str</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>bytes 与 bytes 之间可以用二元操作符（binary operator）来比较大小，str 与 str 之间也可以：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17798745364675717000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`assert b\'red\' > b\'blue\'\nassert \'red\' > \'blue\'`, `17798745364675717000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">assert</span> <span class="token string">b\'red\'</span> <span class="token operator">></span> <span class="token string">b\'blue\'</span>\n<span class="token keyword">assert</span> <span class="token string">\'red\'</span> <span class="token operator">></span> <span class="token string">\'blue\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>但是 str 实例不能与 bytes 实例比较：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21782500107026293000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`assert \'red\' > b\'blue\'\n\n>>>\nTraceback ...\nTypeError: \'>\' not supported between instances of \'str\' and \'bytes\'`, `21782500107026293000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">assert</span> <span class="token string">\'red\'</span> <span class="token operator">></span> <span class="token string">b\'blue\'</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> <span class="token string">\'>\'</span> <span class="token keyword">not</span> supported between instances of <span class="token string">\'str\'</span> <span class="token keyword">and</span> <span class="token string">\'bytes\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>反过来也一样，也就是说 bytes 实例不能与 str 实例比较：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1521015224947497200"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`assert b\'blue\' < \'red\'\n\n>>>\nTraceback ...\nTypeError: \'<\' not supported between instances of \'bytes\' and \'str\'`, `1521015224947497200`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">assert</span> <span class="token string">b\'blue\'</span> <span class="token operator">&lt;</span> <span class="token string">\'red\'</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> <span class="token string">\'&lt;\'</span> <span class="token keyword">not</span> supported between instances of <span class="token string">\'bytes\'</span> <span class="token keyword">and</span> <span class="token string">\'str\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>判断 bytes 与 str 实例是否相等，总是会评估为假（False），即便这两个实例表示的字符完全相同，它们也不相等。例如，在下面这个例子里，它们表示的字符串都相当于 ASCII 编码之中的 foo。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95094202898594230000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`print(b\'foo\' == \'foo\')\n\n>>>\nFalse`, `95094202898594230000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">b\'foo\'</span> <span class="token operator">==</span> <span class="token string">\'foo\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token boolean">False</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>两种类型的实例都可以出现在 % 操作符的右侧，用来替换左侧那个格式字符串（format string）里面的 %s。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52264590143890310000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`print(b\'red %s\' % b\'blue\')\nprint(\'red %s\' % \'blue\')\n\n>>>\nb\'red blue\'\nred blue`, `52264590143890310000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">b\'red %s\'</span> <span class="token operator">%</span> <span class="token string">b\'blue\'</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'red %s\'</span> <span class="token operator">%</span> <span class="token string">\'blue\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token string">b\'red blue\'</span>\nred blue</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果格式字符串是 bytes 类型，那么不能用 str 实例来替换其中的 %s，因为 Python 不知道这个 str 应该按照什么方案来编码。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9545237226023428000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`print(b\'red %s\' % \'blue\')\n\n>>>\nTraceback ...\nTypeError: %b requires a bytes-like object, or an object that implements _bytes_, not \'str\'`, `9545237226023428000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">b\'red %s\'</span> <span class="token operator">%</span> <span class="token string">\'blue\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> <span class="token operator">%</span>b requires a <span class="token builtin">bytes</span><span class="token operator">-</span>like <span class="token builtin">object</span><span class="token punctuation">,</span> <span class="token keyword">or</span> an <span class="token builtin">object</span> that implements _bytes_<span class="token punctuation">,</span> <span class="token keyword">not</span> <span class="token string">\'str\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但反过来却可以，也就是说如果格式字符串是 str 类型，则可以用 bytes 实例来替换其中的 %s，问题是这可能跟你想要的结果不一样。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14177901427128670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`print(\'red %s\' % b\'blue\')\n\n>>>\nred b\'blue\'`, `14177901427128670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'red %s\'</span> <span class="token operator">%</span> <span class="token string">b\'blue\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nred <span class="token string">b\'blue\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样做，会让系统在 bytes 实例上面调用 <code class="language-text">__repr__</code> 方法（参见第 75 条），然后用这次调用所得到的结果替换格式字符串里的 %s，因此程序会直接输出 <code class="language-text">b&#39;blue&#39;</code>，而不是像你想的那样，输出 blue 本身。</p>\n<p>第二个问题发生在操作文件句柄的时候，这里的句柄指由内置的 open 函数返回的句柄。这样的句柄默认需要使用 Unicode 字符串操作，而不能采用原始的 bytes。习惯了 Python 2 的开发者，尤其容易碰到这个问题，进而导致程序出现奇怪的错误。例如，向文件写入二进制数据的时候，下面这种写法其实是错误的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8984088721948735000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`with open(\'data.bin\', \'w\') as f:\n   f.write(b\'\\xf1\\xf2\\xf3\\xf4\\xf5\')\n\n>>>\nTraceback ...\nTypeError: write() argument must be str, not bytes`, `8984088721948735000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'data.bin\'</span><span class="token punctuation">,</span> <span class="token string">\'w\'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>\n   f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">b\'\\xf1\\xf2\\xf3\\xf4\\xf5\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> write<span class="token punctuation">(</span><span class="token punctuation">)</span> argument must be <span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token keyword">not</span> <span class="token builtin">bytes</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>程序发生异常是因为在调用 open 函数时，指定的是 <code class="language-text">&#39;w&#39;</code> 模式，所以系统要求必须以文本模式写入。如果想用二进制模式，那应该指定 <code class="language-text">&#39;wb&#39;</code> 才对。在文本模式下，write 方法接受的是包含 Unicode 数据的 str 实例，不是包含二进制数据的 bytes 实例。所以，我们得把模式改成 <code class="language-text">&#39;wb&#39;</code> 来解决该问题。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76066613998127820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`with open(\'data.bin\', \'wb\') as f:\n   f.write(b\'\\xf1\\xf2\\xf3\\xf4\\xf5\')`, `76066613998127820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'data.bin\'</span><span class="token punctuation">,</span> <span class="token string">\'wb\'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>\n   f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">b\'\\xf1\\xf2\\xf3\\xf4\\xf5\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>读取文件的时候也有类似的问题。例如，如果要把刚才写入的二进制文件读出来，那么不能用下面这种写法，同样需要改成 <code class="language-text">&#39;rb&#39;</code></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22907739540545990000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`with open(\'data.bin\', \'r\') as f:\n   data = f.read()\n\n>>>\nTraceback ...\nUnicodeDecodeError: \'utf-8\' codec can\'t decode byte 0xf1 in position 0: invalid continuation byte`, `22907739540545990000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'data.bin\'</span><span class="token punctuation">,</span> <span class="token string">\'r\'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>\n   data <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nUnicodeDecodeError<span class="token punctuation">:</span> <span class="token string">\'utf-8\'</span> codec can\'t decode byte <span class="token number">0xf1</span> <span class="token keyword">in</span> position <span class="token number">0</span><span class="token punctuation">:</span> invalid continuation byte</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>另一种改法是在调用 open 函数的时候，通过 encoding 参数明确指定编码标准，以确保平台特有的一些行为不会干扰代码的运行效果。例如，假设刚才写到文件里的那些二进制数据表示的是一个采用 ‘cp1252’ 标准（cp1252 是一种老式的 Windows 编码方案）来编码的字符串，则可以这样写</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77451435184095170000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`with open(\'data.bin\', \'r\', encoding=\'cp1252\') as f:\n   data f.read()\n\nassert data == \'ioooδ\'`, `77451435184095170000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'data.bin\'</span><span class="token punctuation">,</span> <span class="token string">\'r\'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">\'cp1252\'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>\n   data f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token keyword">assert</span> data <span class="token operator">==</span> <span class="token string">\'ioooδ\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样程序就不会出现异常了，但返回的字符串也与读取原始字节数据所返回的有很大区别。通过这个例子，我们要提醒自己注意当前操作系统默认的编码标准（可以执行 <code class="language-text">python3 -c &#39;import locale; print(locale.getpreferredencoding())&#39;</code> 命令查看），了解它与你所期望的是否一致。如果不确定，那就在调用 open 时明确指定 encoding 参数。</p>\n<h2 id="第-4-条：用支持插值的-f-string-取代-c-风格的格式字符串与-strformat-方法"><a href="#%E7%AC%AC-4-%E6%9D%A1%EF%BC%9A%E7%94%A8%E6%94%AF%E6%8C%81%E6%8F%92%E5%80%BC%E7%9A%84-f-string-%E5%8F%96%E4%BB%A3-c-%E9%A3%8E%E6%A0%BC%E7%9A%84%E6%A0%BC%E5%BC%8F%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%B8%8E-strformat-%E6%96%B9%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 4 条：用支持插值的 f-string 取代 C 风格的格式字符串与 str.format 方法</h2>\n<p>Python 里面最常用的字符串格式化方式是采用 % 格式化操作符。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66392640883933490000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = 0b10111011\nb = 0xc5f\nprint(\'Binary is %d, hex is %d\' % (a, b))\n\n>>>\nBinary is 187, hex is 3167`, `66392640883933490000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token number">0b10111011</span>\nb <span class="token operator">=</span> <span class="token number">0xc5f</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Binary is %d, hex is %d\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBinary <span class="token keyword">is</span> <span class="token number">187</span><span class="token punctuation">,</span> <span class="token builtin">hex</span> <span class="token keyword">is</span> <span class="token number">3167</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是 C 风格的格式字符串，在 Python 里有四个缺点。</p>\n<ol>\n<li>\n<p>如果 % 右侧那个元组里面的值在类型或顺序上有变化，那么程序可能会因为转换类型时发生不兼容问题而出现错误。例如，下面这个简单的格式化表达式是正确的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72777291329423655000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`key = \'my_var\'\nvalue = 1.234\nformatted = \'%-10s = %.2f\' % (key, value)\nprint(formatted)\n\n>>>\nmy_var     = 1.23`, `72777291329423655000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">key <span class="token operator">=</span> <span class="token string">\'my_var\'</span>\nvalue <span class="token operator">=</span> <span class="token number">1.234</span>\nformatted <span class="token operator">=</span> <span class="token string">\'%-10s = %.2f\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>formatted<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nmy_var     <span class="token operator">=</span> <span class="token number">1.23</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但如果把 key 跟 value 互换位置，那么程序就会在运行时出现异常。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95132981046238450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`reordered_tuple = \'%-10s = %.2f\' % (value, key)\n\n>>>\nTraceback ...\nTypeError: must be real number, not str`, `95132981046238450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">reordered_tuple <span class="token operator">=</span> <span class="token string">\'%-10s = %.2f\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>value<span class="token punctuation">,</span> key<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> must be real number<span class="token punctuation">,</span> <span class="token keyword">not</span> <span class="token builtin">str</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果 % 右侧的写法不变，但左侧那个格式字符串里面的两个说明符对调了顺序，那么程序同样会发生这个错误。</p>\n</li>\n<li>\n<p>在填充模板之前，经常要先对准备填写进去的这个值稍微做一些处理，但这样一来，整个表达式可能就会写得很长，让人觉得比较混乱。下面这段代码用来罗列厨房里的各种食材，现在的这种写法并没有对填入格式字符串里面的那三个值（也就是食材的编号 i、食材的名称 item，以及食材的数量 count）预先做出调整。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75782829114975580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pantry = [\n  (\'avocados\', 1.25),\n  (\'bananas\', 2.5),\n  (\'cherries\', 15),\n]\n\nfor i, (item, count) in enumerate(pantry):\n  print(\'#%d: %-10s = %.2f\' % (i, item, count))\n\n>>>\n#0: avocados   = 1.25\n#1: bananas    = 2.50\n#2: cherries   = 15.00`, `75782829114975580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">pantry <span class="token operator">=</span> <span class="token punctuation">[</span>\n  <span class="token punctuation">(</span><span class="token string">\'avocados\'</span><span class="token punctuation">,</span> <span class="token number">1.25</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n  <span class="token punctuation">(</span><span class="token string">\'bananas\'</span><span class="token punctuation">,</span> <span class="token number">2.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n  <span class="token punctuation">(</span><span class="token string">\'cherries\'</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">]</span>\n\n<span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>item<span class="token punctuation">,</span> count<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>pantry<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'#%d: %-10s = %.2f\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> item<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token comment">#0: avocados   = 1.25</span>\n<span class="token comment">#1: bananas    = 2.50</span>\n<span class="token comment">#2: cherries   = 15.00</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果想让打印出来的信息更好懂，那可能得把这几个值稍微调整一下，但是调整之后，% 操作符右侧的那个三元组就特别长，所以需要多行拆分才能写得下，这会影响程序的可读性。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6259313139676226000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pantry = [\n  (\'avocados\', 1.25),\n  (\'bananas\', 2.5),\n  (\'cherries\', 15),\n]\n\nfor i, (item, count) in enumerate(pantry):\n  print(\'#%d: %-10s = %d\' % (\n     i + 1,\n     item.title(),\n     round(count)))\n\n>>>\n#1: Avocados   = 1\n#2: Bananas    = 2\n#3: Cherries   = 15`, `6259313139676226000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">pantry <span class="token operator">=</span> <span class="token punctuation">[</span>\n  <span class="token punctuation">(</span><span class="token string">\'avocados\'</span><span class="token punctuation">,</span> <span class="token number">1.25</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n  <span class="token punctuation">(</span><span class="token string">\'bananas\'</span><span class="token punctuation">,</span> <span class="token number">2.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n  <span class="token punctuation">(</span><span class="token string">\'cherries\'</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">]</span>\n\n<span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>item<span class="token punctuation">,</span> count<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>pantry<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'#%d: %-10s = %d\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>\n     i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>\n     item<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n     <span class="token builtin">round</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token comment">#1: Avocados   = 1</span>\n<span class="token comment">#2: Bananas    = 2</span>\n<span class="token comment">#3: Cherries   = 15</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>如果想用同一个值来填充格式字符串里的多个位置，那么必须在 % 操作符右侧的元组中相应地多次重复该值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46815249002269300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`template = \'%s loves food. See %s cook.\'\nname = \'Max\'\nformatted = template % (name, name)\nprint(formatted)\n\n>>>\nMax loves food. See Max cook.`, `46815249002269300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">template <span class="token operator">=</span> <span class="token string">\'%s loves food. See %s cook.\'</span>\nname <span class="token operator">=</span> <span class="token string">\'Max\'</span>\nformatted <span class="token operator">=</span> template <span class="token operator">%</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> name<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>formatted<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nMax loves food<span class="token punctuation">.</span> See Max cook<span class="token punctuation">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果想在填充之前把这个值修改一下，那么必须同时修改多处才行，这尤其烦人，且容易出错。例如，如果这次要填的不是 name 而是 name.title()，那就必须提醒自己，要把所有的 name 都改成 name.title()。若是有的地方改了，有的地方没改，那输出的信息可能就不一致了。</p>\n<p>为了解决上面提到的一些问题，Python 的 % 操作符允许我们用 dict 取代 tuple，这样的话，我们就可以让格式字符串里面的说明符与 dict 里面的键以相应的名称对应起来，例如 %(key)s 这个说明符，意思就是用字符串（s）来表示 dict 里面名为 key 的那个键所保存的值。下面通过这种办法解决刚才讲的第一个缺点，也就是 % 操作符两侧的顺序不匹配问题。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82332762207982400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`key = \'my_var\'\nvalue = 1.234\nold_way = \'%-10s = %.2f\' % (key, value)\n\nnew_way = \'%(key)-10s = %(value).2f\' % {\n  \'key\': key, \'value\': value}  # Original\n\nreordered = \'%(key)-10s = %(value).2f\' % {\n  \'value\': value, \'key\': key}  # Swapped\n\nassert old_way == new_way == reordered`, `82332762207982400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">key <span class="token operator">=</span> <span class="token string">\'my_var\'</span>\nvalue <span class="token operator">=</span> <span class="token number">1.234</span>\nold_way <span class="token operator">=</span> <span class="token string">\'%-10s = %.2f\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n\nnew_way <span class="token operator">=</span> <span class="token string">\'%(key)-10s = %(value).2f\'</span> <span class="token operator">%</span> <span class="token punctuation">{</span>\n  <span class="token string">\'key\'</span><span class="token punctuation">:</span> key<span class="token punctuation">,</span> <span class="token string">\'value\'</span><span class="token punctuation">:</span> value<span class="token punctuation">}</span>  <span class="token comment"># Original</span>\n\nreordered <span class="token operator">=</span> <span class="token string">\'%(key)-10s = %(value).2f\'</span> <span class="token operator">%</span> <span class="token punctuation">{</span>\n  <span class="token string">\'value\'</span><span class="token punctuation">:</span> value<span class="token punctuation">,</span> <span class="token string">\'key\'</span><span class="token punctuation">:</span> key<span class="token punctuation">}</span>  <span class="token comment"># Swapped</span>\n\n<span class="token keyword">assert</span> old_way <span class="token operator">==</span> new_way <span class="token operator">==</span> reordered</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种写法还可以解决刚才讲的第三个缺点，也就是用同一个值替换多个格式说明符的问题。改用这种写法之后，我们就不用在 % 操作符右侧重复这个值了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82100302501212770000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`name = \'Max\'\ntemplate = \'%s loves food .See %s cook.\'\nbefore = template % (name, name)  # Tuple\ntemplate = \'%(name)s loves food .See %(name)s cook.\'\nafter = template % {\'name\': name}  # Dictionary\nassert before == after`, `82100302501212770000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">name <span class="token operator">=</span> <span class="token string">\'Max\'</span>\ntemplate <span class="token operator">=</span> <span class="token string">\'%s loves food .See %s cook.\'</span>\nbefore <span class="token operator">=</span> template <span class="token operator">%</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> name<span class="token punctuation">)</span>  <span class="token comment"># Tuple</span>\ntemplate <span class="token operator">=</span> <span class="token string">\'%(name)s loves food .See %(name)s cook.\'</span>\nafter <span class="token operator">=</span> template <span class="token operator">%</span> <span class="token punctuation">{</span><span class="token string">\'name\'</span><span class="token punctuation">:</span> name<span class="token punctuation">}</span>  <span class="token comment"># Dictionary</span>\n<span class="token keyword">assert</span> before <span class="token operator">==</span> after</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是，这种写法会让刚才讲的第二个缺点变得更加严重，因为字典格式字符串的引入，我们必须给每一个值都定义键名，而且要在键名的右侧加冒号，格式化表达式变得更加冗长，看起来也更加混乱。我们把不采用 dict 的写法与采用 dict 的写法对比一下，可以更明确地意识到这种写法的缺点。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19682686826540930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pantry = [\n(\'avocados\', 1.25),\n(\'bananas\', 2.5),\n(\'cherries\', 15),\n]\n\nfor i, (item, count) in enumerate(pantry):\n  before = \'#%d: %-10s = %d\' % (\n     i + 1,\n     item.title(),\n     round(count)\n  )\n  after = \'#%(loop)d: %(item)-10s = %(count)d\' % {\n     \'loop\': i + 1,\n     \'item\': item.title(),\n     \'count\': round(count),\n  }\n\n  assert before == after`, `19682686826540930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">pantry <span class="token operator">=</span> <span class="token punctuation">[</span>\n<span class="token punctuation">(</span><span class="token string">\'avocados\'</span><span class="token punctuation">,</span> <span class="token number">1.25</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">(</span><span class="token string">\'bananas\'</span><span class="token punctuation">,</span> <span class="token number">2.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">(</span><span class="token string">\'cherries\'</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">]</span>\n\n<span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>item<span class="token punctuation">,</span> count<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>pantry<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  before <span class="token operator">=</span> <span class="token string">\'#%d: %-10s = %d\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>\n     i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>\n     item<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n     <span class="token builtin">round</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n  <span class="token punctuation">)</span>\n  after <span class="token operator">=</span> <span class="token string">\'#%(loop)d: %(item)-10s = %(count)d\'</span> <span class="token operator">%</span> <span class="token punctuation">{</span>\n     <span class="token string">\'loop\'</span><span class="token punctuation">:</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>\n     <span class="token string">\'item\'</span><span class="token punctuation">:</span> item<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n     <span class="token string">\'count\'</span><span class="token punctuation">:</span> <span class="token builtin">round</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">assert</span> before <span class="token operator">==</span> after</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>把 dict 写到格式化表达式里面会让代码变多。每个键都至少要写两次：一次是在格式说明符中，还有一次是在字典中作为键，另外，定义字典的时候，可能还要专门用一个变量来表示这个键所对应的值，而且这个变量的名称或许也和键名相同，这样算下来就是三次了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76852361878244070000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`soup = \'lentil\'\nformatted = \'Today\\\'s soup is %(soup)s.\' % {\'soup\': soup}\nprint(formatted)\n\n>>>\nToday\'s soup is lentil.`, `76852361878244070000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">soup <span class="token operator">=</span> <span class="token string">\'lentil\'</span>\nformatted <span class="token operator">=</span> <span class="token string">\'Today\\\'s soup is %(soup)s.\'</span> <span class="token operator">%</span> <span class="token punctuation">{</span><span class="token string">\'soup\'</span><span class="token punctuation">:</span> soup<span class="token punctuation">}</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>formatted<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nToday\'s soup <span class="token keyword">is</span> lentil<span class="token punctuation">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>除了要反复写键名，在格式化表达式里面使用 dict 的办法还会让表达式变得特别长，通常必须拆分为多行来写，同时，为了与格式字符串的多行写法相对应，定义字典的时候，也要一行一行地给每个键设定对应的值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7863026977390208000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`menu = {\n\'soup\': \'lentil\',\n\'oyster\': \'kumamoto\',\n\'special\': \'schnitzel\',\n}\n\ntemplate = (\'Today\\\'s soup is %(soup)s, \'\n           \'buy one get two %(oyster)s oysters, \'\n           \'and our special entree is %(special)s.\')\nformatted = template % menu\nprint(formatted)\n\n>>>\nToday\'s soup is lentil, buy one get two kumamoto oysters, and our special entree is schnitzel.`, `7863026977390208000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">menu <span class="token operator">=</span> <span class="token punctuation">{</span>\n<span class="token string">\'soup\'</span><span class="token punctuation">:</span> <span class="token string">\'lentil\'</span><span class="token punctuation">,</span>\n<span class="token string">\'oyster\'</span><span class="token punctuation">:</span> <span class="token string">\'kumamoto\'</span><span class="token punctuation">,</span>\n<span class="token string">\'special\'</span><span class="token punctuation">:</span> <span class="token string">\'schnitzel\'</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\ntemplate <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">\'Today\\\'s soup is %(soup)s, \'</span>\n           <span class="token string">\'buy one get two %(oyster)s oysters, \'</span>\n           <span class="token string">\'and our special entree is %(special)s.\'</span><span class="token punctuation">)</span>\nformatted <span class="token operator">=</span> template <span class="token operator">%</span> menu\n<span class="token keyword">print</span><span class="token punctuation">(</span>formatted<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nToday\'s soup <span class="token keyword">is</span> lentil<span class="token punctuation">,</span> buy one get two kumamoto oysters<span class="token punctuation">,</span> <span class="token keyword">and</span> our special entree <span class="token keyword">is</span> schnitzel<span class="token punctuation">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>为了查看格式字符串中的说明符究竟对应于字典里的哪个键，必须在这两段代码之间来回跳跃，这会令人难以发现其中的 bug。如果要对键名稍做修改，那么必须同步修改格式字符串里的说明符，这更让代码变得相当烦琐，可读性更差。</p>\n</li>\n</ol>\n<h3 id="内置的-format-函数与-str-类的-format-方法"><a href="#%E5%86%85%E7%BD%AE%E7%9A%84-format-%E5%87%BD%E6%95%B0%E4%B8%8E-str-%E7%B1%BB%E7%9A%84-format-%E6%96%B9%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>内置的 format 函数与 str 类的 format 方法</h3>\n<p>Python 3 添加了高级字符串格式化（advanced string formatting）机制，它的表达能力比老式 C 风格的格式字符串要强，且不再使用 % 操作符。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53083963885291500000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = 1234.5678\nformatted = format(a, \',.2f\')\nprint(formatted)\nb = \'my string\'\nformatted = format(b, \'^20s\')\nprint(\'*\', formatted, \'*\')\n\n>>>\n1,234.57\n*      my string       *`, `53083963885291500000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token number">1234.5678</span>\nformatted <span class="token operator">=</span> <span class="token builtin">format</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token string">\',.2f\'</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>formatted<span class="token punctuation">)</span>\nb <span class="token operator">=</span> <span class="token string">\'my string\'</span>\nformatted <span class="token operator">=</span> <span class="token builtin">format</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token string">\'^20s\'</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'*\'</span><span class="token punctuation">,</span> formatted<span class="token punctuation">,</span> <span class="token string">\'*\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">1</span><span class="token punctuation">,</span><span class="token number">234.57</span>\n<span class="token operator">*</span>      my string       <span class="token operator">*</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68426440226818380000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`key = \'my_var\'\nvalue = 1.234\n\nformatted = \'{} = {}\'.format(key, value)\nprint(formatted)\n\n>>>\nmy_var = 1.234`, `68426440226818380000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">key <span class="token operator">=</span> <span class="token string">\'my_var\'</span>\nvalue <span class="token operator">=</span> <span class="token number">1.234</span>\n\nformatted <span class="token operator">=</span> <span class="token string">\'{} = {}\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>formatted<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nmy_var <span class="token operator">=</span> <span class="token number">1.234</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>你可以在 {} 里写个冒号，然后把格式说明符写在冒号的右边，用以规定 format 方法所接收的这个值应该按照怎样的格式来调整。在 Python 解释器里输入 help(‘FORMATTING’)，可以详细查看 str.format 使用的这套格式说明符所依据的规则。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56261652135492305000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`key = \'my_var\'\nvalue = 1.234\n\nformatted = \'{:<10} = {:.2f}\'.format(key, value)\nprint(formatted)\n\n>>>\nmy_var     = 1.23`, `56261652135492305000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">key <span class="token operator">=</span> <span class="token string">\'my_var\'</span>\nvalue <span class="token operator">=</span> <span class="token number">1.234</span>\n\nformatted <span class="token operator">=</span> <span class="token string">\'{:&lt;10} = {:.2f}\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>formatted<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nmy_var     <span class="token operator">=</span> <span class="token number">1.23</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>运行过程：系统先把 str.format 方法接收到的每个值传给内置的 format 函数，并找到这个值在字符串里对应的 {}，同时将 {} 里面写的格式也传给 format 函数，例如系统在处理 value 的时候，传的就是 format(value, ‘.2f’)。然后，系统会把 format 函数所返回的结果写在整个格式化字符串 {} 所在的位置。另外，每个类都可以通过 <code class="language-text">__format__</code> 这个特殊的方法定制相应的逻辑，这样的话，format 函数在把该类实例转换成字符串时，就会按照这种逻辑来转换。</p>\n<p>C 风格的格式字符串采用 % 操作符来引导格式说明符，所以如果要将这个符号照原样输出，那就必须转义，也就是连写两个 %。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72207535912306704000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`print(\'%.2f%%\' % 12.5)\nprint(\'{} replaces {{}}\'.format(1.23))\n\n>>>\n12.50%\n1.23 replaces {}`, `72207535912306704000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'%.2f%%\'</span> <span class="token operator">%</span> <span class="token number">12.5</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'{} replaces {{}}\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token number">1.23</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">12.50</span><span class="token operator">%</span>\n<span class="token number">1.23</span> replaces <span class="token punctuation">{</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>调用 str.format 方法的时候，也可以给 str 的 {} 里面写上数字，用来指代 format 方法在这个位置所接收到的参数值位置索引。以后即使这些 {} 在格式字符串中的次序有所变动，也不用调换传给 format 方法的那些参数。于是，这就避免了前面讲的第一个缺点所提到的那个顺序问题。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35494551616108237000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`key = \'my_var\'\nvalue = 1.234\n\nformatted = \'{1} = {0}\'.format(key, value)\nprint(formatted)\n\n>>>\n1.234 = my_var`, `35494551616108237000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">key <span class="token operator">=</span> <span class="token string">\'my_var\'</span>\nvalue <span class="token operator">=</span> <span class="token number">1.234</span>\n\nformatted <span class="token operator">=</span> <span class="token string">\'{1} = {0}\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>formatted<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">1.234</span> <span class="token operator">=</span> my_var</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>同一个位置索引可以出现在 str 的多个 {} 里面，这些 {} 指代的都是 format 方法在对应位置所收到的值。这就不需要把这个值重复地传给 format 方法，于是就解决了前面提到的第三个缺点。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79949546604152820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`name = \'Max\'\nformatted = \'{0} loves food. See {0} cook.\'.format(name)\nprint(formatted)\n\n>>>\nMax loves food. See Max cook.`, `79949546604152820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">name <span class="token operator">=</span> <span class="token string">\'Max\'</span>\nformatted <span class="token operator">=</span> <span class="token string">\'{0} loves food. See {0} cook.\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>formatted<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nMax loves food<span class="token punctuation">.</span> See Max cook<span class="token punctuation">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然而，这个新的 str.format 方法并没有解决上面讲的第二个缺点。如果在对值做填充之前要先对这个值做出调整，那么用这种方法写出来的代码还是跟原来一样乱，阅读性差。把原来那种写法和现在的新写法对比一下，大家就会看到新写法并不比原来好多少。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21285781216176680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pantry = [\n    (\'avocados\', 1.25),\n    (\'bananas\', 2.5),\n    (\'cherries\', 15),\n]\n\nfor i, (item, count) in enumerate(pantry):\n    old_style = \'#%d: %-10s = %d\' % (\n        i + 1,\n        item.title(),\n        round(count))\n    new_style = \'#{}: {:<10s} = {}\'.format(\n        i + 1,\n        item.title(),\n        round(count))\n    assert old_style == new_style`, `21285781216176680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">pantry <span class="token operator">=</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">(</span><span class="token string">\'avocados\'</span><span class="token punctuation">,</span> <span class="token number">1.25</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">(</span><span class="token string">\'bananas\'</span><span class="token punctuation">,</span> <span class="token number">2.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">(</span><span class="token string">\'cherries\'</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">]</span>\n\n<span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>item<span class="token punctuation">,</span> count<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>pantry<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    old_style <span class="token operator">=</span> <span class="token string">\'#%d: %-10s = %d\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>\n        i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>\n        item<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        <span class="token builtin">round</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span>\n    new_style <span class="token operator">=</span> <span class="token string">\'#{}: {:&lt;10s} = {}\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>\n        i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>\n        item<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        <span class="token builtin">round</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token keyword">assert</span> old_style <span class="token operator">==</span> new_style</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当然，这种 {} 形式的说明符，还支持一些比较高级的用法，例如可以查询 dict 中某个键的值，可以访问 list 里某个位置的元素，还可以把值转化成 Unicode 或 repr 字符串。下面这段代码把这三项特性结合了起来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5596669452389990000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`menu = {\n    \'soup\': \'lentil\',\n    \'oyster\': \'kumamoto\',\n    \'special\': \'schnitzel\',\n}\n\nformatted = \'First letter is {menu[oyster][0]!r}\'.format(\n    menu=menu)\nprint(formatted)\n\n>>>\nFirst letter is \'k\'`, `5596669452389990000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">menu <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'soup\'</span><span class="token punctuation">:</span> <span class="token string">\'lentil\'</span><span class="token punctuation">,</span>\n    <span class="token string">\'oyster\'</span><span class="token punctuation">:</span> <span class="token string">\'kumamoto\'</span><span class="token punctuation">,</span>\n    <span class="token string">\'special\'</span><span class="token punctuation">:</span> <span class="token string">\'schnitzel\'</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\nformatted <span class="token operator">=</span> <span class="token string">\'First letter is {menu[oyster][0]!r}\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>\n    menu<span class="token operator">=</span>menu<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>formatted<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nFirst letter <span class="token keyword">is</span> <span class="token string">\'k\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是这些特性，依然不能解决前面提到的第四个缺点，也就是键名需要多次重复的那个问题。下面把 C 风格的格式化表达式与新的 str.format 方法对比一下，看看这两种写法在处理键值对形式的数据时有什么区别。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82795059891858160000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`old_template = (\n    \'Today\\\'s soup is %(soup)s, \'\n    \'buy one get two %(oyster)s oysters, \'\n    \'and our special entree is %(special)s.\')\nold_formatted = old_template % {\n    \'soup\': \'lentil\',\n    \'oyster\': \'kumamoto\',\n    \'special\': \'schnitzel\',\n}\n\nnew_template = (\n    \'Today\\\'s soup is {soup}, \'\n    \'buy one get two {oyster} oysters, \'\n    \'and our special entree is {special}.\')\nnew_formatted = new_template.format(\n    soup=\'lentil\',\n    oyster=\'kumamoto\',\n    special=\'schnitzel\',\n)\n\nassert old_formatted == new_formatted`, `82795059891858160000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">old_template <span class="token operator">=</span> <span class="token punctuation">(</span>\n    <span class="token string">\'Today\\\'s soup is %(soup)s, \'</span>\n    <span class="token string">\'buy one get two %(oyster)s oysters, \'</span>\n    <span class="token string">\'and our special entree is %(special)s.\'</span><span class="token punctuation">)</span>\nold_formatted <span class="token operator">=</span> old_template <span class="token operator">%</span> <span class="token punctuation">{</span>\n    <span class="token string">\'soup\'</span><span class="token punctuation">:</span> <span class="token string">\'lentil\'</span><span class="token punctuation">,</span>\n    <span class="token string">\'oyster\'</span><span class="token punctuation">:</span> <span class="token string">\'kumamoto\'</span><span class="token punctuation">,</span>\n    <span class="token string">\'special\'</span><span class="token punctuation">:</span> <span class="token string">\'schnitzel\'</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\nnew_template <span class="token operator">=</span> <span class="token punctuation">(</span>\n    <span class="token string">\'Today\\\'s soup is {soup}, \'</span>\n    <span class="token string">\'buy one get two {oyster} oysters, \'</span>\n    <span class="token string">\'and our special entree is {special}.\'</span><span class="token punctuation">)</span>\nnew_formatted <span class="token operator">=</span> new_template<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>\n    soup<span class="token operator">=</span><span class="token string">\'lentil\'</span><span class="token punctuation">,</span>\n    oyster<span class="token operator">=</span><span class="token string">\'kumamoto\'</span><span class="token punctuation">,</span>\n    special<span class="token operator">=</span><span class="token string">\'schnitzel\'</span><span class="token punctuation">,</span>\n<span class="token punctuation">)</span>\n\n<span class="token keyword">assert</span> old_formatted <span class="token operator">==</span> new_formatted</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>新写法稍微好一点儿，因为它不用定义 dict 了，所以不需要把键名用 <code class="language-text">&#39; &#39;</code> 给括起来。它的说明符也比旧写法的说明符要简单一些。然而这些优点并不突出。另外，虽然我们在新写法里面，可以访问字典中的键，也可以访问列表中的元素，但这些功能只涵盖了 Python 表达式的一小部分特性，str.format 方法还是没有能够把 Python 表达式的优势充分发挥出来。</p>\n<h3 id="插值格式字符串"><a href="#%E6%8F%92%E5%80%BC%E6%A0%BC%E5%BC%8F%E5%AD%97%E7%AC%A6%E4%B8%B2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>插值格式字符串</h3>\n<p>Python 3.6 添加了一种新的特性，叫作插值格式字符串（interpolatedformat string，简称 f-string），可以解决上面提到的所有问题。新语法特性要求在格式字符串的前面加字母 f 作为前缀，这跟字母 b 与字母 r 的用法类似，也就是分别表示字节形式的字符串与原始的（或者说未经转义的）字符串的前缀。</p>\n<p>f-string 把格式字符串的表达能力发挥到了极致，它彻底解决了上文提到的第四个缺点，也就是键名重复导致的程序冗余问题。我们不用再像使用 C 风格格式表达式时那样专门定义 dict，也不用再像调用 str.format 方法时那样专门把值传给某个参数，这次可以直接在 f-string 的 {} 里面引用当前 Python 范围内的所有名称，进而达到简化的目的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35737877944062110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`key = \'my_var\'\nvalue = 1.234\n\nformatted = f\'{key} = {value}\'\nprint(formatted)\n\n>>>\nmy_var = 1.234`, `35737877944062110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">key <span class="token operator">=</span> <span class="token string">\'my_var\'</span>\nvalue <span class="token operator">=</span> <span class="token number">1.234</span>\n\nformatted <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>key<span class="token punctuation">}</span></span><span class="token string"> = </span><span class="token interpolation"><span class="token punctuation">{</span>value<span class="token punctuation">}</span></span><span class="token string">\'</span></span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>formatted<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nmy_var <span class="token operator">=</span> <span class="token number">1.234</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>str.format 方法所支持的那套迷你语言，也就是在 {} 内的冒号右侧所采用的那套规则，现在也可以用到 f-string 里面，而且还可以像早前使用 str.format 时那样，通过 ! 符号把值转化成 Unicode 及 repr 形式的字符串。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85735993467017600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`key = \'my_var\'\nvalue = 1.234\n\nformatted = f\'{key!r:<10} = {value:.2f}\'\nprint(formatted)\n\n>>>\n\'my_var\'   = 1.23`, `85735993467017600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">key <span class="token operator">=</span> <span class="token string">\'my_var\'</span>\nvalue <span class="token operator">=</span> <span class="token number">1.234</span>\n\nformatted <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>key<span class="token conversion-option punctuation">!r</span><span class="token punctuation">:</span><span class="token format-spec">&lt;10</span><span class="token punctuation">}</span></span><span class="token string"> = </span><span class="token interpolation"><span class="token punctuation">{</span>value<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>formatted<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token string">\'my_var\'</span>   <span class="token operator">=</span> <span class="token number">1.23</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>同一个问题，使用 f-string 来解决总是比通过 % 操作符使用 C 风格的格式字符串简单，而且也比 str.format 方法简单。下面按照从短到长的顺序把这几种写法所占的篇幅对比一下，每种写法里面的那个赋值符号（=）左侧都对齐到同一个位置，这样很容易看出符号右边的代码到底有多少。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79135888446848090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`key = \'my_var\'\nvalue = 1.234\n\nf_string = f\'{key:<10} = {value:.2f}\'\nc_tuple = \'%-10s = %.2f\' % (key, value)\nstr_args = \'{:<10} = {:.2f}\'.format(key, value)\nstr_kw = \'{key:<10} = {value:.2f}\'.format(key=key,\n                                          value=value)\nc_dict = \'%(key)-10s = %(value).2f\' % {\'key\': key,\n                                       \'value\': value}\nassert c_tuple == c_dict == f_string\nassert str_args == str_kw == f_string`, `79135888446848090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">key <span class="token operator">=</span> <span class="token string">\'my_var\'</span>\nvalue <span class="token operator">=</span> <span class="token number">1.234</span>\n\nf_string <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>key<span class="token punctuation">:</span><span class="token format-spec">&lt;10</span><span class="token punctuation">}</span></span><span class="token string"> = </span><span class="token interpolation"><span class="token punctuation">{</span>value<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span>\nc_tuple <span class="token operator">=</span> <span class="token string">\'%-10s = %.2f\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\nstr_args <span class="token operator">=</span> <span class="token string">\'{:&lt;10} = {:.2f}\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\nstr_kw <span class="token operator">=</span> <span class="token string">\'{key:&lt;10} = {value:.2f}\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>key<span class="token operator">=</span>key<span class="token punctuation">,</span>\n                                          value<span class="token operator">=</span>value<span class="token punctuation">)</span>\nc_dict <span class="token operator">=</span> <span class="token string">\'%(key)-10s = %(value).2f\'</span> <span class="token operator">%</span> <span class="token punctuation">{</span><span class="token string">\'key\'</span><span class="token punctuation">:</span> key<span class="token punctuation">,</span>\n                                       <span class="token string">\'value\'</span><span class="token punctuation">:</span> value<span class="token punctuation">}</span>\n<span class="token keyword">assert</span> c_tuple <span class="token operator">==</span> c_dict <span class="token operator">==</span> f_string\n<span class="token keyword">assert</span> str_args <span class="token operator">==</span> str_kw <span class="token operator">==</span> f_string</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 f-string 方法中，各种 Python 表达式都可以出现在 {} 里，于是这就解决了前面提到的第二个缺点。我们现在可以用相当简洁的写法对需要填充到字符串里面的值做出微调。C 风格的写法与采用 str.format 方法的写法可能会让表达式变得很长，但如果改用 f-string，或许一行就能写完。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20178643266573440000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pantry = [\n    (\'avocados\', 1.25),\n    (\'bananas\', 2.5),\n    (\'cherries\', 15),\n]\n\nfor i, (item, count) in enumerate(pantry):\n    old_style = \'#%d: %-10s = %d\' % (\n        i + 1,\n        item.title(),\n        round(count))\n    new_style = \'#{}: {:<10s} = {}\'.format(\n        i + 1,\n        item.title(),\n        round(count))\n    f_string = f\'#{i + 1}: {item.title():<10s} = {round(count)}\'\n    assert old_style == new_style == f_string`, `20178643266573440000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">pantry <span class="token operator">=</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">(</span><span class="token string">\'avocados\'</span><span class="token punctuation">,</span> <span class="token number">1.25</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">(</span><span class="token string">\'bananas\'</span><span class="token punctuation">,</span> <span class="token number">2.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">(</span><span class="token string">\'cherries\'</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">]</span>\n\n<span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>item<span class="token punctuation">,</span> count<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>pantry<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    old_style <span class="token operator">=</span> <span class="token string">\'#%d: %-10s = %d\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>\n        i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>\n        item<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        <span class="token builtin">round</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span>\n    new_style <span class="token operator">=</span> <span class="token string">\'#{}: {:&lt;10s} = {}\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>\n        i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>\n        item<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        <span class="token builtin">round</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span>\n    f_string <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f\'#</span><span class="token interpolation"><span class="token punctuation">{</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>item<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token format-spec">&lt;10s</span><span class="token punctuation">}</span></span><span class="token string"> = </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">round</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span>\n    <span class="token keyword">assert</span> old_style <span class="token operator">==</span> new_style <span class="token operator">==</span> f_string</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>要是想表达得更清楚一些，可以把 f-string 写成多行的形式，类似于 C 语言的相邻字符串拼接（adjacent-string concatenation）。这样写虽然比单行的 f-string 要长，但仍然好过另外那两种多行的写法。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60818579022777050000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pantry = [\n    (\'avocados\', 1.25),\n    (\'bananas\', 2.5),\n    (\'cherries\', 15),\n]\n\nfor i, (item, count) in enumerate(pantry):\n    f_string = (\n        f\'# {i + 1}: \'\n        f\'{item.title():<10s} = \'\n        f\'{round(count)}\'\n    )\n    print(f_string)\n\n>>>\n# 1: Avocados   = 1\n# 2: Bananas    = 2\n# 3: Cherries   = 15`, `60818579022777050000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">pantry <span class="token operator">=</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">(</span><span class="token string">\'avocados\'</span><span class="token punctuation">,</span> <span class="token number">1.25</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">(</span><span class="token string">\'bananas\'</span><span class="token punctuation">,</span> <span class="token number">2.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">(</span><span class="token string">\'cherries\'</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">]</span>\n\n<span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>item<span class="token punctuation">,</span> count<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>pantry<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    f_string <span class="token operator">=</span> <span class="token punctuation">(</span>\n        <span class="token string-interpolation"><span class="token string">f\'# </span><span class="token interpolation"><span class="token punctuation">{</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">: \'</span></span>\n        <span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>item<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token format-spec">&lt;10s</span><span class="token punctuation">}</span></span><span class="token string"> = \'</span></span>\n        <span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">round</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span>\n    <span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span>f_string<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token comment"># 1: Avocados   = 1</span>\n<span class="token comment"># 2: Bananas    = 2</span>\n<span class="token comment"># 3: Cherries   = 15</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Python 表达式也可以出现在格式说明符中。例如，下面的代码把小数点之后的位数用变量来表示，然后把这个变量的名字 places 用 {} 括起来放到格式说明符中，这样写比采用硬代码更灵活。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68125441764895700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`places = 3\nnumber = 1.23456\nprint(f\'My number is {number:.{places}f}\')\n\n>>>\nMy number is 1.235`, `68125441764895700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">places <span class="token operator">=</span> <span class="token number">3</span>\nnumber <span class="token operator">=</span> <span class="token number">1.23456</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'My number is </span><span class="token interpolation"><span class="token punctuation">{</span>number<span class="token punctuation">:</span><span class="token punctuation">.</span><span class="token punctuation">{</span>places<span class="token punctuation">}</span>f<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nMy number <span class="token keyword">is</span> <span class="token number">1.235</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 Python 内置的四种字符串格式化办法里面，f-string 可以简洁而清晰地表达出许多种逻辑，这使它成为程序员的最佳选择。如果你想把值以适当的格式填充到字符串里面，那么首先应该考虑的就是采用 f-string 来实现。</p>\n<h3 id="总结"><a href="#%E6%80%BB%E7%BB%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>采用 % 操作符把值填充到 C 风格的格式字符串时会遇到许多问题，而且这种写法比较烦琐。</li>\n<li>str.format 方法专门用一套迷你语言来定义它的格式说明符，这套语言给我们提供了一些有用的概念，但是在其他方面，这个方法还是存在与 C 风格的格式字符串一样的多种缺点，所以我们也应该避免使用它。</li>\n<li>f-string 采用新的写法，将值填充到字符串之中，解决了 C 风格的格式字符串所带来的最大问题。f-string 是个简洁而强大的机制，可以直接在格式说明符里嵌入任意 Python 表达式。</li>\n</ol>\n<h2 id="第-5-条：用辅助函数取代复杂的表达式"><a href="#%E7%AC%AC-5-%E6%9D%A1%EF%BC%9A%E7%94%A8%E8%BE%85%E5%8A%A9%E5%87%BD%E6%95%B0%E5%8F%96%E4%BB%A3%E5%A4%8D%E6%9D%82%E7%9A%84%E8%A1%A8%E8%BE%BE%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 5 条：用辅助函数取代复杂的表达式</h2>\n<p>Python 的语法相当简明，所以有时只用一条表达式就能实现许多逻辑。例如，要把 URL 之中的查询字符串拆分成键值对，那么只需要使用 parse_qs 函数就可以了。下面的例子会解析查询字符串之中的每个参数，并把这些参数跟它们所对应的整数值放到一份字典（dict）里面。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72108252644560470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from urllib.parse import parse_qs\nmy_values = parse_qs(\'red=5&blue=0&green=\',\n                     keep_blank_values=True)\nprint(repr(my_values))\n\n>>>\n{\'red\': [\'5\'], \'blue\': [\'0\'], \'green\': [\'\']}`, `72108252644560470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> parse_qs\nmy_values <span class="token operator">=</span> parse_qs<span class="token punctuation">(</span><span class="token string">\'red=5&amp;blue=0&amp;green=\'</span><span class="token punctuation">,</span>\n                     keep_blank_values<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">repr</span><span class="token punctuation">(</span>my_values<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">{</span><span class="token string">\'red\'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'5\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">\'blue\'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'0\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">\'green\'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'\'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在解析查询字符串时，可以发现，有的参数可能带有多个值，有的参数可能只有一个值，还有的参数可能是空白值，另外也会遇到根本没提供这个参数的情况。下面这三行代码分别通过 get 方法查询结果字典里面的三个参数，这刚好对应三种不同的情况：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86927602265607650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from urllib.parse import parse_qs\nmy_values = parse_qs(\'red=5&blue=0&green=\',\n                     keep_blank_values=True)\n\nprint(\'Red:         \', my_values.get(\'red\'))\nprint(\'Green:       \', my_values.get(\'green\'))\nprint(\'Opacity:     \', my_values.get(\'opacity\'))\n\n>>>\nRed:          [\'5\']\nGreen:        [\'\']\nOpacity:      None`, `86927602265607650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> parse_qs\nmy_values <span class="token operator">=</span> parse_qs<span class="token punctuation">(</span><span class="token string">\'red=5&amp;blue=0&amp;green=\'</span><span class="token punctuation">,</span>\n                     keep_blank_values<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Red:         \'</span><span class="token punctuation">,</span> my_values<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'red\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Green:       \'</span><span class="token punctuation">,</span> my_values<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'green\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Opacity:     \'</span><span class="token punctuation">,</span> my_values<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'opacity\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nRed<span class="token punctuation">:</span>          <span class="token punctuation">[</span><span class="token string">\'5\'</span><span class="token punctuation">]</span>\nGreen<span class="token punctuation">:</span>        <span class="token punctuation">[</span><span class="token string">\'\'</span><span class="token punctuation">]</span>\nOpacity<span class="token punctuation">:</span>      <span class="token boolean">None</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果能把参数缺失与参数为空白值这两种情况都默认当成 0，那就更好了。但这样一个小小的逻辑，似乎不值得专门写 if 语句或辅助函数，所以有人会直接用 Boolean 表达式实现。</p>\n<p>Boolean 表达式用 Python 的语法写起来很简单，因为 Python 在对这种表达式求值的时候，会把空白字符串、空白 list 以及 0 值，全都当成 False 看待。所以，只需要把 get 方法查到的结果放在 or 操作符的左边，并且在右边写上 0 就行了。这样的话，只要左边的子表达式为 False，那么整个表达式的值自然就被评估为右边那个表达式的值，也就是 0。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60788289364234620000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from urllib.parse import parse_qs\nmy_values = parse_qs(\'red=5&blue=0&green=\',\n                     keep_blank_values=True)\n\n# For query string \'red=5&blue=0&green=\'\nred = my_values.get(\'red\', [\'\'])[0] or 0\ngreen = my_values.get(\'green\', [\'\'])[0] or 0\nopacity = my_values.get(\'opacity\', [\'\'])[0] or 0\nprint(f\'Red:     {red!r}\')\nprint(f\'Green:   {green!r}\')\nprint(f\'Opacity: {opacity!r}\')\n\n>>>\nRed:     \'5\'\nGreen:   0\nOpacity: 0`, `60788289364234620000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> parse_qs\nmy_values <span class="token operator">=</span> parse_qs<span class="token punctuation">(</span><span class="token string">\'red=5&amp;blue=0&amp;green=\'</span><span class="token punctuation">,</span>\n                     keep_blank_values<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\n\n<span class="token comment"># For query string \'red=5&amp;blue=0&amp;green=\'</span>\nred <span class="token operator">=</span> my_values<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'red\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">or</span> <span class="token number">0</span>\ngreen <span class="token operator">=</span> my_values<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'green\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">or</span> <span class="token number">0</span>\nopacity <span class="token operator">=</span> my_values<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'opacity\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">or</span> <span class="token number">0</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Red:     </span><span class="token interpolation"><span class="token punctuation">{</span>red<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Green:   </span><span class="token interpolation"><span class="token punctuation">{</span>green<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Opacity: </span><span class="token interpolation"><span class="token punctuation">{</span>opacity<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nRed<span class="token punctuation">:</span>     <span class="token string">\'5\'</span>\nGreen<span class="token punctuation">:</span>   <span class="token number">0</span>\nOpacity<span class="token punctuation">:</span> <span class="token number">0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>表达式写成这样，看起来很别扭，而且它并没有完全实现我们想要的效果，因为我们还得保证解析出来的参数值是能够直接参与数学运算的整数。于是，需要通过内置的 int() 把这种表达式所解析出来的字符串转换成整数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97872701311546640000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`red = int(my_values.get(\'red\', [\'\'])[0] or 0)`, `97872701311546640000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">red <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>my_values<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'red\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">or</span> <span class="token number">0</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>现在的代码比原来更难读了，因为看上去比原来还要乱。这种代码让人觉得很可怕：如果你是第一次阅读该代码，那必须得把整个表达式逐层拆分，才能明白这行代码的意思，这要花很长时间。代码当然应该写得短一些，但并不意味着非得挤成一行。</p>\n<p>Python 可以用 if/else 结构实现三元的条件表达式，这样写比刚才那种写法更清晰，且能保持代码简短。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8090999180304736000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`red_str = my_values.get(\'red\', [\'\'])\nred = int(red_str[0]) if red_str[0] else 0`, `8090999180304736000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">red_str <span class="token operator">=</span> my_values<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'red\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\nred <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>red_str<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">if</span> red_str<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">else</span> <span class="token number">0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>但在我们这个例子里，这种写法还是不如完整的多行 if/else 结构好，虽然要多写几行，但非常容易看懂。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57457762441304760000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`green_str = my_values.get(\'green\', [\'\'])\nif green_str[0]:\n    green = int(green_str[0])\nelse:\n    green = 0`, `57457762441304760000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">green_str <span class="token operator">=</span> my_values<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'green\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token keyword">if</span> green_str<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>\n    green <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>green_str<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    green <span class="token operator">=</span> <span class="token number">0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果要反复使用这套逻辑，那还是写成辅助函数比较好，即使像下面这个例子一样只用两三次，也还是值得这样做。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65357026975054410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def get_first_int(values, key, default=0):\n    found = values.get(key, [\'\'])\n    if found[0]:\n        return int(found[0])\n    return default`, `65357026975054410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">get_first_int</span><span class="token punctuation">(</span>values<span class="token punctuation">,</span> key<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    found <span class="token operator">=</span> values<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n    <span class="token keyword">if</span> found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token builtin">int</span><span class="token punctuation">(</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n    <span class="token keyword">return</span> default</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="总结-1"><a href="#%E6%80%BB%E7%BB%93-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>Python 的语法很容易把复杂的意思挤到同一行表达式里，这样写很难懂。</li>\n<li>复杂的表达式，尤其是那种需要重复使用的复杂表达式，应该写到辅助函数里面。</li>\n<li>用 if/else 结构写成的条件表达式，要比用 or 与 and 写成的 Boolean 表达式更好懂。</li>\n</ol>\n<h2 id="第-6-条：把数据结构直接拆分到多个变量里，不要专门通过下标访问"><a href="#%E7%AC%AC-6-%E6%9D%A1%EF%BC%9A%E6%8A%8A%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%9B%B4%E6%8E%A5%E6%8B%86%E5%88%86%E5%88%B0%E5%A4%9A%E4%B8%AA%E5%8F%98%E9%87%8F%E9%87%8C%EF%BC%8C%E4%B8%8D%E8%A6%81%E4%B8%93%E9%97%A8%E9%80%9A%E8%BF%87%E4%B8%8B%E6%A0%87%E8%AE%BF%E9%97%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 6 条：把数据结构直接拆分到多个变量里，不要专门通过下标访问</h2>\n<p>Python 内置的元组（tuple）类型可以创建不可变的序列，把许多元素依次保存起来。最简单的用法是只用元组保存两个值，例如字典里面的键值对。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50860252511959180000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`snack_calories = {\n    \'chips\': 140,\n    \'popcorn\': 80,\n    \'nuts\': 190,\n}\nitems = tuple(snack_calories.items())\nprint(items)\n\n>>>\n((\'chips\', 140), (\'popcorn\', 80), (\'nuts\', 190))`, `50860252511959180000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">snack_calories <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'chips\'</span><span class="token punctuation">:</span> <span class="token number">140</span><span class="token punctuation">,</span>\n    <span class="token string">\'popcorn\'</span><span class="token punctuation">:</span> <span class="token number">80</span><span class="token punctuation">,</span>\n    <span class="token string">\'nuts\'</span><span class="token punctuation">:</span> <span class="token number">190</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\nitems <span class="token operator">=</span> <span class="token builtin">tuple</span><span class="token punctuation">(</span>snack_calories<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">\'chips\'</span><span class="token punctuation">,</span> <span class="token number">140</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">\'popcorn\'</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">\'nuts\'</span><span class="token punctuation">,</span> <span class="token number">190</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们可以用整数作下标，通过下标来访问元组里面对应的元素。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91529022977225930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`item = (\'Peanut butter\', \'Jelly\')\nfirst = item[0]\nsecond = item[1]\nprint(first, \'and\', second)\n\n>>>\nPeanut butter and Jelly`, `91529022977225930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">item <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">\'Peanut butter\'</span><span class="token punctuation">,</span> <span class="token string">\'Jelly\'</span><span class="token punctuation">)</span>\nfirst <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>\nsecond <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span> <span class="token string">\'and\'</span><span class="token punctuation">,</span> second<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nPeanut butter <span class="token keyword">and</span> Jelly</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>创建好 tuple 之后，就不能通过下标给其中的元素赋新值了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59423950869679360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pair = (\'Chocolate\', \'Peanut butter\')\npair[0] = \'Honey\'\n\n>>>\nTraceback ...\nTypeError: \'tuple\' object does not support item assignment`, `59423950869679360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">pair <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">\'Chocolate\'</span><span class="token punctuation">,</span> <span class="token string">\'Peanut butter\'</span><span class="token punctuation">)</span>\npair<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">\'Honey\'</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> <span class="token string">\'tuple\'</span> <span class="token builtin">object</span> does <span class="token keyword">not</span> support item assignment</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Python 还有一种写法，叫作拆分（unpacking）。这种写法让我们只用一条语句，就可以把元组里面的元素分别赋给多个变量。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41974726261476530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`item = (\'Peanut butter\', \'Jelly\')\nfirst, second = item  # Unpacking\nprint(first, \'and\', second)\n\n>>>\nPeanut butter and Jelly`, `41974726261476530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">item <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">\'Peanut butter\'</span><span class="token punctuation">,</span> <span class="token string">\'Jelly\'</span><span class="token punctuation">)</span>\nfirst<span class="token punctuation">,</span> second <span class="token operator">=</span> item  <span class="token comment"># Unpacking</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span> <span class="token string">\'and\'</span><span class="token punctuation">,</span> second<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nPeanut butter <span class="token keyword">and</span> Jelly</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>通过 unpacking 来赋值要比通过下标去访问元组内的元素更清晰，而且这种写法所需的代码量通常比较少。当然，赋值操作的左边除了可以罗列单个变量，也可以写成列表、序列或任意深度的可迭代对象（iterable）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64614213346931670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`favorite_snacks = {\n    \'salty\': (\'pretzels\', 100),\n    \'sweet\': (\'cookies\', 180),\n    \'veggie\': (\'carrots\', 20),\n}\n\n((type1, (name1, cals1)),\n (type2, (name2, cals2)),\n (type3, (name3, cals3))) = favorite_snacks.items()\nprint(f\'Favorite {type1} is {name1} with {cals1} calories\')\nprint(f\'Favorite {type2} is {name2} with {cals2} calories\')\nprint(f\'Favorite {type3} is {name3} with {cals3} calories\')\n\n>>>\nFavorite salty is pretzels with 100 calories\nFavorite sweet is cookies with 180 calories\nFavorite veggie is carrots with 20 calories`, `64614213346931670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">favorite_snacks <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'salty\'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">\'pretzels\'</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token string">\'sweet\'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">\'cookies\'</span><span class="token punctuation">,</span> <span class="token number">180</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token string">\'veggie\'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">\'carrots\'</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\n<span class="token punctuation">(</span><span class="token punctuation">(</span>type1<span class="token punctuation">,</span> <span class="token punctuation">(</span>name1<span class="token punctuation">,</span> cals1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n <span class="token punctuation">(</span>type2<span class="token punctuation">,</span> <span class="token punctuation">(</span>name2<span class="token punctuation">,</span> cals2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n <span class="token punctuation">(</span>type3<span class="token punctuation">,</span> <span class="token punctuation">(</span>name3<span class="token punctuation">,</span> cals3<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> favorite_snacks<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Favorite </span><span class="token interpolation"><span class="token punctuation">{</span>type1<span class="token punctuation">}</span></span><span class="token string"> is </span><span class="token interpolation"><span class="token punctuation">{</span>name1<span class="token punctuation">}</span></span><span class="token string"> with </span><span class="token interpolation"><span class="token punctuation">{</span>cals1<span class="token punctuation">}</span></span><span class="token string"> calories\'</span></span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Favorite </span><span class="token interpolation"><span class="token punctuation">{</span>type2<span class="token punctuation">}</span></span><span class="token string"> is </span><span class="token interpolation"><span class="token punctuation">{</span>name2<span class="token punctuation">}</span></span><span class="token string"> with </span><span class="token interpolation"><span class="token punctuation">{</span>cals2<span class="token punctuation">}</span></span><span class="token string"> calories\'</span></span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Favorite </span><span class="token interpolation"><span class="token punctuation">{</span>type3<span class="token punctuation">}</span></span><span class="token string"> is </span><span class="token interpolation"><span class="token punctuation">{</span>name3<span class="token punctuation">}</span></span><span class="token string"> with </span><span class="token interpolation"><span class="token punctuation">{</span>cals3<span class="token punctuation">}</span></span><span class="token string"> calories\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nFavorite salty <span class="token keyword">is</span> pretzels <span class="token keyword">with</span> <span class="token number">100</span> calories\nFavorite sweet <span class="token keyword">is</span> cookies <span class="token keyword">with</span> <span class="token number">180</span> calories\nFavorite veggie <span class="token keyword">is</span> carrots <span class="token keyword">with</span> <span class="token number">20</span> calories</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15519189305351390000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`snacks = [(\'bacon\', 350), (\'donut\', 240), (\'muffin\', 190)]\n\nfor rank, (name, calories) in enumerate(snacks, 1):\n    print(f\'#{rank}: {name} has {calories} calories\')\n\n>>>\n#1: bacon has 350 calories\n#2: donut has 240 calories\n#3: muffin has 190 calories`, `15519189305351390000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">snacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'bacon\'</span><span class="token punctuation">,</span> <span class="token number">350</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">\'donut\'</span><span class="token punctuation">,</span> <span class="token number">240</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">\'muffin\'</span><span class="token punctuation">,</span> <span class="token number">190</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n\n<span class="token keyword">for</span> rank<span class="token punctuation">,</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> calories<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>snacks<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'#</span><span class="token interpolation"><span class="token punctuation">{</span>rank<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string"> has </span><span class="token interpolation"><span class="token punctuation">{</span>calories<span class="token punctuation">}</span></span><span class="token string"> calories\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token comment">#1: bacon has 350 calories</span>\n<span class="token comment">#2: donut has 240 calories</span>\n<span class="token comment">#3: muffin has 190 calories</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这才是符合 Python 风格的写法（Pythonic 式的写法），我们不需要再通过下标逐层访问了。这种写法可以节省篇幅，而且比较容易理解。</p>\n<p>Python 的 unpacking 机制可以用在许多方面，例如构建列表（参见第 13 条）、给函数设计参数列表（参见第 22 条）、传递关键字参数（参见第 23 条）、接收多个返回值（参见第 19 条）等。</p>\n<p>明智地使用 unpacking 机制，可以实现很多原来必须通过下标才能写出的功能，这让代码变得更加清晰，而且能充分发挥 Python 的优势。</p>\n<h3 id="总结-2"><a href="#%E6%80%BB%E7%BB%93-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>unpacking 是一种特殊的 Python 语法，只需要一行代码，就能把数据结构里面的多个值分别赋给相应的变量。</li>\n<li>unpacking 在 Python 中应用广泛，凡是可迭代的对象都能拆分，无论它里面还有多少层迭代结构。</li>\n<li>尽量通过 unpacking 来拆解序列之中的数据，而不要通过下标访问，这样可以让代码更简洁、更清晰。</li>\n</ol>\n<h2 id="第-7-条：尽量用-enumerate-取代-range"><a href="#%E7%AC%AC-7-%E6%9D%A1%EF%BC%9A%E5%B0%BD%E9%87%8F%E7%94%A8-enumerate-%E5%8F%96%E4%BB%A3-range" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 7 条：尽量用 enumerate 取代 range</h2>\n<p>Python 内置的 range 函数适合用来迭代一系列整数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15316696858827973000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from random import randint\n\nrandom_bits = 0\nfor i in range(32):\n    if randint(0, 1):\n        random_bits |= 1 << i\nprint(bin(random_bits))\n\n>>>\n0b100101010010000001011011010011`, `15316696858827973000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> random <span class="token keyword">import</span> randint\n\nrandom_bits <span class="token operator">=</span> <span class="token number">0</span>\n<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        random_bits <span class="token operator">|</span><span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> i\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">bin</span><span class="token punctuation">(</span>random_bits<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">0b100101010010000001011011010011</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果要迭代的是某种数据结构，例如字符串列表，那么可以直接在这个序列上面迭代，用不着专门通过 range 设定一个取值范围，然后把这个范围里的每个整数值，依次当成下标来访问列表中的元素。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6347427182763909000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`flavor_list = [\'vanilla\', \'chocolate\', \'pecan\', \'strawberry\']\n\nfor flavor in flavor_list:\n    print(f\'{flavor} is delicious\')\n\n>>>\nvanilla is delicious\nchocolate is delicious\npecan is delicious\nstrawberry is delicious`, `6347427182763909000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">flavor_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'vanilla\'</span><span class="token punctuation">,</span> <span class="token string">\'chocolate\'</span><span class="token punctuation">,</span> <span class="token string">\'pecan\'</span><span class="token punctuation">,</span> <span class="token string">\'strawberry\'</span><span class="token punctuation">]</span>\n\n<span class="token keyword">for</span> flavor <span class="token keyword">in</span> flavor_list<span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>flavor<span class="token punctuation">}</span></span><span class="token string"> is delicious\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nvanilla <span class="token keyword">is</span> delicious\nchocolate <span class="token keyword">is</span> delicious\npecan <span class="token keyword">is</span> delicious\nstrawberry <span class="token keyword">is</span> delicious</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当然有的时候，在迭代 list 的过程中也需要知道当前处理的这个元素在 list 里的位置。例如，我把爱吃的冰激淋口味写在 <code class="language-text">flavor_list</code> 列表里面，在打印每种口味时，我还想指出这种口味在自己心目中的排名。为了实现这样的功能，我们可以用传统的 range 方式来实现。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74888764495939110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`flavor_list = [\'vanilla\', \'chocolate\', \'pecan\', \'strawberry\']\n\nfor i in range(len(flavor_list)):\n    flavor = flavor_list[i]\n    print(f\'{i+1}: {flavor}\')\n\n>>>\n1: vanilla\n2: chocolate\n3: pecan\n4: strawberry`, `74888764495939110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">flavor_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'vanilla\'</span><span class="token punctuation">,</span> <span class="token string">\'chocolate\'</span><span class="token punctuation">,</span> <span class="token string">\'pecan\'</span><span class="token punctuation">,</span> <span class="token string">\'strawberry\'</span><span class="token punctuation">]</span>\n\n<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>flavor_list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    flavor <span class="token operator">=</span> flavor_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>flavor<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">1</span><span class="token punctuation">:</span> vanilla\n<span class="token number">2</span><span class="token punctuation">:</span> chocolate\n<span class="token number">3</span><span class="token punctuation">:</span> pecan\n<span class="token number">4</span><span class="token punctuation">:</span> strawberry</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><code class="language-text">range(len(flavor_list))</code> 的写法太过复杂，可以用 enumerate 代替。enumerate 能够把任何一种迭代器（iterator）封装成惰性生成器（lazy generator，参见第 30 条）</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45188602288429800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`flavor_list = [\'vanilla\', \'chocolate\', \'pecan\', \'strawberry\']\n\nit = enumerate(flavor_list)\nprint(next(it))\nprint(next(it))\n\n>>>\n(0, \'vanilla\')\n(1, \'chocolate\')`, `45188602288429800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">flavor_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'vanilla\'</span><span class="token punctuation">,</span> <span class="token string">\'chocolate\'</span><span class="token punctuation">,</span> <span class="token string">\'pecan\'</span><span class="token punctuation">,</span> <span class="token string">\'strawberry\'</span><span class="token punctuation">]</span>\n\nit <span class="token operator">=</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>flavor_list<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">next</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">next</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">\'vanilla\'</span><span class="token punctuation">)</span>\n<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'chocolate\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35995845668723180000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`flavor_list = [\'vanilla\', \'chocolate\', \'pecan\', \'strawberry\']\n\nfor i, flavor in enumerate(flavor_list):\n    print(f\'{i + 1}: {flavor}\')\n\n>>>\n1: vanilla\n2: chocolate\n3: pecan\n4: strawberry`, `35995845668723180000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">flavor_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'vanilla\'</span><span class="token punctuation">,</span> <span class="token string">\'chocolate\'</span><span class="token punctuation">,</span> <span class="token string">\'pecan\'</span><span class="token punctuation">,</span> <span class="token string">\'strawberry\'</span><span class="token punctuation">]</span>\n\n<span class="token keyword">for</span> i<span class="token punctuation">,</span> flavor <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>flavor_list<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>flavor<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">1</span><span class="token punctuation">:</span> vanilla\n<span class="token number">2</span><span class="token punctuation">:</span> chocolate\n<span class="token number">3</span><span class="token punctuation">:</span> pecan\n<span class="token number">4</span><span class="token punctuation">:</span> strawberry</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>另外，还可以通过 enumerate 的第二个参数指定起始序号，这样就不用在每次打印的时候去调整了。例如，本例可以从 1 开始计算。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59171981147495645000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`for i, flavor in enumerate(flavor_list, 1):\n    print(f\'{i + 1}: {flavor}\')`, `59171981147495645000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">for</span> i<span class="token punctuation">,</span> flavor <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>flavor_list<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>flavor<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h3 id="总结-3"><a href="#%E6%80%BB%E7%BB%93-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>enumerate 函数可以用简洁的代码迭代 iterator，而且可以指出当前这轮循环的序号。</li>\n<li>不要先通过 range 指定下标的取值范围，然后用下标去访问序列，而是应该直接用 enumerate 函数迭代。</li>\n<li>可以通过 enumerate 的第二个参数指定起始序号（默认为 0）。</li>\n</ol>\n<h2 id="第-8-条：用-zip-函数同时遍历两个迭代器"><a href="#%E7%AC%AC-8-%E6%9D%A1%EF%BC%9A%E7%94%A8-zip-%E5%87%BD%E6%95%B0%E5%90%8C%E6%97%B6%E9%81%8D%E5%8E%86%E4%B8%A4%E4%B8%AA%E8%BF%AD%E4%BB%A3%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 8 条：用 zip 函数同时遍历两个迭代器</h2>\n<p>写 Python 代码时，经常会根据某份列表中的对象创建许多与这份列表有关的新列表。下面这样的列表推导机制，可以把表达式运用到源列表的每个元素上面，从而生成一份派生列表（参见第 27 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71067660784233100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`names = [\'Cecilia\', \'Lise\', \'Marie\']\ncounts = [len(n) for n in names]\nprint(counts)\n\n>>>\n[7, 4, 5]`, `71067660784233100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'Cecilia\'</span><span class="token punctuation">,</span> <span class="token string">\'Lise\'</span><span class="token punctuation">,</span> <span class="token string">\'Marie\'</span><span class="token punctuation">]</span>\ncounts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token keyword">for</span> n <span class="token keyword">in</span> names<span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>counts<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>派生列表中的元素与源列表中对应位置上面的元素有着一定的关系。如果想同时遍历这两份列表，那可以根据源列表的长度做迭代。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75839276380605100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`names = [\'Cecilia\', \'Lise\', \'Marie\']\ncounts = [len(n) for n in names]\n\nlongest_name = None\nmax_count = 0\nfor i in range(len(names)):\n    count = counts[i]\n    if count > max_count:\n        longest_name = names[i]\n        max_count = count\n\nprint(longest_name)\n\n>>>\nCecilia`, `75839276380605100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'Cecilia\'</span><span class="token punctuation">,</span> <span class="token string">\'Lise\'</span><span class="token punctuation">,</span> <span class="token string">\'Marie\'</span><span class="token punctuation">]</span>\ncounts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token keyword">for</span> n <span class="token keyword">in</span> names<span class="token punctuation">]</span>\n\nlongest_name <span class="token operator">=</span> <span class="token boolean">None</span>\nmax_count <span class="token operator">=</span> <span class="token number">0</span>\n<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>names<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    count <span class="token operator">=</span> counts<span class="token punctuation">[</span>i<span class="token punctuation">]</span>\n    <span class="token keyword">if</span> count <span class="token operator">></span> max_count<span class="token punctuation">:</span>\n        longest_name <span class="token operator">=</span> names<span class="token punctuation">[</span>i<span class="token punctuation">]</span>\n        max_count <span class="token operator">=</span> count\n\n<span class="token keyword">print</span><span class="token punctuation">(</span>longest_name<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nCecilia</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种写法的问题在于，整个循环代码看起来很乱。我们要通过下标访问 names 与 counts 这两个列表里的元素，所以表示下标的那个循环变量 i 在循环体里必须出现两次，这让代码变得不太好懂。改用 enumerate 实现（参见第 7 条）会稍微好一些，但仍然不够理想。</p>\n<p>为了把代码写得更清楚，可以用 Python 内置的 zip 函数来实现。这个函数能把两个或更多的 iterator 封装成惰性生成器（lazy generator）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51329869310601490000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`for name, count in zip(names, counts):\n    if count > max_count:\n        longest_name = name\n        max_count = count`, `51329869310601490000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">for</span> name<span class="token punctuation">,</span> count <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> counts<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> count <span class="token operator">></span> max_count<span class="token punctuation">:</span>\n        longest_name <span class="token operator">=</span> name\n        max_count <span class="token operator">=</span> count</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>zip 每次只从它封装的那些迭代器里面各自取出一个元素，所以即便源列表很长，程序也不会因为占用内存过多而崩溃。但是，如果输入 zip 的那些列表的长度不一致，那就得小心了。例如，我给 names 列表里又添加了一个名字，但是忘了把它的长度更新到 counts 列表之中。在这种情况下，用 zip 同时遍历这两份列表，会产生奇怪的结果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58754779723105970000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`names = [\'Cecilia\', \'Lise\', \'Marie\']\ncounts = [len(n) for n in names]\n\nlongest_name = None\nmax_count = 0\nfor name, count in zip(names, counts):\n    if count > max_count:\n        longest_name = name\n        max_count = count\n\nnames.append(\'Rosalind\')\nfor name, count in zip(names, counts):\n    print(name)\n\n>>>\nCecilia\nLise\nMarie`, `58754779723105970000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'Cecilia\'</span><span class="token punctuation">,</span> <span class="token string">\'Lise\'</span><span class="token punctuation">,</span> <span class="token string">\'Marie\'</span><span class="token punctuation">]</span>\ncounts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token keyword">for</span> n <span class="token keyword">in</span> names<span class="token punctuation">]</span>\n\nlongest_name <span class="token operator">=</span> <span class="token boolean">None</span>\nmax_count <span class="token operator">=</span> <span class="token number">0</span>\n<span class="token keyword">for</span> name<span class="token punctuation">,</span> count <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> counts<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> count <span class="token operator">></span> max_count<span class="token punctuation">:</span>\n        longest_name <span class="token operator">=</span> name\n        max_count <span class="token operator">=</span> count\n\nnames<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">\'Rosalind\'</span><span class="token punctuation">)</span>\n<span class="token keyword">for</span> name<span class="token punctuation">,</span> count <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> counts<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nCecilia\nLise\nMarie</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>zip 函数只要其中任何一个迭代器处理完毕，它就不再往下走了。于是，循环的次数实际上等于最短的那份列表所具备的长度。一般情况下，我们都是根据某份列表推导出其他几份列表，然后把这些列表一起封装到 zip 里面，由于这些列表长度相同，因此不会遇到刚才的问题。</p>\n<p>在列表长度不同的情况下，zip 函数的提前终止行为可能跟你想实现的效果不一样。所以，如果无法确定这些列表的长度相同，那就不要把它们传给 zip，而是应该传给另一个叫作 <code class="language-text">zip_longest</code> 的函数，这个函数位于内置的 itertools 模块里。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70476953644394700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\nnames = [\'Cecilia\', \'Lise\', \'Marie\']\ncounts = [len(n) for n in names]\n\nlongest_name = None\nmax_count = 0\nfor name, count in zip(names, counts):\n    if count > max_count:\n        longest_name = name\n        max_count = count\n\nnames.append(\'Rosalind\')\n\nfor name, count in itertools.zip_longest(names, counts):\n    print(f\'{name}: {count}\')\n\n>>>\nCecilia: 7\nLise: 4\nMarie: 5\nRosalind: None`, `70476953644394700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\nnames <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'Cecilia\'</span><span class="token punctuation">,</span> <span class="token string">\'Lise\'</span><span class="token punctuation">,</span> <span class="token string">\'Marie\'</span><span class="token punctuation">]</span>\ncounts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token keyword">for</span> n <span class="token keyword">in</span> names<span class="token punctuation">]</span>\n\nlongest_name <span class="token operator">=</span> <span class="token boolean">None</span>\nmax_count <span class="token operator">=</span> <span class="token number">0</span>\n<span class="token keyword">for</span> name<span class="token punctuation">,</span> count <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> counts<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> count <span class="token operator">></span> max_count<span class="token punctuation">:</span>\n        longest_name <span class="token operator">=</span> name\n        max_count <span class="token operator">=</span> count\n\nnames<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">\'Rosalind\'</span><span class="token punctuation">)</span>\n\n<span class="token keyword">for</span> name<span class="token punctuation">,</span> count <span class="token keyword">in</span> itertools<span class="token punctuation">.</span>zip_longest<span class="token punctuation">(</span>names<span class="token punctuation">,</span> counts<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>count<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nCecilia<span class="token punctuation">:</span> <span class="token number">7</span>\nLise<span class="token punctuation">:</span> <span class="token number">4</span>\nMarie<span class="token punctuation">:</span> <span class="token number">5</span>\nRosalind<span class="token punctuation">:</span> <span class="token boolean">None</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果其中有些列表已经遍历完了，那么 <code class="language-text">zip_longest</code> 会用当初传给 fillvalue 参数的那个值来填补空缺（本例中空缺的为字符串 <code class="language-text">&#39;Rosalind&#39;</code> 的长度值），默认的参数值是 None。</p>\n<h3 id="总结-4"><a href="#%E6%80%BB%E7%BB%93-4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>内置的 zip 函数可以同时遍历多个迭代器。</li>\n<li>zip 会创建惰性生成器，让它每次只生成一个元组，所以无论输入的数据有多长，它都是一个一个处理的。</li>\n<li>如果提供的迭代器的长度不一致，那么只要其中任何一个迭代完毕，zip 就会停止。如果想按最长的那个迭代器来遍历，那就改用内置的 itertools 模块中的 <code class="language-text">zip_longest</code> 函数。</li>\n</ol>\n<h2 id="第-9-条：不要在-for-与-while-循环后面写-else-块"><a href="#%E7%AC%AC-9-%E6%9D%A1%EF%BC%9A%E4%B8%8D%E8%A6%81%E5%9C%A8-for-%E4%B8%8E-while-%E5%BE%AA%E7%8E%AF%E5%90%8E%E9%9D%A2%E5%86%99-else-%E5%9D%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 9 条：不要在 for 与 while 循环后面写 else 块</h2>\n<p>Python 的循环有一项大多数编程语言都不支持的特性，即可以把 else 块紧跟在整个循环结构的后面。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72479773985651510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`for i in range(3):\n    print(\'Loop\', i)\nelse:\n    print(\'Else block!\')\n\n>>>\nLoop 0\nLoop 1\nLoop 2\nElse block!`, `72479773985651510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Loop\'</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Else block!\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nLoop <span class="token number">0</span>\nLoop <span class="token number">1</span>\nLoop <span class="token number">2</span>\nElse block!</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果循环没有从头到尾执行完（也就是循环提前终止了），那么 else 块里的代码是不会执行的。在循环中使用 break 语句实际上会跳过 else 块。这个与实际想象中的功能差别较大</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24622354153562796000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`for i in range(3):\n    print(\'Loop\', i)\n    if i == 1:\n        break\nelse:\n    print(\'Else block!\')\n\n>>>\nLoop 0\nLoop 1`, `24622354153562796000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Loop\'</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>\n    <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>\n        <span class="token keyword">break</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Else block!\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nLoop <span class="token number">0</span>\nLoop <span class="token number">1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>还有一个奇怪的地方是，如果对空白序列做 for 循环，那么程序立刻就会执行 else 块。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40230174032009320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`for x in []:\n    print(\'Never runs\')\nelse:\n    print(\'For Else block!\')\n\n>>>\nFor Else block!`, `40230174032009320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Never runs\'</span><span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'For Else block!\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nFor Else block!</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>while 循环也是这样，如果首次循环就遇到 False，那么程序也会立刻运行 else 块。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34702506230963757000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`while False:\n    print(\'Never runs\')\nelse:\n    print(\'While Else block!\')\n\n>>>\nWhile Else block!`, `34702506230963757000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">while</span> <span class="token boolean">False</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Never runs\'</span><span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'While Else block!\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nWhile Else block!</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>把 else 设计成这样，是想让你利用它实现搜索逻辑。例如，如果要判断两个数是否互质（也就是除了 1 之外，是不是没有别的数能够同时整除它们），就可以用这种结构实现。先把有可能同时整除它们的数逐个试一遍，如果全都试过之后还是没找到这样的数，那么循环就会从头到尾执行完（这意味着循环没有因为 break 而提前跳出），然后程序就会执行 else 块里的代码。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85057578534971790000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = 4\nb = 9\n\nfor i in range(2, min(a, b) + 1):\n    print(\'Testing\', i)\n    if a % i == 0 and b % i == 0:\n        print(\'Not coprime\')\n        break\nelse:\n    print(\'Coprime\')\n\n>>>\nTesting 2\nTesting 3\nTesting 4\nCoprime`, `85057578534971790000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token number">4</span>\nb <span class="token operator">=</span> <span class="token number">9</span>\n\n<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Testing\'</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>\n    <span class="token keyword">if</span> a <span class="token operator">%</span> i <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">and</span> b <span class="token operator">%</span> i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Not coprime\'</span><span class="token punctuation">)</span>\n        <span class="token keyword">break</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Coprime\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTesting <span class="token number">2</span>\nTesting <span class="token number">3</span>\nTesting <span class="token number">4</span>\nCoprime</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>实际工作中，会改用辅助函数完成计算。这样的辅助函数有两种常见的写法。</p>\n<ol>\n<li>\n<p>只要发现某个条件成立，就立刻返回，如果始终都没碰到这种情况，那么循环就会完整地执行，让程序返回函数末尾的那个值作为默认返回值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70503977468662060000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def coprime(a, b):\n  for i in range(2, min(a, b) + 1):\n     if a % i == 0 and b % i == 0:\n           return False\n  return True\n\nassert coprime(4, 9)\nassert not coprime(3, 6)`, `70503977468662060000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">coprime</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n     <span class="token keyword">if</span> a <span class="token operator">%</span> i <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">and</span> b <span class="token operator">%</span> i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>\n           <span class="token keyword">return</span> <span class="token boolean">False</span>\n  <span class="token keyword">return</span> <span class="token boolean">True</span>\n\n<span class="token keyword">assert</span> coprime<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span>\n<span class="token keyword">assert</span> <span class="token keyword">not</span> coprime<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>用变量来记录循环过程中有没有碰到这样的情况，如果有，那就用 break 提前跳出循环，如果没有，循环就会完整地执行，无论如何，最后都返回这个变量的值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1676392052064867800"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def coprime_alternate(a, b):\n  is_coprime = True\n  for i in range(2, min(a, b) + 1):\n     if a % i == 0 and b % i == 0:\n           is_coprime = False\n           break\n  return is_coprime\n\nassert coprime_alternate(4, 9)\nassert not coprime_alternate(3, 6)`, `1676392052064867800`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">coprime_alternate</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  is_coprime <span class="token operator">=</span> <span class="token boolean">True</span>\n  <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n     <span class="token keyword">if</span> a <span class="token operator">%</span> i <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">and</span> b <span class="token operator">%</span> i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>\n           is_coprime <span class="token operator">=</span> <span class="token boolean">False</span>\n           <span class="token keyword">break</span>\n  <span class="token keyword">return</span> is_coprime\n\n<span class="token keyword">assert</span> coprime_alternate<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span>\n<span class="token keyword">assert</span> <span class="token keyword">not</span> coprime_alternate<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n</ol>\n<p>for/else 或 while/else 结构本身虽然可以实现某些逻辑表达，但它带来的困惑，已经盖过了它的好处。</p>\n<h3 id="总结-5"><a href="#%E6%80%BB%E7%BB%93-5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>Python 有种特殊的语法，可以把 else 块紧跟在整个 for 循环或 while 循环的后面。</li>\n<li>只有在整个循环没有因为 break 提前跳出的情况下，else 块才会执行</li>\n<li>把 else 块紧跟在整个循环后面，会让人不太容易看出这段代码的意思，所以要避免这样写。</li>\n</ol>\n<h2 id="第-10-条：用赋值表达式减少重复代码"><a href="#%E7%AC%AC-10-%E6%9D%A1%EF%BC%9A%E7%94%A8%E8%B5%8B%E5%80%BC%E8%A1%A8%E8%BE%BE%E5%BC%8F%E5%87%8F%E5%B0%91%E9%87%8D%E5%A4%8D%E4%BB%A3%E7%A0%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 10 条：用赋值表达式减少重复代码</h2>\n<p>赋值表达式（assignment expression）是 Python3.8 新引入的语法，它会用到海象操作符（walrus operator）。这种写法可以解决某些持续已久的代码重复问题。</p>\n<p>这种表达式很有用，可以在普通的赋值语句无法应用的场合实现赋值，例如可以用在条件表达式的 if 语句里面。赋值表达式的值，就是赋给海象操作符左侧那个标识符的值。</p>\n<p>举个例子。如果有一筐新鲜水果要给果汁店做食材，那我们就可以这样定义其中的内容：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58111450753674210000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`fresh_fruit = {\n    \'apple\': 10,\n    \'banana\': 8,\n    \'lemon\': 5,\n}\n\ndef make_lemonade(count):\n    pass\n\ndef out_of_stock():\n    pass\n\ncount = fresh_fruit.get(\'lemon\', 0)\nif count:\n    make_lemonade(count)\nelse:\n    out_of_stock()`, `58111450753674210000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">fresh_fruit <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'apple\'</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>\n    <span class="token string">\'banana\'</span><span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span>\n    <span class="token string">\'lemon\'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">def</span> <span class="token function">make_lemonade</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n<span class="token keyword">def</span> <span class="token function">out_of_stock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\ncount <span class="token operator">=</span> fresh_fruit<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'lemon\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\n<span class="token keyword">if</span> count<span class="token punctuation">:</span>\n    make_lemonade<span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    out_of_stock<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这段代码看上去虽然简单，但还是显得有点儿松散，因为 count 变量虽然定义在整个 if/else 结构之上，然而只有 if 语句才会用到它，else 块根本就不需要使用这个变量。所以，这种写法让人误以为 count 是个重要的变量，if 和 else 都要用到它，但实际上并非如此。</p>\n<p>我们在 Python 里面经常要先获取某个值，然后判断它是否非零，如果是就执行某段代码。对于这种用法，我们以前总是要通过各种技巧，来避免 count 这样的变量重复出现在代码之中，这些技巧有时会让代码变得比较难懂（参考第 5 条里面提到的那些技巧）。Python 引入赋值表达式正是为了解决这样的问题。下面改用海象操作符来写：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67032657493908480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if count := fresh_fruit.get(\'lemon\', 0):\n    make_lemonade(count)\nelse:\n    out_of_stock()`, `67032657493908480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">if</span> count <span class="token punctuation">:</span><span class="token operator">=</span> fresh_fruit<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'lemon\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    make_lemonade<span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    out_of_stock<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>新代码虽然只省了一行，但读起来却清晰很多，因为这种写法明确体现出 count 变量只与 if 块有关。这个赋值表达式先把 <code class="language-text">:=</code> 右边的值赋给左边的 count 变量，然后对自身求值，也就是把变量的值当成整个表达式的值。由于表达式紧跟着 if，程序会根据它的值是否非零来决定该不该执行 if 块。这种先赋值再判断的做法，正是海象操作符想要表达的意思。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58173710297298570000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`fresh_fruit = {\n    \'apple\': 10,\n    \'banana\': 8,\n    \'lemon\': 5,\n}\n\ndef make_cider(count):\n    pass\n\ncount = fresh_fruit.get(\'apple\', 0)\n\nif count >= 4:\n    make_cider(count)\nelse:\n    out_of_stock()`, `58173710297298570000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">fresh_fruit <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'apple\'</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>\n    <span class="token string">\'banana\'</span><span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span>\n    <span class="token string">\'lemon\'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">def</span> <span class="token function">make_cider</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\ncount <span class="token operator">=</span> fresh_fruit<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'apple\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\n\n<span class="token keyword">if</span> count <span class="token operator">>=</span> <span class="token number">4</span><span class="token punctuation">:</span>\n    make_cider<span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    out_of_stock<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>同理以上代码可以修改如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48567468600580145000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if (count := fresh_fruit.get(\'apple\', 0)) >= 4:\n    make_lemonade(count)\nelse:\n    out_of_stock()`, `48567468600580145000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token punctuation">:</span><span class="token operator">=</span> fresh_fruit<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'apple\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">4</span><span class="token punctuation">:</span>\n    make_lemonade<span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    out_of_stock<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>与刚才那个例子一样，修改之后的代码也比原来少了一行。但是这次，我们还要注意另外一个现象：赋值表达式本身是放在一对括号里面的。为什么要这样做呢？因为我们要在 if 语句里面把这个表达式的结果跟 4 这个值相比较。刚才柠檬汁的例子没有加括号，因为那时只凭赋值表达式本身的值就能决定 if/else 的走向：只要表达式的值不是 0，程序就进入 if 分支。但是这次不行，这次要把这个赋值表达式放在更大的表达式里面，所以必须用括号把它括起来。当然，在没有必要加括号的情况下，还是尽量别加括号比较好。</p>\n<p>还有一种类似的逻辑也会出现刚才说的重复代码，这指的是：我们要根据情况给某个变量赋予不同的值，紧接着要用这个变量做参数来调用某个函数。例如，若顾客要点香蕉冰沙，那我们首先得把香蕉切成好几份，然后用其中的两份来制作这道冰沙。如果不够两份，那就抛出香蕉不足（OutOfBananas）异常。下面用传统的写法实现这种逻辑：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99943482206511370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def slice_bananas(count):\n    pass\n\n\nclass OutofBananas(Exception):\n    pass\n\n\ndef make_smoothies(count):\n    pass\n\n\nfresh_fruit = {\n    \'apple\': 10,\n    \'banana\': 8,\n    \'lemon\': 5,\n}\n\npieces = 0\ncount = fresh_fruit.get(\'banana\', 0)\nif count >= 2:\n    pieces = slice_bananas(count)\n\ntry:\n    smoothies = make_smoothies(pieces)\nexcept OutofBananas:\n    out_of_stock()`, `99943482206511370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">slice_bananas</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">OutofBananas</span><span class="token punctuation">(</span>Exception<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">def</span> <span class="token function">make_smoothies</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\nfresh_fruit <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'apple\'</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>\n    <span class="token string">\'banana\'</span><span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span>\n    <span class="token string">\'lemon\'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\npieces <span class="token operator">=</span> <span class="token number">0</span>\ncount <span class="token operator">=</span> fresh_fruit<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'banana\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\n<span class="token keyword">if</span> count <span class="token operator">>=</span> <span class="token number">2</span><span class="token punctuation">:</span>\n    pieces <span class="token operator">=</span> slice_bananas<span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    smoothies <span class="token operator">=</span> make_smoothies<span class="token punctuation">(</span>pieces<span class="token punctuation">)</span>\n<span class="token keyword">except</span> OutofBananas<span class="token punctuation">:</span>\n    out_of_stock<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>还有一种传统的写法也很常见，就是把 if/else 结构上方那条 pieces = 0 的赋值语句移动到 else 块中。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26425269147199582000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`count = fresh_fruit.get(\'banana\', 0)\nif count >= 2:\n    pieces = slice_bananas(count)\nelse:\n    pieces = 0\n\ntry:\n    smoothies = make_smoothies(pieces)\nexcept OutofBananas:\n    out_of_stock()`, `26425269147199582000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">count <span class="token operator">=</span> fresh_fruit<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'banana\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\n<span class="token keyword">if</span> count <span class="token operator">>=</span> <span class="token number">2</span><span class="token punctuation">:</span>\n    pieces <span class="token operator">=</span> slice_bananas<span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    pieces <span class="token operator">=</span> <span class="token number">0</span>\n\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    smoothies <span class="token operator">=</span> make_smoothies<span class="token punctuation">(</span>pieces<span class="token punctuation">)</span>\n<span class="token keyword">except</span> OutofBananas<span class="token punctuation">:</span>\n    out_of_stock<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种写法看上去稍微有点儿怪，因为 if 与 else 这两个分支都给 pieces 变量定义了初始值。根据 Python 的作用域规则，这种分别定义变量初始值的写法是成立的（参见第 21 条）。虽说成立，但这样写看起来比较别扭，所以很多人喜欢用第一种写法，也就是在进入 if/else 结构之前，先把 pieces 的初始值给设置好。</p>\n<p>改用海象操作符来实现，可以少写一行代码，而且能够压低 count 变量的地位，让它只出现在 if 块里，这样我们就能更清楚地意识到 pieces 变量才是整段代码的重点。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65295697699185680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pieces = 0\nif (count := fresh_fruit.get(\'banana\', 0)) >= 2:\n    pieces = slice_bananas(count)\n\ntry:\n    smoothies = make_smoothies(pieces)\nexcept OutofBananas:\n    out_of_stock()`, `65295697699185680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">pieces <span class="token operator">=</span> <span class="token number">0</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token punctuation">:</span><span class="token operator">=</span> fresh_fruit<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'banana\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">2</span><span class="token punctuation">:</span>\n    pieces <span class="token operator">=</span> slice_bananas<span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    smoothies <span class="token operator">=</span> make_smoothies<span class="token punctuation">(</span>pieces<span class="token punctuation">)</span>\n<span class="token keyword">except</span> OutofBananas<span class="token punctuation">:</span>\n    out_of_stock<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>对于在 if 与 else 分支里面分别定义 pieces 变量的写法来说，海象操作符也能让代码变得清晰，因为这次不用再把 count 变量放到整个 if/else 块的上方了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71072071341963250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if (count := fresh_fruit.get(\'banana\', 0)) >= 2:\n    pieces = slice_bananas(count)\nelse:\n    pieces = 0\n\ntry:\n    smoothies = make_smoothies(pieces)\nexcept OutofBananas:\n    out_of_stock()`, `71072071341963250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token punctuation">:</span><span class="token operator">=</span> fresh_fruit<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'banana\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">2</span><span class="token punctuation">:</span>\n    pieces <span class="token operator">=</span> slice_bananas<span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    pieces <span class="token operator">=</span> <span class="token number">0</span>\n\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    smoothies <span class="token operator">=</span> make_smoothies<span class="token punctuation">(</span>pieces<span class="token punctuation">)</span>\n<span class="token keyword">except</span> OutofBananas<span class="token punctuation">:</span>\n    out_of_stock<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Python 新手经常会遇到这样一种困难，就是找不到好办法来实现 switch/case 结构。最接近这种结构的做法是在 if/else 结构里面继续嵌套 if/else 结构，或者使用 if/elif/else 结构。</p>\n<p>例如，我们想按照一定的顺序自动给客人制作饮品，这样就不用点餐了。下面这段逻辑先判断能不能做香蕉冰沙，如果不能，就做苹果汁，还不行，就做柠檬汁：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82252869390187870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`count = fresh_fruit.get(\'banana\', 0)\nif count >= 2:\n    pieces = slice_bananas(count)\n    to_enjoy = make_smoothies(pieces)\nelse:\n    count = fresh_fruit.get(\'apple\', 0)\n    if count >= 4:\n        to_enjoy = make_cider(count)\n    else:\n        count = fresh_fruit.get(\'lemon\', 0)\n        if count:\n            to_enjoy = make_lemonade(count)\n        else:\n            to_enjoy = \'Nothing\'`, `82252869390187870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">count <span class="token operator">=</span> fresh_fruit<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'banana\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\n<span class="token keyword">if</span> count <span class="token operator">>=</span> <span class="token number">2</span><span class="token punctuation">:</span>\n    pieces <span class="token operator">=</span> slice_bananas<span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n    to_enjoy <span class="token operator">=</span> make_smoothies<span class="token punctuation">(</span>pieces<span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    count <span class="token operator">=</span> fresh_fruit<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'apple\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\n    <span class="token keyword">if</span> count <span class="token operator">>=</span> <span class="token number">4</span><span class="token punctuation">:</span>\n        to_enjoy <span class="token operator">=</span> make_cider<span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        count <span class="token operator">=</span> fresh_fruit<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'lemon\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\n        <span class="token keyword">if</span> count<span class="token punctuation">:</span>\n            to_enjoy <span class="token operator">=</span> make_lemonade<span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            to_enjoy <span class="token operator">=</span> <span class="token string">\'Nothing\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种难看的写法其实在 Python 代码里特别常见。幸好现在有了海象操作符，让我们能够轻松地模拟出很接近 switch/case 的方案。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2641754177742550000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if (count := fresh_fruit.get(\'banana\', 0)) >= 2:\n    pieces = slice_bananas(count)\n    to_enjoy = make_smoothies(pieces)\nelif (count := fresh_fruit.get(\'apple\', 0)) >= 4:\n    to_enjoy = make_cider(count)\nelif count := fresh_fruit.get(\'lemon\', 0):\n    to_enjoy = make_lemonade(count)\nelse:\n    to_enjoy = \'Nothing\'`, `2641754177742550000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token punctuation">:</span><span class="token operator">=</span> fresh_fruit<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'banana\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">2</span><span class="token punctuation">:</span>\n    pieces <span class="token operator">=</span> slice_bananas<span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n    to_enjoy <span class="token operator">=</span> make_smoothies<span class="token punctuation">(</span>pieces<span class="token punctuation">)</span>\n<span class="token keyword">elif</span> <span class="token punctuation">(</span>count <span class="token punctuation">:</span><span class="token operator">=</span> fresh_fruit<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'apple\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">4</span><span class="token punctuation">:</span>\n    to_enjoy <span class="token operator">=</span> make_cider<span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n<span class="token keyword">elif</span> count <span class="token punctuation">:</span><span class="token operator">=</span> fresh_fruit<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'lemon\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    to_enjoy <span class="token operator">=</span> make_lemonade<span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    to_enjoy <span class="token operator">=</span> <span class="token string">\'Nothing\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个版本只比原来短五行，但是看起来却清晰得多，因为嵌套深度与缩进层数都变少了。只要碰到刚才那种难看的结构，我们就应该考虑能不能改用海象操作符来写。</p>\n<p>Python 新手还会遇到一个困难，就是缺少 do/while 循环结构。例如，我们要把新来的水果做成果汁并且装到瓶子里面，直到水果用完为止。下面先用普通的 while 循环来实现：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59544118035877160000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def pick_fruit():\n    pass\n\n\ndef make_juice(fruit, count):\n    pass\n\n\nbottles = []\nfresh_fruit = pick_fruit()\nwhile fresh_fruit:\n    for fruit, count in fresh_fruit.items():\n        batch = make_juice(fruit, count)\n        bottles.extend(batch)\n    fresh_fruit = pick_fruit()`, `59544118035877160000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">pick_fruit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">def</span> <span class="token function">make_juice</span><span class="token punctuation">(</span>fruit<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\nbottles <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\nfresh_fruit <span class="token operator">=</span> pick_fruit<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">while</span> fresh_fruit<span class="token punctuation">:</span>\n    <span class="token keyword">for</span> fruit<span class="token punctuation">,</span> count <span class="token keyword">in</span> fresh_fruit<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        batch <span class="token operator">=</span> make_juice<span class="token punctuation">(</span>fruit<span class="token punctuation">,</span> count<span class="token punctuation">)</span>\n        bottles<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>batch<span class="token punctuation">)</span>\n    fresh_fruit <span class="token operator">=</span> pick_fruit<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种写法必须把 <code class="language-text">fresh_fruit = pick_fruit()</code> 写两次，第一次是在进入 while 循环之前，因为我们要给 <code class="language-text">fresh_fruit</code> 设定初始值，第二次是在 while 循环体的末尾，因为我们得把下一轮需要处理的水果列表填充到 <code class="language-text">fresh_fruit</code> 里面。如果想复用这行代码，可以考虑 loop-and-a-half 模式。这个模式虽然能消除重复，但是会让 while 循环看起来很笨，因为它成了无限循环，程序只能通过 break 语句跳出这个循环。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88436431213986280000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`bottles = []\nwhile True:\n   fresh_fruit = pick_fruit()\n   if not fresh_fruit:\n      break\n    for fruit, count in fresh_fruit.items():\n        batch = make_juice(fruit, count)\n        bottles.extend(batch)`, `88436431213986280000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">bottles <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>\n   fresh_fruit <span class="token operator">=</span> pick_fruit<span class="token punctuation">(</span><span class="token punctuation">)</span>\n   <span class="token keyword">if</span> <span class="token keyword">not</span> fresh_fruit<span class="token punctuation">:</span>\n      <span class="token keyword">break</span>\n    <span class="token keyword">for</span> fruit<span class="token punctuation">,</span> count <span class="token keyword">in</span> fresh_fruit<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        batch <span class="token operator">=</span> make_juice<span class="token punctuation">(</span>fruit<span class="token punctuation">,</span> count<span class="token punctuation">)</span>\n        bottles<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>batch<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>有了海象操作符，就不需要使用 <code class="language-text">loop-and-a-half</code> 模式了，我们可以在每轮循环的开头给 <code class="language-text">fresh_fruit</code> 变量赋值，并根据变量的值来决定要不要继续循环。这个写法简单易读，所以应该成为首选方案。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92025168108319100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`bottles = []\nwhile fresh_fruit := pick_fruit():\n    for fruit, count in fresh_fruit.items():\n        batch = make_juice(fruit, count)\n        bottles.extend(batch)`, `92025168108319100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">bottles <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n<span class="token keyword">while</span> fresh_fruit <span class="token punctuation">:</span><span class="token operator">=</span> pick_fruit<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> fruit<span class="token punctuation">,</span> count <span class="token keyword">in</span> fresh_fruit<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        batch <span class="token operator">=</span> make_juice<span class="token punctuation">(</span>fruit<span class="token punctuation">,</span> count<span class="token punctuation">)</span>\n        bottles<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>batch<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在其他一些场合，赋值表达式也能缩减重复代码（参见第 29 条）。总之，如果某个表达式或赋值操作多次出现在一组代码里面，那就可以考虑用赋值表达式把这段代码改得简单一些。</p>\n<h3 id="总结-6"><a href="#%E6%80%BB%E7%BB%93-6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>赋值表达式通过海象操作符（:=）给变量赋值，并且让这个值成为这条表达式的结果，于是，我们可以利用这项特性来缩减代码。如果赋值表达式是大表达式里的一部分，就得用一对括号把它括起来。</li>\n<li>虽说 Python 不支持 switch/case 与 do/while 结构，但可以利用赋值表达式清晰地模拟出这种逻辑。</li>\n</ol>\n<h1 id="列表与字典"><a href="#%E5%88%97%E8%A1%A8%E4%B8%8E%E5%AD%97%E5%85%B8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>列表与字典</h1>\n<h2 id="第-11-条：学会对序列做切片"><a href="#%E7%AC%AC-11-%E6%9D%A1%EF%BC%9A%E5%AD%A6%E4%BC%9A%E5%AF%B9%E5%BA%8F%E5%88%97%E5%81%9A%E5%88%87%E7%89%87" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 11 条：学会对序列做切片</h2>\n<p>Python 有这样一种写法，可以从序列里面切割（slice）出一部分内容，让我们能够轻松地获取原序列的某个子集合。最简单的用法就是切割内置的 list、str 与 bytes。其实，凡是实现了 <code class="language-text">__getitem__</code> 与 <code class="language-text">__setitem__</code> 这两个特殊方法的类都可以切割（参见第 43 条）。</p>\n<p>最基本的写法是用 <code class="language-text">somelist[start:end]</code> 这一形式来切割，也就是从 start 开始一直取到 end 这个位置，但不包含 end 本身的元素。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37927410969744015000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']\nprint(\'Middle two:   \', a[3:5])\nprint(\'All but ends: \', a[1:7])\n\n>>>\nMiddle two:    [\'d\', \'e\']\nAll but ends:  [\'b\', \'c\', \'d\', \'e\', \'f\', \'g\']`, `37927410969744015000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Middle two:   \'</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'All but ends: \'</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nMiddle two<span class="token punctuation">:</span>    <span class="token punctuation">[</span><span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">]</span>\nAll but ends<span class="token punctuation">:</span>  <span class="token punctuation">[</span><span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果是从头开始切割列表，那就应该省略冒号左侧的下标 0，这样看起来更清晰。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68773737709820805000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`assert a[:5] == a[0:5]`, `68773737709820805000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">assert</span> a<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">==</span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>如果一直取到列表末尾，那就应该省略冒号右侧的下标，因为用不着专门把它写出来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28221822210791637000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`assert a[5:] == a[5:len(a)]`, `28221822210791637000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">assert</span> a<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">==</span> a<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token builtin">len</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>用负数作下标表示从列表末尾往前算。下面这些切割方式，即便是刚看到这段代码的人也应该能明白是什么意思。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58537752346711654000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']\nprint(a[:]) # [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']\nprint(a[:5]) # [\'a\', \'b\', \'c\', \'d\', \'e\']\nprint(a[:-1]) # [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\']\nprint(a[4:]) # [\'e\', \'f\', \'g\', \'h\']\nprint(a[-3:]) # [\'f\', \'g\', \'h\']\nprint(a[2:5]) # [\'c\', \'d\', \'e\']\nprint(a[2:-1]) # [\'c\', \'d\', \'e\', \'f\', \'g\']\nprint(a[-3:-1]) # [\'f\', \'g\']`, `58537752346711654000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># [\'a\', \'b\', \'c\', \'d\', \'e\']</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\']</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># [\'e\', \'f\', \'g\', \'h\']</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># [\'f\', \'g\', \'h\']</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># [\'c\', \'d\', \'e\']</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># [\'c\', \'d\', \'e\', \'f\', \'g\']</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># [\'f\', \'g\']</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果起点与终点所确定的范围超出了列表的边界，那么系统会自动忽略不存在的元素。利用这项特性，很容易就能构造出一个最多只有若干元素的输入序列，例如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43180861889920850000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`first_twenty_items = a[:20]\nlast_twenty_items = a[-20:]`, `43180861889920850000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">first_twenty_items <span class="token operator">=</span> a<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">]</span>\nlast_twenty_items <span class="token operator">=</span> a<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">:</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>切割时所用的下标可以越界，但是直接访问列表时却不行，那样会让程序抛出异常。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51719065965469780000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a[20]\n\n>>>\nTraceback ...\nIndexError: list index out of range`, `51719065965469780000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nIndexError<span class="token punctuation">:</span> <span class="token builtin">list</span> index out of <span class="token builtin">range</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>切割出来的列表是一份全新的列表。即便把某个元素换掉，也不会影响原列表中的相应位置。那个位置上的元素还是旧值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67630799081003520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']\nb = a[3:]\nprint(\'Before:\', b)\nb[1] = 99\nprint(\'After: \', b)\nprint(\'No change:\', a)\n\n>>>\nBefore: [\'d\', \'e\', \'f\', \'g\', \'h\']\nAfter:  [\'d\', 99, \'f\', \'g\', \'h\']\nNo change: [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']`, `67630799081003520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span>\nb <span class="token operator">=</span> a<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Before:\'</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span>\nb<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">99</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After: \'</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'No change:\'</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span>\nAfter<span class="token punctuation">:</span>  <span class="token punctuation">[</span><span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span>\nNo change<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>切片可以出现在赋值符号的左侧，表示用右侧那些元素把原列表中位于这个范围之内的元素换掉。与 unpacking 形式的赋值不同，这种赋值不要求等号两边所指定的元素个数必须相同（如果是做 unpacking，那么等号左侧用来接收数值的变量个数必须与等号右边所提供的数值个数一致，例如 <code class="language-text">a, b = c[:2]</code>，参见第 6 条）。在原列表中，位于切片范围之前和之后的那些元素会予以保留，但是列表的长度可能有所变化。例如在下面这个例子中，列表会变短，因为赋值符号右侧只提供了 3 个值，但是左侧那个切片却涵盖了 5 个值，列表会比原来少两个元素。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67520184482405960000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']\nprint(\'Before \', a)\na[2:7] = [99, 22, 14]\nprint(\'After  \', a)\n\n>>>\nBefore  [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']\nAfter   [\'a\', \'b\', 99, 22, 14, \'h\']`, `67520184482405960000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Before \'</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>\na<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">99</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After  \'</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore  <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span>\nAfter   <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>下面这段代码会使列表变长，因为赋值符号右侧的元素数量比左侧那个切片所涵盖的元素数量要多。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54776937212469985000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']\nprint(\'Before \', a)\na[2:3] = [47, 11]\nprint(\'After  \', a)\n\n>>>\nBefore  [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']\nAfter   [\'a\', \'b\', 47, 11, \'d\', \'e\', \'f\', \'g\', \'h\']`, `54776937212469985000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Before \'</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>\na<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">47</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After  \'</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore  <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span>\nAfter   <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token number">47</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>起止位置都留空的切片，如果出现在赋值符号右侧，那么表示给这个列表做副本，这样制作出来的新列表内容和原列表相同，但身份不同。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23527593897856193000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`b = a[:]\nassert b == a and b is not a`, `23527593897856193000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">b <span class="token operator">=</span> a<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span>\n<span class="token keyword">assert</span> b <span class="token operator">==</span> a <span class="token keyword">and</span> b <span class="token keyword">is</span> <span class="token keyword">not</span> a</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>把不带起止下标的切片放在赋值符号左边，表示是用右边那个列表的副本把左侧列表的全部内容替换掉（注意，左侧列表依然保持原来的身份，系统不会分配新的列表）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99641170628831200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']\nb = a\nc = a[:]\nprint(\'Before a\', a)\nprint(\'Before b\', b)\nprint(\'Before c\', b)\na[:] = [101, 102, 103]\nassert b is a and c is not a  # Still the same list object\nprint(\'After a \', a)  # Now has different contents\nprint(\'After b \', b)  # Same list, so same contents as a\nprint(\'After c \', c)  # Not same list, same contents as a\n\n>>>\nBefore a [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']\nBefore b [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']\nBefore c [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']\nAfter a  [101, 102, 103]\nAfter b  [101, 102, 103]\nAfter c  [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']`, `99641170628831200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span>\nb <span class="token operator">=</span> a\nc <span class="token operator">=</span> a<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Before a\'</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Before b\'</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Before c\'</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span>\na<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">102</span><span class="token punctuation">,</span> <span class="token number">103</span><span class="token punctuation">]</span>\n<span class="token keyword">assert</span> b <span class="token keyword">is</span> a <span class="token keyword">and</span> c <span class="token keyword">is</span> <span class="token keyword">not</span> a  <span class="token comment"># Still the same list object</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After a \'</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>  <span class="token comment"># Now has different contents</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After b \'</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span>  <span class="token comment"># Same list, so same contents as a</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After c \'</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span>  <span class="token comment"># Not same list, same contents as a</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore a <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span>\nBefore b <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span>\nBefore c <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span>\nAfter a  <span class="token punctuation">[</span><span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">102</span><span class="token punctuation">,</span> <span class="token number">103</span><span class="token punctuation">]</span>\nAfter b  <span class="token punctuation">[</span><span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">102</span><span class="token punctuation">,</span> <span class="token number">103</span><span class="token punctuation">]</span>\nAfter c  <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="总结-7"><a href="#%E6%80%BB%E7%BB%93-7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>切片要尽可能写得简单一些：如果从头开始选取，就省略起始下标 0；如果选到序列末尾，就省略终止下标。</li>\n<li>切片允许起始下标或终止下标越界，所以很容易就能表达“取开头多少个元素”（例如 <code class="language-text">a[:20]</code>）或“取末尾多少个元素”（例如 <code class="language-text">a[-20:0]</code>）等含义，而不用担心切片是否真有这么多元素。</li>\n<li>把切片放在赋值符号的左侧可以将原列表中这段范围内的元素用赋值符号右侧的元素替换掉，但可能会改变原列表的长度。</li>\n</ol>\n<h2 id="第-12-条：不要在切片里同时指定起止下标与步进"><a href="#%E7%AC%AC-12-%E6%9D%A1%EF%BC%9A%E4%B8%8D%E8%A6%81%E5%9C%A8%E5%88%87%E7%89%87%E9%87%8C%E5%90%8C%E6%97%B6%E6%8C%87%E5%AE%9A%E8%B5%B7%E6%AD%A2%E4%B8%8B%E6%A0%87%E4%B8%8E%E6%AD%A5%E8%BF%9B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 12 条：不要在切片里同时指定起止下标与步进</h2>\n<p>除了基本的切片写法（参见第 11 条）外，Python 还有一种特殊的步进切片形式，也就是 somelist[start:end:stride]。这种形式会在每 n 个元素里面选取一个，这样很容易就能把奇数位置上的元素与偶数位置上的元素分别通过 <code class="language-text">x[::2]</code> 与 <code class="language-text">x[1::2]</code> 选取出来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47169390653474630000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`x = [\'red\', \'orange\', \'yellow\', \'green\', \'blue\', \'purple\']\nodds = x[::2]\nevens = x[1::2]\nprint(odds)\nprint(evens)\n\n>>>\n[\'red\', \'yellow\', \'blue\']\n[\'orange\', \'green\', \'purple\']`, `47169390653474630000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">x <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'red\'</span><span class="token punctuation">,</span> <span class="token string">\'orange\'</span><span class="token punctuation">,</span> <span class="token string">\'yellow\'</span><span class="token punctuation">,</span> <span class="token string">\'green\'</span><span class="token punctuation">,</span> <span class="token string">\'blue\'</span><span class="token punctuation">,</span> <span class="token string">\'purple\'</span><span class="token punctuation">]</span>\nodds <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>\nevens <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>odds<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>evens<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token string">\'red\'</span><span class="token punctuation">,</span> <span class="token string">\'yellow\'</span><span class="token punctuation">,</span> <span class="token string">\'blue\'</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token string">\'orange\'</span><span class="token punctuation">,</span> <span class="token string">\'green\'</span><span class="token punctuation">,</span> <span class="token string">\'purple\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>带有步进的切片经常会引发意外的效果，并且使程序出现 bug。例如，Python 里面有个常见的技巧，就是把 -1 当成步进值对 bytes 类型的字符串做切片，这样就能将字符串反转过来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1415915006332779800"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`x = b\'mongoose\'\ny = x[::-1]\nprint(y)\n\n>>>\nb\'esoognom\'`, `1415915006332779800`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">x <span class="token operator">=</span> <span class="token string">b\'mongoose\'</span>\ny <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token string">b\'esoognom\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Unicode 形式的字符串也可以这样反转（参见第 3 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14913850844397003000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`x = \'多喝水\'\ny = x[::-1]\nprint(y)\n\n>>>\n水喝多`, `14913850844397003000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">x <span class="token operator">=</span> <span class="token string">\'多喝水\'</span>\ny <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n水喝多</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但如果把这种字符串编码成 UTF-8 标准的字节数据，就不能用这个技巧来反转了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24793024437858980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`x = \'多喝水\'\nx = x.encode(\'utf-8\')\ny = x[::-1]\nz = y.decode(\'utf-8\')\n\n>>>\nTraceback ...\nUnicodeDecodeError: \'utf-8\' codec can\'t decode byte 0xb4 in position 0: invalid start byte`, `24793024437858980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">x <span class="token operator">=</span> <span class="token string">\'多喝水\'</span>\nx <span class="token operator">=</span> x<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">\'utf-8\'</span><span class="token punctuation">)</span>\ny <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>\nz <span class="token operator">=</span> y<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">\'utf-8\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nUnicodeDecodeError<span class="token punctuation">:</span> <span class="token string">\'utf-8\'</span> codec can\'t decode byte <span class="token number">0xb4</span> <span class="token keyword">in</span> position <span class="token number">0</span><span class="token punctuation">:</span> invalid start byte</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>除了 -1 之外，用其他负数做步进值，有没有意义呢？请看下面的例子：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13884936837894801000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`x = [\'a\', \'b\', \'c\', \'d\', \'e\', \'f\', \'g\', \'h\']\nprint(x[::2])  # [\'a\', \'c\', \'e\', \'g\']\nprint(x[::-2])  # [\'h\', \'f\', \'d\', \'b\']`, `13884936837894801000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">x <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">,</span> <span class="token string">\'e\'</span><span class="token punctuation">,</span> <span class="token string">\'f\'</span><span class="token punctuation">,</span> <span class="token string">\'g\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># [\'a\', \'c\', \'e\', \'g\']</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># [\'h\', \'f\', \'d\', \'b\']</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>上例中，<code class="language-text">::2</code> 表示从头开始往后选，每两个元素里面选一个。<code class="language-text">::-2</code> 的含义稍微有点儿绕，表示从末尾开始往前选，每两个元素里面选一个。</p>\n<p>同时使用起止下标与步进会让切片很难懂。方括号里面写三个值显得太过拥挤，读起来不大容易，而且在指定了步进值（尤其是负数步进值）的时候，我们必须很仔细地考虑：这究竟是从前往后取，还是从后往前取？</p>\n<p>为了避免这个问题，笔者建议大家不要把起止下标和步进值同时写在切片里。如果必须指定步进，那么尽量采用正数，而且要把起止下标都留空。即便必须同时使用步进值与起止下标，也应该考虑分成两次来写。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76063807270584240000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`y = x[::2]  # [\'a\', \'c\', \'e\', \'g\']\nz = y[1:-1] # [\'c\', \'e\']`, `76063807270584240000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">y <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>  <span class="token comment"># [\'a\', \'c\', \'e\', \'g\']</span>\nz <span class="token operator">=</span> y<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token comment"># [\'c\', \'e\']</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>像刚才那样先隔位选取然后再切割，会让程序多做一次浅拷贝（shallow copy）。所以，应该把最能缩减列表长度的那个切片操作放在前面。如果程序实在没有那么多时间或内存去分两步操作，那么可以改用内置的 itertools 模块中的 islice 方法（参见第 36 条），这个方法用起来更清晰，因为它的起止位置与步进值都不能是负数。</p>\n<h3 id="总结-8"><a href="#%E6%80%BB%E7%BB%93-8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>同时指定切片的起止下标与步进值理解起来会很困难。</li>\n<li>如果要指定步进值，那就省略起止下标，而且最好采用正数作为步进值，尽量别用负数。</li>\n<li>不要把起始位置、终止位置与步进值全都写在同一个切片操作里。如果必须同时使用这三项指标，那就分两次来做（其中一次隔位选取，另一次做切割），也可以改用 itertools 内置模块里的 islice 方法。</li>\n</ol>\n<h2 id="第-13-条：通过带星号的-unpacking-操作来捕获多个元素，不要用切片"><a href="#%E7%AC%AC-13-%E6%9D%A1%EF%BC%9A%E9%80%9A%E8%BF%87%E5%B8%A6%E6%98%9F%E5%8F%B7%E7%9A%84-unpacking-%E6%93%8D%E4%BD%9C%E6%9D%A5%E6%8D%95%E8%8E%B7%E5%A4%9A%E4%B8%AA%E5%85%83%E7%B4%A0%EF%BC%8C%E4%B8%8D%E8%A6%81%E7%94%A8%E5%88%87%E7%89%87" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 13 条：通过带星号的 unpacking 操作来捕获多个元素，不要用切片</h2>\n<p>基本的 unpacking 操作（参见第 6 条）有一项限制，就是必须提前确定需要拆解的序列的长度。例如，销售汽车的时候，我们可能会把每辆车的车龄写在一份列表中，然后按照从大到小的顺序排列好。如果试着通过基本的 unpacking 操作获取其中最旧的两辆车，那么程序运行时会出现异常。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67689777238330540000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`car_ages = [0, 9, 4, 8, 7, 20, 19, 1, 6, 15]\ncar_ages_descending = sorted(car_ages, reverse=True)\noldest, second_oldest = car_ages_descending\n\n>>>\nTraceback ...\nValueError: too many values to unpack (expected 2)`, `67689777238330540000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">car_ages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">]</span>\ncar_ages_descending <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>car_ages<span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\noldest<span class="token punctuation">,</span> second_oldest <span class="token operator">=</span> car_ages_descending\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nValueError<span class="token punctuation">:</span> too many values to unpack <span class="token punctuation">(</span>expected <span class="token number">2</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Python 新手经常通过下标与切片（参见第 11 条）来处理这个问题。例如，可以明确通过下标把最旧和第二旧的那两辆车取出来，然后把其余的车放到另一份列表中。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54661218666127655000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`car_ages = [0, 9, 4, 8, 7, 20, 19, 1, 6, 15]\ncar_ages_descending = sorted(car_ages, reverse=True)\noldest = car_ages_descending[0]\nsecond_oldest = car_ages_descending[1]\nothers = car_ages_descending[2:]\nprint(oldest, second_oldest, others)\n\n>>>\n20 19 [15, 9, 8, 7, 6, 4, 1, 0]`, `54661218666127655000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">car_ages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">]</span>\ncar_ages_descending <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>car_ages<span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\noldest <span class="token operator">=</span> car_ages_descending<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>\nsecond_oldest <span class="token operator">=</span> car_ages_descending<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>\nothers <span class="token operator">=</span> car_ages_descending<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>oldest<span class="token punctuation">,</span> second_oldest<span class="token punctuation">,</span> others<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">20</span> <span class="token number">19</span> <span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样做没问题，但是下标与切片会让代码看起来很乱。而且，用这种办法把序列中的元素分成多个子集合，其实很容易出错，因为我们通常容易把下标多写或少写一个位置。例如，若修改了其中一行，但却忘了更新另一行，那就会遇到这种错误。</p>\n<p>这个问题通过带星号的表达式（starred expression）来解决会更好一些，这也是一种 unpacking 操作，它可以把无法由普通变量接收的那些元素全都囊括进去。下面用带星号的 unpacking 操作改写刚才那段代码，这次既不用取下标，也不用做切片。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83042883314671100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`car_ages = [0, 9, 4, 8, 7, 20, 19, 1, 6, 15]\ncar_ages_descending = sorted(car_ages, reverse=True)\noldest, second_oldest, *others = car_ages_descending\nprint(oldest, second_oldest, others)\n\n>>>\n20 19 [15, 9, 8, 7, 6, 4, 1, 0]`, `83042883314671100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">car_ages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">]</span>\ncar_ages_descending <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>car_ages<span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\noldest<span class="token punctuation">,</span> second_oldest<span class="token punctuation">,</span> <span class="token operator">*</span>others <span class="token operator">=</span> car_ages_descending\n<span class="token keyword">print</span><span class="token punctuation">(</span>oldest<span class="token punctuation">,</span> second_oldest<span class="token punctuation">,</span> others<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">20</span> <span class="token number">19</span> <span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写简短易读，而且不容易出错，因为它不要求我们在修改完其中一个下标之后，还必须记得同步更新其他的下标。</p>\n<p>这种带星号的表达式可以出现在任意位置，所以它能够捕获序列中的任何一段元素。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89009949745257960000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`car_ages = [0, 9, 4, 8, 7, 20, 19, 1, 6, 15]\ncar_ages_descending = sorted(car_ages, reverse=True)\noldest, *others, youngest = car_ages_descending\nprint(oldest, youngest, others)\n*others, second_youngest, youngest = car_ages_descending\nprint(youngest, second_youngest, others)\n\n>>>\n20 0 [19, 15, 9, 8, 7, 6, 4, 1]\n0 1 [20, 19, 15, 9, 8, 7, 6, 4]`, `89009949745257960000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">car_ages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">]</span>\ncar_ages_descending <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>car_ages<span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\noldest<span class="token punctuation">,</span> <span class="token operator">*</span>others<span class="token punctuation">,</span> youngest <span class="token operator">=</span> car_ages_descending\n<span class="token keyword">print</span><span class="token punctuation">(</span>oldest<span class="token punctuation">,</span> youngest<span class="token punctuation">,</span> others<span class="token punctuation">)</span>\n<span class="token operator">*</span>others<span class="token punctuation">,</span> second_youngest<span class="token punctuation">,</span> youngest <span class="token operator">=</span> car_ages_descending\n<span class="token keyword">print</span><span class="token punctuation">(</span>youngest<span class="token punctuation">,</span> second_youngest<span class="token punctuation">,</span> others<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">20</span> <span class="token number">0</span> <span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>\n<span class="token number">0</span> <span class="token number">1</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>只不过，在使用这种写法时，至少要有一个普通的接收变量与它搭配，否则就会出现 SyntaxError。例如不能像下面这样，只使用带星号的表达式而不搭配普通变量。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56068521739094155000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`car_ages = [0, 9, 4, 8, 7, 20, 19, 1, 6, 15]\ncar_ages_descending = sorted(car_ages, reverse=True)\n*others = car_ages_descending\n\n>>>\nSyntaxError: starred assignment target must be in a list or tuple`, `56068521739094155000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">car_ages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">]</span>\ncar_ages_descending <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>car_ages<span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\n<span class="token operator">*</span>others <span class="token operator">=</span> car_ages_descending\n\n<span class="token operator">>></span><span class="token operator">></span>\nSyntaxError<span class="token punctuation">:</span> starred assignment target must be <span class="token keyword">in</span> a <span class="token builtin">list</span> <span class="token keyword">or</span> <span class="token builtin">tuple</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>另外，对于单层结构来说，同一级里面最多只能出现一次带星号的 unpacking。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57135557951423046000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`first, *middle, *second_middle, last = [1, 2, 3, 4]\n\n>>>\nSyntaxError: two starred expressions in assignment`, `57135557951423046000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">first<span class="token punctuation">,</span> <span class="token operator">*</span>middle<span class="token punctuation">,</span> <span class="token operator">*</span>second_middle<span class="token punctuation">,</span> last <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nSyntaxError<span class="token punctuation">:</span> two starred expressions <span class="token keyword">in</span> assignment</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果要拆解的结构有很多层，那么同一级的不同部分里面可以各自出现带星号的 unpacking 操作。当然笔者并不推荐这种写法（类似的建议参见第 19 条）。这里举这样一个例子，是想帮助大家理解这种带星号的表达式可以实现怎样的拆分效果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41544513699267990000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`car_inventory = {\n    \'Downtown\': (\'Silver Shadow\', \'Pinto\', \'DMC\'),\n    \'Airport\': (\'Skyline\', \'Viper\', \'Gremlin\', \'Nova\'),\n}\n\n((loc1, (best1, *rest1)),\n (loc2, (best2, *rest2))) = car_inventory.items()\nprint(f\'Best at {loc1} is {best1}, {len(rest1)} others\')\nprint(f\'Best at {loc2} is {best2}, {len(rest2)} others\')\n\n>>>\nBest at Downtown is Silver Shadow, 2 others\nBest at Airport is Skyline, 3 others`, `41544513699267990000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">car_inventory <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'Downtown\'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">\'Silver Shadow\'</span><span class="token punctuation">,</span> <span class="token string">\'Pinto\'</span><span class="token punctuation">,</span> <span class="token string">\'DMC\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token string">\'Airport\'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">\'Skyline\'</span><span class="token punctuation">,</span> <span class="token string">\'Viper\'</span><span class="token punctuation">,</span> <span class="token string">\'Gremlin\'</span><span class="token punctuation">,</span> <span class="token string">\'Nova\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\n<span class="token punctuation">(</span><span class="token punctuation">(</span>loc1<span class="token punctuation">,</span> <span class="token punctuation">(</span>best1<span class="token punctuation">,</span> <span class="token operator">*</span>rest1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n <span class="token punctuation">(</span>loc2<span class="token punctuation">,</span> <span class="token punctuation">(</span>best2<span class="token punctuation">,</span> <span class="token operator">*</span>rest2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> car_inventory<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Best at </span><span class="token interpolation"><span class="token punctuation">{</span>loc1<span class="token punctuation">}</span></span><span class="token string"> is </span><span class="token interpolation"><span class="token punctuation">{</span>best1<span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>rest1<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> others\'</span></span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Best at </span><span class="token interpolation"><span class="token punctuation">{</span>loc2<span class="token punctuation">}</span></span><span class="token string"> is </span><span class="token interpolation"><span class="token punctuation">{</span>best2<span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>rest2<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> others\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBest at Downtown <span class="token keyword">is</span> Silver Shadow<span class="token punctuation">,</span> <span class="token number">2</span> others\nBest at Airport <span class="token keyword">is</span> Skyline<span class="token punctuation">,</span> <span class="token number">3</span> others</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>带星号的表达式总会形成一份列表实例。如果要拆分的序列里已经没有元素留给它了，那么列表就是空白的。如果能提前确定有待处理的序列里至少会有 N 个元素，那么这项特性就相当有用。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4064914606464853500"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`short_list = [1, 2]\nfirst, second, *rest = short_list\nprint(first, second, rest)\n\n>>>\n1 2 []`, `4064914606464853500`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">short_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>\nfirst<span class="token punctuation">,</span> second<span class="token punctuation">,</span> <span class="token operator">*</span>rest <span class="token operator">=</span> short_list\n<span class="token keyword">print</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span> second<span class="token punctuation">,</span> rest<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">1</span> <span class="token number">2</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>unpacking 操作也可以用在迭代器上，但是这样写与把数据拆分到多个变量里面的那种基本写法相比，并没有太大优势。例如，我可以先构造长度为 2 的取值范围（range），并把它封装在 it 这个迭代器里，然后将其中的值拆分到 first 与 second 这两个变量里。但这样写还不如直接使用形式相符的静态列表（例如[1, 2]），那样更简单。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53940107567037890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`it = iter(range(1, 3))\nfirst, second = it\nprint(f\'{first} and {second}\')\n\n>>>\n1 and 2`, `53940107567037890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">it <span class="token operator">=</span> <span class="token builtin">iter</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\nfirst<span class="token punctuation">,</span> second <span class="token operator">=</span> it\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>first<span class="token punctuation">}</span></span><span class="token string"> and </span><span class="token interpolation"><span class="token punctuation">{</span>second<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">1</span> <span class="token keyword">and</span> <span class="token number">2</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>对迭代器做 unpacking 操作的好处，主要体现在带星号的用法上面，它使迭代器的拆分值更清晰。例如，这里有个生成器，每次可以从含有整个一周的汽车订单的 CSV 文件中取出一行数据。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44349875081627510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def generate_csv():\n    yield (\'Date\', \'Make\', \'Model\', \'Year\', \'Price\')\n    # ...`, `44349875081627510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">generate_csv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">yield</span> <span class="token punctuation">(</span><span class="token string">\'Date\'</span><span class="token punctuation">,</span> <span class="token string">\'Make\'</span><span class="token punctuation">,</span> <span class="token string">\'Model\'</span><span class="token punctuation">,</span> <span class="token string">\'Year\'</span><span class="token punctuation">,</span> <span class="token string">\'Price\'</span><span class="token punctuation">)</span>\n    <span class="token comment"># ...</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>我们可以用下标和切片来处理这个生成器所给出的结果，但这样写需要很多行代码，而且看着比较混乱。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10497018547652393000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def generate_csv():\n    yield (\'Date\', \'Make\', \'Model\', \'Year\', \'Price\')\n    yield (\'Date\', \'Make\', \'Model\', \'Year\', \'Price\')\n    yield (\'Date\', \'Make\', \'Model\', \'Year\', \'Price\')\n    yield (\'Date\', \'Make\', \'Model\', \'Year\', \'Price\')\n    yield (\'Date\', \'Make\', \'Model\', \'Year\', \'Price\')\n    # ...\n\n\nall_csv_rows = list(generate_csv())\nheader = all_csv_rows[0]\nrows = all_csv_rows[1:]\nprint(\'CSV Header:\', header)\nprint(\'Row count:\', len(rows))\n\n>>>\nCSV Header: (\'Date\', \'Make\', \'Model\', \'Year\', \'Price\')\nRow count: 4`, `10497018547652393000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">generate_csv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">yield</span> <span class="token punctuation">(</span><span class="token string">\'Date\'</span><span class="token punctuation">,</span> <span class="token string">\'Make\'</span><span class="token punctuation">,</span> <span class="token string">\'Model\'</span><span class="token punctuation">,</span> <span class="token string">\'Year\'</span><span class="token punctuation">,</span> <span class="token string">\'Price\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token punctuation">(</span><span class="token string">\'Date\'</span><span class="token punctuation">,</span> <span class="token string">\'Make\'</span><span class="token punctuation">,</span> <span class="token string">\'Model\'</span><span class="token punctuation">,</span> <span class="token string">\'Year\'</span><span class="token punctuation">,</span> <span class="token string">\'Price\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token punctuation">(</span><span class="token string">\'Date\'</span><span class="token punctuation">,</span> <span class="token string">\'Make\'</span><span class="token punctuation">,</span> <span class="token string">\'Model\'</span><span class="token punctuation">,</span> <span class="token string">\'Year\'</span><span class="token punctuation">,</span> <span class="token string">\'Price\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token punctuation">(</span><span class="token string">\'Date\'</span><span class="token punctuation">,</span> <span class="token string">\'Make\'</span><span class="token punctuation">,</span> <span class="token string">\'Model\'</span><span class="token punctuation">,</span> <span class="token string">\'Year\'</span><span class="token punctuation">,</span> <span class="token string">\'Price\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token punctuation">(</span><span class="token string">\'Date\'</span><span class="token punctuation">,</span> <span class="token string">\'Make\'</span><span class="token punctuation">,</span> <span class="token string">\'Model\'</span><span class="token punctuation">,</span> <span class="token string">\'Year\'</span><span class="token punctuation">,</span> <span class="token string">\'Price\'</span><span class="token punctuation">)</span>\n    <span class="token comment"># ...</span>\n\n\nall_csv_rows <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>generate_csv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\nheader <span class="token operator">=</span> all_csv_rows<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>\nrows <span class="token operator">=</span> all_csv_rows<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'CSV Header:\'</span><span class="token punctuation">,</span> header<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Row count:\'</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>rows<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nCSV Header<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">\'Date\'</span><span class="token punctuation">,</span> <span class="token string">\'Make\'</span><span class="token punctuation">,</span> <span class="token string">\'Model\'</span><span class="token punctuation">,</span> <span class="token string">\'Year\'</span><span class="token punctuation">,</span> <span class="token string">\'Price\'</span><span class="token punctuation">)</span>\nRow count<span class="token punctuation">:</span> <span class="token number">4</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>利用带星号的 unpacking 操作，我们可以把第一行（表头）单独放在 header 变量里，同时把迭代器所给出的其余内容合起来表示成 rows 变量。这样写就清楚多了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83099890779764300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def generate_csv():\n    yield (\'Date\', \'Make\', \'Model\', \'Year\', \'Price\')\n    yield (\'Date\', \'Make\', \'Model\', \'Year\', \'Price\')\n    yield (\'Date\', \'Make\', \'Model\', \'Year\', \'Price\')\n    yield (\'Date\', \'Make\', \'Model\', \'Year\', \'Price\')\n    yield (\'Date\', \'Make\', \'Model\', \'Year\', \'Price\')\n    # ...\n\n\nit = list(generate_csv())\nheader, *rows = it\nprint(\'CSV Header:\', header)\nprint(\'Row count:\', len(rows))\n\n>>>\nCSV Header: (\'Date\', \'Make\', \'Model\', \'Year\', \'Price\')\nRow count: 4`, `83099890779764300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">generate_csv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">yield</span> <span class="token punctuation">(</span><span class="token string">\'Date\'</span><span class="token punctuation">,</span> <span class="token string">\'Make\'</span><span class="token punctuation">,</span> <span class="token string">\'Model\'</span><span class="token punctuation">,</span> <span class="token string">\'Year\'</span><span class="token punctuation">,</span> <span class="token string">\'Price\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token punctuation">(</span><span class="token string">\'Date\'</span><span class="token punctuation">,</span> <span class="token string">\'Make\'</span><span class="token punctuation">,</span> <span class="token string">\'Model\'</span><span class="token punctuation">,</span> <span class="token string">\'Year\'</span><span class="token punctuation">,</span> <span class="token string">\'Price\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token punctuation">(</span><span class="token string">\'Date\'</span><span class="token punctuation">,</span> <span class="token string">\'Make\'</span><span class="token punctuation">,</span> <span class="token string">\'Model\'</span><span class="token punctuation">,</span> <span class="token string">\'Year\'</span><span class="token punctuation">,</span> <span class="token string">\'Price\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token punctuation">(</span><span class="token string">\'Date\'</span><span class="token punctuation">,</span> <span class="token string">\'Make\'</span><span class="token punctuation">,</span> <span class="token string">\'Model\'</span><span class="token punctuation">,</span> <span class="token string">\'Year\'</span><span class="token punctuation">,</span> <span class="token string">\'Price\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token punctuation">(</span><span class="token string">\'Date\'</span><span class="token punctuation">,</span> <span class="token string">\'Make\'</span><span class="token punctuation">,</span> <span class="token string">\'Model\'</span><span class="token punctuation">,</span> <span class="token string">\'Year\'</span><span class="token punctuation">,</span> <span class="token string">\'Price\'</span><span class="token punctuation">)</span>\n    <span class="token comment"># ...</span>\n\n\nit <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>generate_csv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\nheader<span class="token punctuation">,</span> <span class="token operator">*</span>rows <span class="token operator">=</span> it\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'CSV Header:\'</span><span class="token punctuation">,</span> header<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Row count:\'</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>rows<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nCSV Header<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">\'Date\'</span><span class="token punctuation">,</span> <span class="token string">\'Make\'</span><span class="token punctuation">,</span> <span class="token string">\'Model\'</span><span class="token punctuation">,</span> <span class="token string">\'Year\'</span><span class="token punctuation">,</span> <span class="token string">\'Price\'</span><span class="token punctuation">)</span>\nRow count<span class="token punctuation">:</span> <span class="token number">4</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>带星号的这部分总是会形成一份列表，所以要注意，这有可能耗尽计算机的全部内存并导致程序崩溃。首先必须确定系统有足够的内存可以存储拆分出来的结果数据，然后才可以对迭代器使用带星号的 unpacking 操作（还有另一种做法，参见第 31 条）。</p>\n<h3 id="总结-9"><a href="#%E6%80%BB%E7%BB%93-9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>拆分数据结构并把其中的数据赋给变量时，可以用带星号的表达式，将结构中无法与普通变量相匹配的内容捕获到一份列表里。</li>\n<li>这种带星号的表达式可以出现在赋值符号左侧的任意位置，它总是会形成一份含有零个或多个值的列表。</li>\n<li>在把列表拆解成互相不重叠的多个部分时，这种带星号的 unpacking 方式比较清晰，而通过下标与切片来实现的方式则很容易出错。</li>\n</ol>\n<h2 id="第-14-条：用-sort-方法的-key-参数来表示复杂的排序逻辑"><a href="#%E7%AC%AC-14-%E6%9D%A1%EF%BC%9A%E7%94%A8-sort-%E6%96%B9%E6%B3%95%E7%9A%84-key-%E5%8F%82%E6%95%B0%E6%9D%A5%E8%A1%A8%E7%A4%BA%E5%A4%8D%E6%9D%82%E7%9A%84%E6%8E%92%E5%BA%8F%E9%80%BB%E8%BE%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 14 条：用 sort 方法的 key 参数来表示复杂的排序逻辑</h2>\n<p>内置的列表类型提供了名叫 sort 的方法，可以根据多项指标给 list 实例中的元素排序。在默认情况下，sort 方法总是按照自然升序排列列表内的元素。例如，如果列表中的元素都是整数，那么它就按数值从小到大排列。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76807236249437390000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`numbers = [93, 86, 11, 68, 70]\nnumbers.sort()\nprint(numbers)\n\n>>>\n[11, 68, 70, 86, 93]`, `76807236249437390000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">numbers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">93</span><span class="token punctuation">,</span> <span class="token number">86</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">68</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">]</span>\nnumbers<span class="token punctuation">.</span>sort<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">68</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">,</span> <span class="token number">86</span><span class="token punctuation">,</span> <span class="token number">93</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这里定义了一个 Tool 类表示各种建筑工具，它带有 <code class="language-text">__repr__</code> 方法，因此我们能把这个类的实例打印成字符串。</p>\n<p>如果仅仅这样写，那么这个由该类的对象所构成的列表是没办法用 sort 方法排序的，因为 sort 方法发现，排序所需要的特殊方法并没有定义在 Tool 类中。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73083544711171514000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Tool:\n    def __init__(self, name, weight):\n        self.name = name\n        self.weight = weight\n\n    def __repr__(self):\n        return f\'Tool({self.name!r}, {self.weight})\'\n\n\ntools = [\n    Tool(\'level\', 3.5),\n    Tool(\'hammer\', 1.25),\n    Tool(\'screwdriver\', 0.5),\n    Tool(\'chisel\', 0.25),\n]\n\ntools.sort()\n\n>>>\nTraceback ...\nTypeError: \'<\' not supported between instances of \'Tool\' and \'Tool\'`, `73083544711171514000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Tool</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> weight<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name\n        self<span class="token punctuation">.</span>weight <span class="token operator">=</span> weight\n\n    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f\'Tool(</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>weight<span class="token punctuation">}</span></span><span class="token string">)\'</span></span>\n\n\ntools <span class="token operator">=</span> <span class="token punctuation">[</span>\n    Tool<span class="token punctuation">(</span><span class="token string">\'level\'</span><span class="token punctuation">,</span> <span class="token number">3.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    Tool<span class="token punctuation">(</span><span class="token string">\'hammer\'</span><span class="token punctuation">,</span> <span class="token number">1.25</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    Tool<span class="token punctuation">(</span><span class="token string">\'screwdriver\'</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    Tool<span class="token punctuation">(</span><span class="token string">\'chisel\'</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">]</span>\n\ntools<span class="token punctuation">.</span>sort<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> <span class="token string">\'&lt;\'</span> <span class="token keyword">not</span> supported between instances of <span class="token string">\'Tool\'</span> <span class="token keyword">and</span> <span class="token string">\'Tool\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>下面用 lambda 关键字定义这样的一个函数，把它传给 sort 方法的 key 参数，让我们能够按照 name 的字母顺序排列这些 Tool 对象。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6898622345864403000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Tool:\n    def __init__(self, name, weight):\n        self.name = name\n        self.weight = weight\n\n    def __repr__(self):\n        return f\'Tool({self.name!r}, {self.weight})\'\n\n\ntools = [\n    Tool(\'level\', 3.5),\n    Tool(\'hammer\', 1.25),\n    Tool(\'screwdriver\', 0.5),\n    Tool(\'chisel\', 0.25),\n]\n\nprint(\'Unsorted:\', repr(tools))\ntools.sort(key=lambda x: x.name)\nprint(\'\\nSorted:\', tools)\n\n>>>\nUnsorted: [Tool(\'level\', 3.5), Tool(\'hammer\', 1.25), Tool(\'screwdriver\', 0.5), Tool(\'chisel\', 0.25)]\n\nSorted: [Tool(\'chisel\', 0.25), Tool(\'hammer\', 1.25), Tool(\'level\', 3.5), Tool(\'screwdriver\', 0.5)]`, `6898622345864403000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Tool</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> weight<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name\n        self<span class="token punctuation">.</span>weight <span class="token operator">=</span> weight\n\n    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f\'Tool(</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>weight<span class="token punctuation">}</span></span><span class="token string">)\'</span></span>\n\n\ntools <span class="token operator">=</span> <span class="token punctuation">[</span>\n    Tool<span class="token punctuation">(</span><span class="token string">\'level\'</span><span class="token punctuation">,</span> <span class="token number">3.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    Tool<span class="token punctuation">(</span><span class="token string">\'hammer\'</span><span class="token punctuation">,</span> <span class="token number">1.25</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    Tool<span class="token punctuation">(</span><span class="token string">\'screwdriver\'</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    Tool<span class="token punctuation">(</span><span class="token string">\'chisel\'</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">]</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Unsorted:\'</span><span class="token punctuation">,</span> <span class="token builtin">repr</span><span class="token punctuation">(</span>tools<span class="token punctuation">)</span><span class="token punctuation">)</span>\ntools<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">.</span>name<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'\\nSorted:\'</span><span class="token punctuation">,</span> tools<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nUnsorted<span class="token punctuation">:</span> <span class="token punctuation">[</span>Tool<span class="token punctuation">(</span><span class="token string">\'level\'</span><span class="token punctuation">,</span> <span class="token number">3.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Tool<span class="token punctuation">(</span><span class="token string">\'hammer\'</span><span class="token punctuation">,</span> <span class="token number">1.25</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Tool<span class="token punctuation">(</span><span class="token string">\'screwdriver\'</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Tool<span class="token punctuation">(</span><span class="token string">\'chisel\'</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n\nSorted<span class="token punctuation">:</span> <span class="token punctuation">[</span>Tool<span class="token punctuation">(</span><span class="token string">\'chisel\'</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Tool<span class="token punctuation">(</span><span class="token string">\'hammer\'</span><span class="token punctuation">,</span> <span class="token number">1.25</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Tool<span class="token punctuation">(</span><span class="token string">\'level\'</span><span class="token punctuation">,</span> <span class="token number">3.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Tool<span class="token punctuation">(</span><span class="token string">\'screwdriver\'</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>有时我们可能需要用多个标准来排序。可以利用元组的特性：如果两个元组的首个元素相等，就比较第二个元素，如果仍然相等，就继续往下比较。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61532024077826940000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Tool:\n    def __init__(self, name, weight):\n        self.name = name\n        self.weight = weight\n\n    def __repr__(self):\n        return f\'Tool({self.name!r}, {self.weight})\'\n\n\npower_tools = [\n    Tool(\'drill\', 4),\n    Tool(\'circular saw\', 5),\n    Tool(\'jackhammer\', 40),\n    Tool(\'sander\', 4),\n]\n\npower_tools.sort(key=lambda x: (x.weight, x.name))\nprint(power_tools)\n\npower_tools.sort(key=lambda x: (x.weight, x.name), reverse=True)\nprint(power_tools)\n\n>>>\n[Tool(\'drill\', 4), Tool(\'sander\', 4), Tool(\'circular saw\', 5), Tool(\'jackhammer\', 40)]\n[Tool(\'jackhammer\', 40), Tool(\'circular saw\', 5), Tool(\'sander\', 4), Tool(\'drill\', 4)]`, `61532024077826940000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Tool</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> weight<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name\n        self<span class="token punctuation">.</span>weight <span class="token operator">=</span> weight\n\n    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f\'Tool(</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>weight<span class="token punctuation">}</span></span><span class="token string">)\'</span></span>\n\n\npower_tools <span class="token operator">=</span> <span class="token punctuation">[</span>\n    Tool<span class="token punctuation">(</span><span class="token string">\'drill\'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    Tool<span class="token punctuation">(</span><span class="token string">\'circular saw\'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    Tool<span class="token punctuation">(</span><span class="token string">\'jackhammer\'</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    Tool<span class="token punctuation">(</span><span class="token string">\'sander\'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">]</span>\n\npower_tools<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>weight<span class="token punctuation">,</span> x<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>power_tools<span class="token punctuation">)</span>\n\npower_tools<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>weight<span class="token punctuation">,</span> x<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>power_tools<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span>Tool<span class="token punctuation">(</span><span class="token string">\'drill\'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Tool<span class="token punctuation">(</span><span class="token string">\'sander\'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Tool<span class="token punctuation">(</span><span class="token string">\'circular saw\'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Tool<span class="token punctuation">(</span><span class="token string">\'jackhammer\'</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span>Tool<span class="token punctuation">(</span><span class="token string">\'jackhammer\'</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Tool<span class="token punctuation">(</span><span class="token string">\'circular saw\'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Tool<span class="token punctuation">(</span><span class="token string">\'sander\'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Tool<span class="token punctuation">(</span><span class="token string">\'drill\'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种做法有个缺点，就是 key 函数所构造的这个元组只能按同一个排序方向来对比它所表示的各项指标（要是升序，就都得是升序；要是降序，就都得是降序），可以利用以下方法实现不同方向的排序</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79553845381691830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`power_tools.sort(key=lambda x: (-x.weight, x.name))\nprint(power_tools)`, `79553845381691830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">power_tools<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token operator">-</span>x<span class="token punctuation">.</span>weight<span class="token punctuation">,</span> x<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>power_tools<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>但是 str 类型不支持一元减操作符，可以通过多次调用 sort 方法实现不同方向的排序，这里利用了 sort 方法是稳定排序算法的原理</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23596206755156324000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`power_tools.sort(key=lambda x: x.name)  # Name ascending\npower_tools.sort(key=lambda x: x.weight, reverse=True)  # Weight descending\nprint(power_tools)`, `23596206755156324000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">power_tools<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">.</span>name<span class="token punctuation">)</span>  <span class="token comment"># Name ascending</span>\npower_tools<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">.</span>weight<span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># Weight descending</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>power_tools<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>无论有多少项排序指标都可以按照这种思路来实现，而且每项指标可以分别按照各自的方向来排，不用全都是升序或全都是降序。只需要倒着写即可，也就是把最主要的那项排序指标放在最后一轮处理。在上面的例子中，首要指标是重量降序，次要指标是名称升序，所以先按名称升序排列，然后按重量降序排列。</p>\n<p>尽管这两种思路都能实现同样的效果，但只调用一次 sort，还是要比多次调用 sort 更为简单。所以，在实现多个指标按不同方向排序时，应该优先考虑让 key 函数返回元组，并对元组中的相应指标取相反数。只有在万不得已的时候，才可以考虑多次调用 sort 方法。</p>\n<h3 id="总结-10"><a href="#%E6%80%BB%E7%BB%93-10" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>列表的 sort 方法可以根据自然顺序给其中的字符串、整数、元组等内置类型的元素进行排序。</li>\n<li>普通对象如果通过特殊方法定义了自然顺序，那么也可以用 sort 方法来排列，但这样的对象并不多见。</li>\n<li>可以把辅助函数传给 sort 方法的 key 参数，让 sort 根据这个函数所返回的值来排列元素顺序，而不是根据元素本身来排列。</li>\n<li>如果排序时要依据的指标有很多项，可以把它们放在一个元组中，让 key 函数返回这样的元组。对于支持一元减操作符的类型来说，可以单独给这项指标取反，让排序算法在这项指标上按照相反的方向处理。</li>\n<li>如果这些指标不支持一元减操作符，可以多次调用 sort 方法，并在每次调用时分别指定 key 函数与 reverse 参数。最次要的指标放在第一轮处理，然后逐步处理更为重要的指标，首要指标放在最后一轮处理。</li>\n</ol>\n<h2 id="第-15-条：不要过分依赖给字典添加条目时所用的顺序"><a href="#%E7%AC%AC-15-%E6%9D%A1%EF%BC%9A%E4%B8%8D%E8%A6%81%E8%BF%87%E5%88%86%E4%BE%9D%E8%B5%96%E7%BB%99%E5%AD%97%E5%85%B8%E6%B7%BB%E5%8A%A0%E6%9D%A1%E7%9B%AE%E6%97%B6%E6%89%80%E7%94%A8%E7%9A%84%E9%A1%BA%E5%BA%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 15 条：不要过分依赖给字典添加条目时所用的顺序</h2>\n<p>在 Python 3.5 与之前的版本中，迭代字典（dict）时所看到的顺序好像是任意的，不一定与当初把这些键值对添加到字典时的顺序相同。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13822815590978021000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# Python 3.5\nbaby_names = {\n    \'cat\': \'kitten\',\n    \'dog\': \'puppy\',\n}\n\nprint(baby_names)\n\n>>>\n{\'dog\': \'puppy\', \'cat\': \'kitten\'}`, `13822815590978021000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment"># Python 3.5</span>\nbaby_names <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'cat\'</span><span class="token punctuation">:</span> <span class="token string">\'kitten\'</span><span class="token punctuation">,</span>\n    <span class="token string">\'dog\'</span><span class="token punctuation">:</span> <span class="token string">\'puppy\'</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span>baby_names<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">{</span><span class="token string">\'dog\'</span><span class="token punctuation">:</span> <span class="token string">\'puppy\'</span><span class="token punctuation">,</span> <span class="token string">\'cat\'</span><span class="token punctuation">:</span> <span class="token string">\'kitten\'</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>之所以出现这种效果，是因为字典类型以前是用哈希表算法来实现的（这个算法通过内置的 hash 函数与一个随机的种子数来运行，而该种子数会在每次启动 Python 解释器时确定）。所以，这样的机制导致这些键值对在字典中的存放顺序不一定会与添加时的顺序相同，而且每次运行程序的时候，存放顺序可能都不一样。</p>\n<p>从 Python 3.6 开始，字典会保留这些键值对在添加时所用的顺序，而且 Python 3.7 版的语言规范正式确立了这条规则。于是，在新版的 Python 里，总是能够按照当初创建字典时的那套顺序来遍历这些键值对。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6300212204806454000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`baby_names = {\n    \'cat\': \'kitten\',\n    \'dog\': \'puppy\',\n}\n\nprint(baby_names)\n\n>>>\n{\'cat\': \'kitten\', \'dog\': \'puppy\'}`, `6300212204806454000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">baby_names <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'cat\'</span><span class="token punctuation">:</span> <span class="token string">\'kitten\'</span><span class="token punctuation">,</span>\n    <span class="token string">\'dog\'</span><span class="token punctuation">:</span> <span class="token string">\'puppy\'</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span>baby_names<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">{</span><span class="token string">\'cat\'</span><span class="token punctuation">:</span> <span class="token string">\'kitten\'</span><span class="token punctuation">,</span> <span class="token string">\'dog\'</span><span class="token punctuation">:</span> <span class="token string">\'puppy\'</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 Python 3.5 与之前的版本中，dict 所提供的许多方法（包括 keys、values、items 与 popitem 等）都不保证固定的顺序，所以让人觉得好像是随机处理的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10053965185390457000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`baby_names = {\n    \'cat\': \'kitten\',\n    \'dog\': \'puppy\',\n}\n\n# Python 3.5\nprint(list(baby_names.keys()))\nprint(list(baby_names.values()))\nprint(list(baby_names.items()))\nprint(baby_names.popitem())  # Randomly chooses an item\n\n>>>\n[\'dog\', \'cat\']\n[\'puppy\', \'kitten\']\n[(\'dog\', \'puppy\'), (\'cat\', \'kitten\')]\n(\'dog\', \'puppy\')`, `10053965185390457000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">baby_names <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'cat\'</span><span class="token punctuation">:</span> <span class="token string">\'kitten\'</span><span class="token punctuation">,</span>\n    <span class="token string">\'dog\'</span><span class="token punctuation">:</span> <span class="token string">\'puppy\'</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment"># Python 3.5</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>baby_names<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>baby_names<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>baby_names<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>baby_names<span class="token punctuation">.</span>popitem<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># Randomly chooses an item</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token string">\'dog\'</span><span class="token punctuation">,</span> <span class="token string">\'cat\'</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token string">\'puppy\'</span><span class="token punctuation">,</span> <span class="token string">\'kitten\'</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'dog\'</span><span class="token punctuation">,</span> <span class="token string">\'puppy\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">\'cat\'</span><span class="token punctuation">,</span> <span class="token string">\'kitten\'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n<span class="token punctuation">(</span><span class="token string">\'dog\'</span><span class="token punctuation">,</span> <span class="token string">\'puppy\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在新版的 Python 中，这些方法已经可以按照当初添加键值对时的顺序来处理了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84862914074803670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`baby_names = {\n    \'cat\': \'kitten\',\n    \'dog\': \'puppy\',\n}\n\nprint(list(baby_names.keys()))\nprint(list(baby_names.values()))\nprint(list(baby_names.items()))\nprint(baby_names.popitem())  # Randomly chooses an item\n\n>>>\n[\'cat\', \'dog\']\n[\'kitten\', \'puppy\']\n[(\'cat\', \'kitten\'), (\'dog\', \'puppy\')]\n(\'dog\', \'puppy\')`, `84862914074803670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">baby_names <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'cat\'</span><span class="token punctuation">:</span> <span class="token string">\'kitten\'</span><span class="token punctuation">,</span>\n    <span class="token string">\'dog\'</span><span class="token punctuation">:</span> <span class="token string">\'puppy\'</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>baby_names<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>baby_names<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>baby_names<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>baby_names<span class="token punctuation">.</span>popitem<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># Randomly chooses an item</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token string">\'cat\'</span><span class="token punctuation">,</span> <span class="token string">\'dog\'</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token string">\'kitten\'</span><span class="token punctuation">,</span> <span class="token string">\'puppy\'</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'cat\'</span><span class="token punctuation">,</span> <span class="token string">\'kitten\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">\'dog\'</span><span class="token punctuation">,</span> <span class="token string">\'puppy\'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n<span class="token punctuation">(</span><span class="token string">\'dog\'</span><span class="token punctuation">,</span> <span class="token string">\'puppy\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这项变化对 Python 中那些依赖字典类型及其实现细节的特性产生了很多影响。</p>\n<p>函数的关键字参数（包括万能的 <code class="language-text">**kwargs</code> 参数，参见第 23 条），以前是按照近乎随机的顺序出现的，这使函数调用操作变得很难调试。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11358587490020033000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# Python 3.5\ndef my_func(**kwargs):\n    for key, value in kwargs.items():\n        print(\'%s = %s\' % (key, value))\n\n\nmy_func(goose=\'gosling\', kangaroo=\'joey\')\n\n>>>\nkangaroo = joey\ngoose = gosling`, `11358587490020033000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment"># Python 3.5</span>\n<span class="token keyword">def</span> <span class="token function">my_func</span><span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> kwargs<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'%s = %s\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n\nmy_func<span class="token punctuation">(</span>goose<span class="token operator">=</span><span class="token string">\'gosling\'</span><span class="token punctuation">,</span> kangaroo<span class="token operator">=</span><span class="token string">\'joey\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nkangaroo <span class="token operator">=</span> joey\ngoose <span class="token operator">=</span> gosling</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在，这些关键字参数总是能够保留调用函数时所指定的那套顺序。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43579421675561410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def my_func(**kwargs):\n    for key, value in kwargs.items():\n        print(\'%s = %s\' % (key, value))\n\n\nmy_func(goose=\'gosling\', kangaroo=\'joey\')\n\n>>>\ngoose = gosling\nkangaroo = joey`, `43579421675561410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">my_func</span><span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> kwargs<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'%s = %s\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n\nmy_func<span class="token punctuation">(</span>goose<span class="token operator">=</span><span class="token string">\'gosling\'</span><span class="token punctuation">,</span> kangaroo<span class="token operator">=</span><span class="token string">\'joey\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\ngoose <span class="token operator">=</span> gosling\nkangaroo <span class="token operator">=</span> joey</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>另外，类也会利用字典来保存这个类的实例所具备的一些数据。在早前版本的 Python 中，对象（object）中的字段看上去好像是按随机顺序出现的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2592567097752129500"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyClass:\n    def __init__(self):\n        self.alligator = \'hatchling\'\n        self.elephant = \'calf\'\n\n\na = MyClass()\nfor key, value in a.__dict__.items():\n    print(\'%s = %s\' % (key, value))\n\n>>>\n# Python 3.5\nelephant = calf\nalligator = hatchling\n\n# Python > 3.5\nalligator = hatchling\nelephant = calf`, `2592567097752129500`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyClass</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>alligator <span class="token operator">=</span> <span class="token string">\'hatchling\'</span>\n        self<span class="token punctuation">.</span>elephant <span class="token operator">=</span> <span class="token string">\'calf\'</span>\n\n\na <span class="token operator">=</span> MyClass<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> a<span class="token punctuation">.</span>__dict__<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'%s = %s\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token comment"># Python 3.5</span>\nelephant <span class="token operator">=</span> calf\nalligator <span class="token operator">=</span> hatchling\n\n<span class="token comment"># Python > 3.5</span>\nalligator <span class="token operator">=</span> hatchling\nelephant <span class="token operator">=</span> calf</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在的 Python 语言规范已经要求，字典必须保留添加键值对时所依照的顺序。所以，我们可以利用这样的特征来实现一些功能，而且可以把它融入自己给类和函数所设计的 API 中。</p>\n<blockquote>\n<p>其实，内置的 collections 模块早就提供了这种能够保留插入顺序的字典，叫作 OrderedDict。它的行为跟（Python 3.7 以来的）标准 dict 类型很像，但性能上有很大区别。如果要频繁插入或弹出键值对（例如要实现 least-recently-used 缓存），那么 OrderedDict 可能比标准的 Python dict 类型更合适（如何判断是否应该换用这种类型，请参见第 70 条）。</p>\n</blockquote>\n<p>处理字典的时候，不能总是假设所有的字典都能保留键值对插入时的顺序。在 Python 中，我们很容易就能定义出特制的容器类型，并且让这些容器也像标准的 list 与 dict 等类型那样遵守相关的协议（参见第 43 条）。Python 不是静态类型的语言，大多数代码都以鸭子类型（duck typing）机制运作（也就是说，对象支持什么样的行为，就可以当成什么样的数据使用，而不用执着于它在类体系中的地位）。这种特性可能会产生意想不到的问题。</p>\n<p>例如，现在要写一个程序，统计各种小动物的受欢迎程度。我们可以设定一个字典，把每种动物和它得到的票数关联起来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96716277452910620000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`votes = {\n    \'otter\': 1281,\n    \'polar bear\': 587,\n    \'fox\': 863,\n}`, `96716277452910620000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">votes <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'otter\'</span><span class="token punctuation">:</span> <span class="token number">1281</span><span class="token punctuation">,</span>\n    <span class="token string">\'polar bear\'</span><span class="token punctuation">:</span> <span class="token number">587</span><span class="token punctuation">,</span>\n    <span class="token string">\'fox\'</span><span class="token punctuation">:</span> <span class="token number">863</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在定义一个函数来处理投票数据。用户可以把空的字典传给这个函数，这样的话，它就会把每个动物及其排名放到这个字典中。这种字典可以充当数据模型，给带有用户界面（UI）的元素提供数据。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65939131211757560000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def populate_ranks(votes, ranks):\n    names = list(votes.keys())\n    names.sort(key=votes.get, reverse=True)\n    for i, name in enumerate(names, 1):\n        ranks[name] = i`, `65939131211757560000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">populate_ranks</span><span class="token punctuation">(</span>votes<span class="token punctuation">,</span> ranks<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    names <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>votes<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    names<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span>votes<span class="token punctuation">.</span>get<span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\n    <span class="token keyword">for</span> i<span class="token punctuation">,</span> name <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        ranks<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> i</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们还需要写一个函数来查出人气最高的动物。这个函数假定 populate_ranks 总是会按照升序向字典写入键值对，这样第一个出现在字典里的就应该是排名最靠前的动物。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58528636828083030000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def get_winner(ranks):\n    return next(iter(ranks))`, `58528636828083030000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">get_winner</span><span class="token punctuation">(</span>ranks<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> <span class="token builtin">next</span><span class="token punctuation">(</span><span class="token builtin">iter</span><span class="token punctuation">(</span>ranks<span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>下面来验证刚才设计的函数，看它们能不能实现想要的结果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38962143286212680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`votes = {\n    \'otter\': 1281,\n    \'polar bear\': 587,\n    \'fox\': 863,\n}\n\n\ndef populate_ranks(votes, ranks):\n    names = list(votes.keys())\n    names.sort(key=votes.get, reverse=True)\n    for i, name in enumerate(names, 1):\n        ranks[name] = i\n\n\ndef get_winner(ranks):\n    return next(iter(ranks))\n\n\nranks = {}\npopulate_ranks(votes, ranks)\nprint(ranks)\nwinner = get_winner(ranks)\nprint(winner)\n\n>>>\n{\'otter\': 1, \'fox\': 2, \'polar bear\': 3}\notter`, `38962143286212680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">votes <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'otter\'</span><span class="token punctuation">:</span> <span class="token number">1281</span><span class="token punctuation">,</span>\n    <span class="token string">\'polar bear\'</span><span class="token punctuation">:</span> <span class="token number">587</span><span class="token punctuation">,</span>\n    <span class="token string">\'fox\'</span><span class="token punctuation">:</span> <span class="token number">863</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\n\n<span class="token keyword">def</span> <span class="token function">populate_ranks</span><span class="token punctuation">(</span>votes<span class="token punctuation">,</span> ranks<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    names <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>votes<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    names<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span>votes<span class="token punctuation">.</span>get<span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\n    <span class="token keyword">for</span> i<span class="token punctuation">,</span> name <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        ranks<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> i\n\n\n<span class="token keyword">def</span> <span class="token function">get_winner</span><span class="token punctuation">(</span>ranks<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> <span class="token builtin">next</span><span class="token punctuation">(</span><span class="token builtin">iter</span><span class="token punctuation">(</span>ranks<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n\nranks <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\npopulate_ranks<span class="token punctuation">(</span>votes<span class="token punctuation">,</span> ranks<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>ranks<span class="token punctuation">)</span>\nwinner <span class="token operator">=</span> get_winner<span class="token punctuation">(</span>ranks<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>winner<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">{</span><span class="token string">\'otter\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'fox\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">\'polar bear\'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">}</span>\notter</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>结果没有问题。但是，假设现在的需求变了，我们现在想要按照字母顺序在 UI 中显示，而不是像原来那样按照名次显示。为了实现这种效果，我们用内置的 collections.abc 模块定义这样一个类。这个类的功能和字典一样，而且会按照字母顺序迭代其中的内容。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63612498044453060000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from collections.abc import MutableMapping\n\n\nclass SortedDict(MutableMapping):\n    def __init__(self):\n        self.data = {}\n\n    def __getitem__(self, key):\n        return self.data[key]\n\n    def __setitem__(self, key, value):\n        self.data[key] = value\n\n    def __delitem__(self, key):\n        del self.data[key]\n\n    def __iter__(self):\n        keys = list(self.data.keys())\n        keys.sort()\n        for key in keys:\n            yield key\n\n    def __len__(self):\n        return len(self.data)\n\n\nvotes = {\n    \'otter\': 1281,\n    \'polar bear\': 587,\n    \'fox\': 863,\n}\n\n\ndef populate_ranks(votes, ranks):\n    names = list(votes.keys())\n    names.sort(key=votes.get, reverse=True)\n    for i, name in enumerate(names, 1):\n        ranks[name] = i\n\n\ndef get_winner(ranks):\n    return next(iter(ranks))\n\n\nsorted_ranks = SortedDict()\npopulate_ranks(votes, sorted_ranks)\nprint(sorted_ranks.data)\nwinner = get_winner(sorted_ranks)\nprint(winner)\n\n>>>\n{\'otter\': 1, \'fox\': 2, \'polar bear\': 3}\nfox`, `63612498044453060000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> collections<span class="token punctuation">.</span>abc <span class="token keyword">import</span> MutableMapping\n\n\n<span class="token keyword">class</span> <span class="token class-name">SortedDict</span><span class="token punctuation">(</span>MutableMapping<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>data<span class="token punctuation">[</span>key<span class="token punctuation">]</span>\n\n    <span class="token keyword">def</span> <span class="token function">__setitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>data<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value\n\n    <span class="token keyword">def</span> <span class="token function">__delitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">del</span> self<span class="token punctuation">.</span>data<span class="token punctuation">[</span>key<span class="token punctuation">]</span>\n\n    <span class="token keyword">def</span> <span class="token function">__iter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        keys <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n        keys<span class="token punctuation">.</span>sort<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">for</span> key <span class="token keyword">in</span> keys<span class="token punctuation">:</span>\n            <span class="token keyword">yield</span> key\n\n    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">)</span>\n\n\nvotes <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'otter\'</span><span class="token punctuation">:</span> <span class="token number">1281</span><span class="token punctuation">,</span>\n    <span class="token string">\'polar bear\'</span><span class="token punctuation">:</span> <span class="token number">587</span><span class="token punctuation">,</span>\n    <span class="token string">\'fox\'</span><span class="token punctuation">:</span> <span class="token number">863</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\n\n<span class="token keyword">def</span> <span class="token function">populate_ranks</span><span class="token punctuation">(</span>votes<span class="token punctuation">,</span> ranks<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    names <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>votes<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    names<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span>votes<span class="token punctuation">.</span>get<span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\n    <span class="token keyword">for</span> i<span class="token punctuation">,</span> name <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        ranks<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> i\n\n\n<span class="token keyword">def</span> <span class="token function">get_winner</span><span class="token punctuation">(</span>ranks<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> <span class="token builtin">next</span><span class="token punctuation">(</span><span class="token builtin">iter</span><span class="token punctuation">(</span>ranks<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n\nsorted_ranks <span class="token operator">=</span> SortedDict<span class="token punctuation">(</span><span class="token punctuation">)</span>\npopulate_ranks<span class="token punctuation">(</span>votes<span class="token punctuation">,</span> sorted_ranks<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>sorted_ranks<span class="token punctuation">.</span>data<span class="token punctuation">)</span>\nwinner <span class="token operator">=</span> get_winner<span class="token punctuation">(</span>sorted_ranks<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>winner<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">{</span><span class="token string">\'otter\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'fox\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">\'polar bear\'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">}</span>\nfox</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>没有得到预期的结果，为什么会这样呢？因为 <code class="language-text">get_winner</code> 函数总是假设，迭代字典时的顺序应该跟 <code class="language-text">populate_ranks</code> 函数当初向字典中插入数据时的顺序一样。但是这次，我们用的是 SortedDict 实例，而不是标准的 dict 实例，所以这项假设不成立。因此，函数返回的数据是按字母顺序排列时最先出现的那个数据，也就是 <code class="language-text">&#39;fox&#39;</code>，有以下 3 种解决方案：</p>\n<ol>\n<li>\n<p>重新实现 <code class="language-text">get_winner</code> 函数，使它不再假设 ranks 字典总是能按照固定的顺序来迭代。这是最保险、最稳妥的一种方案。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32762537582942163000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def get_winner(ranks):\n  for name, rank in ranks.items():\n     if rank == 1:\n           return name\n\nwinner = get_winner(sorted_ranks)\nprint(winner)\n\n>>>\notter`, `32762537582942163000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">get_winner</span><span class="token punctuation">(</span>ranks<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  <span class="token keyword">for</span> name<span class="token punctuation">,</span> rank <span class="token keyword">in</span> ranks<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n     <span class="token keyword">if</span> rank <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>\n           <span class="token keyword">return</span> name\n\nwinner <span class="token operator">=</span> get_winner<span class="token punctuation">(</span>sorted_ranks<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>winner<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\notter</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>在函数开头先判断 ranks 是不是预期的那种标准字典（dict）。如果不是，就抛出异常。这个办法的运行性能要比刚才那种好。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74709405631671400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def get_winner(ranks):\n  if not isinstance(ranks, dict):\n     raise TypeError(\'must provide a dict instance\')\n  return next(iter(ranks))\n\nget_winner(sorted_ranks)\n\n>>>\nTraceback ...\nTypeError: must provide a dict instance`, `74709405631671400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">get_winner</span><span class="token punctuation">(</span>ranks<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>ranks<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n     <span class="token keyword">raise</span> TypeError<span class="token punctuation">(</span><span class="token string">\'must provide a dict instance\'</span><span class="token punctuation">)</span>\n  <span class="token keyword">return</span> <span class="token builtin">next</span><span class="token punctuation">(</span><span class="token builtin">iter</span><span class="token punctuation">(</span>ranks<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\nget_winner<span class="token punctuation">(</span>sorted_ranks<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> must provide a <span class="token builtin">dict</span> instance</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>通过类型注解（type annotation）来保证传给 <code class="language-text">get_winner</code> 函数的确实是个真正的 dict 实例，而不是那种行为跟标准字典类似的 MutableMapping（参见第 90 条）。下面就采用严格（strict）模式，针对含有注解的代码运行 mypy 工具。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17222556496773556000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from typing import Dict, MutableMapping\n\ndef populate_ranks(votes: Dict[str, int],\n                 ranks: Dict[str, int]) -> None:\n  names = list(votes.keys())\n  names.sort(key=votes.get, reverse=True)\n  for i, name in enumerate(names, 1):\n     ranks[name] = i\n\ndef get_winner(ranks: Dict[str, int]) -> str:\n  return next(iter(ranks))\n\nclass SortedDict(MutableMapping[str, int]):\n  def __init__(self):\n     self.data = {}\n\n  def __getitem__(self, key):\n     return self.data[key]\n\n  def __setitem__(self, key, value):\n     self.data[key] = value\n\n  def __delitem__(self, key):\n     del self.data[key]\n\n  def __iter__(self):\n     keys = list(self.data.keys())\n     keys.sort()\n     for key in keys:\n           yield key\n\n  def __len__(self):\n     return len(self.data)\n\nvotes = {\n  \'otter\': 1281,\n  \'polar bear\': 587,\n  \'fox\': 863,\n}\n\nsorted_ranks = SortedDict()\npopulate_ranks(votes, sorted_ranks)\nprint(sorted_ranks.data)\nwinner = get_winner(sorted_ranks)\nprint(winner)\n\n\\$ python3 -m mypy --strict test.py\ntest.py:42: error: Argument 2 to &quot;populate_ranks&quot; has incompatible type &quot;SortedDict&quot;; expected &quot;Dict[str, int]&quot;\ntest.py:44: error: Argument 1 to &quot;get_winner&quot; has incompatible type &quot;SortedDict&quot;; expected &quot;Dict[str, int]&quot;`, `17222556496773556000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> typing <span class="token keyword">import</span> Dict<span class="token punctuation">,</span> MutableMapping\n\n<span class="token keyword">def</span> <span class="token function">populate_ranks</span><span class="token punctuation">(</span>votes<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n                 ranks<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n  names <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>votes<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n  names<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span>votes<span class="token punctuation">.</span>get<span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\n  <span class="token keyword">for</span> i<span class="token punctuation">,</span> name <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n     ranks<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> i\n\n<span class="token keyword">def</span> <span class="token function">get_winner</span><span class="token punctuation">(</span>ranks<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">str</span><span class="token punctuation">:</span>\n  <span class="token keyword">return</span> <span class="token builtin">next</span><span class="token punctuation">(</span><span class="token builtin">iter</span><span class="token punctuation">(</span>ranks<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token keyword">class</span> <span class="token class-name">SortedDict</span><span class="token punctuation">(</span>MutableMapping<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n  <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n     self<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n  <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">:</span>\n     <span class="token keyword">return</span> self<span class="token punctuation">.</span>data<span class="token punctuation">[</span>key<span class="token punctuation">]</span>\n\n  <span class="token keyword">def</span> <span class="token function">__setitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n     self<span class="token punctuation">.</span>data<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value\n\n  <span class="token keyword">def</span> <span class="token function">__delitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">:</span>\n     <span class="token keyword">del</span> self<span class="token punctuation">.</span>data<span class="token punctuation">[</span>key<span class="token punctuation">]</span>\n\n  <span class="token keyword">def</span> <span class="token function">__iter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n     keys <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n     keys<span class="token punctuation">.</span>sort<span class="token punctuation">(</span><span class="token punctuation">)</span>\n     <span class="token keyword">for</span> key <span class="token keyword">in</span> keys<span class="token punctuation">:</span>\n           <span class="token keyword">yield</span> key\n\n  <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n     <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">)</span>\n\nvotes <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token string">\'otter\'</span><span class="token punctuation">:</span> <span class="token number">1281</span><span class="token punctuation">,</span>\n  <span class="token string">\'polar bear\'</span><span class="token punctuation">:</span> <span class="token number">587</span><span class="token punctuation">,</span>\n  <span class="token string">\'fox\'</span><span class="token punctuation">:</span> <span class="token number">863</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\nsorted_ranks <span class="token operator">=</span> SortedDict<span class="token punctuation">(</span><span class="token punctuation">)</span>\npopulate_ranks<span class="token punctuation">(</span>votes<span class="token punctuation">,</span> sorted_ranks<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>sorted_ranks<span class="token punctuation">.</span>data<span class="token punctuation">)</span>\nwinner <span class="token operator">=</span> get_winner<span class="token punctuation">(</span>sorted_ranks<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>winner<span class="token punctuation">)</span>\n\n$ python3 <span class="token operator">-</span>m mypy <span class="token operator">-</span><span class="token operator">-</span>strict test<span class="token punctuation">.</span>py\ntest<span class="token punctuation">.</span>py<span class="token punctuation">:</span><span class="token number">42</span><span class="token punctuation">:</span> error<span class="token punctuation">:</span> Argument <span class="token number">2</span> to <span class="token string">"populate_ranks"</span> has incompatible <span class="token builtin">type</span> <span class="token string">"SortedDict"</span><span class="token punctuation">;</span> expected <span class="token string">"Dict[str, int]"</span>\ntest<span class="token punctuation">.</span>py<span class="token punctuation">:</span><span class="token number">44</span><span class="token punctuation">:</span> error<span class="token punctuation">:</span> Argument <span class="token number">1</span> to <span class="token string">"get_winner"</span> has incompatible <span class="token builtin">type</span> <span class="token string">"SortedDict"</span><span class="token punctuation">;</span> expected <span class="token string">"Dict[str, int]"</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样可以检查出类型不相符的问题，mypy 会标出错误的用法，指出函数要求的是 dict，但传入的却是 MutableMapping。这个方案既能保证静态类型准确，又不会影响程序的运行效率。</p>\n</li>\n</ol>\n<h3 id="总结-11"><a href="#%E6%80%BB%E7%BB%93-11" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>\n<p>从 Python 3.7 版开始，我们就可以确信迭代标准的字典时所看到的顺序跟这些键值对插入字典时的顺序一致。</p>\n</li>\n<li>\n<p>在 Python 代码中，我们很容易就能定义跟标准的字典很像但本身并不是 dict 实例的对象。对于这种类型的对象，不能假设迭代时看到的顺序必定与插入时的顺序相同。</p>\n</li>\n<li>\n<p>如果不想把这种跟标准字典很相似的类型也当成标准字典来处理，那么可以考虑这样三种办法。</p>\n<ol>\n<li>不要依赖插入时的顺序编写代码；</li>\n<li>在程序运行时明确判断它是不是标准的字典；</li>\n<li>给代码添加类型注解并做静态分析。</li>\n</ol>\n</li>\n</ol>\n<h2 id="第-16-条：用-get-处理键不在字典中的情况，不要使用-in-与-keyerror"><a href="#%E7%AC%AC-16-%E6%9D%A1%EF%BC%9A%E7%94%A8-get-%E5%A4%84%E7%90%86%E9%94%AE%E4%B8%8D%E5%9C%A8%E5%AD%97%E5%85%B8%E4%B8%AD%E7%9A%84%E6%83%85%E5%86%B5%EF%BC%8C%E4%B8%8D%E8%A6%81%E4%BD%BF%E7%94%A8-in-%E4%B8%8E-keyerror" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 16 条：用 get 处理键不在字典中的情况，不要使用 in 与 KeyError</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51400877231129670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`counters = {\n    \'pumpernickel\': 2,\n    \'sourdough\': 1,\n}\n\nkey = \'wheat\'\n\nif key not in counters:\n    counters[key] = 0\ncounters[key] += 1\n\nif key in counters:\n    counters[key] += 1\nelse:\n    counters[key] = 1\n\ntry:\n    counters[key] += 1\nexcept KeyError:\n    counters[key] = 1`, `51400877231129670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">counters <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'pumpernickel\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>\n    <span class="token string">\'sourdough\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\nkey <span class="token operator">=</span> <span class="token string">\'wheat\'</span>\n\n<span class="token keyword">if</span> key <span class="token keyword">not</span> <span class="token keyword">in</span> counters<span class="token punctuation">:</span>\n    counters<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>\ncounters<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>\n\n<span class="token keyword">if</span> key <span class="token keyword">in</span> counters<span class="token punctuation">:</span>\n    counters<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    counters<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>\n\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    counters<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>\n<span class="token keyword">except</span> KeyError<span class="token punctuation">:</span>\n    counters<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用 get 来优化</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47964917034838870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`counters = {\n    \'pumpernickel\': 2,\n    \'sourdough\': 1,\n}\n\nkey = \'wheat\'\n\ncount = counters.get(key, 0)\ncounters[key] = count + 1`, `47964917034838870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">counters <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'pumpernickel\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>\n    <span class="token string">\'sourdough\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\nkey <span class="token operator">=</span> <span class="token string">\'wheat\'</span>\n\ncount <span class="token operator">=</span> counters<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\ncounters<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> count <span class="token operator">+</span> <span class="token number">1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果使用 setdefault 改写是有问题的，这会有一次访问、两次赋值操作</p>\n<p>而且 setdefault 不管是否有这个键，都会执行默认值的分配，这会造成比较大的性能开销</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53853528874027020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`count = counters.setdefault(key, 0)\ncounters[key] = count + 1`, `53853528874027020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">count <span class="token operator">=</span> counters<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\ncounters<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> count <span class="token operator">+</span> <span class="token number">1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>缓解性能问题的话，可以用 get 方法加赋值表达式，也可以直接用 defaultdict</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62009052281796360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`names = votes.get(key)\nif names is None:\n    votes[key] = names = []\nnames.append(who)\n\n# 或者使用赋值表达式\nif (names := votes.get(key)) is None:\n    votes[key] = names = []\nnames.append(who)`, `62009052281796360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">names <span class="token operator">=</span> votes<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">)</span>\n<span class="token keyword">if</span> names <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n    votes<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\nnames<span class="token punctuation">.</span>append<span class="token punctuation">(</span>who<span class="token punctuation">)</span>\n\n<span class="token comment"># 或者使用赋值表达式</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>names <span class="token punctuation">:</span><span class="token operator">=</span> votes<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n    votes<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\nnames<span class="token punctuation">.</span>append<span class="token punctuation">(</span>who<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>只有与键相关联的默认值构造起来开销很低且可以变化，而且不用担心异常问题（例如 list 实例）。在这种情况下可以使用 setdefault，然而一般也优先考虑使用 defaultdict 取代 dict</p>\n<h3 id="总结-12"><a href="#%E6%80%BB%E7%BB%93-12" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>有四种办法可以处理键不在字典中的情况：in 表达式、KeyError 异常、get 方法与 setdefault 方法。</li>\n<li>如果跟键相关联的值是像计数器这样的基本类型，那么 get 方法就是最好的方案；如果是那种构造起来开销比较大，或是容易出异常的类型，那么可以把这个方法与赋值表达式结合起来使用。</li>\n<li>即使看上去最应该使用 setdefault 方案，也不一定要真的使用 setdefault 方案，而是可以考虑用 defaultdict 取代普通的 dict。</li>\n</ol>\n<h2 id="第-17-条：用-defaultdict-处理内部状态中缺失的元素，而不要用-setdefault"><a href="#%E7%AC%AC-17-%E6%9D%A1%EF%BC%9A%E7%94%A8-defaultdict-%E5%A4%84%E7%90%86%E5%86%85%E9%83%A8%E7%8A%B6%E6%80%81%E4%B8%AD%E7%BC%BA%E5%A4%B1%E7%9A%84%E5%85%83%E7%B4%A0%EF%BC%8C%E8%80%8C%E4%B8%8D%E8%A6%81%E7%94%A8-setdefault" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 17 条：用 defaultdict 处理内部状态中缺失的元素，而不要用 setdefault</h2>\n<p>通过 setdefault 方案把新的城市添加到对应的集合里，这要比利用 get 方法与赋值表达式（Python3.8 的新特性）来实现的方案短很多。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73250485883537660000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`visits = {\n    \'Mexico\': {\'Tulum\', \'Puerto Vallarta\'},\n    \'Japan\': {\'Hakone\'},\n}\n\nvisits.setdefault(\'France\', set()).add(\'Arles\')  # Short\nif (japan := visits.get(\'Japan\')) is None:  # Long\n    visits[\'Japan\'] = japan = set()\njapan.add(\'Kyoto\')\n\nprint(visits)\n\n>>>\n{\'Mexico\': {\'Tulum\', \'Puerto Vallarta\'}, \'Japan\': {\'Kyoto\', \'Hakone\'}, \'France\': {\'Arles\'}}`, `73250485883537660000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">visits <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'Mexico\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'Tulum\'</span><span class="token punctuation">,</span> <span class="token string">\'Puerto Vallarta\'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token string">\'Japan\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'Hakone\'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\nvisits<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span><span class="token string">\'France\'</span><span class="token punctuation">,</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token string">\'Arles\'</span><span class="token punctuation">)</span>  <span class="token comment"># Short</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>japan <span class="token punctuation">:</span><span class="token operator">=</span> visits<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'Japan\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>  <span class="token comment"># Long</span>\n    visits<span class="token punctuation">[</span><span class="token string">\'Japan\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> japan <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\njapan<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token string">\'Kyoto\'</span><span class="token punctuation">)</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span>visits<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">{</span><span class="token string">\'Mexico\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'Tulum\'</span><span class="token punctuation">,</span> <span class="token string">\'Puerto Vallarta\'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'Japan\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'Kyoto\'</span><span class="token punctuation">,</span> <span class="token string">\'Hakone\'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'France\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'Arles\'</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果程序所访问的这个字典需要由你自己明确地创建，那又该怎么写？</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63274961440607250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Visits:\n    def __init__(self):\n        self.data = {}\n\n    def add(self, country, city):\n        city_set = self.data.setdefault(country, set())\n        city_set.add(city)\n\n\nvisits = Visits()\nvisits.add(\'Russia\', \'Yekaterinburg\')\nvisits.add(\'Tanzania\', \'Zanzibar\')\nprint(visits.data)\n\n>>>\n{\'Russia\': {\'Yekaterinburg\'}, \'Tanzania\': {\'Zanzibar\'}}`, `63274961440607250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Visits</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n    <span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> country<span class="token punctuation">,</span> city<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        city_set <span class="token operator">=</span> self<span class="token punctuation">.</span>data<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span>country<span class="token punctuation">,</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n        city_set<span class="token punctuation">.</span>add<span class="token punctuation">(</span>city<span class="token punctuation">)</span>\n\n\nvisits <span class="token operator">=</span> Visits<span class="token punctuation">(</span><span class="token punctuation">)</span>\nvisits<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token string">\'Russia\'</span><span class="token punctuation">,</span> <span class="token string">\'Yekaterinburg\'</span><span class="token punctuation">)</span>\nvisits<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token string">\'Tanzania\'</span><span class="token punctuation">,</span> <span class="token string">\'Zanzibar\'</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>visits<span class="token punctuation">.</span>data<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">{</span><span class="token string">\'Russia\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'Yekaterinburg\'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'Tanzania\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'Zanzibar\'</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>以上代码有以下问题</p>\n<ol>\n<li>调用了名字很怪的 setdefault 方法，很难让人理解发生了什么</li>\n<li>每次调用 add 方法，都会构造新的 set 实例</li>\n</ol>\n<p>改用 defaultdict 可以解决以上问题，它会在键缺失的情况下，自动添加这个键以及键所对应的默认值，每次发现键不存在时，该字典都会调用这个函数返回一份新的默认值</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16494861680739748000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from collections import defaultdict\n\n\nclass Visits:\n    def __init__(self):\n        self.data = defaultdict(set)\n\n    def add(self, country, city):\n        self.data[country].add(city)\n\n\nvisits = Visits()\nvisits.add(\'England\', \'Bath\')\nvisits.add(\'England\', \'London\')\nprint(visits.data)\n\n>>>\ndefaultdict(<class \'set\'>, {\'England\': {\'Bath\', \'London\'}})`, `16494861680739748000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> collections <span class="token keyword">import</span> defaultdict\n\n\n<span class="token keyword">class</span> <span class="token class-name">Visits</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>data <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">set</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> country<span class="token punctuation">,</span> city<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>data<span class="token punctuation">[</span>country<span class="token punctuation">]</span><span class="token punctuation">.</span>add<span class="token punctuation">(</span>city<span class="token punctuation">)</span>\n\n\nvisits <span class="token operator">=</span> Visits<span class="token punctuation">(</span><span class="token punctuation">)</span>\nvisits<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token string">\'England\'</span><span class="token punctuation">,</span> <span class="token string">\'Bath\'</span><span class="token punctuation">)</span>\nvisits<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token string">\'England\'</span><span class="token punctuation">,</span> <span class="token string">\'London\'</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>visits<span class="token punctuation">.</span>data<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\ndefaultdict<span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'set\'</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">\'England\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'Bath\'</span><span class="token punctuation">,</span> <span class="token string">\'London\'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="总结-13"><a href="#%E6%80%BB%E7%BB%93-13" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>如果你管理的字典可能需要添加任意的键，那么应该考虑能否用内置的 collections 模块中的 defaultdict 实例来解决问题。</li>\n<li>如果这种键名比较随意的字典是别人传给你的，你无法把它创建成 defaultdict，那么应该考虑通过 get 方法访问其中的键值。然而，在个别情况下，也可以考虑改用 setdefault 方法，因为那样写更短。</li>\n</ol>\n<h2 id="第-18-条：学会利用-__missing__-构造依赖键的默认值"><a href="#%E7%AC%AC-18-%E6%9D%A1%EF%BC%9A%E5%AD%A6%E4%BC%9A%E5%88%A9%E7%94%A8-__missing__-%E6%9E%84%E9%80%A0%E4%BE%9D%E8%B5%96%E9%94%AE%E7%9A%84%E9%BB%98%E8%AE%A4%E5%80%BC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 18 条：学会利用 <code class="language-text">__missing__</code> 构造依赖键的默认值</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40426407708856240000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pictures = {}\npath = \'profile_1234.png\'\nif (handle := pictures.get(path)) is None:\n    try:\n        handle = open(path, \'a+b\')\n    except OSError:\n        print(f\'Failed to open path {path}\')\n        raise\n    else:\n        pictures[path] = handle\n\nhandle.seek(0)\nimage_data = handle.read()`, `40426407708856240000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">pictures <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\npath <span class="token operator">=</span> <span class="token string">\'profile_1234.png\'</span>\n<span class="token keyword">if</span> <span class="token punctuation">(</span>handle <span class="token punctuation">:</span><span class="token operator">=</span> pictures<span class="token punctuation">.</span>get<span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        handle <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">\'a+b\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">except</span> OSError<span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Failed to open path </span><span class="token interpolation"><span class="token punctuation">{</span>path<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n        <span class="token keyword">raise</span>\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        pictures<span class="token punctuation">[</span>path<span class="token punctuation">]</span> <span class="token operator">=</span> handle\n\nhandle<span class="token punctuation">.</span>seek<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>\nimage_data <span class="token operator">=</span> handle<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果改成 setdefault</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22746264741095710000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pictures = {}\npath = \'profile_1234.png\'\ntry:\n    handle = pictures.setdefault(path, open(path, \'a+b\'))\nexcept OSError:\n    print(f\'Failed to open path {path}\')\n    raise\nelse:\n    handle.seek(0)\n\nimage_data = handle.read()`, `22746264741095710000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">pictures <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\npath <span class="token operator">=</span> <span class="token string">\'profile_1234.png\'</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    handle <span class="token operator">=</span> pictures<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token builtin">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">\'a+b\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">except</span> OSError<span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Failed to open path </span><span class="token interpolation"><span class="token punctuation">{</span>path<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n    <span class="token keyword">raise</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    handle<span class="token punctuation">.</span>seek<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>\n\nimage_data <span class="token operator">=</span> handle<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然而使用 setdefault 实现会有以下问题</p>\n<ol>\n<li>即便图片的路径名已经在字典里了，程序也还是得调用内置的 open 函数创建文件句柄，于是导致这个程序要给已经创建过 handle 的那份文件再度创建 handle（两者可能相互冲突）</li>\n<li>如果 try 块抛出异常，那我们可能无法判断这个异常是 open 函数导致的，还是 setdefault 方法导致的，因为这两次调用全都写在了同一行代码里</li>\n</ol>\n<p>理论上可以使用 defaultdict 优化，但是 defaultdict 的第二个函数不能传参</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96606509838434090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from collections import defaultdict\n\n\ndef open_picture(profile_path):\n    try:\n        return open(profile_path, \'a+b\')\n    except OSError:\n        print(f\'Failed to open path {profile_path}\')\n        raise\n\n\npath = \'profile_1234.png\'\npictures = defaultdict(open_picture)\nhandle = pictures[path]\nhandle.seek(0)\nimage_data = handle.read()\n\n>>>\nTraceback ...\nTypeError: open_picture() missing 1 required positional argument: \'profile_path\'`, `96606509838434090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> collections <span class="token keyword">import</span> defaultdict\n\n\n<span class="token keyword">def</span> <span class="token function">open_picture</span><span class="token punctuation">(</span>profile_path<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token builtin">open</span><span class="token punctuation">(</span>profile_path<span class="token punctuation">,</span> <span class="token string">\'a+b\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">except</span> OSError<span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Failed to open path </span><span class="token interpolation"><span class="token punctuation">{</span>profile_path<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n        <span class="token keyword">raise</span>\n\n\npath <span class="token operator">=</span> <span class="token string">\'profile_1234.png\'</span>\npictures <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span>open_picture<span class="token punctuation">)</span>\nhandle <span class="token operator">=</span> pictures<span class="token punctuation">[</span>path<span class="token punctuation">]</span>\nhandle<span class="token punctuation">.</span>seek<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>\nimage_data <span class="token operator">=</span> handle<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> open_picture<span class="token punctuation">(</span><span class="token punctuation">)</span> missing <span class="token number">1</span> required positional argument<span class="token punctuation">:</span> <span class="token string">\'profile_path\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以通过继承 dict 类型并实现 <code class="language-text">__missing__</code> 特殊方法来解决这个问题</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25822359330867960000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def open_picture(profile_path):\n    try:\n        return open(profile_path, \'a+b\')\n    except OSError:\n        print(f\'Failed to open path {profile_path}\')\n        raise\n\n\nclass Pictures(dict):\n    def __missing__(self, key):\n        value = open_picture(key)\n        self[key] = value\n        return value\n\n\npath = \'profile_1234.png\'\npictures = Pictures()\nhandle = pictures[path]\nhandle.seek(0)\nimage_data = handle.read()`, `25822359330867960000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">open_picture</span><span class="token punctuation">(</span>profile_path<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token builtin">open</span><span class="token punctuation">(</span>profile_path<span class="token punctuation">,</span> <span class="token string">\'a+b\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">except</span> OSError<span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Failed to open path </span><span class="token interpolation"><span class="token punctuation">{</span>profile_path<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n        <span class="token keyword">raise</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Pictures</span><span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__missing__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        value <span class="token operator">=</span> open_picture<span class="token punctuation">(</span>key<span class="token punctuation">)</span>\n        self<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value\n        <span class="token keyword">return</span> value\n\n\npath <span class="token operator">=</span> <span class="token string">\'profile_1234.png\'</span>\npictures <span class="token operator">=</span> Pictures<span class="token punctuation">(</span><span class="token punctuation">)</span>\nhandle <span class="token operator">=</span> pictures<span class="token punctuation">[</span>path<span class="token punctuation">]</span>\nhandle<span class="token punctuation">.</span>seek<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>\nimage_data <span class="token operator">=</span> handle<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="总结-14"><a href="#%E6%80%BB%E7%BB%93-14" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>如果创建默认值需要较大的开销，或者可能抛出异常，那就不适合用 dict 类型的 setdefault 方法实现。</li>\n<li>传给 defaultdict 的函数必须是不需要参数的函数，所以无法创建出需要依赖键名的默认值。</li>\n<li>如果要构造的默认值必须根据键名来确定，那么可以定义自己的 dict 子类并实现 <code class="language-text">__missing__</code> 方法。</li>\n</ol>\n<h1 id="函数"><a href="#%E5%87%BD%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>函数</h1>\n<h2 id="第-19-条：不要把函数返回的多个数值拆分到三个以上的变量中"><a href="#%E7%AC%AC-19-%E6%9D%A1%EF%BC%9A%E4%B8%8D%E8%A6%81%E6%8A%8A%E5%87%BD%E6%95%B0%E8%BF%94%E5%9B%9E%E7%9A%84%E5%A4%9A%E4%B8%AA%E6%95%B0%E5%80%BC%E6%8B%86%E5%88%86%E5%88%B0%E4%B8%89%E4%B8%AA%E4%BB%A5%E4%B8%8A%E7%9A%84%E5%8F%98%E9%87%8F%E4%B8%AD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 19 条：不要把函数返回的多个数值拆分到三个以上的变量中</h2>\n<p>unpacking 机制允许 Python 函数返回一个以上的值（参见第 6 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52880540243141860000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def get_stats(numbers):\n    minimum = min(numbers)\n    maximum = max(numbers)\n    return minimum, maximum\n\n\nlengths = [63, 73, 72, 60, 67, 66, 71, 61, 72, 70]\nminimum, maximum = get_stats(lengths)  # Two return values\nprint(f\'Min: {minimum}, Max: {maximum}\')\n\n>>>\nMin: 60, Max: 73`, `52880540243141860000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">def <span class="token function">get_stats</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    minimum <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n    maximum <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> minimum<span class="token punctuation">,</span> maximum\n\n\nlengths <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">63</span><span class="token punctuation">,</span> <span class="token number">73</span><span class="token punctuation">,</span> <span class="token number">72</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">67</span><span class="token punctuation">,</span> <span class="token number">66</span><span class="token punctuation">,</span> <span class="token number">71</span><span class="token punctuation">,</span> <span class="token number">61</span><span class="token punctuation">,</span> <span class="token number">72</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">]</span>\nminimum<span class="token punctuation">,</span> maximum <span class="token operator">=</span> <span class="token function">get_stats</span><span class="token punctuation">(</span>lengths<span class="token punctuation">)</span>  # Two <span class="token keyword">return</span> values\n<span class="token function">print</span><span class="token punctuation">(</span>f<span class="token string">\'Min: {minimum}, Max: {maximum}\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>>></span>\nMin<span class="token punctuation">:</span> <span class="token number">60</span><span class="token punctuation">,</span> Max<span class="token punctuation">:</span> <span class="token number">73</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72518342102074690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`first, second = 1, 2\nassert first == 1\nassert second == 2\n\n\ndef my_function():\n    return 1, 2\n\n\nfirst, second = my_function()\nassert first == 1\nassert second == 2`, `72518342102074690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="js"\n              >\n                <span class="gatsby-code-button-language">js</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">first<span class="token punctuation">,</span> second <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span>\nassert first <span class="token operator">==</span> <span class="token number">1</span>\nassert second <span class="token operator">==</span> <span class="token number">2</span>\n\n\ndef <span class="token function">my_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span>\n\n\nfirst<span class="token punctuation">,</span> second <span class="token operator">=</span> <span class="token function">my_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\nassert first <span class="token operator">==</span> <span class="token number">1</span>\nassert second <span class="token operator">==</span> <span class="token number">2</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在返回多个值的时候，可以用带星号的表达式接收那些没有被普通变量捕获到的值（参见第 13 条）</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26940809887109296000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def get_avg_ratio(numbers):\n    average = sum(numbers) / len(numbers)\n    scaled = [x / average for x in numbers]\n    scaled.sort(reverse=True)\n    return scaled\n\n\nlengths = [63, 73, 72, 60, 67, 66, 71, 61, 72, 70]\nlongest, *middle, shortest = get_avg_ratio(lengths)\nprint(f\'Longest:  {longest:>4.0%}\')\nprint(f\'Shortest: {shortest:>4.0%}\')\n\n>>>\nLongest:  108%\nShortest:  89%`, `26940809887109296000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">get_avg_ratio</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    average <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n    scaled <span class="token operator">=</span> <span class="token punctuation">[</span>x <span class="token operator">/</span> average <span class="token keyword">for</span> x <span class="token keyword">in</span> numbers<span class="token punctuation">]</span>\n    scaled<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\n    <span class="token keyword">return</span> scaled\n\n\nlengths <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">63</span><span class="token punctuation">,</span> <span class="token number">73</span><span class="token punctuation">,</span> <span class="token number">72</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">67</span><span class="token punctuation">,</span> <span class="token number">66</span><span class="token punctuation">,</span> <span class="token number">71</span><span class="token punctuation">,</span> <span class="token number">61</span><span class="token punctuation">,</span> <span class="token number">72</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">]</span>\nlongest<span class="token punctuation">,</span> <span class="token operator">*</span>middle<span class="token punctuation">,</span> shortest <span class="token operator">=</span> get_avg_ratio<span class="token punctuation">(</span>lengths<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Longest:  </span><span class="token interpolation"><span class="token punctuation">{</span>longest<span class="token punctuation">:</span><span class="token format-spec">>4.0%</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Shortest: </span><span class="token interpolation"><span class="token punctuation">{</span>shortest<span class="token punctuation">:</span><span class="token format-spec">>4.0%</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nLongest<span class="token punctuation">:</span>  <span class="token number">108</span><span class="token operator">%</span>\nShortest<span class="token punctuation">:</span>  <span class="token number">89</span><span class="token operator">%</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20435819647413633000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def get_stats(numbers):\n    minimum = min(numbers)\n    maximum = max(numbers)\n    count = len(numbers)\n    average = sum(numbers)/count\n    sorted_numbers = sorted(numbers)\n    middle = count // 2\n    if count % 2 == 0:\n        lower = sorted_numbers[middle - 1]\n        upper = sorted_numbers[middle]\n        median = (lower + upper)/2\n    else:\n        median = sorted_numbers[middle]\n    return minimum, maximum, average, median, count\n\n\nlengths = [63, 73, 72, 60, 67, 66, 71, 61, 72, 70]\nminimum, maximum, average, median, count = get_stats(lengths)\nprint(f\'Min: {minimum}, Max: {maximum}\')\nprint(f\'Average: {average}, Median: {median}, Count: {count}\')\n\n>>>\nMin: 60, Max: 73\nAverage: 67.5, Median: 68.5, Count: 10`, `20435819647413633000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">get_stats</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    minimum <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n    maximum <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n    count <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n    average <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span><span class="token operator">/</span>count\n    sorted_numbers <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n    middle <span class="token operator">=</span> count <span class="token operator">//</span> <span class="token number">2</span>\n    <span class="token keyword">if</span> count <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>\n        lower <span class="token operator">=</span> sorted_numbers<span class="token punctuation">[</span>middle <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>\n        upper <span class="token operator">=</span> sorted_numbers<span class="token punctuation">[</span>middle<span class="token punctuation">]</span>\n        median <span class="token operator">=</span> <span class="token punctuation">(</span>lower <span class="token operator">+</span> upper<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span>\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        median <span class="token operator">=</span> sorted_numbers<span class="token punctuation">[</span>middle<span class="token punctuation">]</span>\n    <span class="token keyword">return</span> minimum<span class="token punctuation">,</span> maximum<span class="token punctuation">,</span> average<span class="token punctuation">,</span> median<span class="token punctuation">,</span> count\n\n\nlengths <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">63</span><span class="token punctuation">,</span> <span class="token number">73</span><span class="token punctuation">,</span> <span class="token number">72</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">67</span><span class="token punctuation">,</span> <span class="token number">66</span><span class="token punctuation">,</span> <span class="token number">71</span><span class="token punctuation">,</span> <span class="token number">61</span><span class="token punctuation">,</span> <span class="token number">72</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">]</span>\nminimum<span class="token punctuation">,</span> maximum<span class="token punctuation">,</span> average<span class="token punctuation">,</span> median<span class="token punctuation">,</span> count <span class="token operator">=</span> get_stats<span class="token punctuation">(</span>lengths<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Min: </span><span class="token interpolation"><span class="token punctuation">{</span>minimum<span class="token punctuation">}</span></span><span class="token string">, Max: </span><span class="token interpolation"><span class="token punctuation">{</span>maximum<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Average: </span><span class="token interpolation"><span class="token punctuation">{</span>average<span class="token punctuation">}</span></span><span class="token string">, Median: </span><span class="token interpolation"><span class="token punctuation">{</span>median<span class="token punctuation">}</span></span><span class="token string">, Count: </span><span class="token interpolation"><span class="token punctuation">{</span>count<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nMin<span class="token punctuation">:</span> <span class="token number">60</span><span class="token punctuation">,</span> Max<span class="token punctuation">:</span> <span class="token number">73</span>\nAverage<span class="token punctuation">:</span> <span class="token number">67.5</span><span class="token punctuation">,</span> Median<span class="token punctuation">:</span> <span class="token number">68.5</span><span class="token punctuation">,</span> Count<span class="token punctuation">:</span> <span class="token number">10</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面的写法有 2 个问题：</p>\n<ol>\n<li>函数返回的五个值都是数字，所以很容易就会搞错顺序</li>\n<li>调用函数并拆分返回值的那行代码会写得比较长</li>\n</ol>\n<p>为避免这些问题，我们不应该把函数返回的多个值拆分到三个以上的变量里。一个三元组最多只拆成三个普通变量，或两个普通变量与一个万能变量（带星号的变量）。当然用于接收的变量个数也可以比这更少。假如要拆分的值确实很多，那最好还是定义一个轻便的类或 namedtuple（参见第 37 条），并让函数返回这样的实例。</p>\n<h3 id="总结-15"><a href="#%E6%80%BB%E7%BB%93-15" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>函数可以把多个值合起来通过一个元组返回给调用者，以便利用 Python 的 unpacking 机制去拆分。</li>\n<li>对于函数返回的多个值，可以把普通变量没有捕获到的那些值全都捕获到一个带星号的变量里。</li>\n<li>把返回的值拆分到四个或四个以上的变量是很容易出错的，所以最好不要那么写，而是应该通过小类或 namedtuple 实例完成。</li>\n</ol>\n<h2 id="第-20-条：遇到意外状况时应该抛出异常，不要返回-none"><a href="#%E7%AC%AC-20-%E6%9D%A1%EF%BC%9A%E9%81%87%E5%88%B0%E6%84%8F%E5%A4%96%E7%8A%B6%E5%86%B5%E6%97%B6%E5%BA%94%E8%AF%A5%E6%8A%9B%E5%87%BA%E5%BC%82%E5%B8%B8%EF%BC%8C%E4%B8%8D%E8%A6%81%E8%BF%94%E5%9B%9E-none" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 20 条：遇到意外状况时应该抛出异常，不要返回 None</h2>\n<p>编写工具函数（utility function）时，许多 Python 程序员都爱用 None 这个返回值来表示特殊情况。对于某些函数来说，这或许有几分道理。</p>\n<p>例如，我们要编写一个辅助函数计算两数相除的结果。在除数是 0 的情况下，返回 None 似乎相当合理，因为这种除法的结果是没有意义的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17333679464467888000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def careful_divide(a, b):\n    try:\n        return a / b\n    except ZeroDivisionError:\n        return None`, `17333679464467888000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">careful_divide</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> a <span class="token operator">/</span> b\n    <span class="token keyword">except</span> ZeroDivisionError<span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token boolean">None</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>调用这个函数时，可以按自己的方式处理这样的返回值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60223413482676630000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def careful_divide(a, b):\n    try:\n        return a / b\n    except ZeroDivisionError:\n        return None\n\n\nx, y = 1, 0\nresult = careful_divide(x, y)\nif result is None:\n    print(\'Invalid inputs\')\n\n>>>\nInvalid inputs`, `60223413482676630000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">careful_divide</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> a <span class="token operator">/</span> b\n    <span class="token keyword">except</span> ZeroDivisionError<span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token boolean">None</span>\n\n\nx<span class="token punctuation">,</span> y <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span>\nresult <span class="token operator">=</span> careful_divide<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>\n<span class="token keyword">if</span> result <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Invalid inputs\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nInvalid inputs</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果传给 <code class="language-text">careful_divide</code> 函数的被除数为 0，会怎么样呢？在这种情况下，只要除数不为 0，函数返回的结果就应该是 0。</p>\n<p>问题是，这个函数的返回值有时可能会用在 if 条件语句里面，那时可能会根据值本身是否相当于 False 来做判断，而不像刚才那样明确判断这个值是否为 None（第 5 条也列举了类似的例子）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38868736660692370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def careful_divide(a, b):\n    try:\n        return a / b\n    except ZeroDivisionError:\n        return None\n\n\nx, y = 0, 5\nresult = careful_divide(x, y)\nif not result:\n    print(\'Invalid inputs\')  # This runs! But shouldn\'t\n\n>>>\nInvalid inputs`, `38868736660692370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">careful_divide</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> a <span class="token operator">/</span> b\n    <span class="token keyword">except</span> ZeroDivisionError<span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token boolean">None</span>\n\n\nx<span class="token punctuation">,</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span>\nresult <span class="token operator">=</span> careful_divide<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>\n<span class="token keyword">if</span> <span class="token keyword">not</span> result<span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Invalid inputs\'</span><span class="token punctuation">)</span>  <span class="token comment"># This runs! But shouldn\'t</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nInvalid inputs</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面这种 if 语句，会把函数返回 0 时的情况，也当成函数返回 None 时那样来处理。这种写法经常出现在 Python 代码里，因此像 <code class="language-text">careful_divide</code> 这样，用 None 来表示特殊状况的函数是很容易出错的。有两种办法可以减少这样的错误。</p>\n<ol>\n<li>\n<p>利用二元组把计算结果分成两部分返回（与这种写法有关的基础知识，参见第 19 条）。元组的首个元素表示操作是否成功，第二个元素表示计算的实际值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45639783758697440000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def careful_divide(a, b):\ntry:\n    return True, a / b\nexcept ZeroDivisionError:\n    return False, None`, `45639783758697440000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">careful_divide</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> <span class="token boolean">True</span><span class="token punctuation">,</span> a <span class="token operator">/</span> b\n<span class="token keyword">except</span> ZeroDivisionError<span class="token punctuation">:</span>\n    <span class="token keyword">return</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">None</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写，会促使调用函数者去拆分返回值，他可以先看看这次运算是否成功，然后再决定怎么处理运算结果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21406839544838750000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`success, result = careful_divide(x, y)\nif not success:\n  print(\'Invalid inputs\')`, `21406839544838750000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">success<span class="token punctuation">,</span> result <span class="token operator">=</span> careful_divide<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>\n<span class="token keyword">if</span> <span class="token keyword">not</span> success<span class="token punctuation">:</span>\n  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Invalid inputs\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>但问题是，有些调用方总喜欢忽略返回元组的第一个部分（在 Python 代码里，习惯用下划线表示用不到的变量）。这样写成的代码，乍一看似乎没问题，但实际上还是无法区分返回 0 与返回 None 这两种情况。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41936931165928890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`_, result = careful_divide(x, y)\nif not result:\n  print(\'Invalid inputs\')`, `41936931165928890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">_<span class="token punctuation">,</span> result <span class="token operator">=</span> careful_divide<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>\n<span class="token keyword">if</span> <span class="token keyword">not</span> result<span class="token punctuation">:</span>\n  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Invalid inputs\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>不采用 None 表示特例，而是向调用方抛出异常（Exception），让他自己去处理。下面我们把执行除法时发生的 ZeroDivisionError 转化成 ValueError，告诉调用方输入的值不对（什么时候应该使用 Exception 类的子类，可参见第 87 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82774011589967020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def careful_divide(a, b):\ntry:\n    return a / b\nexcept ZeroDivisionError:\n    raise ValueError(\'Invalid inputs\')`, `82774011589967020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">careful_divide</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> a <span class="token operator">/</span> b\n<span class="token keyword">except</span> ZeroDivisionError<span class="token punctuation">:</span>\n    <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Invalid inputs\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在，调用方拿到函数的返回值之后，不用先判断操作是否成功了。因为这次可以假设，只要能拿到返回值，就说明函数肯定顺利执行完了，所以只需要用 try 把函数包起来并在 else 块里处理运算结果就好（这种结构的详细用法，参见第 65 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80074147771321660000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def careful_divide(a, b):\ntry:\n    return a / b\nexcept ZeroDivisionError:\n    raise ValueError(\'Invalid inputs\')\n\nx, y = 5, 2\ntry:\n  result = careful_divide(x, y)\nexcept ValueError:\n  print(\'Invalid inputs\')\nelse:\n  print(\'Result is %.1f\' % result)\n\n>>>\nResult is 2.5`, `80074147771321660000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">careful_divide</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> a <span class="token operator">/</span> b\n<span class="token keyword">except</span> ZeroDivisionError<span class="token punctuation">:</span>\n    <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Invalid inputs\'</span><span class="token punctuation">)</span>\n\nx<span class="token punctuation">,</span> y <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">2</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n  result <span class="token operator">=</span> careful_divide<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>\n<span class="token keyword">except</span> ValueError<span class="token punctuation">:</span>\n  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Invalid inputs\'</span><span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Result is %.1f\'</span> <span class="token operator">%</span> result<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nResult <span class="token keyword">is</span> <span class="token number">2.5</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n</ol>\n<p>这个办法也可以扩展到那些使用类型注解的代码中（参见第 90 条），我们可以把函数的返回值指定为 float 类型，这样它就不可能返回 None 了。然而，Python 采用的是动态类型与静态类型相搭配的 gradual 类型系统，我们不能在函数的接口上指定函数可能抛出哪些异常（有的编程语言支持这样的受检异常（checked exception），调用方必须应对这些异常）。所以，我们只好把有可能抛出的异常写在文档里面，并希望调用方能够根据这份文档适当地捕获相关的异常（参见第 84 条）。</p>\n<p>下面我们给刚才那个函数加类型注解，并为它编写 docstring。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18366697124265640000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def careful_divide(a: float, b: float) -> float:\n    &quot;&quot;&quot;Divides a by b.\n\n    Raises:\n      ValueError: When the inputs cannot be divided.\n    &quot;&quot;&quot;\n    try:\n        return a / b\n    except ZeroDivisionError as e:\n        raise ValueError(\'Invalid inputs\')`, `18366697124265640000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">careful_divide</span><span class="token punctuation">(</span>a<span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">,</span> b<span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">float</span><span class="token punctuation">:</span>\n    <span class="token triple-quoted-string string">"""Divides a by b.\n\n    Raises:\n      ValueError: When the inputs cannot be divided.\n    """</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> a <span class="token operator">/</span> b\n    <span class="token keyword">except</span> ZeroDivisionError <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Invalid inputs\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写，输入、输出与异常都显得很清晰，所以调用方出错的概率就变得很小了。</p>\n<h3 id="总结-16"><a href="#%E6%80%BB%E7%BB%93-16" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>用返回值 None 表示特殊情况是很容易出错的，因为这样的值在条件表达式里面，没办法与 0 和空白字符串之类的值区分，这些值都相当于 False。</li>\n<li>用异常表示特殊的情况，而不要返回 None。让调用这个函数的程序根据文档里写的异常情况做出处理。</li>\n<li>通过类型注解可以明确禁止函数返回 None，即便在特殊情况下，它也不能返回这个值。</li>\n</ol>\n<h2 id="第-21-条：了解如何在闭包里面使用外围作用域中的变量"><a href="#%E7%AC%AC-21-%E6%9D%A1%EF%BC%9A%E4%BA%86%E8%A7%A3%E5%A6%82%E4%BD%95%E5%9C%A8%E9%97%AD%E5%8C%85%E9%87%8C%E9%9D%A2%E4%BD%BF%E7%94%A8%E5%A4%96%E5%9B%B4%E4%BD%9C%E7%94%A8%E5%9F%9F%E4%B8%AD%E7%9A%84%E5%8F%98%E9%87%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 21 条：了解如何在闭包里面使用外围作用域中的变量</h2>\n<p>有时，我们要给列表中的元素排序，而且要优先把某个群组之中的元素放在其他元素的前面。例如，渲染用户界面时，可能就需要这样做，因为关键的消息和特殊的事件应该优先显示在其他信息之前。</p>\n<p>实现这种做法的一种常见方案，是把辅助函数通过 key 参数传给列表的 sort 方法（参见第 14 条），让这个方法根据辅助函数所返回的值来决定元素在列表中的先后顺序。辅助函数先判断当前元素是否处在重要群组里，如果在，就把返回值的第一项写成 0，让它能够排在不属于这个组的那些元素之前。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28063283821747233000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def sort_priority(values, group):\n    def helper(x):\n        if x in group:\n            return (0, x)\n        return (1, x)\n    values.sort(key=helper)`, `28063283821747233000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">sort_priority</span><span class="token punctuation">(</span>values<span class="token punctuation">,</span> group<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">helper</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> x <span class="token keyword">in</span> group<span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>\n    values<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span>helper<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个函数可以处理比较简单的输入数据。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31579178151292387000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def sort_priority(values, group):\n    def helper(x):\n        if x in group:\n            return (0, x)\n        return (1, x)\n    values.sort(key=helper)\n\n\nnumbers = [8, 3, 1, 2, 5, 4, 7, 6]\ngroup = {2, 3, 5, 7}\nsort_priority(numbers, group)\nprint(numbers)\n\n>>>\n[2, 3, 5, 7, 1, 4, 6, 8]`, `31579178151292387000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">sort_priority</span><span class="token punctuation">(</span>values<span class="token punctuation">,</span> group<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">helper</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> x <span class="token keyword">in</span> group<span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>\n    values<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span>helper<span class="token punctuation">)</span>\n\n\nnumbers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span>\ngroup <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">}</span>\nsort_priority<span class="token punctuation">(</span>numbers<span class="token punctuation">,</span> group<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>它为什么能够实现这个功能呢？这要分三个原因来讲：</p>\n<ol>\n<li>Python 支持闭包（closure），这让定义在大函数里面的小函数也能引用大函数之中的变量。具体到这个例子，<code class="language-text">sort_priority</code> 函数里面的那个 helper 函数也能够引用前者的 group 参数。</li>\n<li>函数在 Python 里是头等对象（first-class object），所以你可以像操作其他对象那样，直接引用它们、把它们赋给变量、将它们当成参数传给其他函数，或是在 in 表达式与 if 语句里面对它做比较，等等。闭包函数也是函数，所以，同样可以传给 sort 方法的 key 参数。</li>\n<li>Python 在判断两个序列（包括元组）的大小时，有自己的一套规则。它首先比较 0 号位置的那两个元素，如果相等，那就比较 1 号位置的那两个元素；如果还相等，那就比较 2 号位置的那两个元素；依此类推，直到得出结论为止。所以，我们可以利用这套规则让 helper 这个闭包函数返回一个元组，并把关键指标写为元组的首个元素以表示当前排序的值是否属于重要群组（0 表示属于，1 表示不属于）。</li>\n</ol>\n<p>如果这个 <code class="language-text">sort_priority</code> 函数还能告诉我们，列表里面有没有位于重要群组之中的元素，那就更好了，因为这样可以让用户界面开发者更方便地做出相应处理。添加这样一个功能似乎相当简单，因为闭包函数本身就需要判断当前值是否处在重要群组之中，既然这样，那么不妨让它在发现这种值时，顺便把标志变量翻转过来。最后，让闭包外的大函数（即 <code class="language-text">sort_priority</code> 函数）返回这个标志变量，如果闭包函数当时遇到过这样的值，那么这个标志肯定是 True。</p>\n<p>下面，试着用最直接的写法来实现。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87393905617053380000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def sort_priority2(numbers, group):\n    found = False\n\n    def helper(x):\n        if x in group:\n            found = True  # Seems simple\n            return (0, x)\n        return (1, x)\n    numbers.sort(key=helper)\n    return found\n\n\nnumbers = [8, 3, 1, 2, 5, 4, 7, 6]\ngroup = {2, 3, 5, 7}\nfound = sort_priority2(numbers, group)\nprint(\'Found:\', found)\nprint(numbers)\n\n>>>\nFound: False\n[2, 3, 5, 7, 1, 4, 6, 8]`, `87393905617053380000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">sort_priority2</span><span class="token punctuation">(</span>numbers<span class="token punctuation">,</span> group<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    found <span class="token operator">=</span> <span class="token boolean">False</span>\n\n    <span class="token keyword">def</span> <span class="token function">helper</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> x <span class="token keyword">in</span> group<span class="token punctuation">:</span>\n            found <span class="token operator">=</span> <span class="token boolean">True</span>  <span class="token comment"># Seems simple</span>\n            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>\n    numbers<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span>helper<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> found\n\n\nnumbers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span>\ngroup <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">}</span>\nfound <span class="token operator">=</span> sort_priority2<span class="token punctuation">(</span>numbers<span class="token punctuation">,</span> group<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Found:\'</span><span class="token punctuation">,</span> found<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nFound<span class="token punctuation">:</span> <span class="token boolean">False</span>\n<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>排序结果没有问题，可以看到：在排过序的 numbers 里面，重要群组 group 里的那些元素（2、3、5、7），确实出现在了其他元素前面。既然这样，那表示函数返回值的 found 变量就应该是 True，但我们看到的却是 False，这是为什么？</p>\n<p>在表达式中引用某个变量时，Python 解释器会按照下面的顺序，在各个作用域（scope）里面查找这个变量，以解析（resolve）这次引用</p>\n<ol>\n<li>当前函数的作用域。</li>\n<li>外围作用域（例如包含当前函数的其他函数所对应的作用域）。</li>\n<li>包含当前代码的那个模块所对应的作用域（也叫全局作用域，global scope）。</li>\n<li>内置作用域（built-in scope，也就是包含 len 与 str 等函数的那个作用域）。</li>\n</ol>\n<p>如果这些作用域中都没有定义名称相符的变量，那么程序就抛出 NameError 异常。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4271322759567741400"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`foo = does_not_exist * 5\n\n>>>\nTraceback...\nNameError: name \'does_not_exist\' is not defined`, `4271322759567741400`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">foo <span class="token operator">=</span> does_not_exist <span class="token operator">*</span> <span class="token number">5</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nNameError<span class="token punctuation">:</span> name <span class="token string">\'does_not_exist\'</span> <span class="token keyword">is</span> <span class="token keyword">not</span> defined</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>刚才讲的是怎么引用变量，现在我们来讲怎么给变量赋值，这要分两种情况处理。</p>\n<ol>\n<li>如果变量已经定义在当前作用域中，那么直接把新值交给它就行了。</li>\n<li>如果当前作用域中不存在这个变量，那么即便外围作用域里有同名的变量，Python 也还是会把这次的赋值操作当成变量的定义来处理</li>\n</ol>\n<p>这会产生一个重要的效果，也就是说，Python 会把包含赋值操作的这个函数当成新定义的这个变量的作用域。</p>\n<p>这可以解释刚才那种写法错在何处。<code class="language-text">sort_priority2</code> 函数里面的 helper 闭包函数是把 True 赋给了 found 变量。当前作用域里没有这样一个叫作 found 的变量，所以就算外围的 <code class="language-text">sort_priority2</code> 函数里面有 found 变量，系统也还是会把这次赋值当成定义，也就是会在 helper 里面定义一个新的 found 变量，而不是把它当成给 <code class="language-text">sort_priority2</code> 已有的那个 found 变量赋值。</p>\n<p>这种问题有时也称作作用域 bug（scoping bug），Python 新手可能认为这样的赋值规则很奇怪，但实际上 Python 是故意这么设计的。因为这样可以防止函数中的局部变量污染外围模块。假如不这样做，那么函数里的每条赋值语句都有可能影响全局作用域的变量，这样不仅混乱，而且会让全局变量之间彼此交互影响，从而导致很多难以探查的 bug。</p>\n<p>Python 有一种特殊的写法，可以把闭包里面的数据赋给闭包外面的变量。用 nonlocal 语句描述变量，就可以让系统在处理针对这个变量的赋值操作时，去外围作用域查找。然而，nonlocal 有个限制，就是不能侵入模块级别的作用域（以防污染全局作用域）。</p>\n<p>下面，用 nonlocal 改写刚才那个函数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85988755992780370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def sort_priority2(numbers, group):\n    found = False\n\n    def helper(x):\n        nonlocal found\n        if x in group:\n            found = True  # Seems simple\n            return (0, x)\n        return (1, x)\n    numbers.sort(key=helper)\n    return found\n\n\nnumbers = [8, 3, 1, 2, 5, 4, 7, 6]\ngroup = {2, 3, 5, 7}\nfound = sort_priority2(numbers, group)\nprint(\'Found:\', found)\nprint(numbers)\n\n>>>\nFound: True\n[2, 3, 5, 7, 1, 4, 6, 8]`, `85988755992780370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{5}"\n              >\n                <span class="gatsby-code-button-language">py{5}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">sort_priority2</span><span class="token punctuation">(</span>numbers<span class="token punctuation">,</span> group<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    found <span class="token operator">=</span> <span class="token boolean">False</span>\n\n    <span class="token keyword">def</span> <span class="token function">helper</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="gatsby-highlight-code-line">        <span class="token keyword">nonlocal</span> found</span>        <span class="token keyword">if</span> x <span class="token keyword">in</span> group<span class="token punctuation">:</span>\n            found <span class="token operator">=</span> <span class="token boolean">True</span>  <span class="token comment"># Seems simple</span>\n            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>\n    numbers<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span>helper<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> found\n\n\nnumbers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span>\ngroup <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">}</span>\nfound <span class="token operator">=</span> sort_priority2<span class="token punctuation">(</span>numbers<span class="token punctuation">,</span> group<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Found:\'</span><span class="token punctuation">,</span> found<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nFound<span class="token punctuation">:</span> <span class="token boolean">True</span>\n<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>nonlocal 语句清楚地表明，我们要把数据赋给闭包之外的变量。有一种跟它互补的语句，叫作 global，用这种语句描述某个变量后，在给这个变量赋值时，系统会直接把它放到模块作用域（或者说全局作用域）中。</p>\n<p>我们都知道全局变量不应该滥用，其实 nonlocal 也这样。除比较简单的函数外，大家尽量不要用这个语句，因为它造成的副作用有时很难发现。尤其是在那种比较长的函数里，nonlocal 语句与其关联变量的赋值操作之间可能隔得很远。</p>\n<p>如果 nonlocal 的用法比较复杂，那最好是改用辅助类来封装状态。下面就定义了这样一个类，用来实现与刚才那种写法相同的效果。这样虽然稍微长一点，但看起来更清晰易读（<code class="language-text">__call__</code> 这个特殊方法，请参见第 38 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94195992984684280000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Sorter:\n    def __init__(self, group):\n        self.group = group\n        self.found = False\n\n    def __call__(self, x):\n        if x in self.group:\n            self.found = True\n            return (0, x)\n        return (1, x)\n\n\nnumbers = [8, 3, 1, 2, 5, 4, 7, 6]\ngroup = {2, 3, 5, 7}\nsorter = Sorter(group)\nnumbers.sort(key=sorter)\nassert sorter.found is True`, `94195992984684280000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Sorter</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> group<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>group <span class="token operator">=</span> group\n        self<span class="token punctuation">.</span>found <span class="token operator">=</span> <span class="token boolean">False</span>\n\n    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> x <span class="token keyword">in</span> self<span class="token punctuation">.</span>group<span class="token punctuation">:</span>\n            self<span class="token punctuation">.</span>found <span class="token operator">=</span> <span class="token boolean">True</span>\n            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>\n\n\nnumbers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span>\ngroup <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">}</span>\nsorter <span class="token operator">=</span> Sorter<span class="token punctuation">(</span>group<span class="token punctuation">)</span>\nnumbers<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span>sorter<span class="token punctuation">)</span>\n<span class="token keyword">assert</span> sorter<span class="token punctuation">.</span>found <span class="token keyword">is</span> <span class="token boolean">True</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="总结-17"><a href="#%E6%80%BB%E7%BB%93-17" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>闭包函数可以引用定义它们的那个外围作用域之中的变量。</li>\n<li>按照默认的写法，在闭包里面给变量赋值并不会改变外围作用域中的同名变量。</li>\n<li>先用 nonlocal 语句说明，然后赋值，可以修改外围作用域中的变量。</li>\n<li>除特别简单的函数外，尽量少用 nonlocal 语句。</li>\n</ol>\n<h2 id="第-22-条：用数量可变的位置参数给函数设计清晰的参数列表"><a href="#%E7%AC%AC-22-%E6%9D%A1%EF%BC%9A%E7%94%A8%E6%95%B0%E9%87%8F%E5%8F%AF%E5%8F%98%E7%9A%84%E4%BD%8D%E7%BD%AE%E5%8F%82%E6%95%B0%E7%BB%99%E5%87%BD%E6%95%B0%E8%AE%BE%E8%AE%A1%E6%B8%85%E6%99%B0%E7%9A%84%E5%8F%82%E6%95%B0%E5%88%97%E8%A1%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 22 条：用数量可变的位置参数给函数设计清晰的参数列表</h2>\n<p>让函数接受数量可变的位置参数（positional argument），可以把函数设计得更加清晰（这些位置参数通常简称 var args，或者叫作 star args，因为我们习惯用 <code class="language-text">*args</code> 指代）。例如，假设我们要记录调试信息。如果采用参数数量固定的方案来设计，那么函数应该接受一个表示信息的 message 参数和一个 values 列表（这个列表用于存放需要填充到信息里的那些值）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32342919667875213000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def log(message, values):\n    if not values:\n        print(message)\n    else:\n        values_str = \', \'.join(str(x) for x in values)\n        print(f\'{message}: {values_str}\')\n\n\nlog(\'My numbers are\', [1, 2])\nlog(\'Hi there\', [])\n\n>>>\nMy numbers are: 1, 2\nHi there`, `32342919667875213000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">log</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> <span class="token keyword">not</span> values<span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        values_str <span class="token operator">=</span> <span class="token string">\', \'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> values<span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>message<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>values_str<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n\nlog<span class="token punctuation">(</span><span class="token string">\'My numbers are\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\nlog<span class="token punctuation">(</span><span class="token string">\'Hi there\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nMy numbers are<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span>\nHi there</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>即便没有值需要填充到信息里面，也必须专门传一个空白的列表进去，这样显得多余，而且让代码看起来比较乱。最好是能允许调用者把第二个参数留空。在 Python 里，可以给最后一个位置参数加前缀 <code class="language-text">*</code>，这样调用者就只需要提供不带星号的那些参数，然后可以不再指其他参数，也可以继续指定任意数量的位置参数。函数的主体代码不用改，只修改调用代码即可。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55735700228435616000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def log(message, *values):  # The only difference\n    if not values:\n        print(message)\n    else:\n        values_str = \', \'.join(str(x) for x in values)\n        print(f\'{message}: {values_str}\')\n\n\nlog(\'My numbers are\', 1, 2)\nlog(\'Hi there\')  # Much better\n\n>>>\nMy numbers are: 1, 2\nHi there`, `55735700228435616000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">log</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token operator">*</span>values<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># The only difference</span>\n    <span class="token keyword">if</span> <span class="token keyword">not</span> values<span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        values_str <span class="token operator">=</span> <span class="token string">\', \'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> values<span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>message<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>values_str<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n\nlog<span class="token punctuation">(</span><span class="token string">\'My numbers are\'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>\nlog<span class="token punctuation">(</span><span class="token string">\'Hi there\'</span><span class="token punctuation">)</span>  <span class="token comment"># Much better</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nMy numbers are<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span>\nHi there</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种写法与拆解数据时用在赋值语句左边带星号的 unpacking 操作非常类似（参见第 13 条）。</p>\n<p>如果想把已有序列（例如某列表）里面的元素当成参数传给像 log 这样的参数个数可变的函数（variadic function），那么可以在传递序列的时采用 <code class="language-text">*</code> 操作符。这会让 Python 把序列中的元素都当成位置参数传给这个函数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8066550201857936000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`favorites = [7, 33, 99]\nlog(\'Favorite colors\', *favorites)\n\n>>>\nFavorite colors: 7, 33, 99`, `8066550201857936000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">favorites <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">]</span>\nlog<span class="token punctuation">(</span><span class="token string">\'Favorite colors\'</span><span class="token punctuation">,</span> <span class="token operator">*</span>favorites<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nFavorite colors<span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">,</span> <span class="token number">99</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>令函数接受数量可变的位置参数，可能导致两个问题。</p>\n<ol>\n<li>\n<p>程序总是必须先把这些参数转化成一个元组，然后才能把它们当成可选的位置参数传给函数。这意味着，如果调用函数时，把带 <code class="language-text">*</code> 操作符的生成器传了过去，那么程序必须先把这个生成器里的所有元素迭代完（以便形成元组），然后才能继续往下执行（相关知识，参见第 30 条）。这个元组包含生成器所给出的每个值，这可能耗费大量内存，甚至会让程序崩溃。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98249777112814350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def my_generator():\nfor i in range(10):\n    yield i\n\ndef my_func(*args):\n  print(args)\n\nit = my_generator()\nmy_func(*it)\n\n>>>\n(0, 1, 2, 3, 4, 5, 6, 7, 8, 9)`, `98249777112814350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">my_generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">yield</span> i\n\n<span class="token keyword">def</span> <span class="token function">my_func</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  <span class="token keyword">print</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>\n\nit <span class="token operator">=</span> my_generator<span class="token punctuation">(</span><span class="token punctuation">)</span>\nmy_func<span class="token punctuation">(</span><span class="token operator">*</span>it<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>接受 <code class="language-text">*args</code> 参数的函数，适合处理输入值不太多，而且数量可以提前预估的情况。在调用这种函数时，传给 <code class="language-text">*args</code> 这一部分的应该是许多个字面值或变量名才对。这种机制，主要是为了让代码写起来更方便、读起来更清晰。</p>\n</li>\n<li>\n<p>如果用了 <code class="language-text">*args</code> 之后，又要给函数添加新的位置参数，那么原有的调用操作就需要全都更新。例如给参数列表开头添加新的位置参数 sequence，那么没有据此更新的那些调用代码就会出错。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70014736531118514000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def log(sequence, message, *values):\nif not values:\n    print(f\'{sequence} - {message}\')\nelse:\n    values_str = \', \'.join(str(x) for x in values)\n    print(f\'{sequence} - {message}: {values_str}\')\n\nlog(1, \'Favorites\', 7, 33)  # New with *args OK\nlog(1, \'Hi there\')  # New message only OK\nlog(\'Favorite numbers\', 7, 33)  # old usage breaks\n\n>>>\n1 - Favorites: 7, 33\n1 - Hi there\nFavorite numbers - 7: 33`, `70014736531118514000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">log</span><span class="token punctuation">(</span>sequence<span class="token punctuation">,</span> message<span class="token punctuation">,</span> <span class="token operator">*</span>values<span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token keyword">if</span> <span class="token keyword">not</span> values<span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>sequence<span class="token punctuation">}</span></span><span class="token string"> - </span><span class="token interpolation"><span class="token punctuation">{</span>message<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    values_str <span class="token operator">=</span> <span class="token string">\', \'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> values<span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>sequence<span class="token punctuation">}</span></span><span class="token string"> - </span><span class="token interpolation"><span class="token punctuation">{</span>message<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>values_str<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\nlog<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'Favorites\'</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">)</span>  <span class="token comment"># New with *args OK</span>\nlog<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'Hi there\'</span><span class="token punctuation">)</span>  <span class="token comment"># New message only OK</span>\nlog<span class="token punctuation">(</span><span class="token string">\'Favorite numbers\'</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">)</span>  <span class="token comment"># old usage breaks</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">1</span> <span class="token operator">-</span> Favorites<span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">33</span>\n<span class="token number">1</span> <span class="token operator">-</span> Hi there\nFavorite numbers <span class="token operator">-</span> <span class="token number">7</span><span class="token punctuation">:</span> <span class="token number">33</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>问题在于：第三次调用 log 函数的那个地方并没有根据新的参数列表传入 sequence 参数，所以 Favorite numbers 就成了 sequence 参数，7 就成了 message 参数。这样的 bug 很难排查，因为程序不会抛出异常，只会采用错误的数据继续运行下去。为了彻底避免这种漏洞，在给这种 <code class="language-text">*arg</code> 函数添加参数时，应该使用只能通过关键字来指定的参数（keyword-only argument，参见第 25 条）。要是想做得更稳妥一些，可以考虑添加类型注解（参见第 90 条）。</p>\n</li>\n</ol>\n<h3 id="总结-18"><a href="#%E6%80%BB%E7%BB%93-18" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>用 def 定义函数时，可以通过 <code class="language-text">*args</code> 的写法让函数接受数量可变的位置参数。</li>\n<li>调用函数时，可以在序列左边加上 <code class="language-text">*</code> 操作符，把其中的元素当成位置参数传给 <code class="language-text">*args</code> 所表示的这一部分。</li>\n<li>如果 <code class="language-text">*</code> 操作符加在生成器前，那么传递参数时，程序有可能因为耗尽内存而崩溃。</li>\n<li>给接受 <code class="language-text">*args</code> 的函数添加新位置参数，可能导致难以排查的 bug。</li>\n</ol>\n<h2 id="第-23-条：用关键字参数来表示可选的行为"><a href="#%E7%AC%AC-23-%E6%9D%A1%EF%BC%9A%E7%94%A8%E5%85%B3%E9%94%AE%E5%AD%97%E5%8F%82%E6%95%B0%E6%9D%A5%E8%A1%A8%E7%A4%BA%E5%8F%AF%E9%80%89%E7%9A%84%E8%A1%8C%E4%B8%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 23 条：用关键字参数来表示可选的行为</h2>\n<p>与大多数其他编程语言一样，Python 允许在调用函数时，按照位置传递参数</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62818054592579830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def remainder(number, divisor):\n    return number % divisor\n\n\nassert remainder(20, 7) == 6`, `62818054592579830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">remainder</span><span class="token punctuation">(</span>number<span class="token punctuation">,</span> divisor<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> number <span class="token operator">%</span> divisor\n\n\n<span class="token keyword">assert</span> remainder<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">6</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Python 函数里面的所有普通参数，除了按位置传递外，还可以按关键字传递。调用函数时，在调用括号内可以把关键字的名称写在 = 左边，把参数值写在右边。这种写法不在乎参数的顺序，只要把必须指定的所有位置参数全都传过去即可。另外，关键字形式与位置形式也可以混用。下面这四种写法的效果相同：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45762127482164500000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`remainder(20, 7)\nremainder(20, divisor=7)\nremainder(number=20, divisor=7)\nremainder(divisor=7, number=20)`, `45762127482164500000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">remainder<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span>\nremainder<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> divisor<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">)</span>\nremainder<span class="token punctuation">(</span>number<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> divisor<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">)</span>\nremainder<span class="token punctuation">(</span>divisor<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">,</span> number<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果混用，那么位置参数必须出现在关键字参数之前，否则就会出错。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15298447694297045000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`remainder(number=20, 7)\n\n>>>\nTraceback ...\nSyntaxError: positional argument follows keyword argument`, `15298447694297045000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">remainder<span class="token punctuation">(</span>number<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nSyntaxError<span class="token punctuation">:</span> positional argument follows keyword argument</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>每个参数只能指定一次，不能既通过位置形式指定，又通过关键字形式指定。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23561294814287100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`remainder(20, number=7)\n\n>>>\nTraceback ...\nTypeError: remainder() got multiple values for argument number`, `23561294814287100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">remainder<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> number<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> remainder<span class="token punctuation">(</span><span class="token punctuation">)</span> got multiple values <span class="token keyword">for</span> argument number</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果有一份字典，而且字典里面的内容能够用来调用 remainder 这样的函数，那么可以把 <code class="language-text">**</code> 运算符加在字典前面，这会让 Python 把字典里面的键值以关键字参数的形式传给函数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65109335415911690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`my_kwargs = {\n    \'number\': 20,\n    \'divisor\': 7,\n}\nassert remainder(**my_kwargs) == 6`, `65109335415911690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">my_kwargs <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'number\'</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span>\n    <span class="token string">\'divisor\'</span><span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">assert</span> remainder<span class="token punctuation">(</span><span class="token operator">**</span>my_kwargs<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">6</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>调用函数时，带 <code class="language-text">**</code> 操作符的参数可以和位置参数或关键字参数混用，只要不重复指定就行。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80554576251141460000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`my_kwargs = {\n    \'divisor\': 7,\n}\nassert remainder(number=20, **my_kwargs) == 6`, `80554576251141460000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">my_kwargs <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'divisor\'</span><span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">assert</span> remainder<span class="token punctuation">(</span>number<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token operator">**</span>my_kwargs<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">6</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>也可以对多个字典分别施加 <code class="language-text">**</code> 操作，只要这些字典所提供的参数不重叠就好。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45885584684367560000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`my_kwargs = {\n    \'number\': 20,\n}\nother_kwargs = {\n    \'divisor\': 7,\n}\nassert remainder(**my_kwargs, **other_kwargs) == 6`, `45885584684367560000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">my_kwargs <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'number\'</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\nother_kwargs <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'divisor\'</span><span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n<span class="token keyword">assert</span> remainder<span class="token punctuation">(</span><span class="token operator">**</span>my_kwargs<span class="token punctuation">,</span> <span class="token operator">**</span>other_kwargs<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">6</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>定义函数时，如果想让这个函数接受任意数量的关键字参数，那么可以在参数列表里写上万能形参 <code class="language-text">**kwargs</code>，它会把调用者传进来的参数收集合到一个字典里面稍后处理（第 26 条讲了一种特别适合这么做的情况）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26374929285616976000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def print_parameters(**kwargs):\n    for key, value in kwargs.items():\n        print(f\'{key} = {value}\')\n\n\nprint_parameters(alpha=1.5, beta=9, gamma=4)\n\n>>>\nalpha = 1.5\nbeta = 9\ngamma = 4`, `26374929285616976000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">print_parameters</span><span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> kwargs<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>key<span class="token punctuation">}</span></span><span class="token string"> = </span><span class="token interpolation"><span class="token punctuation">{</span>value<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n\nprint_parameters<span class="token punctuation">(</span>alpha<span class="token operator">=</span><span class="token number">1.5</span><span class="token punctuation">,</span> beta<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">,</span> gamma<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nalpha <span class="token operator">=</span> <span class="token number">1.5</span>\nbeta <span class="token operator">=</span> <span class="token number">9</span>\ngamma <span class="token operator">=</span> <span class="token number">4</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>关键字参数的灵活用法可以带来三个好处。</p>\n<ol>\n<li>\n<p>用关键字参数调用函数可以让初次阅读代码的人更容易看懂。例如，读到 remainder(20, 7) 这样的调用代码，就不太容易看出谁是被除数 number，谁是除数 divisor，只有去查看 remainder 的具体实现方法才能明白。但如果改用关键字形式来调用，例如 remainder(number=20, divisor=7)，那么每个参数的含义就相当明了。</p>\n</li>\n<li>\n<p>它可以带有默认值，该值是在定义函数时指定的。在大多数情况下，调用者只需要沿用这个值就好，但有时也可以明确指定自己想要传的值。这样能够减少重复代码，让程序看上去干净一些。</p>\n<p>例如，我们要计算液体流入容器的速率。如果这个容器带刻度，那么可以取前后两个时间点的刻度差（<code class="language-text">weight_diff</code>），并把它跟这两个时间点的时间差（<code class="language-text">time_diff</code>）相除，就可以算出流速了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41967975235522130000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def flow_rate(weight_diff, time_diff):\n   return weight_diff / time_diff\n\nweight_diff = 0.5\ntime_diff = 3\nflow = flow_rate(weight_diff, time_diff)\nprint(f\'{flow:.3} kg per second\')`, `41967975235522130000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">flow_rate</span><span class="token punctuation">(</span>weight_diff<span class="token punctuation">,</span> time_diff<span class="token punctuation">)</span><span class="token punctuation">:</span>\n   <span class="token keyword">return</span> weight_diff <span class="token operator">/</span> time_diff\n\nweight_diff <span class="token operator">=</span> <span class="token number">0.5</span>\ntime_diff <span class="token operator">=</span> <span class="token number">3</span>\nflow <span class="token operator">=</span> flow_rate<span class="token punctuation">(</span>weight_diff<span class="token punctuation">,</span> time_diff<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>flow<span class="token punctuation">:</span><span class="token format-spec">.3</span><span class="token punctuation">}</span></span><span class="token string"> kg per second\'</span></span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>一般来说，我们会用每秒的千克数表示流速。但有的时候，我们还想估算更长的时间段（例如几小时或几天）内的流速结果。只需给同一个函数加一个 period 参数来表示那个时间段相当于多少秒即可。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40506490977254736000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def flow_rate(weight_diff, time_diff, period):\n   return (weight_diff / time_diff) * period`, `40506490977254736000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">flow_rate</span><span class="token punctuation">(</span>weight_diff<span class="token punctuation">,</span> time_diff<span class="token punctuation">,</span> period<span class="token punctuation">)</span><span class="token punctuation">:</span>\n   <span class="token keyword">return</span> <span class="token punctuation">(</span>weight_diff <span class="token operator">/</span> time_diff<span class="token punctuation">)</span> <span class="token operator">*</span> period</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>这样写有个问题，就是每次调用函数时，都得明确指定 period 参数。即便我们想计算每秒钟的流速，也还是得明确指定 period 为 1。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75350239598599140000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`flow_per_second = flow_rate(weight_diff, time_diff, 1)`, `75350239598599140000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">flow_per_second <span class="token operator">=</span> flow_rate<span class="token punctuation">(</span>weight_diff<span class="token punctuation">,</span> time_diff<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>为了简化这种用法，我们可以给 period 参数设定默认值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66632725944795660000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def flow_rate(weight_diff, time_diff, period=1):\n   return (weight_diff / time_diff) * period\n\nflow_per_second = flow_rate(weight_diff, time_diff)\nflow_per_hour = flow_rate(weight_diff, time_diff, 3600)`, `66632725944795660000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">flow_rate</span><span class="token punctuation">(</span>weight_diff<span class="token punctuation">,</span> time_diff<span class="token punctuation">,</span> period<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n   <span class="token keyword">return</span> <span class="token punctuation">(</span>weight_diff <span class="token operator">/</span> time_diff<span class="token punctuation">)</span> <span class="token operator">*</span> period\n\nflow_per_second <span class="token operator">=</span> flow_rate<span class="token punctuation">(</span>weight_diff<span class="token punctuation">,</span> time_diff<span class="token punctuation">)</span>\nflow_per_hour <span class="token operator">=</span> flow_rate<span class="token punctuation">(</span>weight_diff<span class="token punctuation">,</span> time_diff<span class="token punctuation">,</span> <span class="token number">3600</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个办法适用于默认值比较简单的情况。如果默认值本身要根据比较复杂的逻辑来确定（可参考第 24 条），那就得仔细考虑一下了。</p>\n</li>\n<li>\n<p>我们可以很灵活地扩充函数的参数，而不用担心会影响原有的函数调用代码。这样的话，我们就可以通过这些新参数在函数里面实现许多新的功能，同时又无须修改早前写好的调用代码，这也让程序不容易因此出现 bug。</p>\n<p>例如，我们想继续扩充上述 <code class="language-text">flow_rate</code> 函数的功能，让它可以用千克之外的其他重量单位来计算流速。那只需要再添加一个可选参数，用来表示 1 千克相当于多少个那样的单位即可。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60564649878610940000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def flow_rate(weight_diff, time_diff, period=1, units_per_kg=1):\n  return ((weight_diff * units_per_kg) / time_diff) * period`, `60564649878610940000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">flow_rate</span><span class="token punctuation">(</span>weight_diff<span class="token punctuation">,</span> time_diff<span class="token punctuation">,</span> period<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> units_per_kg<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>weight_diff <span class="token operator">*</span> units_per_kg<span class="token punctuation">)</span> <span class="token operator">/</span> time_diff<span class="token punctuation">)</span> <span class="token operator">*</span> period</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>新参数 <code class="language-text">units_per_kg</code> 的默认值为 1，这表示默认情况下，依然以千克为重量单位来计算。于是，以前写好的那些调用代码就不用修改了。以后调用 <code class="language-text">flow_rate</code> 时，可以通过关键字形式给这个参数指定值，以表示他们想用的那种单位（例如磅，1 千克约等于 2.2 磅）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92832600556256620000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pounds_per_hour = flow_rate(weight_diff, time_diff,\n                        period=3600, units_per_kg=2.2)`, `92832600556256620000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">pounds_per_hour <span class="token operator">=</span> flow_rate<span class="token punctuation">(</span>weight_diff<span class="token punctuation">,</span> time_diff<span class="token punctuation">,</span>\n                        period<span class="token operator">=</span><span class="token number">3600</span><span class="token punctuation">,</span> units_per_kg<span class="token operator">=</span><span class="token number">2.2</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>可选的关键字参数有助于维护向后兼容（backward compatibility）。这是个相当重要的问题，对于接受带 <code class="language-text">*args</code> 参数的函数，也要注意向后兼容（参见第 22 条）。</p>\n<p>像 period 和 <code class="language-text">units_per_kg</code> 这样可选的关键字参数，只有一个缺点，就是调用者仍然能够按照位置来指定。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55501783796623230000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pounds_per_hour = flow_rate(weight_diff, time_diff, 3600, 2.2)`, `55501783796623230000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">pounds_per_hour <span class="token operator">=</span> flow_rate<span class="token punctuation">(</span>weight_diff<span class="token punctuation">,</span> time_diff<span class="token punctuation">,</span> <span class="token number">3600</span><span class="token punctuation">,</span> <span class="token number">2.2</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>通过位置来指定可选参数，可能会让读代码的人有点儿糊涂，因为他不太清楚 3600 和 2.2 这两个值分别指哪个量的缩放系数。所以，最好是能以关键字的形式给这些参数传值，而不要按位置去传。从设计函数的角度来说，还可以考虑用更加明确的方案以降低出错概率（参见第 25 条）。</p>\n</li>\n</ol>\n<h3 id="总结-19"><a href="#%E6%80%BB%E7%BB%93-19" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>函数的参数可以按位置指定，也可以用关键字的形式指定。</li>\n<li>关键字可以让每个参数的作用更加明了，因为在调用函数时只按位置指定参数，可能导致这些参数的含义不够明确。</li>\n<li>应该通过带默认值的关键字参数来扩展函数的行为，因为这不会影响原有的函数调用代码。</li>\n<li>可选的关键字参数总是应该通过参数名来传递，而不应按位置传递。</li>\n</ol>\n<h2 id="第-24-条：用-none-和-docstring-来描述默认值会变的参数"><a href="#%E7%AC%AC-24-%E6%9D%A1%EF%BC%9A%E7%94%A8-none-%E5%92%8C-docstring-%E6%9D%A5%E6%8F%8F%E8%BF%B0%E9%BB%98%E8%AE%A4%E5%80%BC%E4%BC%9A%E5%8F%98%E7%9A%84%E5%8F%82%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 24 条：用 None 和 docstring 来描述默认值会变的参数</h2>\n<p>有时，我们想把那种不能够提前固定的值，当作关键字参数的默认值。例如，记录日志消息时，默认的时间应该是触发事件的那一刻。所以，如果调用者没有明确指定时间，那么就默认把调用函数的那一刻当成这条日志的记录时间。现在试试下面这种写法，假定它能让 when 参数的默认值随着这个函数每次的执行时间而发生变化。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32676688354878070000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from time import sleep\nfrom datetime import datetime\n\n\ndef log(message, when=datetime.now()):\n    print(f\'{when}: {message}\')\n\n\nlog(\'Hi there!\')\nsleep(0.1)\nlog(\'Hello again!\')\n\n>>>\n2022-09-16 11:39:58.577119: Hi there!\n2022-09-16 11:39:58.577119: Hello again!`, `32676688354878070000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> time <span class="token keyword">import</span> sleep\n<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime\n\n\n<span class="token keyword">def</span> <span class="token function">log</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> when<span class="token operator">=</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>when<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>message<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n\nlog<span class="token punctuation">(</span><span class="token string">\'Hi there!\'</span><span class="token punctuation">)</span>\nsleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>\nlog<span class="token punctuation">(</span><span class="token string">\'Hello again!\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">2022</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">16</span> <span class="token number">11</span><span class="token punctuation">:</span><span class="token number">39</span><span class="token punctuation">:</span><span class="token number">58.577119</span><span class="token punctuation">:</span> Hi there!\n<span class="token number">2022</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">16</span> <span class="token number">11</span><span class="token punctuation">:</span><span class="token number">39</span><span class="token punctuation">:</span><span class="token number">58.577119</span><span class="token punctuation">:</span> Hello again!</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写不行。因为 datetime.now 只执行了一次，所以每条日志的时间戳（timestamp）相同。参数的默认值只会在系统加载这个模块的时候，计算一遍，而不会在每次执行时都重新计算，这通常意味着这些默认值在程序启动后，就已经定下来了。只要包含这段代码的那个模块已经加载进来，那么 when 参数的默认值就是加载时计算的那个 datetime.now()，系统不会重新计算。</p>\n<p>要想在 Python 里实现这种效果，惯用的办法是把参数的默认值设为 None，同时在 docstring 文档里面写清楚，这个参数为 None 时，函数会怎么运作（参见第 84 条）。给函数写实现代码时，要判断该参数是不是 None，如果是，就把它改成相应的默认值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41889010275951845000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from time import sleep\nfrom datetime import datetime\n\n\ndef log(message, when=None):\n    &quot;&quot;&quot;Log a message with a timestamp.\n\n    Args:\n        message: Message to print.\n        when: datetime of when the message occurred.\n            Defaults to the present time.\n    &quot;&quot;&quot;\n    if when is None:\n        when = datetime.now()\n    print(f\'{when}: {message}\')\n\n\nlog(\'Hi there!\')\nsleep(0.1)\nlog(\'Hello again!\')\n\n>>>\n2022-09-16 11:52:02.810552: Hi there!\n2022-09-16 11:52:02.910765: Hello again!`, `41889010275951845000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> time <span class="token keyword">import</span> sleep\n<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime\n\n\n<span class="token keyword">def</span> <span class="token function">log</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> when<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token triple-quoted-string string">"""Log a message with a timestamp.\n\n    Args:\n        message: Message to print.\n        when: datetime of when the message occurred.\n            Defaults to the present time.\n    """</span>\n    <span class="token keyword">if</span> when <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n        when <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>when<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>message<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n\nlog<span class="token punctuation">(</span><span class="token string">\'Hi there!\'</span><span class="token punctuation">)</span>\nsleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>\nlog<span class="token punctuation">(</span><span class="token string">\'Hello again!\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">2022</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">16</span> <span class="token number">11</span><span class="token punctuation">:</span><span class="token number">52</span><span class="token punctuation">:</span><span class="token number">02.810552</span><span class="token punctuation">:</span> Hi there!\n<span class="token number">2022</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">16</span> <span class="token number">11</span><span class="token punctuation">:</span><span class="token number">52</span><span class="token punctuation">:</span><span class="token number">02.910765</span><span class="token punctuation">:</span> Hello again!</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>把参数的默认值写成 None 还有个重要的意义，就是用来表示那种以后可能由调用者修改内容的默认值（例如某个可变的容器）。例如，我们要写一个函数对采用 JSON 格式编码的数据做解码。如果无法解码，那么就返回调用时所指定的默认结果，假如调用者当时没有明确指定，那就返回空白的字典。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="855224309216517900"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import json\n\n\ndef decode(data, default={}):\n    try:\n        return json.loads(data)\n    except ValueError:\n        return default`, `855224309216517900`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> json\n\n\n<span class="token keyword">def</span> <span class="token function">decode</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">)</span>\n    <span class="token keyword">except</span> ValueError<span class="token punctuation">:</span>\n        <span class="token keyword">return</span> default</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样的写法与前面 datetime.now 的例子有着同样的问题。系统只会计算一次 default 参数（在加载这个模块的时候），所以每次调用这个函数时，给调用者返回的都是一开始分配的那个字典，这就相当于凡是以默认值调用这个函数的代码都共用同一份字典。这会使程序出现很奇怪的效果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27257291057839740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import json\n\n\ndef decode(data, default={}):\n    try:\n        return json.loads(data)\n    except ValueError:\n        return default\n\n\nfoo = decode(\'bad data\')\nfoo[\'stuff\'] = 5\nbar = decode(\'also bad\')\nbar[\'meep\'] = 1\nprint(\'Foo:\', foo)\nprint(\'Bar:\', bar)\n\n>>>\nFoo: {\'stuff\': 5, \'meep\': 1}\nBar: {\'stuff\': 5, \'meep\': 1}`, `27257291057839740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> json\n\n\n<span class="token keyword">def</span> <span class="token function">decode</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">)</span>\n    <span class="token keyword">except</span> ValueError<span class="token punctuation">:</span>\n        <span class="token keyword">return</span> default\n\n\nfoo <span class="token operator">=</span> decode<span class="token punctuation">(</span><span class="token string">\'bad data\'</span><span class="token punctuation">)</span>\nfoo<span class="token punctuation">[</span><span class="token string">\'stuff\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">5</span>\nbar <span class="token operator">=</span> decode<span class="token punctuation">(</span><span class="token string">\'also bad\'</span><span class="token punctuation">)</span>\nbar<span class="token punctuation">[</span><span class="token string">\'meep\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Foo:\'</span><span class="token punctuation">,</span> foo<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Bar:\'</span><span class="token punctuation">,</span> bar<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nFoo<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'stuff\'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">\'meep\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span>\nBar<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'stuff\'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">\'meep\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们本意是想让这两次调用操作得到两个不同的空白字典，每个字典都可以分别用来存放不同的键值。但实际上，只要修改其中一个字典，另一个字典的内容就会受到影响。这种错误的根源在于，foo 和 bar 实际上是同一个字典，都等于系统一开始给 default 参数确定默认值时所分配的那个字典。它们表示的是同一个字典对象。</p>\n<p>要解决这个问题，可以把默认值设成 None，并且在 docstring 文档里面说明，函数在这个值为 None 时会怎么做。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26635825513435595000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import json\n\n\ndef decode(data, default=None):\n    &quot;&quot;&quot;Load JSON data from a string.\n\n    Args:\n        data: JSON data to decode.\n        default: Value to return if decoding fails.\n            Defaults to an empty dictionary.\n    &quot;&quot;&quot;\n    try:\n        return json.loads(data)\n    except ValueError:\n        if default is None:\n            default = {}\n        return default\n\n\nfoo = decode(\'bad data\')\nfoo[\'stuff\'] = 5\nbar = decode(\'also bad\')\nbar[\'meep\'] = 1\nprint(\'Foo:\', foo)\nprint(\'Bar:\', bar)\nassert foo is not bar\n\n>>>\nFoo: {\'stuff\': 5}\nBar: {\'meep\': 1}`, `26635825513435595000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> json\n\n\n<span class="token keyword">def</span> <span class="token function">decode</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token triple-quoted-string string">"""Load JSON data from a string.\n\n    Args:\n        data: JSON data to decode.\n        default: Value to return if decoding fails.\n            Defaults to an empty dictionary.\n    """</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">)</span>\n    <span class="token keyword">except</span> ValueError<span class="token punctuation">:</span>\n        <span class="token keyword">if</span> default <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n            default <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n        <span class="token keyword">return</span> default\n\n\nfoo <span class="token operator">=</span> decode<span class="token punctuation">(</span><span class="token string">\'bad data\'</span><span class="token punctuation">)</span>\nfoo<span class="token punctuation">[</span><span class="token string">\'stuff\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">5</span>\nbar <span class="token operator">=</span> decode<span class="token punctuation">(</span><span class="token string">\'also bad\'</span><span class="token punctuation">)</span>\nbar<span class="token punctuation">[</span><span class="token string">\'meep\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Foo:\'</span><span class="token punctuation">,</span> foo<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Bar:\'</span><span class="token punctuation">,</span> bar<span class="token punctuation">)</span>\n<span class="token keyword">assert</span> foo <span class="token keyword">is</span> <span class="token keyword">not</span> bar\n\n<span class="token operator">>></span><span class="token operator">></span>\nFoo<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'stuff\'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">}</span>\nBar<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'meep\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个思路可以跟类型注解搭配起来（参见第 90 条）。下面这种写法把 when 参数标注成可选（Optional）值，并限定其类型为 datetime。于是，它的取值就只有两种可能，要么是 None，要么是 datetime 对象。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64847200233689375000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from typing import Optional\n\n\ndef log_typed(message: str, when: Optional[datetime] = None) -> None:\n    &quot;&quot;&quot;Log a message with a timestamp.\n\n        Args:\n            message: Message to print.\n            when: datetime of when the message occurred.\n                Defaults to the present time.\n    &quot;&quot;&quot;\n    if when is None:\n        when = datetime.now()\n    print(f\'{when}: {message}\')`, `64847200233689375000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> typing <span class="token keyword">import</span> Optional\n\n\n<span class="token keyword">def</span> <span class="token function">log_typed</span><span class="token punctuation">(</span>message<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> when<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>datetime<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n    <span class="token triple-quoted-string string">"""Log a message with a timestamp.\n\n        Args:\n            message: Message to print.\n            when: datetime of when the message occurred.\n                Defaults to the present time.\n    """</span>\n    <span class="token keyword">if</span> when <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n        when <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>when<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>message<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="总结-20"><a href="#%E6%80%BB%E7%BB%93-20" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>参数的默认值只会计算一次，也就是在系统把定义函数的那个模块加载进来的时候。所以，如果默认值将来可能由调用方修改（例如 {}、[]）或者要随着调用时的情况变化（例如 datetime.now()），那么程序就会出现奇怪的效果。</li>\n<li>如果关键字参数的默认值属于这种会发生变化的值，那就应该写成 None，并且要在 docstring 里面描述函数此时的默认行为。</li>\n<li>默认值为 None 的关键字参数，也可以添加类型注解。</li>\n</ol>\n<h2 id="第-25-条：用只能以关键字指定和只能按位置传入的参数来设计清晰的参数列表"><a href="#%E7%AC%AC-25-%E6%9D%A1%EF%BC%9A%E7%94%A8%E5%8F%AA%E8%83%BD%E4%BB%A5%E5%85%B3%E9%94%AE%E5%AD%97%E6%8C%87%E5%AE%9A%E5%92%8C%E5%8F%AA%E8%83%BD%E6%8C%89%E4%BD%8D%E7%BD%AE%E4%BC%A0%E5%85%A5%E7%9A%84%E5%8F%82%E6%95%B0%E6%9D%A5%E8%AE%BE%E8%AE%A1%E6%B8%85%E6%99%B0%E7%9A%84%E5%8F%82%E6%95%B0%E5%88%97%E8%A1%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 25 条：用只能以关键字指定和只能按位置传入的参数来设计清晰的参数列表</h2>\n<p>按关键字传递参数是 Python 函数的一项强大特性（参见第 23 条）。这种关键字参数特别灵活，在很多情况下，都能让我们写出一看就懂的函数代码。例如，计算两数相除的结果时，可能需要仔细考虑各种特殊情况。</p>\n<p>例如，在除数为 0 的情况下，是抛出 ZeroDivisionError 异常，还是返回无穷（infinity）；在结果溢出的情况下，是抛出 OverflowError 异常，还是返回 0。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62990769851130830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def safe_division(number, divisor,\n                  ignore_overflow,\n                  ignore_zero_division):\n    try:\n        return number / divisor\n    except OverflowError:\n        if ignore_overflow:\n            return 0\n        else:\n            raise\n    except ZeroDivisionError:\n        if ignore_zero_division:\n            return float(\'inf\')\n        else:\n            raise`, `62990769851130830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">safe_division</span><span class="token punctuation">(</span>number<span class="token punctuation">,</span> divisor<span class="token punctuation">,</span>\n                  ignore_overflow<span class="token punctuation">,</span>\n                  ignore_zero_division<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> number <span class="token operator">/</span> divisor\n    <span class="token keyword">except</span> OverflowError<span class="token punctuation">:</span>\n        <span class="token keyword">if</span> ignore_overflow<span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token number">0</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span>\n    <span class="token keyword">except</span> ZeroDivisionError<span class="token punctuation">:</span>\n        <span class="token keyword">if</span> ignore_zero_division<span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">\'inf\'</span><span class="token punctuation">)</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个函数用起来很直观。如果想在结果溢出的情况下，让它返回 0，那么可以像下面这样调用函数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85747544353492880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`result = safe_division(1.0, 10**500, True, False)\nprint(result)\n\n>>>\n0`, `85747544353492880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">result <span class="token operator">=</span> safe_division<span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token operator">**</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果想在除数是 0 的情况下，让函数返回无穷，那么就按下面这样来写。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70358817012949705000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`result = safe_division(1.0, 0, False, True)\nprint(result)\n\n>>>\ninf`, `70358817012949705000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">result <span class="token operator">=</span> safe_division<span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\ninf</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>表示要不要忽略异常的那两个参数都是 Boolean 值，所以容易弄错位置，这会让程序出现难以查找的 bug。要想让代码看起来更清晰，一种办法是给这两个参数都指定默认值。按照默认值，该函数只要遇到特殊情况，就会抛出异常。</p>\n<p>调用者可以用关键字参数指定覆盖其中某个参数的默认值，以调整函数在遇到那种特殊情况时的处理方式，同时让另一个参数依然取那个参数自己的默认值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13714741071856484000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def safe_division_b(number, divisor,\n                    ignore_overflow=False,\n                    ignore_zero_division=False):\n    try:\n        return number / divisor\n    except OverflowError:\n        if ignore_overflow:\n            return 0\n        else:\n            raise\n    except ZeroDivisionError:\n        if ignore_zero_division:\n            return float(\'inf\')\n        else:\n            raise\n\n\nresult = safe_division_b(1.0, 10**500, ignore_overflow=True)\nprint(result)\nresult = safe_division_b(1.0, 0, ignore_zero_division=True)\nprint(result)\n\n>>>\n0\ninf`, `13714741071856484000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{2-3}"\n              >\n                <span class="gatsby-code-button-language">py{2-3}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">safe_division_b</span><span class="token punctuation">(</span>number<span class="token punctuation">,</span> divisor<span class="token punctuation">,</span>\n<span class="gatsby-highlight-code-line">                    ignore_overflow<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">                    ignore_zero_division<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> number <span class="token operator">/</span> divisor\n    <span class="token keyword">except</span> OverflowError<span class="token punctuation">:</span>\n        <span class="token keyword">if</span> ignore_overflow<span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token number">0</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span>\n    <span class="token keyword">except</span> ZeroDivisionError<span class="token punctuation">:</span>\n        <span class="token keyword">if</span> ignore_zero_division<span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">\'inf\'</span><span class="token punctuation">)</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span>\n\n\nresult <span class="token operator">=</span> safe_division_b<span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token operator">**</span><span class="token number">500</span><span class="token punctuation">,</span> ignore_overflow<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>\nresult <span class="token operator">=</span> safe_division_b<span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ignore_zero_division<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">0</span>\ninf</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然而，由于这些关键参数是可选的，我们没办法要求调用者必须按照关键字形式来指定这两个参数。他们还是可以用传统的写法，按位置给这个新定义的 <code class="language-text">safe_division_b</code> 函数传递参数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28936462515650540000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`assert safe_division_b(1.0, 10**500, True, False) == 0`, `28936462515650540000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">assert</span> safe_division_b<span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token operator">**</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>对于这种参数比较复杂的函数，我们可以声明只能通过关键字指定的参数（keyword-only argument），这样的话，写出来的代码就能清楚地反映调用者的想法了。这种参数只能用关键字来指定，不能按位置传递。</p>\n<p>下面就重新定义 <code class="language-text">safe_division</code> 函数，让它接受这样的参数。参数列表里的 <code class="language-text">*</code> 符号把参数分成两组，左边是位置参数，右边是只能用关键字指定的参数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97276375427768220000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def safe_division_c(number, divisor, *,\n                    ignore_overflow=False,\n                    ignore_zero_division=False):\n    try:\n        return number / divisor\n    except OverflowError:\n        if ignore_overflow:\n            return 0\n        else:\n            raise\n    except ZeroDivisionError:\n        if ignore_zero_division:\n            return float(\'inf\')\n        else:\n            raise\n\n\nassert safe_division_c(1.0, 10**500, True, False) == 0\n\n>>>\nTraceback ...\nTypeError: safe_division_c() takes 2 positional arguments but 4 were given`, `97276375427768220000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{1}"\n              >\n                <span class="gatsby-code-button-language">py{1}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="gatsby-highlight-code-line"><span class="token keyword">def</span> <span class="token function">safe_division_c</span><span class="token punctuation">(</span>number<span class="token punctuation">,</span> divisor<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span></span>                    ignore_overflow<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>\n                    ignore_zero_division<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> number <span class="token operator">/</span> divisor\n    <span class="token keyword">except</span> OverflowError<span class="token punctuation">:</span>\n        <span class="token keyword">if</span> ignore_overflow<span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token number">0</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span>\n    <span class="token keyword">except</span> ZeroDivisionError<span class="token punctuation">:</span>\n        <span class="token keyword">if</span> ignore_zero_division<span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">\'inf\'</span><span class="token punctuation">)</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span>\n\n\n<span class="token keyword">assert</span> safe_division_c<span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token operator">**</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> safe_division_c<span class="token punctuation">(</span><span class="token punctuation">)</span> takes <span class="token number">2</span> positional arguments but <span class="token number">4</span> were given</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当然我们还是可以像前面那样，用关键字参数指定覆盖其中一个参数的默认值（即忽略其中一种特殊情况，并让函数在遇到另一种特殊情况时抛出异常）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38586036139044725000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`result = safe_division_c(1.0, 0, ignore_zero_division=True)\nassert result == float(\'inf\')\ntry:\n    result = safe_division_c(1.0, 0)\nexcept ZeroDivisionError:\n    pass  # Expected`, `38586036139044725000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">result <span class="token operator">=</span> safe_division_c<span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ignore_zero_division<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>\n<span class="token keyword">assert</span> result <span class="token operator">==</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">\'inf\'</span><span class="token punctuation">)</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    result <span class="token operator">=</span> safe_division_c<span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\n<span class="token keyword">except</span> ZeroDivisionError<span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>  <span class="token comment"># Expected</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样改依然有问题，因为在 <code class="language-text">safe_division_c</code> 版本的函数里面，有两个参数（也就是 number 和 divisor）必须由调用者提供。然而，调用者在提供这两个参数时，既可以按位置提供，也可以按关键字提供，还可以把这两种方式混起来用。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51913906931187870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`assert safe_division_c(number=2, divisor=5) == 0.4\nassert safe_division_c(divisor=5, number=2) == 0.4\nassert safe_division_c(2, divisor=5) == 0.4`, `51913906931187870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">assert</span> safe_division_c<span class="token punctuation">(</span>number<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> divisor<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0.4</span>\n<span class="token keyword">assert</span> safe_division_c<span class="token punctuation">(</span>divisor<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> number<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0.4</span>\n<span class="token keyword">assert</span> safe_division_c<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> divisor<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0.4</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>在未来也许因为扩展函数的需要，甚至是因为代码风格的变化，或许要修改这两个参数的名字。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11037838823472579000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def safe_division_c(numerator, denominator, *,\n                    ignore_overflow=False,\n                    ignore_zero_division=False):`, `11037838823472579000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{1}"\n              >\n                <span class="gatsby-code-button-language">py{1}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="gatsby-highlight-code-line"><span class="token keyword">def</span> <span class="token function">safe_division_c</span><span class="token punctuation">(</span>numerator<span class="token punctuation">,</span> denominator<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span></span>                    ignore_overflow<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>\n                    ignore_zero_division<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>这看起来只是文字上面的微调，但之前所有通过关键字形式来指定这两个参数的调用代码，都会出错。</p>\n<p>其实最重要的问题在于，我们根本就没打算把 number 和 divisor 这两个名称纳入函数的接口；我们只是在编写函数的实现代码时，随意挑了这两个比较顺口的名称而已。也并不期望调用者也非得采用这种称呼来指定这两个参数。</p>\n<p>Python 3.8 引入了一项新特性，可以解决这个问题，这就是只能按位置传递的参数（positional-only argument）。这种参数与刚才的只能通过关键字指定的参数（keyword-only argument）相反，它们必须按位置指定，绝不能通过关键字形式指定。下面来重新定义 <code class="language-text">safe_division</code> 函数，使其前两个必须由调用者提供的参数只能按位置来提供。参数列表中的 <code class="language-text">/</code> 符号，表示它左边的那些参数只能按位置指定。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20257296806412040000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def safe_division_d(numerator, denominator, /, *,\n                    ignore_overflow=False,\n                    ignore_zero_division=False):\n    try:\n        return numerator / denominator\n    except OverflowError:\n        if ignore_overflow:\n            return 0\n        else:\n            raise\n    except ZeroDivisionError:\n        if ignore_zero_division:\n            return float(\'inf\')\n        else:\n            raise\n\n\nassert safe_division_d(2, 5) == 0.4 # 正常运行\nassert safe_division_d(numerator=2, denominator=5) == 0.4 # 报错`, `20257296806412040000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{1}"\n              >\n                <span class="gatsby-code-button-language">py{1}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="gatsby-highlight-code-line"><span class="token keyword">def</span> <span class="token function">safe_division_d</span><span class="token punctuation">(</span>numerator<span class="token punctuation">,</span> denominator<span class="token punctuation">,</span> <span class="token operator">/</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span></span>                    ignore_overflow<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>\n                    ignore_zero_division<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> numerator <span class="token operator">/</span> denominator\n    <span class="token keyword">except</span> OverflowError<span class="token punctuation">:</span>\n        <span class="token keyword">if</span> ignore_overflow<span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token number">0</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span>\n    <span class="token keyword">except</span> ZeroDivisionError<span class="token punctuation">:</span>\n        <span class="token keyword">if</span> ignore_zero_division<span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">\'inf\'</span><span class="token punctuation">)</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span>\n\n\n<span class="token keyword">assert</span> safe_division_d<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0.4</span> <span class="token comment"># 正常运行</span>\n<span class="token keyword">assert</span> safe_division_d<span class="token punctuation">(</span>numerator<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> denominator<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0.4</span> <span class="token comment"># 报错</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在我们可以确信：给 <code class="language-text">safe_division_d</code> 函数的前两个参数（也就是那两个必备的参数）所挑选的名称，已经与调用者的代码解耦了。即便以后再次修改这两个参数的名称，也不会影响已经写好的调用代码。</p>\n<p>在函数的参数列表之中，<code class="language-text">/</code> 符号左侧的参数是只能按位置指定的参数，<code class="language-text">*</code> 符号右侧的参数则是只能按关键字形式指定的参数。那么，这两个符号如果同时出现在参数列表中，会有什么效果呢？这是个值得注意的问题。这意味着，这两个符号之间的参数，既可以按位置提供，又可以用关键字形式指定（其实，如果不特别说明 Python 函数的参数全都属于这种参数）。在设计 API 时，为了体现某编程风格或者实现某些需求，可能会允许某些参数既可以按位置传递，也可以用关键字形式指定，这样可以让代码简单易读。例如，给下面这个 <code class="language-text">safe_division</code> 函数的参数列表添加一个可选的 ndigits 参数，允许调用者指定这次除法应该精确到小数点后第几位。</p>\n<p>下面我们用三种方式来调用这个 <code class="language-text">safe_division_e</code> 函数。ndigits 是个带默认值的普通参数，因此，它既可以按位置传递，也可以用关键字来指定，还可以直接省略。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26082563045884100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def safe_division_e(numerator, denominator, /,\n                    ndigits=10, *,\n                    ignore_overflow=False,\n                    ignore_zero_division=False):\n    try:\n        fraction = numerator / denominator\n        return round(fraction, ndigits)\n    except OverflowError:\n        if ignore_overflow:\n            return 0\n        else:\n            raise\n    except ZeroDivisionError:\n        if ignore_zero_division:\n            return float(\'inf\')\n        else:\n            raise\n\n\nresult = safe_division_e(22, 7)\nprint(result)\nresult = safe_division_e(22, 7, 5)\nprint(result)\nresult = safe_division_e(22, 7, ndigits=2)\nprint(result)\n\n>>>\n3.1428571429\n3.14286\n3.14`, `26082563045884100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">safe_division_e</span><span class="token punctuation">(</span>numerator<span class="token punctuation">,</span> denominator<span class="token punctuation">,</span> <span class="token operator">/</span><span class="token punctuation">,</span>\n                    ndigits<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span>\n                    ignore_overflow<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>\n                    ignore_zero_division<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        fraction <span class="token operator">=</span> numerator <span class="token operator">/</span> denominator\n        <span class="token keyword">return</span> <span class="token builtin">round</span><span class="token punctuation">(</span>fraction<span class="token punctuation">,</span> ndigits<span class="token punctuation">)</span>\n    <span class="token keyword">except</span> OverflowError<span class="token punctuation">:</span>\n        <span class="token keyword">if</span> ignore_overflow<span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token number">0</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span>\n    <span class="token keyword">except</span> ZeroDivisionError<span class="token punctuation">:</span>\n        <span class="token keyword">if</span> ignore_zero_division<span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">\'inf\'</span><span class="token punctuation">)</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span>\n\n\nresult <span class="token operator">=</span> safe_division_e<span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>\nresult <span class="token operator">=</span> safe_division_e<span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>\nresult <span class="token operator">=</span> safe_division_e<span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> ndigits<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">3.1428571429</span>\n<span class="token number">3.14286</span>\n<span class="token number">3.14</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="总结-21"><a href="#%E6%80%BB%E7%BB%93-21" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>Keyword-only argument 是一种只能通过关键字指定而不能通过位置指定的参数。这迫使调用者必须指明，这个值是传给哪一个参数的。在函数的参数列表中，这种参数位于 <code class="language-text">*</code> 符号的右侧。</li>\n<li>Positional-only argument 是这样一种参数，它不允许调用者通过关键字来指定，而是要求必须按位置传递。这可以降低调用代码与参数名称之间的耦合程度。在函数的参数列表中，这些参数位于 <code class="language-text">/</code> 符号的左侧。</li>\n<li>在参数列表中，位于 <code class="language-text">/</code> 与 <code class="language-text">*</code> 之间的参数，可以按位置指定，也可以用关键字来指定。这也是 Python 普通参数的默认指定方式。</li>\n</ol>\n<h2 id="第-26-条：用-functoolswraps-定义函数修饰器"><a href="#%E7%AC%AC-26-%E6%9D%A1%EF%BC%9A%E7%94%A8-functoolswraps-%E5%AE%9A%E4%B9%89%E5%87%BD%E6%95%B0%E4%BF%AE%E9%A5%B0%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 26 条：用 functools.wraps 定义函数修饰器</h2>\n<p>Python 中有一种特殊的写法，可以用修饰器（decorator）来封装某个函数，从而让程序在执行这个函数之前与执行完这个函数之后，分别运行某些代码。这意味着，调用者传给函数的参数值、函数返回给调用者的值，以及函数抛出的异常，都可以由修饰器访问并修改。这是个很有用的机制，能够确保用户以正确的方式使用函数，也能够用来调试程序或实现函数注册功能，此外还有许多用途。</p>\n<p>例如，假设我们要把函数执行时收到的参数与返回的值记录下来。这在调试递归函数时是很有用的，因为我们需要知道，这个函数执行每一层递归时，输入的是什么参数，返回的是什么值。下面我们就定义这样一个修饰器，在实现这个修饰器时，用 <code class="language-text">*args</code> 与 <code class="language-text">**kwargs</code> 表示受修饰的原函数 func 所收到的参数（参见第 22 条与第 23 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43839229635214090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def trace(func):\n    def wrapper(*args, **kwargs):\n        result = func(*args, **kwargs)\n        print(f\'{func.__name__}({args!r}，{kwargs!r})\'\n              f\'-> {result!r}\')\n        return result\n    return wrapper\n\n\n@trace # 相当于 fibonacci = trace(fibonacci)\ndef fibonacci(n):\n    &quot;&quot;&quot;Return the n-th Fibonacci number&quot;&quot;&quot;\n    if n in (0, 1):\n        return n\n    return fibonacci(n - 2) + fibonacci(n - 1)\n\nfibonacci(4)\n\n>>>\nfibonacci((0,)，{})-> 0\nfibonacci((1,)，{})-> 1\nfibonacci((2,)，{})-> 1\nfibonacci((1,)，{})-> 1\nfibonacci((0,)，{})-> 0\nfibonacci((1,)，{})-> 1\nfibonacci((2,)，{})-> 1\nfibonacci((3,)，{})-> 2\nfibonacci((4,)，{})-> 3`, `43839229635214090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">trace</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        result <span class="token operator">=</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>func<span class="token punctuation">.</span>__name__<span class="token punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token punctuation">{</span>args<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">，</span><span class="token interpolation"><span class="token punctuation">{</span>kwargs<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">)\'</span></span>\n              <span class="token string-interpolation"><span class="token string">f\'-> </span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> result\n    <span class="token keyword">return</span> wrapper\n\n\n@trace <span class="token comment"># 相当于 fibonacci = trace(fibonacci)</span>\n<span class="token keyword">def</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token triple-quoted-string string">"""Return the n-th Fibonacci number"""</span>\n    <span class="token keyword">if</span> n <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> n\n    <span class="token keyword">return</span> fibonacci<span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> fibonacci<span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>\n\nfibonacci<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nfibonacci<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">)</span>，<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span> <span class="token number">0</span>\nfibonacci<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">)</span>，<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span> <span class="token number">1</span>\nfibonacci<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token punctuation">)</span>，<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span> <span class="token number">1</span>\nfibonacci<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">)</span>，<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span> <span class="token number">1</span>\nfibonacci<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">)</span>，<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span> <span class="token number">0</span>\nfibonacci<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">)</span>，<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span> <span class="token number">1</span>\nfibonacci<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token punctuation">)</span>，<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span> <span class="token number">1</span>\nfibonacci<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token punctuation">)</span>，<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span> <span class="token number">2</span>\nfibonacci<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token punctuation">)</span>，<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span> <span class="token number">3</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写确实能满足需求，但是会带来一个我们不愿意看到的副作用。修饰器返回的那个值，也就是刚才调用的 fibonacci，它的名字并不叫 <code class="language-text">fibonacci</code>。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28153443574195335000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`print(fibonacci)\n\n>>>\n<function trace.<locals>.wrapper at 0x108955dcO>`, `28153443574195335000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">print</span><span class="token punctuation">(</span>fibonacci<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token operator">&lt;</span>function trace<span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token builtin">locals</span><span class="token operator">></span><span class="token punctuation">.</span>wrapper at 0x108955dcO<span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种现象解释起来并不困难。trace 函数返回的，是它里面定义的 wrapper 函数，所以，当我们把这个返回值赋给 fibonacci 之后，fibonacci 这个名称所表示的自然就是 wrapper 了。问题在于，这样可能会干扰那些需要利用 introspection 机制来运作的工具，例如调试器（debugger）（参见第 80 条）。</p>\n<p>例如，如果用内置的 help 函数来查看修饰后的 fibonacci，那么打印出来的并不是我们想看的帮助文档，它本来应该打印前面定义时写的那行 <code class="language-text">Return the n-th Fibonacci number</code> 文本才对。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81411862002533580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`help(fibonacci)\n\n>>>\nHelp on function wrapper in module __main__:\n\nwrapper(*args, **kwargs)`, `81411862002533580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token builtin">help</span><span class="token punctuation">(</span>fibonacci<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nHelp on function wrapper <span class="token keyword">in</span> module __main__<span class="token punctuation">:</span>\n\nwrapper<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>对象序列化器（object serializer，参见第 68 条）也无法正常运作，因为它不能确定受修饰的那个原始函数的位置。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24322422365229457000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import pickle\n\npickle.dumps(fibonacci)\n\n>>>\nTraceback ...\nAttributeError: Can\'t pickle local object \'trace.<locals>.wrapper\'`, `24322422365229457000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> pickle\n\npickle<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>fibonacci<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nAttributeError<span class="token punctuation">:</span> Can<span class="token string">\'t pickle local object \'</span>trace<span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token builtin">locals</span><span class="token operator">></span><span class="token punctuation">.</span>wrapper\'</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>要想解决这些问题，可以改用 functools 内置模块之中的 wraps 辅助函数来实现。wraps 本身也是个修饰器，它可以帮助你编写自己的修饰器。把它运用到 wrapper 函数上面，它就会将重要的元数据（metadata）全都从内部函数复制到外部函数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35410417027512463000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import pickle\nfrom functools import wraps\n\n\ndef trace(func):\n    @wraps(func)\n    def wrapper(*args, **kwargs):\n        result = func(*args, **kwargs)\n        print(f\'{func.__name__}({args!r}，{kwargs!r})\'\n              f\'-> {result!r}\')\n        return result\n    return wrapper\n\n\n@trace\ndef fibonacci(n):\n    &quot;&quot;&quot;Return the n-th Fibonacci number&quot;&quot;&quot;\n    if n in (0, 1):\n        return n\n    return fibonacci(n - 2) + fibonacci(n - 1)\n\n\npickle.dumps(fibonacci)\nhelp(fibonacci)`, `35410417027512463000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{2,6}"\n              >\n                <span class="gatsby-code-button-language">py{2,6}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> pickle\n<span class="gatsby-highlight-code-line"><span class="token keyword">from</span> functools <span class="token keyword">import</span> wraps</span>\n\n<span class="token keyword">def</span> <span class="token function">trace</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="gatsby-highlight-code-line">    @wraps<span class="token punctuation">(</span>func<span class="token punctuation">)</span></span>    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        result <span class="token operator">=</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>func<span class="token punctuation">.</span>__name__<span class="token punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token punctuation">{</span>args<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">，</span><span class="token interpolation"><span class="token punctuation">{</span>kwargs<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">)\'</span></span>\n              <span class="token string-interpolation"><span class="token string">f\'-> </span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> result\n    <span class="token keyword">return</span> wrapper\n\n\n@trace\n<span class="token keyword">def</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token triple-quoted-string string">"""Return the n-th Fibonacci number"""</span>\n    <span class="token keyword">if</span> n <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> n\n    <span class="token keyword">return</span> fibonacci<span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> fibonacci<span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>\n\n\npickle<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>fibonacci<span class="token punctuation">)</span>\n<span class="token builtin">help</span><span class="token punctuation">(</span>fibonacci<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在我们就可以通过 help 函数看到正确的文档了。虽然原来的 fibonacci 函数现在封装在修饰器里面，但我们还是可以看到它的文档。</p>\n<p>除了这里讲到的几个方面之外，Python 函数还有很多标准属性（例如 <code class="language-text">__name__</code>、<code class="language-text">__module__</code>、<code class="language-text">__annotations__</code>）也应该在受到封装时得以保留，这样才能让相关的接口正常运作。wraps 可以帮助保留这些属性，使程序表现出正确的行为。</p>\n<h3 id="总结-22"><a href="#%E6%80%BB%E7%BB%93-22" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>修饰器是 Python 中的一种写法，能够把一个函数封装在另一个函数里面，这样程序在执行原函数之前与执行完毕之后，就有机会执行其他一些逻辑了。</li>\n<li>修饰器可能会让那些利用 introspection 机制运作的工具（例如调试器）产生奇怪的行为。</li>\n<li>Python 内置的 functools 模块里有个叫作 wraps 的修饰器，可以帮助我们正确定义自己的修饰器，从而避开相关的问题。</li>\n</ol>\n<h1 id="推导与生成"><a href="#%E6%8E%A8%E5%AF%BC%E4%B8%8E%E7%94%9F%E6%88%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>推导与生成</h1>\n<h2 id="第-27-条：用列表推导取代-map-与-filter"><a href="#%E7%AC%AC-27-%E6%9D%A1%EF%BC%9A%E7%94%A8%E5%88%97%E8%A1%A8%E6%8E%A8%E5%AF%BC%E5%8F%96%E4%BB%A3-map-%E4%B8%8E-filter" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 27 条：用列表推导取代 map 与 filter</h2>\n<p>Python 里面有一种很精简的写法，可以根据某个序列或可迭代对象派生出一份新的列表。用这种写法写成的表达式，叫作列表推导（list comprehension）。假设我们要用列表中每个元素的平方值构建一份新的列表。传统的写法是，采用下面这个简单的 for 循环来实现。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31231132960834994000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]\nsquares = []\nfor x in a:\n    squares.append(x**2)\nprint(squares)\n\n>>>\n[1, 4, 9, 16, 25, 36, 49, 64, 81, 100]`, `31231132960834994000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\nsquares <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n<span class="token keyword">for</span> x <span class="token keyword">in</span> a<span class="token punctuation">:</span>\n    squares<span class="token punctuation">.</span>append<span class="token punctuation">(</span>x<span class="token operator">**</span><span class="token number">2</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>squares<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">49</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">81</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面那段代码可以改用列表推导来写，这样可以在迭代列表的过程中，根据表达式算出新列表中的对应元素。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67897244148319945000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]\nsquares = [x**2 for x in a]\nprint(squares)`, `67897244148319945000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\nsquares <span class="token operator">=</span> <span class="token punctuation">[</span>x<span class="token operator">**</span><span class="token number">2</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> a<span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>squares<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>这种功能当然也可以用内置函数 map 实现，它能够从多个列表中分别取出当前位置上的元素，并把它们当作参数传给映射函数，以求出新列表在这个位置上的元素值。如果映射关系比较简单（例如只是把一个列表映射到另一个列表），那么用列表推导来写还是比用 map 简单一些，因为用 map 的时候，必须先把映射逻辑定义成 lambda 函数，这看上去稍微有点烦琐。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81847506326765600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]\nsquares = list(map(lambda x: x ** 2, a))\nprint(squares)`, `81847506326765600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\nsquares <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>squares<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>列表推导还有一个地方比 map 好，就是它能够方便地过滤原列表，把某些输入值对应的计算结果从输出结果中排除。例如，假设新列表只需要纳入原列表中那些偶数的平方值，那我们可以在推导的时候，在 for x in a 这一部分的右侧写一个条件表达式：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95212537861541450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]\neven_squares = [x**2 for x in a if x % 2 == 0]\nprint(even_squares)\n\n>>>\n[4, 16, 36, 64, 100]`, `95212537861541450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\neven_squares <span class="token operator">=</span> <span class="token punctuation">[</span>x<span class="token operator">**</span><span class="token number">2</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> a <span class="token keyword">if</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>even_squares<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种功能也可以通过内置的 filter 与 map 函数来实现，但是这两个函数相结合的写法要比列表推导难懂一些。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85344879134620010000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]\neven_squares = [x**2 for x in a if x % 2 == 0]\nalt = map(lambda x: x**2, filter(lambda x: x % 2 == 0, a))\nassert even_squares == list(alt)`, `85344879134620010000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\neven_squares <span class="token operator">=</span> <span class="token punctuation">[</span>x<span class="token operator">**</span><span class="token number">2</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> a <span class="token keyword">if</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">]</span>\nalt <span class="token operator">=</span> <span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token operator">**</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">assert</span> even_squares <span class="token operator">==</span> <span class="token builtin">list</span><span class="token punctuation">(</span>alt<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>字典与集合也有相应的推导机制，分别叫作字典推导（dictionary comprehension）与集合推导（set comprehension）。编写算法时，可以利用这些机制根据原字典与原集合创建新字典与新集合。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95471519719868350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]\neven_squares_dict = {x: x**2 for x in a if x % 2 == 0}\nthrees_cubed_set = {x**3 for x in a if x % 3 == 0}\nprint(even_squares_dict)\nprint(threes_cubed_set)\n\n>>>\n{2: 4, 4: 16, 6: 36, 8: 64, 10: 100}\n{216, 729, 27}`, `95471519719868350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\neven_squares_dict <span class="token operator">=</span> <span class="token punctuation">{</span>x<span class="token punctuation">:</span> x<span class="token operator">**</span><span class="token number">2</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> a <span class="token keyword">if</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">}</span>\nthrees_cubed_set <span class="token operator">=</span> <span class="token punctuation">{</span>x<span class="token operator">**</span><span class="token number">3</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> a <span class="token keyword">if</span> x <span class="token operator">%</span> <span class="token number">3</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">}</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>even_squares_dict<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>threes_cubed_set<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">:</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">:</span> <span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">:</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">}</span>\n<span class="token punctuation">{</span><span class="token number">216</span><span class="token punctuation">,</span> <span class="token number">729</span><span class="token punctuation">,</span> <span class="token number">27</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果改用 map 与 filter 实现，那么还必须调用相应的构造器（constructor），这会让代码变得很长，需要分成多行才能写得下。这样看起来比较乱，不如使用推导机制的代码清晰。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84856221008812340000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]\neven_squares_dict = {x: x**2 for x in a if x % 2 == 0}\nthrees_cubed_set = {x**3 for x in a if x % 3 == 0}\n\nalt_dict = dict(map(lambda x: (x, x**2),\n                    filter(lambda x: x % 2 == 0, a)))\nalt_set = set(map(lambda x: x**3,\n                  filter(lambda x: x % 3 == 0, a)))\n\nassert even_squares_dict == alt_dict\nassert threes_cubed_set == alt_set`, `84856221008812340000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\neven_squares_dict <span class="token operator">=</span> <span class="token punctuation">{</span>x<span class="token punctuation">:</span> x<span class="token operator">**</span><span class="token number">2</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> a <span class="token keyword">if</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">}</span>\nthrees_cubed_set <span class="token operator">=</span> <span class="token punctuation">{</span>x<span class="token operator">**</span><span class="token number">3</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> a <span class="token keyword">if</span> x <span class="token operator">%</span> <span class="token number">3</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">}</span>\n\nalt_dict <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> x<span class="token operator">**</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n                    <span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\nalt_set <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token operator">**</span><span class="token number">3</span><span class="token punctuation">,</span>\n                  <span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x <span class="token operator">%</span> <span class="token number">3</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token keyword">assert</span> even_squares_dict <span class="token operator">==</span> alt_dict\n<span class="token keyword">assert</span> threes_cubed_set <span class="token operator">==</span> alt_set</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="总结-23"><a href="#%E6%80%BB%E7%BB%93-23" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>列表推导要比内置的 map 与 filter 函数清晰，因为它不用另外定义 lambda 表达式。</li>\n<li>列表推导可以很容易地跳过原列表中的某些数据，假如改用 map 实现，那么必须搭配 filter 才能实现。</li>\n<li>字典与集合也可以通过推导来创建。</li>\n</ol>\n<h2 id="第-28-条：控制推导逻辑的子表达式不要超过两个"><a href="#%E7%AC%AC-28-%E6%9D%A1%EF%BC%9A%E6%8E%A7%E5%88%B6%E6%8E%A8%E5%AF%BC%E9%80%BB%E8%BE%91%E7%9A%84%E5%AD%90%E8%A1%A8%E8%BE%BE%E5%BC%8F%E4%B8%8D%E8%A6%81%E8%B6%85%E8%BF%87%E4%B8%A4%E4%B8%AA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 28 条：控制推导逻辑的子表达式不要超过两个</h2>\n<p>除了最基本的用法（参见第 27 条）外，列表推导还支持多层循环。例如，要把矩阵（一种二维列表，它的每个元素本身也是列表）转化成普通的一维列表，那么可以在推导时，使用两条 for 子表达式。这些子表达式会按照从左到右的顺序解读。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70967206977812420000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`matrix = [[1, 2, 3], [4, 5, 6], [7, 8, 9]]\nflat = [x for row in matrix for x in row]\nprint(flat)\n\n>>>\n[1, 2, 3, 4, 5, 6, 7, 8, 9]`, `70967206977812420000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">matrix <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">]</span>\nflat <span class="token operator">=</span> <span class="token punctuation">[</span>x <span class="token keyword">for</span> row <span class="token keyword">in</span> matrix <span class="token keyword">for</span> x <span class="token keyword">in</span> row<span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>flat<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写简单易懂，这也正是多层循环在列表推导之中的合理用法。多层循环还可以用来重制那种两层深的结构。例如，如果要根据二维矩阵里每个元素的平方值构建一个新的二维矩阵，那么可以采用下面这种写法。这看上去有点儿复杂，因为它把小的推导逻辑 <code class="language-text">[x**2 for x in row]</code> 嵌到了大的推导逻辑里面，不过，这行语句总体上不难理解。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26068418161114270000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`matrix = [[1, 2, 3], [4, 5, 6], [7, 8, 9]]\nsquared = [[x**2 for x in row] for row in matrix]\nprint(squared)\n\n>>>\n[[1, 4, 9], [16, 25, 36], [49, 64, 81]]`, `26068418161114270000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">matrix <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">]</span>\nsquared <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>x<span class="token operator">**</span><span class="token number">2</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> row<span class="token punctuation">]</span> <span class="token keyword">for</span> row <span class="token keyword">in</span> matrix<span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>squared<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">49</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">81</span><span class="token punctuation">]</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果推导过程中还要再加一层循环，那么语句就会变得很长，必须把它分成多行来写，例如下面是把一个三维矩阵转化成普通一维列表的代码。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69285928065142870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`my_lists = [\n    [[1, 2, 3], [4, 5, 6]]\n]\nflat = [x for sublist1 in my_lists\n        for sublist2 in sublist1\n        for x in sublist2]\nprint(flat)\n\n>>>\n[1, 2, 3, 4, 5, 6]`, `69285928065142870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">my_lists <span class="token operator">=</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">]</span>\n<span class="token punctuation">]</span>\nflat <span class="token operator">=</span> <span class="token punctuation">[</span>x <span class="token keyword">for</span> sublist1 <span class="token keyword">in</span> my_lists\n        <span class="token keyword">for</span> sublist2 <span class="token keyword">in</span> sublist1\n        <span class="token keyword">for</span> x <span class="token keyword">in</span> sublist2<span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>flat<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在这种情况下，采用列表推导来实现，其实并不会比传统的 for 循环节省多少代码。下面用常见的 for 循环改写刚才的例子。这次我们通过级别不同的缩进表示每一层循环的深度，这要比刚才那种三层矩阵的列表推导更加清晰。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42031526679378280000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`my_lists = [\n    [[1, 2, 3], [4, 5, 6]]\n]\nflat = []\nfor sublistl in my_lists:\n    for sublist2 in sublistl:\n        flat.extend(sublist2)`, `42031526679378280000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">my_lists <span class="token operator">=</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">]</span>\n<span class="token punctuation">]</span>\nflat <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n<span class="token keyword">for</span> sublistl <span class="token keyword">in</span> my_lists<span class="token punctuation">:</span>\n    <span class="token keyword">for</span> sublist2 <span class="token keyword">in</span> sublistl<span class="token punctuation">:</span>\n        flat<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>sublist2<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>推导的时候，可以使用多个 if 条件。如果这些 if 条件出现在同一层循环内，那么它们之间默认是 and 关系，也就是必须同时成立。例如，如果要用原列表中大于 4 且是偶数的值来构建新列表，那么既可以连用两个 if，也可以只用一个 if，下面两种写法效果相同。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62639249502145430000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]\nb = [x for x in a if x > 4 if x % 2 == 0]\nc = [x for x in a if x > 4 and x % 2 == 0]`, `62639249502145430000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\nb <span class="token operator">=</span> <span class="token punctuation">[</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> a <span class="token keyword">if</span> x <span class="token operator">></span> <span class="token number">4</span> <span class="token keyword">if</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">]</span>\nc <span class="token operator">=</span> <span class="token punctuation">[</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> a <span class="token keyword">if</span> x <span class="token operator">></span> <span class="token number">4</span> <span class="token keyword">and</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>在推导时，每一层的 for 子表达式都可以带有 if 条件。例如，要根据原矩阵构建新的矩阵，把其中各元素之和大于等于 10 的那些行选出来，而且只保留其中能够被 3 整除的那些元素。这个逻辑用列表推导来写，并不需要太多的代码，但是这些代码理解起来会很困难。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36387041865013340000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`matrix = [[1, 2, 3], [4, 5, 6], [7, 8, 9]]\nfiltered = [[x for x in row if x % 3 == 0]\n            for row in matrix if sum(row) >= 10]\nprint(filtered)\n\n>>>\n[[6], [9]]`, `36387041865013340000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">matrix <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">]</span>\nfiltered <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> row <span class="token keyword">if</span> x <span class="token operator">%</span> <span class="token number">3</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">]</span>\n            <span class="token keyword">for</span> row <span class="token keyword">in</span> matrix <span class="token keyword">if</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>row<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">10</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>filtered<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>虽然这个例子是笔者专门构造出来的，但在实际中，我们确实会碰到很多类似的需求。有人可能觉得，这些需求应该通过推导来实现。然而，笔者强烈建议大家不要用刚才的写法来推导新的 list、dict 或 set，因为这样写出来的代码很难让初次阅读这段程序的人看懂。对于 dict 来说，问题尤其严重，因为必须得把键与值的推导逻辑都表达出来才行。</p>\n<p>总之，在表示推导逻辑时，最多只应该写两个子表达式（例如两个 if 条件、两个 for 循环，或者一个 if 条件与一个 for 循环）。只要实现的逻辑比这还复杂，那就应该采用普通的 if 与 for 语句来实现，并且可以考虑编写辅助函数（参见第 30 条）。</p>\n<h3 id="总结-24"><a href="#%E6%80%BB%E7%BB%93-24" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>推导的时候可以使用多层循环，每层循环可以带有多个条件。</li>\n<li>控制推导逻辑的子表达式不要超过两个，否则代码很难读懂。</li>\n</ol>\n<h2 id="第-29-条：用赋值表达式消除推导中的重复代码"><a href="#%E7%AC%AC-29-%E6%9D%A1%EF%BC%9A%E7%94%A8%E8%B5%8B%E5%80%BC%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B6%88%E9%99%A4%E6%8E%A8%E5%AF%BC%E4%B8%AD%E7%9A%84%E9%87%8D%E5%A4%8D%E4%BB%A3%E7%A0%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 29 条：用赋值表达式消除推导中的重复代码</h2>\n<p>推导 list、dict 与 set 等变体结构时，经常要在多个地方用到同一个计算结果。例如，我们要给制作紧固件的公司编写程序以管理订单。顾客下单后，我们要判断当前的库存能否满足这份订单，也就是说，要核查每种产品的数量有没有达到可以发货的最低限制（8 个为一批，至少要有一批，才能发货）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38076977182045946000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`stock = {\n    \'nails\': 125,\n    \'screws\': 35,\n    \'wingnuts\': 8,\n    \'washers\': 24,\n}\norder = [\'screws\', \'wingnuts\', \'clips\']\n\n\ndef get_batches(count, size):\n    return count // size\n\n\nresult = {}\nfor name in order:\n    count = stock.get(name, 0)\n    batches = get_batches(count, 8)\n    if batches:\n        result[name] = batches\n\nprint(result)\n\n>>>\n{\'screws\': 4, \'wingnuts\': 1}`, `38076977182045946000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">stock <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token string">\'nails\'</span><span class="token punctuation">:</span> <span class="token number">125</span><span class="token punctuation">,</span>\n    <span class="token string">\'screws\'</span><span class="token punctuation">:</span> <span class="token number">35</span><span class="token punctuation">,</span>\n    <span class="token string">\'wingnuts\'</span><span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span>\n    <span class="token string">\'washers\'</span><span class="token punctuation">:</span> <span class="token number">24</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\norder <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'screws\'</span><span class="token punctuation">,</span> <span class="token string">\'wingnuts\'</span><span class="token punctuation">,</span> <span class="token string">\'clips\'</span><span class="token punctuation">]</span>\n\n\n<span class="token keyword">def</span> <span class="token function">get_batches</span><span class="token punctuation">(</span>count<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> count <span class="token operator">//</span> size\n\n\nresult <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n<span class="token keyword">for</span> name <span class="token keyword">in</span> order<span class="token punctuation">:</span>\n    count <span class="token operator">=</span> stock<span class="token punctuation">.</span>get<span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\n    batches <span class="token operator">=</span> get_batches<span class="token punctuation">(</span>count<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span>\n    <span class="token keyword">if</span> batches<span class="token punctuation">:</span>\n        result<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> batches\n\n<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">{</span><span class="token string">\'screws\'</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">\'wingnuts\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这段循环逻辑，如果改用字典推导来写，会简单一些（参见第 27 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71672349442513990000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`found = {name: get_batches(stock.get(name, 0), 8)\n         for name in order\n         if get_batches(stock.get(name, 0), 8)}\nprint(found)`, `71672349442513990000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">found <span class="token operator">=</span> <span class="token punctuation">{</span>name<span class="token punctuation">:</span> get_batches<span class="token punctuation">(</span>stock<span class="token punctuation">.</span>get<span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span>\n         <span class="token keyword">for</span> name <span class="token keyword">in</span> order\n         <span class="token keyword">if</span> get_batches<span class="token punctuation">(</span>stock<span class="token punctuation">.</span>get<span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">}</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>found<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写虽然比刚才简短，但问题是，它把 <code class="language-text">get_batches(stock.get(name, 0), 8)</code> 写了两遍。这样会让代码看起来比较乱，而且实际上，程序也没有必要把这个结果计算两遍。另外，如果这两个地方忘了同步更新，那么程序就会出现 bug。例如，我们决定每一批不是 8 个，而是 4 个，那么需要把 <code class="language-text">get_batches</code> 的第二个参数从 8 改成 4，但是，万一我们忘了同步修改另一个地方，那么代码就可能会出问题（它会把大于等于 4 但是小于 8 的情况给漏掉）。</p>\n<p>有个简单的办法可以解决这个问题，那就是在推导的过程中使用 Python 3.8 新引入的 <code class="language-text">:=</code> 操作符进行赋值表达（参见第 10 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52881851398743155000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`found = {name: batches for name in order\n         if (batches := get_batches(stock.get(name, 0), 8))}`, `52881851398743155000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">found <span class="token operator">=</span> <span class="token punctuation">{</span>name<span class="token punctuation">:</span> batches <span class="token keyword">for</span> name <span class="token keyword">in</span> order\n         <span class="token keyword">if</span> <span class="token punctuation">(</span>batches <span class="token punctuation">:</span><span class="token operator">=</span> get_batches<span class="token punctuation">(</span>stock<span class="token punctuation">.</span>get<span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>这条 <code class="language-text">batches := get_batches(...)</code> 赋值表达式，能够从 stock 字典里查到对应产品一共有几批，并把这个批数放在 batches 变量里。这样的话，我们推导这个产品所对应批数时，就不用再通过 <code class="language-text">get_batches</code> 计算了，因为结果已经保存到 batches 里面了。这种写法只需要把 get 与 <code class="language-text">get_batches</code> 调用一次即可，这样能够提升效率，因为我们不需要针对 order 列表中的每件产品都多做一次 get 与 <code class="language-text">get_batches</code>。</p>\n<p>在推导过程中，描述新值的那一部分也可以出现赋值表达式。但如果在其他部分引用了定义在那一部分的变量，那么程序可能就会在运行时出错。例如，如果写成了下面这样，那么程序就必须先考虑 <code class="language-text">for name, count in stock.items() if tenth &gt; 0</code>，而这个时候，其中的 tenth 还没有得到定义。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7690853315085966000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`result = {name: (tenth := count // 10)\n          for name, count in stock.items() if tenth > 0}\nprint(result)\n\n>>>\nTraceback ...\nNameError: name \'tenth\' is not defined`, `7690853315085966000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">result <span class="token operator">=</span> <span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token punctuation">(</span>tenth <span class="token punctuation">:</span><span class="token operator">=</span> count <span class="token operator">//</span> <span class="token number">10</span><span class="token punctuation">)</span>\n          <span class="token keyword">for</span> name<span class="token punctuation">,</span> count <span class="token keyword">in</span> stock<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> tenth <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">}</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nNameError<span class="token punctuation">:</span> name <span class="token string">\'tenth\'</span> <span class="token keyword">is</span> <span class="token keyword">not</span> defined</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>为了解决这个问题，可以把赋值表达式移动到 if 条件里面，然后在描述新值的这一部分引用已经定义过的 tenth 变量。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83540864515836070000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`result = {name: tenth for name, count in stock.items()\n          if (tenth := count // 10) > 0}\nprint(result)\n\n>>>\n{\'nails\': 12, \'screws\': 3, \'washers\': 2}`, `83540864515836070000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">result <span class="token operator">=</span> <span class="token punctuation">{</span>name<span class="token punctuation">:</span> tenth <span class="token keyword">for</span> name<span class="token punctuation">,</span> count <span class="token keyword">in</span> stock<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span>tenth <span class="token punctuation">:</span><span class="token operator">=</span> count <span class="token operator">//</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">}</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">{</span><span class="token string">\'nails\'</span><span class="token punctuation">:</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token string">\'screws\'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">\'washers\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果推导逻辑不带条件，而表示新值的那一部分又使用了 <code class="language-text">:=</code> 操作符，那么操作符左边的变量就会泄漏到包含这条推导语句的那个作用域里（参见第 21 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16652920926695125000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`half = [(last := count // 2) for count in stock.values()]\nprint(f\'Last item of {half} is {last}\')\n\n>>>\nLast item of [62, 17, 4, 12] is 12`, `16652920926695125000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">half <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>last <span class="token punctuation">:</span><span class="token operator">=</span> count <span class="token operator">//</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">for</span> count <span class="token keyword">in</span> stock<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Last item of </span><span class="token interpolation"><span class="token punctuation">{</span>half<span class="token punctuation">}</span></span><span class="token string"> is </span><span class="token interpolation"><span class="token punctuation">{</span>last<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nLast item of <span class="token punctuation">[</span><span class="token number">62</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">]</span> <span class="token keyword">is</span> <span class="token number">12</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这与普通的 for 循环所用的那个循环变量类似</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66745935072397060000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`for count in stock.values():  # Leaks loop variable\n    pass\nprint(f\'Last item of {list(stock.values())} is {count}\')\n\n>>>\nLast item of [125, 35, 8, 24] is 24`, `66745935072397060000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">for</span> count <span class="token keyword">in</span> stock<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># Leaks loop variable</span>\n    <span class="token keyword">pass</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Last item of </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">list</span><span class="token punctuation">(</span>stock<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> is </span><span class="token interpolation"><span class="token punctuation">{</span>count<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nLast item of <span class="token punctuation">[</span><span class="token number">125</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">]</span> <span class="token keyword">is</span> <span class="token number">24</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然而，推导语句中的 for 循环所使用的循环变量，是不会像刚才那样泄漏到外面的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86024449951081580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`half = [count // 2 for count in stock.values()]\nprint(half)\n# Works\nprint(count)  # Exception because loop variable didn\'t leak\n\n>>>\n[62, 17, 4, 12]\nTraceback ...\nNameError: name \'count\' is not defined`, `86024449951081580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">half <span class="token operator">=</span> <span class="token punctuation">[</span>count <span class="token operator">//</span> <span class="token number">2</span> <span class="token keyword">for</span> count <span class="token keyword">in</span> stock<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>half<span class="token punctuation">)</span>\n<span class="token comment"># Works</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span>  <span class="token comment"># Exception because loop variable didn\'t leak</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">62</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">]</span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nNameError<span class="token punctuation">:</span> name <span class="token string">\'count\'</span> <span class="token keyword">is</span> <span class="token keyword">not</span> defined</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>最好不要泄漏循环变量，所以，建议赋值表达式只出现在推导逻辑的条件之中。</p>\n<p>赋值表达式不仅可以用在推导过程中，而且可以用来编写生成器表达式（generator expression，参见第 32 条）。下面这种写法创建的是迭代器，而不是字典实例，该迭代器每次会给出一对数值，其中第一个元素为产品的名字，第二个元素为这种产品的库存。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52856936304891740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`found = ((name, batches) for name in order\n         if (batches := get_batches(stock.get(name, 0), 8)))\nprint(next(found))\nprint(next(found))\n\n>>>\n(\'screws\', 4)\n(\'wingnuts\', 1)`, `52856936304891740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">found <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> batches<span class="token punctuation">)</span> <span class="token keyword">for</span> name <span class="token keyword">in</span> order\n         <span class="token keyword">if</span> <span class="token punctuation">(</span>batches <span class="token punctuation">:</span><span class="token operator">=</span> get_batches<span class="token punctuation">(</span>stock<span class="token punctuation">.</span>get<span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">next</span><span class="token punctuation">(</span>found<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">next</span><span class="token punctuation">(</span>found<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">(</span><span class="token string">\'screws\'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>\n<span class="token punctuation">(</span><span class="token string">\'wingnuts\'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="总结-25"><a href="#%E6%80%BB%E7%BB%93-25" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>编写推导式与生成器表达式时，可以在描述条件的那一部分通过赋值表达式定义变量，并在其他部分复用该变量，可使程序简单易读。</li>\n<li>对于推导式与生成器表达式来说，虽然赋值表达式也可以出现在描述条件的那一部分之外，但最好别这么写。</li>\n</ol>\n<h2 id="第-30-条：不要让函数直接返回列表，应该让它逐个生成列表里的值"><a href="#%E7%AC%AC-30-%E6%9D%A1%EF%BC%9A%E4%B8%8D%E8%A6%81%E8%AE%A9%E5%87%BD%E6%95%B0%E7%9B%B4%E6%8E%A5%E8%BF%94%E5%9B%9E%E5%88%97%E8%A1%A8%EF%BC%8C%E5%BA%94%E8%AF%A5%E8%AE%A9%E5%AE%83%E9%80%90%E4%B8%AA%E7%94%9F%E6%88%90%E5%88%97%E8%A1%A8%E9%87%8C%E7%9A%84%E5%80%BC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 30 条：不要让函数直接返回列表，应该让它逐个生成列表里的值</h2>\n<p>如果函数要返回的是个包含许多结果的序列，那么最简单的办法就是把这些结果放到列表中。例如，我们要返回字符串里每个单词的首字母所对应的下标。下面这种写法，会把每次遇到的新单词所在的位置追加（append）到存放结果的 result 列表中，在函数末尾返回这份列表。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81829568960734660000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def index_words(text):\n    result = []\n    if text:\n        result.append(0)\n    for index, letter in enumerate(text):\n        if letter == \' \':\n            result.append(index + 1)\n    return result`, `81829568960734660000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">index_words</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n    <span class="token keyword">if</span> text<span class="token punctuation">:</span>\n        result<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>\n    <span class="token keyword">for</span> index<span class="token punctuation">,</span> letter <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> letter <span class="token operator">==</span> <span class="token string">\' \'</span><span class="token punctuation">:</span>\n            result<span class="token punctuation">.</span>append<span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>\n    <span class="token keyword">return</span> result</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们把一段范例文本传给这个函数，它可以返回正确的结果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31200205882580190000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`address = \'Four score and seven years ago...\'\nresult = index_words(address)\nprint(result)\n\n>>>\n[0, 5, 11, 15, 21, 27]`, `31200205882580190000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">address <span class="token operator">=</span> <span class="token string">\'Four score and seven years ago...\'</span>\nresult <span class="token operator">=</span> index_words<span class="token punctuation">(</span>address<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token number">27</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>index_words 函数有两个缺点。</p>\n<ol>\n<li>\n<p>它的代码看起来有点杂乱。每找到一个新单词，它都要调用 append 方法，而调用这个方法时，必须写上 result.append 这样一串字符，这就把我们想要强调的重点，也就是这个新单词在字符串中的位置（index + 1）淡化了。另外，函数还必须专门用一行代码创建这个保存结果的 result 列表，并且要用一条 return 语句把它返回给调用者。这样算下来，虽然函数的主体部分大约有 130 个字符（非空白的），但真正重要的只有 75 个左右。</p>\n<p>这种函数改用生成器（generator）来实现会比较好。生成器由包含 yield 表达式的函数创建。下面就定义一个生成器函数，实现与刚才那个函数相同的效果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51121521240038740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def index_words_iter(text):\n  if text:\n     yield 0\n  for index, letter in enumerate(text):\n     if letter == \' \':\n           yield index + 1\n\naddress = \'Four score and seven years ago...\'\nresult = index_words_iter(address)\nprint(list(result))`, `51121521240038740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">index_words_iter</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  <span class="token keyword">if</span> text<span class="token punctuation">:</span>\n     <span class="token keyword">yield</span> <span class="token number">0</span>\n  <span class="token keyword">for</span> index<span class="token punctuation">,</span> letter <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">:</span>\n     <span class="token keyword">if</span> letter <span class="token operator">==</span> <span class="token string">\' \'</span><span class="token punctuation">:</span>\n           <span class="token keyword">yield</span> index <span class="token operator">+</span> <span class="token number">1</span>\n\naddress <span class="token operator">=</span> <span class="token string">\'Four score and seven years ago...\'</span>\nresult <span class="token operator">=</span> index_words_iter<span class="token punctuation">(</span>address<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>它必须把所有的结果都保存到列表中，然后才能返回列表。如果输入的数据特别多，那么程序可能会因为耗尽内存而崩溃。</p>\n<p>相反，用生成器函数来实现，就不会有这个问题了。它可以接受长度任意的输入信息，并把内存消耗量压得比较低。例如下面这个生成器，只需要把当前这行文字从文件中读进来就行，每次推进的时候，它都只处理一个单词，直到把当前这行文字处理完毕，才读入下一行文字。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43950805307552150000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\ndef index_file(handle):\n  offset = 0\n  for line in handle:\n     if line:\n           yield offset\n     for letter in line:\n           offset += 1\n           if letter == \' \':\n              yield offset\n\nwith open(\'address.txt\', \'r\') as f:\n  it = index_file(f)\n  results = itertools.islice(it, 0, 10)\n  print(list(results))`, `43950805307552150000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\n<span class="token keyword">def</span> <span class="token function">index_file</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  offset <span class="token operator">=</span> <span class="token number">0</span>\n  <span class="token keyword">for</span> line <span class="token keyword">in</span> handle<span class="token punctuation">:</span>\n     <span class="token keyword">if</span> line<span class="token punctuation">:</span>\n           <span class="token keyword">yield</span> offset\n     <span class="token keyword">for</span> letter <span class="token keyword">in</span> line<span class="token punctuation">:</span>\n           offset <span class="token operator">+=</span> <span class="token number">1</span>\n           <span class="token keyword">if</span> letter <span class="token operator">==</span> <span class="token string">\' \'</span><span class="token punctuation">:</span>\n              <span class="token keyword">yield</span> offset\n\n<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'address.txt\'</span><span class="token punctuation">,</span> <span class="token string">\'r\'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>\n  it <span class="token operator">=</span> index_file<span class="token punctuation">(</span>f<span class="token punctuation">)</span>\n  results <span class="token operator">=</span> itertools<span class="token punctuation">.</span>islice<span class="token punctuation">(</span>it<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>\n  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>该函数运行时所耗的内存，取决于文件中最长的那一行所包含的字符数。把刚才那份输入数据存放到 address.txt 文件，让这个函数去读取并用它所返回的生成器构建一份列表，可以看到跟原来相同的结果（islice 函数的详细用法，参见第 36 条）。</p>\n<p>定义这种生成器函数的时候，只有一个地方需要注意，就是调用者无法重复使用函数所返回的迭代器，因为这些迭代器是有状态的（参见第 31 条）。</p>\n</li>\n</ol>\n<h3 id="总结-26"><a href="#%E6%80%BB%E7%BB%93-26" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>用生成器来实现比让函数把结果收集合到列表里再返回，要更加清晰一些。</li>\n<li>生成器函数所返回的迭代器可以产生一系列值，每次产生的那个值都是由函数体的下一条 yield 表达式所决定的。</li>\n<li>不管输入的数据量有多大，生成器函数每次都只需要根据其中的一小部分来计算当前这次的输出值。它不用把整个输入值全都读取进来，也不用一次就把所有的输出值全都算好。</li>\n</ol>\n<h2 id="第-31-条：谨慎地迭代函数所收到的参数"><a href="#%E7%AC%AC-31-%E6%9D%A1%EF%BC%9A%E8%B0%A8%E6%85%8E%E5%9C%B0%E8%BF%AD%E4%BB%A3%E5%87%BD%E6%95%B0%E6%89%80%E6%94%B6%E5%88%B0%E7%9A%84%E5%8F%82%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 31 条：谨慎地迭代函数所收到的参数</h2>\n<p>如果函数接受的参数是个包含许多对象的列表，那么这份列表有可能要迭代多次。例如，我们要分析美国得克萨斯州的游客数量。原始数据保存在一份列表中，其中的每个元素表示每年有多少游客到这个城市旅游（单位是百万）。我们现在要统计每个城市的游客数占游客总数的百分比。</p>\n<p>为了求出这份数据，先把列表里的所有元素加起来求出游客总数，然后，分别用每个城市的游客数除以游客总数计算出该城市在总数据中所占的百分比。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8996699445835432000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def normalize(numbers):\n    total = sum(numbers)\n    result = []\n    for value in numbers:\n        percent = 100 * value / total\n        result.append(percent)\n    return result`, `8996699445835432000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">normalize</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    total <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n    result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n    <span class="token keyword">for</span> value <span class="token keyword">in</span> numbers<span class="token punctuation">:</span>\n        percent <span class="token operator">=</span> <span class="token number">100</span> <span class="token operator">*</span> value <span class="token operator">/</span> total\n        result<span class="token punctuation">.</span>append<span class="token punctuation">(</span>percent<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> result</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>把一份范例数据放到列表中传给这个函数，可以得到正确的结果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49928591626037800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def normalize(numbers):\n    total = sum(numbers)\n    result = []\n    for value in numbers:\n        percent = 100 * value / total\n        result.append(percent)\n    return result\n\n\nvisits = [15, 35, 80]\npercentages = normalize(visits)\nprint(percentages)\nassert sum(percentages) == 100.0\n\n>>>\n[11.538461538461538, 26.923076923076923, 61.53846153846154]`, `49928591626037800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">normalize</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    total <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n    result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n    <span class="token keyword">for</span> value <span class="token keyword">in</span> numbers<span class="token punctuation">:</span>\n        percent <span class="token operator">=</span> <span class="token number">100</span> <span class="token operator">*</span> value <span class="token operator">/</span> total\n        result<span class="token punctuation">.</span>append<span class="token punctuation">(</span>percent<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> result\n\n\nvisits <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">]</span>\npercentages <span class="token operator">=</span> normalize<span class="token punctuation">(</span>visits<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>percentages<span class="token punctuation">)</span>\n<span class="token keyword">assert</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>percentages<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">100.0</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">11.538461538461538</span><span class="token punctuation">,</span> <span class="token number">26.923076923076923</span><span class="token punctuation">,</span> <span class="token number">61.53846153846154</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>为了应对规模更大的数据，我们现在需要让程序能够从文件中读取信息，并假设得克萨斯州所有城市的游客数都放在这份文件中。笔者决定用生成器实现，因为这样做可以让我们把同样的功能套用在其他数据上面，例如分析全世界（而不仅仅是得克萨斯一州）各城市的游客数。那些场合的数据量与内存用量可能会比现在大得多（参见第 30 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25523735909703537000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def read_visits(data_path):\n    with open(data_path)as f:\n        for line in f:\n            yield int(line)`, `25523735909703537000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">read_visits</span><span class="token punctuation">(</span>data_path<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>data_path<span class="token punctuation">)</span><span class="token keyword">as</span> f<span class="token punctuation">:</span>\n        <span class="token keyword">for</span> line <span class="token keyword">in</span> f<span class="token punctuation">:</span>\n            <span class="token keyword">yield</span> <span class="token builtin">int</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>奇怪的是，对 <code class="language-text">read_visits</code> 所返回的迭代器调用 normalize 函数后，并没有得到结果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69903350589443550000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`it = read_visits(\'my_numbers.txt\')\npercentages = normalize(it)\nprint(percentages)\n\n>>>\n[]`, `69903350589443550000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">it <span class="token operator">=</span> read_visits<span class="token punctuation">(</span><span class="token string">\'my_numbers.txt\'</span><span class="token punctuation">)</span>\npercentages <span class="token operator">=</span> normalize<span class="token punctuation">(</span>it<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>percentages<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>出现这种状况的原因在于，迭代器只能产生一次结果。假如迭代器或生成器已经抛出过 StopIteration 异常，继续用它来构造列表或是像 normalize 那样对它做 for 循环，那它不会给出任何结果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50320459067649330000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`it = read_visits(\'my_numbers.txt\')\nprint(list(it))\nprint(list(it))  # Already exhausted\n\n>>>\n[15, 35, 80]\n[]`, `50320459067649330000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">it <span class="token operator">=</span> read_visits<span class="token punctuation">(</span><span class="token string">\'my_numbers.txt\'</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># Already exhausted</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>还有个因素也很令人迷惑，那就是：在已经把数据耗完的迭代器上面继续迭代，程序居然不报错。for 循环、list 构造器以及 Python 标准库的其他许多函数，都认为迭代器在正常的操作过程中抛出 StopIteration 异常是很自然的。它们没办法区分，这个迭代器是本身就没有数据可以提供，还是虽然有数据，但现在已经耗尽了。</p>\n<p>为了解决这个问题，我们可以把外界传入的迭代器特意遍历一整轮，从而将其中的内容复制到一份列表里。这样的话，以后就可以用这份列表来处理数据了，那时想迭代多少遍都可以。下面的函数与原来的 normalize 函数功能相同，但是它会把收到的那个 numbers 迭代器所能提供的数据明确地复制到 <code class="language-text">numbers_copy</code> 列表里。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3775057581412100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def normalize_copy(numbers):\n    numbers_copy = list(numbers)  # Copy the iterator\n    total = sum(numbers_copy)\n    result = []\n    for value in numbers_copy:\n        percent = 100 * value / total\n        result.append(percent)\n    return result`, `3775057581412100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">normalize_copy</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    numbers_copy <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>  <span class="token comment"># Copy the iterator</span>\n    total <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>numbers_copy<span class="token punctuation">)</span>\n    result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n    <span class="token keyword">for</span> value <span class="token keyword">in</span> numbers_copy<span class="token punctuation">:</span>\n        percent <span class="token operator">=</span> <span class="token number">100</span> <span class="token operator">*</span> value <span class="token operator">/</span> total\n        result<span class="token punctuation">.</span>append<span class="token punctuation">(</span>percent<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> result</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在的这个函数就可以正确处理 <code class="language-text">read_visits</code> 生成器函数所返回的 it 值了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90592224736259210000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`it = read_visits(\'my_numbers.txt\')\npercentages = normalize_copy(it)\nprint(percentages)\nassert sum(percentages) == 100.0`, `90592224736259210000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">it <span class="token operator">=</span> read_visits<span class="token punctuation">(</span><span class="token string">\'my_numbers.txt\'</span><span class="token punctuation">)</span>\npercentages <span class="token operator">=</span> normalize_copy<span class="token punctuation">(</span>it<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>percentages<span class="token punctuation">)</span>\n<span class="token keyword">assert</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>percentages<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">100.0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个办法虽然能解决问题，但如果输入给它的迭代器所要提供的数据量相当庞大，那么有可能导致程序在复制迭代器时，因耗尽内存而崩溃。所以，把这个方案用在大规模的数据集合上面，会抵消掉 <code class="language-text">read_visits</code> 的好处。编写那样一个函数，就是不想让程序把整套数据全都读取进来，而是可以一条一条地处理。为了应对大规模的数据，其中一个变通方案是让 normalize 函数接受另外一个函数（也就是下面的 <code class="language-text">get_iter</code>），使它每次要使用迭代器时，都去向那个函数索要。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74997304270124320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def normalize_func(get_iter):\n    total = sum(get_iter())  # New iterator\n    result = []\n    for value in get_iter():  # New iterator\n        percent = 100 * value / total\n        result.append(percent)\n    return result`, `74997304270124320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">normalize_func</span><span class="token punctuation">(</span>get_iter<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    total <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>get_iter<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># New iterator</span>\n    result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n    <span class="token keyword">for</span> value <span class="token keyword">in</span> get_iter<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># New iterator</span>\n        percent <span class="token operator">=</span> <span class="token number">100</span> <span class="token operator">*</span> value <span class="token operator">/</span> total\n        result<span class="token punctuation">.</span>append<span class="token punctuation">(</span>percent<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> result</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>使用 <code class="language-text">normalize_func</code> 函数时，需要传入一条 <code class="language-text">lambda</code> 表达式，让这个表达式去调用 <code class="language-text">read_visits</code> 生成器函数。这样 <code class="language-text">normalize_func</code> 每次向 <code class="language-text">get_iter</code> 索要迭代器时，程序都会给出一个新的迭代器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52987251413922530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`path = \'my_numbers.txt\'\npercentages = normalize_func(lambda: read_visits(path))\nprint(percentages)\nassert sum(percentages) == 100.0`, `52987251413922530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">path <span class="token operator">=</span> <span class="token string">\'my_numbers.txt\'</span>\npercentages <span class="token operator">=</span> normalize_func<span class="token punctuation">(</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> read_visits<span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>percentages<span class="token punctuation">)</span>\n<span class="token keyword">assert</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>percentages<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">100.0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样做虽然可行，但传入这么一个 lambda 表达式显得有点儿生硬。要想用更好的办法解决这个问题，可以新建一种容器类，让它实现迭代器协议（iterator protocol）。</p>\n<p>Python 的 for 循环及相关的表达式，正是按照迭代器协议来遍历容器内容的。Python 执行 <code class="language-text">for x in foo</code> 这样的语句时，实际上会调用 iter(foo)，也就是把 foo 传给内置的 iter 函数。这个函数会触发名为 <code class="language-text">foo.__iter__</code> 的特殊方法，该方法必须返回迭代器对象（这个迭代器对象本身要实现 <code class="language-text">__next__</code> 特殊方法）。最后，Python 会用迭代器对象反复调用内置的 next 函数，直到数据耗尽为止（如果抛出 StopIteration 异常，就表示数据已经迭代完了）。</p>\n<p>这个过程听上去比较复杂，但总结起来，其实只需要让你的类在实现 <code class="language-text">__iter__</code> 方法时，按照生成器的方式来写就好。下面定义这样一种可迭代的容器类，用来读取文件中的游客数据。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62185810033416454000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class ReadVisits:\n    def __init__(self, data_path):\n        self.data_path = data_path\n\n    def __iter__(self):\n        with open(self.data_path) as f:\n            for line in f:\n                yield int(line)`, `62185810033416454000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">ReadVisits</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data_path<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>data_path <span class="token operator">=</span> data_path\n\n    <span class="token keyword">def</span> <span class="token function">__iter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_path<span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>\n            <span class="token keyword">for</span> line <span class="token keyword">in</span> f<span class="token punctuation">:</span>\n                <span class="token keyword">yield</span> <span class="token builtin">int</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们只需要把新的容器传给最早的那个 normalize 函数运行即可，函数本身的代码不需要修改。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47486381246068744000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def normalize(numbers):\n    total = sum(numbers)\n    result = []\n    for value in numbers:\n        percent = 100 * value / total\n        result.append(percent)\n    return result\n\n\nclass ReadVisits:\n    def __init__(self, data_path):\n        self.data_path = data_path\n\n    def __iter__(self):\n        with open(self.data_path) as f:\n            for line in f:\n                yield int(line)\n\n\npath = \'my_numbers.txt\'\nvisits = ReadVisits(path)\npercentages = normalize(visits)\nprint(percentages)\nassert sum(percentages) == 100.0`, `47486381246068744000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">normalize</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    total <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n    result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n    <span class="token keyword">for</span> value <span class="token keyword">in</span> numbers<span class="token punctuation">:</span>\n        percent <span class="token operator">=</span> <span class="token number">100</span> <span class="token operator">*</span> value <span class="token operator">/</span> total\n        result<span class="token punctuation">.</span>append<span class="token punctuation">(</span>percent<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> result\n\n\n<span class="token keyword">class</span> <span class="token class-name">ReadVisits</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data_path<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>data_path <span class="token operator">=</span> data_path\n\n    <span class="token keyword">def</span> <span class="token function">__iter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_path<span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>\n            <span class="token keyword">for</span> line <span class="token keyword">in</span> f<span class="token punctuation">:</span>\n                <span class="token keyword">yield</span> <span class="token builtin">int</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span>\n\n\npath <span class="token operator">=</span> <span class="token string">\'my_numbers.txt\'</span>\nvisits <span class="token operator">=</span> ReadVisits<span class="token punctuation">(</span>path<span class="token punctuation">)</span>\npercentages <span class="token operator">=</span> normalize<span class="token punctuation">(</span>visits<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>percentages<span class="token punctuation">)</span>\n<span class="token keyword">assert</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>percentages<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">100.0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样做为什么可行呢？因为 normalize 函数里面的 sum 会触发 <code class="language-text">ReadVisits.__iter__</code>，让系统分配一个新的迭代器对象给它。接下来，normalize 通过 for 循环计算每项数据占总值的百分比时，又会触发 <code class="language-text">__iter__</code>，于是系统会分配另一个迭代器对象。这些迭代器各自推进，其中一个迭代器把数据耗尽，并不会影响其他迭代器。所以，在每一个迭代器上面遍历，都可以分别看到一套完整的数据。这种方案的唯一缺点，就是多次读取输入数据。</p>\n<p>明白了 ReadVisits 这种容器的工作原理后，我们就可以在编写函数和方法时先确认一下，收到的应该是像 ReadVisits 这样的容器，而不是普通的迭代器。按照协议，如果将普通的迭代器传给内置的 iter 函数，那么函数会把迭代器本身返回给调用者。反之，如果传来的是容器类型，那么 iter 函数就会返回一个新的迭代器对象。我们可以借助这条规律，判断输入值是不是这种容器。如果不是，就抛出 TypeError 异常，因为我们没办法在那样的值上面重复遍历。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2496620434750895600"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def normalize_defensive(numbers):\n    if iter(numbers) is numbers:  # An iterator -- bad!\n        raise TypeError(\'Must supply a container\')\n    total = sum(numbers)\n    result = []\n    for value in numbers:\n        percent = 100 * value / total\n        result.append(percent)\n    return result`, `2496620434750895600`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">normalize_defensive</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> <span class="token builtin">iter</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span> <span class="token keyword">is</span> numbers<span class="token punctuation">:</span>  <span class="token comment"># An iterator -- bad!</span>\n        <span class="token keyword">raise</span> TypeError<span class="token punctuation">(</span><span class="token string">\'Must supply a container\'</span><span class="token punctuation">)</span>\n    total <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n    result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n    <span class="token keyword">for</span> value <span class="token keyword">in</span> numbers<span class="token punctuation">:</span>\n        percent <span class="token operator">=</span> <span class="token number">100</span> <span class="token operator">*</span> value <span class="token operator">/</span> total\n        result<span class="token punctuation">.</span>append<span class="token punctuation">(</span>percent<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> result</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>还有一种写法也可以检测出这样的问题。collections.abc 内置模块里定义了名为 Iterator 的类，它用在 isinstance 函数中，可以判断自己收到的参数是不是这种实例。如果是，就抛出异常（参见第 43 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35981669543151563000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def normalize_defensive(numbers):\n    if isinstance(numbers, Iterator):  # Another way to check\n        raise TypeError(\'Must supply a container\')\n    total = sum(numbers)\n    result = []\n    for value in numbers:\n        percent = 100 * value / total\n        result.append(percent)\n    return result`, `35981669543151563000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">normalize_defensive</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>numbers<span class="token punctuation">,</span> Iterator<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># Another way to check</span>\n        <span class="token keyword">raise</span> TypeError<span class="token punctuation">(</span><span class="token string">\'Must supply a container\'</span><span class="token punctuation">)</span>\n    total <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n    result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n    <span class="token keyword">for</span> value <span class="token keyword">in</span> numbers<span class="token punctuation">:</span>\n        percent <span class="token operator">=</span> <span class="token number">100</span> <span class="token operator">*</span> value <span class="token operator">/</span> total\n        result<span class="token punctuation">.</span>append<span class="token punctuation">(</span>percent<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> result</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种自定义容器的方案，最适合于既不想像 <code class="language-text">normalize_copy</code> 函数一样，把迭代器提供的这套数据全部复制一份，同时又要多次遍历这套数据的情况。该方案不仅支持自定义容器，还支持系统自带的列表类型，因为这些全都属于遵循迭代器协议的可迭代容器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93503217932991170000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`visits = [15, 35, 80]\npercentages = normalize_defensive(visits)\nassert sum(percentages) == 100.0\n\npath = \'my_numbers.txt\'\nvisits = ReadVisits(path)\npercentages = normalize_defensive(visits)\nassert sum(percentages) == 100.0`, `93503217932991170000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">visits <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">]</span>\npercentages <span class="token operator">=</span> normalize_defensive<span class="token punctuation">(</span>visits<span class="token punctuation">)</span>\n<span class="token keyword">assert</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>percentages<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">100.0</span>\n\npath <span class="token operator">=</span> <span class="token string">\'my_numbers.txt\'</span>\nvisits <span class="token operator">=</span> ReadVisits<span class="token punctuation">(</span>path<span class="token punctuation">)</span>\npercentages <span class="token operator">=</span> normalize_defensive<span class="token punctuation">(</span>visits<span class="token punctuation">)</span>\n<span class="token keyword">assert</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>percentages<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">100.0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果输入的是普通迭代器而不是容器，那么 <code class="language-text">normalize_defensive</code> 就会抛出异常。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2495508192584550400"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`visits = [15, 35, 80]\nit = iter(visits)\nnormalize_defensive(it)\n\n>>>\nTraceback ...\nTypeError: Must supply a container`, `2495508192584550400`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">visits <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">]</span>\nit <span class="token operator">=</span> <span class="token builtin">iter</span><span class="token punctuation">(</span>visits<span class="token punctuation">)</span>\nnormalize_defensive<span class="token punctuation">(</span>it<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> Must supply a container</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种思路也适用于异步的迭代器（示例参见第 61 条）。</p>\n<h3 id="总结-27"><a href="#%E6%80%BB%E7%BB%93-27" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>函数和方法如果要把收到的参数遍历很多遍，那就必须特别小心。因为如果这些参数为迭代器，那么程序可能得不到预期的值，从而出现奇怪的效果。</li>\n<li>Python 的迭代器协议确定了容器与迭代器应该怎样跟内置的 iter 及 next 函数、for 循环及相关的表达式交互。</li>\n<li>要想让自定义的容器类型可以迭代，只需要把 <code class="language-text">__iter__</code> 方法实现为生成器即可。</li>\n<li>可以把值传给 iter 函数，检测它返回的是不是那个值本身。如果是，就说明这是个普通的迭代器，而不是一个可以迭代的容器。另外，也可以用内置的 isinstance 函数判断该值是不是 collections.abc.Iterator 类的实例。</li>\n</ol>\n<h2 id="第-32-条：考虑用生成器表达式改写数据量较大的列表推导"><a href="#%E7%AC%AC-32-%E6%9D%A1%EF%BC%9A%E8%80%83%E8%99%91%E7%94%A8%E7%94%9F%E6%88%90%E5%99%A8%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%94%B9%E5%86%99%E6%95%B0%E6%8D%AE%E9%87%8F%E8%BE%83%E5%A4%A7%E7%9A%84%E5%88%97%E8%A1%A8%E6%8E%A8%E5%AF%BC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 32 条：考虑用生成器表达式改写数据量较大的列表推导</h2>\n<p>列表推导可以根据输入序列中的每个元素创建一个包含派生元素的新列表（参见第 27 条）。如果输入的数据量比较小，那么这样做没问题，但如果数据量很大，那么程序就有可能因为内存耗尽而崩溃。</p>\n<p>例如，我们要读取一份文件并返回每行的字符数。假如采用列表推导来实现，那需要把文件中的每行文本都载入内存，并统计长度。对于庞大的文件，或者像 network socket 这样无休止的输入来说，这么写恐怕有问题。下面就是采用列表推导写的代码，它只能处理输入数据量比较少的情况。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24899813815691020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`value = [len(x) for x in open(\'my_file.txt\')]\nprint(value)`, `24899813815691020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">value <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'my_file.txt\'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>要想处理大规模的数据，可以使用生成器表达式（generator expression）来做，它扩展了列表推导式与生成器机制。程序在对生成器表达式求值时，并不会让它把包含输出结果的那个序列立刻构建出来，而是会把它当成一个迭代器，该迭代器每次可以根据表达式中的逻辑给出一项结果。</p>\n<p>生成器表达式的写法，与列表推导式语法类似，但它是写在一对圆括号内，而不是方括号里面。下面这种写法的效果与刚才一样，但是程序并不会立刻给出全部结果，而是先将生成器表达式表示成一个迭代器返回。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79802780736944490000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`it = (len(x) for x in open(\'my_file.txt\'))\nprint(it)\n\n>>>\n<generator object <genexpr> at 0x7f13063e03c0>`, `79802780736944490000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">it <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'my_file.txt\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token operator">&lt;</span>generator <span class="token builtin">object</span> <span class="token operator">&lt;</span>genexpr<span class="token operator">></span> at <span class="token number">0x7f13063e03c0</span><span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>返回的迭代器每次可以推进一步，这时它会根据生成表达式的逻辑计算出下一项输出结果（这项结果可以通过内置的 next 函数取得）。需要多少项结果，就把迭代器推进多少次，这种采用生成器表达式来实现的写法不会消耗太多内存。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20543908024546950000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`print(next(it))\nprint(next(it))`, `20543908024546950000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">next</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">next</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>生成器表达式还有个强大的特性，就是可以组合起来。例如，可以用刚才那条生成器表达式所形成的 it 迭代器作为输入，编写一条新的生成器表达式。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65568437942488830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`it = (len(x) for x in open(\'my_file.txt\'))\nroots = ((x, x ** 0.5) for x in it)\nprint(roots)`, `65568437942488830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">it <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'my_file.txt\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\nroots <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> x <span class="token operator">**</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> it<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>roots<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>这条表达式所形成的 roots 迭代器每次推进时，会引发连锁反应：它也推进内部迭代器 it 以判断当前是否还能在 it 上面继续迭代，如果可以，就把 it 所返回的值代入 <code class="language-text">(x, x ** 0.5)</code> 里面求出结果。这种写法使用的内存同样不会太多。</p>\n<p>多个生成器嵌套而成的代码，执行起来还是相当快的。所以，如果要对数据量很大的输入流做一系列处理，那么生成器表达式应该是个很好的选择。唯一需要注意的是，生成器表达式返回的迭代器是有状态的，跑完一整轮之后，就不能继续使用了（参见第 31 条）。</p>\n<h3 id="总结-28"><a href="#%E6%80%BB%E7%BB%93-28" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>通过列表推导来处理大量的输入数据，可能会占用许多内存。</li>\n<li>改用生成器表达式来做，可以避免内存使用量过大的问题，因为这种表达式所形成的迭代器每次只会计算一项结果。</li>\n<li>生成器表达式所形成的迭代器可以当成 for 语句的子表达式出现在另一个生成器表达式里。</li>\n<li>把生成器表达式组合起来使用，能够写出执行速度快且占用内存少的代码。</li>\n</ol>\n<h2 id="第-33-条：通过-yield-from-把多个生成器连起来用"><a href="#%E7%AC%AC-33-%E6%9D%A1%EF%BC%9A%E9%80%9A%E8%BF%87-yield-from-%E6%8A%8A%E5%A4%9A%E4%B8%AA%E7%94%9F%E6%88%90%E5%99%A8%E8%BF%9E%E8%B5%B7%E6%9D%A5%E7%94%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 33 条：通过 yield from 把多个生成器连起来用</h2>\n<p>生成器有很多好处（参见第 30 条），而且能够解决许多常见的问题（参见第 31 条）。生成器的用途特别广，所以许多程序都会频繁使用它们，而且是一个连着一个地用。</p>\n<p>例如，我们要编写一个图形程序，让它在屏幕上面移动图像，从而形成动画效果。假设要实现这样一段动画：图片先快速移动一段时间，然后暂停，接下来慢速移动一段时间。为了把移动与暂停表示出来，笔者定义了下面两个生成器函数，让它们分别给出图片在当前时间段内应该保持的速度。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74478377560692700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def move(period, speed):\n    for _ in range(period):\n        yield speed\n\n\ndef pause(delay):\n    for _ in range(delay):\n        yield 0`, `74478377560692700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">move</span><span class="token punctuation">(</span>period<span class="token punctuation">,</span> speed<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">yield</span> speed\n\n\n<span class="token keyword">def</span> <span class="token function">pause</span><span class="token punctuation">(</span>delay<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>delay<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">yield</span> <span class="token number">0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>为了把完整的动画制作出来，需要将 move 与 pause 连起来使用，从而算出这张图片当前的位置与上一个位置之差。下面的函数用三个 for 循环来表示动画的三个环节，在每一个环节里，它都通过 yield 把图片当前的位置与上一次的位置之差 delta 返回给调用者。根据 animate 函数返回的 delta 值，即可把整段动画做好。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62562495181523020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def animate():\n    for delta in move(4, 5.0):\n        yield delta\n    for delta in pause(3):\n        yield delta\n    for delta in move(2, 3.0):\n        yield delta`, `62562495181523020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">animate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> delta <span class="token keyword">in</span> move<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5.0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">yield</span> delta\n    <span class="token keyword">for</span> delta <span class="token keyword">in</span> pause<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">yield</span> delta\n    <span class="token keyword">for</span> delta <span class="token keyword">in</span> move<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">yield</span> delta</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>接下来，我们就根据 animate 生成器所给出的 delta 值，把整个动画效果渲染出来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91130423398101650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def render(delta):\n    print(f\'Delta: {delta:.1f}\')\n    # Move the images onscreen\n\n\ndef run(func):\n    for delta in func():\n        render(delta)\n\n\nrun(animate)\n\n>>>\nDelta: 5.0\nDelta: 5.0\nDelta: 5.0\nDelta: 5.0\nDelta: 0.0\nDelta: 0.0\nDelta: 0.0\nDelta: 3.0\nDelta: 3.0`, `91130423398101650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">render</span><span class="token punctuation">(</span>delta<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Delta: </span><span class="token interpolation"><span class="token punctuation">{</span>delta<span class="token punctuation">:</span><span class="token format-spec">.1f</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n    <span class="token comment"># Move the images onscreen</span>\n\n\n<span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> delta <span class="token keyword">in</span> func<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        render<span class="token punctuation">(</span>delta<span class="token punctuation">)</span>\n\n\nrun<span class="token punctuation">(</span>animate<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nDelta<span class="token punctuation">:</span> <span class="token number">5.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">5.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">5.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">5.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">0.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">0.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">0.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">3.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">3.0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种写法的问题在于，animate 函数里有很多重复的地方。比如它反复使用 for 结构来操纵生成器，而且每个 for 结构都使用相同的 yield 表达式，这样看上去很啰唆。这个例子仅仅连用了三个生成器，就让代码变得如此烦琐，若是动画里面有十几或几十个环节，那么代码读起来会更加困难。</p>\n<p>为了解决这个问题，我们可以改用 yield from 形式的表达式来实现。这种形式，会先从嵌套进去的小生成器里面取值，如果该生成器已经用完，那么程序的控制流程就会回到 yield from 所在的这个函数之中，然后它有可能进入下一套 yield from 逻辑。下面这段代码，用 yield from 语句重新实现了 animate 函数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3105303905302037000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def animate_composed():\n    yield from move(4, 5.0)\n    yield from pause(3)\n    yield from move(2, 3.0)\n\nrun(animate_composed)\n\n>>>\nDelta: 5.0\nDelta: 5.0\nDelta: 5.0\nDelta: 5.0\nDelta: 0.0\nDelta: 0.0\nDelta: 0.0\nDelta: 3.0\nDelta: 3.0`, `3105303905302037000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">animate_composed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">yield</span> <span class="token keyword">from</span> move<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5.0</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token keyword">from</span> pause<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token keyword">from</span> move<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token punctuation">)</span>\n\nrun<span class="token punctuation">(</span>animate_composed<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nDelta<span class="token punctuation">:</span> <span class="token number">5.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">5.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">5.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">5.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">0.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">0.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">0.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">3.0</span>\nDelta<span class="token punctuation">:</span> <span class="token number">3.0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>它的运行结果与刚才一样，但是代码看上去更清晰、更直观了。Python 解释器看到 yield from 形式的表达式后，会自己想办法实现与带有普通 yield 语句的 for 循环相同的效果，而且这种实现方式要更快。下面采用内置的 timeit 模块编写并运行一个 micro-benchmark 试试。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6441808663030324000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import timeit\n\n\ndef child():\n    for i in range(1_000_000):\n        yield i\n\n\ndef slow():\n    for i in child():\n        yield i\n\n\ndef fast():\n    yield from child()\n\n\nbaseline = timeit.timeit(\n    stmt=\'for _ in slow(): pass\',\n    globals=globals(),\n    number=50)\nprint(f\'Manual nesting {baseline:.2f}s\')\ncomparison = timeit.timeit(\n    stmt=\'for _ in fast(): pass\',\n    globals=globals(),\n    number=50)\nprint(f\'Composed nesting {comparison:2f}s\')\nreduction = -(comparison - baseline)/baseline\nprint(f\'{reduction:.1%} less time\')\n\n>>>\nManual nesting 3.70s\nComposed nesting 3.319963s\n10.2% less time`, `6441808663030324000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> timeit\n\n\n<span class="token keyword">def</span> <span class="token function">child</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>1_000_000<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">yield</span> i\n\n\n<span class="token keyword">def</span> <span class="token function">slow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> i <span class="token keyword">in</span> child<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">yield</span> i\n\n\n<span class="token keyword">def</span> <span class="token function">fast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">yield</span> <span class="token keyword">from</span> child<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n\nbaseline <span class="token operator">=</span> timeit<span class="token punctuation">.</span>timeit<span class="token punctuation">(</span>\n    stmt<span class="token operator">=</span><span class="token string">\'for _ in slow(): pass\'</span><span class="token punctuation">,</span>\n    <span class="token builtin">globals</span><span class="token operator">=</span><span class="token builtin">globals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    number<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Manual nesting </span><span class="token interpolation"><span class="token punctuation">{</span>baseline<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">s\'</span></span><span class="token punctuation">)</span>\ncomparison <span class="token operator">=</span> timeit<span class="token punctuation">.</span>timeit<span class="token punctuation">(</span>\n    stmt<span class="token operator">=</span><span class="token string">\'for _ in fast(): pass\'</span><span class="token punctuation">,</span>\n    <span class="token builtin">globals</span><span class="token operator">=</span><span class="token builtin">globals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    number<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Composed nesting </span><span class="token interpolation"><span class="token punctuation">{</span>comparison<span class="token punctuation">:</span><span class="token format-spec">2f</span><span class="token punctuation">}</span></span><span class="token string">s\'</span></span><span class="token punctuation">)</span>\nreduction <span class="token operator">=</span> <span class="token operator">-</span><span class="token punctuation">(</span>comparison <span class="token operator">-</span> baseline<span class="token punctuation">)</span><span class="token operator">/</span>baseline\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>reduction<span class="token punctuation">:</span><span class="token format-spec">.1%</span><span class="token punctuation">}</span></span><span class="token string"> less time\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nManual nesting <span class="token number">3.</span>70s\nComposed nesting <span class="token number">3.</span>319963s\n<span class="token number">10.2</span><span class="token operator">%</span> less time</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>所以，如果要把多个生成器连起来用，那么笔者强烈建议优先考虑 yield from 表达式。</p>\n<h3 id="总结-29"><a href="#%E6%80%BB%E7%BB%93-29" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>如果要连续使用多个生成器，那么可以通过 yield from 表达式来分别使用这些生成器，这样做能够免去重复的 for 结构。</li>\n<li>yield from 的性能要胜过那种在 for 循环里手工编写 yield 表达式的方案。</li>\n</ol>\n<h2 id="第-34-条：不要用-send-给生成器注入数据"><a href="#%E7%AC%AC-34-%E6%9D%A1%EF%BC%9A%E4%B8%8D%E8%A6%81%E7%94%A8-send-%E7%BB%99%E7%94%9F%E6%88%90%E5%99%A8%E6%B3%A8%E5%85%A5%E6%95%B0%E6%8D%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 34 条：不要用 send 给生成器注入数据</h2>\n<p>yield 表达式让我们能够轻松地写出生成器函数，使得调用者可以每次只获取输出序列中的一项结果（参见第 30 条）。但问题是，这种通道是单向的，也就是说，无法让生成器在其一端接收数据流，同时在另一端给出计算结果。假如能实现双向通信，那么生成器的适用面会更广。</p>\n<p>例如，我们想用软件实现无线电广播，用它来发送信号。为了编写这个程序，我们必须用一个函数来模拟正弦波，让它能够给出一系列按照正弦方式分布的点。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49954908061417890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import math\n\n\ndef wave(amplitude, steps):\n    step_size = 2 * math.pi / steps\n    for step in range(steps):\n        radians = step * step_size\n        fraction = math.sin(radians)\n        output = amplitude * fraction\n        yield output`, `49954908061417890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> math\n\n\n<span class="token keyword">def</span> <span class="token function">wave</span><span class="token punctuation">(</span>amplitude<span class="token punctuation">,</span> steps<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    step_size <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> math<span class="token punctuation">.</span>pi <span class="token operator">/</span> steps\n    <span class="token keyword">for</span> step <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>steps<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        radians <span class="token operator">=</span> step <span class="token operator">*</span> step_size\n        fraction <span class="token operator">=</span> math<span class="token punctuation">.</span>sin<span class="token punctuation">(</span>radians<span class="token punctuation">)</span>\n        output <span class="token operator">=</span> amplitude <span class="token operator">*</span> fraction\n        <span class="token keyword">yield</span> output</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>有了这个 wave 函数，我们可以让它按照某个固定的振幅生成一系列可供传输的值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58907411594546490000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def transmit(output):\n    if output is None:\n        print(f\'Output is None\')\n    else:\n        print(f\'Output: {output:>5.1f}\')\n\n\ndef run(it):\n    for output in it:\n        transmit(output)\n\n\nrun(wave(3.0, 8))\n\n>>>\nOutput:   0.0\nOutput:   2.1\nOutput:   3.0\nOutput:   2.1\nOutput:   0.0\nOutput:  -2.1\nOutput:  -3.0\nOutput:  -2.1`, `58907411594546490000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">transmit</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> output <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Output is None\'</span></span><span class="token punctuation">)</span>\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Output: </span><span class="token interpolation"><span class="token punctuation">{</span>output<span class="token punctuation">:</span><span class="token format-spec">>5.1f</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> output <span class="token keyword">in</span> it<span class="token punctuation">:</span>\n        transmit<span class="token punctuation">(</span>output<span class="token punctuation">)</span>\n\n\nrun<span class="token punctuation">(</span>wave<span class="token punctuation">(</span><span class="token number">3.0</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">2.1</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">3.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">2.1</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">2.1</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">3.0</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">2.1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写可以生成基本的波形，但问题是，该函数在产生这些值的时候，只能按照刚开始给定的振幅来计算，而没办法使振幅在整个生成过程中根据某个因素发生变化（例如在发送调幅广播信号时，我们就需要这么做）。现在，我们要让生成器在计算每个值的时候，都能考虑到振幅的变化，从而实现调幅。</p>\n<p>Python 的生成器支持 send 方法，这可以让生成器变为双向通道。send 方法可以把参数发给生成器，让它成为上一条 yield 表达式的求值结果，并将生成器推进到下一条 yield 表达式，然后把 yield 右边的值返回给 send 方法的调用者。然而在一般情况下，我们还是会通过内置的 next 函数来推进生成器，按照这种写法，上一条 yield 表达式的求值结果总是 None。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14651188392799197000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def my_generator():\n    received = yield 1\n    print(f\'received {received}\')\n\n\nit = iter(my_generator())\noutput = next(it)  # Get first generator output\nprint(f\'output = {output}\')\ntry:\n    next(it)  # Run generator until it exits\nexcept StopIteration:\n    pass\n\n>>>\noutput = 1\nreceived None`, `14651188392799197000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">my_generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    received <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token number">1</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'received </span><span class="token interpolation"><span class="token punctuation">{</span>received<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n\nit <span class="token operator">=</span> <span class="token builtin">iter</span><span class="token punctuation">(</span>my_generator<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\noutput <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span>  <span class="token comment"># Get first generator output</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'output = </span><span class="token interpolation"><span class="token punctuation">{</span>output<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    <span class="token builtin">next</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span>  <span class="token comment"># Run generator until it exits</span>\n<span class="token keyword">except</span> StopIteration<span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\noutput <span class="token operator">=</span> <span class="token number">1</span>\nreceived <span class="token boolean">None</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果不通过 for 循环或内置的 next 函数推进生成器，而是改用 send 方法，那么调用方法时传入的参数就会成为上一条 yield 表达式的值，生成器拿到这个值后，会继续运行到下一条 yield 表达式那里。可是，刚开始推进生成器的时候，它是从头执行的，而不是从某一条 yield 表达式那里继续的，所以，首次调用 send 方法时，只能传 None，要是传入其他值，程序运行时就会抛出异常。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37028940746423180000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def my_generator():\n    received = yield 1\n    print(f\'received {received}\')\n\n\nit = iter(my_generator())\noutput = it.send(None)  # Get first generator output\nprint(f\'output {output}\')\ntry:\n    it.send(\'hello!\')  # Send value into the generator\nexcept StopIteration:\n    pass\n\n>>>\noutput 1\nreceived hello!`, `37028940746423180000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">my_generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    received <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token number">1</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'received </span><span class="token interpolation"><span class="token punctuation">{</span>received<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n\nit <span class="token operator">=</span> <span class="token builtin">iter</span><span class="token punctuation">(</span>my_generator<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\noutput <span class="token operator">=</span> it<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span>  <span class="token comment"># Get first generator output</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'output </span><span class="token interpolation"><span class="token punctuation">{</span>output<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    it<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">\'hello!\'</span><span class="token punctuation">)</span>  <span class="token comment"># Send value into the generator</span>\n<span class="token keyword">except</span> StopIteration<span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\noutput <span class="token number">1</span>\nreceived hello!</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们可以利用这种机制让调用者把振幅发送过来，这样函数就能根据这个输入值调整生成的正弦波幅值了。首先修改 wave 函数的代码，让它把 yield 表达式的求值结果（也就是调用者通过 send 发过来的振幅）保存到 amplitude 变量里，这样就能根据该变量计算出下次应该生成的值。</p>\n<p>然后，要修改 run 函数调用 <code class="language-text">wave_modulating</code> 函数的方式。它现在必须把每次所要使用的振幅发给 <code class="language-text">wave_modulating</code> 生成器。首次必须发送 None，因为此时生成器还没有遇到过 yield 表达式，它不需要知道上一条 yield 表达式的求值结果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94148827729758930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import math\n\n\ndef transmit(output):\n    if output is None:\n        print(f\'Output is None\')\n    else:\n        print(f\'Output: {output:>5.1f}\')\n\n\ndef wave_modulating(steps):\n    step_size = 2 * math.pi / steps\n    amplitude = yield  # Receive initial amplitude\n    for step in range(steps):\n        radians = step * step_size\n        fraction = math.sin(radians)\n        output = amplitude * fraction\n        amplitude = yield output  # Receive next amplitude\n\n\ndef run_modulating(it):\n    amplitudes = [None, 7, 7, 7, 2, 2, 2, 2, 10, 10, 10, 10, 10]\n    for amplitude in amplitudes:\n        output = it.send(amplitude)\n        transmit(output)\n\n\nrun_modulating(wave_modulating(12))\n\n>>>\nOutput is None\nOutput:   0.0\nOutput:   3.5\nOutput:   6.1\nOutput:   2.0\nOutput:   1.7\nOutput:   1.0\nOutput:   0.0\nOutput:  -5.0\nOutput:  -8.7\nOutput: -10.0\nOutput:  -8.7\nOutput:  -5.0`, `94148827729758930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> math\n\n\n<span class="token keyword">def</span> <span class="token function">transmit</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> output <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Output is None\'</span></span><span class="token punctuation">)</span>\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Output: </span><span class="token interpolation"><span class="token punctuation">{</span>output<span class="token punctuation">:</span><span class="token format-spec">>5.1f</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">def</span> <span class="token function">wave_modulating</span><span class="token punctuation">(</span>steps<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    step_size <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> math<span class="token punctuation">.</span>pi <span class="token operator">/</span> steps\n    amplitude <span class="token operator">=</span> <span class="token keyword">yield</span>  <span class="token comment"># Receive initial amplitude</span>\n    <span class="token keyword">for</span> step <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>steps<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        radians <span class="token operator">=</span> step <span class="token operator">*</span> step_size\n        fraction <span class="token operator">=</span> math<span class="token punctuation">.</span>sin<span class="token punctuation">(</span>radians<span class="token punctuation">)</span>\n        output <span class="token operator">=</span> amplitude <span class="token operator">*</span> fraction\n        amplitude <span class="token operator">=</span> <span class="token keyword">yield</span> output  <span class="token comment"># Receive next amplitude</span>\n\n\n<span class="token keyword">def</span> <span class="token function">run_modulating</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    amplitudes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\n    <span class="token keyword">for</span> amplitude <span class="token keyword">in</span> amplitudes<span class="token punctuation">:</span>\n        output <span class="token operator">=</span> it<span class="token punctuation">.</span>send<span class="token punctuation">(</span>amplitude<span class="token punctuation">)</span>\n        transmit<span class="token punctuation">(</span>output<span class="token punctuation">)</span>\n\n\nrun_modulating<span class="token punctuation">(</span>wave_modulating<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nOutput <span class="token keyword">is</span> <span class="token boolean">None</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">3.5</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">6.1</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">2.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">1.7</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">1.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">5.0</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">8.7</span>\nOutput<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">10.0</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">8.7</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">5.0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写没问题，程序可以按照每次输入的值调整输出信号的振幅。首次输出的肯定是 None，因为此时 <code class="language-text">wave_modulating</code> 函数并不知道 amplitude 是多少，它只有在运行第一条 yield 表达式后，才能把调用者通过 send 发来的值保存到这个变量里。</p>\n<p>这种写法有个缺点，就是它很难让初次阅读这段代码的人立刻理解它的意思。把 yield 放在赋值语句的右侧，本身就不太直观，因为我们必须先了解生成器的这项高级特性，才能明白 yield 与 send 是如何相互配合的。</p>\n<p>现在假设程序的需求变得更复杂了。这次要生成的载波不是简单的正弦波，而是由多个信号序列构成的复合波形（complex waveform）。要实现这个需求，可以连用几条 yield from 语句，把多个生成器串接起来（参见第 33 条）。下面先验证一下，这种写法能否处理振幅固定的简单情况。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84910766181013880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def complex_wave():\n    yield from wave(7.0, 3)\n    yield from wave(2.0, 4)\n    yield from wave(10.0, 5)\n\n\nrun(complex_wave())\n\n>>>\nOutput:   0.0\nOutput:   6.1\nOutput:  -6.1\nOutput:   0.0\nOutput:   2.0\nOutput:   0.0\nOutput:  -2.0\nOutput:   0.0\nOutput:   9.5\nOutput:   5.9\nOutput:  -5.9\nOutput:  -9.5`, `84910766181013880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">complex_wave</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">yield</span> <span class="token keyword">from</span> wave<span class="token punctuation">(</span><span class="token number">7.0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token keyword">from</span> wave<span class="token punctuation">(</span><span class="token number">2.0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token keyword">from</span> wave<span class="token punctuation">(</span><span class="token number">10.0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>\n\n\nrun<span class="token punctuation">(</span>complex_wave<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">6.1</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">6.1</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">2.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">2.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">9.5</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">5.9</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">5.9</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">9.5</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，利用 yield from 表达式确实可以处理比较简单的情况。那既然这样，我们再试试看，它能否处理那种采用 send 方法写成的函数。下面就用这种写法，接连多次调用 <code class="language-text">wave_modulating</code> 生成器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83648584391256240000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def complex_wave_modulating():\n    yield from wave_modulating(3)\n    yield from wave_modulating(4)\n    yield from wave_modulating(5)\n\n\nrun_modulating(complex_wave_modulating())\n\n>>>\nOutput is None\nOutput:   0.0\nOutput:   6.1\nOutput:  -6.1\nOutput is None\nOutput:   0.0\nOutput:   2.0\nOutput:   0.0\nOutput: -10.0\nOutput is None\nOutput:   0.0\nOutput:   9.5\nOutput:   5.9`, `83648584391256240000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">complex_wave_modulating</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">yield</span> <span class="token keyword">from</span> wave_modulating<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token keyword">from</span> wave_modulating<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token keyword">from</span> wave_modulating<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>\n\n\nrun_modulating<span class="token punctuation">(</span>complex_wave_modulating<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nOutput <span class="token keyword">is</span> <span class="token boolean">None</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">6.1</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">6.1</span>\nOutput <span class="token keyword">is</span> <span class="token boolean">None</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">2.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">10.0</span>\nOutput <span class="token keyword">is</span> <span class="token boolean">None</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">9.5</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">5.9</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写在大方向上是对的，但问题在于：程序竟然输出了那么多 None！这是为什么呢？因为每条 yield from 表达式其实都在遍历一个嵌套进去的生成器，所以每个嵌套生成器都必须分别执行它们各自的第一条 yield 语句（也就是什么值都不带的那条 yield 语句），只有执行过这条语句之后，这些生成器才能通过 send 方法所传来的值决定这条语句的求值结果，并把这个结果放在 amplitude 变量里以计算下一次应该输出的值。所以，<code class="language-text">complex_wave_modulating</code> 函数处理完前一个嵌套的生成器之后，会进入下一个嵌套的生成器，而这时就必须先把该生成器的第一条 yield 语句运行过去，这就导致后面两个嵌套生成器会各自从 amplitudes 列表里浪费掉一个，并使得每个嵌套生成器所拿到的第一个结果必定是 None，还会让最后那个嵌套生成器少执行两次。</p>\n<p>这意味着，虽然 yield from 语句与 send 方法单独用着都没问题，然而结合使用的效果却不太让人满意。当然也可以在 <code class="language-text">run_modulating</code> 函数里添加一些代码，使得计算波形的步调与 amplitudes 列表提供振幅值的步调相一致，但这只能使程序越写越复杂，因为利用 send 方法写成的 <code class="language-text">wave_modulating</code> 函数本身已经不太直观了，而我们又把这个生成器函数通过 yield from 语句套到了 <code class="language-text">complex_wave_modulating</code> 里面，这理解起来就更加困难了。所以，笔者建议彻底抛开 send 方法，改用更简单的方案来做。</p>\n<p>最简单的一种写法，是把迭代器传给 wave 函数，让 wave 每次用到振幅的时候，通过 Python 内置的 next 函数推进这个迭代器并返回一个输入振幅。于是，这就促使多个生成器之间，产生连环反应（其他类似案例参见第 32 条）。</p>\n<p>这样，我们只需要把同一个迭代器分别传给这几条 yield from 语句里的 <code class="language-text">wave_cascading</code> 就行。迭代器是有状态的（参见第 31 条），所以下一个 <code class="language-text">wave_cascading</code> 会从上一个 <code class="language-text">wave_cascading</code> 使用完的地方，继续往下使用 <code class="language-text">amplitude_it</code> 迭代器。</p>\n<p>要想触发这个组合的生成器，只需要把振幅值放在列表中，并把针对列表制作的迭代器传给 <code class="language-text">complex_wave_cascading</code> 就好。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40209809988589120000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import math\n\n\ndef transmit(output):\n    if output is None:\n        print(f\'Output is None\')\n    else:\n        print(f\'Output: {output:>5.1f}\')\n\n\ndef wave_cascading(amplitude_it, steps):\n    step_size = 2 * math.pi / steps\n    for step in range(steps):\n        radians = step * step_size\n        fraction = math.sin(radians)\n        amplitude = next(amplitude_it)  # Get next input\n        output = amplitude * fraction\n        yield output\n\n\ndef complex_wave_cascading(amplitude_it):\n    yield from wave_cascading(amplitude_it, 3)\n    yield from wave_cascading(amplitude_it, 4)\n    yield from wave_cascading(amplitude_it, 5)\n\n\ndef run_cascading():\n    amplitudes = [7, 7, 7, 2, 2, 2, 2, 10, 10, 10, 10, 10]\n    it = complex_wave_cascading(iter(amplitudes))\n    for amplitude in amplitudes:\n        output = next(it)\n        transmit(output)\n\n\nrun_cascading()\n\n>>>\nOutput:   0.0\nOutput:   6.1\nOutput:  -6.1\nOutput:   0.0\nOutput:   2.0\nOutput:   0.0\nOutput:  -2.0\nOutput:   0.0\nOutput:   9.5\nOutput:   5.9\nOutput:  -5.9\nOutput:  -9.5`, `40209809988589120000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> math\n\n\n<span class="token keyword">def</span> <span class="token function">transmit</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> output <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Output is None\'</span></span><span class="token punctuation">)</span>\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Output: </span><span class="token interpolation"><span class="token punctuation">{</span>output<span class="token punctuation">:</span><span class="token format-spec">>5.1f</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">def</span> <span class="token function">wave_cascading</span><span class="token punctuation">(</span>amplitude_it<span class="token punctuation">,</span> steps<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    step_size <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> math<span class="token punctuation">.</span>pi <span class="token operator">/</span> steps\n    <span class="token keyword">for</span> step <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>steps<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        radians <span class="token operator">=</span> step <span class="token operator">*</span> step_size\n        fraction <span class="token operator">=</span> math<span class="token punctuation">.</span>sin<span class="token punctuation">(</span>radians<span class="token punctuation">)</span>\n        amplitude <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span>amplitude_it<span class="token punctuation">)</span>  <span class="token comment"># Get next input</span>\n        output <span class="token operator">=</span> amplitude <span class="token operator">*</span> fraction\n        <span class="token keyword">yield</span> output\n\n\n<span class="token keyword">def</span> <span class="token function">complex_wave_cascading</span><span class="token punctuation">(</span>amplitude_it<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">yield</span> <span class="token keyword">from</span> wave_cascading<span class="token punctuation">(</span>amplitude_it<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token keyword">from</span> wave_cascading<span class="token punctuation">(</span>amplitude_it<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token keyword">from</span> wave_cascading<span class="token punctuation">(</span>amplitude_it<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">def</span> <span class="token function">run_cascading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    amplitudes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\n    it <span class="token operator">=</span> complex_wave_cascading<span class="token punctuation">(</span><span class="token builtin">iter</span><span class="token punctuation">(</span>amplitudes<span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token keyword">for</span> amplitude <span class="token keyword">in</span> amplitudes<span class="token punctuation">:</span>\n        output <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span>\n        transmit<span class="token punctuation">(</span>output<span class="token punctuation">)</span>\n\n\nrun_cascading<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">6.1</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">6.1</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">2.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">2.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">0.0</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">9.5</span>\nOutput<span class="token punctuation">:</span>   <span class="token number">5.9</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">5.9</span>\nOutput<span class="token punctuation">:</span>  <span class="token operator">-</span><span class="token number">9.5</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种写法最大的优点在于，迭代器可以来自任何地方，而且完全可以是动态的（例如可以用生成器函数来实现迭代器）。此方案只有一个缺陷，就是必须假设负责输入的生成器绝对能保证线程安全，但有时其实保证不了这一点。如果代码要跨越线程边界，那么用 async 函数实现可能更好（参见第 62 条）。</p>\n<h3 id="总结-30"><a href="#%E6%80%BB%E7%BB%93-30" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>send 方法可以把数据注入生成器，让它成为上一条 yield 表达式的求值结果，生成器可以把这个结果赋给变量。</li>\n<li>把 send 方法与 yield from 表达式搭配起来使用，可能导致奇怪的结果，例如会让程序在本该输出有效值的地方输出 None。</li>\n<li>通过迭代器向组合起来的生成器输入数据，要比采用 send 方法的那种方案好，所以尽量避免使用 send 方法。</li>\n</ol>\n<h2 id="第-35-条：不要通过-throw-变换生成器的状态"><a href="#%E7%AC%AC-35-%E6%9D%A1%EF%BC%9A%E4%B8%8D%E8%A6%81%E9%80%9A%E8%BF%87-throw-%E5%8F%98%E6%8D%A2%E7%94%9F%E6%88%90%E5%99%A8%E7%9A%84%E7%8A%B6%E6%80%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 35 条：不要通过 throw 变换生成器的状态</h2>\n<p>除 yield from 表达式（参见第 33 条）与 send 方法（参见第 34 条）外，生成器还有一项高级功能，就是可以把调用者通过 throw 方法传来的 Exception 实例重新抛出。这个 throw 方法用起来很简单：如果调用了这个方法，那么生成器下次推进时，就不会像平常那样，直接走到下一条 yield 表达式那里，而是会把通过 throw 方法传入的异常重新抛出。下面用代码演示这种效果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74302550554031850000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyError(Exception):\n    pass\n\n\ndef my_generator():\n    yield 1\n    yield 2\n    yield 3\n\n\nit = my_generator()\nprint(next(it))  # Yield 1\nprint(next(it))  # Yield 2\nprint(it.throw(MyError(\'test error\')))\n\n>>>\n1\n2\nTraceback ...\n__main__.MyError: test error`, `74302550554031850000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyError</span><span class="token punctuation">(</span>Exception<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">def</span> <span class="token function">my_generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">yield</span> <span class="token number">1</span>\n    <span class="token keyword">yield</span> <span class="token number">2</span>\n    <span class="token keyword">yield</span> <span class="token number">3</span>\n\n\nit <span class="token operator">=</span> my_generator<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">next</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># Yield 1</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">next</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># Yield 2</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span>throw<span class="token punctuation">(</span>MyError<span class="token punctuation">(</span><span class="token string">\'test error\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">1</span>\n<span class="token number">2</span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n__main__<span class="token punctuation">.</span>MyError<span class="token punctuation">:</span> test error</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>生成器函数可以用标准的 try/except 复合语句把 yield 表达式包裹起来，如果函数上次执行到了这条表达式这里，而这次即将继续执行时，又发现外界通过 throw 方法给自己注入了异常，那么这个异常就会被 try 结构捕获下来，如果捕获之后不继续抛异常，那么生成器函数会推进到下一条 yield 表达式（更多异常处理，参见第 65 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1312492490809114000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyError(Exception):\n    pass\n\n\ndef my_generator():\n    yield 1\n    try:\n        yield 2\n    except MyError:\n        print(\'Got MyError!\')\n    else:\n        yield 3\n    yield 4\n\n\nit = my_generator()\nprint(next(it))  # Yield 1\nprint(next(it))  # Yield 2\nprint(it.throw(MyError(\'test error\')))\n\n>>>\n1\n2\nGot MyError!\n4`, `1312492490809114000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyError</span><span class="token punctuation">(</span>Exception<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">def</span> <span class="token function">my_generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">yield</span> <span class="token number">1</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">yield</span> <span class="token number">2</span>\n    <span class="token keyword">except</span> MyError<span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Got MyError!\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        <span class="token keyword">yield</span> <span class="token number">3</span>\n    <span class="token keyword">yield</span> <span class="token number">4</span>\n\n\nit <span class="token operator">=</span> my_generator<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">next</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># Yield 1</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">next</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># Yield 2</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span>throw<span class="token punctuation">(</span>MyError<span class="token punctuation">(</span><span class="token string">\'test error\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">1</span>\n<span class="token number">2</span>\nGot MyError!\n<span class="token number">4</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这项机制会在生成器与调用者之间形成双向通信通道（另一种双向通信通道，参见第 34 条），这在某些情况下是有用的。例如，要编写一个偶尔可以重置的计时器程序。笔者定义下面的 Reset 异常与 timer 生成器方法，让调用者可以在 timer 给出的迭代器上通过 throw 方法注入 Reset 异常，令计时器重置。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23861039347219280000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Reset(Exception):\n    pass\n\n\ndef timer(period):\n    current = period\n    while current:\n        current -= 1\n        try:\n            yield current\n        except Reset:\n            current = period`, `23861039347219280000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Reset</span><span class="token punctuation">(</span>Exception<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">def</span> <span class="token function">timer</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    current <span class="token operator">=</span> period\n    <span class="token keyword">while</span> current<span class="token punctuation">:</span>\n        current <span class="token operator">-=</span> <span class="token number">1</span>\n        <span class="token keyword">try</span><span class="token punctuation">:</span>\n            <span class="token keyword">yield</span> current\n        <span class="token keyword">except</span> Reset<span class="token punctuation">:</span>\n            current <span class="token operator">=</span> period</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>按照这种写法，如果 timer 正准备从 yield 表达式往下推进时，发现有人注入了 Reset 异常，那么它就会把这个异常捕获下来，并进入 except 分支，在这里它会把表示倒计时的 current 变量重新调整成最初的 period 值。</p>\n<p>这个计时器可以与外界某个按秒轮询的输入机制对接起来。为此，笔者定义一个 run 函数以驱动 timer 生成器所给出的那个 it 迭代器，并根据外界的情况做处理，如果外界要求重置，那就通过 it 迭代器的 throw 方法给计时器注入 Reset 变量，如果外界没有这样要求，那就调用 announce 函数打印生成器所给的倒计时值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20359267242147647000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Reset(Exception):\n    pass\n\n\ndef timer(period):\n    current = period\n    while current:\n        current -= 1\n        try:\n            yield current\n        except Reset:\n            current = period\n\n\ndef check_for_reset():\n    # Poll for external event\n    # ...\n    pass\n\n\ndef announce(remaining):\n    print(f\'{remaining} ticks remaining\')\n\n\ndef run():\n    it = timer(4)\n    while True:\n        try:\n            if check_for_reset():\n                current = it.throw(Reset())\n            else:\n                current = next(it)\n        except StopIteration:\n            break\n        else:\n            announce(current)\n\n\nrun()\n\n>>>\n3 ticks remaining\n2 ticks remaining\n1 ticks remaining\n0 ticks remaining`, `20359267242147647000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Reset</span><span class="token punctuation">(</span>Exception<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">def</span> <span class="token function">timer</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    current <span class="token operator">=</span> period\n    <span class="token keyword">while</span> current<span class="token punctuation">:</span>\n        current <span class="token operator">-=</span> <span class="token number">1</span>\n        <span class="token keyword">try</span><span class="token punctuation">:</span>\n            <span class="token keyword">yield</span> current\n        <span class="token keyword">except</span> Reset<span class="token punctuation">:</span>\n            current <span class="token operator">=</span> period\n\n\n<span class="token keyword">def</span> <span class="token function">check_for_reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token comment"># Poll for external event</span>\n    <span class="token comment"># ...</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">def</span> <span class="token function">announce</span><span class="token punctuation">(</span>remaining<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>remaining<span class="token punctuation">}</span></span><span class="token string"> ticks remaining\'</span></span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    it <span class="token operator">=</span> timer<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>\n    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>\n        <span class="token keyword">try</span><span class="token punctuation">:</span>\n            <span class="token keyword">if</span> check_for_reset<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n                current <span class="token operator">=</span> it<span class="token punctuation">.</span>throw<span class="token punctuation">(</span>Reset<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n            <span class="token keyword">else</span><span class="token punctuation">:</span>\n                current <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span>\n        <span class="token keyword">except</span> StopIteration<span class="token punctuation">:</span>\n            <span class="token keyword">break</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            announce<span class="token punctuation">(</span>current<span class="token punctuation">)</span>\n\n\nrun<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">3</span> ticks remaining\n<span class="token number">2</span> ticks remaining\n<span class="token number">1</span> ticks remaining\n<span class="token number">0</span> ticks remaining</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写没错，但是有点儿难懂，因为用了许多层嵌套结构。我们要判断 <code class="language-text">check_for_reset</code> 函数的返回值，以确定是应该通过 it.throw 注入 Reset 异常，还是应该通过 next 推进迭代器。如果是要推进迭代器，那么还得捕获 StopIteration 异常：若是捕获到了这种异常，那说明迭代器已经走到终点，则要执行 break 跳出 while 循环；若没捕获到，则需要调用 announce 函数打印倒计时值。这会让代码变得很乱。</p>\n<p>有个简单的办法，能够改写这段代码，那就是用可迭代的容器对象（参见第 31 条）定义一个有状态的闭包（参见第 38 条）。下面的代码就写了这样一个 Timer 类，并通过它重新实现刚才的 timer 生成器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71224984675835445000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Timer:\n    def __init__(self, period):\n        self.current = period\n        self.period = period\n\n    def reset(self):\n        self.current = self.period\n\n    def __iter__(self):\n        while self.current:\n            self.current -= 1\n            yield self.current`, `71224984675835445000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Timer</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> period<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>current <span class="token operator">=</span> period\n        self<span class="token punctuation">.</span>period <span class="token operator">=</span> period\n\n    <span class="token keyword">def</span> <span class="token function">reset</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>current <span class="token operator">=</span> self<span class="token punctuation">.</span>period\n\n    <span class="token keyword">def</span> <span class="token function">__iter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">while</span> self<span class="token punctuation">.</span>current<span class="token punctuation">:</span>\n            self<span class="token punctuation">.</span>current <span class="token operator">-=</span> <span class="token number">1</span>\n            <span class="token keyword">yield</span> self<span class="token punctuation">.</span>current</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在，run 函数就好写多了，因为它只需要用 for 循环迭代这个 timer 即可。这样写出来的代码，不像刚才那样有那么多层嵌套，所以读起来很容易懂。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82046557192402350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Reset(Exception):\n    pass\n\n\ndef check_for_reset():\n    # Poll for external event\n    # ...\n    pass\n\n\ndef announce(remaining):\n    print(f\'{remaining} ticks remaining\')\n\n\nclass Timer:\n    def __init__(self, period):\n        self.current = period\n        self.period = period\n\n    def reset(self):\n        self.current = self.period\n\n    def __iter__(self):\n        while self.current:\n            self.current -= 1\n            yield self.current\n\n\ndef run():\n    timer = Timer(4)\n    for current in timer:\n        if check_for_reset():\n            timer.reset()\n        announce(current)\n\n\nrun()\n\n>>>\n3 ticks remaining\n2 ticks remaining\n1 ticks remaining\n0 ticks remaining`, `82046557192402350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{29-37}"\n              >\n                <span class="gatsby-code-button-language">py{29-37}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Reset</span><span class="token punctuation">(</span>Exception<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">def</span> <span class="token function">check_for_reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token comment"># Poll for external event</span>\n    <span class="token comment"># ...</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">def</span> <span class="token function">announce</span><span class="token punctuation">(</span>remaining<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>remaining<span class="token punctuation">}</span></span><span class="token string"> ticks remaining\'</span></span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Timer</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> period<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>current <span class="token operator">=</span> period\n        self<span class="token punctuation">.</span>period <span class="token operator">=</span> period\n\n    <span class="token keyword">def</span> <span class="token function">reset</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>current <span class="token operator">=</span> self<span class="token punctuation">.</span>period\n\n    <span class="token keyword">def</span> <span class="token function">__iter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">while</span> self<span class="token punctuation">.</span>current<span class="token punctuation">:</span>\n            self<span class="token punctuation">.</span>current <span class="token operator">-=</span> <span class="token number">1</span>\n            <span class="token keyword">yield</span> self<span class="token punctuation">.</span>current\n\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">    timer <span class="token operator">=</span> Timer<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">for</span> current <span class="token keyword">in</span> timer<span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">if</span> check_for_reset<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">            timer<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">        announce<span class="token punctuation">(</span>current<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">run<span class="token punctuation">(</span><span class="token punctuation">)</span></span>\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">3</span> ticks remaining\n<span class="token number">2</span> ticks remaining\n<span class="token number">1</span> ticks remaining\n<span class="token number">0</span> ticks remaining</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写所输出的结果与前面一样，但是这种实现方案理解起来要容易得多，即便是初次阅读这段代码的人也很容易就能读懂。凡是想用生成器与异常来实现的功能，通常都可以改用异步机制去做（参见第 60 条），那样会更好。如果确实遇到了这里讲到的这种需求，那么应该通过可迭代的类来实现生成器，而不要用 throw 方法注入异常。</p>\n<h3 id="总结-31"><a href="#%E6%80%BB%E7%BB%93-31" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>throw 方法可以把异常发送到生成器刚执行过的那条 yield 表达式那里，让这个异常在生成器下次推进时重新抛出。</li>\n<li>通过 throw 方法注入异常，会让代码变得难懂，因为需要用多层嵌套的模板结构来抛出并捕获这种异常。</li>\n<li>如果确实遇到了这样的特殊情况，那么应该通过类的 <code class="language-text">__iter__</code> 方法实现生成器，并且专门提供一个方法，让调用者通过这个方法来触发这种特殊的状态变换逻辑。</li>\n</ol>\n<h2 id="第-36-条：考虑用-itertools-拼装迭代器与生成器"><a href="#%E7%AC%AC-36-%E6%9D%A1%EF%BC%9A%E8%80%83%E8%99%91%E7%94%A8-itertools-%E6%8B%BC%E8%A3%85%E8%BF%AD%E4%BB%A3%E5%99%A8%E4%B8%8E%E7%94%9F%E6%88%90%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 36 条：考虑用 itertools 拼装迭代器与生成器</h2>\n<p>Python 内置的 itertools 模块里有很多函数，可以用来安排迭代器之间的交互关系（相关的基础知识，参见第 30 条与第 31 条）。</p>\n<p>如果要实现比较难写的迭代逻辑，那么应该先查看 itertools 的文档（在 Python 解释器界面输入 help(itertools)），说不定里面就有你能用到的函数。下面分三大类，列出其中最重要的函数。</p>\n<h3 id="连接多个迭代器"><a href="#%E8%BF%9E%E6%8E%A5%E5%A4%9A%E4%B8%AA%E8%BF%AD%E4%BB%A3%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>连接多个迭代器</h3>\n<p>内置的 itertools 模块有一些函数可以把多个迭代器连成一个使用。</p>\n<h4 id="chain"><a href="#chain" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>chain</h4>\n<p>chain 可以把多个迭代器从头到尾连成一个迭代器。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73689956852953190000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\nit = itertools.chain([1, 2, 3], [4, 5, 6])\nprint(list(it))\n\n>>>\n[1, 2, 3, 4, 5, 6]`, `73689956852953190000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\nit <span class="token operator">=</span> itertools<span class="token punctuation">.</span>chain<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="repeat"><a href="#repeat" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>repeat</h4>\n<p>repeat 可以制作这样一个迭代器，它会不停地输出某个值。调用 repeat 时，也可以通过第二个参数指定迭代器最多能输出几次。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63207158678601720000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\nit = itertools.repeat(\'hello\', 3)\nprint(list(it))\n\n>>>\n[\'hello\', \'hello\', \'hello\']`, `63207158678601720000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\nit <span class="token operator">=</span> itertools<span class="token punctuation">.</span>repeat<span class="token punctuation">(</span><span class="token string">\'hello\'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token string">\'hello\'</span><span class="token punctuation">,</span> <span class="token string">\'hello\'</span><span class="token punctuation">,</span> <span class="token string">\'hello\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="cycle"><a href="#cycle" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>cycle</h4>\n<p>cycle 可以制作这样一个迭代器，它会循环地输出某段内容之中的各项元素。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24910513822401483000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\nit = itertools.cycle([1, 2])\nresult = [next(it) for _ in range(10)]\nprint(result)\n\n>>>\n[1, 2, 1, 2, 1, 2, 1, 2, 1, 2]`, `24910513822401483000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\nit <span class="token operator">=</span> itertools<span class="token punctuation">.</span>cycle<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\nresult <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">next</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="tee"><a href="#tee" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>tee</h4>\n<p>tee 可以让一个迭代器分裂成多个平行的迭代器，具体个数由第二个参数指定。如果这些迭代器推进的速度不一致，那么程序可能要用大量内存做缓冲，以存放进度落后的迭代器将来会用到的元素。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85661432988300570000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\nit1, it2, it3 = itertools.tee([\'first\', \'second\'], 3)\nprint(list(it1))\nprint(list(it2))\nprint(list(it3))\n\n>>>\n[\'first\', \'second\']\n[\'first\', \'second\']\n[\'first\', \'second\']`, `85661432988300570000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\nit1<span class="token punctuation">,</span> it2<span class="token punctuation">,</span> it3 <span class="token operator">=</span> itertools<span class="token punctuation">.</span>tee<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'first\'</span><span class="token punctuation">,</span> <span class="token string">\'second\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>it1<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>it2<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>it3<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token string">\'first\'</span><span class="token punctuation">,</span> <span class="token string">\'second\'</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token string">\'first\'</span><span class="token punctuation">,</span> <span class="token string">\'second\'</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token string">\'first\'</span><span class="token punctuation">,</span> <span class="token string">\'second\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="zip_longest"><a href="#zip_longest" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>zip_longest</h4>\n<p>它与 Python 内置的 zip 函数类似（参见第 8 条），但区别在于，如果源迭代器的长度不同，那么它会用 fillvalue 参数的值来填补提前耗尽的那些迭代器所留下的空缺。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2427332467932319000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\nkeys = [\'one\', \'two\', \'three\']\nvalues = [1, 2]\n\nnormal = list(zip(keys, values))\nprint(\'zip:        \', normal)\n\nit = itertools.zip_longest(keys, values, fillvalue=\'nope\')\nlongest = list(it)\nprint(\'zip_longest:\', longest)\n\n>>>\nzip:         [(\'one\', 1), (\'two\', 2)]\nzip_longest: [(\'one\', 1), (\'two\', 2), (\'three\', \'nope\')]`, `2427332467932319000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\nkeys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'one\'</span><span class="token punctuation">,</span> <span class="token string">\'two\'</span><span class="token punctuation">,</span> <span class="token string">\'three\'</span><span class="token punctuation">]</span>\nvalues <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>\n\nnormal <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span>keys<span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'zip:        \'</span><span class="token punctuation">,</span> normal<span class="token punctuation">)</span>\n\nit <span class="token operator">=</span> itertools<span class="token punctuation">.</span>zip_longest<span class="token punctuation">(</span>keys<span class="token punctuation">,</span> values<span class="token punctuation">,</span> fillvalue<span class="token operator">=</span><span class="token string">\'nope\'</span><span class="token punctuation">)</span>\nlongest <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'zip_longest:\'</span><span class="token punctuation">,</span> longest<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token builtin">zip</span><span class="token punctuation">:</span>         <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'one\'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">\'two\'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\nzip_longest<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'one\'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">\'two\'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">\'three\'</span><span class="token punctuation">,</span> <span class="token string">\'nope\'</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="过滤源迭代器中的元素"><a href="#%E8%BF%87%E6%BB%A4%E6%BA%90%E8%BF%AD%E4%BB%A3%E5%99%A8%E4%B8%AD%E7%9A%84%E5%85%83%E7%B4%A0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>过滤源迭代器中的元素</h3>\n<p>Python 内置的 itertools 模块里有一些函数可以过滤源迭代器中的元素。</p>\n<h4 id="islice"><a href="#islice" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>islice</h4>\n<p>islice 可以在不拷贝数据的前提下，按照下标切割源迭代器。可以只给出切割的终点，也可以同时给出起点与终点，还可以指定步进值。这种切割方式与标准的序列切片及步进机制类似（参见第 11 条与第 12 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83774452126108200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\nvalues = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]\nfirst_five = itertools.islice(values, 5)\nprint(\'First five: \', list(first_five))\nmiddle_odds = itertools.islice(values, 2, 8, 2)\nprint(\'Middle odds:\', list(middle_odds))\n\n>>>\nFirst five:  [1, 2, 3, 4, 5]\nMiddle odds: [3, 5, 7]`, `83774452126108200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\nvalues <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\nfirst_five <span class="token operator">=</span> itertools<span class="token punctuation">.</span>islice<span class="token punctuation">(</span>values<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'First five: \'</span><span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">(</span>first_five<span class="token punctuation">)</span><span class="token punctuation">)</span>\nmiddle_odds <span class="token operator">=</span> itertools<span class="token punctuation">.</span>islice<span class="token punctuation">(</span>values<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Middle odds:\'</span><span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">(</span>middle_odds<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nFirst five<span class="token punctuation">:</span>  <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span>\nMiddle odds<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="takewhile"><a href="#takewhile" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>takewhile</h4>\n<p>takewhile 会一直从源迭代器里获取元素，直到某元素让测试函数返回 False 为止。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64971748901586060000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\nvalues = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]\n\n\ndef less_than_seven(x):\n    return x < 7\n\n\nit = itertools.takewhile(less_than_seven, values)\nprint(list(it))\n\n>>>\n[1, 2, 3, 4, 5, 6]`, `64971748901586060000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\nvalues <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\n\n\n<span class="token keyword">def</span> <span class="token function">less_than_seven</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> x <span class="token operator">&lt;</span> <span class="token number">7</span>\n\n\nit <span class="token operator">=</span> itertools<span class="token punctuation">.</span>takewhile<span class="token punctuation">(</span>less_than_seven<span class="token punctuation">,</span> values<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="dropwhile"><a href="#dropwhile" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>dropwhile</h4>\n<p>与 takewhile 相反，dropwhile 会一直跳过源序列里的元素，直到某元素让测试函数返回 True 为止，然后它会从这个地方开始逐个取值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99645272571427140000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\nvalues = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]\n\n\ndef less_than_seven(x):\n    return x < 7\n\n\nit = itertools.dropwhile(less_than_seven, values)\nprint(list(it))\n\n>>>\n[7, 8, 9, 10]`, `99645272571427140000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\nvalues <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\n\n\n<span class="token keyword">def</span> <span class="token function">less_than_seven</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> x <span class="token operator">&lt;</span> <span class="token number">7</span>\n\n\nit <span class="token operator">=</span> itertools<span class="token punctuation">.</span>dropwhile<span class="token punctuation">(</span>less_than_seven<span class="token punctuation">,</span> values<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="filterfalse"><a href="#filterfalse" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>filterfalse</h4>\n<p>filterfalse 和内置的 filter 函数相反，它会逐个输出源迭代器里使得测试函数返回 False 的那些元素。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68599971094479330000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\nvalues = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]\n\n\ndef evens(x):\n    return x % 2 == 0\n\n\nfilter_result = filter(evens, values)\nprint(\'Filter:      \', list(filter_result))\nfilter_false_result = itertools.filterfalse(evens, values)\nprint(\'Filter false:\', list(filter_false_result))\n\n>>>\nFilter:       [2, 4, 6, 8, 10]\nFilter false: [1, 3, 5, 7, 9]`, `68599971094479330000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\nvalues <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\n\n\n<span class="token keyword">def</span> <span class="token function">evens</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span>\n\n\nfilter_result <span class="token operator">=</span> <span class="token builtin">filter</span><span class="token punctuation">(</span>evens<span class="token punctuation">,</span> values<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Filter:      \'</span><span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">(</span>filter_result<span class="token punctuation">)</span><span class="token punctuation">)</span>\nfilter_false_result <span class="token operator">=</span> itertools<span class="token punctuation">.</span>filterfalse<span class="token punctuation">(</span>evens<span class="token punctuation">,</span> values<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Filter false:\'</span><span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">(</span>filter_false_result<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nFilter<span class="token punctuation">:</span>       <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\nFilter false<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="用源迭代器中的元素合成新元素"><a href="#%E7%94%A8%E6%BA%90%E8%BF%AD%E4%BB%A3%E5%99%A8%E4%B8%AD%E7%9A%84%E5%85%83%E7%B4%A0%E5%90%88%E6%88%90%E6%96%B0%E5%85%83%E7%B4%A0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>用源迭代器中的元素合成新元素</h3>\n<p>Python 内置的 itertools 模块里，有一些函数可以根据源迭代器中的元素合成新的元素。</p>\n<h4 id="accumulate"><a href="#accumulate" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>accumulate</h4>\n<p>accumulate 会从源迭代器里取出一个元素，并把已经累计的结果与这个元素一起传给表示累加逻辑的函数，然后输出那个函数的计算结果，并把结果当成新的累计值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31514559686618358000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\nvalues = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]\nsum_reduce = itertools.accumulate(values)\nprint(\'Sum:   \', list(sum_reduce))\n\n\ndef sum_modulo_20(first, second):\n    output = first + second\n    return output % 20\n\n\nmodulo_reduce = itertools.accumulate(values, sum_modulo_20)\nprint(\'Modulo:\', list(modulo_reduce))\n\n>>>\nSum:    [1, 3, 6, 10, 15, 21, 28, 36, 45, 55]\nModulo: [1, 3, 6, 10, 15, 1, 8, 16, 5, 15]`, `31514559686618358000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\nvalues <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>\nsum_reduce <span class="token operator">=</span> itertools<span class="token punctuation">.</span>accumulate<span class="token punctuation">(</span>values<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Sum:   \'</span><span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">(</span>sum_reduce<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">def</span> <span class="token function">sum_modulo_20</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span> second<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    output <span class="token operator">=</span> first <span class="token operator">+</span> second\n    <span class="token keyword">return</span> output <span class="token operator">%</span> <span class="token number">20</span>\n\n\nmodulo_reduce <span class="token operator">=</span> itertools<span class="token punctuation">.</span>accumulate<span class="token punctuation">(</span>values<span class="token punctuation">,</span> sum_modulo_20<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Modulo:\'</span><span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">(</span>modulo_reduce<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nSum<span class="token punctuation">:</span>    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">45</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">]</span>\nModulo<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这与内置的 functools 模块中 reduce 函数，实际上是一样的，只不过这个函数每次只给出一项累计值。如果调用者没有指定表示累加逻辑的双参数函数（binary function），那么默认的逻辑就是两值相加。</p>\n<h4 id="product"><a href="#product" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>product</h4>\n<p>product 会从一个或多个源迭代器里获取元素，并计算笛卡尔积（Cartesian product），它可以取代那种多层嵌套的列表推导代码（参见第 28 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53487252795187290000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\nsingle = itertools.product([1, 2], repeat=2)\nprint(\'Single:  \', list(single))\n\nmultiple = itertools.product([1, 2], [\'a\', \'b\'])\nprint(\'Multiple:\', list(multiple))\n\n>>>\nSingle:   [(1, 1), (1, 2), (2, 1), (2, 2)]\nMultiple: [(1, \'a\'), (1, \'b\'), (2, \'a\'), (2, \'b\')]`, `53487252795187290000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\nsingle <span class="token operator">=</span> itertools<span class="token punctuation">.</span>product<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> repeat<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Single:  \'</span><span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">(</span>single<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\nmultiple <span class="token operator">=</span> itertools<span class="token punctuation">.</span>product<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Multiple:\'</span><span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">(</span>multiple<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nSingle<span class="token punctuation">:</span>   <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\nMultiple<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'a\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">\'a\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="permutations"><a href="#permutations" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>permutations</h4>\n<p>permutations 会考虑源迭代器所能给出的全部元素，并逐个输出由其中 N 个元素形成的每种有序排列（permutation）方式，元素相同但顺序不同，算作两种排列。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93403598136297440000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\nit = itertools.permutations([1, 2, 3, 4], 2)\nprint(list(it))\n\n>>>\n[(1, 2), (1, 3), (1, 4), (2, 1), (2, 3), (2, 4), (3, 1), (3, 2), (3, 4), (4, 1), (4, 2), (4, 3)]`, `93403598136297440000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\nit <span class="token operator">=</span> itertools<span class="token punctuation">.</span>permutations<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="combinations"><a href="#combinations" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>combinations</h4>\n<p>combinations 会考虑源迭代器所能给出的全部元素，并逐个输出由其中 N 个元素形成的每种无序组合（combination）方式，元素相同但顺序不同，算作同一种组合。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46868786665448600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\nit = itertools.combinations([1, 2, 3, 4], 2)\nprint(list(it))\n\n>>>\n[(1, 2), (1, 3), (1, 4), (2, 3), (2, 4), (3, 4)]`, `46868786665448600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\nit <span class="token operator">=</span> itertools<span class="token punctuation">.</span>combinations<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id="combinations_with_replacement"><a href="#combinations_with_replacement" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code class="language-text">combinations_with_replacement</code></h4>\n<p><code class="language-text">combinations_with_replacement</code> 与 combinations 类似，但它允许同一个元素在组合里多次出现。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61388919929549890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import itertools\n\nit = itertools.combinations_with_replacement([1, 2, 3, 4], 2)\nprint(list(it))\n\n>>>\n[(1, 1), (1, 2), (1, 3), (1, 4), (2, 2), (2, 3), (2, 4), (3, 3), (3, 4), (4, 4)]`, `61388919929549890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> itertools\n\nit <span class="token operator">=</span> itertools<span class="token punctuation">.</span>combinations_with_replacement<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="总结-32"><a href="#%E6%80%BB%E7%BB%93-32" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>itertools 包里面有三套函数可以拼装迭代器与生成器，它们分别能够连接多个迭代器，过滤源迭代器中的元素，以及用源迭代器中的元素合成新元素。</li>\n<li>通过 help(itertools) 查看文档，了解这些函数所支持的其他参数，以及许多更为高级的函数和实用的代码范例。</li>\n</ol>\n<h1 id="类与接口"><a href="#%E7%B1%BB%E4%B8%8E%E6%8E%A5%E5%8F%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>类与接口</h1>\n<h2 id="第-37-条：用组合起来的类来实现多层结构，不要用嵌套的内置类型"><a href="#%E7%AC%AC-37-%E6%9D%A1%EF%BC%9A%E7%94%A8%E7%BB%84%E5%90%88%E8%B5%B7%E6%9D%A5%E7%9A%84%E7%B1%BB%E6%9D%A5%E5%AE%9E%E7%8E%B0%E5%A4%9A%E5%B1%82%E7%BB%93%E6%9E%84%EF%BC%8C%E4%B8%8D%E8%A6%81%E7%94%A8%E5%B5%8C%E5%A5%97%E7%9A%84%E5%86%85%E7%BD%AE%E7%B1%BB%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 37 条：用组合起来的类来实现多层结构，不要用嵌套的内置类型</h2>\n<p>Python 内置的字典类型，很适合维护对象在生命期内的动态内部状态。所谓动态的（dynamic），是指我们无法获知那套状态会用到哪些标识符。例如，如果要用成绩册（Gradebook）记录学生的分数，而我们又没办法提前确定这些学生的名字，那么受到记录的每位学生与各自的分数，对于 Gradebook 对象来说，就属于动态的内部状态。为了实现这个需求，笔者定义下面这样一个类，让它把学生的名字当作键保存到 <code class="language-text">_grades</code> 字典中，因为我们无法提前确定要记录哪些学生，所以不能将每位学生的名字都设置成这个类的一项属性。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38479450862055180000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class SimpleGradebook:\n\n    def __init__(self):\n        self._grades = {}\n\n    def add_student(self, name):\n        self._grades[name] = []\n\n    def report_grade(self, name, score):\n        self._grades[name].append(score)\n\n    def average_grade(self, name):\n        grades = self._grades[name]\n        return sum(grades) / len(grades)\n\n\nbook = SimpleGradebook()\nbook.add_student(\'Isaac Newton\')\nbook.report_grade(\'Isaac Newton\', 90)\nbook.report_grade(\'Isaac Newton\', 95)\nbook.report_grade(\'Isaac Newton\', 85)\n\nprint(book.average_grade(\'Isaac Newton\'))\n\n>>>\n90.0`, `38479450862055180000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">SimpleGradebook</span><span class="token punctuation">:</span>\n\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_grades <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n    <span class="token keyword">def</span> <span class="token function">add_student</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_grades<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n\n    <span class="token keyword">def</span> <span class="token function">report_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> score<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_grades<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>score<span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">average_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        grades <span class="token operator">=</span> self<span class="token punctuation">.</span>_grades<span class="token punctuation">[</span>name<span class="token punctuation">]</span>\n        <span class="token keyword">return</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>grades<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>grades<span class="token punctuation">)</span>\n\n\nbook <span class="token operator">=</span> SimpleGradebook<span class="token punctuation">(</span><span class="token punctuation">)</span>\nbook<span class="token punctuation">.</span>add_student<span class="token punctuation">(</span><span class="token string">\'Isaac Newton\'</span><span class="token punctuation">)</span>\nbook<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token string">\'Isaac Newton\'</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">)</span>\nbook<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token string">\'Isaac Newton\'</span><span class="token punctuation">,</span> <span class="token number">95</span><span class="token punctuation">)</span>\nbook<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token string">\'Isaac Newton\'</span><span class="token punctuation">,</span> <span class="token number">85</span><span class="token punctuation">)</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span>book<span class="token punctuation">.</span>average_grade<span class="token punctuation">(</span><span class="token string">\'Isaac Newton\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">90.0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>字典与相关的内置类型用起来很方便，但同时也容易遭到滥用导致代码出问题。例如，我们现在要扩展这个 SimpleGradebook 类的功能，让它按照科目保存成绩，而不是把所有科目的成绩存在一起。通过修改 <code class="language-text">_grades</code> 字典的用法，使它必须把键（也就是学生的名字）与另一个小字典相对应，而不是像刚才那样，直接与列表对应起来。那份小字典以各科的名称作键与一份列表对应起来，以保存学生在这一科的全部考试成绩。这次笔者用 defaultdict 来实现这个小字典，这样可以方便地处理科目名称还不存在的那些情况（参见第 17 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86162324495565470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from collections import defaultdict\n\n\nclass BySubjectGradebook:\n    def __init__(self):\n        self._grades = {}  # Outer dict\n\n    def add_student(self, name):\n        self._grades[name] = defaultdict(list)  # Inner dict`, `86162324495565470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> collections <span class="token keyword">import</span> defaultdict\n\n\n<span class="token keyword">class</span> <span class="token class-name">BySubjectGradebook</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_grades <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token comment"># Outer dict</span>\n\n    <span class="token keyword">def</span> <span class="token function">add_student</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_grades<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">)</span>  <span class="token comment"># Inner dict</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>程序写到现在，还算比较直观。但是接下来，我们要编写 <code class="language-text">report_grade</code> 方法来记录某位学生在某科目上的一次成绩，并且要写 <code class="language-text">average_grade</code> 方法计算某位学生所有科目的平均成绩。这两个方法写起来就稍微有点复杂了，因为必须处理多层嵌套的字典结构，不过，这似乎还在可以把握的范围内。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65266569774292750000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from collections import defaultdict\n\n\nclass BySubjectGradebook:\n    def __init__(self):\n        self._grades = {}  # Outer dict\n\n    def add_student(self, name):\n        self._grades[name] = defaultdict(list)  # Inner dict\n\n    def report_grade(self, name, subject, grade):\n        by_subject = self._grades[name]\n        grade_list = by_subject[subject]\n        grade_list.append(grade)\n\n    def average_grade(self, name):\n        by_subject = self._grades[name]\n        total, count = 0, 0\n        for grades in by_subject.values():\n            total += sum(grades)\n            count += len(grades)\n        return total / count`, `65266569774292750000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{11-22}"\n              >\n                <span class="gatsby-code-button-language">py{11-22}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> collections <span class="token keyword">import</span> defaultdict\n\n\n<span class="token keyword">class</span> <span class="token class-name">BySubjectGradebook</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_grades <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token comment"># Outer dict</span>\n\n    <span class="token keyword">def</span> <span class="token function">add_student</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_grades<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">)</span>  <span class="token comment"># Inner dict</span>\n\n<span class="gatsby-highlight-code-line">    <span class="token keyword">def</span> <span class="token function">report_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> subject<span class="token punctuation">,</span> grade<span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">        by_subject <span class="token operator">=</span> self<span class="token punctuation">.</span>_grades<span class="token punctuation">[</span>name<span class="token punctuation">]</span></span><span class="gatsby-highlight-code-line">        grade_list <span class="token operator">=</span> by_subject<span class="token punctuation">[</span>subject<span class="token punctuation">]</span></span><span class="gatsby-highlight-code-line">        grade_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>grade<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">    <span class="token keyword">def</span> <span class="token function">average_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">        by_subject <span class="token operator">=</span> self<span class="token punctuation">.</span>_grades<span class="token punctuation">[</span>name<span class="token punctuation">]</span></span><span class="gatsby-highlight-code-line">        total<span class="token punctuation">,</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">for</span> grades <span class="token keyword">in</span> by_subject<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">            total <span class="token operator">+=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>grades<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">            count <span class="token operator">+=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>grades<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">return</span> total <span class="token operator">/</span> count</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>扩展后的类，用起来依然比较容易。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52490900124845250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`book = BySubjectGradebook()\nbook.add_student(\'Albert Einstein\')\nbook.report_grade(\'Albert Einstein\', \'Math\', 75)\nbook.report_grade(\'Albert Einstein\', \'Math\', 65)\nbook.report_grade(\'Albert Einstein\', \'Gym\', 90)\nbook.report_grade(\'Albert Einstein\', \'Gym\', 95)\nprint(book.average_grade(\'Albert Einstein\'))\n\n>>>\n81.25`, `52490900124845250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">book <span class="token operator">=</span> BySubjectGradebook<span class="token punctuation">(</span><span class="token punctuation">)</span>\nbook<span class="token punctuation">.</span>add_student<span class="token punctuation">(</span><span class="token string">\'Albert Einstein\'</span><span class="token punctuation">)</span>\nbook<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token string">\'Albert Einstein\'</span><span class="token punctuation">,</span> <span class="token string">\'Math\'</span><span class="token punctuation">,</span> <span class="token number">75</span><span class="token punctuation">)</span>\nbook<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token string">\'Albert Einstein\'</span><span class="token punctuation">,</span> <span class="token string">\'Math\'</span><span class="token punctuation">,</span> <span class="token number">65</span><span class="token punctuation">)</span>\nbook<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token string">\'Albert Einstein\'</span><span class="token punctuation">,</span> <span class="token string">\'Gym\'</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">)</span>\nbook<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token string">\'Albert Einstein\'</span><span class="token punctuation">,</span> <span class="token string">\'Gym\'</span><span class="token punctuation">,</span> <span class="token number">95</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>book<span class="token punctuation">.</span>average_grade<span class="token punctuation">(</span><span class="token string">\'Albert Einstein\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">81.25</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在假设需求又变了，我们还要记录每次考试在科目里的权重（weight），因为期中考试与期末考试及随堂举行的临时考试（pop quiz）在总成绩里占的比例是不同的。实现这项功能的一种办法是改变里面那个小字典的用法，让它不要把成绩（score）直接添加到与键名（也就科目名称）相对应的那份列表里，而是先用成绩与权重构造元组，然后把（score, weight）形式的元组添加到列表里。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65624156673735740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from collections import defaultdict\n\n\nclass WeightedGradebook:\n    def __init__(self):\n        self._grades = {}\n\n    def add_student(self, name):\n        self._grades[name] = defaultdict(list)\n\n    def report_grade(self, name, subject, score, weight):\n        by_subject = self._grades[name]\n        grade_list = by_subject[subject]\n        grade_list.append((score, weight))`, `65624156673735740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> collections <span class="token keyword">import</span> defaultdict\n\n\n<span class="token keyword">class</span> <span class="token class-name">WeightedGradebook</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_grades <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n    <span class="token keyword">def</span> <span class="token function">add_student</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_grades<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">report_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> subject<span class="token punctuation">,</span> score<span class="token punctuation">,</span> weight<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        by_subject <span class="token operator">=</span> self<span class="token punctuation">.</span>_grades<span class="token punctuation">[</span>name<span class="token punctuation">]</span>\n        grade_list <span class="token operator">=</span> by_subject<span class="token punctuation">[</span>subject<span class="token punctuation">]</span>\n        grade_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>score<span class="token punctuation">,</span> weight<span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><code class="language-text">report_grade</code> 方法改起来似乎挺简单的，只需要把原来的成绩变为带权重的元组保存到列表里面即可。但是 <code class="language-text">average_grade</code> 方法就比较难懂了，因为我们必须在循环里面再嵌套一个循环。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8955858102972591000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from collections import defaultdict\n\n\nclass WeightedGradebook:\n    def __init__(self):\n        self._grades = {}\n\n    def add_student(self, name):\n        self._grades[name] = defaultdict(list)\n\n    def report_grade(self, name, subject, score, weight):\n        by_subject = self._grades[name]\n        grade_list = by_subject[subject]\n        grade_list.append((score, weight))\n\n    def average_grade(self, name):\n        by_subject = self._grades[name]\n        score_sum, score_count = 0, 0\n        for subject, scores in by_subject.items():\n            subject_avg, total_weight = 0, 0\n            for score, weight in scores:\n                subject_avg += score * weight\n                total_weight += weight\n\n            score_sum += subject_avg / total_weight\n            score_count += 1\n        return score_sum / score_count\n\n\nbook = WeightedGradebook()\nbook.add_student(\'Albert Einstein\')\nbook.report_grade(\'Albert Einstein\', \'Math\', 75, 0.05)\nbook.report_grade(\'Albert Einstein\', \'Math\', 65, 0.15)\nbook.report_grade(\'Albert Einstein\', \'Math\', 70, 0.80)\nbook.report_grade(\'Albert Einstein\', \'Gym\', 100, 0.40)\nbook.report_grade(\'Albert Einstein\', \'Gym\', 85, 0.60)\nprint(book.average_grade(\'Albert Einstein\'))\n\n>>>\n80.25`, `8955858102972591000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> collections <span class="token keyword">import</span> defaultdict\n\n\n<span class="token keyword">class</span> <span class="token class-name">WeightedGradebook</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_grades <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n    <span class="token keyword">def</span> <span class="token function">add_student</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_grades<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">report_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> subject<span class="token punctuation">,</span> score<span class="token punctuation">,</span> weight<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        by_subject <span class="token operator">=</span> self<span class="token punctuation">.</span>_grades<span class="token punctuation">[</span>name<span class="token punctuation">]</span>\n        grade_list <span class="token operator">=</span> by_subject<span class="token punctuation">[</span>subject<span class="token punctuation">]</span>\n        grade_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>score<span class="token punctuation">,</span> weight<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">average_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        by_subject <span class="token operator">=</span> self<span class="token punctuation">.</span>_grades<span class="token punctuation">[</span>name<span class="token punctuation">]</span>\n        score_sum<span class="token punctuation">,</span> score_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>\n        <span class="token keyword">for</span> subject<span class="token punctuation">,</span> scores <span class="token keyword">in</span> by_subject<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            subject_avg<span class="token punctuation">,</span> total_weight <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>\n            <span class="token keyword">for</span> score<span class="token punctuation">,</span> weight <span class="token keyword">in</span> scores<span class="token punctuation">:</span>\n                subject_avg <span class="token operator">+=</span> score <span class="token operator">*</span> weight\n                total_weight <span class="token operator">+=</span> weight\n\n            score_sum <span class="token operator">+=</span> subject_avg <span class="token operator">/</span> total_weight\n            score_count <span class="token operator">+=</span> <span class="token number">1</span>\n        <span class="token keyword">return</span> score_sum <span class="token operator">/</span> score_count\n\n\nbook <span class="token operator">=</span> WeightedGradebook<span class="token punctuation">(</span><span class="token punctuation">)</span>\nbook<span class="token punctuation">.</span>add_student<span class="token punctuation">(</span><span class="token string">\'Albert Einstein\'</span><span class="token punctuation">)</span>\nbook<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token string">\'Albert Einstein\'</span><span class="token punctuation">,</span> <span class="token string">\'Math\'</span><span class="token punctuation">,</span> <span class="token number">75</span><span class="token punctuation">,</span> <span class="token number">0.05</span><span class="token punctuation">)</span>\nbook<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token string">\'Albert Einstein\'</span><span class="token punctuation">,</span> <span class="token string">\'Math\'</span><span class="token punctuation">,</span> <span class="token number">65</span><span class="token punctuation">,</span> <span class="token number">0.15</span><span class="token punctuation">)</span>\nbook<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token string">\'Albert Einstein\'</span><span class="token punctuation">,</span> <span class="token string">\'Math\'</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">,</span> <span class="token number">0.80</span><span class="token punctuation">)</span>\nbook<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token string">\'Albert Einstein\'</span><span class="token punctuation">,</span> <span class="token string">\'Gym\'</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">0.40</span><span class="token punctuation">)</span>\nbook<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token string">\'Albert Einstein\'</span><span class="token punctuation">,</span> <span class="token string">\'Gym\'</span><span class="token punctuation">,</span> <span class="token number">85</span><span class="token punctuation">,</span> <span class="token number">0.60</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>book<span class="token punctuation">.</span>average_grade<span class="token punctuation">(</span><span class="token string">\'Albert Einstein\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">80.25</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个类用起来也变得困难了，因为单看代码很难知道 <code class="language-text">report_grade</code> 里面那些数字形式的位置参数表示什么意思。</p>\n<p>如果遇到的是类似这种比较复杂的需求，那么不要再嵌套字典、元组、集合、列表等内置的类型了，而是应该编写一批新类并让这些类形成一套体系。</p>\n<p>拿这个成绩册的例子来说，一开始我们并不知道后来要考虑成绩权重，所以那个时候似乎没有必要专门创建这样一套类体系。后来，当要纳入权重因素时，有人认为，这可以继续通过 Python 内置的字典与元组来实现，因为只不过是要给保存内部状态的那个结构多添加一层而已。所以，才有了刚才那种复杂的写法。其实，在需要分科目统计成绩时，就不应该继续嵌套下去了，那样会让字典里出现小字典，而小字典里又会出现列表。这种超过两层的嵌套结构，其他开发者很难看懂，而且后面维护起来也很麻烦。</p>\n<p>只要发现记录内部状态的代码开始变得复杂起来，就应该及时把这些代码拆分到多个类里。这样可以定义良好的接口，并且能够合理地封装数据。这种写法可以在接口与具体实现之间创建一层抽象。</p>\n<h3 id="把多层嵌套的内置类型重构为类体系"><a href="#%E6%8A%8A%E5%A4%9A%E5%B1%82%E5%B5%8C%E5%A5%97%E7%9A%84%E5%86%85%E7%BD%AE%E7%B1%BB%E5%9E%8B%E9%87%8D%E6%9E%84%E4%B8%BA%E7%B1%BB%E4%BD%93%E7%B3%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>把多层嵌套的内置类型重构为类体系</h3>\n<p>有很多种办法可以实现重构（除了这里讲的这种，第 89 条还讲了另一种）。笔者这里采用的办法是，先从依赖树的最底层做起，也就是考虑怎么记录某科目的单次考试成绩与权重。这么简单的一条信息，似乎没必要专门写一个类来记录。由于分数不需要修改，因此元组已经足够用了。下面以（score, weight）形式的元组来记录单次考试成绩，并把这种元素添加到列表里面。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64138218192193740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`grades = []\ngrades.append((95, 0.45))\ngrades.append((85, 0.55))\ntotal = sum(score * weight for score, weight in grades)\ntotal_weight = sum(weight for _, weight in grades)\naverage_grade = total / total_weight`, `64138218192193740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">grades <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\ngrades<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">95</span><span class="token punctuation">,</span> <span class="token number">0.45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\ngrades<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">85</span><span class="token punctuation">,</span> <span class="token number">0.55</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\ntotal <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>score <span class="token operator">*</span> weight <span class="token keyword">for</span> score<span class="token punctuation">,</span> weight <span class="token keyword">in</span> grades<span class="token punctuation">)</span>\ntotal_weight <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>weight <span class="token keyword">for</span> _<span class="token punctuation">,</span> weight <span class="token keyword">in</span> grades<span class="token punctuation">)</span>\naverage_grade <span class="token operator">=</span> total <span class="token operator">/</span> total_weight</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>汇总每次考试的权重之和（<code class="language-text">total * weight</code>）时，不需要关注具体的成绩，所以在 <code class="language-text">for ... in ...</code> 结构中用下划线（<code class="language-text">*</code>）表示元组中的 score 那一部分，表示计算时忽略它。</p>\n<p>这种写法的问题在于，元组里的元素只能通过位置区分。例如，如果还要把老师的评语记在每次考试的成绩旁边，那么早前使用二元组的那些代码就全都需要修改，因为现在必须采用包含三个元素的元组才行。另外，统计成绩之和与权重之和时，还得分别用一个下划线跳过每个三元组里面表示评语的那一部分。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89411261026618900000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`grades = []\ngrades.append((95, 0.45, \'Great job\'))\ngrades.append((85, 0.55, \'Better next time\'))\ntotal = sum(score * weight for score, weight, _ in grades)\ntotal_weight = sum(weight for _, weight, _ in grades)\naverage_grade = total / total_weight`, `89411261026618900000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">grades <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\ngrades<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">95</span><span class="token punctuation">,</span> <span class="token number">0.45</span><span class="token punctuation">,</span> <span class="token string">\'Great job\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\ngrades<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">85</span><span class="token punctuation">,</span> <span class="token number">0.55</span><span class="token punctuation">,</span> <span class="token string">\'Better next time\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\ntotal <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>score <span class="token operator">*</span> weight <span class="token keyword">for</span> score<span class="token punctuation">,</span> weight<span class="token punctuation">,</span> _ <span class="token keyword">in</span> grades<span class="token punctuation">)</span>\ntotal_weight <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>weight <span class="token keyword">for</span> _<span class="token punctuation">,</span> weight<span class="token punctuation">,</span> _ <span class="token keyword">in</span> grades<span class="token punctuation">)</span>\naverage_grade <span class="token operator">=</span> total <span class="token operator">/</span> total_weight</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>元组拖得太长，就跟字典套得太深一样，都不好维护。所以只要发现元组里的元素超过两个，就应该考虑其他办法了。</p>\n<p>Python 内置的 collections 模块里有个具名元组（namedtuple）类型，恰好可以满足这样的需求，这种类型很容易就能定义出小型的类以表示不可变的数据。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37753219739784180000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from collections import namedtuple\n\nGrade = namedtuple(\'Grade\', (\'score\', \'weight\'))`, `37753219739784180000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> collections <span class="token keyword">import</span> namedtuple\n\nGrade <span class="token operator">=</span> namedtuple<span class="token punctuation">(</span><span class="token string">\'Grade\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">\'score\'</span><span class="token punctuation">,</span> <span class="token string">\'weight\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>这样的类，既可以通过位置参数构造，也可以用关键字参数来创建。每个属性都有名字，因此可以根据属性名称访问字段，如果将来需求发生变化（例如需要修改数据，或是要转变成一个简单的数据容器），也很容易就能把这种 namedtuple 改写成普通的类。</p>\n<h3 id="namedtuple-的局限"><a href="#namedtuple-%E7%9A%84%E5%B1%80%E9%99%90" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>namedtuple 的局限</h3>\n<p>虽然 namedtuple 可以用于许多场合，但我们一定要知道在哪些情况下不适合用它。</p>\n<ol>\n<li>namedtuple 类无法指定默认的参数值。如果数据的可选属性比较多，那么采用这种类来表示，会很不方便。在属性较多的情况下，应该改用内置的 dataclasses 模块实现。</li>\n<li>namedtuple 实例的属性值仍然可以通过数字下标与迭代来访问，所以可能还是会有人（尤其是那些通过你发布的 API 来编程的人）会采用这种方式访问这些属性，这样的话，将来就不太容易把它转成普通的类了。如果无法完全控制这些 namedtuple 实例的用法，那么最好还是明确定义一个新的类。</li>\n</ol>\n<p>有了叫作 Grade 的具名元组，我们就可以写出表示科目的 Subject 类，让它容纳许多个这样的元组。</p>\n<p>然后，就可以写一个表示学生的 Student 类，用它来记录某位学生各科目（Subject）的考试成绩。</p>\n<p>最后，写这样一个表示成绩册的 Gradebook 容器类，把每位学生的名字与表示这位学生的 Student 对象关联起来，如果成绩册里还没有记录过这位学生，那么在调用 <code class="language-text">get_student</code> 方法时，Gradebook 就会构造一个默认的 Student 对象给调用者使用。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73263499217452210000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from collections import namedtuple, defaultdict\n\nGrade = namedtuple(\'Grade\', (\'score\', \'weight\'))\n\n\nclass Subject:\n    def __init__(self):\n        self._grades = []\n\n    def report_grade(self, score, weight):\n        self._grades.append(Grade(score, weight))\n\n    def average_grade(self):\n        total, total_weight = 0, 0\n        for grade in self._grades:\n            total += grade.score * grade.weight\n            total_weight += grade.weight\n        return total / total_weight\n\n\nclass Student:\n    def __init__(self):\n        self._subjects = defaultdict(Subject)\n\n    def get_subject(self, name):\n        return self._subjects[name]\n\n    def average_grade(self):\n        total, count = 0, 0\n        for subject in self._subjects.values():\n            total += subject.average_grade()\n            count += 1\n        return total / count\n\n\nclass Gradebook:\n    def __init__(self):\n        self._students = defaultdict(Student)\n\n    def get_student(self, name):\n        return self._students[name]\n\n\nbook = Gradebook()\nalbert = book.get_student(\'Albert Einstein\')\nmath = albert.get_subject(\'Math\')\nmath.report_grade(75, 0.05)\nmath.report_grade(65, 0.15)\nmath.report_grade(70, 0.80)\ngym = albert.get_subject(\'Gym\')\ngym.report_grade(100, 0.40)\ngym.report_grade(85, 0.60)\nprint(albert.average_grade())\n\n>>>\n80.25`, `73263499217452210000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> collections <span class="token keyword">import</span> namedtuple<span class="token punctuation">,</span> defaultdict\n\nGrade <span class="token operator">=</span> namedtuple<span class="token punctuation">(</span><span class="token string">\'Grade\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">\'score\'</span><span class="token punctuation">,</span> <span class="token string">\'weight\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Subject</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_grades <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n\n    <span class="token keyword">def</span> <span class="token function">report_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> score<span class="token punctuation">,</span> weight<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_grades<span class="token punctuation">.</span>append<span class="token punctuation">(</span>Grade<span class="token punctuation">(</span>score<span class="token punctuation">,</span> weight<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">average_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        total<span class="token punctuation">,</span> total_weight <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>\n        <span class="token keyword">for</span> grade <span class="token keyword">in</span> self<span class="token punctuation">.</span>_grades<span class="token punctuation">:</span>\n            total <span class="token operator">+=</span> grade<span class="token punctuation">.</span>score <span class="token operator">*</span> grade<span class="token punctuation">.</span>weight\n            total_weight <span class="token operator">+=</span> grade<span class="token punctuation">.</span>weight\n        <span class="token keyword">return</span> total <span class="token operator">/</span> total_weight\n\n\n<span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_subjects <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span>Subject<span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">get_subject</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_subjects<span class="token punctuation">[</span>name<span class="token punctuation">]</span>\n\n    <span class="token keyword">def</span> <span class="token function">average_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        total<span class="token punctuation">,</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>\n        <span class="token keyword">for</span> subject <span class="token keyword">in</span> self<span class="token punctuation">.</span>_subjects<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            total <span class="token operator">+=</span> subject<span class="token punctuation">.</span>average_grade<span class="token punctuation">(</span><span class="token punctuation">)</span>\n            count <span class="token operator">+=</span> <span class="token number">1</span>\n        <span class="token keyword">return</span> total <span class="token operator">/</span> count\n\n\n<span class="token keyword">class</span> <span class="token class-name">Gradebook</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_students <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span>Student<span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">get_student</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_students<span class="token punctuation">[</span>name<span class="token punctuation">]</span>\n\n\nbook <span class="token operator">=</span> Gradebook<span class="token punctuation">(</span><span class="token punctuation">)</span>\nalbert <span class="token operator">=</span> book<span class="token punctuation">.</span>get_student<span class="token punctuation">(</span><span class="token string">\'Albert Einstein\'</span><span class="token punctuation">)</span>\nmath <span class="token operator">=</span> albert<span class="token punctuation">.</span>get_subject<span class="token punctuation">(</span><span class="token string">\'Math\'</span><span class="token punctuation">)</span>\nmath<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token number">75</span><span class="token punctuation">,</span> <span class="token number">0.05</span><span class="token punctuation">)</span>\nmath<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token number">65</span><span class="token punctuation">,</span> <span class="token number">0.15</span><span class="token punctuation">)</span>\nmath<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token number">70</span><span class="token punctuation">,</span> <span class="token number">0.80</span><span class="token punctuation">)</span>\ngym <span class="token operator">=</span> albert<span class="token punctuation">.</span>get_subject<span class="token punctuation">(</span><span class="token string">\'Gym\'</span><span class="token punctuation">)</span>\ngym<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">0.40</span><span class="token punctuation">)</span>\ngym<span class="token punctuation">.</span>report_grade<span class="token punctuation">(</span><span class="token number">85</span><span class="token punctuation">,</span> <span class="token number">0.60</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>albert<span class="token punctuation">.</span>average_grade<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token number">80.25</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这些类的代码所占篇幅，虽然比原来那种写法长了一倍，但理解起来却要容易得多。而且用这些类写出来的调用代码，也比原来更清晰、更便于扩展。</p>\n<p>另外，还可以提供一些向后兼容的方法，帮助大家把采用旧式 API 所写的代码迁移到这种通过对象体系所设计的方案之中。</p>\n<h3 id="总结-33"><a href="#%E6%80%BB%E7%BB%93-33" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>不要在字典里嵌套字典、长元组，以及用其他内置类型构造的复杂结构。</li>\n<li>namedtuple 能够实现出轻量级的容器，以存放不可变的数据，而且将来可以灵活地转化成普通的类。</li>\n<li>如果发现用字典来维护内部状态的那些代码已经越写越复杂了，那么就应该考虑改用多个类来实现。</li>\n</ol>\n<h2 id="第-38-条：让简单的接口接受函数，而不是类的实例"><a href="#%E7%AC%AC-38-%E6%9D%A1%EF%BC%9A%E8%AE%A9%E7%AE%80%E5%8D%95%E7%9A%84%E6%8E%A5%E5%8F%A3%E6%8E%A5%E5%8F%97%E5%87%BD%E6%95%B0%EF%BC%8C%E8%80%8C%E4%B8%8D%E6%98%AF%E7%B1%BB%E7%9A%84%E5%AE%9E%E4%BE%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 38 条：让简单的接口接受函数，而不是类的实例</h2>\n<p>Python 有许多内置的 API，都允许我们传入某个函数来定制它的行为。这种函数可以叫作挂钩（hook），API 在执行过程中，会回调（call back）这些挂钩函数。例如，list 类型的 sort 方法就带有可选的 key 参数，如果明确指定了这个参数，那么它就会按照你提供的挂钩函数来决定列表中每个元素的先后顺序（参见第 14 条）。下面的代码把内置的 len 函数当成挂钩传给 key 参数，让 sort 方法根据长度排列这些名字。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26343955729566028000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`names = [\'Socrates\', \'Archimedes\', \'Plato\', \'Aristotle\']\nnames.sort(key=len)\nprint(names)\n\n>>>\n[\'Plato\', \'Socrates\', \'Aristotle\', \'Archimedes\']`, `26343955729566028000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'Socrates\'</span><span class="token punctuation">,</span> <span class="token string">\'Archimedes\'</span><span class="token punctuation">,</span> <span class="token string">\'Plato\'</span><span class="token punctuation">,</span> <span class="token string">\'Aristotle\'</span><span class="token punctuation">]</span>\nnames<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>names<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">[</span><span class="token string">\'Plato\'</span><span class="token punctuation">,</span> <span class="token string">\'Socrates\'</span><span class="token punctuation">,</span> <span class="token string">\'Aristotle\'</span><span class="token punctuation">,</span> <span class="token string">\'Archimedes\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在其他编程语言中，挂钩可能会用抽象类（abstract class）来定义。但在 Python 中，许多挂钩都是无状态的函数（stateless function），带有明确的参数与返回值。挂钩用函数来描述，要比定义成类更简单。用作挂钩的函数与别的函数一样，都是 Python 里的头等（first-class）对象，也就是说，这些函数与方法可以像 Python 中其他值那样传递与引用。</p>\n<p>例如，我们要定制 defaultdict 类的行为（相关的知识，参见第 17 条）。这种 defaultdict 数据结构允许调用者提供一个函数，用来在键名缺失的情况下，创建与这个键相对应的值。只要字典发现调用者想要访问的键不存在，就会触发这个函数，以返回应该与键相关联的默认值。下面定义一个 <code class="language-text">log_missing</code> 函数作为键名缺失时的挂钩，该函数总是会把这种键的默认值设为 0。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22250852864655622000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def log_missing():\n    print(\'Key added\')\n    return 0`, `22250852864655622000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">log_missing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Key added\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">return</span> <span class="token number">0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>下面这段代码通过定制的 defaultdict 字典，把 increments 列表里面描述的增量添加到 current 这个普通字典所提供的初始量上面，但字典里一开始没有 red 和 orange 这两个键，因此 <code class="language-text">log_missing</code> 这个挂钩函数会触发两次，每次它都会打印 Key added 信息。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95208275137175960000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from collections import defaultdict\n\n\ndef log_missing():\n    print(\'Key added\')\n    return 0\n\n\ncurrent = {\'green\': 12, \'blue\': 3}\nincrements = [\n    (\'red\', 5),\n    (\'blue\', 17),\n    (\'orange\', 9),\n]\nresult = defaultdict(log_missing, current)\nprint(\'Before:\', dict(result))\nfor key, amount in increments:\n    result[key] += amount\nprint(\'After:\', dict(result))\n\n>>>\nBefore: {\'green\': 12, \'blue\': 3}\nKey added\nKey added\nAfter: {\'green\': 12, \'blue\': 20, \'red\': 5, \'orange\': 9}`, `95208275137175960000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> collections <span class="token keyword">import</span> defaultdict\n\n\n<span class="token keyword">def</span> <span class="token function">log_missing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Key added\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">return</span> <span class="token number">0</span>\n\n\ncurrent <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">\'green\'</span><span class="token punctuation">:</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token string">\'blue\'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">}</span>\nincrements <span class="token operator">=</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">(</span><span class="token string">\'red\'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">(</span><span class="token string">\'blue\'</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">(</span><span class="token string">\'orange\'</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">]</span>\nresult <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span>log_missing<span class="token punctuation">,</span> current<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Before:\'</span><span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">for</span> key<span class="token punctuation">,</span> amount <span class="token keyword">in</span> increments<span class="token punctuation">:</span>\n    result<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">+=</span> amount\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After:\'</span><span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'green\'</span><span class="token punctuation">:</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token string">\'blue\'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">}</span>\nKey added\nKey added\nAfter<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'green\'</span><span class="token punctuation">:</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token string">\'blue\'</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">\'red\'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">\'orange\'</span><span class="token punctuation">:</span> <span class="token number">9</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>通过 <code class="language-text">log_missing</code> 这样的挂钩函数，我们很容易构建出便于测试的 API，这种 API 可以把挂钩所实现的附加效果（side effect）与数据本身所应具备的确定行为分开。例如，假设我们要在传给 defaultdict 的挂钩里面，统计它总共遇到了多少次键名缺失的情况。要实现这项功能，其中一个办法是采用有状态的闭包（stateful closure，参见第 21 条）。下面就定义一个辅助函数，把 missing 闭包当作挂钩传给 defaultdict 字典，以便为缺失的键提供默认值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84664343577540600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def increment_with_report(current, increments):\n    added_count = 0\n\n    def missing():\n        nonlocal added_count  # Stateful closure\n        added_count += 1\n        return 0\n\n    result = defaultdict(missing, current)\n    for key, amount in increments:\n        result[key] += amount\n\n    return result, added_count`, `84664343577540600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">increment_with_report</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> increments<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    added_count <span class="token operator">=</span> <span class="token number">0</span>\n\n    <span class="token keyword">def</span> <span class="token function">missing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">nonlocal</span> added_count  <span class="token comment"># Stateful closure</span>\n        added_count <span class="token operator">+=</span> <span class="token number">1</span>\n        <span class="token keyword">return</span> <span class="token number">0</span>\n\n    result <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span>missing<span class="token punctuation">,</span> current<span class="token punctuation">)</span>\n    <span class="token keyword">for</span> key<span class="token punctuation">,</span> amount <span class="token keyword">in</span> increments<span class="token punctuation">:</span>\n        result<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">+=</span> amount\n\n    <span class="token keyword">return</span> result<span class="token punctuation">,</span> added_count</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>运行这个辅助函数处理前面的数据，可以得到预期的结果（可以看到，键名缺失的情况确实出现了两次，函数返回的 count 值也为 2）。统计键名缺失次数所用的 <code class="language-text">added_count</code> 状态是由 missing 挂钩维护的，采用挂钩来运作的 defaultdict 字典并不需要关注这个细节。于是，这就体现了把简单函数传给接口的另一个好处，也就是方便稍后添加新的功能，因为我们可以把实现这项功能所用的状态隐藏在这个简单的闭包里面。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88919401412009800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from collections import defaultdict\n\n\ndef increment_with_report(current, increments):\n    added_count = 0\n\n    def missing():\n        nonlocal added_count  # Stateful closure\n        added_count += 1\n        return 0\n\n    result = defaultdict(missing, current)\n    for key, amount in increments:\n        result[key] += amount\n\n    return result, added_count\n\n\ncurrent = {\'green\': 12, \'blue\': 3}\nincrements = [\n    (\'red\', 5),\n    (\'blue\', 17),\n    (\'orange\', 9),\n]\nresult, count = increment_with_report(current, increments)\nassert count == 2`, `88919401412009800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{25-26}"\n              >\n                <span class="gatsby-code-button-language">py{25-26}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> collections <span class="token keyword">import</span> defaultdict\n\n\n<span class="token keyword">def</span> <span class="token function">increment_with_report</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> increments<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    added_count <span class="token operator">=</span> <span class="token number">0</span>\n\n    <span class="token keyword">def</span> <span class="token function">missing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">nonlocal</span> added_count  <span class="token comment"># Stateful closure</span>\n        added_count <span class="token operator">+=</span> <span class="token number">1</span>\n        <span class="token keyword">return</span> <span class="token number">0</span>\n\n    result <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span>missing<span class="token punctuation">,</span> current<span class="token punctuation">)</span>\n    <span class="token keyword">for</span> key<span class="token punctuation">,</span> amount <span class="token keyword">in</span> increments<span class="token punctuation">:</span>\n        result<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">+=</span> amount\n\n    <span class="token keyword">return</span> result<span class="token punctuation">,</span> added_count\n\n\ncurrent <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">\'green\'</span><span class="token punctuation">:</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token string">\'blue\'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">}</span>\nincrements <span class="token operator">=</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">(</span><span class="token string">\'red\'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">(</span><span class="token string">\'blue\'</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">(</span><span class="token string">\'orange\'</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">]</span>\n<span class="gatsby-highlight-code-line">result<span class="token punctuation">,</span> count <span class="token operator">=</span> increment_with_report<span class="token punctuation">(</span>current<span class="token punctuation">,</span> increments<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">assert</span> count <span class="token operator">==</span> <span class="token number">2</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>与无状态的闭包函数相比，用有状态的闭包作为挂钩写出来的代码会难懂一些。为了让代码更清晰，可以专门定义一个小类，把原本由闭包所维护的状态给封装起来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32829705329035174000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class CountMissing:\n    def __init__(self):\n        self.added = 0\n\n    def missing(self):\n        self.added += 1\n        return 0`, `32829705329035174000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">CountMissing</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>added <span class="token operator">=</span> <span class="token number">0</span>\n\n    <span class="token keyword">def</span> <span class="token function">missing</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>added <span class="token operator">+=</span> <span class="token number">1</span>\n        <span class="token keyword">return</span> <span class="token number">0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在其他编程语言中，可能需要修改 defaultdict 以便与 CountMissing 接口相适应。但在 Python 中，方法与函数都是头等的（first-class）对象，因此可以直接通过对象引用它所属的 CountMissing 类里的 missing 方法，并把这个方法传给 defaultdict 充当挂钩，让字典可以用这个挂钩制作默认值。在 Python 中，这种通过对象实例而引用的方法，很容易就能满足函数的接口</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="722361660930137600"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from collections import defaultdict\n\n\nclass CountMissing:\n    def __init__(self):\n        self.added = 0\n\n    def missing(self):\n        self.added += 1\n        return 0\n\n\ncurrent = {\'green\': 12, \'blue\': 3}\nincrements = [\n    (\'red\', 5),\n    (\'blue\', 17),\n    (\'orange\', 9),\n]\ncounter = CountMissing()\nresult = defaultdict(counter.missing, current)  # Method ref\nfor key, amount in increments:\n    result[key] += amount\nassert counter.added == 2`, `722361660930137600`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{19-23}"\n              >\n                <span class="gatsby-code-button-language">py{19-23}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> collections <span class="token keyword">import</span> defaultdict\n\n\n<span class="token keyword">class</span> <span class="token class-name">CountMissing</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>added <span class="token operator">=</span> <span class="token number">0</span>\n\n    <span class="token keyword">def</span> <span class="token function">missing</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>added <span class="token operator">+=</span> <span class="token number">1</span>\n        <span class="token keyword">return</span> <span class="token number">0</span>\n\n\ncurrent <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">\'green\'</span><span class="token punctuation">:</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token string">\'blue\'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">}</span>\nincrements <span class="token operator">=</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">(</span><span class="token string">\'red\'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">(</span><span class="token string">\'blue\'</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">(</span><span class="token string">\'orange\'</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">]</span>\n<span class="gatsby-highlight-code-line">counter <span class="token operator">=</span> CountMissing<span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">result <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span>counter<span class="token punctuation">.</span>missing<span class="token punctuation">,</span> current<span class="token punctuation">)</span>  <span class="token comment"># Method ref</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">for</span> key<span class="token punctuation">,</span> amount <span class="token keyword">in</span> increments<span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">    result<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">+=</span> amount</span><span class="gatsby-highlight-code-line"><span class="token keyword">assert</span> counter<span class="token punctuation">.</span>added <span class="token operator">==</span> <span class="token number">2</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>把有状态的闭包所具备的行为，改用辅助类来实现，要比前面的 <code class="language-text">increment_with_report</code> 函数更清晰。但如果单看这个类，可能没办法立刻了解它的意图。CountMissing 对象应该由谁构造？missing 方法应该由谁调用？这个类将来还会不会再增加 public 方法？这些疑惑都必须在看到 defaultdict 的用法之后才能解开。</p>\n<p>为了让这个类的意义更加明确，可以给它定义名为 <code class="language-text">__call__</code> 的特殊方法。这会让这个类的对象能够像函数那样得到调用。同时，也让内置的 callable 函数能够针对这种实例返回 True 值，用以表示这个实例与普通的函数或方法类似，都是可调用的。凡是能够像这样（在后面加一对括号来）执行的对象，都叫作 callable。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17785567077271503000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class BetterCountMissing:\n    def __init__(self):\n        self.added = 0\n\n    def __call__(self):\n        self.added += 1\n        return 0\n\n\ncounter = BetterCountMissing()\nassert counter() == 0\nassert callable(counter)`, `17785567077271503000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">BetterCountMissing</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>added <span class="token operator">=</span> <span class="token number">0</span>\n\n    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>added <span class="token operator">+=</span> <span class="token number">1</span>\n        <span class="token keyword">return</span> <span class="token number">0</span>\n\n\ncounter <span class="token operator">=</span> BetterCountMissing<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">assert</span> counter<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>\n<span class="token keyword">assert</span> <span class="token builtin">callable</span><span class="token punctuation">(</span>counter<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>下面，就用这样的 BetterCountMissing 实例给 defaultdict 当挂钩，让它在字典里没有键名时，创建默认的键值，并把这种情况记入键名缺失的总次数里。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21763078099544474000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from collections import defaultdict\n\n\nclass BetterCountMissing:\n    def __init__(self):\n        self.added = 0\n\n    def __call__(self):\n        self.added += 1\n        return 0\n\n\ncurrent = {\'green\': 12, \'blue\': 3}\nincrements = [\n    (\'red\', 5),\n    (\'blue\', 17),\n    (\'orange\', 9),\n]\ncounter = BetterCountMissing()\nresult = defaultdict(counter, current)\nfor key, amount in increments:\n    result[key] += amount\nassert counter.added == 2`, `21763078099544474000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{19-23}"\n              >\n                <span class="gatsby-code-button-language">py{19-23}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> collections <span class="token keyword">import</span> defaultdict\n\n\n<span class="token keyword">class</span> <span class="token class-name">BetterCountMissing</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>added <span class="token operator">=</span> <span class="token number">0</span>\n\n    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>added <span class="token operator">+=</span> <span class="token number">1</span>\n        <span class="token keyword">return</span> <span class="token number">0</span>\n\n\ncurrent <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">\'green\'</span><span class="token punctuation">:</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token string">\'blue\'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">}</span>\nincrements <span class="token operator">=</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">(</span><span class="token string">\'red\'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">(</span><span class="token string">\'blue\'</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">(</span><span class="token string">\'orange\'</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">]</span>\n<span class="gatsby-highlight-code-line">counter <span class="token operator">=</span> BetterCountMissing<span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">result <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span>counter<span class="token punctuation">,</span> current<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">for</span> key<span class="token punctuation">,</span> amount <span class="token keyword">in</span> increments<span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">    result<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">+=</span> amount</span><span class="gatsby-highlight-code-line"><span class="token keyword">assert</span> counter<span class="token punctuation">.</span>added <span class="token operator">==</span> <span class="token number">2</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面这段代码要比 CountMissing 更清晰，因为它里面有 <code class="language-text">__call__</code> 方法，这说明这个类的实例可像普通的函数那样使用（例如可以传给 API 当挂钩）。即便是初次看到这段代码，也能明白这个类的主要目标。因为你应该会注意到那个比较显眼的 <code class="language-text">__call__</code> 方法。它强烈暗示着这个类可以像有状态的闭包那样使用。</p>\n<p>总之，最大的优势在于，defaultdict 仍然不需要关注 <code class="language-text">__call__</code> 方法触发之后究竟会做什么。它只知道自己可以用这样一个挂钩，来给缺失的键制作默认值。Python 很容易就能设计这种把挂钩函数当参数来用的接口，面对这种接口，调用者可以采用最适合自己的，把符合接口要求的东西传进去。</p>\n<h3 id="总结-34"><a href="#%E6%80%BB%E7%BB%93-34" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>如果想设计简单的 Python 接口，让组件之间能够通过接口交互，那么可以考虑让接口接受挂钩函数，而不一定非得定义新类，并要求使用者传入这种类的实例。</li>\n<li>Python 的函数与方法都是头等对象，这意味着它们可以像其他类型那样，用在表达式里。</li>\n<li>某个类如果定义了 <code class="language-text">__call__</code> 特殊方法，那么它的实例就可以像普通的 Python 函数那样调用。</li>\n<li>如果想用函数来维护状态，那么可以考虑定义一个带有 <code class="language-text">__call__</code> 方法的新类，而不要用有状态的闭包去实现。</li>\n</ol>\n<h2 id="第-39-条：通过-classmethod-多态来构造同一体系中的各类对象"><a href="#%E7%AC%AC-39-%E6%9D%A1%EF%BC%9A%E9%80%9A%E8%BF%87-classmethod-%E5%A4%9A%E6%80%81%E6%9D%A5%E6%9E%84%E9%80%A0%E5%90%8C%E4%B8%80%E4%BD%93%E7%B3%BB%E4%B8%AD%E7%9A%84%E5%90%84%E7%B1%BB%E5%AF%B9%E8%B1%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 39 条：通过 @classmethod 多态来构造同一体系中的各类对象</h2>\n<p>在 Python 中，不仅对象支持多态，类也支持多态。类的多态是什么意思，这样做有什么好处？</p>\n<p>多态机制使同一体系中的多个类可以按照各自独有的方式来实现同一个方法，这意味着这些类都可以满足同一套接口，或者都可以当作某个抽象类来使用，同时，它们又能在这个前提下，实现各自的功能（参见第 43 条）。</p>\n<p>例如，要实现一套 MapReduce（映射-归纳/映射-化简）流程，并且以一个通用的类来表示输入数据。于是，笔者就定义了这样一个 InputData 类，并把 read 方法留给子类去实现。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67195005947687320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class InputData:\n    def read(self):\n        raise NotImplementedError`, `67195005947687320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">InputData</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">read</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> NotImplementedError</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>然后，编写一个具体的 InputData 子类，例如，可以从磁盘文件中读取数据的 PathInputData 类。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51681289859543680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class PathInputData(InputData):\n    def __init__(self, path):\n        super().__init__()\n        self.path = path\n\n    def read(self):\n        with open(self.path) as f:\n            return f.read()`, `51681289859543680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">PathInputData</span><span class="token punctuation">(</span>InputData<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>path <span class="token operator">=</span> path\n\n    <span class="token keyword">def</span> <span class="token function">read</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>\n            <span class="token keyword">return</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>通用的 InputData 类以后可能会有很多个像 PathInputData 这样的子类，每个子类都会实现标准的 read 接口，并按照各自的方式把需要处理的数据读取进来。例如，有的 InputData 子类可从网上读取数据，有的 InputData 可读取压缩格式的数据并将其解压成普通数据，等等。</p>\n<p>除了输入数据要通用，我们还想让处理 MapReduce 任务的工作节点（Worker）也能有一套通用的抽象接口，这样不同的 Worker 就可以通过这套标准的接口来消耗输入数据。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30340641415946346000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Worker:\n    def __init__(self, input_data):\n        self.input_data = input_data\n        self.result = None\n\n    def map(self):\n        raise NotImplementedError\n\n    def reduce(self, other):\n        raise NotImplementedError`, `30340641415946346000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Worker</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> input_data<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>input_data <span class="token operator">=</span> input_data\n        self<span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token boolean">None</span>\n\n    <span class="token keyword">def</span> <span class="token function">map</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> NotImplementedError\n\n    <span class="token keyword">def</span> <span class="token function">reduce</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> other<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> NotImplementedError</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>下面，我们定义一种具体的 Worker 子类，使它按照特定的方式实现 MapReduce。也就是统计每份数据里的换行符个数，然后把所有的统计值汇总起来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49626180663906025000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class LineCountWorker(Worker):\n    def map(self):\n        data = self.input_data.read()\n        self.result = data.count(\'\\n\')\n\n    def reduce(self, other):\n        self.result += other.result`, `49626180663906025000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">LineCountWorker</span><span class="token punctuation">(</span>Worker<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">map</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        data <span class="token operator">=</span> self<span class="token punctuation">.</span>input_data<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>result <span class="token operator">=</span> data<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">\'\\n\'</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">reduce</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> other<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>result <span class="token operator">+=</span> other<span class="token punctuation">.</span>result</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样实现似乎不错，但接下来会碰到一个大难题，也就是如何把这些组件拼接起来。输入数据与工作节点都有各自的类体系，而且这两套体系也抽象出了合理的接口，然而，它们都必须落实到具体的对象上面，只有构造出了具体对象，才能写出有用的程序。问题是，这些对象由谁来构造？构造出来之后，怎么编排 MapReduce 流程？</p>\n<p>最简单的办法，是编写几个辅助函数，手动构建这些对象并把它们连接起来。例如，可以采用下面的辅助函数读取目录中的内容，并给目录下每份文件构造一个 PathInputData 实例。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54004068898990120000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import os\n\n\ndef generate_inputs(data_dir):\n    for name in os.listdir(data_dir):\n        yield PathInputData(os.path.join(data_dir, name))`, `54004068898990120000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> os\n\n\n<span class="token keyword">def</span> <span class="token function">generate_inputs</span><span class="token punctuation">(</span>data_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> name <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>data_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">yield</span> PathInputData<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>data_dir<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>接下来，再编写一个辅助函数，针对 <code class="language-text">generate_inputs</code> 返回的每个 InputData 实例分别创建相应的 LineCountWorker 对象。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1070403576629064300"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def create_workers(input_list):\n    workers = []\n    for input_data in input_list:\n        workers.append(LineCountWorker(input_data))\n    return workers`, `1070403576629064300`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">create_workers</span><span class="token punctuation">(</span>input_list<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    workers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n    <span class="token keyword">for</span> input_data <span class="token keyword">in</span> input_list<span class="token punctuation">:</span>\n        workers<span class="token punctuation">.</span>append<span class="token punctuation">(</span>LineCountWorker<span class="token punctuation">(</span>input_data<span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token keyword">return</span> workers</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后，将这些 Worker 实例的映射（map）工作分发到多个线程中去执行（参见第 53 条）。反复调用 reduce，把这些 Worker 计算出的结果合并成一个值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80742033114596110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from threading import Thread\n\n\ndef execute(workers):\n    threads = [Thread(target=w.map) for w in workers]\n    for thread in threads:\n        thread.start()\n    for thread in threads:\n        thread.join()\n\n    first, *rest = workers\n    for worker in rest:\n        first.reduce(worker)\n    return first.result`, `80742033114596110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread\n\n\n<span class="token keyword">def</span> <span class="token function">execute</span><span class="token punctuation">(</span>workers<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    threads <span class="token operator">=</span> <span class="token punctuation">[</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>w<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">)</span> <span class="token keyword">for</span> w <span class="token keyword">in</span> workers<span class="token punctuation">]</span>\n    <span class="token keyword">for</span> thread <span class="token keyword">in</span> threads<span class="token punctuation">:</span>\n        thread<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">for</span> thread <span class="token keyword">in</span> threads<span class="token punctuation">:</span>\n        thread<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n    first<span class="token punctuation">,</span> <span class="token operator">*</span>rest <span class="token operator">=</span> workers\n    <span class="token keyword">for</span> worker <span class="token keyword">in</span> rest<span class="token punctuation">:</span>\n        first<span class="token punctuation">.</span><span class="token builtin">reduce</span><span class="token punctuation">(</span>worker<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> first<span class="token punctuation">.</span>result</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>最后，编写一个函数，将刚才那三个环节串起来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26845485345763630000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def mapreduce(data_dir):\n    inputs = generate_inputs(data_dir)\n    workers = create_workers(inputs)\n    return execute(workers)`, `26845485345763630000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">mapreduce</span><span class="token punctuation">(</span>data_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    inputs <span class="token operator">=</span> generate_inputs<span class="token punctuation">(</span>data_dir<span class="token punctuation">)</span>\n    workers <span class="token operator">=</span> create_workers<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> execute<span class="token punctuation">(</span>workers<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，该函数可以很好地处理随机制造出的这批输入文件。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16177096128565460000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import random\nfrom threading import Thread\nimport os\n\n\nclass InputData:\n    def read(self):\n        raise NotImplementedError\n\n\nclass PathInputData(InputData):\n    def __init__(self, path):\n        super().__init__()\n        self.path = path\n\n    def read(self):\n        with open(self.path) as f:\n            return f.read()\n\n\nclass Worker:\n    def __init__(self, input_data):\n        self.input_data = input_data\n        self.result = None\n\n    def map(self):\n        raise NotImplementedError\n\n    def reduce(self, other):\n        raise NotImplementedError\n\n\nclass LineCountWorker(Worker):\n    def map(self):\n        data = self.input_data.read()\n        self.result = data.count(\'\\n\')\n\n    def reduce(self, other):\n        self.result += other.result\n\n\ndef generate_inputs(data_dir):\n    for name in os.listdir(data_dir):\n        yield PathInputData(os.path.join(data_dir, name))\n\n\ndef create_workers(input_list):\n    workers = []\n    for input_data in input_list:\n        workers.append(LineCountWorker(input_data))\n    return workers\n\n\ndef mapreduce(data_dir):\n    inputs = generate_inputs(data_dir)\n    workers = create_workers(inputs)\n    return execute(workers)\n\n\ndef execute(workers):\n    threads = [Thread(target=w.map) for w in workers]\n    for thread in threads:\n        thread.start()\n    for thread in threads:\n        thread.join()\n\n    first, *rest = workers\n    for worker in rest:\n        first.reduce(worker)\n    return first.result\n\n\ndef write_test_files(tmpdir):\n    os.makedirs(tmpdir)\n    print(\'generate dir is:\', os.path.abspath(tmpdir))\n    for i in range(100):\n        with open(os.path.join(tmpdir, str(i)), \'w\') as f:\n            f.write(\'\\n\' * random.randint(0, 100))\n\n\ntmpdir = \'test_inputs\'\nwrite_test_files(tmpdir)\nresult = mapreduce(tmpdir)\nprint(f\'There are {result} lines\')\n\n>>>\ngenerate dir is: /home/123/Desktop/test_inputs\nThere are 4884 lines`, `16177096128565460000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{73-84}"\n              >\n                <span class="gatsby-code-button-language">py{73-84}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> random\n<span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread\n<span class="token keyword">import</span> os\n\n\n<span class="token keyword">class</span> <span class="token class-name">InputData</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">read</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> NotImplementedError\n\n\n<span class="token keyword">class</span> <span class="token class-name">PathInputData</span><span class="token punctuation">(</span>InputData<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>path <span class="token operator">=</span> path\n\n    <span class="token keyword">def</span> <span class="token function">read</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>\n            <span class="token keyword">return</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Worker</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> input_data<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>input_data <span class="token operator">=</span> input_data\n        self<span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token boolean">None</span>\n\n    <span class="token keyword">def</span> <span class="token function">map</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> NotImplementedError\n\n    <span class="token keyword">def</span> <span class="token function">reduce</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> other<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> NotImplementedError\n\n\n<span class="token keyword">class</span> <span class="token class-name">LineCountWorker</span><span class="token punctuation">(</span>Worker<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">map</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        data <span class="token operator">=</span> self<span class="token punctuation">.</span>input_data<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>result <span class="token operator">=</span> data<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">\'\\n\'</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">reduce</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> other<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>result <span class="token operator">+=</span> other<span class="token punctuation">.</span>result\n\n\n<span class="token keyword">def</span> <span class="token function">generate_inputs</span><span class="token punctuation">(</span>data_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> name <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>data_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">yield</span> PathInputData<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>data_dir<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">def</span> <span class="token function">create_workers</span><span class="token punctuation">(</span>input_list<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    workers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n    <span class="token keyword">for</span> input_data <span class="token keyword">in</span> input_list<span class="token punctuation">:</span>\n        workers<span class="token punctuation">.</span>append<span class="token punctuation">(</span>LineCountWorker<span class="token punctuation">(</span>input_data<span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token keyword">return</span> workers\n\n\n<span class="token keyword">def</span> <span class="token function">mapreduce</span><span class="token punctuation">(</span>data_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    inputs <span class="token operator">=</span> generate_inputs<span class="token punctuation">(</span>data_dir<span class="token punctuation">)</span>\n    workers <span class="token operator">=</span> create_workers<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> execute<span class="token punctuation">(</span>workers<span class="token punctuation">)</span>\n\n\n<span class="token keyword">def</span> <span class="token function">execute</span><span class="token punctuation">(</span>workers<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    threads <span class="token operator">=</span> <span class="token punctuation">[</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>w<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">)</span> <span class="token keyword">for</span> w <span class="token keyword">in</span> workers<span class="token punctuation">]</span>\n    <span class="token keyword">for</span> thread <span class="token keyword">in</span> threads<span class="token punctuation">:</span>\n        thread<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">for</span> thread <span class="token keyword">in</span> threads<span class="token punctuation">:</span>\n        thread<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n    first<span class="token punctuation">,</span> <span class="token operator">*</span>rest <span class="token operator">=</span> workers\n    <span class="token keyword">for</span> worker <span class="token keyword">in</span> rest<span class="token punctuation">:</span>\n        first<span class="token punctuation">.</span><span class="token builtin">reduce</span><span class="token punctuation">(</span>worker<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> first<span class="token punctuation">.</span>result\n\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">def</span> <span class="token function">write_test_files</span><span class="token punctuation">(</span>tmpdir<span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">    os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>tmpdir<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'generate dir is:\'</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>tmpdir<span class="token punctuation">)</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>tmpdir<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'w\'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">\'\\n\'</span> <span class="token operator">*</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">tmpdir <span class="token operator">=</span> <span class="token string">\'test_inputs\'</span></span><span class="gatsby-highlight-code-line">write_test_files<span class="token punctuation">(</span>tmpdir<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">result <span class="token operator">=</span> mapreduce<span class="token punctuation">(</span>tmpdir<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'There are </span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token punctuation">}</span></span><span class="token string"> lines\'</span></span><span class="token punctuation">)</span></span>\n<span class="token operator">>></span><span class="token operator">></span>\ngenerate <span class="token builtin">dir</span> <span class="token keyword">is</span><span class="token punctuation">:</span> <span class="token operator">/</span>home<span class="token operator">/</span><span class="token number">123</span><span class="token operator">/</span>Desktop<span class="token operator">/</span>test_inputs\nThere are <span class="token number">4884</span> lines</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然而这样做有个大问题，就是 mapreduce 函数根本不通用。假如要使用其他的 InputData 或 Worker 子类，那就必须修改 <code class="language-text">generate_inputs</code>、<code class="language-text">create_workers</code> 与 mapreduce 的代码，以匹配新类的用法。</p>\n<p>这个问题的根本原因在于，构造对象的办法不够通用。在其他编程语言中，可以利用构造函数多态（constructor polymorphism）来解决，也就是子类不仅要具备与超类一致的构造函数，而且还必须各自提供一个特殊的构造函数以实现和自身有关的构造逻辑。这样，刚才那些辅助方法在编排 MapReduce 流程时，就可以按照超类的形式统一地构造这些对象，并使其根据所属的子类分别去触发相关的特殊构造函数（类似工厂模式）。但是我们在 Python 里不能这样做，因为 Python 的类只能有一个构造方法（即 <code class="language-text">__init__</code> 方法），没办法要求所有的 InputData 子类都采用同一种写法来定义 <code class="language-text">__init__</code>（因为它们必须用各自不同的数据来完成构造）。</p>\n<p>这个问题，最好是能够通过类方法多态（class method polymorphism）来解决。这种多态与 InputData.read 所体现的实例方法多态（instance method polymorphism）很像，只不过它针对的是类，而不是这些类的对象。</p>\n<p>我们现在运用方法多态来实现 MapReduce 流程所用到的这些类。首先改写 InputData 类，把 <code class="language-text">generate_inputs</code> 方法放到该类里面并声明成通用的 @classmethod，这样它的所有子类都可以通过同一个接口来新建具体的 InputData 实例。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35515754904956465000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class GenericInputData:\n    def read(self):\n        raise NotImplementedError\n\n    @classmethod\n    def generate_inputs(cls, config):\n        raise NotImplementedError`, `35515754904956465000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">GenericInputData</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">read</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> NotImplementedError\n\n    @<span class="token builtin">classmethod</span>\n    <span class="token keyword">def</span> <span class="token function">generate_inputs</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> NotImplementedError</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>新的 <code class="language-text">generate_inputs</code> 方法带有一个叫作 config 的字典参数，调用者可以把一系列配置信息放到字典里中，让具体的 GenericInputData 子类去解读。例如 PathInputData 这个子类就会通过 <code class="language-text">data_dir</code> 键从字典里寻找含有输入文件的那个目录。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6100009302382858000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class PathInputData(GenericInputData):\n    @classmethod\n    def generate_inputs(cls, config):\n        data_dir = config[\'data_dir\']\n        for name in os.listdir(data_dir):\n            yield cls(os.path.join(data_dir, name))`, `6100009302382858000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">PathInputData</span><span class="token punctuation">(</span>GenericInputData<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    @<span class="token builtin">classmethod</span>\n    <span class="token keyword">def</span> <span class="token function">generate_inputs</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        data_dir <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">\'data_dir\'</span><span class="token punctuation">]</span>\n        <span class="token keyword">for</span> name <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>data_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">yield</span> cls<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>data_dir<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后，可以用类似的思路改写前面的 Worker 类。把名叫 <code class="language-text">create_workers</code> 的辅助方法移到这个类里面并且也声明成 @classmethod。新方法的 <code class="language-text">input_class</code> 参数将会是 GenericInputData 的某个子类，我们要通过这个参数触发那个子类的 <code class="language-text">generate_inputs</code> 方法，以创建出 Worker 所需的输入信息。有了输入信息之后，通过 <code class="language-text">cls(input_data)</code> 这个通用的形式来调用构造函数，这样创建的实例，其类型是 cls 所表示的具体 GenericWorker 子类。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40920557676713890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class GenericWorker:\n    def __init__(self, input_data):\n        self.input_data = input_data\n        self.result = None\n\n    def map(self):\n        raise NotImplementedError\n\n    def reduce(self, other):\n        raise NotImplementedError\n\n    @classmethod\n    def create_workers(cls, input_class, config):\n        workers = []\n        for input_data in input_class.generate_inputs(config):\n            workers.append(cls(input_data))\n        return workers`, `40920557676713890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">GenericWorker</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> input_data<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>input_data <span class="token operator">=</span> input_data\n        self<span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token boolean">None</span>\n\n    <span class="token keyword">def</span> <span class="token function">map</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> NotImplementedError\n\n    <span class="token keyword">def</span> <span class="token function">reduce</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> other<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> NotImplementedError\n\n    @<span class="token builtin">classmethod</span>\n    <span class="token keyword">def</span> <span class="token function">create_workers</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> input_class<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        workers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n        <span class="token keyword">for</span> input_data <span class="token keyword">in</span> input_class<span class="token punctuation">.</span>generate_inputs<span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            workers<span class="token punctuation">.</span>append<span class="token punctuation">(</span>cls<span class="token punctuation">(</span>input_data<span class="token punctuation">)</span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> workers</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>请注意，上面的代码创建输入信息时，用的是 <code class="language-text">input_class.generate_inputs</code> 这样的写法，这么写正是为了触发类多态机制，以便将 <code class="language-text">generate_inputs</code> 派发到 <code class="language-text">input_class</code> 所表示的那个实际子类上面。另外还要注意，在构造 GenericWorker 的子类对象时，用的是 <code class="language-text">cls(...)</code> 这样的通用写法，而没有直接调用 <code class="language-text">__init__</code> 方法。</p>\n<p>接下来要修改具体的 Worker 类，这其实很简单，只需要把超类的名称改为 GenericWorker 就好。</p>\n<p>最后，重新编写 mapreduce 函数，让它通过 <code class="language-text">worker_class.create_workers</code> 来创建工作节点，这样它就变得通用了。</p>\n<p>把原来那套实现方案所处理的随机文件，再采用这套新的工作节点来处理，可以产生相同的结果。区别只在于，这次调用 mapreduce 时，必须多传几个参数，因为它现在是个通用的函数，必须把实际的输入数据与实际的工作节点告诉它。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23392013881665384000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import random\nfrom threading import Thread\nimport os\n\n\nclass GenericInputData:\n    def read(self):\n        raise NotImplementedError\n\n    @classmethod\n    def generate_inputs(cls, config):\n        raise NotImplementedError\n\n\nclass PathInputData(GenericInputData):\n    def __init__(self, path):\n        super().__init__()\n        self.path = path\n\n    def read(self):\n        with open(self.path) as f:\n            return f.read()\n\n    @classmethod\n    def generate_inputs(cls, config):\n        data_dir = config[\'data_dir\']\n        for name in os.listdir(data_dir):\n            yield cls(os.path.join(data_dir, name))\n\n\nclass GenericWorker:\n    def __init__(self, input_data):\n        self.input_data = input_data\n        self.result = None\n\n    def map(self):\n        raise NotImplementedError\n\n    def reduce(self, other):\n        raise NotImplementedError\n\n    @classmethod\n    def create_workers(cls, input_class, config):\n        workers = []\n        for input_data in input_class.generate_inputs(config):\n            workers.append(cls(input_data))\n        return workers\n\n\nclass LineCountWorker(GenericWorker):\n    def map(self):\n        data = self.input_data.read()\n        self.result = data.count(\'\\n\')\n\n    def reduce(self, other):\n        self.result += other.result\n\n\ndef mapreduce(worker_class, input_class, config):\n    workers = worker_class.create_workers(input_class, config)\n    return execute(workers)\n\n\ndef execute(workers):\n    threads = [Thread(target=w.map) for w in workers]\n    for thread in threads:\n        thread.start()\n    for thread in threads:\n        thread.join()\n\n    first, *rest = workers\n    for worker in rest:\n        first.reduce(worker)\n    return first.result\n\n\ndef write_test_files(tmpdir):\n    os.makedirs(tmpdir)\n    print(\'generate dir is:\', os.path.abspath(tmpdir))\n    for i in range(100):\n        with open(os.path.join(tmpdir, str(i)), \'w\') as f:\n            f.write(\'\\n\' * random.randint(0, 100))\n\n\ntmpdir = \'test_inputs\'\nwrite_test_files(tmpdir)\nconfig = {\n    \'data_dir\': tmpdir\n}\nresult = mapreduce(LineCountWorker, PathInputData, config)\nprint(f\'There are {result} lines\')\n\n>>>\ngenerate dir is: /home/123/Desktop/test_inputs\nThere are 5373 lines`, `23392013881665384000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{6,10-12,15,24-28,31,42-47,50,59-61,87-90}"\n              >\n                <span class="gatsby-code-button-language">py{6,10-12,15,24-28,31,42-47,50,59-61,87-90}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> random\n<span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread\n<span class="token keyword">import</span> os\n\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">class</span> <span class="token class-name">GenericInputData</span><span class="token punctuation">:</span></span>    <span class="token keyword">def</span> <span class="token function">read</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> NotImplementedError\n\n<span class="gatsby-highlight-code-line">    @<span class="token builtin">classmethod</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">def</span> <span class="token function">generate_inputs</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">raise</span> NotImplementedError</span>\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">class</span> <span class="token class-name">PathInputData</span><span class="token punctuation">(</span>GenericInputData<span class="token punctuation">)</span><span class="token punctuation">:</span></span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>path <span class="token operator">=</span> path\n\n    <span class="token keyword">def</span> <span class="token function">read</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>\n            <span class="token keyword">return</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="gatsby-highlight-code-line">    @<span class="token builtin">classmethod</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">def</span> <span class="token function">generate_inputs</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">        data_dir <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">\'data_dir\'</span><span class="token punctuation">]</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">for</span> name <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>data_dir<span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">            <span class="token keyword">yield</span> cls<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>data_dir<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span></span>\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">class</span> <span class="token class-name">GenericWorker</span><span class="token punctuation">:</span></span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> input_data<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>input_data <span class="token operator">=</span> input_data\n        self<span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token boolean">None</span>\n\n    <span class="token keyword">def</span> <span class="token function">map</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> NotImplementedError\n\n    <span class="token keyword">def</span> <span class="token function">reduce</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> other<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> NotImplementedError\n\n<span class="gatsby-highlight-code-line">    @<span class="token builtin">classmethod</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">def</span> <span class="token function">create_workers</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> input_class<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">        workers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">for</span> input_data <span class="token keyword">in</span> input_class<span class="token punctuation">.</span>generate_inputs<span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">            workers<span class="token punctuation">.</span>append<span class="token punctuation">(</span>cls<span class="token punctuation">(</span>input_data<span class="token punctuation">)</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">return</span> workers</span>\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">class</span> <span class="token class-name">LineCountWorker</span><span class="token punctuation">(</span>GenericWorker<span class="token punctuation">)</span><span class="token punctuation">:</span></span>    <span class="token keyword">def</span> <span class="token function">map</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        data <span class="token operator">=</span> self<span class="token punctuation">.</span>input_data<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>result <span class="token operator">=</span> data<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">\'\\n\'</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">reduce</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> other<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>result <span class="token operator">+=</span> other<span class="token punctuation">.</span>result\n\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">def</span> <span class="token function">mapreduce</span><span class="token punctuation">(</span>worker_class<span class="token punctuation">,</span> input_class<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">    workers <span class="token operator">=</span> worker_class<span class="token punctuation">.</span>create_workers<span class="token punctuation">(</span>input_class<span class="token punctuation">,</span> config<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">return</span> execute<span class="token punctuation">(</span>workers<span class="token punctuation">)</span></span>\n\n<span class="token keyword">def</span> <span class="token function">execute</span><span class="token punctuation">(</span>workers<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    threads <span class="token operator">=</span> <span class="token punctuation">[</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>w<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">)</span> <span class="token keyword">for</span> w <span class="token keyword">in</span> workers<span class="token punctuation">]</span>\n    <span class="token keyword">for</span> thread <span class="token keyword">in</span> threads<span class="token punctuation">:</span>\n        thread<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">for</span> thread <span class="token keyword">in</span> threads<span class="token punctuation">:</span>\n        thread<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n    first<span class="token punctuation">,</span> <span class="token operator">*</span>rest <span class="token operator">=</span> workers\n    <span class="token keyword">for</span> worker <span class="token keyword">in</span> rest<span class="token punctuation">:</span>\n        first<span class="token punctuation">.</span><span class="token builtin">reduce</span><span class="token punctuation">(</span>worker<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> first<span class="token punctuation">.</span>result\n\n\n<span class="token keyword">def</span> <span class="token function">write_test_files</span><span class="token punctuation">(</span>tmpdir<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>tmpdir<span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'generate dir is:\'</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>tmpdir<span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>tmpdir<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'w\'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>\n            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">\'\\n\'</span> <span class="token operator">*</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n\ntmpdir <span class="token operator">=</span> <span class="token string">\'test_inputs\'</span>\nwrite_test_files<span class="token punctuation">(</span>tmpdir<span class="token punctuation">)</span>\n<span class="gatsby-highlight-code-line">config <span class="token operator">=</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token string">\'data_dir\'</span><span class="token punctuation">:</span> tmpdir</span><span class="gatsby-highlight-code-line"><span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">result <span class="token operator">=</span> mapreduce<span class="token punctuation">(</span>LineCountWorker<span class="token punctuation">,</span> PathInputData<span class="token punctuation">,</span> config<span class="token punctuation">)</span></span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'There are </span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token punctuation">}</span></span><span class="token string"> lines\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\ngenerate <span class="token builtin">dir</span> <span class="token keyword">is</span><span class="token punctuation">:</span> <span class="token operator">/</span>home<span class="token operator">/</span><span class="token number">123</span><span class="token operator">/</span>Desktop<span class="token operator">/</span>test_inputs\nThere are <span class="token number">5373</span> lines</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这套方案让我们能够随意编写其他的 GenericInputData 与 GenericWorker 子类，而不用再花时间去调整它们之间的拼接代码（glue code）。</p>\n<h3 id="总结-35"><a href="#%E6%80%BB%E7%BB%93-35" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>Python 只允许每个类有一个构造方法，也就是 <code class="language-text">__init__</code> 方法。</li>\n<li>如果想在超类中用通用的代码构造子类实例，那么可以考虑定义 @classmethod 方法，并在里面用 <code class="language-text">cls(...)</code> 的形式构造具体的子类对象。</li>\n<li>通过类方法多态机制，我们能够以通用的形式构造并拼接具体的子类对象。</li>\n</ol>\n<h2 id="第-40-条：通过-super-初始化超类"><a href="#%E7%AC%AC-40-%E6%9D%A1%EF%BC%9A%E9%80%9A%E8%BF%87-super-%E5%88%9D%E5%A7%8B%E5%8C%96%E8%B6%85%E7%B1%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 40 条：通过 super 初始化超类</h2>\n<p>以前有种简单的写法，能在子类里面执行超类的初始化逻辑，那就是直接在超类名称上调用 <code class="language-text">__init__</code> 方法并把子类实例传进去。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95699111777728580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyBaseClass:\n    def __init__(self, value):\n        self.value = value\n\n\nclass MyChildClass(MyBaseClass):\n    def __init__(self):\n        MyBaseClass.__init__(self, 5)`, `95699111777728580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyBaseClass</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value\n\n\n<span class="token keyword">class</span> <span class="token class-name">MyChildClass</span><span class="token punctuation">(</span>MyBaseClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        MyBaseClass<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个办法能够应对比较简单的类体系，但是在其他的情况下容易出现问题。</p>\n<p>假如某个类继承了多个超类（一般来说不应该采用多重继承，笔者这里只是举例而已，参见第 41 条），那么直接调用超类的 <code class="language-text">__init__</code> 方法会让代码产生误会。</p>\n<p>直接调用 <code class="language-text">__init__</code> 方法所产生的第一个问题在于，超类的构造逻辑不一定会按照它们在子类 class 语句中的声明顺序执行。例如，在 MyBaseClass 之外再定义两个类，让它们也分别去操纵本实例的 value 字段。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93418426965685200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class TimesTwo:\n    def __init__(self):\n        self.value *= 2\n\n\nclass PlusFive:\n    def __init__(self):\n        self.value += 5`, `93418426965685200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">TimesTwo</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">*=</span> <span class="token number">2</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">PlusFive</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">+=</span> <span class="token number">5</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>下面这个子类继承了刚才那三个类，而且它在 class 语句里指定的超类顺序与它执行那些超类的 <code class="language-text">__init__</code> 时所用的顺序一致。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23523280113447110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class OneWay(MyBaseClass, TimesTwo, PlusFive):\n    def __init__(self, value):\n        MyBaseClass.__init__(self, value)\n        TimesTwo.__init__(self)\n        PlusFive.__init__(self)`, `23523280113447110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">OneWay</span><span class="token punctuation">(</span>MyBaseClass<span class="token punctuation">,</span> TimesTwo<span class="token punctuation">,</span> PlusFive<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        MyBaseClass<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n        TimesTwo<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">)</span>\n        PlusFive<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写，程序会按正常顺序初始化那几个超类。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41502099252211660000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyBaseClass:\n    def __init__(self, value):\n        self.value = value\n\n\nclass TimesTwo:\n    def __init__(self):\n        self.value *= 2\n\n\nclass PlusFive:\n    def __init__(self):\n        self.value += 5\n\n\nclass OneWay(MyBaseClass, TimesTwo, PlusFive):\n    def __init__(self, value):\n        MyBaseClass.__init__(self, value)\n        TimesTwo.__init__(self)\n        PlusFive.__init__(self)\n\n\nfoo = OneWay(5)\nprint(\'First ordering value is (5 * 2) + 5 =\', foo.value)\n\n>>>\nFirst ordering value is (5 * 2) + 5 = 15`, `41502099252211660000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{23-24}"\n              >\n                <span class="gatsby-code-button-language">py{23-24}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyBaseClass</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value\n\n\n<span class="token keyword">class</span> <span class="token class-name">TimesTwo</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">*=</span> <span class="token number">2</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">PlusFive</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">+=</span> <span class="token number">5</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">OneWay</span><span class="token punctuation">(</span>MyBaseClass<span class="token punctuation">,</span> TimesTwo<span class="token punctuation">,</span> PlusFive<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        MyBaseClass<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n        TimesTwo<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">)</span>\n        PlusFive<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">)</span>\n\n\n<span class="gatsby-highlight-code-line">foo <span class="token operator">=</span> OneWay<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'First ordering value is (5 * 2) + 5 =\'</span><span class="token punctuation">,</span> foo<span class="token punctuation">.</span>value<span class="token punctuation">)</span></span>\n<span class="token operator">>></span><span class="token operator">></span>\nFirst ordering value <span class="token keyword">is</span> <span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">5</span> <span class="token operator">=</span> <span class="token number">15</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但如果子类在 class 语句里指定的超类顺序，与它执行那些超类的 <code class="language-text">__init__</code> 时的顺序不同，那么运行结果就会让人困惑（例如这次先声明它继承 PlusFive 类，然后才声明它继承 TimesTwo 类，但执行 <code class="language-text">__init__</code> 的顺序却刚好相反）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70069689001988220000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class AnotherWay(MyBaseClass, PlusFive, TimesTwo):\n    def __init__(self, value):\n        MyBaseClass.__init__(self, value)\n        TimesTwo.__init_(self)\n        PlusFive.__init_(self)`, `70069689001988220000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">AnotherWay</span><span class="token punctuation">(</span>MyBaseClass<span class="token punctuation">,</span> PlusFive<span class="token punctuation">,</span> TimesTwo<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        MyBaseClass<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n        TimesTwo<span class="token punctuation">.</span>__init_<span class="token punctuation">(</span>self<span class="token punctuation">)</span>\n        PlusFive<span class="token punctuation">.</span>__init_<span class="token punctuation">(</span>self<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>该子类调整了两个超类的声明顺序，但没有相应调整构造逻辑的执行顺序，因此它还是会跟前面那个子类一样，先初始化 TimesTwo，然后初始化 PlusFive。这样写，就让初次看到这段代码的人很难理解程序的运行结果，他们以为程序先加 5，再乘 2，这样算出来是 20；但实际上，程序依照的是 <code class="language-text">__init__</code> 的调用顺序，而不是 class 语句中的声明顺序，这是个很难察觉的问题。</p>\n<p>直接调用 <code class="language-text">__init__</code> 所产生的第二个问题在于，无法正确处理菱形继承（diamond inheritance）。这种继承指的是子类通过类体系里两条不同路径的类继承了同一个超类。如果采用刚才那种常见的写法来调用超类的 <code class="language-text">__init__</code>，那么会让超类的初始化逻辑重复执行，从而引发混乱。例如，下面先从 MyBaseClass 派生出两个子类。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35178209222557610000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyBaseClass:\n    def __init__(self, value):\n        self.value = value\n\n\nclass TimesSeven(MyBaseClass):\n    def __init__(self, value):\n        MyBaseClass.__init__(self, value)\n        self.value *= 7\n\n\nclass PlusNine(MyBaseClass):\n    def __init__(self, value):\n        MyBaseClass.__init__(self, value)\n        self.value += 9`, `35178209222557610000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyBaseClass</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value\n\n\n<span class="token keyword">class</span> <span class="token class-name">TimesSeven</span><span class="token punctuation">(</span>MyBaseClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        MyBaseClass<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">*=</span> <span class="token number">7</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">PlusNine</span><span class="token punctuation">(</span>MyBaseClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        MyBaseClass<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">+=</span> <span class="token number">9</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后，定义最终的子类，让它分别继承刚才那两个类，这样 MyBaseClass 就会出现在菱形体系的顶端。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27878616943905964000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyBaseClass:\n    def __init__(self, value):\n        self.value = value\n\n\nclass TimesSeven(MyBaseClass):\n    def __init__(self, value):\n        MyBaseClass.__init__(self, value)\n        self.value *= 7\n\n\nclass PlusNine(MyBaseClass):\n    def __init__(self, value):\n        MyBaseClass.__init__(self, value)\n        self.value += 9\n\n\nclass ThisWay(TimesSeven, PlusNine):\n    def __init__(self, value):\n        TimesSeven.__init__(self, value)\n        PlusNine.__init__(self, value)\n\n\nfoo = ThisWay(5)\nprint(\'Should be (5 * 7) + 9 = 44 but is\', foo.value)\n\n>>>\nShould be (5 * 7) + 9 = 44 but is 14`, `27878616943905964000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{18-25}"\n              >\n                <span class="gatsby-code-button-language">py{18-25}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyBaseClass</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value\n\n\n<span class="token keyword">class</span> <span class="token class-name">TimesSeven</span><span class="token punctuation">(</span>MyBaseClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        MyBaseClass<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">*=</span> <span class="token number">7</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">PlusNine</span><span class="token punctuation">(</span>MyBaseClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        MyBaseClass<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">+=</span> <span class="token number">9</span>\n\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">class</span> <span class="token class-name">ThisWay</span><span class="token punctuation">(</span>TimesSeven<span class="token punctuation">,</span> PlusNine<span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">        TimesSeven<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">        PlusNine<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">foo <span class="token operator">=</span> ThisWay<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Should be (5 * 7) + 9 = 44 but is\'</span><span class="token punctuation">,</span> foo<span class="token punctuation">.</span>value<span class="token punctuation">)</span></span>\n<span class="token operator">>></span><span class="token operator">></span>\nShould be <span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">9</span> <span class="token operator">=</span> <span class="token number">44</span> but <span class="token keyword">is</span> <span class="token number">14</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当 ThisWay 调用第二个超类的 <code class="language-text">__init__</code> 时，那个方法会再度触发 MyBaseClass 的 <code class="language-text">__init__</code>，导致 self.value 重新变成 5。所以，最后的结果是 5 + 9 = 14，而不是 <code class="language-text">(5 * 7) + 9 = 44</code>，因为早前由 <code class="language-text">TimesSeven.__init__</code> 所做的初始化效果已经被第二次执行的 <code class="language-text">MyBaseClass.__init__</code> 覆盖了。这是个违背直觉的结果，如果情况更为复杂，那么调试起来会特别困难。</p>\n<p>为了解决这些问题，Python 内置了 super 函数并且规定了标准的方法解析顺序（method resolution order，MRO）。super 能够确保菱形继承体系中的共同超类只初始化一次（其他案例参见第 48 条）。MRO 可以确定超类之间的初始化顺序，它遵循 C3 线性化（C3 linearization）算法。</p>\n<p>下面再创建一套菱形的类体系，但是这次，我们改用 <code class="language-text">super()</code> 来调用超类的初始化逻辑。</p>\n<p>位于菱形结构顶端的 MyBaseClass，会率先初始化，而且只会初始化一次。接下来，程序会参照菱形底端那个子类在 class 语句里声明超类时的顺序，来执行菱形结构中部的那两个超类。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2039527665526552600"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyBaseClass:\n    def __init__(self, value):\n        self.value = value\n\n\nclass TimesSevenCorrect(MyBaseClass):\n    def __init__(self, value):\n        super().__init__(value)\n        self.value *= 7\n\n\nclass PlusNineCorrect(MyBaseClass):\n    def __init__(self, value):\n        super().__init__(value)\n        self.value += 9\n\n\nclass GoodWay(TimesSevenCorrect, PlusNineCorrect):\n    def __init__(self, value):\n        super().__init__(value)\n\n\nfoo = GoodWay(5)\nprint(\'Should be 7 * (5 + 9) = 98 but is\', foo.value)\n\n>>>\nShould be 7 * (5 + 9) = 98 but is 98`, `2039527665526552600`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyBaseClass</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value\n\n\n<span class="token keyword">class</span> <span class="token class-name">TimesSevenCorrect</span><span class="token punctuation">(</span>MyBaseClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">*=</span> <span class="token number">7</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">PlusNineCorrect</span><span class="token punctuation">(</span>MyBaseClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">+=</span> <span class="token number">9</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">GoodWay</span><span class="token punctuation">(</span>TimesSevenCorrect<span class="token punctuation">,</span> PlusNineCorrect<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n\n\nfoo <span class="token operator">=</span> GoodWay<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Should be 7 * (5 + 9) = 98 but is\'</span><span class="token punctuation">,</span> foo<span class="token punctuation">.</span>value<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nShould be <span class="token number">7</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">+</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">98</span> but <span class="token keyword">is</span> <span class="token number">98</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个执行顺序，似乎与看上去的相反。既然 GoodWay 在指定超类时，先写的是 TimesSevenCorrect，那就应该先执行 <code class="language-text">TimesSevenCorrect.__init__</code> 才对，这样结果应该是 <code class="language-text">(5 * 7) + 9 = 44</code>。但实际上并非如此。这两个超类之间的初始化顺序，要由子类的 MRO 确定，它可以通过 mro 方法来查询。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18302733605481204000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`mro_str = \'\\n\'.join(repr(cls) for cls in GoodWay.mro())\nprint(mro_str)\n\n>>>\n<class \'__main__.GoodWay\'>\n<class \'__main__.TimesSevenCorrect\'>\n<class \'__main__.PlusNineCorrect\'>\n<class \'__main__.MyBaseClass\'>\n<class \'object\'>`, `18302733605481204000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">mro_str <span class="token operator">=</span> <span class="token string">\'\\n\'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token builtin">repr</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span> <span class="token keyword">for</span> cls <span class="token keyword">in</span> GoodWay<span class="token punctuation">.</span>mro<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>mro_str<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.GoodWay\'</span><span class="token operator">></span>\n<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.TimesSevenCorrect\'</span><span class="token operator">></span>\n<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.PlusNineCorrect\'</span><span class="token operator">></span>\n<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.MyBaseClass\'</span><span class="token operator">></span>\n<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'object\'</span><span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>调用 GoodWay(5) 时，会先触发 <code class="language-text">TimesSevenCorrect.__init__</code>，进而触发 <code class="language-text">PlusNineCorrect.__init__</code>，而这又会触发 <code class="language-text">MyBaseClass.__init__</code>。程序到达菱形结构的顶端后，开始执行 MyBaseClass 的初始化逻辑，然后按照与刚才相反的顺序，依次执行 PlusNineCorrect、TimesSevenCorrect 与 GoodWay 的初始化逻辑。所以，程序首先会在 <code class="language-text">MyBaseClass.__init__</code> 中，把 value 设为 5，然后在 <code class="language-text">PlusNineCorrect.__init__</code> 里面给它加 9，这样就成了 14，接着又会在 <code class="language-text">TimesSevenCorrect.__init__</code> 里面将它乘 7，于是等于 98。</p>\n<p>除了可以应对菱形继承结构，通过 super() 调用 <code class="language-text">__init__</code>，与在子类内通过类名直接调用 <code class="language-text">__init__</code> 相比，可使代码更容易维护。现在不用从子类里面指名调用 <code class="language-text">MyBaseClass.__init__</code> 方法了，因此可以把 MyBaseClass 改成其他名字，或者让 TimesSevenCorrect 与 PlusNineCorrect 从另外一个超类里面继承，这些改动都无须调整 super 这一部分的代码。假如像原来那样写，那就必须手工修改 <code class="language-text">__init__</code> 方法前面的类名。</p>\n<p>super 函数也可以用双参数的形式调用。第一个参数表示从这个类型开始（不含该类型本身）按照方法解析顺序（MRO）向上搜索，而解析顺序则要由第二个参数所在类型的 <code class="language-text">__mro__</code> 决定。例如，按照下面这种写法，如果在 super 所返回的内容上调用 <code class="language-text">__init__</code> 方法，那么程序会从 ExplicitTrisect 类型开始（不含该类型本身）按照 MRO 向上搜索，直至找到这样的 <code class="language-text">__init__</code> 方法为止，而解析顺序是由第二个参数（self）所属的类型（ExplicitTrisect）决定的，所以解析顺序是 <code class="language-text">ExplicitTrisect -&gt; MyBaseClass -&gt; object</code>。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8440446214332398000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class ExplicitTrisect(MyBaseClass):\n    def __init__(self, value):\n        super(ExplicitTrisect, self).__init__(value)\n        self.value /= 3`, `8440446214332398000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">ExplicitTrisect</span><span class="token punctuation">(</span>MyBaseClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span>ExplicitTrisect<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">/=</span> <span class="token number">3</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>一般来说，在类的 <code class="language-text">__init__</code> 方法里面通过 super 初始化实例时，不需要采用双参数的形式，而是可以直接采用不带参数的写法调用 super，这样 Python 编译器会自动将 <code class="language-text">__class__</code> 和 self 当成参数传递进去。所以，下面这两种写法跟刚才那种写法是同一个意思。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76815168371146160000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyBaseClass:\n    def __init__(self, value):\n        self.value = value\n\n\nclass ExplicitTrisect(MyBaseClass):\n    def __init__(self, value):\n        super(ExplicitTrisect, self).__init__(value)\n        self.value /= 3\n\n\nclass AutomaticTrisect(MyBaseClass):\n    def __init__(self, value):\n        super(__class__, self).__init__(value)\n        self.value /= 3\n\n\nclass ImplicitTrisect(MyBaseClass):\n    def __init__(self, value):\n        super().__init__(value)\n        self.value /= 3\n\n\nassert ExplicitTrisect(9).value == 3\nassert AutomaticTrisect(9).value == 3\nassert ImplicitTrisect(9).value == 3`, `76815168371146160000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyBaseClass</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value\n\n\n<span class="token keyword">class</span> <span class="token class-name">ExplicitTrisect</span><span class="token punctuation">(</span>MyBaseClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span>ExplicitTrisect<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">/=</span> <span class="token number">3</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">AutomaticTrisect</span><span class="token punctuation">(</span>MyBaseClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span>__class__<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">/=</span> <span class="token number">3</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">ImplicitTrisect</span><span class="token punctuation">(</span>MyBaseClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">/=</span> <span class="token number">3</span>\n\n\n<span class="token keyword">assert</span> ExplicitTrisect<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">==</span> <span class="token number">3</span>\n<span class="token keyword">assert</span> AutomaticTrisect<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">==</span> <span class="token number">3</span>\n<span class="token keyword">assert</span> ImplicitTrisect<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">==</span> <span class="token number">3</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>只有一种情况需要明确给 super 指定参数，这就是：我们想从子类里面访问超类对某项功能所做的实现方案，而那种方案可能已经被子类覆盖掉了（例如，在封装或复用功能时，就会遇到这样的情况）。</p>\n<h3 id="总结-36"><a href="#%E6%80%BB%E7%BB%93-36" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>Python 有标准的方法解析顺序（MRO）规则，可以用来判定超类之间的初始化顺序，并解决菱形继承问题。</li>\n<li>可以通过 Python 内置的 super 函数正确触发超类的 <code class="language-text">__init__</code> 逻辑。一般情况下，不需要给这个函数指定参数。</li>\n</ol>\n<h2 id="第-41-条：考虑用-mix-in-类来表示可组合的功能"><a href="#%E7%AC%AC-41-%E6%9D%A1%EF%BC%9A%E8%80%83%E8%99%91%E7%94%A8-mix-in-%E7%B1%BB%E6%9D%A5%E8%A1%A8%E7%A4%BA%E5%8F%AF%E7%BB%84%E5%90%88%E7%9A%84%E5%8A%9F%E8%83%BD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 41 条：考虑用 mix-in 类来表示可组合的功能</h2>\n<p>Python 是面向对象的编程语言，而且内置了相关的机制，使开发者能够正确处理多重继承（参见第 40 条）。尽管如此，但还是应该尽量少用多重继承。</p>\n<p>如果既要通过多重继承来方便地封装逻辑，又想避开可能出现的问题，那么就应该把有待继承的类写成 mix-in 类。这种类只提供一小套方法给子类去沿用，而不定义自己实例级别的属性，也不需要 <code class="language-text">__init__</code> 构造函数。</p>\n<p>在 Python 里很容易编写 mix-in，因为无论对象是什么类型，我们都可以方便地检视（inspect）它当前的状态。这种动态检测机制，让我们只需要把通用的功能在 mix-in 实现一遍即可，将来也可以把这项功能应用到其他许多类里面。可以把这些 mix-in 类有层次地组合起来，从而用相当少的代码表达出丰富的功能。</p>\n<p>例如，现在要实现这样一个功能，把内存中的 Python 对象表示成字典形式以便做序列化（serialization）处理。不妨将这项功能写为通用代码，以供其他类使用。</p>\n<p>为了演示这种做法，笔者定义下面这个 mix-in，让它提供名为 <code class="language-text">to_dict</code> 的 public 方法。凡是想支持这项功能的类，都可以从 mix-in 继承。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="13830381143408398000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class ToDictMixin:\n    def to_dict(self):\n        return self._traverse_dict(self.__dict__)`, `13830381143408398000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">ToDictMixin</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">to_dict</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_traverse_dict<span class="token punctuation">(</span>self<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>具体的实现代码写得很直观，我们可以通过 isinstance 函数动态地检视值的类型，并利用 hasattr 函数判断值里面有没有叫作 <code class="language-text">__dict__</code> 的字典。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56958403702189990000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def _traverse_dict(self, instance_dict):\n    output = {}\n    for key, value in instance_dict.items():\n        output[key] = self._traverse(key, value)\n    return output\n\n\ndef _traverse(self, key, value):\n    if isinstance(value, ToDictMixin):\n        return value.to_dict()\n    elif isinstance(value, dict):\n        return self._traverse_dict(value)\n    elif isinstance(value, list):\n        return [self._traverse(key, i) for i in value]\n    elif hasattr(value, \'__dict__\'):\n        return self._traverse_dict(value.__dict__)\n    else:\n        return value`, `56958403702189990000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">_traverse_dict</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    output <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n    <span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> instance_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        output<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> output\n\n\n<span class="token keyword">def</span> <span class="token function">_traverse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> ToDictMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> value<span class="token punctuation">.</span>to_dict<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_traverse_dict<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n    <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span>key<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> value<span class="token punctuation">]</span>\n    <span class="token keyword">elif</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token string">\'__dict__\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_traverse_dict<span class="token punctuation">(</span>value<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> value</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>下面以二叉树为例，演示如何使表示二叉树的 BinaryTree 类具备刚才那个 mix-in 所提供的功能。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36327064667206610000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class BinaryTree(ToDictMixin):\n    def __init__(self, value, left=None, right=None):\n        self.value = value\n        self.left = left\n        self.right = right`, `36327064667206610000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">BinaryTree</span><span class="token punctuation">(</span>ToDictMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">,</span> left<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> right<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value\n        self<span class="token punctuation">.</span>left <span class="token operator">=</span> left\n        self<span class="token punctuation">.</span>right <span class="token operator">=</span> right</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>定义了这样的 BinaryTree 类后，很容易就能把二叉树里面那些相互关联的 Python 对象转换成字典的形式。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64274869738764770000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class ToDictMixin:\n    def _traverse_dict(self, instance_dict):\n        output = {}\n        for key, value in instance_dict.items():\n            output[key] = self._traverse(key, value)\n        return output\n\n    def _traverse(self, key, value):\n        if isinstance(value, ToDictMixin):\n            return value.to_dict()\n        elif isinstance(value, dict):\n            return self._traverse_dict(value)\n        elif isinstance(value, list):\n            return [self._traverse(key, i) for i in value]\n        elif hasattr(value, \'__dict__\'):\n            return self._traverse_dict(value.__dict__)\n        else:\n            return value\n\n    def to_dict(self):\n        return self._traverse_dict(self.__dict__)\n\n\nclass BinaryTree(ToDictMixin):\n    def __init__(self, value, left=None, right=None):\n        self.value = value\n        self.left = left\n        self.right = right\n\n\ntree = BinaryTree(10,\n                  left=BinaryTree(7, right=BinaryTree(9)),\n                  right=BinaryTree(13, left=BinaryTree(11)))\nprint(tree.to_dict())\n\n>>>\n{\'value\': 10, \'left\': {\'value\': 7, \'left\': None, \'right\': {\'value\': 9, \'left\': None, \'right\': None}}, \'right\': {\'value\': 13, \'left\': {\'value\': 11, \'left\': None, \'right\': None}, \'right\': None}}`, `64274869738764770000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{31-34}"\n              >\n                <span class="gatsby-code-button-language">py{31-34}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">ToDictMixin</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">_traverse_dict</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        output <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n        <span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> instance_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            output<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> output\n\n    <span class="token keyword">def</span> <span class="token function">_traverse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> ToDictMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> value<span class="token punctuation">.</span>to_dict<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_traverse_dict<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n        <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span>key<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> value<span class="token punctuation">]</span>\n        <span class="token keyword">elif</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token string">\'__dict__\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_traverse_dict<span class="token punctuation">(</span>value<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> value\n\n    <span class="token keyword">def</span> <span class="token function">to_dict</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_traverse_dict<span class="token punctuation">(</span>self<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">BinaryTree</span><span class="token punctuation">(</span>ToDictMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">,</span> left<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> right<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value\n        self<span class="token punctuation">.</span>left <span class="token operator">=</span> left\n        self<span class="token punctuation">.</span>right <span class="token operator">=</span> right\n\n\n<span class="gatsby-highlight-code-line">tree <span class="token operator">=</span> BinaryTree<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">                  left<span class="token operator">=</span>BinaryTree<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> right<span class="token operator">=</span>BinaryTree<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">                  right<span class="token operator">=</span>BinaryTree<span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">,</span> left<span class="token operator">=</span>BinaryTree<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">print</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span>to_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">{</span><span class="token string">\'value\'</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">\'left\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'value\'</span><span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">\'left\'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">\'right\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'value\'</span><span class="token punctuation">:</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token string">\'left\'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">\'right\'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'right\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'value\'</span><span class="token punctuation">:</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token string">\'left\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'value\'</span><span class="token punctuation">:</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token string">\'left\'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">\'right\'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'right\'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>mix-in 最妙的地方在于，子类既可以沿用它所提供的功能，又可以对其中一些地方做自己的处理。例如，我们从普通的二叉树（BinaryTree）派生了一个子类，让这种特殊的 BinaryTreeWithParent 二叉树能够把指向上级节点的引用保留下来。但问题是，这种二叉树的 <code class="language-text">to_dict</code> 方法是从 ToDictMixin 继承来的，它所触发的 <code class="language-text">_traverse</code> 方法，在面对循环引用时，会无休止地递归下去。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79584007057969760000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class BinaryTreeWithParent(BinaryTree):\n    def __init__(self, value, left=None,\n                 right=None, parent=None):\n        super().__init__(value, left=left, right=right)\n        self.parent = parent`, `79584007057969760000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">BinaryTreeWithParent</span><span class="token punctuation">(</span>BinaryTree<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">,</span> left<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>\n                 right<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> parent<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>value<span class="token punctuation">,</span> left<span class="token operator">=</span>left<span class="token punctuation">,</span> right<span class="token operator">=</span>right<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>parent <span class="token operator">=</span> parent</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>为了避免无限循环，我们可以覆盖 <code class="language-text">BinaryTreeWithParent._traverse</code> 方法，让它对指向上级节点的引用做专门处理，而对于其他的值，则继续沿用从 mix-in 继承的 <code class="language-text">_traverse</code> 逻辑。下面这段代码，首先判断当前值是不是指向上级节点的引用。如果是，就直接返回上级节点的 value 值；如果不是，那就通过内置的 super 函数沿用由 mix-in 超类所给出默认实现方案。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36897029235089730000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def _traverse(self, key, value):\n   if (isinstance(value, BinaryTreeWithParent) and\n            key == \'parent\'):\n      return value.value  # Prevent cycles\n   else:\n      return super()._traverse(key, value)`, `36897029235089730000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">_traverse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> BinaryTreeWithParent<span class="token punctuation">)</span> <span class="token keyword">and</span>\n            key <span class="token operator">==</span> <span class="token string">\'parent\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n      <span class="token keyword">return</span> value<span class="token punctuation">.</span>value  <span class="token comment"># Prevent cycles</span>\n   <span class="token keyword">else</span><span class="token punctuation">:</span>\n      <span class="token keyword">return</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在调用 <code class="language-text">BinaryTreeWithParent.to_dict</code> 就没有问题了，因为它所触发的是 BinaryTreeWithParent 自己的 <code class="language-text">_traverse</code> 方法，该方法不会再递归地处理循环引用。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92220990242954820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class ToDictMixin:\n    def _traverse_dict(self, instance_dict):\n        output = {}\n        for key, value in instance_dict.items():\n            output[key] = self._traverse(key, value)\n        return output\n\n    def _traverse(self, key, value):\n        if isinstance(value, ToDictMixin):\n            return value.to_dict()\n        elif isinstance(value, dict):\n            return self._traverse_dict(value)\n        elif isinstance(value, list):\n            return [self._traverse(key, i) for i in value]\n        elif hasattr(value, \'__dict__\'):\n            return self._traverse_dict(value.__dict__)\n        else:\n            return value\n\n    def to_dict(self):\n        return self._traverse_dict(self.__dict__)\n\n\nclass BinaryTree(ToDictMixin):\n    def __init__(self, value, left=None, right=None):\n        self.value = value\n        self.left = left\n        self.right = right\n\n\nclass BinaryTreeWithParent(BinaryTree):\n    def __init__(self, value, left=None,\n                 right=None, parent=None):\n        super().__init__(value, left=left, right=right)\n        self.parent = parent\n\n    def _traverse(self, key, value):\n        if (isinstance(value, BinaryTreeWithParent) and\n                key == \'parent\'):\n            return value.value  # Prevent cycles\n        else:\n            return super()._traverse(key, value)\n\n\nroot = BinaryTreeWithParent(10)\nroot.left = BinaryTreeWithParent(7, parent=root)\nroot.left.right = BinaryTreeWithParent(9, parent=root.left)\nprint(root.to_dict())\n\n>>>\n{\'value\': 10, \'left\': {\'value\': 7, \'left\': None, \'right\': {\'value\': 9, \'left\': None, \'right\': None, \'parent\': 7}, \'parent\': 10}, \'right\': None, \'parent\': None}`, `92220990242954820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{37-42}"\n              >\n                <span class="gatsby-code-button-language">py{37-42}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">ToDictMixin</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">_traverse_dict</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        output <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n        <span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> instance_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            output<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> output\n\n    <span class="token keyword">def</span> <span class="token function">_traverse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> ToDictMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> value<span class="token punctuation">.</span>to_dict<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_traverse_dict<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n        <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span>key<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> value<span class="token punctuation">]</span>\n        <span class="token keyword">elif</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token string">\'__dict__\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_traverse_dict<span class="token punctuation">(</span>value<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> value\n\n    <span class="token keyword">def</span> <span class="token function">to_dict</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_traverse_dict<span class="token punctuation">(</span>self<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">BinaryTree</span><span class="token punctuation">(</span>ToDictMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">,</span> left<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> right<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value\n        self<span class="token punctuation">.</span>left <span class="token operator">=</span> left\n        self<span class="token punctuation">.</span>right <span class="token operator">=</span> right\n\n\n<span class="token keyword">class</span> <span class="token class-name">BinaryTreeWithParent</span><span class="token punctuation">(</span>BinaryTree<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">,</span> left<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>\n                 right<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> parent<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>value<span class="token punctuation">,</span> left<span class="token operator">=</span>left<span class="token punctuation">,</span> right<span class="token operator">=</span>right<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>parent <span class="token operator">=</span> parent\n\n<span class="gatsby-highlight-code-line">    <span class="token keyword">def</span> <span class="token function">_traverse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> BinaryTreeWithParent<span class="token punctuation">)</span> <span class="token keyword">and</span></span><span class="gatsby-highlight-code-line">                key <span class="token operator">==</span> <span class="token string">\'parent\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">            <span class="token keyword">return</span> value<span class="token punctuation">.</span>value  <span class="token comment"># Prevent cycles</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">else</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">            <span class="token keyword">return</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span></span>\n\nroot <span class="token operator">=</span> BinaryTreeWithParent<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>\nroot<span class="token punctuation">.</span>left <span class="token operator">=</span> BinaryTreeWithParent<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> parent<span class="token operator">=</span>root<span class="token punctuation">)</span>\nroot<span class="token punctuation">.</span>left<span class="token punctuation">.</span>right <span class="token operator">=</span> BinaryTreeWithParent<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> parent<span class="token operator">=</span>root<span class="token punctuation">.</span>left<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>to_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">{</span><span class="token string">\'value\'</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">\'left\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'value\'</span><span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">\'left\'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">\'right\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'value\'</span><span class="token punctuation">:</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token string">\'left\'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">\'right\'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">\'parent\'</span><span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'parent\'</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'right\'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">\'parent\'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>只要 <code class="language-text">BinaryTreeWithParent._traverse</code> 没问题，带有 BinaryTreeWithParent 属性的其他类就可以直接继承 ToDictMixin，这样的话，程序在把这种对象转化成字典时，会自动对其中的 BinaryTreeWithParent 属性做出正确处理。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34374431809434845000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class ToDictMixin:\n    def _traverse_dict(self, instance_dict):\n        output = {}\n        for key, value in instance_dict.items():\n            output[key] = self._traverse(key, value)\n        return output\n\n    def _traverse(self, key, value):\n        if isinstance(value, ToDictMixin):\n            return value.to_dict()\n        elif isinstance(value, dict):\n            return self._traverse_dict(value)\n        elif isinstance(value, list):\n            return [self._traverse(key, i) for i in value]\n        elif hasattr(value, \'__dict__\'):\n            return self._traverse_dict(value.__dict__)\n        else:\n            return value\n\n    def to_dict(self):\n        return self._traverse_dict(self.__dict__)\n\n\nclass BinaryTree(ToDictMixin):\n    def __init__(self, value, left=None, right=None):\n        self.value = value\n        self.left = left\n        self.right = right\n\n\nclass BinaryTreeWithParent(BinaryTree):\n    def __init__(self, value, left=None,\n                 right=None, parent=None):\n        super().__init__(value, left=left, right=right)\n        self.parent = parent\n\n    def _traverse(self, key, value):\n        if (isinstance(value, BinaryTreeWithParent) and\n                key == \'parent\'):\n            return value.value  # Prevent cycles\n        else:\n            return super()._traverse(key, value)\n\n\nclass NamedSubTree(ToDictMixin):\n    def __init__(self, name, tree_with_parent):\n        self.name = name\n        self.tree_with_parent = tree_with_parent\n\n\nroot = BinaryTreeWithParent(10)\nroot.left = BinaryTreeWithParent(7, parent=root)\nroot.left.right = BinaryTreeWithParent(9, parent=root.left)\n\nmy_tree = NamedSubTree(\'foobar\', root.left.right)\nprint(my_tree.to_dict())  # No infinite loop\n\n>>>\n{\'name\': \'foobar\', \'tree_with_parent\': {\'value\': 9, \'left\': None, \'right\': None, \'parent\': 7}}`, `34374431809434845000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{45-48,55-56}"\n              >\n                <span class="gatsby-code-button-language">py{45-48,55-56}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">ToDictMixin</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">_traverse_dict</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        output <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n        <span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> instance_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            output<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> output\n\n    <span class="token keyword">def</span> <span class="token function">_traverse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> ToDictMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> value<span class="token punctuation">.</span>to_dict<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_traverse_dict<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n        <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span>key<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> value<span class="token punctuation">]</span>\n        <span class="token keyword">elif</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token string">\'__dict__\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_traverse_dict<span class="token punctuation">(</span>value<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> value\n\n    <span class="token keyword">def</span> <span class="token function">to_dict</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_traverse_dict<span class="token punctuation">(</span>self<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">BinaryTree</span><span class="token punctuation">(</span>ToDictMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">,</span> left<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> right<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value\n        self<span class="token punctuation">.</span>left <span class="token operator">=</span> left\n        self<span class="token punctuation">.</span>right <span class="token operator">=</span> right\n\n\n<span class="token keyword">class</span> <span class="token class-name">BinaryTreeWithParent</span><span class="token punctuation">(</span>BinaryTree<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">,</span> left<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>\n                 right<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> parent<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>value<span class="token punctuation">,</span> left<span class="token operator">=</span>left<span class="token punctuation">,</span> right<span class="token operator">=</span>right<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>parent <span class="token operator">=</span> parent\n\n    <span class="token keyword">def</span> <span class="token function">_traverse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> BinaryTreeWithParent<span class="token punctuation">)</span> <span class="token keyword">and</span>\n                key <span class="token operator">==</span> <span class="token string">\'parent\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> value<span class="token punctuation">.</span>value  <span class="token comment"># Prevent cycles</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n\n\n<span class="gatsby-highlight-code-line"><span class="token keyword">class</span> <span class="token class-name">NamedSubTree</span><span class="token punctuation">(</span>ToDictMixin<span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> tree_with_parent<span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name</span><span class="gatsby-highlight-code-line">        self<span class="token punctuation">.</span>tree_with_parent <span class="token operator">=</span> tree_with_parent</span>\n\nroot <span class="token operator">=</span> BinaryTreeWithParent<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>\nroot<span class="token punctuation">.</span>left <span class="token operator">=</span> BinaryTreeWithParent<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> parent<span class="token operator">=</span>root<span class="token punctuation">)</span>\nroot<span class="token punctuation">.</span>left<span class="token punctuation">.</span>right <span class="token operator">=</span> BinaryTreeWithParent<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> parent<span class="token operator">=</span>root<span class="token punctuation">.</span>left<span class="token punctuation">)</span>\n\n<span class="gatsby-highlight-code-line">my_tree <span class="token operator">=</span> NamedSubTree<span class="token punctuation">(</span><span class="token string">\'foobar\'</span><span class="token punctuation">,</span> root<span class="token punctuation">.</span>left<span class="token punctuation">.</span>right<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">print</span><span class="token punctuation">(</span>my_tree<span class="token punctuation">.</span>to_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># No infinite loop</span></span>\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">{</span><span class="token string">\'name\'</span><span class="token punctuation">:</span> <span class="token string">\'foobar\'</span><span class="token punctuation">,</span> <span class="token string">\'tree_with_parent\'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'value\'</span><span class="token punctuation">:</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token string">\'left\'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">\'right\'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">\'parent\'</span><span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>多个 mix-in 可以组合起来用。例如，我们要再写一个 mix-in，让所有的类都可以通过继承它来实现 JSON 序列化功能。在编写这个 mix-in 时，假设继承了它的那个类肯定有自己的 <code class="language-text">to_dict</code> 方法（这个方法有可能是从另一个 mix-in（如 ToDictMixin）继承的）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95600348923497400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import json\n\n\nclass JsonMixin:\n    @classmethod\n    def from_json(cls, data):\n        kwargs = json.loads(data)\n        return cls(**kwargs)\n\n    def to_json(self):\n        return json.dumps(self.to_dict())`, `95600348923497400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> json\n\n\n<span class="token keyword">class</span> <span class="token class-name">JsonMixin</span><span class="token punctuation">:</span>\n    @<span class="token builtin">classmethod</span>\n    <span class="token keyword">def</span> <span class="token function">from_json</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        kwargs <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> cls<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">to_json</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>self<span class="token punctuation">.</span>to_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>请注意，JsonMixin 既定义了实例方法，也定义了类方法。于是，继承了这个 mix-in 的其他类也会拥有这两种行为。在本例中，继承 JsonMixin 的类只需要提供 <code class="language-text">to_dict</code> 方法以及能够接受关键字参数的 <code class="language-text">__init__</code> 方法即可（参见第 23 条）。</p>\n<p>有了这样两个 mix-in，我们很容易就能创建一套含有工具类的体系，让其中的各种类型都可以把对象序列化成 JSON 格式并且能够根据 JSON 格式的数据创建这样的对象。而这只需要开发者按照固定的样式多写一点点代码即可。例如，可以用这样一套由数据类所构成的体系表示数据中心的各种设备与它们之间的结构关系。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69599335607213785000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import json\n\n\nclass ToDictMixin:\n    def _traverse_dict(self, instance_dict):\n        output = {}\n        for key, value in instance_dict.items():\n            output[key] = self._traverse(key, value)\n        return output\n\n    def _traverse(self, key, value):\n        if isinstance(value, ToDictMixin):\n            return value.to_dict()\n        elif isinstance(value, dict):\n            return self._traverse_dict(value)\n        elif isinstance(value, list):\n            return [self._traverse(key, i) for i in value]\n        elif hasattr(value, \'__dict__\'):\n            return self._traverse_dict(value.__dict__)\n        else:\n            return value\n\n    def to_dict(self):\n        return self._traverse_dict(self.__dict__)\n\n\nclass JsonMixin:\n    @classmethod\n    def from_json(cls, data):\n        kwargs = json.loads(data)\n        return cls(**kwargs)\n\n    def to_json(self):\n        return json.dumps(self.to_dict())\n\n\nclass Switch(ToDictMixin, JsonMixin):\n    def __init__(self, ports=None, speed=None):\n        self.ports = ports\n        self.speed = speed\n\n\nclass Machine(ToDictMixin, JsonMixin):\n    def __init__(self, cores=None, ram=None, disk=None):\n        self.cores = cores\n        self.ram = ram\n        self.disk = disk\n\n\nclass DatacenterRack(ToDictMixin, JsonMixin):\n    def __init__(self, switch=None, machines=None):\n        self.switch = Switch(**switch)\n        self.machines = [\n            Machine(**kwargs) for kwargs in machines]\n\n\nserialized = &quot;&quot;&quot;{\n    &quot;switch&quot;: {&quot;ports&quot;: 5, &quot;speed&quot;: 1e9},\n    &quot;machines&quot;: [\n        {&quot;cores&quot;: 8, &quot;ram&quot;: 32e9, &quot;disk&quot;: 5e12},\n        {&quot;cores&quot;: 4, &quot;ram&quot;: 16e9, &quot;disk&quot;: 1e12},\n        {&quot;cores&quot;: 2, &quot;ram&quot;: 4e9, &quot;disk&quot;: 500e9}\n    ]\n}\n&quot;&quot;&quot;\n\ndeserialized = DatacenterRack.from_json(serialized)\nroundtrip = deserialized.to_json()\nassert json.loads(serialized) == json.loads(roundtrip)`, `69599335607213785000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> json\n\n\n<span class="token keyword">class</span> <span class="token class-name">ToDictMixin</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">_traverse_dict</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        output <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n        <span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> instance_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            output<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> output\n\n    <span class="token keyword">def</span> <span class="token function">_traverse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> ToDictMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> value<span class="token punctuation">.</span>to_dict<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_traverse_dict<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n        <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span>key<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> value<span class="token punctuation">]</span>\n        <span class="token keyword">elif</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token string">\'__dict__\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_traverse_dict<span class="token punctuation">(</span>value<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> value\n\n    <span class="token keyword">def</span> <span class="token function">to_dict</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_traverse_dict<span class="token punctuation">(</span>self<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">JsonMixin</span><span class="token punctuation">:</span>\n    @<span class="token builtin">classmethod</span>\n    <span class="token keyword">def</span> <span class="token function">from_json</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        kwargs <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> cls<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">to_json</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>self<span class="token punctuation">.</span>to_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Switch</span><span class="token punctuation">(</span>ToDictMixin<span class="token punctuation">,</span> JsonMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ports<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> speed<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>ports <span class="token operator">=</span> ports\n        self<span class="token punctuation">.</span>speed <span class="token operator">=</span> speed\n\n\n<span class="token keyword">class</span> <span class="token class-name">Machine</span><span class="token punctuation">(</span>ToDictMixin<span class="token punctuation">,</span> JsonMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> cores<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> ram<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> disk<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>cores <span class="token operator">=</span> cores\n        self<span class="token punctuation">.</span>ram <span class="token operator">=</span> ram\n        self<span class="token punctuation">.</span>disk <span class="token operator">=</span> disk\n\n\n<span class="token keyword">class</span> <span class="token class-name">DatacenterRack</span><span class="token punctuation">(</span>ToDictMixin<span class="token punctuation">,</span> JsonMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> switch<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> machines<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>switch <span class="token operator">=</span> Switch<span class="token punctuation">(</span><span class="token operator">**</span>switch<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>machines <span class="token operator">=</span> <span class="token punctuation">[</span>\n            Machine<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span> <span class="token keyword">for</span> kwargs <span class="token keyword">in</span> machines<span class="token punctuation">]</span>\n\n\nserialized <span class="token operator">=</span> <span class="token triple-quoted-string string">"""{\n    "switch": {"ports": 5, "speed": 1e9},\n    "machines": [\n        {"cores": 8, "ram": 32e9, "disk": 5e12},\n        {"cores": 4, "ram": 16e9, "disk": 1e12},\n        {"cores": 2, "ram": 4e9, "disk": 500e9}\n    ]\n}\n"""</span>\n\ndeserialized <span class="token operator">=</span> DatacenterRack<span class="token punctuation">.</span>from_json<span class="token punctuation">(</span>serialized<span class="token punctuation">)</span>\nroundtrip <span class="token operator">=</span> deserialized<span class="token punctuation">.</span>to_json<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">assert</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>serialized<span class="token punctuation">)</span> <span class="token operator">==</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>roundtrip<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写之后，我们很容易就能根据 JSON 格式的信息把这些对象还原出来，另外，也可以把它们再序列化成 JSON 格式。下面我们就先把 serialized 变量所指的一段 JSON 信息反序列化（也就是还原）成 DatacenterRack 对象，然后再把这个对象序列化成 JSON 信息并保存到 roundtrip 变量，最后通过 json.loads 方法验证这两个变量中的信息是否等效。</p>\n<p>对于 JsonMixin 这样的 mix-in 来说，即便直接继承它的那个类还通过类体系中的其他更高层类型间接地继承了它，程序也依然能够正常运行，因为 Python 可以把相关的方法正确地派发给 JsonMixin 类。</p>\n<h3 id="总结-37"><a href="#%E6%80%BB%E7%BB%93-37" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>超类最好能写成不带实例属性与 <code class="language-text">__init__</code> 方法的 mix-in 类，以避免由多重继承所引发的一些问题。</li>\n<li>如果子类要定制（或者说修改）mix-in 所提供的功能，那么可以在自己的代码里面覆盖相关的实例方法。</li>\n<li>根据需求，mix-in 可以只提供实例方法，也可以只提供类方法，还可以同时提供这两种方法。</li>\n<li>把每个 mix-in 所提供的简单功能组合起来，可以实现比较复杂的功能。</li>\n</ol>\n<h2 id="第-42-条：优先考虑用-public-属性表示应受保护的数据，不要用-private-属性表示"><a href="#%E7%AC%AC-42-%E6%9D%A1%EF%BC%9A%E4%BC%98%E5%85%88%E8%80%83%E8%99%91%E7%94%A8-public-%E5%B1%9E%E6%80%A7%E8%A1%A8%E7%A4%BA%E5%BA%94%E5%8F%97%E4%BF%9D%E6%8A%A4%E7%9A%84%E6%95%B0%E6%8D%AE%EF%BC%8C%E4%B8%8D%E8%A6%81%E7%94%A8-private-%E5%B1%9E%E6%80%A7%E8%A1%A8%E7%A4%BA" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 42 条：优先考虑用 public 属性表示应受保护的数据，不要用 private 属性表示</h2>\n<p>Python 类的属性只有两种访问级别，也就是 public 与 private。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33392409757829177000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyObject:\n    def __init__(self):\n        self.public_field = 5\n        self.__private_field = 10\n\n    def get_private_field(self):\n        return self.__private_field`, `33392409757829177000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyObject</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>public_field <span class="token operator">=</span> <span class="token number">5</span>\n        self<span class="token punctuation">.</span>__private_field <span class="token operator">=</span> <span class="token number">10</span>\n\n    <span class="token keyword">def</span> <span class="token function">get_private_field</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>__private_field</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>public 属性能够公开访问，只需要在对象后面加上圆点操作符（dot operator），并写出属性的名称即可。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87058523201279820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyObject:\n    def __init__(self):\n        self.public_field = 5\n        self.__private_field = 10\n\n    def get_private_field(self):\n        return self.__private_field\n\n\nfoo = MyObject()\nassert foo.public_field == 5`, `87058523201279820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{10-11}"\n              >\n                <span class="gatsby-code-button-language">py{10-11}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyObject</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>public_field <span class="token operator">=</span> <span class="token number">5</span>\n        self<span class="token punctuation">.</span>__private_field <span class="token operator">=</span> <span class="token number">10</span>\n\n    <span class="token keyword">def</span> <span class="token function">get_private_field</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>__private_field\n\n\n<span class="gatsby-highlight-code-line">foo <span class="token operator">=</span> MyObject<span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">assert</span> foo<span class="token punctuation">.</span>public_field <span class="token operator">==</span> <span class="token number">5</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果属性名以两个下划线开头，那么即为 private 字段。属性所在的类可以通过实例方法访问该属性。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46438706492649980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyObject:\n    def __init__(self):\n        self.public_field = 5\n        self.__private_field = 10\n\n    def get_private_field(self):\n        return self.__private_field\n\n\nfoo = MyObject()\nassert foo.get_private_field() == 10`, `46438706492649980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{11}"\n              >\n                <span class="gatsby-code-button-language">py{11}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyObject</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>public_field <span class="token operator">=</span> <span class="token number">5</span>\n        self<span class="token punctuation">.</span>__private_field <span class="token operator">=</span> <span class="token number">10</span>\n\n    <span class="token keyword">def</span> <span class="token function">get_private_field</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>__private_field\n\n\nfoo <span class="token operator">=</span> MyObject<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">assert</span> foo<span class="token punctuation">.</span>get_private_field<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">10</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但如果在类的外面直接通过对象访问 private 字段，那么程序就会抛出异常。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20072584854100615000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyObject:\n    def __init__(self):\n        self.public_field = 5\n        self.__private_field = 10\n\n    def get_private_field(self):\n        return self.__private_field\n\n\nfoo = MyObject()\nfoo.__private_field\n\n>>>\nTraceback ...\nAttributeError: \'MyObject\' object has no attribute \'__private_field\'`, `20072584854100615000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{11}"\n              >\n                <span class="gatsby-code-button-language">py{11}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyObject</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>public_field <span class="token operator">=</span> <span class="token number">5</span>\n        self<span class="token punctuation">.</span>__private_field <span class="token operator">=</span> <span class="token number">10</span>\n\n    <span class="token keyword">def</span> <span class="token function">get_private_field</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>__private_field\n\n\nfoo <span class="token operator">=</span> MyObject<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="gatsby-highlight-code-line">foo<span class="token punctuation">.</span>__private_field</span>\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nAttributeError<span class="token punctuation">:</span> <span class="token string">\'MyObject\'</span> <span class="token builtin">object</span> has no attribute <span class="token string">\'__private_field\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>类方法（@classmethod）可以访问本类的 private 属性，因为这种方法也是在这个类（class）的范围里面声明的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20834165923992633000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyOtherObject:\n    def __init__(self):\n        self.__private_field = 71\n\n    @classmethod\n    def get_private_field_of_instance(cls, instance):\n        return instance.__private_field\n\n\nbar = MyOtherObject()\nassert MyOtherObject.get_private_field_of_instance(bar) == 71`, `20834165923992633000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyOtherObject</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>__private_field <span class="token operator">=</span> <span class="token number">71</span>\n\n    @<span class="token builtin">classmethod</span>\n    <span class="token keyword">def</span> <span class="token function">get_private_field_of_instance</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> instance<span class="token punctuation">.</span>__private_field\n\n\nbar <span class="token operator">=</span> MyOtherObject<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">assert</span> MyOtherObject<span class="token punctuation">.</span>get_private_field_of_instance<span class="token punctuation">(</span>bar<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">71</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>private 字段只给这个类自己使用，子类不能访问超类的 private 字段。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78865886611276190000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyParentObject:\n    def __init__(self):\n        self.__private_field = 71\n\n\nclass MyChildObject(MyParentObject):\n    def get_private_field(self):\n        return self.__private_field\n\n\nbaz = MyChildObject()\nbaz.get_private_field()\n\n>>>\nTraceback ...\nAttributeError: \'MyChildObject\' object has no attribute \'_MyChildObject__private_field\'`, `78865886611276190000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyParentObject</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>__private_field <span class="token operator">=</span> <span class="token number">71</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">MyChildObject</span><span class="token punctuation">(</span>MyParentObject<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">get_private_field</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>__private_field\n\n\nbaz <span class="token operator">=</span> MyChildObject<span class="token punctuation">(</span><span class="token punctuation">)</span>\nbaz<span class="token punctuation">.</span>get_private_field<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nAttributeError<span class="token punctuation">:</span> <span class="token string">\'MyChildObject\'</span> <span class="token builtin">object</span> has no attribute <span class="token string">\'_MyChildObject__private_field\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种防止其他类访问 private 属性的功能，其实仅仅是通过变换属性名称而实现的。当 Python 编译器看到 <code class="language-text">MyChildObject.get_private_field</code> 这样的方法想要访问 <code class="language-text">__private_field</code> 属性时，它会把下划线和类名加在这个属性名称的前面，所以代码实际上访问的是 <code class="language-text">_MyChildObject__private_field</code>。在上面的例子中，<code class="language-text">__private_field</code> 是在 MyParentObject 的 <code class="language-text">__init__</code> 里面定义的，所以，它变换之后的真实名称是 <code class="language-text">_MyParentObject__private_field</code>。子类不能通过 <code class="language-text">__private_field</code> 来访问这个属性，因为这样写实际上是在访问不存在的 <code class="language-text">_MyChildObject__private_field</code>，而不是 <code class="language-text">_MyParentObject__private_field</code>。</p>\n<p>了解名称变换规则后，我们就可以从任何一个类里面访问 private 属性。无论是子类还是外部的类，都可以不经许可就访问到这些属性。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60375153975223330000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyParentObject:\n    def __init__(self):\n        self.__private_field = 71\n\n\nclass MyChildObject(MyParentObject):\n    def get_private_field(self):\n        return self.__private_field\n\n\nbaz = MyChildObject()\nassert baz._MyParentObject__private_field == 71`, `60375153975223330000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{12}"\n              >\n                <span class="gatsby-code-button-language">py{12}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyParentObject</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>__private_field <span class="token operator">=</span> <span class="token number">71</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">MyChildObject</span><span class="token punctuation">(</span>MyParentObject<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">get_private_field</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>__private_field\n\n\nbaz <span class="token operator">=</span> MyChildObject<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="gatsby-highlight-code-line"><span class="token keyword">assert</span> baz<span class="token punctuation">.</span>_MyParentObject__private_field <span class="token operator">==</span> <span class="token number">71</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>查看该对象的属性字典，就会发现 private 属性的名称其实是以变换后的名称存储的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24247533470216710000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`print(baz.__dict__)\n\n>>>\n{\'_MyParentObject__private_field\': 71}`, `24247533470216710000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">print</span><span class="token punctuation">(</span>baz<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token punctuation">{</span><span class="token string">\'_MyParentObject__private_field\'</span><span class="token punctuation">:</span> <span class="token number">71</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>为什么 Python 不从语法上严格禁止其他类访问 private 属性呢？这可以用一句常见的 Python 格言来回答：我们都是成年人了（We are all consenting adults here）。意思是说，我们用不着让编程语言把自己给拦住。你可以按照自己的想法扩展某个类的功能，同时也必须考虑到这样做的风险，并为此负责。Python 开发者相信，虽然开放访问权限可能导致别人不按默认方式扩展这个类，但总比封闭起来要好。</p>\n<p>另外，Python 里面还有一些挂钩函数可以访问到这种属性（参见第 47 条），我们可以通过这些机制按需操纵对象的内部数据。既然这样，那即便 Python 阻止我们通过圆点加名称的办法访问 private 属性，我们也还是有其他办法能访问到，那么 Python 阻止 private 属性访问又有何意义？</p>\n<p>为了减少在不知情情况下访问内部数据而造成的损伤，Python 开发者会按照风格指南里面建议的方式来给字段命名（参见第 2 条）。以单下划线开头的字段（例如 <code class="language-text">_protected_field</code>），习惯上叫作受保护的（protected）字段，表示这个类以外的用户在使用这种字段时必须慎重。</p>\n<p>尽管如此，有许多 Python 新手还是喜欢把内部的 API 设计成 private 字段，想通过这种写法防止子类或外部类访问这些字段。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11438840127894400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyStringClass:\n    def __init__(self, value):\n        self.__value = value\n\n    def get_value(self):\n        return str(self.__value)\n\n\nfoo = MyStringClass(5)\nassert foo.get_value() == \'5\'`, `11438840127894400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyStringClass</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>__value <span class="token operator">=</span> value\n\n    <span class="token keyword">def</span> <span class="token function">get_value</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>__value<span class="token punctuation">)</span>\n\n\nfoo <span class="token operator">=</span> MyStringClass<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>\n<span class="token keyword">assert</span> foo<span class="token punctuation">.</span>get_value<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">\'5\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这么写不对。因为总会有开发者（也包括你自己）想要继承这个类，并给里面添加新的行为，或采用更高效的办法来实现已有的行为（例如他可能觉得，<code class="language-text">MyStringClass.get_value</code> 总是返回字符串的方式的效率不高）。如果把属性设为 private，那么子类在覆盖或扩充这个类的时候，就必须采用变换之后的名称来访问那个属性，这会让代码变得很容易出错。例如，在写这样一个子类时，就不得不去访问超类中的 private 字段。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45208423364486120000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyStringClass:\n    def __init__(self, value):\n        self.__value = value\n\n    def get_value(self):\n        return str(self.__value)\n\n\nclass MyIntegerSubclass(MyStringClass):\n    def get_value(self):\n        return int(self._MyStringClass__value)\n\n\nfoo = MyIntegerSubclass(\'5\')\nassert foo.get_value() == 5`, `45208423364486120000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyStringClass</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>__value <span class="token operator">=</span> value\n\n    <span class="token keyword">def</span> <span class="token function">get_value</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>__value<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">MyIntegerSubclass</span><span class="token punctuation">(</span>MyStringClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">get_value</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token builtin">int</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_MyStringClass__value<span class="token punctuation">)</span>\n\n\nfoo <span class="token operator">=</span> MyIntegerSubclass<span class="token punctuation">(</span><span class="token string">\'5\'</span><span class="token punctuation">)</span>\n<span class="token keyword">assert</span> foo<span class="token punctuation">.</span>get_value<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">5</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写的问题是，如果类体系发生变动，那么引用 private 属性的那些代码就失效了。例如，MyIntegerSubclass 类的直接超类（也就是 MyStringClass）本身现在也继承自一个类（叫作 MyBaseClass），而且它把早前的 <code class="language-text">__value</code> 属性移到了那个类里面。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97173114012470100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyBaseClass:\n    def __init__(self, value):\n        self.__value = value\n\n    def get_value(self):\n        return self.__value\n\n\nclass MyStringClass(MyBaseClass):\n    def get_value(self):\n        return str(super().get_value())  # Updated\n\n\nclass MyIntegerSubclass(MyStringClass):\n    def get_value(self):\n        return int(self._MyStringClass__value)  # Not updated\n\n\nfoo = MyIntegerSubclass(5)\nfoo.get_value()\n\n>>>\nTraceback ...\nAttributeError: \'MyIntegerSubclass\' object has no attribute \'_MyStringClass__value\'`, `97173114012470100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyBaseClass</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>__value <span class="token operator">=</span> value\n\n    <span class="token keyword">def</span> <span class="token function">get_value</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>__value\n\n\n<span class="token keyword">class</span> <span class="token class-name">MyStringClass</span><span class="token punctuation">(</span>MyBaseClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">get_value</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_value<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># Updated</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">MyIntegerSubclass</span><span class="token punctuation">(</span>MyStringClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">get_value</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token builtin">int</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_MyStringClass__value<span class="token punctuation">)</span>  <span class="token comment"># Not updated</span>\n\n\nfoo <span class="token operator">=</span> MyIntegerSubclass<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>\nfoo<span class="token punctuation">.</span>get_value<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nAttributeError<span class="token punctuation">:</span> <span class="token string">\'MyIntegerSubclass\'</span> <span class="token builtin">object</span> has no attribute <span class="token string">\'_MyStringClass__value\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在的 <code class="language-text">__value</code> 属性，是在 MyBaseClass 里面设置的，而不是在 MyStringClass 里面，所以 MyIntegerSubclass 没办法再通过 <code class="language-text">self._MyStringClass__value</code> 访问这个属性。</p>\n<p>一般来说，这种属性应该设置成 protected 字段，这样虽然有可能导致子类误用，但还是要比直接设为 private 好。我们可以在每个 protected 字段的文档里面详细解释，告诉用户这是属于可以由子类来操作的内部 API，还是属于完全不应该触碰的数据。这样的文档，既可以给别人提供建议，也可以指导自己安全地扩充代码。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6551820363986915000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyStringClass:\n    def __init__(self, value):\n        # This stores the user-supplied value for the object.\n        # It should be coercible to a string. Once assigned in\n        # the object it should be treated as immutable.\n        self._value = value`, `6551820363986915000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyStringClass</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token comment"># This stores the user-supplied value for the object.</span>\n        <span class="token comment"># It should be coercible to a string. Once assigned in</span>\n        <span class="token comment"># the object it should be treated as immutable.</span>\n        self<span class="token punctuation">.</span>_value <span class="token operator">=</span> value</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>只有一种情况是可以考虑用 private 属性解决的，就是子类属性有可能与超类重名的情况。如果子类定义属性时使用的名称，恰巧与超类相同，那就会出现这个问题。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35777196272945377000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class ApiClass:\n    def __init__(self):\n        self._value = 5\n\n    def get(self):\n        return self._value\n\n\nclass Child(ApiClass):\n    def __init__(self):\n        super().__init__()\n        self._value = \'hello\'  # Conflicts\n\n\na = Child()\nprint(f\'{a.get()} and {a._value} should be different\')`, `35777196272945377000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">ApiClass</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_value <span class="token operator">=</span> <span class="token number">5</span>\n\n    <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_value\n\n\n<span class="token keyword">class</span> <span class="token class-name">Child</span><span class="token punctuation">(</span>ApiClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>_value <span class="token operator">=</span> <span class="token string">\'hello\'</span>  <span class="token comment"># Conflicts</span>\n\n\na <span class="token operator">=</span> Child<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>a<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> and </span><span class="token interpolation"><span class="token punctuation">{</span>a<span class="token punctuation">.</span>_value<span class="token punctuation">}</span></span><span class="token string"> should be different\'</span></span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果超类属于开放给外界使用的 API，那么你就没办法预料哪些子类会继承它，也不知道那些子类会添加什么属性，此时很有可能出现这个问题，而且你无法通过重构代码来解决。属性名越常见（如本例中的 value），越容易发生冲突。为了减少冲突，我们可以把超类的属性设计成 private 属性，使子类的属性名不太可能与超类重复。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47450197673098720000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class ApiClass:\n    def __init__(self):\n        self.__value = 5  # Double underscore\n\n    def get(self):\n        return self.__value  # Double underscore\n\n\nclass Child(ApiClass):\n    def __init__(self):\n        super().__init__()\n        self._value = \'hello\'  # OK!\n\n\na = Child()\nprint(f\'{a.get()} and {a._value} are different\')`, `47450197673098720000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">ApiClass</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>__value <span class="token operator">=</span> <span class="token number">5</span>  <span class="token comment"># Double underscore</span>\n\n    <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>__value  <span class="token comment"># Double underscore</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Child</span><span class="token punctuation">(</span>ApiClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>_value <span class="token operator">=</span> <span class="token string">\'hello\'</span>  <span class="token comment"># OK!</span>\n\n\na <span class="token operator">=</span> Child<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>a<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> and </span><span class="token interpolation"><span class="token punctuation">{</span>a<span class="token punctuation">.</span>_value<span class="token punctuation">}</span></span><span class="token string"> are different\'</span></span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="总结-38"><a href="#%E6%80%BB%E7%BB%93-38" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>Python 编译器无法绝对禁止外界访问 private 属性。</li>\n<li>从一开始就应该考虑允许其他类能继承这个类，并利用其中的内部 API 与属性去实现更多功能，而不是把它们藏起来。</li>\n<li>把需要保护的数据设计成 protected 字段，并用文档加以解释，而不要通过 private 属性限制访问。</li>\n<li>只有在子类不受控制且名称有可能与超类冲突时，才可以考虑给超类设计 private 属性。</li>\n</ol>\n<h2 id="第-43-条：自定义的容器类型应该从-collectionsabc-继承"><a href="#%E7%AC%AC-43-%E6%9D%A1%EF%BC%9A%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84%E5%AE%B9%E5%99%A8%E7%B1%BB%E5%9E%8B%E5%BA%94%E8%AF%A5%E4%BB%8E-collectionsabc-%E7%BB%A7%E6%89%BF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 43 条：自定义的容器类型应该从 collections.abc 继承</h2>\n<p>编写 Python 程序时，要花很多精力来定义类，以存放数据并描述这种对象与其他对象之间的关系。每个 Python 类其实都是某种容器，可以把属性与功能封装进来。除了自定义的类之外，Python 本身还提供了一些内置的容器类型，例如列表（list）、元组（tuple）、集合（set）、字典（dict）等，也可以用来管理数据。</p>\n<p>如果要定义的是那种用法比较简单的类，那么我们自然就会想到直接从 Python 内置的容器类型里面继承，例如通过继承 list 类型实现某种序列。下面就是笔者自己定制的一种 list 类型，它在 list 的基础上提供了 frequency 方法，用来计算每个元素出现的次数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25483618808695276000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class FrequencyList(list):\n    def __init__(self, members):\n        super().__init__(members)\n\n    def frequency(self):\n        counts = {}\n        for item in self:\n            counts[item] = counts.get(item, 0) + 1\n        return counts`, `25483618808695276000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">FrequencyList</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> members<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>members<span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">frequency</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        counts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n        <span class="token keyword">for</span> item <span class="token keyword">in</span> self<span class="token punctuation">:</span>\n            counts<span class="token punctuation">[</span>item<span class="token punctuation">]</span> <span class="token operator">=</span> counts<span class="token punctuation">.</span>get<span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>\n        <span class="token keyword">return</span> counts</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>继承 list 类，可以自动获得标准的 Python 列表所具备的各项功能。这样的话，其他开发者就可以像使用普通列表那样使用 FrequencyList 了。此外，我们还可以定义其他一些方法，来提供想要实现的各种行为。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22077746133313393000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class FrequencyList(list):\n    def __init__(self, members):\n        super().__init__(members)\n\n    def frequency(self):\n        counts = {}\n        for item in self:\n            counts[item] = counts.get(item, 0) + 1\n        return counts\n\n\nfoo = FrequencyList([\'a\', \'b\', \'a\', \'c\', \'b\', \'a\', \'d\'])\nprint(\'Length is\', len(foo))\n\nprint(foo.pop())\nprint(\'After pop:\', repr(foo))\nprint(\'Frequency:\', foo.frequency())\n\n>>>\nLength is 7\nd\nAfter pop: [\'a\', \'b\', \'a\', \'c\', \'b\', \'a\']\nFrequency: {\'a\': 3, \'b\': 2, \'c\': 1}`, `22077746133313393000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{12-17}"\n              >\n                <span class="gatsby-code-button-language">py{12-17}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">FrequencyList</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> members<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>members<span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">frequency</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        counts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n        <span class="token keyword">for</span> item <span class="token keyword">in</span> self<span class="token punctuation">:</span>\n            counts<span class="token punctuation">[</span>item<span class="token punctuation">]</span> <span class="token operator">=</span> counts<span class="token punctuation">.</span>get<span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>\n        <span class="token keyword">return</span> counts\n\n\n<span class="gatsby-highlight-code-line">foo <span class="token operator">=</span> FrequencyList<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Length is\'</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line"><span class="token keyword">print</span><span class="token punctuation">(</span>foo<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After pop:\'</span><span class="token punctuation">,</span> <span class="token builtin">repr</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Frequency:\'</span><span class="token punctuation">,</span> foo<span class="token punctuation">.</span>frequency<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>\n<span class="token operator">>></span><span class="token operator">></span>\nLength <span class="token keyword">is</span> <span class="token number">7</span>\nd\nAfter pop<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'a\'</span><span class="token punctuation">]</span>\nFrequency<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'a\'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>有的时候，某个对象所属的类本身虽然不是 list 的子类，但我们还是想让它能像 list 那样，可以通过下标来访问。例如，下面这个表示二叉树节点的 BinaryNode 类就不是 list 的子类，但我们想让它能够像序列（list 或 tuple 等）那样，通过下标来访问。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2990806926632206000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class BinaryNode:\n    def __init__(self, value, left=None, right=None):\n        self.value = value\n        self.left = left\n        self.right = right`, `2990806926632206000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">BinaryNode</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">,</span> left<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> right<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value\n        self<span class="token punctuation">.</span>left <span class="token operator">=</span> left\n        self<span class="token punctuation">.</span>right <span class="token operator">=</span> right</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们需要怎么做，才能让这个类可以像序列一样访问呢？答案是，需要实现一些名称特殊的实例方法。当通过下标访问序列中的元素时：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64595546924150640000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`bar = [1, 2, 3]\nbar[0]`, `64595546924150640000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">bar <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>\nbar<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>Python 会把访问操作解读为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24648399834134450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`bar.__getitem__(0)`, `24648399834134450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">bar<span class="token punctuation">.</span>__getitem__<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>所以，为了让 BinaryNode 类能像序列那样使用，我们可以定义 <code class="language-text">__getitem__</code> 方法（一般叫作 dunder getitem，其中的 dunder 为 double underscore（双下划线）的简称）。这个方法可以按照深度优先的方式遍历 BinaryNode 对象所表示的二叉树。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67405795323377360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class BinaryNode:\n    def __init__(self, value, left=None, right=None):\n        self.value = value\n        self.left = left\n        self.right = right\n\n\nclass IndexableNode(BinaryNode):\n    def _traverse(self):\n        if self.left is not None:\n            yield from self.left._traverse()\n        yield self\n        if self.right is not None:\n            yield from self.right._traverse()\n\n    def __getitem__(self, index):\n        for i, item in enumerate(self._traverse()):\n            if i == index:\n                return item.value\n        raise IndexError(f\'Index {index} is out of range\')\n\n\ntree = IndexableNode(\n    10,\n    left=IndexableNode(\n        5,\n        left=IndexableNode(2),\n        right=IndexableNode(\n            6,\n            right=IndexableNode(7))),\n    right=IndexableNode(\n        15,\n        left=IndexableNode(11)))\n\nprint(\'LRR is\', tree.left.right.right.value)\nprint(\'Index 0 is\', tree[0])\nprint(\'Index 1 is\', tree[1])\nprint(\'11 in the tree?\', 11 in tree)\nprint(\'17 in the tree?\', 17 in tree)\nprint(\'Tree is\', list(tree))\n\n>>>\nLRR is 7\nIndex 0 is 2\nIndex 1 is 5\n11 in the tree? True\n17 in the tree? False\nTree is [2, 5, 6, 7, 10, 11, 15]`, `67405795323377360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">BinaryNode</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">,</span> left<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> right<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value\n        self<span class="token punctuation">.</span>left <span class="token operator">=</span> left\n        self<span class="token punctuation">.</span>right <span class="token operator">=</span> right\n\n\n<span class="token keyword">class</span> <span class="token class-name">IndexableNode</span><span class="token punctuation">(</span>BinaryNode<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">_traverse</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> self<span class="token punctuation">.</span>left <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n            <span class="token keyword">yield</span> <span class="token keyword">from</span> self<span class="token punctuation">.</span>left<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">yield</span> self\n        <span class="token keyword">if</span> self<span class="token punctuation">.</span>right <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n            <span class="token keyword">yield</span> <span class="token keyword">from</span> self<span class="token punctuation">.</span>right<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">for</span> i<span class="token punctuation">,</span> item <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">if</span> i <span class="token operator">==</span> index<span class="token punctuation">:</span>\n                <span class="token keyword">return</span> item<span class="token punctuation">.</span>value\n        <span class="token keyword">raise</span> IndexError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Index </span><span class="token interpolation"><span class="token punctuation">{</span>index<span class="token punctuation">}</span></span><span class="token string"> is out of range\'</span></span><span class="token punctuation">)</span>\n\n\ntree <span class="token operator">=</span> IndexableNode<span class="token punctuation">(</span>\n    <span class="token number">10</span><span class="token punctuation">,</span>\n    left<span class="token operator">=</span>IndexableNode<span class="token punctuation">(</span>\n        <span class="token number">5</span><span class="token punctuation">,</span>\n        left<span class="token operator">=</span>IndexableNode<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        right<span class="token operator">=</span>IndexableNode<span class="token punctuation">(</span>\n            <span class="token number">6</span><span class="token punctuation">,</span>\n            right<span class="token operator">=</span>IndexableNode<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    right<span class="token operator">=</span>IndexableNode<span class="token punctuation">(</span>\n        <span class="token number">15</span><span class="token punctuation">,</span>\n        left<span class="token operator">=</span>IndexableNode<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'LRR is\'</span><span class="token punctuation">,</span> tree<span class="token punctuation">.</span>left<span class="token punctuation">.</span>right<span class="token punctuation">.</span>right<span class="token punctuation">.</span>value<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Index 0 is\'</span><span class="token punctuation">,</span> tree<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Index 1 is\'</span><span class="token punctuation">,</span> tree<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'11 in the tree?\'</span><span class="token punctuation">,</span> <span class="token number">11</span> <span class="token keyword">in</span> tree<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'17 in the tree?\'</span><span class="token punctuation">,</span> <span class="token number">17</span> <span class="token keyword">in</span> tree<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Tree is\'</span><span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">(</span>tree<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nLRR <span class="token keyword">is</span> <span class="token number">7</span>\nIndex <span class="token number">0</span> <span class="token keyword">is</span> <span class="token number">2</span>\nIndex <span class="token number">1</span> <span class="token keyword">is</span> <span class="token number">5</span>\n<span class="token number">11</span> <span class="token keyword">in</span> the tree? <span class="token boolean">True</span>\n<span class="token number">17</span> <span class="token keyword">in</span> the tree? <span class="token boolean">False</span>\nTree <span class="token keyword">is</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们可以像使用 BinaryNode 那样，用这种定制过的 IndexableNode 对象来构造二叉树。</p>\n<p>我们既可以像访问列表那样来访问二叉树中的节点，也可以明确通过 left 与 right 属性来访问。</p>\n<p>但问题是，除了下标索引，list 实例还支持其他一些功能，所以只实现 <code class="language-text">__getitem__</code> 这样一个特殊方法是不够的。例如，我们现在还是没办法像查询 list 长度那样查询这种二叉树的长度（元素总数）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19254580459918926000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`len(tree)\n\n>>>\nTraceback ...\nTypeError: object of type \'IndexableNode\' has no len()`, `19254580459918926000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token builtin">len</span><span class="token punctuation">(</span>tree<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> <span class="token builtin">object</span> of <span class="token builtin">type</span> <span class="token string">\'IndexableNode\'</span> has no <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>要想让定制的二叉树支持内置的 len 函数，必须再实现一个特殊方法，也就是 <code class="language-text">__len__</code> 方法。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85213444422410130000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class BinaryNode:\n    def __init__(self, value, left=None, right=None):\n        self.value = value\n        self.left = left\n        self.right = right\n\n\nclass SequenceNode(BinaryNode):\n    def _traverse(self):\n        if self.left is not None:\n            yield from self.left._traverse()\n        yield self\n        if self.right is not None:\n            yield from self.right._traverse()\n\n    def __getitem__(self, index):\n        for i, item in enumerate(self._traverse()):\n            if i == index:\n                return item.value\n        raise IndexError(f\'Index {index} is out of range\')\n\n    def __len__(self):\n        for count, _ in enumerate(self._traverse(), 1):\n            pass\n        return count\n\n\ntree = SequenceNode(\n    10,\n    left=SequenceNode(\n        5,\n        left=SequenceNode(2),\n        right=SequenceNode(\n            6,\n            right=SequenceNode(7))),\n    right=SequenceNode(\n        15,\n        left=SequenceNode(11)))\n\nprint(\'Tree length is\', len(tree))\n\n>>>\nTree length is 7`, `85213444422410130000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py{22-25}"\n              >\n                <span class="gatsby-code-button-language">py{22-25}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">BinaryNode</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">,</span> left<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> right<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value\n        self<span class="token punctuation">.</span>left <span class="token operator">=</span> left\n        self<span class="token punctuation">.</span>right <span class="token operator">=</span> right\n\n\n<span class="token keyword">class</span> <span class="token class-name">SequenceNode</span><span class="token punctuation">(</span>BinaryNode<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">_traverse</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> self<span class="token punctuation">.</span>left <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n            <span class="token keyword">yield</span> <span class="token keyword">from</span> self<span class="token punctuation">.</span>left<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">yield</span> self\n        <span class="token keyword">if</span> self<span class="token punctuation">.</span>right <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n            <span class="token keyword">yield</span> <span class="token keyword">from</span> self<span class="token punctuation">.</span>right<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">for</span> i<span class="token punctuation">,</span> item <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">if</span> i <span class="token operator">==</span> index<span class="token punctuation">:</span>\n                <span class="token keyword">return</span> item<span class="token punctuation">.</span>value\n        <span class="token keyword">raise</span> IndexError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Index </span><span class="token interpolation"><span class="token punctuation">{</span>index<span class="token punctuation">}</span></span><span class="token string"> is out of range\'</span></span><span class="token punctuation">)</span>\n\n<span class="gatsby-highlight-code-line">    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">for</span> count<span class="token punctuation">,</span> _ <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">            <span class="token keyword">pass</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">return</span> count</span>\n\ntree <span class="token operator">=</span> SequenceNode<span class="token punctuation">(</span>\n    <span class="token number">10</span><span class="token punctuation">,</span>\n    left<span class="token operator">=</span>SequenceNode<span class="token punctuation">(</span>\n        <span class="token number">5</span><span class="token punctuation">,</span>\n        left<span class="token operator">=</span>SequenceNode<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        right<span class="token operator">=</span>SequenceNode<span class="token punctuation">(</span>\n            <span class="token number">6</span><span class="token punctuation">,</span>\n            right<span class="token operator">=</span>SequenceNode<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    right<span class="token operator">=</span>SequenceNode<span class="token punctuation">(</span>\n        <span class="token number">15</span><span class="token punctuation">,</span>\n        left<span class="token operator">=</span>SequenceNode<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Tree length is\'</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>tree<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTree length <span class="token keyword">is</span> <span class="token number">7</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>实现完这样两个方法之后，我们仍然没办法让这种二叉树具备列表所应支持的全套功能。因为，有些 Python 开发者可能还想在二叉树上面调用 count 与 index 等方法，他们觉得，既然 list 或 tuple 这样的序列支持这些方法，那二叉树也应该支持才对。这样看来，要定制一个与标准容器兼容的类，似乎比想象中麻烦。</p>\n<p>为了方便大家定制容器，Python 内置的 collections.abc 模块定义了一系列抽象基类（abstract base class），把每种容器类型应该提供的所有常用方法都写了出来。我们只需要从这样的抽象基类里面继承就好。同时，如果忘了实现某些必备的方法，那么程序会报错，提醒我们这些方法必须实现。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34944432292532433000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from collections.abc import Sequence\n\n\nclass BadType(Sequence):\n    pass\n\n\nfoo = BadType()\n\n>>>\nTraceback ...\nTypeError: Can\'t instantiate abstract class BadType with abstract methods __getitem__, __len__`, `34944432292532433000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> collections<span class="token punctuation">.</span>abc <span class="token keyword">import</span> Sequence\n\n\n<span class="token keyword">class</span> <span class="token class-name">BadType</span><span class="token punctuation">(</span>Sequence<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\nfoo <span class="token operator">=</span> BadType<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> Can\'t instantiate abstract <span class="token keyword">class</span> <span class="token class-name">BadType</span> <span class="token keyword">with</span> abstract methods __getitem__<span class="token punctuation">,</span> __len__</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果这些必备的方法都已经实现好了，那我们就可以从 collections.abc 模块的抽象基类里面继承了。例如，下面这个 BetterNode 二叉树类就是正确的，因为它已经通过继承前面的 SequenceNode 类实现了序列容器所应支持的全部必备方法，至于其他一些方法（例如 index 与 count）则会由 Sequence 这个抽象基类自动帮我们实现（它在实现的时候，会借助 BetterNode 从 SequenceNode 继承的那些必备方法）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63038061580310315000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from collections.abc import Sequence\n\n\nclass BinaryNode:\n    def __init__(self, value, left=None, right=None):\n        self.value = value\n        self.left = left\n        self.right = right\n\n\nclass SequenceNode(BinaryNode):\n    def _traverse(self):\n        if self.left is not None:\n            yield from self.left._traverse()\n        yield self\n        if self.right is not None:\n            yield from self.right._traverse()\n\n    def __getitem__(self, index):\n        for i, item in enumerate(self._traverse()):\n            if i == index:\n                return item.value\n        raise IndexError(f\'Index {index} is out of range\')\n\n    def __len__(self):\n        for count, _ in enumerate(self._traverse(), 1):\n            pass\n        return count\n\n\nclass BetterNode(SequenceNode, Sequence):\n    pass\n\n\ntree = BetterNode(\n    10,\n    left=BetterNode(\n        5,\n        left=BetterNode(2),\n        right=BetterNode(\n            6,\n            right=BetterNode(7))),\n    right=BetterNode(\n        15,\n        left=BetterNode(11))\n)\n\nprint(\'Index of 7 is\', tree.index(7))\nprint(\'Count of 10 is\', tree.count(10))\n\n>>>\nIndex of 7 is 3\nCount of 10 is 1`, `63038061580310315000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> collections<span class="token punctuation">.</span>abc <span class="token keyword">import</span> Sequence\n\n\n<span class="token keyword">class</span> <span class="token class-name">BinaryNode</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">,</span> left<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> right<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value\n        self<span class="token punctuation">.</span>left <span class="token operator">=</span> left\n        self<span class="token punctuation">.</span>right <span class="token operator">=</span> right\n\n\n<span class="token keyword">class</span> <span class="token class-name">SequenceNode</span><span class="token punctuation">(</span>BinaryNode<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">_traverse</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> self<span class="token punctuation">.</span>left <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n            <span class="token keyword">yield</span> <span class="token keyword">from</span> self<span class="token punctuation">.</span>left<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">yield</span> self\n        <span class="token keyword">if</span> self<span class="token punctuation">.</span>right <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n            <span class="token keyword">yield</span> <span class="token keyword">from</span> self<span class="token punctuation">.</span>right<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">for</span> i<span class="token punctuation">,</span> item <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">if</span> i <span class="token operator">==</span> index<span class="token punctuation">:</span>\n                <span class="token keyword">return</span> item<span class="token punctuation">.</span>value\n        <span class="token keyword">raise</span> IndexError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Index </span><span class="token interpolation"><span class="token punctuation">{</span>index<span class="token punctuation">}</span></span><span class="token string"> is out of range\'</span></span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">for</span> count<span class="token punctuation">,</span> _ <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_traverse<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">pass</span>\n        <span class="token keyword">return</span> count\n\n\n<span class="token keyword">class</span> <span class="token class-name">BetterNode</span><span class="token punctuation">(</span>SequenceNode<span class="token punctuation">,</span> Sequence<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\ntree <span class="token operator">=</span> BetterNode<span class="token punctuation">(</span>\n    <span class="token number">10</span><span class="token punctuation">,</span>\n    left<span class="token operator">=</span>BetterNode<span class="token punctuation">(</span>\n        <span class="token number">5</span><span class="token punctuation">,</span>\n        left<span class="token operator">=</span>BetterNode<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        right<span class="token operator">=</span>BetterNode<span class="token punctuation">(</span>\n            <span class="token number">6</span><span class="token punctuation">,</span>\n            right<span class="token operator">=</span>BetterNode<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    right<span class="token operator">=</span>BetterNode<span class="token punctuation">(</span>\n        <span class="token number">15</span><span class="token punctuation">,</span>\n        left<span class="token operator">=</span>BetterNode<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token punctuation">)</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Index of 7 is\'</span><span class="token punctuation">,</span> tree<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Count of 10 is\'</span><span class="token punctuation">,</span> tree<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nIndex of <span class="token number">7</span> <span class="token keyword">is</span> <span class="token number">3</span>\nCount of <span class="token number">10</span> <span class="token keyword">is</span> <span class="token number">1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>对于定制集合或可变映射等复杂的容器类型来说，继承 collections.abc 模块里的 Set 或 MutableMapping 等抽象基类所带来的好处会更加明显。假如自己从头开始实现，那必须编写大量的特殊方法才能让这些容器类的对象也能像标准的 Python 容器那样使用。</p>\n<p>collections.abc 模块要求子类必须实现某些特殊方法，另外，Python 在比较或排列对象时，还会用到其他一些特殊方法，无论定制的是不是容器类，有时为了支持某些功能，你都必须定义相关的特殊方法才行（案例参见第 73 条）。</p>\n<h3 id="总结-39"><a href="#%E6%80%BB%E7%BB%93-39" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>如果要编写的新类比较简单，那么可以直接从 Python 的容器类型（例如 list 或 dict）里面继承。</li>\n<li>如果想让定制的容器类型能像标准的 Python 容器那样使用，那么有可能要编写许多特殊方法。</li>\n<li>可以从 collections.abc 模块里的抽象基类之中派生自己的容器类型，这样可以让容器自动具备相关的功能，同时又可以保证没有把实现这些功能所必备的方法给漏掉。</li>\n</ol>\n<h1 id="元类与属性"><a href="#%E5%85%83%E7%B1%BB%E4%B8%8E%E5%B1%9E%E6%80%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>元类与属性</h1>\n<h2 id="第-44-条：用纯属性与修饰器取代旧式的-setter-与-getter-方法"><a href="#%E7%AC%AC-44-%E6%9D%A1%EF%BC%9A%E7%94%A8%E7%BA%AF%E5%B1%9E%E6%80%A7%E4%B8%8E%E4%BF%AE%E9%A5%B0%E5%99%A8%E5%8F%96%E4%BB%A3%E6%97%A7%E5%BC%8F%E7%9A%84-setter-%E4%B8%8E-getter-%E6%96%B9%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 44 条：用纯属性与修饰器取代旧式的 setter 与 getter 方法</h2>\n<p>从其他编程语言转入 Python 的开发者，可能想在类里面明确地实现 getter 与 setter 方法。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89604871475169600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class OldResistor:\n    def __init__(self, ohms):\n        self._ohms = ohms\n\n    def get_ohms(self):\n        return self._ohms\n\n    def set_ohms(self, ohms):\n        self._ohms = ohms`, `89604871475169600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">OldResistor</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ohms<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_ohms <span class="token operator">=</span> ohms\n\n    <span class="token keyword">def</span> <span class="token function">get_ohms</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_ohms\n\n    <span class="token keyword">def</span> <span class="token function">set_ohms</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ohms<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_ohms <span class="token operator">=</span> ohms</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>虽然这些 setter 与 getter 用起来很简单，但这并不符合 Python 的风格。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89378269175501130000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`r0 = OldResistor(50e3)\nprint(\'Before:\', r0.get_ohms())\nr0.set_ohms(10e3)\nprint(\'After: \', r0.get_ohms())\n\n>>>\nBefore: 50000.0\nAfter:  10000.0`, `89378269175501130000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">r0 <span class="token operator">=</span> OldResistor<span class="token punctuation">(</span><span class="token number">50e3</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Before:\'</span><span class="token punctuation">,</span> r0<span class="token punctuation">.</span>get_ohms<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\nr0<span class="token punctuation">.</span>set_ohms<span class="token punctuation">(</span><span class="token number">10e3</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After: \'</span><span class="token punctuation">,</span> r0<span class="token punctuation">.</span>get_ohms<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore<span class="token punctuation">:</span> <span class="token number">50000.0</span>\nAfter<span class="token punctuation">:</span>  <span class="token number">10000.0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>例如，想让属性值变大或者变小，采用这些方法来写会特别麻烦。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46978325101157110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`r0.set_ohms(r0.get_ohms() - 4e3)\nassert r0.get_ohms() == 6e3`, `46978325101157110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">r0<span class="token punctuation">.</span>set_ohms<span class="token punctuation">(</span>r0<span class="token punctuation">.</span>get_ohms<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">4e3</span><span class="token punctuation">)</span>\n<span class="token keyword">assert</span> r0<span class="token punctuation">.</span>get_ohms<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">6e3</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>这种工具方法确实有助于将类的接口定义得更加清晰，并方便开发者封装功能、验证用法、划定界限。这些都是在设计类时应该考虑的目标，实现这些目标可以确保我们在完善这个类的过程中不影响已经写好的调用代码。</p>\n<p>可是，在 Python 中实现这些目标时，没必要明确定义 setter 与 getter 方法。而是应该从最简单的 public 属性开始写起，例如像下面这样：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73081325502461270000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Resistor:\n    def __init__(self, ohms):\n        self.ohms = ohms\n        self.voltage = 0\n        self.current = 0\n\n\nr1 = Resistor(50e3)\nr1.ohms = 10e3`, `73081325502461270000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Resistor</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ohms<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>ohms <span class="token operator">=</span> ohms\n        self<span class="token punctuation">.</span>voltage <span class="token operator">=</span> <span class="token number">0</span>\n        self<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token number">0</span>\n\n\nr1 <span class="token operator">=</span> Resistor<span class="token punctuation">(</span><span class="token number">50e3</span><span class="token punctuation">)</span>\nr1<span class="token punctuation">.</span>ohms <span class="token operator">=</span> <span class="token number">10e3</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>按照这种写法，很容易就能实现原地增减属性值。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47939172988294290000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`r1.ohms += 5e3`, `47939172988294290000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">r1<span class="token punctuation">.</span>ohms <span class="token operator">+=</span> <span class="token number">5e3</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>将来如果想在设置属性时，实现特别的功能，那么可以先通过 @property 修饰器来封装获取属性的那个方法，并在封装出来的修饰器上面通过 setter 属性来封装设置属性的那个方法（参见第 26 条）。下面这个新类继承自刚才的 Resistor 类，它允许我们通过设置 voltage（电压）属性来改变 current（电流）。为了正确实现这项功能，必须保证设置属性与获取属性所用的那两个方法都跟属性同名。</p>\n<p>按照这种写法，给 voltage 属性赋值会触发同名的 setter 方法，该方法会根据新的 voltage 计算本对象的 current 属性。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65393353720905155000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Resistor:\n    def __init__(self, ohms):\n        self.ohms = ohms\n        self.voltage = 0\n        self.current = 0\n\n\nclass VoltageResistance(Resistor):\n    def __init__(self, ohms):\n        super().__init__(ohms)\n        self._voltage = 0\n\n    @property\n    def voltage(self):\n        return self._voltage\n\n    @voltage.setter\n    def voltage(self, voltage):\n        self._voltage = voltage\n        self.current = self._voltage / self.ohms\n\n\nr2 = VoltageResistance(1e3)\nprint(f\'Before: {r2.current: .2f} amps\')\nr2.voltage = 10\nprint(f\'After:  {r2.current: .2f} amps\')\n\n>>>\nBefore:  0.00 amps\nAfter:   0.01 amps`, `65393353720905155000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Resistor</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ohms<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>ohms <span class="token operator">=</span> ohms\n        self<span class="token punctuation">.</span>voltage <span class="token operator">=</span> <span class="token number">0</span>\n        self<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token number">0</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">VoltageResistance</span><span class="token punctuation">(</span>Resistor<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ohms<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>ohms<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>_voltage <span class="token operator">=</span> <span class="token number">0</span>\n\n    @<span class="token builtin">property</span>\n    <span class="token keyword">def</span> <span class="token function">voltage</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_voltage\n\n    @voltage<span class="token punctuation">.</span>setter\n    <span class="token keyword">def</span> <span class="token function">voltage</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> voltage<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_voltage <span class="token operator">=</span> voltage\n        self<span class="token punctuation">.</span>current <span class="token operator">=</span> self<span class="token punctuation">.</span>_voltage <span class="token operator">/</span> self<span class="token punctuation">.</span>ohms\n\n\nr2 <span class="token operator">=</span> VoltageResistance<span class="token punctuation">(</span><span class="token number">1e3</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Before: </span><span class="token interpolation"><span class="token punctuation">{</span>r2<span class="token punctuation">.</span>current<span class="token punctuation">:</span><span class="token format-spec"> .2f</span><span class="token punctuation">}</span></span><span class="token string"> amps\'</span></span><span class="token punctuation">)</span>\nr2<span class="token punctuation">.</span>voltage <span class="token operator">=</span> <span class="token number">10</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'After:  </span><span class="token interpolation"><span class="token punctuation">{</span>r2<span class="token punctuation">.</span>current<span class="token punctuation">:</span><span class="token format-spec"> .2f</span><span class="token punctuation">}</span></span><span class="token string"> amps\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore<span class="token punctuation">:</span>  <span class="token number">0.00</span> amps\nAfter<span class="token punctuation">:</span>   <span class="token number">0.01</span> amps</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>为属性指定 setter 方法还可以用来检查调用方所传入的值在类型与范围上是否符合要求。例如，下面这个 Resistor 子类可以确保用户设置的电阻值总是大于 0 的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65102177600835830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Resistor:\n    def __init__(self, ohms):\n        self.ohms = ohms\n        self.voltage = 0\n        self.current = 0\n\n\nclass BoundedResistance(Resistor):\n    def __init__(self, ohms):\n        super().__init__(ohms)\n\n    @property\n    def ohms(self):\n        return self._ohms\n\n    @ohms.setter\n    def ohms(self, ohms):\n        if ohms <= 0:\n            raise ValueError(f\'ohms must be > 0; got {ohms}\')\n        self._ohms = ohms\n\n\nr3 = BoundedResistance(1e3)\nr3.ohms = 0\n\n>>>\nTraceback ...\nValueError: ohms must be > 0; got 0`, `65102177600835830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Resistor</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ohms<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>ohms <span class="token operator">=</span> ohms\n        self<span class="token punctuation">.</span>voltage <span class="token operator">=</span> <span class="token number">0</span>\n        self<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token number">0</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">BoundedResistance</span><span class="token punctuation">(</span>Resistor<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ohms<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>ohms<span class="token punctuation">)</span>\n\n    @<span class="token builtin">property</span>\n    <span class="token keyword">def</span> <span class="token function">ohms</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_ohms\n\n    @ohms<span class="token punctuation">.</span>setter\n    <span class="token keyword">def</span> <span class="token function">ohms</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ohms<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> ohms <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'ohms must be > 0; got </span><span class="token interpolation"><span class="token punctuation">{</span>ohms<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>_ohms <span class="token operator">=</span> ohms\n\n\nr3 <span class="token operator">=</span> BoundedResistance<span class="token punctuation">(</span><span class="token number">1e3</span><span class="token punctuation">)</span>\nr3<span class="token punctuation">.</span>ohms <span class="token operator">=</span> <span class="token number">0</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nValueError<span class="token punctuation">:</span> ohms must be <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span> got <span class="token number">0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果构造时所用的值无效，那么同样会触发异常。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16088320744431960000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`BoundedResistance(-5)\n\n>>>\nValueError: ohms must be > 0; got -5`, `16088320744431960000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">BoundedResistance<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nValueError<span class="token punctuation">:</span> ohms must be <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span> got <span class="token operator">-</span><span class="token number">5</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>之所以会出现这种效果，是因为子类的构造器（<code class="language-text">BoundedResistance.__init__</code>）会调用超类的构造器（<code class="language-text">Resistor.__init__</code>），而超类的构造器会把 self.ohms 设置成 -5。于是，就会触发 BoundedResistance 里面的 <code class="language-text">@ohms.setter</code> 方法，该方法立刻发现属性值无效，所以程序在对象还没有构造完之前，就会抛出异常。</p>\n<p>我们还可以利用 @property 阻止用户修改超类中的属性。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81778351042031930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Resistor:\n    def __init__(self, ohms):\n        self.ohms = ohms\n        self.voltage = 0\n        self.current = 0\n\n\nclass FixedResistance(Resistor):\n    def __init__(self, ohms):\n        super().__init__(ohms)\n\n    @property\n    def ohms(self):\n        return self._ohms\n\n    @ohms.setter\n    def ohms(self, ohms):\n        if hasattr(self, \'_ohms\'):\n            raise AttributeError(&quot;Ohms is immutable&quot;)\n        self._ohms = ohms\n\n\nr4 = FixedResistance(1e3)\nr4.ohms = 2e3\n\n>>>\nTraceback ...\nAttributeError: Ohms is immutable`, `81778351042031930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Resistor</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ohms<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>ohms <span class="token operator">=</span> ohms\n        self<span class="token punctuation">.</span>voltage <span class="token operator">=</span> <span class="token number">0</span>\n        self<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token number">0</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">FixedResistance</span><span class="token punctuation">(</span>Resistor<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ohms<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>ohms<span class="token punctuation">)</span>\n\n    @<span class="token builtin">property</span>\n    <span class="token keyword">def</span> <span class="token function">ohms</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_ohms\n\n    @ohms<span class="token punctuation">.</span>setter\n    <span class="token keyword">def</span> <span class="token function">ohms</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ohms<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">\'_ohms\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span> AttributeError<span class="token punctuation">(</span><span class="token string">"Ohms is immutable"</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>_ohms <span class="token operator">=</span> ohms\n\n\nr4 <span class="token operator">=</span> FixedResistance<span class="token punctuation">(</span><span class="token number">1e3</span><span class="token punctuation">)</span>\nr4<span class="token punctuation">.</span>ohms <span class="token operator">=</span> <span class="token number">2e3</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nAttributeError<span class="token punctuation">:</span> Ohms <span class="token keyword">is</span> immutable</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>构造好对象之后，如果试图给属性赋值，那么程序就会抛出异常。</p>\n<p>用 @property 实现 setter 与 getter 时，还应该注意不要让对象产生反常的行为。例如，不要在某属性的 getter 方法里面设置其他属性的值。</p>\n<p>假如在获取属性的 getter 方法里面修改了其他属性的值，那么用户查询这个属性时，就会觉得相当奇怪，他可能不理解为什么另外一个属性会在我查询这个属性时发生变化。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61811148719526160000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Resistor:\n    def __init__(self, ohms):\n        self.ohms = ohms\n        self.voltage = 0\n        self.current = 0\n\n\nclass MysteriousResistor(Resistor):\n    @property\n    def ohms(self):\n        self.voltage = self._ohms * self.current\n        return self._ohms\n\n    @ohms.setter\n    def ohms(self, ohms):\n        self._ohms = ohms\n\n\nr7 = MysteriousResistor(10)\nr7.current = 0.01\nprint(f\'Before: {r7.voltage:.2f}\')\nr7.ohms\nprint(f\'After: {r7.voltage: .2f}\')\n\n>>>\nBefore: 0.00\nAfter:  0.10`, `61811148719526160000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Resistor</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ohms<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>ohms <span class="token operator">=</span> ohms\n        self<span class="token punctuation">.</span>voltage <span class="token operator">=</span> <span class="token number">0</span>\n        self<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token number">0</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">MysteriousResistor</span><span class="token punctuation">(</span>Resistor<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    @<span class="token builtin">property</span>\n    <span class="token keyword">def</span> <span class="token function">ohms</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>voltage <span class="token operator">=</span> self<span class="token punctuation">.</span>_ohms <span class="token operator">*</span> self<span class="token punctuation">.</span>current\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_ohms\n\n    @ohms<span class="token punctuation">.</span>setter\n    <span class="token keyword">def</span> <span class="token function">ohms</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ohms<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_ohms <span class="token operator">=</span> ohms\n\n\nr7 <span class="token operator">=</span> MysteriousResistor<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>\nr7<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token number">0.01</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Before: </span><span class="token interpolation"><span class="token punctuation">{</span>r7<span class="token punctuation">.</span>voltage<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\nr7<span class="token punctuation">.</span>ohms\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'After: </span><span class="token interpolation"><span class="token punctuation">{</span>r7<span class="token punctuation">.</span>voltage<span class="token punctuation">:</span><span class="token format-spec"> .2f</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore<span class="token punctuation">:</span> <span class="token number">0.00</span>\nAfter<span class="token punctuation">:</span>  <span class="token number">0.10</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>最好的办法是，只在 @property.setter 方法里面修改状态，而且只应该修改对象之中与当前属性有关的状态。同时还得注意不要产生让调用者感到意外的其他一些副作用，例如，不要动态地引入模块，不要运行速度较慢的辅助函数，不要做 I/O，不要执行开销较大的数据库查询操作等。类的属性用起来应该跟其他的 Python 对象一样方便而快捷。如果确实要执行比较复杂或比较缓慢的操作，那么应该用普通的方法来做，而不应该把这些操作放在获取及设置属性的这两个方法里面。</p>\n<p>@property 最大的缺点是，通过它而编写的属性获取及属性设置方法只能由子类共享。与此无关的类不能共用这份逻辑。但是没关系，Python 还支持描述符（descriptor，参见第 46 条），我们可以利用这种机制把早前编写的属性获取与属性设置逻辑复用到其他许多地方。</p>\n<h3 id="总结-40"><a href="#%E6%80%BB%E7%BB%93-40" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>给新类定义接口时，应该先从简单的 public 属性写起，避免定义 setter 与 getter 方法。</li>\n<li>如果在访问属性时确实有必要做特殊的处理，那就通过 @property 来定义获取属性与设置属性的方法。</li>\n<li>实现 @property 方法时，应该遵循最小惊讶原则，不要引发奇怪的副作用。</li>\n<li>@property 方法必须执行得很快。复杂或缓慢的任务，尤其是涉及 I/O 或者会引发副作用的那些任务，还是用普通的方法来实现比较好。</li>\n</ol>\n<h2 id="第-45-条：考虑用-property-实现新的属性访问逻辑，不要急着重构原有的代码"><a href="#%E7%AC%AC-45-%E6%9D%A1%EF%BC%9A%E8%80%83%E8%99%91%E7%94%A8-property-%E5%AE%9E%E7%8E%B0%E6%96%B0%E7%9A%84%E5%B1%9E%E6%80%A7%E8%AE%BF%E9%97%AE%E9%80%BB%E8%BE%91%EF%BC%8C%E4%B8%8D%E8%A6%81%E6%80%A5%E7%9D%80%E9%87%8D%E6%9E%84%E5%8E%9F%E6%9C%89%E7%9A%84%E4%BB%A3%E7%A0%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 45 条：考虑用 @property 实现新的属性访问逻辑，不要急着重构原有的代码</h2>\n<p>Python 内置的 @property 修饰器使开发者很容易就能实现出灵活的逻辑，使得程序在获取或设置相关属性时，触发这些逻辑（参见第 44 条）。@property 还有一种更为高级的用法，其实也很常见，这就是把简单的数值属性迁移成那种实时计算的属性。这个用法的意义特别大，因为它可以确保，按照旧写法来访问属性的那些代码依然有效，而且会自动按照新逻辑执行，也不需要重写原来那些访问代码（这一点相当关键，因为那些代码未必都在你控制之下）。@property 可以说是一种重要的缓冲机制，使开发者能够逐渐改善接口而不影响已经写好的代码。</p>\n<p>例如，下面我们用普通的 Python 对象实现带有配额（quota）的漏桶（leaky bucket）。这个类可以记录当前的配额以及这份配额在多长时间内有效。</p>\n<p>漏桶算法要求在添加配额时，不能把已有的额度带到下一个时段。如果想使用额度，那么首先必须确保漏桶当前所剩的配额足够使用。</p>\n<p>现在我们来使用这个类。首先填充额度，然后根据自己的需要使用额度，这样用下去，最终会遇到额度不够的情况。从这时开始，额度就不会再变了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43911458100415190000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from datetime import datetime, timedelta\n\n\nclass Bucket:\n    def __init__(self, period):\n        self.period_delta = timedelta(seconds=period)\n        self.reset_time = datetime.now()\n        self.quota = 0\n\n    def __repr__(self):\n        return f\'Bucket (quota={self.quota})\'\n\n\ndef fill(bucket, amount):\n    now = datetime.now()\n    if (now - bucket.reset_time) > bucket.period_delta:\n        bucket.quota = 0\n        bucket.reset_time = now\n    bucket.quota += amount\n\n\ndef deduct(bucket, amount):\n    now = datetime.now()\n    if (now - bucket.reset_time) > bucket.period_delta:\n        return False  # Bucket hasn\'t been filled this period\n    if bucket.quota - amount < 0:\n        return False  # Bucket was filled, but not enough\n    bucket.quota -= amount\n    return True  # Bucket had enough, quota consumed\n\n\nbucket = Bucket(60)\nfill(bucket, 100)\nprint(bucket)\n\nif deduct(bucket, 99):\n    print(\'Had 99 quota\')\nelse:\n    print(\'Not enough for 99 quota\')\nprint(bucket)\n\nif deduct(bucket, 3):\n    print(\'Had 3 quota\')\nelse:\n    print(\'Not enough for 3 quota\')\nprint(bucket)\n\n>>>\nBucket (quota=100)\nHad 99 quota\nBucket (quota=1)\nNot enough for 3 quota\nBucket (quota=1)`, `43911458100415190000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timedelta\n\n\n<span class="token keyword">class</span> <span class="token class-name">Bucket</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> period<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>period_delta <span class="token operator">=</span> timedelta<span class="token punctuation">(</span>seconds<span class="token operator">=</span>period<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>reset_time <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>quota <span class="token operator">=</span> <span class="token number">0</span>\n\n    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f\'Bucket (quota=</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>quota<span class="token punctuation">}</span></span><span class="token string">)\'</span></span>\n\n\n<span class="token keyword">def</span> <span class="token function">fill</span><span class="token punctuation">(</span>bucket<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    now <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> bucket<span class="token punctuation">.</span>reset_time<span class="token punctuation">)</span> <span class="token operator">></span> bucket<span class="token punctuation">.</span>period_delta<span class="token punctuation">:</span>\n        bucket<span class="token punctuation">.</span>quota <span class="token operator">=</span> <span class="token number">0</span>\n        bucket<span class="token punctuation">.</span>reset_time <span class="token operator">=</span> now\n    bucket<span class="token punctuation">.</span>quota <span class="token operator">+=</span> amount\n\n\n<span class="token keyword">def</span> <span class="token function">deduct</span><span class="token punctuation">(</span>bucket<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    now <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> bucket<span class="token punctuation">.</span>reset_time<span class="token punctuation">)</span> <span class="token operator">></span> bucket<span class="token punctuation">.</span>period_delta<span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token boolean">False</span>  <span class="token comment"># Bucket hasn\'t been filled this period</span>\n    <span class="token keyword">if</span> bucket<span class="token punctuation">.</span>quota <span class="token operator">-</span> amount <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token boolean">False</span>  <span class="token comment"># Bucket was filled, but not enough</span>\n    bucket<span class="token punctuation">.</span>quota <span class="token operator">-=</span> amount\n    <span class="token keyword">return</span> <span class="token boolean">True</span>  <span class="token comment"># Bucket had enough, quota consumed</span>\n\n\nbucket <span class="token operator">=</span> Bucket<span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span>\nfill<span class="token punctuation">(</span>bucket<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>\n\n<span class="token keyword">if</span> deduct<span class="token punctuation">(</span>bucket<span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Had 99 quota\'</span><span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Not enough for 99 quota\'</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>\n\n<span class="token keyword">if</span> deduct<span class="token punctuation">(</span>bucket<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Had 3 quota\'</span><span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Not enough for 3 quota\'</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBucket <span class="token punctuation">(</span>quota<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span>\nHad <span class="token number">99</span> quota\nBucket <span class="token punctuation">(</span>quota<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>\nNot enough <span class="token keyword">for</span> <span class="token number">3</span> quota\nBucket <span class="token punctuation">(</span>quota<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种实现方式有个问题，就是没办法知道第一次填充漏桶时，给它分配的额度。我们只知道额度会越用越少直到不够用为止。如果当前这段时间内的额度已经降到 0，那么不管你想使用多少额度，deduct 函数都会返回 False，除非通过 fill 函数再往里面补充额度。所以，当 deduct 函数返回 False 时，了解这究竟是因为 Bucket 没有足够的额度可以扣减，还是说它一开始根本就没分配到任何额度，这一点很重要。</p>\n<p>为了解决这个问题，可以修改这个类，把当前时间段内的初始额度（max<em>quota）与已经使用的额度（quota</em>consumed）明确记录下来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48993163391778100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from datetime import datetime, timedelta\n\n\nclass NewBucket:\n    def __init__(self, period):\n        self.period_delta = timedelta(seconds=period)\n        self.reset_time = datetime.now()\n        self.max_quota = 0\n        self.quota_consumed = 0\n\n    def __repr__(self):\n        return f\'NewBucket (max_quota={self.max_quota}, quota_consumed={self.quota_consumed})\'\n\n    @property\n    def quota(self):\n        return self.max_quota - self.quota_consumed\n\n    @quota.setter\n    def quota(self, amount):\n        delta = self.max_quota - amount\n        if amount == 0:\n            # Quota being reset for a new period\n            self.quota_consumed = 0\n            self.max_quota = 0\n        elif delta < 0:\n            # Quota being filled for the new period\n            assert self.quota_consumed == 0\n            self.max_quota = amount\n        else:\n            # Quota being consumed during the period\n            assert amount > 0\n            self.quota_consumed = delta\n\n\ndef fill(bucket, amount):\n    now = datetime.now()\n    if (now - bucket.reset_time) > bucket.period_delta:\n        bucket.quota = 0\n        bucket.reset_time = now\n    bucket.quota += amount\n\n\ndef deduct(bucket, amount):\n    now = datetime.now()\n    if (now - bucket.reset_time) > bucket.period_delta:\n        return False  # Bucket hasn\'t been filled this period\n    if bucket.quota - amount < 0:\n        return False  # Bucket was filled, but not enough\n    bucket.quota -= amount\n    return True  # Bucket had enough, quota consumed\n\n\nbucket = NewBucket(60)\nfill(bucket, 100)\nprint(bucket)\n\nif deduct(bucket, 99):\n    print(\'Had 99 quota\')\nelse:\n    print(\'Not enough for 99 quota\')\nprint(bucket)\n\nif deduct(bucket, 3):\n    print(\'Had 3 quota\')\nelse:\n    print(\'Not enough for 3 quota\')\nprint(bucket)\n\n>>>\nNewBucket (max_quota=100, quota_consumed=0)\nHad 99 quota\nNewBucket (max_quota=100, quota_consumed=99)\nNot enough for 3 quota\nNewBucket (max_quota=100, quota_consumed=99)`, `48993163391778100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timedelta\n\n\n<span class="token keyword">class</span> <span class="token class-name">NewBucket</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> period<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>period_delta <span class="token operator">=</span> timedelta<span class="token punctuation">(</span>seconds<span class="token operator">=</span>period<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>reset_time <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>max_quota <span class="token operator">=</span> <span class="token number">0</span>\n        self<span class="token punctuation">.</span>quota_consumed <span class="token operator">=</span> <span class="token number">0</span>\n\n    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f\'NewBucket (max_quota=</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>max_quota<span class="token punctuation">}</span></span><span class="token string">, quota_consumed=</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>quota_consumed<span class="token punctuation">}</span></span><span class="token string">)\'</span></span>\n\n    <span class="token decorator annotation punctuation">@property</span>\n    <span class="token keyword">def</span> <span class="token function">quota</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>max_quota <span class="token operator">-</span> self<span class="token punctuation">.</span>quota_consumed\n\n    @quota<span class="token punctuation">.</span>setter\n    <span class="token keyword">def</span> <span class="token function">quota</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        delta <span class="token operator">=</span> self<span class="token punctuation">.</span>max_quota <span class="token operator">-</span> amount\n        <span class="token keyword">if</span> amount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>\n            <span class="token comment"># Quota being reset for a new period</span>\n            self<span class="token punctuation">.</span>quota_consumed <span class="token operator">=</span> <span class="token number">0</span>\n            self<span class="token punctuation">.</span>max_quota <span class="token operator">=</span> <span class="token number">0</span>\n        <span class="token keyword">elif</span> delta <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">:</span>\n            <span class="token comment"># Quota being filled for the new period</span>\n            <span class="token keyword">assert</span> self<span class="token punctuation">.</span>quota_consumed <span class="token operator">==</span> <span class="token number">0</span>\n            self<span class="token punctuation">.</span>max_quota <span class="token operator">=</span> amount\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token comment"># Quota being consumed during the period</span>\n            <span class="token keyword">assert</span> amount <span class="token operator">></span> <span class="token number">0</span>\n            self<span class="token punctuation">.</span>quota_consumed <span class="token operator">=</span> delta\n\n\n<span class="token keyword">def</span> <span class="token function">fill</span><span class="token punctuation">(</span>bucket<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    now <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> bucket<span class="token punctuation">.</span>reset_time<span class="token punctuation">)</span> <span class="token operator">></span> bucket<span class="token punctuation">.</span>period_delta<span class="token punctuation">:</span>\n        bucket<span class="token punctuation">.</span>quota <span class="token operator">=</span> <span class="token number">0</span>\n        bucket<span class="token punctuation">.</span>reset_time <span class="token operator">=</span> now\n    bucket<span class="token punctuation">.</span>quota <span class="token operator">+=</span> amount\n\n\n<span class="token keyword">def</span> <span class="token function">deduct</span><span class="token punctuation">(</span>bucket<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    now <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> bucket<span class="token punctuation">.</span>reset_time<span class="token punctuation">)</span> <span class="token operator">></span> bucket<span class="token punctuation">.</span>period_delta<span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token boolean">False</span>  <span class="token comment"># Bucket hasn\'t been filled this period</span>\n    <span class="token keyword">if</span> bucket<span class="token punctuation">.</span>quota <span class="token operator">-</span> amount <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token boolean">False</span>  <span class="token comment"># Bucket was filled, but not enough</span>\n    bucket<span class="token punctuation">.</span>quota <span class="token operator">-=</span> amount\n    <span class="token keyword">return</span> <span class="token boolean">True</span>  <span class="token comment"># Bucket had enough, quota consumed</span>\n\n\nbucket <span class="token operator">=</span> NewBucket<span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span>\nfill<span class="token punctuation">(</span>bucket<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>\n\n<span class="token keyword">if</span> deduct<span class="token punctuation">(</span>bucket<span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Had 99 quota\'</span><span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Not enough for 99 quota\'</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>\n\n<span class="token keyword">if</span> deduct<span class="token punctuation">(</span>bucket<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Had 3 quota\'</span><span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Not enough for 3 quota\'</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nNewBucket <span class="token punctuation">(</span>max_quota<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span> quota_consumed<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>\nHad <span class="token number">99</span> quota\nNewBucket <span class="token punctuation">(</span>max_quota<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span> quota_consumed<span class="token operator">=</span><span class="token number">99</span><span class="token punctuation">)</span>\nNot enough <span class="token keyword">for</span> <span class="token number">3</span> quota\nNewBucket <span class="token punctuation">(</span>max_quota<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span> quota_consumed<span class="token operator">=</span><span class="token number">99</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个方案最大的好处是，原来根据 Bucket.quota 所写的那些代码可以继续沿用，而且无须考虑 Bucket 现在已经换成了新的 NewBucket。至于以后的代码，则可以直接操纵漏桶的额度（quota），因为可以通过访问 <code class="language-text">max_quota</code> 与 <code class="language-text">quota_consumed</code> 字段正确地获取及设置该额度。</p>\n<p>笔者特别喜欢 @property 属性的地方在于，它让我们能够逐渐完善数据模型而不影响已经写好的代码。观看刚才那个 Bucket 范例时，有人可能会想，为什么不把 fill 与 deduct 直接设计成实例方法呢？嗯，这样想确实有道理（参见第 37 条），但实际上，我们不可能每次都想得这么周到，还是会遇到很多相当糟糕的接口，或者遇到那种纯粹当成数据容器来写的类。之所以出现那样的情况，可能有许多原因，例如代码不断膨胀，项目的范围也越来越广，而给同一个项目提交程序的开发者又全都没有考虑到以后的维护工作。</p>\n<p>@property 可以帮助解决实际工作中的许多问题，但不应该遭到滥用。如果你发现自己总是在扩充 @property 方法，那可能说明这个类确实应该重构了。在这种情况下，就不要再沿着糟糕的方案继续往下写了。</p>\n<h3 id="总结-41"><a href="#%E6%80%BB%E7%BB%93-41" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>可以利用 @property 给已有的实例属性增加新的功能。</li>\n<li>可以利用 @property 逐渐改善数据模型而不影响已经写好的代码。</li>\n<li>如果发现 @property 使用太过频繁，那可能就该考虑重构这个类了，同时按照旧办法使用这个类的那些代码可能也要重构。</li>\n</ol>\n<h2 id="第-46-条：用描述符来改写需要复用的-property-方法"><a href="#%E7%AC%AC-46-%E6%9D%A1%EF%BC%9A%E7%94%A8%E6%8F%8F%E8%BF%B0%E7%AC%A6%E6%9D%A5%E6%94%B9%E5%86%99%E9%9C%80%E8%A6%81%E5%A4%8D%E7%94%A8%E7%9A%84-property-%E6%96%B9%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 46 条：用描述符来改写需要复用的 @property 方法</h2>\n<p>Python 内置的 @property 机制的最大的缺点就是不方便复用（参见第 44 条与第 45 条）。我们不能把它修饰的方法所使用的逻辑，套用在同一个类的其他属性上面，也不能在无关的类里面复用。</p>\n<p>例如，我们要编写一个类来记录学生的家庭作业成绩，而且要确保设置的成绩位于 0 到 100 之间，受 @property 修饰的属性用起来很简单。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23632869638601052000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Homework:\n    def __init__(self):\n        self._grade = 0\n\n    @property\n    def grade(self):\n        return self._grade\n\n    @grade.setter\n    def grade(self, value):\n        if not (0 <= value <= 100):\n            raise ValueError(\'Grade must be between 0 and 100\')\n        self._grade = value\n\n\ngalileo = Homework()\ngalileo.grade = 95`, `23632869638601052000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Homework</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_grade <span class="token operator">=</span> <span class="token number">0</span>\n\n    @<span class="token builtin">property</span>\n    <span class="token keyword">def</span> <span class="token function">grade</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_grade\n\n    @grade<span class="token punctuation">.</span>setter\n    <span class="token keyword">def</span> <span class="token function">grade</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;=</span> value <span class="token operator">&lt;=</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Grade must be between 0 and 100\'</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>_grade <span class="token operator">=</span> value\n\n\ngalileo <span class="token operator">=</span> Homework<span class="token punctuation">(</span><span class="token punctuation">)</span>\ngalileo<span class="token punctuation">.</span>grade <span class="token operator">=</span> <span class="token number">95</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>假设，我们还需要写一个类记录学生的考试成绩，而且要把每科的成绩分别记录下来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54630901323058700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Exam:\n    def __init__(self):\n        self._writing_grade = 0\n        self._math_grade = 0\n\n    @staticmethod\n    def _check_grade(value):\n        if not (0 <= value <= 100):\n            raise ValueError(\'Grade must be between 0 and 100\')`, `54630901323058700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Exam</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_writing_grade <span class="token operator">=</span> <span class="token number">0</span>\n        self<span class="token punctuation">.</span>_math_grade <span class="token operator">=</span> <span class="token number">0</span>\n\n    @<span class="token builtin">staticmethod</span>\n    <span class="token keyword">def</span> <span class="token function">_check_grade</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;=</span> value <span class="token operator">&lt;=</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Grade must be between 0 and 100\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写很费事，因为每科的成绩都需要一套 @property 方法，而且其中设置属性值的那个方法还必须调用 <code class="language-text">_check_grade</code> 验证新值是否位于合理的范围内。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42732967349971630000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@property\ndef writing_grade(self):\n    return self._writing_grade\n\n\n@writing_grade.setter\ndef writing_grade(self, value):\n    self._check_grade(value)\n    self._writing_grade = value\n\n\n@property\ndef math_grade(self):\n    return self._math_grade\n\n\n@math_grade.setter\ndef math_grade(self, value):\n    self._check_grade(value)\n    self._math_grade = value`, `42732967349971630000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token decorator annotation punctuation">@property</span>\n<span class="token keyword">def</span> <span class="token function">writing_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> self<span class="token punctuation">.</span>_writing_grade\n\n\n@writing_grade<span class="token punctuation">.</span>setter\n<span class="token keyword">def</span> <span class="token function">writing_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    self<span class="token punctuation">.</span>_check_grade<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n    self<span class="token punctuation">.</span>_writing_grade <span class="token operator">=</span> value\n\n\n@<span class="token builtin">property</span>\n<span class="token keyword">def</span> <span class="token function">math_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> self<span class="token punctuation">.</span>_math_grade\n\n\n@math_grade<span class="token punctuation">.</span>setter\n<span class="token keyword">def</span> <span class="token function">math_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    self<span class="token punctuation">.</span>_check_grade<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n    self<span class="token punctuation">.</span>_math_grade <span class="token operator">=</span> value</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种写法不仅烦琐，而且无法复用。如果想把这个百分制验证逻辑运用到 Homework 与 Exam 以外的类，那么必须反复编写例行的 @property 方法与 <code class="language-text">_check_grade</code> 逻辑。</p>\n<p>在 Python 里，这样的功能最好通过描述符（descriptor）实现。描述符协议（descriptor protocol）规定了程序应该如何处理属性访问操作。充当描述符的那个类能够实现 <code class="language-text">__get__</code> 与 <code class="language-text">__set__</code> 方法，这样其他类就可以共用这个描述符所实现的逻辑而无须把这套逻辑分别重写一遍。在这一点上，描述符要比 <code class="language-text">mix-in</code> 好（参见第 41 条），因为即便在同一个类里，我们也可以反复使用这个描述符来设计不同的属性。</p>\n<p>下面重新定义 Exam 类，这次我们采用类级别的属性来实现每科成绩的访问功能，这些属性指向下面这个 Grade 类的实例，而这个 Grade 类则实现刚才提到的描述符协议。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89793324211492130000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Grade:\n    def __get__(self, instance, instance_type):\n        return ()\n\n    def __set__(self, instance, value):\n        return ()\n\n\nclass Exam:\n    # Class attributes\n    math_grade = Grade()\n    writing_grade = Grade()\n    science_grade = Grade()`, `89793324211492130000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Grade</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__get__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> instance_type<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__set__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Exam</span><span class="token punctuation">:</span>\n    <span class="token comment"># Class attributes</span>\n    math_grade <span class="token operator">=</span> Grade<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    writing_grade <span class="token operator">=</span> Grade<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    science_grade <span class="token operator">=</span> Grade<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在解释 Grade 类的工作原理之前，我们首先要知道，当程序访问 Exam 实例的某个属性时，Python 如何将访问操作派发到 Exam 类的描述符属性上面。例如，如果要给 Exam 实例的 <code class="language-text">writing_grade</code> 属性赋值：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53143300846869670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`exam = Exam()\nexam.writing_grade = 40`, `53143300846869670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">exam <span class="token operator">=</span> Exam<span class="token punctuation">(</span><span class="token punctuation">)</span>\nexam<span class="token punctuation">.</span>writing_grade <span class="token operator">=</span> <span class="token number">40</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>那么 Python 会把这次赋值操作转译为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77793060626121000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Exam.__dict__[\'writing_grade\'].__set__(exam, 40)`, `77793060626121000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">Exam<span class="token punctuation">.</span>__dict__<span class="token punctuation">[</span><span class="token string">\'writing_grade\'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__set__<span class="token punctuation">(</span>exam<span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>获取这个属性时也一样：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65892805756536460000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`exam.writing_grade`, `65892805756536460000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">exam<span class="token punctuation">.</span>writing_grade</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>Python 会把它相应地转译为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61814181352791220000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Exam.__dict__[\'writing_grade\'].__get__(exam, Exam)`, `61814181352791220000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">Exam<span class="token punctuation">.</span>__dict__<span class="token punctuation">[</span><span class="token string">\'writing_grade\'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__get__<span class="token punctuation">(</span>exam<span class="token punctuation">,</span> Exam<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这样的转译效果是由 object 的 <code class="language-text">__getattribute__</code> 方法促成的（参见第 47 条）。简单地说，就是当 Exam 实例里面没有名为 <code class="language-text">writing_grade</code> 的属性时，Python 会转而在类的层面查找，查询 Exam 类里面有没有这样一个属性。如果有，而且还是个实现了 <code class="language-text">__get__</code> 与 <code class="language-text">__set__</code> 方法的对象，那么系统就认定你想通过描述符协议定义这个属性的访问行为。</p>\n<p>知道了这条规则之后，我们来尝试把 Homework 类早前用 <code class="language-text">@property</code> 实现的成绩验证逻辑搬到 Grade 描述符里面。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58491308849183300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Grade:\n    def __init__(self):\n        self._value = 0\n\n    def __get__(self, instance, instance_type):\n        return self._value\n\n    def __set__(self, instance, value):\n        if not (0 <= value <= 100):\n            raise ValueError(\'Grade must be between 0 and 100\')\n        self._value = value`, `58491308849183300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Grade</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_value <span class="token operator">=</span> <span class="token number">0</span>\n\n    <span class="token keyword">def</span> <span class="token function">__get__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> instance_type<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_value\n\n    <span class="token keyword">def</span> <span class="token function">__set__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;=</span> value <span class="token operator">&lt;=</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Grade must be between 0 and 100\'</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>_value <span class="token operator">=</span> value</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写其实不对，而且会让程序出现混乱。但在同一个 Exam 实例上面访问不同的属性是没有问题的。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24383839658576380000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Exam:\n    math_grade = Grade()\n    writing_grade = Grade()\n    science_grade = Grade()\n\n\nfirst_exam = Exam()\nfirst_exam.writing_grade = 82\nfirst_exam.science_grade = 99\nprint(\'Writing\', first_exam.writing_grade)\nprint(\'Science\', first_exam.science_grade)\n\n>>>\nWriting 82\nScience 99`, `24383839658576380000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Exam</span><span class="token punctuation">:</span>\n    math_grade <span class="token operator">=</span> Grade<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    writing_grade <span class="token operator">=</span> Grade<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    science_grade <span class="token operator">=</span> Grade<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n\nfirst_exam <span class="token operator">=</span> Exam<span class="token punctuation">(</span><span class="token punctuation">)</span>\nfirst_exam<span class="token punctuation">.</span>writing_grade <span class="token operator">=</span> <span class="token number">82</span>\nfirst_exam<span class="token punctuation">.</span>science_grade <span class="token operator">=</span> <span class="token number">99</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Writing\'</span><span class="token punctuation">,</span> first_exam<span class="token punctuation">.</span>writing_grade<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Science\'</span><span class="token punctuation">,</span> first_exam<span class="token punctuation">.</span>science_grade<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nWriting <span class="token number">82</span>\nScience <span class="token number">99</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是，在不同的 Exam 实例上分别访问同一个属性却会看到奇怪的结果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99096038137674150000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`second_exam = Exam()\nsecond_exam.writing_grade = 75\nprint(f\'Second {second_exam.writing_grade} is right\')\nprint(f\'First {first_exam.writing_grade} is wrong; should be 82\')\n\n>>>\nSecond 75 is right\nFirst 75 is wrong; should be 82`, `99096038137674150000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">second_exam <span class="token operator">=</span> Exam<span class="token punctuation">(</span><span class="token punctuation">)</span>\nsecond_exam<span class="token punctuation">.</span>writing_grade <span class="token operator">=</span> <span class="token number">75</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Second </span><span class="token interpolation"><span class="token punctuation">{</span>second_exam<span class="token punctuation">.</span>writing_grade<span class="token punctuation">}</span></span><span class="token string"> is right\'</span></span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'First </span><span class="token interpolation"><span class="token punctuation">{</span>first_exam<span class="token punctuation">.</span>writing_grade<span class="token punctuation">}</span></span><span class="token string"> is wrong; should be 82\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nSecond <span class="token number">75</span> <span class="token keyword">is</span> right\nFirst <span class="token number">75</span> <span class="token keyword">is</span> wrong<span class="token punctuation">;</span> should be <span class="token number">82</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>出现这种问题的原因在于，这些 Exam 实例之中的 <code class="language-text">writing_grade</code> 属性实际上是在共享同一个 Grade 实例。在整个程序的运行过程中，这个 Grade 只会于定义 Exam 类时构造一次，而不是每创建一个 Exam 实例都有一个新的 Grade 来与 <code class="language-text">writing_grade</code> 属性相搭配。</p>\n<p>为解决此问题，我们必须把每个 Exam 实例在这个属性上面的取值都记录下来。可以通过字典实现每个实例的状态保存。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52092006698045080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Grade:\n    def __init__(self):\n        self._values = {}\n\n    def __get__(self, instance, instance_type):\n        if instance is None:\n            return self\n        return self._values.get(instance, 0)\n\n    def __set__(self, instance, value):\n        if not (0 <= value <= 100):\n            raise ValueError(\'Grade must be between 0 and 100\')\n        self._values[instance] = value`, `52092006698045080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Grade</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_values <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n    <span class="token keyword">def</span> <span class="token function">__get__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> instance_type<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> instance <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_values<span class="token punctuation">.</span>get<span class="token punctuation">(</span>instance<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__set__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;=</span> value <span class="token operator">&lt;=</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Grade must be between 0 and 100\'</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>_values<span class="token punctuation">[</span>instance<span class="token punctuation">]</span> <span class="token operator">=</span> value</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种实现方案很简单，而且能得到正确结果，但仍然有一个缺陷，就是会泄漏内存。在程序运行过程中，传给 <code class="language-text">__set__</code> 方法的那些 Exam 实例全都会被 Grade 之中的 <code class="language-text">_values</code> 字典所引用。于是，指向那些实例的引用数量就永远不会降到 0，这导致垃圾回收器没办法把那些实例清理掉（第 81 条会介绍怎样才能发现这种问题）。</p>\n<p>为了解决这个问题，我们可以求助于 Python 内置的 weakref 模块。该模块里有一种特殊的字典，名为 WeakKeyDictionary，它可以取代刚才实现 <code class="language-text">_values</code> 时所用的普通字典。这个字典的特殊之处在于：如果运行时系统发现，指向 Exam 实例的引用只剩一个，而这个引用又是由 WeakKeyDictionary 的键所发起的，那么系统会将该引用从这个特殊的字典里删掉，于是指向那个 Exam 实例的引用数量就会降为 0。总之，改用这种字典来实现 <code class="language-text">_values</code> 会让 Python 系统自动把内存泄漏问题处理好，如果所有的 Exam 实例都不再使用了，那么 <code class="language-text">_values</code> 字典肯定是空的。</p>\n<p>用这种字典改写 Grade 描述符之后，Exam 就能够正常运作了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10074239134622710000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from weakref import WeakKeyDictionary\n\n\nclass Grade:\n    def __init__(self):\n        self._values = WeakKeyDictionary()\n\n    def __get__(self, instance, instance_type):\n        if instance is None:\n            return self\n        return self._values.get(instance, 0)\n\n    def __set__(self, instance, value):\n        if not (0 <= value <= 100):\n            raise ValueError(\'Grade must be between 0 and 100\')\n        self._values[instance] = value\n\n\nclass Exam:\n    math_grade = Grade()\n    writing_grade = Grade()\n    science_grade = Grade()\n\n\nfirst_exam = Exam()\nfirst_exam.writing_grade = 82\nsecond_exam = Exam()\nsecond_exam.writing_grade = 75\nprint(f\'First {first_exam.writing_grade} is right\')\nprint(f\'Second {second_exam.writing_grade} is right\')\n\n>>>\nFirst 82 is right\nSecond 75 is right`, `10074239134622710000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> weakref <span class="token keyword">import</span> WeakKeyDictionary\n\n\n<span class="token keyword">class</span> <span class="token class-name">Grade</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_values <span class="token operator">=</span> WeakKeyDictionary<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__get__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> instance_type<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> instance <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_values<span class="token punctuation">.</span>get<span class="token punctuation">(</span>instance<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__set__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;=</span> value <span class="token operator">&lt;=</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Grade must be between 0 and 100\'</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>_values<span class="token punctuation">[</span>instance<span class="token punctuation">]</span> <span class="token operator">=</span> value\n\n\n<span class="token keyword">class</span> <span class="token class-name">Exam</span><span class="token punctuation">:</span>\n    math_grade <span class="token operator">=</span> Grade<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    writing_grade <span class="token operator">=</span> Grade<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    science_grade <span class="token operator">=</span> Grade<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n\nfirst_exam <span class="token operator">=</span> Exam<span class="token punctuation">(</span><span class="token punctuation">)</span>\nfirst_exam<span class="token punctuation">.</span>writing_grade <span class="token operator">=</span> <span class="token number">82</span>\nsecond_exam <span class="token operator">=</span> Exam<span class="token punctuation">(</span><span class="token punctuation">)</span>\nsecond_exam<span class="token punctuation">.</span>writing_grade <span class="token operator">=</span> <span class="token number">75</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'First </span><span class="token interpolation"><span class="token punctuation">{</span>first_exam<span class="token punctuation">.</span>writing_grade<span class="token punctuation">}</span></span><span class="token string"> is right\'</span></span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Second </span><span class="token interpolation"><span class="token punctuation">{</span>second_exam<span class="token punctuation">.</span>writing_grade<span class="token punctuation">}</span></span><span class="token string"> is right\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nFirst <span class="token number">82</span> <span class="token keyword">is</span> right\nSecond <span class="token number">75</span> <span class="token keyword">is</span> right</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="总结-42"><a href="#%E6%80%BB%E7%BB%93-42" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>如果想复用 @property 方法所实现的行为与验证逻辑，则可以考虑自己定义描述符类。</li>\n<li>为了防止内存泄漏，可以在描述符类中用 WeakKeyDictionary 取代普通的字典。</li>\n<li>不要太纠结于 <code class="language-text">__getattribute__</code> 是怎么通过描述符协议来获取并设置属性的。</li>\n</ol>\n<h2 id="第-47-条：针对惰性属性使用-__getattr__、__getattribute__-及-__setattr__"><a href="#%E7%AC%AC-47-%E6%9D%A1%EF%BC%9A%E9%92%88%E5%AF%B9%E6%83%B0%E6%80%A7%E5%B1%9E%E6%80%A7%E4%BD%BF%E7%94%A8-__getattr__%E3%80%81__getattribute__-%E5%8F%8A-__setattr__" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 47 条：针对惰性属性使用 <code class="language-text">__getattr__</code>、<code class="language-text">__getattribute__</code> 及 <code class="language-text">__setattr__</code></h2>\n<p>Python 的 object 提供了一套挂钩，使开发者很容易就能写出通用的代码，将不同的系统粘合到一起。例如，我们想把数据库中的记录表示为 Python 对象。数据库当然有它自己的模式（schema），而程序在把记录表示成对象时，必须知道数据库是按照什么样的 schema 来组织这些记录的。同时，我们又要注意，连接 Python 对象与数据库的代码应该写得通用一些，而不应该明确限定这些记录必须使用哪种 schema。</p>\n<p>这个功能如何实现才好呢？普通的实例属性、经过 <code class="language-text">@property</code> 修饰的方法以及上一条里提到的描述符，都做不到这一点，因为它们都必须得提前定义好。在 Python 中，这种动态的行为可以通过名为 <code class="language-text">__getattr__</code> 的特殊方法来实现。如果类中定义了 <code class="language-text">__getattr__</code>，那么每当访问该类对象的属性，而且实例字典里又找不到这个属性时，系统就会触发 <code class="language-text">__getattr__</code> 方法。</p>\n<p>下面我们试着访问 foo 属性。data 实例中并没有这样一个属性，因此 Python 会触发上面定义的 <code class="language-text">__getattr__</code> 方法，而该方法又会通过 setattr 修改本实例的 <code class="language-text">__dict__</code> 字典。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32684603313383096000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class LazyRecord:\n    def __init__(self):\n        self.exists = 5\n\n    def __getattr__(self, name):\n        value = f\'Value for {name}\'\n        setattr(self, name, value)\n        return value\n\n\ndata = LazyRecord()\nprint(\'Before:\', data.__dict__)\nprint(\'foo:   \', data.foo)\nprint(\'After: \', data.__dict__)\n\n>>>\nBefore: {\'exists\': 5}\nfoo:    Value for foo\nAfter:  {\'exists\': 5, \'foo\': \'Value for foo\'}`, `32684603313383096000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">LazyRecord</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>exists <span class="token operator">=</span> <span class="token number">5</span>\n\n    <span class="token keyword">def</span> <span class="token function">__getattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        value <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f\'Value for </span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">\'</span></span>\n        <span class="token builtin">setattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> value\n\n\ndata <span class="token operator">=</span> LazyRecord<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Before:\'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'foo:   \'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>foo<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After: \'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'exists\'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">}</span>\nfoo<span class="token punctuation">:</span>    Value <span class="token keyword">for</span> foo\nAfter<span class="token punctuation">:</span>  <span class="token punctuation">{</span><span class="token string">\'exists\'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">\'foo\'</span><span class="token punctuation">:</span> <span class="token string">\'Value for foo\'</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>下面，我们通过子类给 LazyRecord 增加日志功能，用来观察程序在什么样的情况下才会调用 <code class="language-text">__getattr__</code> 方法。我们先写入第一条日志，然后通过 super() 调用超类所实现的 <code class="language-text">__getattr__</code> 方法，并把那个方法返回的结果记录到第二条日志里面。假如不加 super()，那么程序就会无限递归，因为那样调用的是本类所写的 <code class="language-text">__getattr__</code> 方法（参见第 40 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78048843554824400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class LazyRecord:\n    def __init__(self):\n        self.exists = 5\n\n    def __getattr__(self, name):\n        value = f\'Value for {name}\'\n        setattr(self, name, value)\n        return value\n\n\nclass LoggingLazyRecord(LazyRecord):\n    def __getattr__(self, name):\n        print(\n            f\'* Called __getattr__({name!r}), populating instance dictionary\')\n        result = super() .__getattr__(name)\n        print(f\'* Returning {result!r}\')\n        return result\n\n\ndata = LoggingLazyRecord()\nprint(\'exists:    \', data.exists)\nprint(\'First foo: \', data.foo)\nprint(\'Second foo:\', data.foo)\n\n>>>\nexists:     5\n* Called __getattr__(\'foo\'), populating instance dictionary\n* Returning \'Value for foo\'\nFirst foo:  Value for foo\nSecond foo: Value for foo`, `78048843554824400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">LazyRecord</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>exists <span class="token operator">=</span> <span class="token number">5</span>\n\n    <span class="token keyword">def</span> <span class="token function">__getattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        value <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f\'Value for </span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">\'</span></span>\n        <span class="token builtin">setattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> value\n\n\n<span class="token keyword">class</span> <span class="token class-name">LoggingLazyRecord</span><span class="token punctuation">(</span>LazyRecord<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__getattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>\n            <span class="token string-interpolation"><span class="token string">f\'* Called __getattr__(</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">), populating instance dictionary\'</span></span><span class="token punctuation">)</span>\n        result <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">.</span>__getattr__<span class="token punctuation">(</span>name<span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'* Returning </span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> result\n\n\ndata <span class="token operator">=</span> LoggingLazyRecord<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'exists:    \'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>exists<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'First foo: \'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>foo<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Second foo:\'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>foo<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nexists<span class="token punctuation">:</span>     <span class="token number">5</span>\n<span class="token operator">*</span> Called __getattr__<span class="token punctuation">(</span><span class="token string">\'foo\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> populating instance dictionary\n<span class="token operator">*</span> Returning <span class="token string">\'Value for foo\'</span>\nFirst foo<span class="token punctuation">:</span>  Value <span class="token keyword">for</span> foo\nSecond foo<span class="token punctuation">:</span> Value <span class="token keyword">for</span> foo</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>exists 属性本来就在实例字典里，所以访问 data.exists 时不会触发 <code class="language-text">__getattr__</code>。接下来，开始访问 data.foo。foo 属性不在实例字典中，因此系统会触发 <code class="language-text">__getattr__</code> 方法，这个方法会通过 setattr 把 foo 属性添加到实例字典。然后，我们第二次访问 data.foo，这次 data 实例的 <code class="language-text">__dict__</code> 字典已经包含这个属性，所以不会触发 <code class="language-text">__getattr__</code>。</p>\n<p>如果要实现惰性的（lazy，也指按需的）数据访问机制，而这份数据又没有 schema，那么通过 <code class="language-text">__getattr__</code> 来做就相当合适。它只需要把属性加载一次即可，以后再访问这个属性时，系统会直接从实例字典中获取。</p>\n<p>假设我们现在还需要验证数据库系统的事务状态。也就是说，用户每次访问某属性时，我们都要确保数据库里面的那条记录依然有效，而且相应的事务也处在开启状态。这个需求没办法通过 <code class="language-text">__getattr__</code> 实现，因为一旦对象的实例字典里包含了这个属性，那么程序就会直接从字典获取，而不会再触发 <code class="language-text">__getattr__</code>。</p>\n<p>为了应对这种比较高级的用法，Python 的 object 还提供了另一个挂钩，叫作 <code class="language-text">__getattribute__</code>。只要访问对象中的属性，就会触发这个特殊方法，即便这项属性已经在 <code class="language-text">__dict__</code> 字典里，系统也还是会执行 <code class="language-text">__getattribute__</code> 方法。于是，我们可以在这个方法里面检测全局的事务状态，这样就能对每一次属性访问操作都进行验证了。同时，我们必须注意这种写法开销很大，而且会降低程序的效率，但有的时候确实值得这么做。下面就定义 ValidatingRecord 类，让它实现 <code class="language-text">__getattribute__</code> 方法，并在系统每次调用这个方法时，打印相关的日志消息。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79983571007944490000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class ValidatingRecord:\n    def __init__(self):\n        self.exists = 5\n\n    def __getattribute__(self, name):\n        print(f\'* Called __getattribute__({name!r})\')\n        try:\n            value = super().__getattribute__(name)\n            print(f\'* Found {name!r}, returning {value!r}\')\n            return value\n        except AttributeError:\n            value = f\'Value for {name}\'\n            print(f\'* Setting {name!r} to {value!r}\')\n            setattr(self, name, value)\n            return value\n\n\ndata = ValidatingRecord()\nprint(\'exists:    \', data.exists)\nprint(\'First foo: \', data.foo)\nprint(\'Second foo:\', data.foo)\n\n>>>\n* Called __getattribute__(\'exists\')\n* Found \'exists\', returning 5\nexists:     5\n* Called __getattribute__(\'foo\')\n* Setting \'foo\' to \'Value for foo\'\nFirst foo:  Value for foo\n* Called __getattribute__(\'foo\')\n* Found \'foo\', returning \'Value for foo\'\nSecond foo: Value for foo`, `79983571007944490000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">ValidatingRecord</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>exists <span class="token operator">=</span> <span class="token number">5</span>\n\n    <span class="token keyword">def</span> <span class="token function">__getattribute__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'* Called __getattribute__(</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">)\'</span></span><span class="token punctuation">)</span>\n        <span class="token keyword">try</span><span class="token punctuation">:</span>\n            value <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__getattribute__<span class="token punctuation">(</span>name<span class="token punctuation">)</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'* Found </span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">, returning </span><span class="token interpolation"><span class="token punctuation">{</span>value<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n            <span class="token keyword">return</span> value\n        <span class="token keyword">except</span> AttributeError<span class="token punctuation">:</span>\n            value <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f\'Value for </span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">\'</span></span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'* Setting </span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string"> to </span><span class="token interpolation"><span class="token punctuation">{</span>value<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n            <span class="token builtin">setattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n            <span class="token keyword">return</span> value\n\n\ndata <span class="token operator">=</span> ValidatingRecord<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'exists:    \'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>exists<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'First foo: \'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>foo<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Second foo:\'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>foo<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token operator">*</span> Called __getattribute__<span class="token punctuation">(</span><span class="token string">\'exists\'</span><span class="token punctuation">)</span>\n<span class="token operator">*</span> Found <span class="token string">\'exists\'</span><span class="token punctuation">,</span> returning <span class="token number">5</span>\nexists<span class="token punctuation">:</span>     <span class="token number">5</span>\n<span class="token operator">*</span> Called __getattribute__<span class="token punctuation">(</span><span class="token string">\'foo\'</span><span class="token punctuation">)</span>\n<span class="token operator">*</span> Setting <span class="token string">\'foo\'</span> to <span class="token string">\'Value for foo\'</span>\nFirst foo<span class="token punctuation">:</span>  Value <span class="token keyword">for</span> foo\n<span class="token operator">*</span> Called __getattribute__<span class="token punctuation">(</span><span class="token string">\'foo\'</span><span class="token punctuation">)</span>\n<span class="token operator">*</span> Found <span class="token string">\'foo\'</span><span class="token punctuation">,</span> returning <span class="token string">\'Value for foo\'</span>\nSecond foo<span class="token punctuation">:</span> Value <span class="token keyword">for</span> foo</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果要访问的属性根本就不应该存在，那么可以在 <code class="language-text">__getattr__</code> 方法里面拦截。无论是 <code class="language-text">__getattr__</code> 还是 <code class="language-text">__getattribute__</code>，都应该抛出标准的 AttributeError 来表示属性不存在或不适合存在的情况。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3306889894135922700"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MissingPropertyRecord:\n    def __getattr__(self, name):\n        if name == \'bad_name\':\n            raise AttributeError(f\'{name} is missing\')\n        return ()\n\n\ndata = MissingPropertyRecord()\ndata.bad_name\n\n>>>\nTraceback ...\nAttributeError: bad_name is missing`, `3306889894135922700`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MissingPropertyRecord</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__getattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> name <span class="token operator">==</span> <span class="token string">\'bad_name\'</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span> AttributeError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string"> is missing\'</span></span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n\ndata <span class="token operator">=</span> MissingPropertyRecord<span class="token punctuation">(</span><span class="token punctuation">)</span>\ndata<span class="token punctuation">.</span>bad_name\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nAttributeError<span class="token punctuation">:</span> bad_name <span class="token keyword">is</span> missing</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在编写通用的 Python 代码时，我们经常要依靠内置的 hasattr 函数判断属性是否存在，并且通过内置的 getattr 函数获取属性值。这些函数也会先在实例的 <code class="language-text">__dict__</code> 字典里面查找，如果找不到，则会触发 <code class="language-text">__getattr__</code>。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25236809159922012000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class LazyRecord:\n    def __init__(self):\n        self.exists = 5\n\n    def __getattr__(self, name):\n        value = f\'Value for {name}\'\n        setattr(self, name, value)\n        return value\n\n\nclass LoggingLazyRecord(LazyRecord):\n    def __getattr__(self, name):\n        print(\n            f\'* Called __getattr__({name!r}), populating instance dictionary\')\n        result = super().__getattr__(name)\n        print(f\'* Returning {result!r}\')\n        return result\n\n\ndata = LoggingLazyRecord()  # Implements __getattr__\nprint(\'Before:        \', data.__dict__)\nprint(\'Has first foo: \', hasattr(data, \'foo\'))\nprint(\'After:         \', data.__dict__)\nprint(\'Has second foo:\', hasattr(data, \'foo\'))\n\n>>>\nBefore:         {\'exists\': 5}\n* Called __getattr__(\'foo\'), populating instance dictionary\n* Returning \'Value for foo\'\nHas first foo:  True\nAfter:          {\'exists\': 5, \'foo\': \'Value for foo\'}\nHas second foo: True`, `25236809159922012000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">LazyRecord</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>exists <span class="token operator">=</span> <span class="token number">5</span>\n\n    <span class="token keyword">def</span> <span class="token function">__getattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        value <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f\'Value for </span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">\'</span></span>\n        <span class="token builtin">setattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> value\n\n\n<span class="token keyword">class</span> <span class="token class-name">LoggingLazyRecord</span><span class="token punctuation">(</span>LazyRecord<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__getattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>\n            <span class="token string-interpolation"><span class="token string">f\'* Called __getattr__(</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">), populating instance dictionary\'</span></span><span class="token punctuation">)</span>\n        result <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__getattr__<span class="token punctuation">(</span>name<span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'* Returning </span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> result\n\n\ndata <span class="token operator">=</span> LoggingLazyRecord<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># Implements __getattr__</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Before:        \'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Has first foo: \'</span><span class="token punctuation">,</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">\'foo\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After:         \'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Has second foo:\'</span><span class="token punctuation">,</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">\'foo\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore<span class="token punctuation">:</span>         <span class="token punctuation">{</span><span class="token string">\'exists\'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">}</span>\n<span class="token operator">*</span> Called __getattr__<span class="token punctuation">(</span><span class="token string">\'foo\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> populating instance dictionary\n<span class="token operator">*</span> Returning <span class="token string">\'Value for foo\'</span>\nHas first foo<span class="token punctuation">:</span>  <span class="token boolean">True</span>\nAfter<span class="token punctuation">:</span>          <span class="token punctuation">{</span><span class="token string">\'exists\'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">\'foo\'</span><span class="token punctuation">:</span> <span class="token string">\'Value for foo\'</span><span class="token punctuation">}</span>\nHas second foo<span class="token punctuation">:</span> <span class="token boolean">True</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在运行上面那段代码的过程中，<code class="language-text">__getattr__</code> 只触发了一次。假如 data 所属的类实现的不是 <code class="language-text">__getattr__</code>，而是 <code class="language-text">__getattribute__</code> 方法，那么效果就不一样了，程序每次对实例做 hasattr 与 getattr 操作时，都会触发这个方法。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81914560695771300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class ValidatingRecord:\n    def __init__(self):\n        self.exists = 5\n\n    def __getattribute__(self, name):\n        print(f\'* Called __getattribute__({name!r})\')\n        try:\n            value = super().__getattribute__(name)\n            print(f\'* Found {name!r}, returning {value!r}\')\n            return value\n        except AttributeError:\n            value = f\'Value for {name}\'\n            print(f\'* Setting {name!r} to {value!r}\')\n            setattr(self, name, value)\n            return value\n\n\ndata = ValidatingRecord()  # Implements __getattribute__\nprint(\'Has first foo: \', hasattr(data, \'foo\'))\nprint(\'Has second foo:\', hasattr(data, \'foo\'))\n\n>>>\n* Called __getattribute__(\'foo\')\n* Setting \'foo\' to \'Value for foo\'\nHas first foo:  True\n* Called __getattribute__(\'foo\')\n* Found \'foo\', returning \'Value for foo\'\nHas second foo: True`, `81914560695771300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">ValidatingRecord</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>exists <span class="token operator">=</span> <span class="token number">5</span>\n\n    <span class="token keyword">def</span> <span class="token function">__getattribute__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'* Called __getattribute__(</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">)\'</span></span><span class="token punctuation">)</span>\n        <span class="token keyword">try</span><span class="token punctuation">:</span>\n            value <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__getattribute__<span class="token punctuation">(</span>name<span class="token punctuation">)</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'* Found </span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">, returning </span><span class="token interpolation"><span class="token punctuation">{</span>value<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n            <span class="token keyword">return</span> value\n        <span class="token keyword">except</span> AttributeError<span class="token punctuation">:</span>\n            value <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f\'Value for </span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">\'</span></span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'* Setting </span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string"> to </span><span class="token interpolation"><span class="token punctuation">{</span>value<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n            <span class="token builtin">setattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n            <span class="token keyword">return</span> value\n\n\ndata <span class="token operator">=</span> ValidatingRecord<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># Implements __getattribute__</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Has first foo: \'</span><span class="token punctuation">,</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">\'foo\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Has second foo:\'</span><span class="token punctuation">,</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">\'foo\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token operator">*</span> Called __getattribute__<span class="token punctuation">(</span><span class="token string">\'foo\'</span><span class="token punctuation">)</span>\n<span class="token operator">*</span> Setting <span class="token string">\'foo\'</span> to <span class="token string">\'Value for foo\'</span>\nHas first foo<span class="token punctuation">:</span>  <span class="token boolean">True</span>\n<span class="token operator">*</span> Called __getattribute__<span class="token punctuation">(</span><span class="token string">\'foo\'</span><span class="token punctuation">)</span>\n<span class="token operator">*</span> Found <span class="token string">\'foo\'</span><span class="token punctuation">,</span> returning <span class="token string">\'Value for foo\'</span>\nHas second foo<span class="token punctuation">:</span> <span class="token boolean">True</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>假设程序给 Python 对象赋值时，我们不想立刻更新数据库，而是打算稍后再推送回去。这个功能可以通过 <code class="language-text">__setattr__</code> 实现，而它也是 object 提供的挂钩，可以拦截所有的属性赋值操作。属性的获取操作分别通过 <code class="language-text">__getattr__</code> 与 <code class="language-text">__getattribute__</code> 挂钩拦截，但设置操作只需要这一个挂钩就行。只要给实例中的属性赋值（不论是直接赋值，还是通过内置的 setattr 函数赋值），系统就触发 <code class="language-text">__setattr__</code> 方法。</p>\n<p>下面我们从 SavingRecord 中派生一个子类，让它的 <code class="language-text">__setattr__</code> 方法把每一次属性赋值操作都记录下来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67158280116216275000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class SavingRecord:\n    def __setattr__(self, name, value):\n        # Save some data for the record\n        super().__setattr__(name, value)\n\n\nclass LoggingSavingRecord(SavingRecord):\n    def __setattr__(self, name, value):\n        print(f\'* Called setattr__({name!r}, {value!r})\')\n        super().__setattr__(name, value)\n\n\ndata = LoggingSavingRecord()\nprint(\'Before: \', data.__dict__)\ndata.foo = 5\nprint(\'After:  \', data.__dict__)\ndata.foo = 7\nprint(\'Finally:\', data.__dict__)\n\n>>>\nBefore:  {}\n* Called setattr__(\'foo\', 5)\nAfter:   {\'foo\': 5}\n* Called setattr__(\'foo\', 7)\nFinally: {\'foo\': 7}`, `67158280116216275000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">SavingRecord</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__setattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token comment"># Save some data for the record</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__setattr__<span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">LoggingSavingRecord</span><span class="token punctuation">(</span>SavingRecord<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__setattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'* Called setattr__(</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{</span>value<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">)\'</span></span><span class="token punctuation">)</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__setattr__<span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n\n\ndata <span class="token operator">=</span> LoggingSavingRecord<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Before: \'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\ndata<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">5</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After:  \'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\ndata<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">7</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Finally:\'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore<span class="token punctuation">:</span>  <span class="token punctuation">{</span><span class="token punctuation">}</span>\n<span class="token operator">*</span> Called setattr__<span class="token punctuation">(</span><span class="token string">\'foo\'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>\nAfter<span class="token punctuation">:</span>   <span class="token punctuation">{</span><span class="token string">\'foo\'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">}</span>\n<span class="token operator">*</span> Called setattr__<span class="token punctuation">(</span><span class="token string">\'foo\'</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span>\nFinally<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'foo\'</span><span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><code class="language-text">__getattribute__</code> 与 <code class="language-text">__setattr__</code> 这样的方法有个问题，就是只要访问对象的属性，系统就会触发该方法。但有时候，我们其实并不希望出现这种效果。例如，我们想实现这样一个类，让它通过自制的字典而不是标准的 <code class="language-text">__dict__</code> 来保存属性，当在这个类的实例上面访问属性时，那么该实例会从自己的 <code class="language-text">_data</code> 字典里面查找。</p>\n<p>可是，这样就导致 <code class="language-text">__getattribute__</code> 方法必须访问 <code class="language-text">self._data</code> 才行。如果直接访问，那么程序就会一直递归下去，直到因为超过最大的递归层数而崩溃为止。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56786218458469564000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class BrokenDictionaryRecord:\n    def __init__(self, data):\n        self._data = data\n\n    def __getattribute__(self, name):\n        print(f\'* Called __getattribute__({name!r})\')\n        return self._data[name]\n\n\ndata = BrokenDictionaryRecord({\'foo\': 3})\ndata.foo\n\n>>>\n* Called __getattribute__(\'foo\')\n* Called __getattribute__(\'_data\')\n...\nRecursionError: maximum recursion depth exceeded while calling a Python object`, `56786218458469564000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">BrokenDictionaryRecord</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_data <span class="token operator">=</span> data\n\n    <span class="token keyword">def</span> <span class="token function">__getattribute__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'* Called __getattribute__(</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">)\'</span></span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_data<span class="token punctuation">[</span>name<span class="token punctuation">]</span>\n\n\ndata <span class="token operator">=</span> BrokenDictionaryRecord<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'foo\'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">)</span>\ndata<span class="token punctuation">.</span>foo\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token operator">*</span> Called __getattribute__<span class="token punctuation">(</span><span class="token string">\'foo\'</span><span class="token punctuation">)</span>\n<span class="token operator">*</span> Called __getattribute__<span class="token punctuation">(</span><span class="token string">\'_data\'</span><span class="token punctuation">)</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nRecursionError<span class="token punctuation">:</span> maximum recursion depth exceeded <span class="token keyword">while</span> calling a Python <span class="token builtin">object</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>为什么会这样呢？因为在 <code class="language-text">__getattribute__</code> 访问 <code class="language-text">self._data</code> 时，由于 <code class="language-text">_data</code> 是自身的一项属性，程序会触发 <code class="language-text">__getattribute__</code> 来获取这项属性，这又会访问到 <code class="language-text">self._data</code>，于是程序就一直递归下去。为解决这个问题，我们可以改用 <code class="language-text">super().__getattribute__</code> 方法获取 <code class="language-text">_data</code> 属性，由于超类的 <code class="language-text">__getattribute__</code> 是直接从实例的属性字典获取的，不会继续触发 <code class="language-text">__getattribute__</code>，这样就避开了递归。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95563875832655100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class DictionaryRecord:\n    def __init__(self, data):\n        self._data = data\n\n    def __getattribute__(self, name):\n        print(f\'* Called __getattribute__({name!r})\')\n        return super().__getattribute__(\'_data\')[name]\n\n\ndata = DictionaryRecord({\'foo\': 3})\nprint(\'foo\', data.foo)\n\n>>>\n* Called __getattribute__(\'foo\')\nfoo 3`, `95563875832655100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">DictionaryRecord</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_data <span class="token operator">=</span> data\n\n    <span class="token keyword">def</span> <span class="token function">__getattribute__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'* Called __getattribute__(</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">)\'</span></span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__getattribute__<span class="token punctuation">(</span><span class="token string">\'_data\'</span><span class="token punctuation">)</span><span class="token punctuation">[</span>name<span class="token punctuation">]</span>\n\n\ndata <span class="token operator">=</span> DictionaryRecord<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'foo\'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'foo\'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>foo<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token operator">*</span> Called __getattribute__<span class="token punctuation">(</span><span class="token string">\'foo\'</span><span class="token punctuation">)</span>\nfoo <span class="token number">3</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 <code class="language-text">__setattr__</code> 里面为这种对象实现属性修改逻辑时，也需要通过 <code class="language-text">super().__setattr__</code> 来获取 <code class="language-text">_data</code> 字典。</p>\n<h3 id="总结-43"><a href="#%E6%80%BB%E7%BB%93-43" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>如果想用自己的方式（例如惰性地或者按需地）加载并保存对象属性，那么可以在该对象所属的类里实现 <code class="language-text">__getattr__</code> 与 <code class="language-text">__setattr__</code> 特殊方法。</li>\n<li><code class="language-text">__getattr__</code> 只会在属性缺失时触发，而 <code class="language-text">__getattribute__</code> 则在每次访问属性时都要触发。</li>\n<li>在实现 <code class="language-text">__getattribute__</code> 与 <code class="language-text">__setattr__</code> 的过程中，如果要使用本对象的普通属性，那么应该通过 <code class="language-text">super()</code>（也就是 object 类）来使用，而不要直接使用，以避免无限递归。</li>\n</ol>\n<h2 id="第-48-条：用-__init_subclass__-验证子类写得是否正确"><a href="#%E7%AC%AC-48-%E6%9D%A1%EF%BC%9A%E7%94%A8-__init_subclass__-%E9%AA%8C%E8%AF%81%E5%AD%90%E7%B1%BB%E5%86%99%E5%BE%97%E6%98%AF%E5%90%A6%E6%AD%A3%E7%A1%AE" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 48 条：用 <code class="language-text">__init_subclass__</code> 验证子类写得是否正确</h2>\n<p>元类最简单的一种用法是验证某个类定义得是否正确。如果要构建一套比较复杂的类体系，那我们可能得确保这套体系中的类采用的都是同一种风格，为此我们可能需要判断这些类有没有重写必要的方法，或者判断类属性之间的关系是否合理。元类提供了一种可靠的手段，只要根据这个元类来定义新类，就能用元类中的验证逻辑核查新类的代码写得是否正确。</p>\n<p>一般来说，我们会在类的 <code class="language-text">__init__</code> 方法里面检查新对象构造得是否正确（参见第 44 条）。但有的时候，整个类的写法可能都是错的，而不单单是该类的某个对象构造得有问题，所以我们想尽早拦住这种错误。例如，当程序刚刚启动并把包含这个类的模块加载进来时，我们就想验证这个类写得对不对，此时便可利用元类来实现。</p>\n<p>在讲解如何用自定义的元类验证子类之前，我们首先必须明白元类的标准用法。元类应该从 type 之中继承。在默认情况下，系统会把通过这个元类所定义的其他类发送给元类的 <code class="language-text">__new__</code> 方法，让该方法知道那个类的 class 语句是怎么写的。下面就定义这样一个元类，如果用户通过这个元类来定义其他类，那么在那个类真正构造出来之前，我们可以先在 <code class="language-text">__new__</code> 里面观察到它的写法并做出修改。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43378268992715350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Meta(type):\n    def __new__(meta, name, bases, class_dict):\n        print(f\'* Running {meta}.__new__ for {name}\')\n        print(\'Bases:\', bases)\n        print(class_dict)\n        return type.__new__(meta, name, bases, class_dict)\n\n\nclass MyClass(metaclass=Meta):\n    stuff = 123\n\n    def foo(self):\n        pass\n\n\nclass MySubclass(MyClass):\n    other = 567\n\n    def bar(self):\n        pass\n\n>>>\n* Running <class \'__main__.Meta\'>.__new__ for MyClass\nBases: ()\n{\'__module__\': \'__main__\', \'__qualname__\': \'MyClass\', \'stuff\': 123, \'foo\': <function MyClass.foo at 0x7f7b6c15b9d0>}\n* Running <class \'__main__.Meta\'>.__new__ for MySubclass\nBases: (<class \'__main__.MyClass\'>,)\n{\'__module__\': \'__main__\', \'__qualname__\': \'MySubclass\', \'other\': 567, \'bar\': <function MySubclass.bar at 0x7f7b6c15ba60>}`, `43378268992715350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'* Running </span><span class="token interpolation"><span class="token punctuation">{</span>meta<span class="token punctuation">}</span></span><span class="token string">.__new__ for </span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Bases:\'</span><span class="token punctuation">,</span> bases<span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>class_dict<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token builtin">type</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">MyClass</span><span class="token punctuation">(</span>metaclass<span class="token operator">=</span>Meta<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    stuff <span class="token operator">=</span> <span class="token number">123</span>\n\n    <span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">pass</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">MySubclass</span><span class="token punctuation">(</span>MyClass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    other <span class="token operator">=</span> <span class="token number">567</span>\n\n    <span class="token keyword">def</span> <span class="token function">bar</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">pass</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token operator">*</span> Running <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.Meta\'</span><span class="token operator">></span><span class="token punctuation">.</span>__new__ <span class="token keyword">for</span> MyClass\nBases<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">{</span><span class="token string">\'__module__\'</span><span class="token punctuation">:</span> <span class="token string">\'__main__\'</span><span class="token punctuation">,</span> <span class="token string">\'__qualname__\'</span><span class="token punctuation">:</span> <span class="token string">\'MyClass\'</span><span class="token punctuation">,</span> <span class="token string">\'stuff\'</span><span class="token punctuation">:</span> <span class="token number">123</span><span class="token punctuation">,</span> <span class="token string">\'foo\'</span><span class="token punctuation">:</span> <span class="token operator">&lt;</span>function MyClass<span class="token punctuation">.</span>foo at <span class="token number">0x7f7b6c15b9d0</span><span class="token operator">></span><span class="token punctuation">}</span>\n<span class="token operator">*</span> Running <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.Meta\'</span><span class="token operator">></span><span class="token punctuation">.</span>__new__ <span class="token keyword">for</span> MySubclass\nBases<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.MyClass\'</span><span class="token operator">></span><span class="token punctuation">,</span><span class="token punctuation">)</span>\n<span class="token punctuation">{</span><span class="token string">\'__module__\'</span><span class="token punctuation">:</span> <span class="token string">\'__main__\'</span><span class="token punctuation">,</span> <span class="token string">\'__qualname__\'</span><span class="token punctuation">:</span> <span class="token string">\'MySubclass\'</span><span class="token punctuation">,</span> <span class="token string">\'other\'</span><span class="token punctuation">:</span> <span class="token number">567</span><span class="token punctuation">,</span> <span class="token string">\'bar\'</span><span class="token punctuation">:</span> <span class="token operator">&lt;</span>function MySubclass<span class="token punctuation">.</span>bar at <span class="token number">0x7f7b6c15ba60</span><span class="token operator">></span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>元类可以获知那个类的名称（name）、那个类的所有超类（bases）以及 class 语句体中定义的所有类属性（<code class="language-text">class_dict</code>）。因为每个类最终都要继承 object，所以这个 object 名字不会体现在罗列超类名称的 bases 元组之中。</p>\n<p>我们可以在元类的 <code class="language-text">__new__</code> 方法里面添加一些代码，用来判断根据这个元类所定义的类的各项参数是否合理。例如，要用不同的类来表示边数不同的多边形（polygon）。如果把这些类都纳入同一套体系，那么可以定义这样一个元类，让该体系内的所有类都受它约束。我们在这个元类的 <code class="language-text">__new__</code> 里面检查那些类的边数（sides）是否有效。注意，不要把检查逻辑运用到类体系的顶端，也就是基类 Polygon 上面。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97352856404904620000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class ValidatePolygon(type):\n    def __new__(meta, name, bases, class_dict):\n        # Only validate subclasses of the Polygon class\n        if bases:\n            if class_dict[\'sides\'] < 3:\n                raise ValueError(\'Polygons need 3+ sides\')\n        return type.__new__(meta, name, bases, class_dict)\n\n\nclass Polygon(metaclass=ValidatePolygon):\n    sides = None  # Must be specified by subclasses\n\n    @classmethod\n    def interior_angles(cls):\n        return (cls.sides - 2) * 180\n\n\nclass Triangle(Polygon):\n    sides = 3\n\n\nclass Rectangle(Polygon):\n    sides = 4\n\n\nclass Nonagon(Polygon):\n    sides = 9\n\n\nassert Triangle.interior_angles() == 180\nassert Rectangle.interior_angles() == 360\nassert Nonagon.interior_angles() == 1260`, `97352856404904620000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">ValidatePolygon</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token comment"># Only validate subclasses of the Polygon class</span>\n        <span class="token keyword">if</span> bases<span class="token punctuation">:</span>\n            <span class="token keyword">if</span> class_dict<span class="token punctuation">[</span><span class="token string">\'sides\'</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">:</span>\n                <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Polygons need 3+ sides\'</span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token builtin">type</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Polygon</span><span class="token punctuation">(</span>metaclass<span class="token operator">=</span>ValidatePolygon<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    sides <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># Must be specified by subclasses</span>\n\n    <span class="token decorator annotation punctuation">@classmethod</span>\n    <span class="token keyword">def</span> <span class="token function">interior_angles</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token punctuation">(</span>cls<span class="token punctuation">.</span>sides <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">180</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Triangle</span><span class="token punctuation">(</span>Polygon<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    sides <span class="token operator">=</span> <span class="token number">3</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Rectangle</span><span class="token punctuation">(</span>Polygon<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    sides <span class="token operator">=</span> <span class="token number">4</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Nonagon</span><span class="token punctuation">(</span>Polygon<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    sides <span class="token operator">=</span> <span class="token number">9</span>\n\n\n<span class="token keyword">assert</span> Triangle<span class="token punctuation">.</span>interior_angles<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">180</span>\n<span class="token keyword">assert</span> Rectangle<span class="token punctuation">.</span>interior_angles<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">360</span>\n<span class="token keyword">assert</span> Nonagon<span class="token punctuation">.</span>interior_angles<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1260</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果我们试着定义边数小于 3 的多边形子类，那么刚把那个子类的 class 语句体写完，元类就会通过 <code class="language-text">__new__</code> 方法察觉到这个问题。这意味着，只要定义了无效的多边形子类，程序就无法正常启动，除非那个类是在动态引入的模块里面定义的（参见第 88 条）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94868177590173200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Line(Polygon):\n    sides = 2\n\n>>>\nTraceback ...\nValueError: Polygons need 3+ sides`, `94868177590173200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Line</span><span class="token punctuation">(</span>Polygon<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    sides <span class="token operator">=</span> <span class="token number">2</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nValueError<span class="token punctuation">:</span> Polygons need <span class="token number">3</span><span class="token operator">+</span> sides</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样一项基本的任务竟然要写这么多代码才能实现。好在 Python 3.6 引入了一种简化的写法，能够直接通过 <code class="language-text">__init_subclass__</code> 这个特殊的类方法实现相同的功能，这样就不用专门定义元类了。下面我们改用这个机制来实现与刚才相同的验证逻辑。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81345625675141580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class BetterPolygon:\n    sides = None  # Must be specified by subclasses\n\n    def __init_subclass__(cls):\n        super().__init_subclass__()\n        if cls.sides < 3:\n            raise ValueError(\'Polygons need 3+ sides\')\n\n    @classmethod\n    def interior_angles(cls):\n        return (cls.sides - 2) * 180\n\n\nclass Hexagon(BetterPolygon):\n    sides = 6\n\n\nassert Hexagon.interior_angles() == 720`, `81345625675141580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">BetterPolygon</span><span class="token punctuation">:</span>\n    sides <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># Must be specified by subclasses</span>\n\n    <span class="token keyword">def</span> <span class="token function">__init_subclass__</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init_subclass__<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">if</span> cls<span class="token punctuation">.</span>sides <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Polygons need 3+ sides\'</span><span class="token punctuation">)</span>\n\n    @<span class="token builtin">classmethod</span>\n    <span class="token keyword">def</span> <span class="token function">interior_angles</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token punctuation">(</span>cls<span class="token punctuation">.</span>sides <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">180</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Hexagon</span><span class="token punctuation">(</span>BetterPolygon<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    sides <span class="token operator">=</span> <span class="token number">6</span>\n\n\n<span class="token keyword">assert</span> Hexagon<span class="token punctuation">.</span>interior_angles<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">720</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在的代码简短多了，完全不需要定义 ValidatePolygon 这样一个元类。在 <code class="language-text">__init_subclass__</code> 方法里面，我们可以直接通过 cls 实例来访问类级别的 sides 属性，而不用像原来那样，在存放类属性的 <code class="language-text">class_dict</code> 里面查询 sides 键。现在的多边形子类应该继承刚写的 BetterPolygon 基类。如果子类定义的边数无效，那么程序会抛出同样的异常。</p>\n<p>用标准的 Python 元类机制来实现验证还有个缺点，就是每个类只能定义一个元类。例如，这里还有一个元类，可以验证某个区域的填充色是否有效（这个区域有可能是多边形区域，也有可能不是）。</p>\n<p>如果想同时利用 Filled 的元类与 Polygon 的元类做验证，那么程序就会给出奇怪的错误消息。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34010023278778687000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class ValidatePolygon(type):\n    def __new__(meta, name, bases, class_dict):\n        # Only validate subclasses of the Polygon class\n        if bases:\n            if class_dict[\'sides\'] < 3:\n                raise ValueError(\'Polygons need 3+ sides\')\n        return type.__new__(meta, name, bases, class_dict)\n\n\nclass Polygon(metaclass=ValidatePolygon):\n    sides = None  # Must be specified by subclasses\n\n    @classmethod\n    def interior_angles(cls):\n        return (cls.sides - 2) * 180\n\n\nclass ValidateFilled(type):\n    def __new__(meta, name, bases, class_dict):\n        # Only validate subclasses of the Filled class\n        if bases:\n            if class_dict[\'color\'] not in (\'red\', \'green\'):\n                raise ValueError(\'Fill color must be supported\')\n        return type.__new__(meta, name, bases, class_dict)\n\n\nclass Filled (metaclass=ValidateFilled):\n    color = None  # Must be specified by subclasses\n\n\nclass RedPentagon(Filled, Polygon):\n    color = \'red\'\n    sides = 5\n\n>>>\nTraceback ...\nTypeError: metaclass conflict: the metaclass of a derived class must be a (non-strict) subclass of the metaclasses of all its bases`, `34010023278778687000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">ValidatePolygon</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token comment"># Only validate subclasses of the Polygon class</span>\n        <span class="token keyword">if</span> bases<span class="token punctuation">:</span>\n            <span class="token keyword">if</span> class_dict<span class="token punctuation">[</span><span class="token string">\'sides\'</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">:</span>\n                <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Polygons need 3+ sides\'</span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token builtin">type</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Polygon</span><span class="token punctuation">(</span>metaclass<span class="token operator">=</span>ValidatePolygon<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    sides <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># Must be specified by subclasses</span>\n\n    <span class="token decorator annotation punctuation">@classmethod</span>\n    <span class="token keyword">def</span> <span class="token function">interior_angles</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token punctuation">(</span>cls<span class="token punctuation">.</span>sides <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">180</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">ValidateFilled</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token comment"># Only validate subclasses of the Filled class</span>\n        <span class="token keyword">if</span> bases<span class="token punctuation">:</span>\n            <span class="token keyword">if</span> class_dict<span class="token punctuation">[</span><span class="token string">\'color\'</span><span class="token punctuation">]</span> <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token string">\'red\'</span><span class="token punctuation">,</span> <span class="token string">\'green\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n                <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Fill color must be supported\'</span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token builtin">type</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Filled</span> <span class="token punctuation">(</span>metaclass<span class="token operator">=</span>ValidateFilled<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    color <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># Must be specified by subclasses</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">RedPentagon</span><span class="token punctuation">(</span>Filled<span class="token punctuation">,</span> Polygon<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    color <span class="token operator">=</span> <span class="token string">\'red\'</span>\n    sides <span class="token operator">=</span> <span class="token number">5</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> metaclass conflict<span class="token punctuation">:</span> the metaclass of a derived <span class="token keyword">class</span> <span class="token class-name">must</span> be a <span class="token punctuation">(</span>non<span class="token operator">-</span>strict<span class="token punctuation">)</span> subclass of the metaclasses of <span class="token builtin">all</span> its bases</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>要解决这个问题，我们可以创建一套元类体系，让不同层面上的元类分别完成各自的验证逻辑（也就是先在下层元类里面验证填充色，如果验证无误，那么再去上层元类里面验证边数）。</p>\n<p>同时，这也要求我们必须设计一个支持填充色的多边形类（FilledPolygon），让它在多边形类（Polygon）的基础上增加填充色逻辑，而不能像刚才那样，把填充色与边数分别放在 Filled 与 Polygon 两个类中。现在，带有具体填充色与边数的多边形需要从这个 FilledPolygon 里面继承。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89305154887763970000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class ValidatePolygon(type):\n    def __new__(meta, name, bases, class_dict):\n        # Only validate non-root classes\n        if not class_dict.get(\'is_root\'):\n            if class_dict[\'sides\'] < 3:\n                raise ValueError(\'Polygons need 3+ sides\')\n        return type.__new__(meta, name, bases, class_dict)\n\n\nclass Polygon(metaclass=ValidatePolygon):\n    is_root = True\n    sides = None  # Must be specified by subclasses\n\n\nclass ValidateFilledPolygon(ValidatePolygon):\n    def __new__(meta, name, bases, class_dict):\n        # Only validate non-root classes\n        if not class_dict.get(\'is_root\'):\n            if class_dict[\'color\'] not in (\'red\', \'green\'):\n                raise ValueError(\'Fill color must be supported\')\n        return super().__new__(meta, name, bases, class_dict)\n\n\nclass FilledPolygon(Polygon, metaclass=ValidateFilledPolygon):\n    is_root = True\n    color = None  # Must be specified by subclasses\n\n\nclass GreenPentagon(FilledPolygon):\n    color = \'green\'\n    sides = 5\n\n\ngreenie = GreenPentagon()\nassert isinstance(greenie, Polygon)`, `89305154887763970000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">ValidatePolygon</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token comment"># Only validate non-root classes</span>\n        <span class="token keyword">if</span> <span class="token keyword">not</span> class_dict<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'is_root\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">if</span> class_dict<span class="token punctuation">[</span><span class="token string">\'sides\'</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">:</span>\n                <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Polygons need 3+ sides\'</span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token builtin">type</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Polygon</span><span class="token punctuation">(</span>metaclass<span class="token operator">=</span>ValidatePolygon<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    is_root <span class="token operator">=</span> <span class="token boolean">True</span>\n    sides <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># Must be specified by subclasses</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">ValidateFilledPolygon</span><span class="token punctuation">(</span>ValidatePolygon<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token comment"># Only validate non-root classes</span>\n        <span class="token keyword">if</span> <span class="token keyword">not</span> class_dict<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'is_root\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">if</span> class_dict<span class="token punctuation">[</span><span class="token string">\'color\'</span><span class="token punctuation">]</span> <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token string">\'red\'</span><span class="token punctuation">,</span> <span class="token string">\'green\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n                <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Fill color must be supported\'</span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">FilledPolygon</span><span class="token punctuation">(</span>Polygon<span class="token punctuation">,</span> metaclass<span class="token operator">=</span>ValidateFilledPolygon<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    is_root <span class="token operator">=</span> <span class="token boolean">True</span>\n    color <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># Must be specified by subclasses</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">GreenPentagon</span><span class="token punctuation">(</span>FilledPolygon<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    color <span class="token operator">=</span> <span class="token string">\'green\'</span>\n    sides <span class="token operator">=</span> <span class="token number">5</span>\n\n\ngreenie <span class="token operator">=</span> GreenPentagon<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">assert</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>greenie<span class="token punctuation">,</span> Polygon<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写虽然能实现验证，但却没办法组合。我们当时之所以把验证逻辑分别写在 ValidatePolygon 与 ValidateFilled 里面，就是想要让这些逻辑可以自由组合（类似 mix-in，参见第 41 条）。但是按照现在这种写法，如果想把颜色的验证逻辑施加在多边形之外的另一套类体系中，那么必须按照刚才的样板重复编写许多代码才行，而没办法很方便地复用已有的代码。</p>\n<p>这个问题，同样可以通过 <code class="language-text">__init_subclass__</code> 这个特殊的类方法来解决。在多层的类体系中，只要通过内置的 super() 函数来调用 <code class="language-text">__init_subclass__</code> 方法，系统就会按照适当的解析顺序触发超类或平级类的 <code class="language-text">__init_subclass__</code> 方法，以保证那些类在各自的 <code class="language-text">__init_subclass__</code> 里面所实现的验证逻辑也能够正确地执行（类似案例参见第 40 条）。这种写法可以正确应对多重继承。例如，下面这个 Filled 类就通过 <code class="language-text">__init_subclass__</code> 来验证填充色，这样的话，子类可以同时继承该类以及刚才的 BetterPolygon 类，从而把这两个类所实现的验证逻辑组合起来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20682268113137070000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Filled:\n    color = None  # Must be specified by subclasses\n\n    def __init_subclass__(cls):\n        super().__init_subclass__() # 调用下一个超类的方法\n        if cls.color not in (\'red\', \'green\', \'blue\'):\n            raise ValueError(\'Fills need a valid color\')\n\n\nclass BetterPolygon:\n    sides = None  # Must be specified by subclasses\n\n    def __init_subclass__(cls):\n        super().__init_subclass__() # 调用下一个超类的方法\n        if cls.sides < 3:\n            raise ValueError(\'Polygons need 3+ sides\')\n\n    @classmethod\n    def interior_angles(cls):\n        return (cls.sides - 2) * 180\n\n\nclass RedTriangle(Filled, BetterPolygon):\n    color = \'red\'\n    sides = 3\n\n\nruddy = RedTriangle()\nassert isinstance(ruddy, Filled)\nassert isinstance(ruddy, BetterPolygon)`, `20682268113137070000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Filled</span><span class="token punctuation">:</span>\n    color <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># Must be specified by subclasses</span>\n\n    <span class="token keyword">def</span> <span class="token function">__init_subclass__</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init_subclass__<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 调用下一个超类的方法</span>\n        <span class="token keyword">if</span> cls<span class="token punctuation">.</span>color <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token string">\'red\'</span><span class="token punctuation">,</span> <span class="token string">\'green\'</span><span class="token punctuation">,</span> <span class="token string">\'blue\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Fills need a valid color\'</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">BetterPolygon</span><span class="token punctuation">:</span>\n    sides <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># Must be specified by subclasses</span>\n\n    <span class="token keyword">def</span> <span class="token function">__init_subclass__</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init_subclass__<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 调用下一个超类的方法</span>\n        <span class="token keyword">if</span> cls<span class="token punctuation">.</span>sides <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'Polygons need 3+ sides\'</span><span class="token punctuation">)</span>\n\n    @<span class="token builtin">classmethod</span>\n    <span class="token keyword">def</span> <span class="token function">interior_angles</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token punctuation">(</span>cls<span class="token punctuation">.</span>sides <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">180</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">RedTriangle</span><span class="token punctuation">(</span>Filled<span class="token punctuation">,</span> BetterPolygon<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    color <span class="token operator">=</span> <span class="token string">\'red\'</span>\n    sides <span class="token operator">=</span> <span class="token number">3</span>\n\n\nruddy <span class="token operator">=</span> RedTriangle<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">assert</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>ruddy<span class="token punctuation">,</span> Filled<span class="token punctuation">)</span>\n<span class="token keyword">assert</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>ruddy<span class="token punctuation">,</span> BetterPolygon<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72186571756394095000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Top:\n    def __init_subclass__(cls):\n        super().__init_subclass__()\n        print(f\'Top for {cls}\')\n\n\nclass Left(Top):\n    def __init_subclass__(cls):\n        super().__init_subclass__()\n        print(f\'Left for {cls}\')\n\n\nclass Right(Top):\n    def __init_subclass__(cls):\n        super().__init_subclass__()\n        print(f\'Right for {cls}\')\n\n\nclass Bottom(Left, Right):\n    def __init_subclass__(cls):\n        super().__init_subclass__()\n        print(f\'Bottom for {cls}\')\n\n>>>\nTop for <class \'__main__.Left\'>\nTop for <class \'__main__.Right\'>\nTop for <class \'__main__.Bottom\'>\nRight for <class \'__main__.Bottom\'>\nLeft for <class \'__main__.Bottom\'>`, `72186571756394095000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Top</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init_subclass__</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init_subclass__<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Top for </span><span class="token interpolation"><span class="token punctuation">{</span>cls<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Left</span><span class="token punctuation">(</span>Top<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init_subclass__</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init_subclass__<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Left for </span><span class="token interpolation"><span class="token punctuation">{</span>cls<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Right</span><span class="token punctuation">(</span>Top<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init_subclass__</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init_subclass__<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Right for </span><span class="token interpolation"><span class="token punctuation">{</span>cls<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Bottom</span><span class="token punctuation">(</span>Left<span class="token punctuation">,</span> Right<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init_subclass__</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init_subclass__<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Bottom for </span><span class="token interpolation"><span class="token punctuation">{</span>cls<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTop <span class="token keyword">for</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.Left\'</span><span class="token operator">></span>\nTop <span class="token keyword">for</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.Right\'</span><span class="token operator">></span>\nTop <span class="token keyword">for</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.Bottom\'</span><span class="token operator">></span>\nRight <span class="token keyword">for</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.Bottom\'</span><span class="token operator">></span>\nLeft <span class="token keyword">for</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.Bottom\'</span><span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，解决了菱形继承问题，体系底部的 Bottom 类通过 Left 与 Right 两条路径重复继承了体系顶端的 Top 类。然而，由于是通过 super() 触发 <code class="language-text">__init_subclass__</code>，系统在处理 Bottom 类的定义时，只会把 Top 类的 <code class="language-text">__init_subclass__</code> 执行一遍。</p>\n<h3 id="总结-44"><a href="#%E6%80%BB%E7%BB%93-44" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>如果某个类是根据元类所定义的，那么当系统把该类的 class 语句体全部处理完之后，就会将这个类的写法告诉元类的 <code class="language-text">__new__</code> 方法。</li>\n<li>可以利用元类在类创建完成前检视或修改开发者根据这个元类所定义的其他类，但这种机制通常显得有点笨重。</li>\n<li><code class="language-text">__init_subclass__</code> 能够用来检查子类定义得是否合理，如果不合理，那么可以提前报错，让程序无法创建出这种子类的对象。</li>\n<li>在分层的或者涉及多重继承的类体系里面，一定别忘了在你写的这些类的<code class="language-text">__init_subclass__</code> 内通过 super() 来调用超类的 <code class="language-text">__init_subclass__</code> 方法，以便按照正确的顺序触发各类的验证逻辑。</li>\n</ol>\n<h2 id="第-49-条：用-__init_subclass__-记录现有的子类"><a href="#%E7%AC%AC-49-%E6%9D%A1%EF%BC%9A%E7%94%A8-__init_subclass__-%E8%AE%B0%E5%BD%95%E7%8E%B0%E6%9C%89%E7%9A%84%E5%AD%90%E7%B1%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 49 条：用 <code class="language-text">__init_subclass__</code> 记录现有的子类</h2>\n<p>元类还有个常见的用途，是可以自动记录（或者说注册）程序之中的类型。利用这项功能，我们就能根据某个标识符反向查出它所对应的类。</p>\n<p>例如，笔者想按照自己的办法给 Python 对象做序列化处理，并将其表示成 JSON 格式的数据。要实现这个功能，首先得想办法把对象转换成 JSON 字符串。笔者在这里设计一套通用的方案，让那些想要支持这种序列化功能的类都来继承下面这个 Serializable 基类，并把构造时所用的参数上报给它，这样的话，它就可以把这些参数转换成一份 JSON 字典。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25565573780301197000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import json\n\n\nclass Serializable:\n    def __init__(self, *args):\n        self.args = args\n\n    def serialize(self):\n        return json.dumps({\'args\': self.args})`, `25565573780301197000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> json\n\n\n<span class="token keyword">class</span> <span class="token class-name">Serializable</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>args <span class="token operator">=</span> args\n\n    <span class="token keyword">def</span> <span class="token function">serialize</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'args\'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>args<span class="token punctuation">}</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>有了这个类，我们很容易就能把 Point2D 这样简单而不可变的数据转化成 JSON 字符串。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37490923995858230000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import json\n\n\nclass Serializable:\n    def __init__(self, *args):\n        self.args = args\n\n    def serialize(self):\n        return json.dumps({\'args\': self.args})\n\n\nclass Point2D(Serializable):\n    def __init__(self, x, y):\n        super().__init__(x, y)\n        self.x = x\n        self.y = y\n\n    def __repr__(self):\n        return f\'Point2D({self.x}, {self.y})\'\n\n\npoint = Point2D(5, 3)\nprint(\'Object:    \', point)\nprint(\'Serialized:\', point.serialize())\n\n>>>\nObject:     Point2D(5, 3)\nSerialized: {&quot;args&quot;: [5, 3]}`, `37490923995858230000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> json\n\n\n<span class="token keyword">class</span> <span class="token class-name">Serializable</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>args <span class="token operator">=</span> args\n\n    <span class="token keyword">def</span> <span class="token function">serialize</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'args\'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>args<span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Point2D</span><span class="token punctuation">(</span>Serializable<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>x <span class="token operator">=</span> x\n        self<span class="token punctuation">.</span>y <span class="token operator">=</span> y\n\n    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f\'Point2D(</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>x<span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>y<span class="token punctuation">}</span></span><span class="token string">)\'</span></span>\n\n\npoint <span class="token operator">=</span> Point2D<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Object:    \'</span><span class="token punctuation">,</span> point<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Serialized:\'</span><span class="token punctuation">,</span> point<span class="token punctuation">.</span>serialize<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nObject<span class="token punctuation">:</span>     Point2D<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>\nSerialized<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"args"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>假设还需要实现反序列化的功能，也就是把 JSON 格式的字符串还原成它所表示的那个 Point2D 对象。下面，我们定义这样一个类，让它继承自 Serializable，从而获得序列化的功能，并把反序列化的功能留给自己或自己的子类去实现，这样它就成了一个既支持序列化又支持反序列化的类。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72928948845879970000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Deserializable(Serializable):\n    @classmethod\n    def deserialize(cls, json_data):\n        params = json.loads(json_data)\n        return cls(*params[\'args\'])`, `72928948845879970000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Deserializable</span><span class="token punctuation">(</span>Serializable<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    @<span class="token builtin">classmethod</span>\n    <span class="token keyword">def</span> <span class="token function">deserialize</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> json_data<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        params <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>json_data<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> cls<span class="token punctuation">(</span><span class="token operator">*</span>params<span class="token punctuation">[</span><span class="token string">\'args\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们可以通过这样一套通用的方式，让比较简单的不可变数据同时具备序列化与反序列化的功能。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63742700549666595000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import json\n\n\nclass Serializable:\n    def __init__(self, *args):\n        self.args = args\n\n    def serialize(self):\n        return json.dumps({\'args\': self.args})\n\n\nclass Deserializable(Serializable):\n    @classmethod\n    def deserialize(cls, json_data):\n        params = json.loads(json_data)\n        return cls(*params[\'args\'])\n\n\nclass BetterPoint2D(Deserializable):\n    def __init__(self, x, y):\n        super().__init__(x, y)\n        self.x = x\n        self.y = y\n\n    def __repr__(self):\n        return f\'Point2D({self.x}, {self.y})\'\n\n\nbefore = BetterPoint2D(5, 3)\nprint(\'Before:    \',  before)\ndata = before.serialize()\nprint(\'Serialized:\', data)\nafter = BetterPoint2D.deserialize(data)\nprint(\'After:     \', after)\n\n>>>\nBefore:     Point2D(5, 3)\nSerialized: {&quot;args&quot;: [5, 3]}\nAfter:      Point2D(5, 3)`, `63742700549666595000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> json\n\n\n<span class="token keyword">class</span> <span class="token class-name">Serializable</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>args <span class="token operator">=</span> args\n\n    <span class="token keyword">def</span> <span class="token function">serialize</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'args\'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>args<span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Deserializable</span><span class="token punctuation">(</span>Serializable<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    @<span class="token builtin">classmethod</span>\n    <span class="token keyword">def</span> <span class="token function">deserialize</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> json_data<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        params <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>json_data<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> cls<span class="token punctuation">(</span><span class="token operator">*</span>params<span class="token punctuation">[</span><span class="token string">\'args\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">BetterPoint2D</span><span class="token punctuation">(</span>Deserializable<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>x <span class="token operator">=</span> x\n        self<span class="token punctuation">.</span>y <span class="token operator">=</span> y\n\n    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f\'Point2D(</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>x<span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>y<span class="token punctuation">}</span></span><span class="token string">)\'</span></span>\n\n\nbefore <span class="token operator">=</span> BetterPoint2D<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Before:    \'</span><span class="token punctuation">,</span>  before<span class="token punctuation">)</span>\ndata <span class="token operator">=</span> before<span class="token punctuation">.</span>serialize<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Serialized:\'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>\nafter <span class="token operator">=</span> BetterPoint2D<span class="token punctuation">.</span>deserialize<span class="token punctuation">(</span>data<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After:     \'</span><span class="token punctuation">,</span> after<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore<span class="token punctuation">:</span>     Point2D<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>\nSerialized<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"args"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">}</span>\nAfter<span class="token punctuation">:</span>      Point2D<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个方案的缺点是，我们必须提前知道 JSON 字符串所表示的类型（例如 Point2D 或 BetterPoint2D），然后才能把它还原成对象。如果只用一个函数就能把各种 JSON 字符串分别还原成对应类型的 Python 对象，那就更好了。</p>\n<p>为了实现这项功能，我们把对象所属的类名也添加到序列化之后的 JSON 数据里面。</p>\n<p>然后，我们用一份字典把支持序列化与反序列化的类记录下来，字典的键为类的名称，与还原这种对象时所要用到的构造函数相对应。这样的话，凡是经由 <code class="language-text">register_class</code> 注册的类，其 JSON 数据都可以通过 deserialize 函数还原成相应的对象。</p>\n<p>为确保 deserialize 函数能够正确还原 JSON 数据，我们必须把想要支持反序列化功能的类通过 <code class="language-text">register_class</code> 注册进去。</p>\n<p>这样就可以把任意的 JSON 字符串都还原为相应的对象，而不需要明确指出类名，因为 deserialize 函数会从注册字典里面查询。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20956056533148336000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import json\n\n\nclass BetterSerializable:\n    def __init__(self, *args):\n        self.args = args\n\n    def serialize(self):\n        return json.dumps({\n            \'class\': self.__class__.__name__,\n            \'args\': self.args,\n        })\n\n    def __repr__(self):\n        name = self.__class__.__name__\n        args_str = \', \'.join(str(x) for x in self.args)\n        return f\'{name}({args_str})\'\n\n\nregistry = {}\n\n\ndef register_class(target_class):\n    registry[target_class.__name__] = target_class\n\n\ndef deserialize(data):\n    params = json.loads(data)\n    name = params[\'class\']\n    target_class = registry[name]\n    return target_class(*params[\'args\'])\n\n\nclass EvenBetterPoint2D(BetterSerializable):\n    def __init__(self, x, y):\n        super().__init__(x, y)\n        self.x = x\n        self.y = y\n\n\nregister_class(EvenBetterPoint2D)\n\n\nbefore = EvenBetterPoint2D(5, 3)\nprint(\'Before:    \', before)\ndata = before.serialize()\nprint(\'Serialized:\', data)\nafter = deserialize(data)\nprint(\'After:     \', after)\n\n>>>\nBefore:     EvenBetterPoint2D(5, 3)\nSerialized: {&quot;class&quot;: &quot;EvenBetterPoint2D&quot;, &quot;args&quot;: [5, 3]}\nAfter:      EvenBetterPoint2D(5, 3)`, `20956056533148336000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> json\n\n\n<span class="token keyword">class</span> <span class="token class-name">BetterSerializable</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>args <span class="token operator">=</span> args\n\n    <span class="token keyword">def</span> <span class="token function">serialize</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span>\n            <span class="token string">\'class\'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__<span class="token punctuation">,</span>\n            <span class="token string">\'args\'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>args<span class="token punctuation">,</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        name <span class="token operator">=</span> self<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__\n        args_str <span class="token operator">=</span> <span class="token string">\', \'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> self<span class="token punctuation">.</span>args<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token punctuation">{</span>args_str<span class="token punctuation">}</span></span><span class="token string">)\'</span></span>\n\n\nregistry <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n\n<span class="token keyword">def</span> <span class="token function">register_class</span><span class="token punctuation">(</span>target_class<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    registry<span class="token punctuation">[</span>target_class<span class="token punctuation">.</span>__name__<span class="token punctuation">]</span> <span class="token operator">=</span> target_class\n\n\n<span class="token keyword">def</span> <span class="token function">deserialize</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    params <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">)</span>\n    name <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token string">\'class\'</span><span class="token punctuation">]</span>\n    target_class <span class="token operator">=</span> registry<span class="token punctuation">[</span>name<span class="token punctuation">]</span>\n    <span class="token keyword">return</span> target_class<span class="token punctuation">(</span><span class="token operator">*</span>params<span class="token punctuation">[</span><span class="token string">\'args\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">EvenBetterPoint2D</span><span class="token punctuation">(</span>BetterSerializable<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>x <span class="token operator">=</span> x\n        self<span class="token punctuation">.</span>y <span class="token operator">=</span> y\n\n\nregister_class<span class="token punctuation">(</span>EvenBetterPoint2D<span class="token punctuation">)</span>\n\n\nbefore <span class="token operator">=</span> EvenBetterPoint2D<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Before:    \'</span><span class="token punctuation">,</span> before<span class="token punctuation">)</span>\ndata <span class="token operator">=</span> before<span class="token punctuation">.</span>serialize<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Serialized:\'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>\nafter <span class="token operator">=</span> deserialize<span class="token punctuation">(</span>data<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After:     \'</span><span class="token punctuation">,</span> after<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore<span class="token punctuation">:</span>     EvenBetterPoint2D<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>\nSerialized<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"class"</span><span class="token punctuation">:</span> <span class="token string">"EvenBetterPoint2D"</span><span class="token punctuation">,</span> <span class="token string">"args"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">}</span>\nAfter<span class="token punctuation">:</span>      EvenBetterPoint2D<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当然这个方案也有不好的地方，那就是开发者可能会忘记调用 <code class="language-text">register_class</code>。</p>\n<p>如果没有注册就想还原数据，那么程序会在通过 deserialize 函数反序列化这份数据时出错。</p>\n<p>可以看到，尽管 Point3D 已经继承了 BetterSerializable，但这只能让它享有序列化的功能，至于反序列化，则必须得在定义完 class 语句体之后，手工调用 <code class="language-text">register_class</code> 函数进行注册后才能享有。所以，这个方案很容易出错，编程新手用起来尤其困难。类修饰器（class decorator）也会有这种问题（适用场合参见第 51 条）。</p>\n<p>那么，怎样才能让子类只需继承 BetterSerializable，就能同时获得序列化与反序列化功能，而不用专门手动通过 <code class="language-text">register_class</code> 注册呢？这可以利用元类实现，也就是让元类把子类的 class 定义拦截下来，然后自动调用 <code class="language-text">register_class</code> 去注册（参见第 48 条）。下面，我们就写这样一个元类，让它在得知开发者定义了 RegisteredSerializable 的某个子类之后，立刻通过 <code class="language-text">register_class</code> 注册。</p>\n<p>用户只要把 RegisteredSerializable 的子类定义完，就可以确信程序已经通过 <code class="language-text">register_class</code> 将这个子类注册过了，所以它肯定支持反序列化。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10474997947129827000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import json\n\n\nclass BetterSerializable:\n    def __init__(self, *args):\n        self.args = args\n\n    def serialize(self):\n        return json.dumps({\n            \'class\': self.__class__.__name__,\n            \'args\': self.args,\n        })\n\n    def __repr__(self):\n        name = self.__class__.__name__\n        args_str = \', \'.join(str(x) for x in self.args)\n        return f\'{name}({args_str})\'\n\n\nregistry = {}\n\n\ndef register_class(target_class):\n    registry[target_class.__name__] = target_class\n\n\ndef deserialize(data):\n    params = json.loads(data)\n    name = params[\'class\']\n    target_class = registry[name]\n    return target_class(*params[\'args\'])\n\n\nclass Meta(type):\n    def __new__(meta, name, bases, class_dict):\n        cls = type.__new__(meta, name, bases, class_dict)\n        register_class(cls)\n        return cls\n\n\nclass RegisteredSerializable(BetterSerializable,\n                             metaclass=Meta):\n    pass\n\n\nclass Vector3D(RegisteredSerializable):\n    def __init__(self, x, y, z):\n        super().__init__(x, y, z)\n        self.x, self.y, self.z = x, y, z\n\n\nbefore = Vector3D(10, -7, 3)\nprint(\'Before:    \', before)\ndata = before.serialize()\nprint(\'Serialized:\', data)\nprint(\'After:     \', deserialize(data))\n\n>>>\nBefore:     Vector3D(10, -7, 3)\nSerialized: {&quot;class&quot;: &quot;Vector3D&quot;, &quot;args&quot;: [10, -7, 3]}\nAfter:      Vector3D(10, -7, 3)`, `10474997947129827000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> json\n\n\n<span class="token keyword">class</span> <span class="token class-name">BetterSerializable</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>args <span class="token operator">=</span> args\n\n    <span class="token keyword">def</span> <span class="token function">serialize</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span>\n            <span class="token string">\'class\'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__<span class="token punctuation">,</span>\n            <span class="token string">\'args\'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>args<span class="token punctuation">,</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        name <span class="token operator">=</span> self<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__\n        args_str <span class="token operator">=</span> <span class="token string">\', \'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> self<span class="token punctuation">.</span>args<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token punctuation">{</span>args_str<span class="token punctuation">}</span></span><span class="token string">)\'</span></span>\n\n\nregistry <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n\n<span class="token keyword">def</span> <span class="token function">register_class</span><span class="token punctuation">(</span>target_class<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    registry<span class="token punctuation">[</span>target_class<span class="token punctuation">.</span>__name__<span class="token punctuation">]</span> <span class="token operator">=</span> target_class\n\n\n<span class="token keyword">def</span> <span class="token function">deserialize</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    params <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">)</span>\n    name <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token string">\'class\'</span><span class="token punctuation">]</span>\n    target_class <span class="token operator">=</span> registry<span class="token punctuation">[</span>name<span class="token punctuation">]</span>\n    <span class="token keyword">return</span> target_class<span class="token punctuation">(</span><span class="token operator">*</span>params<span class="token punctuation">[</span><span class="token string">\'args\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        cls <span class="token operator">=</span> <span class="token builtin">type</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span>\n        register_class<span class="token punctuation">(</span>cls<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> cls\n\n\n<span class="token keyword">class</span> <span class="token class-name">RegisteredSerializable</span><span class="token punctuation">(</span>BetterSerializable<span class="token punctuation">,</span>\n                             metaclass<span class="token operator">=</span>Meta<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Vector3D</span><span class="token punctuation">(</span>RegisteredSerializable<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>x<span class="token punctuation">,</span> self<span class="token punctuation">.</span>y<span class="token punctuation">,</span> self<span class="token punctuation">.</span>z <span class="token operator">=</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z\n\n\nbefore <span class="token operator">=</span> Vector3D<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Before:    \'</span><span class="token punctuation">,</span> before<span class="token punctuation">)</span>\ndata <span class="token operator">=</span> before<span class="token punctuation">.</span>serialize<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Serialized:\'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After:     \'</span><span class="token punctuation">,</span> deserialize<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore<span class="token punctuation">:</span>     Vector3D<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>\nSerialized<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"class"</span><span class="token punctuation">:</span> <span class="token string">"Vector3D"</span><span class="token punctuation">,</span> <span class="token string">"args"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">}</span>\nAfter<span class="token punctuation">:</span>      Vector3D<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>还有一种办法比上面的实现方式更简单，那就是通过名为 <code class="language-text">__init_subclass__</code> 的特殊类方法来实现。这是 Python 3.6 引入的新写法，我们只需要编很少的代码，就可以把自己的逻辑运用到子类上面。有些编程新手可能不太熟悉元类那种比较复杂的写法，但如果改用下面这种方案，他们应该很容易就能看懂。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2927835071642026500"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import json\n\n\nclass BetterSerializable:\n    def __init__(self, *args):\n        self.args = args\n\n    def serialize(self):\n        return json.dumps({\n            \'class\': self.__class__.__name__,\n            \'args\': self.args,\n        })\n\n    def __repr__(self):\n        name = self.__class__.__name__\n        args_str = \', \'.join(str(x) for x in self.args)\n        return f\'{name}({args_str})\'\n\n\nregistry = {}\n\n\ndef register_class(target_class):\n    registry[target_class.__name__] = target_class\n\n\ndef deserialize(data):\n    params = json.loads(data)\n    name = params[\'class\']\n    target_class = registry[name]\n    return target_class(*params[\'args\'])\n\n\nclass BetterRegisteredSerializable(BetterSerializable):\n    def __init_subclass__(cls):\n        super().__init_subclass__()\n        register_class(cls)\n\n\nclass Vector1D(BetterRegisteredSerializable):\n    def __init__(self, magnitude):\n        super().__init__(magnitude)\n        self.magnitude = magnitude\n\n\nbefore = Vector1D(6)\nprint(\'Before:    \', before)\ndata = before.serialize()\nprint(\'Serialized:\', data)\nprint(\'After:     \', deserialize(data))\n\n>>>\nBefore:     Vector1D(6)\nSerialized: {&quot;class&quot;: &quot;Vector1D&quot;, &quot;args&quot;: [6]}\nAfter:      Vector1D(6)`, `2927835071642026500`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> json\n\n\n<span class="token keyword">class</span> <span class="token class-name">BetterSerializable</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>args <span class="token operator">=</span> args\n\n    <span class="token keyword">def</span> <span class="token function">serialize</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span>\n            <span class="token string">\'class\'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__<span class="token punctuation">,</span>\n            <span class="token string">\'args\'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>args<span class="token punctuation">,</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        name <span class="token operator">=</span> self<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__\n        args_str <span class="token operator">=</span> <span class="token string">\', \'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> self<span class="token punctuation">.</span>args<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token punctuation">{</span>args_str<span class="token punctuation">}</span></span><span class="token string">)\'</span></span>\n\n\nregistry <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n\n<span class="token keyword">def</span> <span class="token function">register_class</span><span class="token punctuation">(</span>target_class<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    registry<span class="token punctuation">[</span>target_class<span class="token punctuation">.</span>__name__<span class="token punctuation">]</span> <span class="token operator">=</span> target_class\n\n\n<span class="token keyword">def</span> <span class="token function">deserialize</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    params <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">)</span>\n    name <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token string">\'class\'</span><span class="token punctuation">]</span>\n    target_class <span class="token operator">=</span> registry<span class="token punctuation">[</span>name<span class="token punctuation">]</span>\n    <span class="token keyword">return</span> target_class<span class="token punctuation">(</span><span class="token operator">*</span>params<span class="token punctuation">[</span><span class="token string">\'args\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">BetterRegisteredSerializable</span><span class="token punctuation">(</span>BetterSerializable<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init_subclass__</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init_subclass__<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        register_class<span class="token punctuation">(</span>cls<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Vector1D</span><span class="token punctuation">(</span>BetterRegisteredSerializable<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> magnitude<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>magnitude<span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>magnitude <span class="token operator">=</span> magnitude\n\n\nbefore <span class="token operator">=</span> Vector1D<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Before:    \'</span><span class="token punctuation">,</span> before<span class="token punctuation">)</span>\ndata <span class="token operator">=</span> before<span class="token punctuation">.</span>serialize<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Serialized:\'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'After:     \'</span><span class="token punctuation">,</span> deserialize<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore<span class="token punctuation">:</span>     Vector1D<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>\nSerialized<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"class"</span><span class="token punctuation">:</span> <span class="token string">"Vector1D"</span><span class="token punctuation">,</span> <span class="token string">"args"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">}</span>\nAfter<span class="token punctuation">:</span>      Vector1D<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在类体系正确无误的前提下，通过 <code class="language-text">__init_subclass__</code>（或元类）自动注册子类可以避免程序由于用户忘记注册而引发问题。这不仅适用于上述序列化与反序列化功能的实现，而且还可以用在数据库的对象关系映射（object-relational mapping，ORM）、可扩展的插件系统以及回调挂钩上面。</p>\n<h3 id="总结-45"><a href="#%E6%80%BB%E7%BB%93-45" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>类注册（Class registration）是个相当有用的模式，可以用来构建模块式的 Python 程序。</li>\n<li>我们可以通过基类的元类把用户从这个基类派生出来的子类自动注册给系统。</li>\n<li>利用元类实现类注册可以防止由于用户忘记注册而导致程序出现问题。</li>\n<li>优先考虑通过 <code class="language-text">__init_subclass__</code> 实现自动注册，而不要用标准的元类机制来实现，因为 <code class="language-text">__init_subclass__</code> 更清晰，更便于初学者理解。</li>\n</ol>\n<h2 id="第-50-条：用-__set_name__-给类属性加注解"><a href="#%E7%AC%AC-50-%E6%9D%A1%EF%BC%9A%E7%94%A8-__set_name__-%E7%BB%99%E7%B1%BB%E5%B1%9E%E6%80%A7%E5%8A%A0%E6%B3%A8%E8%A7%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 50 条：用 <code class="language-text">__set_name__</code> 给类属性加注解</h2>\n<p>元类还有一个更有用的功能，那就是可以在某个类真正投入使用之前，率先修改或注解这个类所定义的属性。这通常需要与描述符（descriptor）搭配使用（参见第 46 条），这样可以让我们更详细地了解这些属性在定义它们的那个类里是如何使用的。</p>\n<p>例如，我们要定义一个新的类，来表示客户数据库中的每一行数据。这个类需要定义一些属性，与数据表中的各列相对应，每个属性都分别表示这行数据在这一列的取值。下面用描述符类来实现这些属性，把它们和数据表中同名的列联系起来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50727335699891610000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Field:\n    def __init__(self, name):\n        self.name = name\n        self.internal_name = \'_\' + self.name\n\n    def __get__(self, instance, instance_type):\n        if instance is None:\n            return self\n        return getattr(instance, self.internal_name, \'\')\n\n    def __set__(self, instance, value):\n        setattr(instance, self.internal_name, value)`, `50727335699891610000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Field</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name\n        self<span class="token punctuation">.</span>internal_name <span class="token operator">=</span> <span class="token string">\'_\'</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>name\n\n    <span class="token keyword">def</span> <span class="token function">__get__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> instance_type<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> instance <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self\n        <span class="token keyword">return</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> self<span class="token punctuation">.</span>internal_name<span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__set__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">setattr</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> self<span class="token punctuation">.</span>internal_name<span class="token punctuation">,</span> value<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Field 描述符的 name 属性指的就是数据表中那一列的列名，所以，我们可以通过内置的 setattr 函数把每行数据在这个属性上面的取值保存到那行数据自己的状态字典里面去，只不过属性名应该稍加调整，我们给它前面加个下划线表示它是受到保护的属性。另外，我们通过 getattr 函数实现属性加载功能。这种写法，看上去似乎要比把每个实例在这项属性上面的取值都保存到 weakref 字典里面更简单（那种字典是 weakref 模块所提供的特殊字典，用以防止内存泄漏）。</p>\n<p>下面定义 Customer 类，每个 Customer 都表示数据表中的一行数据，其中的四个属性分别对应于这行数据在那四列上面的取值。</p>\n<p>这个类用起来很简单。可以看到，早前定义的 Field 描述符能够正确地修改 cust 实例中的 <code class="language-text">__dict__</code> 字典。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60346530317271700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Field:\n    def __init__(self, name):\n        self.name = name\n        self.internal_name = \'_\' + self.name\n\n    def __get__(self, instance, instance_type):\n        if instance is None:\n            return self\n        return getattr(instance, self.internal_name, \'\')\n\n    def __set__(self, instance, value):\n        setattr(instance, self.internal_name, value)\n\n\nclass Customer:\n    # Class attributes\n    first_name = Field(\'first_name\')\n    last_name = Field(\'last_name\')\n    prefix = Field(\'prefix\')\n    suffix = Field(\'suffix\')\n\n\ncust = Customer()\nprint(f\'Before: {cust.first_name!r} {cust.__dict__}\')\ncust.first_name = \'Euclid\'\nprint(f\'After:  {cust.first_name!r} {cust.__dict__}\')\n\n>>>\nBefore: \'\' {}\nAfter:  \'Euclid\' {\'_first_name\': \'Euclid\'}`, `60346530317271700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Field</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name\n        self<span class="token punctuation">.</span>internal_name <span class="token operator">=</span> <span class="token string">\'_\'</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>name\n\n    <span class="token keyword">def</span> <span class="token function">__get__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> instance_type<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> instance <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self\n        <span class="token keyword">return</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> self<span class="token punctuation">.</span>internal_name<span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__set__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">setattr</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> self<span class="token punctuation">.</span>internal_name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Customer</span><span class="token punctuation">:</span>\n    <span class="token comment"># Class attributes</span>\n    first_name <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token string">\'first_name\'</span><span class="token punctuation">)</span>\n    last_name <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token string">\'last_name\'</span><span class="token punctuation">)</span>\n    prefix <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token string">\'prefix\'</span><span class="token punctuation">)</span>\n    suffix <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token string">\'suffix\'</span><span class="token punctuation">)</span>\n\n\ncust <span class="token operator">=</span> Customer<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Before: </span><span class="token interpolation"><span class="token punctuation">{</span>cust<span class="token punctuation">.</span>first_name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>cust<span class="token punctuation">.</span>__dict__<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\ncust<span class="token punctuation">.</span>first_name <span class="token operator">=</span> <span class="token string">\'Euclid\'</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'After:  </span><span class="token interpolation"><span class="token punctuation">{</span>cust<span class="token punctuation">.</span>first_name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>cust<span class="token punctuation">.</span>__dict__<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore<span class="token punctuation">:</span> <span class="token string">\'\'</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\nAfter<span class="token punctuation">:</span>  <span class="token string">\'Euclid\'</span> <span class="token punctuation">{</span><span class="token string">\'_first_name\'</span><span class="token punctuation">:</span> <span class="token string">\'Euclid\'</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写虽然没错，但是类的定义似乎有点重复。在给 Customer 类定义字段时，既然等号左边已经写出了字段的名称（例如 <code class="language-text">first_name</code>），那为什么等号右边的 Field 构造函数里，还要再写一次呢？</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44633022853717926000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Customer:\n    # Left side is redundant with right side\n    first_name = Field(\'first_name\')\n    ...`, `44633022853717926000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Customer</span><span class="token punctuation">:</span>\n    <span class="token comment"># Left side is redundant with right side</span>\n    first_name <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token string">\'first_name\'</span><span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这是因为，Customer 类在定义字段时，要按照从右到左的顺序解读，而不是像阅读代码时那样，从左到右阅读。所以，程序必须首先处理等号右边的部分，也就是 <code class="language-text">Field(&#39;first_name&#39;)</code>，然后才能把这个 Field 构造函数所返回的值赋给左边的 <code class="language-text">first_name</code>。等号右边的 Field 实例没办法提前知道，它将被赋给类的哪一个属性。</p>\n<p>这样的重复代码，可以利用元类来消除。元类可以当作 class 语句的挂钩，只要 class 语句体定义完毕，元类就会看到它的写法并尽快做出应对（具体原理参见第 48 条）。在本例中，我们可以让元类自动给每个 Field 描述符的 name 与 <code class="language-text">internal_name</code> 赋值，而不用再像原来那样，需要开发者把字段名称重复书写一遍并手动传给 Field 的构造函数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83370339855801730000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Meta(type):\n    def __new__(meta, name, bases, class_dict):\n        for key, value in class_dict.items():\n            if isinstance(value, Field):\n                value.name = key\n                value.internal_name = \'_\' + key\n        cls = type.__new__(meta, name, bases, class_dict)\n        return cls`, `83370339855801730000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> class_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> Field<span class="token punctuation">)</span><span class="token punctuation">:</span>\n                value<span class="token punctuation">.</span>name <span class="token operator">=</span> key\n                value<span class="token punctuation">.</span>internal_name <span class="token operator">=</span> <span class="token string">\'_\'</span> <span class="token operator">+</span> key\n        cls <span class="token operator">=</span> <span class="token builtin">type</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> cls</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>下面定义一个基类，让该基类把刚才定义好的 Meta 当成元类。凡是表示数据库某行的类都继承自该基类，以确保它们可以利用元类所提供的功能。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58588752903060070000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class DatabaseRow(metaclass=Meta):\n    pass`, `58588752903060070000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">DatabaseRow</span><span class="token punctuation">(</span>metaclass<span class="token operator">=</span>Meta<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>为了跟元类配合，Field 描述符需要稍加调整。它的大部分代码都可以沿用，只是现在已经不用再要求调用者把名称传给构造函数了，因为这次元类的 <code class="language-text">__new__</code> 方法会自动设置名称。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16225856830682606000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Field:\n    def __init__(self):\n        # These will be assigned by the metaclass.\n        self.name = None\n        self.internal_name = None\n\n    def __get__(self, instance, instance_type):\n        if instance is None:\n            return self\n\n        return getattr(instance, self.internal_name, \'\')\n\n    def __set__(self, instance, value):\n        setattr(instance, self.internal_name, value)`, `16225856830682606000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Field</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token comment"># These will be assigned by the metaclass.</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token boolean">None</span>\n        self<span class="token punctuation">.</span>internal_name <span class="token operator">=</span> <span class="token boolean">None</span>\n\n    <span class="token keyword">def</span> <span class="token function">__get__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> instance_type<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> instance <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self\n\n        <span class="token keyword">return</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> self<span class="token punctuation">.</span>internal_name<span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__set__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">setattr</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> self<span class="token punctuation">.</span>internal_name<span class="token punctuation">,</span> value<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>有了元类、DatabaseRow 基类以及修改过的 Field 描述符，我们在给客户类定义字段时，就不用手工传入字段名了，代码也不像之前那样冗余了。</p>\n<p>这个新类的效果与早前那个类一样。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71682410176649716000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Field:\n    def __init__(self):\n        # These will be assigned by the metaclass.\n        self.name = None\n        self.internal_name = None\n\n    def __get__(self, instance, instance_type):\n        if instance is None:\n            return self\n        return getattr(instance, self.internal_name, \'\')\n\n    def __set__(self, instance, value):\n        setattr(instance, self.internal_name, value)\n\n\nclass Meta(type):\n    def __new__(meta, name, bases, class_dict):\n        for key, value in class_dict.items():\n            if isinstance(value, Field):\n                value.name = key\n                value.internal_name = \'_\' + key\n        cls = type.__new__(meta, name, bases, class_dict)\n        return cls\n\n\nclass DatabaseRow(metaclass=Meta):\n    pass\n\n\nclass BetterCustomer(DatabaseRow):\n    # Class attributes\n    first_name = Field()\n    last_name = Field()\n    prefix = Field()\n    suffix = Field()\n\n\ncust = BetterCustomer()\nprint(f\'Before: {cust.first_name!r} {cust.__dict__}\')\ncust.first_name = \'Euler\'\nprint(f\'After : {cust.first_name!r} {cust.__dict__}\')\n\n>>>\nBefore: \'\' {}\nAfter : \'Euler\' {\'_first_name\': \'Euler\'}`, `71682410176649716000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Field</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token comment"># These will be assigned by the metaclass.</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token boolean">None</span>\n        self<span class="token punctuation">.</span>internal_name <span class="token operator">=</span> <span class="token boolean">None</span>\n\n    <span class="token keyword">def</span> <span class="token function">__get__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> instance_type<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> instance <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self\n        <span class="token keyword">return</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> self<span class="token punctuation">.</span>internal_name<span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__set__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">setattr</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> self<span class="token punctuation">.</span>internal_name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> class_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> Field<span class="token punctuation">)</span><span class="token punctuation">:</span>\n                value<span class="token punctuation">.</span>name <span class="token operator">=</span> key\n                value<span class="token punctuation">.</span>internal_name <span class="token operator">=</span> <span class="token string">\'_\'</span> <span class="token operator">+</span> key\n        cls <span class="token operator">=</span> <span class="token builtin">type</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> cls\n\n\n<span class="token keyword">class</span> <span class="token class-name">DatabaseRow</span><span class="token punctuation">(</span>metaclass<span class="token operator">=</span>Meta<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">BetterCustomer</span><span class="token punctuation">(</span>DatabaseRow<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token comment"># Class attributes</span>\n    first_name <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    last_name <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    prefix <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    suffix <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n\ncust <span class="token operator">=</span> BetterCustomer<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Before: </span><span class="token interpolation"><span class="token punctuation">{</span>cust<span class="token punctuation">.</span>first_name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>cust<span class="token punctuation">.</span>__dict__<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\ncust<span class="token punctuation">.</span>first_name <span class="token operator">=</span> <span class="token string">\'Euler\'</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'After : </span><span class="token interpolation"><span class="token punctuation">{</span>cust<span class="token punctuation">.</span>first_name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>cust<span class="token punctuation">.</span>__dict__<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore<span class="token punctuation">:</span> <span class="token string">\'\'</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\nAfter <span class="token punctuation">:</span> <span class="token string">\'Euler\'</span> <span class="token punctuation">{</span><span class="token string">\'_first_name\'</span><span class="token punctuation">:</span> <span class="token string">\'Euler\'</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个办法的缺点是，要想在类中声明 Field 字段，这个类必须从 DatabaseRow 继承。假如忘了继承，或者所面对的类体系在结构上不方便这样继承，那么代码就无法正常运行。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56555342702866880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class BrokenCustomer:\n    first_name = Field()\n    last_name = Field()\n    prefix = Field()\n    suffix = Field()\n\n\ncust = BrokenCustomer()\ncust.first_name = \'Mersenne\'\n\n>>>\nTraceback ...\nTypeError: attribute name must be string, not \'NoneType\'`, `56555342702866880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">BrokenCustomer</span><span class="token punctuation">:</span>\n    first_name <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    last_name <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    prefix <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    suffix <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n\ncust <span class="token operator">=</span> BrokenCustomer<span class="token punctuation">(</span><span class="token punctuation">)</span>\ncust<span class="token punctuation">.</span>first_name <span class="token operator">=</span> <span class="token string">\'Mersenne\'</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> attribute name must be string<span class="token punctuation">,</span> <span class="token keyword">not</span> <span class="token string">\'NoneType\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个问题可以通过给描述符定义 <code class="language-text">__set_name__</code> 特殊方法来解决。这是 Python 3.6 引入的新功能：如果某个类用这种描述符的实例来定义字段，那么系统就会在描述符上面触发这个特殊方法。系统会把采用这个描述符实例作字段的那个类以及字段的名称，当成参数传给 <code class="language-text">__set_name__</code>。下面我们将 <code class="language-text">Meta.__new__</code> 之中的逻辑移动到 Field 描述符的 <code class="language-text">__set_name__</code> 里面，这样一来，就不用定义元类了。</p>\n<p>现在，我们可以直接在类里通过 Field 描述符来定义字段，而不用再让这个类继承某个基类，还能把元类给省掉。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38716761464796140000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Field:\n    def __init__(self):\n        self.name = None\n        self.internal_name = None\n\n    def __set_name__(self, owner, name):\n        # Called on class creation for each descriptor\n        self.name = name\n        self.internal_name = \'_\' + name\n\n    def __get__(self, instance, instance_type):\n        if instance is None:\n            return self\n        return getattr(instance, self.internal_name, \'\')\n\n    def __set__(self, instance, value):\n        setattr(instance, self.internal_name, value)\n\n\nclass FixedCustomer:\n    first_name = Field()\n    last_name = Field()\n    prefix = Field()\n    suffix = Field()\n\n\ncust = FixedCustomer()\nprint(f\'Before: {cust.first_name!r} {cust.__dict__}\')\ncust.first_name = \'Mersenne\'\nprint(f\'After : {cust.first_name!r} {cust.__dict__}\')\n\n>>>\nBefore: \'\' {}\nAfter : \'Mersenne\' {\'_first_name\': \'Mersenne\'}`, `38716761464796140000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Field</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token boolean">None</span>\n        self<span class="token punctuation">.</span>internal_name <span class="token operator">=</span> <span class="token boolean">None</span>\n\n    <span class="token keyword">def</span> <span class="token function">__set_name__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> owner<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token comment"># Called on class creation for each descriptor</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name\n        self<span class="token punctuation">.</span>internal_name <span class="token operator">=</span> <span class="token string">\'_\'</span> <span class="token operator">+</span> name\n\n    <span class="token keyword">def</span> <span class="token function">__get__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> instance_type<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> instance <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self\n        <span class="token keyword">return</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> self<span class="token punctuation">.</span>internal_name<span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__set__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">setattr</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> self<span class="token punctuation">.</span>internal_name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">FixedCustomer</span><span class="token punctuation">:</span>\n    first_name <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    last_name <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    prefix <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    suffix <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n\ncust <span class="token operator">=</span> FixedCustomer<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Before: </span><span class="token interpolation"><span class="token punctuation">{</span>cust<span class="token punctuation">.</span>first_name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>cust<span class="token punctuation">.</span>__dict__<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\ncust<span class="token punctuation">.</span>first_name <span class="token operator">=</span> <span class="token string">\'Mersenne\'</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'After : </span><span class="token interpolation"><span class="token punctuation">{</span>cust<span class="token punctuation">.</span>first_name<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>cust<span class="token punctuation">.</span>__dict__<span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nBefore<span class="token punctuation">:</span> <span class="token string">\'\'</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\nAfter <span class="token punctuation">:</span> <span class="token string">\'Mersenne\'</span> <span class="token punctuation">{</span><span class="token string">\'_first_name\'</span><span class="token punctuation">:</span> <span class="token string">\'Mersenne\'</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="总结-46"><a href="#%E6%80%BB%E7%BB%93-46" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>我们可以通过元类把利用这个元类所定义的其他类拦截下来，从而在程序开始使用那些类之前，先对其中定义的属性做出修改。</li>\n<li>描述符与元类搭配起来，可以形成一套强大的机制，让我们既能采用声明式的写法来定义行为，又能在程序运行时检视这个行为的具体执行情况。</li>\n<li>你可以给描述符定义 <code class="language-text">__set_name__</code> 方法，让系统把使用这个描述符做属性的那个类以及它在类里的属性名通过方法的参数告诉你。</li>\n<li>用描述符直接操纵每个实例的属性字典，要比把所有实例的属性都放到一份字典里更好，因为后者要求我们必须使用 weakref 内置模块之中的特殊字典来记录每个实例的属性值以防止内存泄漏。</li>\n</ol>\n<h2 id="第-51-条：优先考虑通过类修饰器来提供可组合的扩充功能，不要使用元类"><a href="#%E7%AC%AC-51-%E6%9D%A1%EF%BC%9A%E4%BC%98%E5%85%88%E8%80%83%E8%99%91%E9%80%9A%E8%BF%87%E7%B1%BB%E4%BF%AE%E9%A5%B0%E5%99%A8%E6%9D%A5%E6%8F%90%E4%BE%9B%E5%8F%AF%E7%BB%84%E5%90%88%E7%9A%84%E6%89%A9%E5%85%85%E5%8A%9F%E8%83%BD%EF%BC%8C%E4%B8%8D%E8%A6%81%E4%BD%BF%E7%94%A8%E5%85%83%E7%B1%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 51 条：优先考虑通过类修饰器来提供可组合的扩充功能，不要使用元类</h2>\n<p>尽管元类（参见第 48 条与第 49 条）允许我们用各种方式来定制其他类的创建逻辑，但有些情况它未必能够处理得很好。</p>\n<p>例如，要写一个辅助函数来修饰类中的每个方法，把这些方法在执行时所用的参数、所返回的值以及所抛出的异常都打印出来，以便调试。这样的辅助函数可以定义成修饰器（参见第 26 条）。</p>\n<p>如果我们从标准的 dict 里面派生了下面这个子类（参见第 43 条），那就可以把刚才的 <code class="language-text">trace_func</code> 修饰器运用到这个子类所提供的那几个特殊方法上面。</p>\n<p>下面，通过 TraceDict 类的实例来验证刚才写的那几个特殊方法确实受到了修饰。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79667222892189780000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from functools import wraps\n\n\ndef trace_func(func):\n    if hasattr(func, \'tracing\'):  # Only decorate once\n        return func\n\n    @wraps(func)\n    def wrapper(*args, **kwargs):\n        result = None\n        try:\n            result = func(*args, **kwargs)\n            return result\n        except Exception as e:\n            result = e\n            raise\n        finally:\n            print(f\'{func.__name__}({args!r}, {kwargs!r}) -> \'\n                  f\'{result!r}\')\n\n    wrapper.tracing = True\n    return wrapper\n\n\nclass TraceDict(dict):\n    @trace_func\n    def __init__(self, *args, **kwargs):\n        super().__init__(*args, **kwargs)\n\n    @trace_func\n    def __setitem__(self, *args, **kwargs):\n        return super().__setitem__(*args, **kwargs)\n\n    @trace_func\n    def __getitem__(self, *args, **kwargs):\n        return super().__getitem__(*args, **kwargs)\n\n\ntrace_dict = TraceDict([(\'hi\', 1)])\ntrace_dict[\'there\'] = 2\ntrace_dict[\'hi\']\ntry:\n    trace_dict[\'does not exist\']\nexcept KeyError:\n    pass  # Expected\n\n>>>\n__init__(({\'hi\': 1}, [(\'hi\', 1)]), {}) -> None\n__setitem__(({\'hi\': 1, \'there\': 2}, \'there\', 2), {}) -> None\n__getitem__(({\'hi\': 1, \'there\': 2}, \'hi\'), {}) -> 1\n__getitem__(({\'hi\': 1, \'there\': 2}, \'does not exist\'), {}) -> KeyError(\'does not exist\')`, `79667222892189780000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> functools <span class="token keyword">import</span> wraps\n\n\n<span class="token keyword">def</span> <span class="token function">trace_func</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> <span class="token string">\'tracing\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># Only decorate once</span>\n        <span class="token keyword">return</span> func\n\n    @wraps<span class="token punctuation">(</span>func<span class="token punctuation">)</span>\n    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        result <span class="token operator">=</span> <span class="token boolean">None</span>\n        <span class="token keyword">try</span><span class="token punctuation">:</span>\n            result <span class="token operator">=</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>\n            <span class="token keyword">return</span> result\n        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n            result <span class="token operator">=</span> e\n            <span class="token keyword">raise</span>\n        <span class="token keyword">finally</span><span class="token punctuation">:</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>func<span class="token punctuation">.</span>__name__<span class="token punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token punctuation">{</span>args<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{</span>kwargs<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">) -> \'</span></span>\n                  <span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n    wrapper<span class="token punctuation">.</span>tracing <span class="token operator">=</span> <span class="token boolean">True</span>\n    <span class="token keyword">return</span> wrapper\n\n\n<span class="token keyword">class</span> <span class="token class-name">TraceDict</span><span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    @trace_func\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>\n\n    @trace_func\n    <span class="token keyword">def</span> <span class="token function">__setitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__setitem__<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>\n\n    @trace_func\n    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__getitem__<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>\n\n\ntrace_dict <span class="token operator">=</span> TraceDict<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'hi\'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\ntrace_dict<span class="token punctuation">[</span><span class="token string">\'there\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span>\ntrace_dict<span class="token punctuation">[</span><span class="token string">\'hi\'</span><span class="token punctuation">]</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    trace_dict<span class="token punctuation">[</span><span class="token string">\'does not exist\'</span><span class="token punctuation">]</span>\n<span class="token keyword">except</span> KeyError<span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>  <span class="token comment"># Expected</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n__init__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'hi\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'hi\'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span>\n__setitem__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'hi\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'there\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'there\'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span>\n__getitem__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'hi\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'there\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'hi\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token number">1</span>\n__getitem__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'hi\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'there\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'does not exist\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> KeyError<span class="token punctuation">(</span><span class="token string">\'does not exist\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写有个缺点，就是必须在子类之中把需要受 <code class="language-text">@trace_func</code> 修饰的方法全都重写一遍，即便子类只想沿用超类的实现方式，也还是得这样做才行。这导致子类里面出现大量的样板代码，让程序变得难以阅读，而且比较容易出错。另外，如果 dict 超类以后添加了新方法，那必须在 TraceDict 子类里面明确重写这个方法，否则它就不会为 <code class="language-text">@trace_func</code> 所修饰。</p>\n<p>要想解决这个问题，其中一个办法是通过元类自动修饰那个类的所有方法。例如，下面的就是这样一个元类，它可以拦截利用本类所写的新类型，并把那个类型里面的每个函数或方法都分别封装到 <code class="language-text">trace_func</code> 修饰器之中。</p>\n<p>现在，我们只需要让子类继承 dict，并把刚写的 TraceMeta 当作子类的 metaclass 就行了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70367804786622430000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import types\nfrom functools import wraps\n\n\ndef trace_func(func):\n    if hasattr(func, \'tracing\'):  # Only decorate once\n        return func\n\n    @wraps(func)\n    def wrapper(*args, **kwargs):\n        result = None\n        try:\n            result = func(*args, **kwargs)\n            return result\n        except Exception as e:\n            result = e\n            raise\n        finally:\n            print(f\'{func.__name__}({args!r}, {kwargs!r}) -> \'\n                  f\'{result!r}\')\n\n    wrapper.tracing = True\n    return wrapper\n\n\ntrace_types = (\n    types.MethodType,\n    types.FunctionType,\n    types.BuiltinFunctionType,\n    types.BuiltinMethodType,\n    types.MethodDescriptorType,\n    types.ClassMethodDescriptorType\n)\n\n\nclass TraceMeta(type):\n    def __new__(meta, name, bases, class_dict):\n        klass = super().__new__(meta, name, bases, class_dict)\n        for key in dir(klass):\n            value = getattr(klass, key)\n            if isinstance(value, trace_types):\n                wrapped = trace_func(value)\n                setattr(klass, key, wrapped)\n\n        return klass\n\n\nclass TraceDict(dict, metaclass=TraceMeta):\n    pass\n\n\ntrace_dict = TraceDict([(\'hi\', 1)])\ntrace_dict[\'there\'] = 2\ntrace_dict[\'hi\']\ntry:\n    trace_dict[\'does not exist\']\nexcept KeyError:\n    pass  # Expected\n\n>>>\n__new__((<class \'__main__.TraceDict\'>, [(\'hi\', 1)]), {}) -> {}\n__getitem__(({\'hi\': 1, \'there\': 2}, \'hi\'), {}) -> 1\n__getitem__(({\'hi\': 1, \'there\': 2}, \'does not exist\'), {}) -> KeyError(\'does not exist\')`, `70367804786622430000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> types\n<span class="token keyword">from</span> functools <span class="token keyword">import</span> wraps\n\n\n<span class="token keyword">def</span> <span class="token function">trace_func</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> <span class="token string">\'tracing\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># Only decorate once</span>\n        <span class="token keyword">return</span> func\n\n    @wraps<span class="token punctuation">(</span>func<span class="token punctuation">)</span>\n    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        result <span class="token operator">=</span> <span class="token boolean">None</span>\n        <span class="token keyword">try</span><span class="token punctuation">:</span>\n            result <span class="token operator">=</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>\n            <span class="token keyword">return</span> result\n        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n            result <span class="token operator">=</span> e\n            <span class="token keyword">raise</span>\n        <span class="token keyword">finally</span><span class="token punctuation">:</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>func<span class="token punctuation">.</span>__name__<span class="token punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token punctuation">{</span>args<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{</span>kwargs<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">) -> \'</span></span>\n                  <span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n    wrapper<span class="token punctuation">.</span>tracing <span class="token operator">=</span> <span class="token boolean">True</span>\n    <span class="token keyword">return</span> wrapper\n\n\ntrace_types <span class="token operator">=</span> <span class="token punctuation">(</span>\n    types<span class="token punctuation">.</span>MethodType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>FunctionType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>BuiltinFunctionType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>BuiltinMethodType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>MethodDescriptorType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>ClassMethodDescriptorType\n<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">TraceMeta</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        klass <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span>\n        <span class="token keyword">for</span> key <span class="token keyword">in</span> <span class="token builtin">dir</span><span class="token punctuation">(</span>klass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            value <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>klass<span class="token punctuation">,</span> key<span class="token punctuation">)</span>\n            <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> trace_types<span class="token punctuation">)</span><span class="token punctuation">:</span>\n                wrapped <span class="token operator">=</span> trace_func<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n                <span class="token builtin">setattr</span><span class="token punctuation">(</span>klass<span class="token punctuation">,</span> key<span class="token punctuation">,</span> wrapped<span class="token punctuation">)</span>\n\n        <span class="token keyword">return</span> klass\n\n\n<span class="token keyword">class</span> <span class="token class-name">TraceDict</span><span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">,</span> metaclass<span class="token operator">=</span>TraceMeta<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\ntrace_dict <span class="token operator">=</span> TraceDict<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'hi\'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\ntrace_dict<span class="token punctuation">[</span><span class="token string">\'there\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span>\ntrace_dict<span class="token punctuation">[</span><span class="token string">\'hi\'</span><span class="token punctuation">]</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    trace_dict<span class="token punctuation">[</span><span class="token string">\'does not exist\'</span><span class="token punctuation">]</span>\n<span class="token keyword">except</span> KeyError<span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>  <span class="token comment"># Expected</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n__new__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.TraceDict\'</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'hi\'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n__getitem__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'hi\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'there\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'hi\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token number">1</span>\n__getitem__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'hi\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'there\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'does not exist\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> KeyError<span class="token punctuation">(</span><span class="token string">\'does not exist\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种办法确实有效，而且还把前面的实现方案中忘记修饰的 <code class="language-text">__new__</code> 方法也自动修饰了。但如果子类所继承的那个超类本身已经指定了它自己的 metaclass，那会如何呢？</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9356143572126240000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class OtherMeta(type):\n    pass\n\n\nclass SimpleDict(dict, metaclass=OtherMeta):\n    pass\n\n\nclass TraceDict(SimpleDict, metaclass=TraceMeta):\n    pass\n\n>>>\nTraceback ...\nTypeError: metaclass conflict: the metaclass of a derived class must be a (non-strict) subclass of the metaclasses of all its bases`, `9356143572126240000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">OtherMeta</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">SimpleDict</span><span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">,</span> metaclass<span class="token operator">=</span>OtherMeta<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">TraceDict</span><span class="token punctuation">(</span>SimpleDict<span class="token punctuation">,</span> metaclass<span class="token operator">=</span>TraceMeta<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTraceback <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTypeError<span class="token punctuation">:</span> metaclass conflict<span class="token punctuation">:</span> the metaclass of a derived <span class="token keyword">class</span> <span class="token class-name">must</span> be a <span class="token punctuation">(</span>non<span class="token operator">-</span>strict<span class="token punctuation">)</span> subclass of the metaclasses of <span class="token builtin">all</span> its bases</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这次程序无法运行，因为子类的 metaclass 是 TraceMeta，而超类的 metaclass 是 OtherMeta，但 TraceMeta 并不是从 OtherMeta 里面继承来的。从理论上讲，我们可以让 TraceMeta 继承 OtherMeta，从而解决这个问题。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61666777392969105000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import types\nfrom functools import wraps\n\n\ndef trace_func(func):\n    if hasattr(func, \'tracing\'):  # Only decorate once\n        return func\n\n    @wraps(func)\n    def wrapper(*args, **kwargs):\n        result = None\n        try:\n            result = func(*args, **kwargs)\n            return result\n        except Exception as e:\n            result = e\n            raise\n        finally:\n            print(f\'{func.__name__}({args!r}, {kwargs!r}) -> \'\n                  f\'{result!r}\')\n\n    wrapper.tracing = True\n    return wrapper\n\n\ntrace_types = (\n    types.MethodType,\n    types.FunctionType,\n    types.BuiltinFunctionType,\n    types.BuiltinMethodType,\n    types.MethodDescriptorType,\n    types.ClassMethodDescriptorType\n)\n\n\nclass OtherMeta(type):\n    pass\n\n\nclass TraceMeta(OtherMeta):\n    def __new__(meta, name, bases, class_dict):\n        klass = super().__new__(meta, name, bases, class_dict)\n        for key in dir(klass):\n            value = getattr(klass, key)\n            if isinstance(value, trace_types):\n                wrapped = trace_func(value)\n                setattr(klass, key, wrapped)\n\n        return klass\n\n\nclass SimpleDict(dict, metaclass=OtherMeta):\n    pass\n\n\nclass TraceDict(SimpleDict, metaclass=TraceMeta):\n    pass\n\n\ntrace_dict = TraceDict([(\'hi\', 1)])\ntrace_dict[\'there\'] = 2\ntrace_dict[\'hi\']\ntry:\n    trace_dict[\'does not exist\']\nexcept KeyError:\n    pass  # Expected\n\n>>>\n__new__((<class \'__main__.TraceDict\'>, [(\'hi\', 1)]), {}) -> {}\n__getitem__(({\'hi\': 1, \'there\': 2}, \'hi\'), {}) -> 1\n__getitem__(({\'hi\': 1, \'there\': 2}, \'does not exist\'), {}) -> KeyError(\'does not exist\')`, `61666777392969105000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> types\n<span class="token keyword">from</span> functools <span class="token keyword">import</span> wraps\n\n\n<span class="token keyword">def</span> <span class="token function">trace_func</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> <span class="token string">\'tracing\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># Only decorate once</span>\n        <span class="token keyword">return</span> func\n\n    @wraps<span class="token punctuation">(</span>func<span class="token punctuation">)</span>\n    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        result <span class="token operator">=</span> <span class="token boolean">None</span>\n        <span class="token keyword">try</span><span class="token punctuation">:</span>\n            result <span class="token operator">=</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>\n            <span class="token keyword">return</span> result\n        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n            result <span class="token operator">=</span> e\n            <span class="token keyword">raise</span>\n        <span class="token keyword">finally</span><span class="token punctuation">:</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>func<span class="token punctuation">.</span>__name__<span class="token punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token punctuation">{</span>args<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{</span>kwargs<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">) -> \'</span></span>\n                  <span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n    wrapper<span class="token punctuation">.</span>tracing <span class="token operator">=</span> <span class="token boolean">True</span>\n    <span class="token keyword">return</span> wrapper\n\n\ntrace_types <span class="token operator">=</span> <span class="token punctuation">(</span>\n    types<span class="token punctuation">.</span>MethodType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>FunctionType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>BuiltinFunctionType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>BuiltinMethodType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>MethodDescriptorType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>ClassMethodDescriptorType\n<span class="token punctuation">)</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">OtherMeta</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">TraceMeta</span><span class="token punctuation">(</span>OtherMeta<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        klass <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>meta<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> class_dict<span class="token punctuation">)</span>\n        <span class="token keyword">for</span> key <span class="token keyword">in</span> <span class="token builtin">dir</span><span class="token punctuation">(</span>klass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            value <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>klass<span class="token punctuation">,</span> key<span class="token punctuation">)</span>\n            <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> trace_types<span class="token punctuation">)</span><span class="token punctuation">:</span>\n                wrapped <span class="token operator">=</span> trace_func<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n                <span class="token builtin">setattr</span><span class="token punctuation">(</span>klass<span class="token punctuation">,</span> key<span class="token punctuation">,</span> wrapped<span class="token punctuation">)</span>\n\n        <span class="token keyword">return</span> klass\n\n\n<span class="token keyword">class</span> <span class="token class-name">SimpleDict</span><span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">,</span> metaclass<span class="token operator">=</span>OtherMeta<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">class</span> <span class="token class-name">TraceDict</span><span class="token punctuation">(</span>SimpleDict<span class="token punctuation">,</span> metaclass<span class="token operator">=</span>TraceMeta<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\ntrace_dict <span class="token operator">=</span> TraceDict<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'hi\'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\ntrace_dict<span class="token punctuation">[</span><span class="token string">\'there\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span>\ntrace_dict<span class="token punctuation">[</span><span class="token string">\'hi\'</span><span class="token punctuation">]</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    trace_dict<span class="token punctuation">[</span><span class="token string">\'does not exist\'</span><span class="token punctuation">]</span>\n<span class="token keyword">except</span> KeyError<span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>  <span class="token comment"># Expected</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n__new__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.TraceDict\'</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'hi\'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n__getitem__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'hi\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'there\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'hi\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token number">1</span>\n__getitem__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'hi\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'there\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'does not exist\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> KeyError<span class="token punctuation">(</span><span class="token string">\'does not exist\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然而，如果 TraceMeta 不是我们自己写的，而是来自某个程序库，那就没办法手工修改它了。另外，如果想同时使用多个像 TraceMeta 这样的元类所提供的逻辑，那么这套方案无法满足需求，因为在定义类的时候，metaclass 后面只能写一个元类。总之，这个方案对受元类控制的子类提出了过多的要求。</p>\n<p>为此，我们可以换一种方案，也就是改用类修饰器（class decorator）来实现。这种修饰器与函数修饰器相似，都通过 @ 符号来施加，但它并不施加在函数上面，而是施加在类的上面。编写类修饰器时，我们可以修改或重建它所修饰的类，并通过 return 语句返回处理结果。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74354031841079750000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def my_class_decorator(klass):\n    klass.extra_param = \'hello\'\n    return klass\n\n\n@my_class_decorator\nclass MyClass:\n    pass\n\n\nprint(MyClass)\nprint(MyClass.extra_param)\n\n>>>\n<class \'__main__.MyClass\'>\nhello`, `74354031841079750000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">my_class_decorator</span><span class="token punctuation">(</span>klass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    klass<span class="token punctuation">.</span>extra_param <span class="token operator">=</span> <span class="token string">\'hello\'</span>\n    <span class="token keyword">return</span> klass\n\n\n@my_class_decorator\n<span class="token keyword">class</span> <span class="token class-name">MyClass</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n<span class="token keyword">print</span><span class="token punctuation">(</span>MyClass<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>MyClass<span class="token punctuation">.</span>extra_param<span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.MyClass\'</span><span class="token operator">></span>\nhello</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在就来实现这样一个类修饰器，它可以施加在类上面，让该类的所有方法与函数都能自动封装在 trace_func 之中。这个类修饰器本身是个独立的函数，它的代码基本上可以沿用早前所写的 <code class="language-text">TraceMeta.__new__</code>。这套方案要比采用元类实现的方案简单得多。</p>\n<p>我们把类修饰器运用到自定义的 dict 子类上面，这样它就有了与刚才那套元类方案相同的功能。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91971470994183880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import types\nfrom functools import wraps\n\n\ndef trace_func(func):\n    if hasattr(func, \'tracing\'):  # Only decorate once\n        return func\n\n    @wraps(func)\n    def wrapper(*args, **kwargs):\n        result = None\n        try:\n            result = func(*args, **kwargs)\n            return result\n        except Exception as e:\n            result = e\n            raise\n        finally:\n            print(f\'{func.__name__}({args!r}, {kwargs!r}) -> \'\n                  f\'{result!r}\')\n\n    wrapper.tracing = True\n    return wrapper\n\n\ntrace_types = (\n    types.MethodType,\n    types.FunctionType,\n    types.BuiltinFunctionType,\n    types.BuiltinMethodType,\n    types.MethodDescriptorType,\n    types.ClassMethodDescriptorType\n)\n\n\ndef trace(klass):\n    for key in dir(klass):\n        value = getattr(klass, key)\n        if isinstance(value, trace_types):\n            wrapped = trace_func(value)\n            setattr(klass, key, wrapped)\n    return klass\n\n\n@trace\nclass TraceDict(dict):\n    pass\n\n\ntrace_dict = TraceDict([(\'hi\', 1)])\ntrace_dict[\'there\'] = 2\ntrace_dict[\'hi\']\ntry:\n    trace_dict[\'does not exist\']\nexcept KeyError:\n    pass  # Expected\n\n>>>\n__new__((<class \'__main__.TraceDict\'>, [(\'hi\', 1)]), {}) -> {}\n__getitem__(({\'hi\': 1, \'there\': 2}, \'hi\'), {}) -> 1\n__getitem__(({\'hi\': 1, \'there\': 2}, \'does not exist\'), {}) -> KeyError(\'does not exist\')`, `91971470994183880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> types\n<span class="token keyword">from</span> functools <span class="token keyword">import</span> wraps\n\n\n<span class="token keyword">def</span> <span class="token function">trace_func</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> <span class="token string">\'tracing\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># Only decorate once</span>\n        <span class="token keyword">return</span> func\n\n    @wraps<span class="token punctuation">(</span>func<span class="token punctuation">)</span>\n    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        result <span class="token operator">=</span> <span class="token boolean">None</span>\n        <span class="token keyword">try</span><span class="token punctuation">:</span>\n            result <span class="token operator">=</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>\n            <span class="token keyword">return</span> result\n        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n            result <span class="token operator">=</span> e\n            <span class="token keyword">raise</span>\n        <span class="token keyword">finally</span><span class="token punctuation">:</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>func<span class="token punctuation">.</span>__name__<span class="token punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token punctuation">{</span>args<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{</span>kwargs<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">) -> \'</span></span>\n                  <span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n    wrapper<span class="token punctuation">.</span>tracing <span class="token operator">=</span> <span class="token boolean">True</span>\n    <span class="token keyword">return</span> wrapper\n\n\ntrace_types <span class="token operator">=</span> <span class="token punctuation">(</span>\n    types<span class="token punctuation">.</span>MethodType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>FunctionType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>BuiltinFunctionType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>BuiltinMethodType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>MethodDescriptorType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>ClassMethodDescriptorType\n<span class="token punctuation">)</span>\n\n\n<span class="token keyword">def</span> <span class="token function">trace</span><span class="token punctuation">(</span>klass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> key <span class="token keyword">in</span> <span class="token builtin">dir</span><span class="token punctuation">(</span>klass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        value <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>klass<span class="token punctuation">,</span> key<span class="token punctuation">)</span>\n        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> trace_types<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            wrapped <span class="token operator">=</span> trace_func<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n            <span class="token builtin">setattr</span><span class="token punctuation">(</span>klass<span class="token punctuation">,</span> key<span class="token punctuation">,</span> wrapped<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> klass\n\n\n@trace\n<span class="token keyword">class</span> <span class="token class-name">TraceDict</span><span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\ntrace_dict <span class="token operator">=</span> TraceDict<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'hi\'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\ntrace_dict<span class="token punctuation">[</span><span class="token string">\'there\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span>\ntrace_dict<span class="token punctuation">[</span><span class="token string">\'hi\'</span><span class="token punctuation">]</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    trace_dict<span class="token punctuation">[</span><span class="token string">\'does not exist\'</span><span class="token punctuation">]</span>\n<span class="token keyword">except</span> KeyError<span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>  <span class="token comment"># Expected</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n__new__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.TraceDict\'</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'hi\'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n__getitem__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'hi\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'there\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'hi\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token number">1</span>\n__getitem__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'hi\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'there\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'does not exist\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> KeyError<span class="token punctuation">(</span><span class="token string">\'does not exist\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>另外，类修饰器也能施加到那种已经有 metaclass 的类上面。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43338319601914830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import types\nfrom functools import wraps\n\n\ndef trace_func(func):\n    if hasattr(func, \'tracing\'):  # Only decorate once\n        return func\n\n    @wraps(func)\n    def wrapper(*args, **kwargs):\n        result = None\n        try:\n            result = func(*args, **kwargs)\n            return result\n        except Exception as e:\n            result = e\n            raise\n        finally:\n            print(f\'{func.__name__}({args!r}, {kwargs!r}) -> \'\n                  f\'{result!r}\')\n\n    wrapper.tracing = True\n    return wrapper\n\n\ntrace_types = (\n    types.MethodType,\n    types.FunctionType,\n    types.BuiltinFunctionType,\n    types.BuiltinMethodType,\n    types.MethodDescriptorType,\n    types.ClassMethodDescriptorType\n)\n\n\ndef trace(klass):\n    for key in dir(klass):\n        value = getattr(klass, key)\n        if isinstance(value, trace_types):\n            wrapped = trace_func(value)\n            setattr(klass, key, wrapped)\n    return klass\n\n\nclass OtherMeta(type):\n    pass\n\n\n@trace\nclass TraceDict(dict, metaclass=OtherMeta):\n    pass\n\n\ntrace_dict = TraceDict([(\'hi\', 1)])\ntrace_dict[\'there\'] = 2\ntrace_dict[\'hi\']\ntry:\n    trace_dict[\'does not exist\']\nexcept KeyError:\n    pass  # Expected\n\n>>>\n__new__((<class \'__main__.TraceDict\'>, [(\'hi\', 1)]), {}) -> {}\n__getitem__(({\'hi\': 1, \'there\': 2}, \'hi\'), {}) -> 1\n__getitem__(({\'hi\': 1, \'there\': 2}, \'does not exist\'), {}) -> KeyError(\'does not exist\')`, `43338319601914830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> types\n<span class="token keyword">from</span> functools <span class="token keyword">import</span> wraps\n\n\n<span class="token keyword">def</span> <span class="token function">trace_func</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> <span class="token string">\'tracing\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># Only decorate once</span>\n        <span class="token keyword">return</span> func\n\n    @wraps<span class="token punctuation">(</span>func<span class="token punctuation">)</span>\n    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        result <span class="token operator">=</span> <span class="token boolean">None</span>\n        <span class="token keyword">try</span><span class="token punctuation">:</span>\n            result <span class="token operator">=</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>\n            <span class="token keyword">return</span> result\n        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n            result <span class="token operator">=</span> e\n            <span class="token keyword">raise</span>\n        <span class="token keyword">finally</span><span class="token punctuation">:</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>func<span class="token punctuation">.</span>__name__<span class="token punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token punctuation">{</span>args<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{</span>kwargs<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">) -> \'</span></span>\n                  <span class="token string-interpolation"><span class="token string">f\'</span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\n\n    wrapper<span class="token punctuation">.</span>tracing <span class="token operator">=</span> <span class="token boolean">True</span>\n    <span class="token keyword">return</span> wrapper\n\n\ntrace_types <span class="token operator">=</span> <span class="token punctuation">(</span>\n    types<span class="token punctuation">.</span>MethodType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>FunctionType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>BuiltinFunctionType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>BuiltinMethodType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>MethodDescriptorType<span class="token punctuation">,</span>\n    types<span class="token punctuation">.</span>ClassMethodDescriptorType\n<span class="token punctuation">)</span>\n\n\n<span class="token keyword">def</span> <span class="token function">trace</span><span class="token punctuation">(</span>klass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> key <span class="token keyword">in</span> <span class="token builtin">dir</span><span class="token punctuation">(</span>klass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        value <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>klass<span class="token punctuation">,</span> key<span class="token punctuation">)</span>\n        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> trace_types<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            wrapped <span class="token operator">=</span> trace_func<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n            <span class="token builtin">setattr</span><span class="token punctuation">(</span>klass<span class="token punctuation">,</span> key<span class="token punctuation">,</span> wrapped<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> klass\n\n\n<span class="token keyword">class</span> <span class="token class-name">OtherMeta</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\n@trace\n<span class="token keyword">class</span> <span class="token class-name">TraceDict</span><span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">,</span> metaclass<span class="token operator">=</span>OtherMeta<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\ntrace_dict <span class="token operator">=</span> TraceDict<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'hi\'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\ntrace_dict<span class="token punctuation">[</span><span class="token string">\'there\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span>\ntrace_dict<span class="token punctuation">[</span><span class="token string">\'hi\'</span><span class="token punctuation">]</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    trace_dict<span class="token punctuation">[</span><span class="token string">\'does not exist\'</span><span class="token punctuation">]</span>\n<span class="token keyword">except</span> KeyError<span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>  <span class="token comment"># Expected</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n__new__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.TraceDict\'</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'hi\'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n__getitem__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'hi\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'there\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'hi\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token number">1</span>\n__getitem__<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'hi\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'there\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">\'does not exist\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> KeyError<span class="token punctuation">(</span><span class="token string">\'does not exist\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>总之，如果想用一套可组合的机制来扩充类的功能，那么最好是通过类修饰器实现（第 73 条会讲到一种很有用的类修饰器，名为 <code class="language-text">functools.total_ordering</code>）。</p>\n<h3 id="总结-47"><a href="#%E6%80%BB%E7%BB%93-47" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>类修饰器其实就是个函数，只不过它可以通过参数获知自己所修饰的类，从而重建或调整这个类并返回修改结果。</li>\n<li>如果要给类中的每个方法或属性都施加一套逻辑，而且还想尽量少写一些例行代码，那么类修饰器是个很值得考虑的方案。</li>\n<li>元类之间很难组合，而类修饰器则比较灵活，它们可以施加在同一个类上，并且不会发生冲突。</li>\n</ol>\n<h1 id="并发与并行"><a href="#%E5%B9%B6%E5%8F%91%E4%B8%8E%E5%B9%B6%E8%A1%8C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>并发与并行</h1>\n<h2 id="第-52-条：用-subprocess-管理子进程"><a href="#%E7%AC%AC-52-%E6%9D%A1%EF%BC%9A%E7%94%A8-subprocess-%E7%AE%A1%E7%90%86%E5%AD%90%E8%BF%9B%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 52 条：用 subprocess 管理子进程</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36020481718203310000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import subprocess\n\nresult = subprocess.run(\n    [\'echo\', \'Hello from the child!\'],\n    capture_output=True,\n    encoding=\'utf-8\')\n\nresult.check_returncode()\nprint(result.stdout)\n# No exception means clean exit\n\n>>>\nHello from the child!`, `36020481718203310000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> subprocess\n\nresult <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>\n    <span class="token punctuation">[</span><span class="token string">\'echo\'</span><span class="token punctuation">,</span> <span class="token string">\'Hello from the child!\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n    capture_output<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>\n    encoding<span class="token operator">=</span><span class="token string">\'utf-8\'</span><span class="token punctuation">)</span>\n\nresult<span class="token punctuation">.</span>check_returncode<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span>\n<span class="token comment"># No exception means clean exit</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nHello <span class="token keyword">from</span> the child!</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>子进程可以独立于父进程而运行，这里的父进程指 Python 解释器所在的那条进程。假如刚才那条子进程不是通过 run 函数启动，而是由 Popen 类启动的，那么我们就可以在它启动之后，让 Python 程序去做别的任务，每做一段时间就来查询一次子进程的状态以决定要不要继续执行任务</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18656424020265240000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import subprocess\n\nproc = subprocess.Popen([\'sleep\', \'1\'])\nwhile proc.poll() is None:\n    print(\'Working...\')\n# Some time-consuming work here\nprint(\'Exit status\', proc.poll())\n\n>>>\nWorking...\nWorking...\nWorking...\nExit status 0`, `18656424020265240000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> subprocess\n\nproc <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'sleep\'</span><span class="token punctuation">,</span> <span class="token string">\'1\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token keyword">while</span> proc<span class="token punctuation">.</span>poll<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Working...\'</span><span class="token punctuation">)</span>\n<span class="token comment"># Some time-consuming work here</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Exit status\'</span><span class="token punctuation">,</span> proc<span class="token punctuation">.</span>poll<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nWorking<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nWorking<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nWorking<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nExit status <span class="token number">0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>把子进程从父进程中剥离，可以让程序平行地运行多条子进程。例如，我们可以像下面这样，先把需要运行的这些子进程用 Popen 启动起来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8388892047664864000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import subprocess\nimport time\n\nstart = time.time()\nsleep_procs = []\nfor _ in range(10):\n    proc = subprocess.Popen([\'sleep\', \'1\'])\n    sleep_procs.append(proc)\n\nfor proc in sleep_procs:\n    proc.communicate()\n\nend = time.time()\ndelta = end - start\nprint(f\'Finished in {delta:.3} seconds\')\n\n>>>\nFinished in 1.01 seconds`, `8388892047664864000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> subprocess\n<span class="token keyword">import</span> time\n\nstart <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>\nsleep_procs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n<span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    proc <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'sleep\'</span><span class="token punctuation">,</span> <span class="token string">\'1\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n    sleep_procs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>proc<span class="token punctuation">)</span>\n\n<span class="token keyword">for</span> proc <span class="token keyword">in</span> sleep_procs<span class="token punctuation">:</span>\n    proc<span class="token punctuation">.</span>communicate<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\nend <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>\ndelta <span class="token operator">=</span> end <span class="token operator">-</span> start\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Finished in </span><span class="token interpolation"><span class="token punctuation">{</span>delta<span class="token punctuation">:</span><span class="token format-spec">.3</span><span class="token punctuation">}</span></span><span class="token string"> seconds\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nFinished <span class="token keyword">in</span> <span class="token number">1.01</span> seconds</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>从统计结果可以看出，这 10 条子进程确实表现出了平行的效果。假如它们是按顺序执行的，那么程序耗费的总时长至少应该是 10 秒，而不是现在看到的 1 秒左右。</p>\n<p>我们还可以在 Python 程序里面把数据通过管道发送给子进程所运行的外部命令，然后将那条命令的输出结果获取到 Python 程序之中。而且，在执行外部命令的这个环节中，可以平行地运行多条命令。例如，要用 oepnssl 这样的命令行工具来加密数据。首先以适当的命令行参数构建一批子进程，并配置好相应的 I/O 管道，这在 Python 里很容易就能做到。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53415294186930274000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import subprocess\nimport os\n\n\ndef run_encrypt(data):\n    env = os.environ.copy()\n    env[\'password\'] = \'2f7ShyBhZOraQDdE/FiZpm/m/8f9X+MI\'\n    proc = subprocess.Popen(\n        [\'openssl\', \'enc\', \'-des3\', \'-pass\', \'env:password\'],\n        env=env,\n        stdin=subprocess.PIPE,\n        stdout=subprocess.PIPE\n    ) # 平行运行\n    proc.stdin.write(data)\n    proc.stdin.flush()  # Ensure that the child gets input\n    return proc\n\n\nprocs = []\nfor _ in range(3):\n    data = os.urandom(10)\n    proc = run_encrypt(data)\n    procs.append(proc)\n\nfor proc in procs:\n    out, _ = proc.communicate()\n    print(out[-10:])\n\n>>>\nb\'\\xc4G\\x01\\xf1\\x90Q\\xae\\xff\\x86\\xe1\'\nb\'>T~~R\\xbd\\xc3n\\x87\\xcc\'\nb\'\\xe9\\x02\\x18sE\\xa1W\\xcet\\xae\'`, `53415294186930274000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> subprocess\n<span class="token keyword">import</span> os\n\n\n<span class="token keyword">def</span> <span class="token function">run_encrypt</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    env <span class="token operator">=</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    env<span class="token punctuation">[</span><span class="token string">\'password\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">\'2f7ShyBhZOraQDdE/FiZpm/m/8f9X+MI\'</span>\n    proc <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span>\n        <span class="token punctuation">[</span><span class="token string">\'openssl\'</span><span class="token punctuation">,</span> <span class="token string">\'enc\'</span><span class="token punctuation">,</span> <span class="token string">\'-des3\'</span><span class="token punctuation">,</span> <span class="token string">\'-pass\'</span><span class="token punctuation">,</span> <span class="token string">\'env:password\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n        env<span class="token operator">=</span>env<span class="token punctuation">,</span>\n        stdin<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span>\n        stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE\n    <span class="token punctuation">)</span> <span class="token comment"># 平行运行</span>\n    proc<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span>write<span class="token punctuation">(</span>data<span class="token punctuation">)</span>\n    proc<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># Ensure that the child gets input</span>\n    <span class="token keyword">return</span> proc\n\n\nprocs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n<span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    data <span class="token operator">=</span> os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>\n    proc <span class="token operator">=</span> run_encrypt<span class="token punctuation">(</span>data<span class="token punctuation">)</span>\n    procs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>proc<span class="token punctuation">)</span>\n\n<span class="token keyword">for</span> proc <span class="token keyword">in</span> procs<span class="token punctuation">:</span>\n    out<span class="token punctuation">,</span> _ <span class="token operator">=</span> proc<span class="token punctuation">.</span>communicate<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span>out<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token string">b\'\\xc4G\\x01\\xf1\\x90Q\\xae\\xff\\x86\\xe1\'</span>\n<span class="token string">b\'>T~~R\\xbd\\xc3n\\x87\\xcc\'</span>\n<span class="token string">b\'\\xe9\\x02\\x18sE\\xa1W\\xcet\\xae\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这些平行运行的子进程还可以分别与另一套平行的子进程对接，形成许多条平行的管道（pipe）。这种管道与 UNIX 管道类似，能够把一条子进程的输出端同另一条子进程的输入端连接起来。下面，我们写这样一个函数，让它开启一条子进程来运行 openssl 命令，这条命令会根据输入端所发来的数据在输出端生成 Whirlpool 哈希。</p>\n<p>现在，我们可以先启动一批进程来加密数据，然后启动另一批进程根据前面那些进程的加密结果生成哈希码。请注意，前面那批进程（也就是上游进程）的 stdout 实例必须谨慎地处理，用它把相应的哈希进程（也就是下游进程）启动之后，就应该及时关闭（close）并将其设为 None。</p>\n<p>只要上、下游的子进程都启动起来，两者之间的 I/O 管道就会自动打通。我们所要做的仅仅是等待这两批子进程完工并把最终结果打印出来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21059513463285297000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import subprocess\nimport os\n\n\ndef run_hash(input_stdin):\n    return subprocess.Popen(\n        [\'openssl\', \'dgst\', \'-whirlpool\', \'-binary\'],\n        stdin=input_stdin,\n        stdout=subprocess.PIPE)\n\n\ndef run_encrypt(data):\n    env = os.environ.copy()\n    env[\'password\'] = \'2f7ShyBhZOraQDdE/FiZpm/m/8f9X+MI\'\n    proc = subprocess.Popen(\n        [\'openssl\', \'enc\', \'-des3\', \'-pass\', \'env:password\'],\n        env=env,\n        stdin=subprocess.PIPE,\n        stdout=subprocess.PIPE\n    )  # 平行运行\n    proc.stdin.write(data)\n    proc.stdin.flush()  # Ensure that the child gets input\n    return proc\n\n\nencrypt_procs = []\nhash_procs = []\nfor _ in range(3):\n    data = os.urandom(100)\n    encrypt_proc = run_encrypt(data)\n    encrypt_procs.append(encrypt_proc)\n    hash_proc = run_hash(encrypt_proc.stdout)\n    hash_procs.append(hash_proc)\n    # Ensure that the child consumes the input stream and\n    # the communicate method doesn\'t inadvertently steal\n    # input from the child. Also lets SIGPIPE propagate to\n    # the upstream process if the downstream process dies.\n    encrypt_proc.stdout.close()\n    encrypt_proc.stdout = None\n\nfor proc in encrypt_procs:\n    proc.communicate()\n    assert proc.returncode == 0\n\nfor proc in hash_procs:\n    out, _ = proc.communicate()\n    print(out[-10:])\n    assert proc.returncode == 0\n\n>>>\nb\'\\xa7{\\xc8q\\xf9n#i\\x0b7\'\nb\'\\xb3\\x9aP\\x7f\\xa6N\\xc9\\x8b-Z\'\nb\'\\xe8F\\x94\\x1fQ\\x83L\\xf7\\xb3p\'`, `21059513463285297000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> subprocess\n<span class="token keyword">import</span> os\n\n\n<span class="token keyword">def</span> <span class="token function">run_hash</span><span class="token punctuation">(</span>input_stdin<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span>\n        <span class="token punctuation">[</span><span class="token string">\'openssl\'</span><span class="token punctuation">,</span> <span class="token string">\'dgst\'</span><span class="token punctuation">,</span> <span class="token string">\'-whirlpool\'</span><span class="token punctuation">,</span> <span class="token string">\'-binary\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n        stdin<span class="token operator">=</span>input_stdin<span class="token punctuation">,</span>\n        stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">)</span>\n\n\n<span class="token keyword">def</span> <span class="token function">run_encrypt</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    env <span class="token operator">=</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    env<span class="token punctuation">[</span><span class="token string">\'password\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">\'2f7ShyBhZOraQDdE/FiZpm/m/8f9X+MI\'</span>\n    proc <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span>\n        <span class="token punctuation">[</span><span class="token string">\'openssl\'</span><span class="token punctuation">,</span> <span class="token string">\'enc\'</span><span class="token punctuation">,</span> <span class="token string">\'-des3\'</span><span class="token punctuation">,</span> <span class="token string">\'-pass\'</span><span class="token punctuation">,</span> <span class="token string">\'env:password\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n        env<span class="token operator">=</span>env<span class="token punctuation">,</span>\n        stdin<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span>\n        stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE\n    <span class="token punctuation">)</span>  <span class="token comment"># 平行运行</span>\n    proc<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span>write<span class="token punctuation">(</span>data<span class="token punctuation">)</span>\n    proc<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># Ensure that the child gets input</span>\n    <span class="token keyword">return</span> proc\n\n\nencrypt_procs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\nhash_procs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n<span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    data <span class="token operator">=</span> os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>\n    encrypt_proc <span class="token operator">=</span> run_encrypt<span class="token punctuation">(</span>data<span class="token punctuation">)</span>\n    encrypt_procs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>encrypt_proc<span class="token punctuation">)</span>\n    hash_proc <span class="token operator">=</span> run_hash<span class="token punctuation">(</span>encrypt_proc<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span>\n    hash_procs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>hash_proc<span class="token punctuation">)</span>\n    <span class="token comment"># Ensure that the child consumes the input stream and</span>\n    <span class="token comment"># the communicate method doesn\'t inadvertently steal</span>\n    <span class="token comment"># input from the child. Also lets SIGPIPE propagate to</span>\n    <span class="token comment"># the upstream process if the downstream process dies.</span>\n    encrypt_proc<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    encrypt_proc<span class="token punctuation">.</span>stdout <span class="token operator">=</span> <span class="token boolean">None</span>\n\n<span class="token keyword">for</span> proc <span class="token keyword">in</span> encrypt_procs<span class="token punctuation">:</span>\n    proc<span class="token punctuation">.</span>communicate<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">assert</span> proc<span class="token punctuation">.</span>returncode <span class="token operator">==</span> <span class="token number">0</span>\n\n<span class="token keyword">for</span> proc <span class="token keyword">in</span> hash_procs<span class="token punctuation">:</span>\n    out<span class="token punctuation">,</span> _ <span class="token operator">=</span> proc<span class="token punctuation">.</span>communicate<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span>out<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n    <span class="token keyword">assert</span> proc<span class="token punctuation">.</span>returncode <span class="token operator">==</span> <span class="token number">0</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\n<span class="token string">b\'\\xa7{\\xc8q\\xf9n#i\\x0b7\'</span>\n<span class="token string">b\'\\xb3\\x9aP\\x7f\\xa6N\\xc9\\x8b-Z\'</span>\n<span class="token string">b\'\\xe8F\\x94\\x1fQ\\x83L\\xf7\\xb3p\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果子进程有可能一直不结束，或者由于某种原因卡在输入端或输出端，那么可以在调用 communicate 方法时指定 timeout 参数。这样的话，子进程若是没能在指定时间内结束，程序就会抛出异常，让我们有机会把这条不正常的子进程停掉。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="47462066066097890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import subprocess\n\nproc = subprocess.Popen([\'sleep\', \'10\'])\ntry:\n    proc.communicate(timeout=0.1)\nexcept subprocess.TimeoutExpired:\n    proc.terminate()\n    proc.wait()\n\nprint(\'Exit status\', proc.poll())\n\n>>>\nExit status -15`, `47462066066097890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> subprocess\n\nproc <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'sleep\'</span><span class="token punctuation">,</span> <span class="token string">\'10\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    proc<span class="token punctuation">.</span>communicate<span class="token punctuation">(</span>timeout<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span>\n<span class="token keyword">except</span> subprocess<span class="token punctuation">.</span>TimeoutExpired<span class="token punctuation">:</span>\n    proc<span class="token punctuation">.</span>terminate<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    proc<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Exit status\'</span><span class="token punctuation">,</span> proc<span class="token punctuation">.</span>poll<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nExit status <span class="token operator">-</span><span class="token number">15</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="总结-48"><a href="#%E6%80%BB%E7%BB%93-48" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>subprocess 模块可以运行子进程并管理它们的输入流与输出流。</li>\n<li>子进程能够跟 Python 解释器所在的进程并行，从而充分利用各 CPU 核心。</li>\n<li>要开启子进程，最简单的办法就是调用 run 函数，另外也可以通过 Popen 类实现类似 UNIX 管道的高级用法。</li>\n<li>调用 communicate 方法时可以指定 timeout 参数，让我们有机会把陷入死锁或已经卡住的子进程关掉。</li>\n</ol>\n<h2 id="第-53-条：可以用线程执行阻塞式-io，但不要用它做并行计算"><a href="#%E7%AC%AC-53-%E6%9D%A1%EF%BC%9A%E5%8F%AF%E4%BB%A5%E7%94%A8%E7%BA%BF%E7%A8%8B%E6%89%A7%E8%A1%8C%E9%98%BB%E5%A1%9E%E5%BC%8F-io%EF%BC%8C%E4%BD%86%E4%B8%8D%E8%A6%81%E7%94%A8%E5%AE%83%E5%81%9A%E5%B9%B6%E8%A1%8C%E8%AE%A1%E7%AE%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第 53 条：可以用线程执行阻塞式 I/O，但不要用它做并行计算</h2>\n<p>Python 语言的标准实现叫作 CPython，，它分两步来运行 Python 程序。首先解析源代码文本，并将其编译成字节码（bytecode）。字节码是一种底层代码，可以把程序表示成 8 位的指令（从 Python 3.6 开始，这种底层代码实际上已经变成 16 位了，所以应该叫作 wordcode 才对，但基本原理依然相同）。然后，CPython 采用基于栈的解释器来运行字节码。这种字节码解释器在执行 Python 程序的过程中，必须确保相关的状态不受干扰，所以 CPython 会用一种叫作全局解释器锁（global interpreter lock，GIL）的机制来保证这一点。</p>\n<p>GIL 实际上就是一种互斥锁（mutual-exclusion lock，mutex），用来防止 CPython 的状态在抢占式的多线程环境（preemptive multithreading）之中受到干扰，因为在这种环境下，一条线程有可能突然打断另一条线程抢占程序的控制权。如果这种抢占行为来得不是时候，那么解释器的状态（例如为垃圾回收工作而设立的引用计数等）就会遭到破坏。所以，CPython 要通过 GIL 阻止这样的动作，以确保它自身以及它的那些 C 扩展模块能够正确地执行每一条字节码指令。</p>\n<p>但是，GIL 会产生一个很不好的影响。在 C++ 与 Java 这样的语言里面，如果程序之中有多个线程能够分头执行任务，那么就可以把 CPU 的各个核心充分地利用起来。尽管 Python 也支持多线程，但这些线程受 GIL 约束，所以每次或许只能有一条线程向前推进，而无法实现多头并进。所以，想通过多线程做并行计算或是给程序提速的开发者，恐怕要失望了。</p>\n<p>例如，我们要用 Python 程序执行一批计算量很大的任务。以最原始的办法实现这样一个因数分解算法，以模拟这种任务。</p>\n<p>我们试着分解几个数。如果必须把上一个数分解完才能开始分解下一个数，那么程序花的时间就比较长。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50234589286187470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import time\n\n\ndef factorize(number):\n    for i in range(1, number + 1):\n        if number % i == 0:\n            yield i\n\n\nnumbers = [2139079, 1214759, 1516637, 1852285]\nstart = time.time()\nfor number in numbers:\n    list(factorize(number))\n\nend = time.time()\ndelta = end - start\nprint(f\'Took {delta:.3f} seconds\')\n\n>>>\nTook 0.428 seconds`, `50234589286187470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> time\n\n\n<span class="token keyword">def</span> <span class="token function">factorize</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> number <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> number <span class="token operator">%</span> i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>\n            <span class="token keyword">yield</span> i\n\n\nnumbers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">2139079</span><span class="token punctuation">,</span> <span class="token number">1214759</span><span class="token punctuation">,</span> <span class="token number">1516637</span><span class="token punctuation">,</span> <span class="token number">1852285</span><span class="token punctuation">]</span>\nstart <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">for</span> number <span class="token keyword">in</span> numbers<span class="token punctuation">:</span>\n    <span class="token builtin">list</span><span class="token punctuation">(</span>factorize<span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\nend <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>\ndelta <span class="token operator">=</span> end <span class="token operator">-</span> start\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Took </span><span class="token interpolation"><span class="token punctuation">{</span>delta<span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string"> seconds\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTook <span class="token number">0.428</span> seconds</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>让每条线程各自分解一个数或许可以把计算机中的多个 CPU 核心充分利用起来。这种想法对于其他语言来说，可能有些道理，但是在 Python 中效果如何呢？我们试着定义这样一种 Python 线程，让它完成与刚才相同的因数分解任务。</p>\n<p>然后，针对每个待分解的数字都启动这样一条线程，让它们平行地运行下去。</p>\n<p>最后，等待所有线程执行完毕。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50604003851108110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import time\n\nfrom threading import Thread\n\n\nclass FactorizeThread(Thread):\n    def __init__(self, number):\n        super().__init__()\n        self.number = number\n\n    def run(self):\n        self.factors = list(factorize(self.number))\n\n\ndef factorize(number):\n    for i in range(1, number + 1):\n        if number % i == 0:\n            yield i\n\n\nnumbers = [2139079, 1214759, 1516637, 1852285]\n\nstart = time.time()\nthreads = []\nfor number in numbers:\n    thread = FactorizeThread(number)\n    thread.start()\n    threads.append(thread)\n\nfor thread in threads:\n    thread.join()\n\nend = time.time()\ndelta = end - start\nprint(f\'Took {delta:.3f} seconds\')\n\n>>>\nTook 0.528 seconds`, `50604003851108110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> time\n\n<span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread\n\n\n<span class="token keyword">class</span> <span class="token class-name">FactorizeThread</span><span class="token punctuation">(</span>Thread<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>number <span class="token operator">=</span> number\n\n    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>factors <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>factorize<span class="token punctuation">(</span>self<span class="token punctuation">.</span>number<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">def</span> <span class="token function">factorize</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> number <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> number <span class="token operator">%</span> i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>\n            <span class="token keyword">yield</span> i\n\n\nnumbers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">2139079</span><span class="token punctuation">,</span> <span class="token number">1214759</span><span class="token punctuation">,</span> <span class="token number">1516637</span><span class="token punctuation">,</span> <span class="token number">1852285</span><span class="token punctuation">]</span>\n\nstart <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>\nthreads <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n<span class="token keyword">for</span> number <span class="token keyword">in</span> numbers<span class="token punctuation">:</span>\n    thread <span class="token operator">=</span> FactorizeThread<span class="token punctuation">(</span>number<span class="token punctuation">)</span>\n    thread<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    threads<span class="token punctuation">.</span>append<span class="token punctuation">(</span>thread<span class="token punctuation">)</span>\n\n<span class="token keyword">for</span> thread <span class="token keyword">in</span> threads<span class="token punctuation">:</span>\n    thread<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\nend <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>\ndelta <span class="token operator">=</span> end <span class="token operator">-</span> start\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Took </span><span class="token interpolation"><span class="token punctuation">{</span>delta<span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string"> seconds\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTook <span class="token number">0.528</span> seconds</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>奇怪的是，这样做竟然比一个一个去分解还要慢。在其他语言中，像这样令 4 条线程分别执行各自的任务，应该比一条线程连续执行 4 份任务要快得多，考虑到创建线程与协调这些线程的开销，新程序的速度可能会比旧程序的 4 倍稍微低一点。即便 CPU 的核心数量不足 4 个，新程序也还是应该比原来更快才对（例如笔者的电脑是双核的，所以应该接近原来的 2 倍），但为什么它没有把多核心的优势发挥出来？这是因为，这种多线程的程序在标准的 CPython 解释器之中会受 GIL 牵制（例如 CPython 要通过 GIL 防止这些线程争抢全局锁，而且要花一些时间来协调）。</p>\n<p>若要 CPython 把多个核心充分利用起来，还是有一些办法的，但那些办法都不采用标准的 Thread 类（参见第 64 条），而且实现起来也需要大量的精力。既然有这么多限制，那 Python 还支持多线程干什么？这其实有两个原因。</p>\n<p>首先，这种机制让我们很容易就能实现出一种效果，也就是令人感觉程序似乎能在同一时间做许多件事。这样的效果采用手工方式很难编写（案例参见第 56 条），而通过线程来实现，则可以让 Python 自动替我们把这些问题处理好，让多项任务能够并发地执行。由于 GIL 机制，虽然每次还是只能有一个线程向前执行，但 CPython 会确保这些 Python 线程之间能够公平地轮换执行。</p>\n<p>其次，我们可以通过 Python 的多线程机制处理阻塞式的 I/O 任务，因为线程在执行某些系统调用的过程中会发生阻塞，假如只支持一条线程，那么整个程序就会卡在这里不动。Python 程序需要通过系统调用与外部环境交互，其中有一些调用属于阻塞式的 I/O 操作，例如读取文件、写入文件、联网以及与显示器等设备交互。多线程机制可以让程序中的其他线程继续执行各自的工作，只有发起调用请求的那条线程才需要卡在那里等待操作系统给出结果。</p>\n<p>例如，要通过串口（serial port）向遥控直升机发送信号。笔者以 select 这个系统调用来模拟这项操作。通过 select 函数让操作系统阻塞 0.1 秒，然后把控制权返还给本程序，这样就模拟出了使用串口通信的效果。</p>\n<p>通过这种方式依次执行系统调用，程序的执行时间会随着调用次数而上升。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17285154204891540000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import time\n\n\ndef slow_systemcall():\n    time.sleep(0.1)\n\n\nstart = time.time()\nfor _ in range(5):\n    slow_systemcall()\nend = time.time()\ndelta = end - start\nprint(f\'Took {delta:.3f} seconds\')\n\n>>>\nTook 0.501 seconds`, `17285154204891540000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> time\n\n\n<span class="token keyword">def</span> <span class="token function">slow_systemcall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>\n\n\nstart <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    slow_systemcall<span class="token punctuation">(</span><span class="token punctuation">)</span>\nend <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>\ndelta <span class="token operator">=</span> end <span class="token operator">-</span> start\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Took </span><span class="token interpolation"><span class="token punctuation">{</span>delta<span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string"> seconds\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTook <span class="token number">0.501</span> seconds</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样写有个问题，就是程序在执行 <code class="language-text">slow_systemcall</code> 函数的过程中会彻底卡住，因为它的主线程会阻塞在 select 这里。在实际的程序里面，这是个相当糟糕的现象，因为我们向直升机发送信号的同时，还需要计算接下来的移动方式，不然直升机就会坠毁。所以，如果在执行阻塞式 I/O 的过程中还需要做计算，那么应该把系统调用放到另一条线程执行。</p>\n<p>下面把 <code class="language-text">slow_systemcall</code> 放在单独的线程里调用，这样能同时触发多项操作，于是我们可以在与多个串口（乃至多个直升机）通信的同时，在主线程里做其他必要的运算。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80230911284748190000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import time\nfrom threading import Thread\n\n\ndef slow_systemcall():\n    time.sleep(0.1)\n\n\ndef compute_helicopter_location(i):\n    pass\n\n\nstart = time.time()\nthreads = []\nfor _ in range(5):\n    thread = Thread(target=slow_systemcall)\n    thread.start()\n    threads.append(thread)\n\nfor i in range(5):\n    compute_helicopter_location(i)\n\n\nfor thread in threads:\n    thread.join()\nend = time.time()\ndelta = end - start\nprint(f\'Took {delta:.3f} seconds\')\n\n>>>\nTook 0.101 seconds`, `80230911284748190000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> time\n<span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread\n\n\n<span class="token keyword">def</span> <span class="token function">slow_systemcall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>\n\n\n<span class="token keyword">def</span> <span class="token function">compute_helicopter_location</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n\nstart <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>\nthreads <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n<span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    thread <span class="token operator">=</span> Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>slow_systemcall<span class="token punctuation">)</span>\n    thread<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    threads<span class="token punctuation">.</span>append<span class="token punctuation">(</span>thread<span class="token punctuation">)</span>\n\n<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    compute_helicopter_location<span class="token punctuation">(</span>i<span class="token punctuation">)</span>\n\n\n<span class="token keyword">for</span> thread <span class="token keyword">in</span> threads<span class="token punctuation">:</span>\n    thread<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>\nend <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>\ndelta <span class="token operator">=</span> end <span class="token operator">-</span> start\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'Took </span><span class="token interpolation"><span class="token punctuation">{</span>delta<span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string"> seconds\'</span></span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span>\nTook <span class="token number">0.101</span> seconds</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>与依次执行系统调用的那种写法相比，这种写法的速度几乎能达到原来的 5 倍。这说明，尽管那 5 条线程依然受 GIL 制约，但它们所发起的系统调用是可以各自向前执行的。GIL 只不过是让 Python 内部的代码无法平行推进而已，至于系统调用，则不会受到影响，因为 Python 线程在即将执行系统调用时，会释放 GIL，待完成调用之后，才会重新获取它。</p>\n<p>除了线程，还有很多办法也能处理阻塞式的 I/O（例如采用内置的 asyncio 模块等）。那些办法都很好，但你可能得花时间去重构代码适应它们所要求的执行模式（参见第 60 条与第 62 条）。与那些办法相比，用多线程处理阻塞式 I/O 是最简单的，而且只需要稍微调整代码就行。</p>\n<h3 id="总结-49"><a href="#%E6%80%BB%E7%BB%93-49" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h3>\n<ol>\n<li>即便计算机具备多核的 CPU，Python 线程也无法真正实现并行，因为它们会受全局解释器锁（GIL）牵制。</li>\n<li>虽然 Python 的多线程机制受 GIL 影响，但还是非常有用的，因为我们很容易就能通过多线程模拟同时执行多项任务的效果。</li>\n<li>多条 Python 线程可以并行地执行多个系统调用，这样就能让程序在执行阻塞式的 I/O 任务时，继续做其他运算。</li>\n</ol>\n<p>// TODO 编写高质量 Python 待完成</p>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/编写高质量Python/index.md absPath of file >>> MarkdownRemark",timeToRead:160,frontmatter:{date:"2023-06-13 12:00:28",path:"/writing-high-quality-python/",tags:"后端, python, 读书笔记",title:"编写高质量Python",draft:null}},{excerpt:"源码结构 重点介绍标红行的内容 对象模型 概述 Python 是一门面向对象语言，实现了一个完整的面向对象体系，简洁而优雅。 一切皆对象 首先，在 Python 世界，基本类型也是对象，与通常意义的“对象”形成一个有机统一。换句话讲，Python 不再区别对待基本类型和对象，所有基本类型内部均由对象实现。一个整数是一个对象，一个字符串也是一个对象： 其次，Python 中的类型也是一种对象，称为类型对象。整数类型是一个对象，字符串类型是一个对象，程序中通过 class…",html:'<h1 id="源码结构"><a href="#%E6%BA%90%E7%A0%81%E7%BB%93%E6%9E%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>源码结构</h1>\n<p>重点介绍标红行的内容</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48379465675454080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ cd Python-3.7.4\n\\$ tree -L 1\n.\n├── CODE_OF_CONDUCT.rst\n├── Doc # 文档相关\n├── Grammar # 语法规则\n├── Include # 头文件\n├── LICENSE\n├── Lib # 标准库\n├── Mac\n├── Makefile.pre.in\n├── Misc\n├── Modules\n├── Objects # 内建对象实现\n├── PC\n├── PCbuild\n├── Parser # 语法分析相关\n├── Programs\n├── Python # 虚拟机执行相关\n├── README.rst\n├── Tools\n├── aclocal.m4\n├── config.guess\n├── config.sub\n├── configure\n├── configure.ac\n├── install-sh\n├── m4\n├── pyconfig.h.in\n└── setup.py`, `48379465675454080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash{7,14,19}"\n              >\n                <span class="gatsby-code-button-language">bash{7,14,19}</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight has-highlighted-lines" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token builtin class-name">cd</span> Python-3.7.4\n$ tree -L <span class="token number">1</span>\n<span class="token builtin class-name">.</span>\n├── CODE_OF_CONDUCT.rst\n├── Doc <span class="token comment"># 文档相关</span>\n├── Grammar <span class="token comment"># 语法规则</span>\n<span class="gatsby-highlight-code-line">├── Include <span class="token comment"># 头文件</span></span>├── LICENSE\n├── Lib <span class="token comment"># 标准库</span>\n├── Mac\n├── Makefile.pre.in\n├── Misc\n├── Modules\n<span class="gatsby-highlight-code-line">├── Objects <span class="token comment"># 内建对象实现</span></span>├── PC\n├── PCbuild\n├── Parser <span class="token comment"># 语法分析相关</span>\n├── Programs\n<span class="gatsby-highlight-code-line">├── Python <span class="token comment"># 虚拟机执行相关</span></span>├── README.rst\n├── Tools\n├── aclocal.m4\n├── config.guess\n├── config.sub\n├── configure\n├── configure.ac\n├── install-sh\n├── m4\n├── pyconfig.h.in\n└── setup.py</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="对象模型"><a href="#%E5%AF%B9%E8%B1%A1%E6%A8%A1%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>对象模型</h1>\n<h2 id="概述"><a href="#%E6%A6%82%E8%BF%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>概述</h2>\n<p>Python 是一门面向对象语言，实现了一个完整的面向对象体系，简洁而优雅。</p>\n<h3 id="一切皆对象"><a href="#%E4%B8%80%E5%88%87%E7%9A%86%E5%AF%B9%E8%B1%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>一切皆对象</h3>\n<p>首先，在 Python 世界，基本类型也是对象，与通常意义的“对象”形成一个有机统一。换句话讲，Python 不再区别对待基本类型和对象，所有基本类型内部均由对象实现。一个整数是一个对象，一个字符串也是一个对象：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83622275136930410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> a = 1\n>>> b = \'abc\'`, `83622275136930410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> <span class="token number">1</span>\n<span class="token operator">>></span><span class="token operator">></span> b <span class="token operator">=</span> <span class="token string">\'abc\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>其次，Python 中的类型也是一种对象，称为类型对象。整数类型是一个对象，字符串类型是一个对象，程序中通过 class 关键字定义的类也是一个对象。</p>\n<p>举个例子，整数类型在 Python 内部是一个对象，称为类型对象：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94291635470023480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> int\n<class \'int\'>`, `94291635470023480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> int\n<span class="token operator">&lt;</span>class <span class="token string">\'int\'</span><span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>通过整数类型实例化可以得到一个整数对象，称为实例对象：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25611447796591260000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> int(\'1024\')\n1024`, `25611447796591260000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> int<span class="token punctuation">(</span><span class="token string">\'1024\'</span><span class="token punctuation">)</span>\n<span class="token number">1024</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>面向对象理论中的“类”和“对象”这两个基本概念，在 Python 内部都是通过对象实现的，这是 Python 最大的特点。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-09-26-14-06-58-f162165e86496acbf1a76ad13c5a31a3-eca56.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 554px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 41.87725631768953%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsSAAALEgHS3X78AAABPklEQVQY022Ry07DMBBF89+s+Am2LGDBDxQhQAhQ2TSAKEJR20CjvJvUaRqSOLYzY+MkFW/Li7Fm5s6dY0MpJeXX/Tzfwq4CsJUSd49doAz156BUgJ1OEKdBnJQMg3RLuYjJ4vr+eGpfCWAgtZY0dBVl2AhJuWxE17QIy9vnaLXlwSrz4qzmGJKKcvCTl8vJoWmNWmC7yd66Me3cnJMHO3tcFmUDNQdSMC3kxhs32kDvsUWBCINtJirbNzdFZMzC+s5KzybOzVMwWeR51Q4Ufq6Mw56yT5Q0Oznft5ZjQ49yksYnzF0zJ6F6209a2oYfE9nzqps8Iq9kG6AEQP4PMC3cgnKS+sJ0ZmHpp6XtJkIIndI+j073RuMDjV039/B7YL/+STt/i4qsFFFWTeeeZXvvtEYUTFDRdqgAxVD5AYk9xqJbAVrfAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 09 26 14 06 58" title="" data-src="/static/2022-09-26-14-06-58-f162165e86496acbf1a76ad13c5a31a3-eca56.png" data-srcset="/static/2022-09-26-14-06-58-f162165e86496acbf1a76ad13c5a31a3-77254.png 200w,\n/static/2022-09-26-14-06-58-f162165e86496acbf1a76ad13c5a31a3-789d0.png 400w,\n/static/2022-09-26-14-06-58-f162165e86496acbf1a76ad13c5a31a3-eca56.png 554w" data-sizes="(max-width: 554px) 100vw, 554px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h3 id="类型、对象体系"><a href="#%E7%B1%BB%E5%9E%8B%E3%80%81%E5%AF%B9%E8%B1%A1%E4%BD%93%E7%B3%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>类型、对象体系</h3>\n<p>a 是一个整数对象（实例对象），其类型是整数类型（类型对象）：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18809075740183290000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> a = 1\n>>> type(a)\n<class \'int\'>\n>>> isinstance(a, int)\nTrue`, `18809075740183290000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> <span class="token number">1</span>\n<span class="token operator">>></span><span class="token operator">></span> type<span class="token punctuation">(</span>a<span class="token punctuation">)</span>\n<span class="token operator">&lt;</span>class <span class="token string">\'int\'</span><span class="token operator">></span>\n<span class="token operator">>></span><span class="token operator">></span> isinstance<span class="token punctuation">(</span>a, int<span class="token punctuation">)</span>\nTrue</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>那么整数类型的类型又是什么呢？</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93485116993385900000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> type(int)\n<class \'type\'>`, `93485116993385900000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> type<span class="token punctuation">(</span>int<span class="token punctuation">)</span>\n<span class="token operator">&lt;</span>class <span class="token string">\'type\'</span><span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>可以看到，整数类型的类型还是一种类型，即类型的类型。只是这个类型比较特殊，它的实例对象还是类型对象。</p>\n<p>Python 中还有一个特殊类型 object，所有其他类型均继承于 object，换句话讲 object 是所有类型的基类：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79488468878230110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> issubclass(int, object)\nTrue`, `79488468878230110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> issubclass<span class="token punctuation">(</span>int, object<span class="token punctuation">)</span>\nTrue</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>综合以上关系，得到以下关系图：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-09-26-14-27-03-51d4d9e5c9a559d8abc8f4f11374cb46-88eb7.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 411px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 39.65936739659367%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsSAAALEgHS3X78AAABPElEQVQY042P7UvCUBTG9/f3IepLIQXRCxaEUZEDsUZqOac559xubeKuc3d3t8vcXPbe3LopyPoQ9OPhcjgP55znctjFgiBIDcn3/TRNkzmscBynXC63mq1oMln00zlxHOu63pCkp+mUq4KiAE4utUJV4+OvH8MwjDAISrJ5emcx8e1+FEUQQkVRXt8+3N7VY/uYyAUkn3G8tnskrR9Ka0VlbzweY4wppWpXObgBudpg89rINyEAACFEiNcfDFEjTyursLRCxW3uwe4arsJkOlo2G7C9joU7lqfbHoP9Ip27ITYnIyVCqm+rXJohyZDtW5bFYgdhyOro+cWELnSoS3wuSWZLZQdmGWOxKwzDoW3ftyv67TkQL3p1/tflv1jGef+MA61IahtU3Ark/L+GlyvYS1Qe1XJE3HHq+9/c+LKLiEVIiwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 09 26 14 27 03" title="" data-src="/static/2022-09-26-14-27-03-51d4d9e5c9a559d8abc8f4f11374cb46-88eb7.png" data-srcset="/static/2022-09-26-14-27-03-51d4d9e5c9a559d8abc8f4f11374cb46-e0906.png 200w,\n/static/2022-09-26-14-27-03-51d4d9e5c9a559d8abc8f4f11374cb46-4c29a.png 400w,\n/static/2022-09-26-14-27-03-51d4d9e5c9a559d8abc8f4f11374cb46-88eb7.png 411w" data-sizes="(max-width: 411px) 100vw, 411px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>内置类型已经搞清楚了，自定义类型及对象关系又如何呢？定义一个简单的类来实验：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48868756043191430000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Dog(object):\n\n    def yelp(self):\n        print(\'woof\')`, `48868756043191430000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Dog</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    <span class="token keyword">def</span> <span class="token function">yelp</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'woof\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>创建一个 Dog 实例，毫无疑问，其类型是 Dog：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65236640241980520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> dog = Dog()\n>>> dog.yelp()\nwoof\n>>> type(dog)\n<class \'__main__.Dog\'>`, `65236640241980520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> dog <span class="token operator">=</span> Dog<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> dog.yelp<span class="token punctuation">(</span><span class="token punctuation">)</span>\nwoof\n<span class="token operator">>></span><span class="token operator">></span> type<span class="token punctuation">(</span>dog<span class="token punctuation">)</span>\n<span class="token operator">&lt;</span>class <span class="token string">\'__main__.Dog\'</span><span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Dog 类的类型自然也是 type，其基类是 object (就算不显式继承也是如此)：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60267623315978945000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> type(Dog)\n<class \'type\'>\n>>> issubclass(Dog, object)\nTrue`, `60267623315978945000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> type<span class="token punctuation">(</span>Dog<span class="token punctuation">)</span>\n<span class="token operator">&lt;</span>class <span class="token string">\'type\'</span><span class="token operator">></span>\n<span class="token operator">>></span><span class="token operator">></span> issubclass<span class="token punctuation">(</span>Dog, object<span class="token punctuation">)</span>\nTrue</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-09-26-14-31-23-a3e8ae864d8666972bdd89e480a5e436-6a9ea.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 413px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 50.847457627118644%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsSAAALEgHS3X78AAAB2klEQVQoz2VSXVPaUBDN/58+9KXoi+ODnVpH2o6VghiwVYwEggEkEBAvBBLuFfJ1k5APQ2K6FdvpjDv34ezOnt2zu5cxDKNSrfB8nTySLMueXwyAoijn5yzPNxzH2cazF4uiqN/vNfh6FIYM/8BW5WNWOvrZP1mv/TAMo+jJWC3POuiLqBwLk3JXAX4cPwGNUmchftdvD1fiEaodMNyk8LW9mxdy5cEnfaVblgUZcl/KC2j/ZrLHodMelmUZ44XnecViaXq5p3M7+CqnXe0wxJ4v13PdV7Gl/NMGKjXTmVm+SkPN9JIkgaK2bVNKA1NN6Cx1VYeMmTja6MSaIc02KbDSNN2WiILAfFygYT/wXHAJIQghABpeyg/ztjQyqMd0UaMmleA15F/Z38ZpkohIu+iN2c4QAEyr67rrusAfNstKqzBtFYb1U+ZaOfl2t5sXP5zJHwkmkGSa5q3QLA60z13tsD27mFqSJGGMQfVoNFKv9+fsO53LKZX3THfCN1GVv2eb95dJ8qp5E8ctpHHjRW2kilMMM2+vBQDLNXJXWg0qk9YPJntjcBg42P8RWFUcx28zmWeo+Po10j89N5tOpwOzYUy2Mta+LwiCqqqwalin57mU2pZpBL7/G6DOFwYzWZ0DAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 09 26 14 31 23" title="" data-src="/static/2022-09-26-14-31-23-a3e8ae864d8666972bdd89e480a5e436-6a9ea.png" data-srcset="/static/2022-09-26-14-31-23-a3e8ae864d8666972bdd89e480a5e436-7efe1.png 200w,\n/static/2022-09-26-14-31-23-a3e8ae864d8666972bdd89e480a5e436-33ab6.png 400w,\n/static/2022-09-26-14-31-23-a3e8ae864d8666972bdd89e480a5e436-6a9ea.png 413w" data-sizes="(max-width: 413px) 100vw, 413px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>自定义子类及实例对象在图中又处于什么位置？定义一个猎犬类进行实验：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75789260059434630000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Sleuth(Dog):\n\n    def hunt(self):\n        pass`, `75789260059434630000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Sleuth</span><span class="token punctuation">(</span>Dog<span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    <span class="token keyword">def</span> <span class="token function">hunt</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">pass</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，猎犬对象(sleuth)是猎犬类(Sleuth)的实例，Sleuth 的类型同样是 type：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52721710635726150000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> sleuth = Sleuth()\n>>> sleuth.hunt()\n>>> type(sleuth)\n<class \'__main__.Sleuth\'>\n>>> type(Sleuth)\n<class \'type\'>`, `52721710635726150000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> sleuth <span class="token operator">=</span> Sleuth<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> sleuth.hunt<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> type<span class="token punctuation">(</span>sleuth<span class="token punctuation">)</span>\n<span class="token operator">&lt;</span>class <span class="token string">\'__main__.Sleuth\'</span><span class="token operator">></span>\n<span class="token operator">>></span><span class="token operator">></span> type<span class="token punctuation">(</span>Sleuth<span class="token punctuation">)</span>\n<span class="token operator">&lt;</span>class <span class="token string">\'type\'</span><span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>同时，Sleuth 类继承自 Dog 类，是 Dog 的子类，当然也是 object 的子类：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21097917086553620000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> issubclass(Sleuth, Dog)\nTrue\n>>> issubclass(Sleuth, object)\nTrue`, `21097917086553620000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> issubclass<span class="token punctuation">(</span>Sleuth, Dog<span class="token punctuation">)</span>\nTrue\n<span class="token operator">>></span><span class="token operator">></span> issubclass<span class="token punctuation">(</span>Sleuth, object<span class="token punctuation">)</span>\nTrue</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-09-26-14-34-40-8a770286b1773b8e58b00215e7bc51cb-88eb7.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 411px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 69.82968369829685%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsSAAALEgHS3X78AAACfklEQVQoz21SWVPaUBjN/3/rTHU6OvahrdVqEStTUVnVokBCSEISCJANuISQPSRkI9CLtJ3O6Hm465z7nfOdi6gztVq9R5uYZVqbzWb9ArgYj+RysdjC0IVj7843L4iTlO1xT/WmvwyRX2y+TGdL9MVDJx8EQRRFcZKYhlEkBpfY4Ac2KJC86y5WqwReLYMQ0CWllVHwrNTMIgXu6zm+d46/v6Y+65puWZa7WFBE+wwVPjZGh09ChgAMw6iq6vv+w2ONrx7a9f1p9d386QDpg46g0YJODwC9Tv9oW61WHNA6E4MBVg8YYRiapgnJlUpVZhuRyiyVjikRSBTEluZOR2rgh1tv6c71Oo5CR59PZcH3HHhuGAaO40kSm7bbF0GPH890G6EGaI0qPbbvqD62+Yt1mrLi5IFgyxhFDqVVmkIyx3Hj8biLP7L1PFPPd7ESUhme5ZijHHt00zmeTpX5fG6YZgtFr5nJBTvLMNMCr5MkKQgCz/PdXh80TrTantk4UGqHSJ2/ve9flnuZ58FdAnNIU1jZdZy6qN6w4+uO1JD1MIps23ZdF3qa0UWleaoTFxP0+9ZzHCZw9Fz/X5hwSpNEAZORJAa+D7ewYXEcb3uZbtu6SjdJuka4QZdiCJajm1h9V3YHXpQaGP7cxLA2sVwuNU3bvAJSYS4L7Ldb5qREZqEwz/NgJLIklWjxipSuSPG+D2CfYFpvkPOdL9n2hwy+n2t9cp0tGYYsiUKOEE5a4jE6/MmM4Q97+aGvyKoJ5g5QbaCa051nXdd93zO9QLEWiu1pzgIAAJW/Ufn/DSRDeRRFDXl+Mhrt3gqDZbtNyLIMbUNRjuPAzOEaevwNVwbuhYMtriQAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 09 26 14 34 40" title="" data-src="/static/2022-09-26-14-34-40-8a770286b1773b8e58b00215e7bc51cb-88eb7.png" data-srcset="/static/2022-09-26-14-34-40-8a770286b1773b8e58b00215e7bc51cb-e0906.png 200w,\n/static/2022-09-26-14-34-40-8a770286b1773b8e58b00215e7bc51cb-4c29a.png 400w,\n/static/2022-09-26-14-34-40-8a770286b1773b8e58b00215e7bc51cb-88eb7.png 411w" data-sizes="(max-width: 411px) 100vw, 411px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>现在不可避免需要讨论 type 以及 object 这两个特殊的类型。</p>\n<p>理论上，object 是所有类型的基类，本质上是一种类型，因此其类型必然是 type。而 type 是所有类型的类型，本质上也是一种类型，因此其类型必须是它自己！</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60985564509830504000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> type(object)\n<class \'type\'>\n>>> type(object) is type\nTrue`, `60985564509830504000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> type<span class="token punctuation">(</span>object<span class="token punctuation">)</span>\n<span class="token operator">&lt;</span>class <span class="token string">\'type\'</span><span class="token operator">></span>\n<span class="token operator">>></span><span class="token operator">></span> type<span class="token punctuation">(</span>object<span class="token punctuation">)</span> is <span class="token builtin class-name">type</span>\nTrue</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75614361610515940000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> type(type)\n<class \'type\'>\n>>> type(type) is type\nTrue`, `75614361610515940000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> type<span class="token punctuation">(</span>type<span class="token punctuation">)</span>\n<span class="token operator">&lt;</span>class <span class="token string">\'type\'</span><span class="token operator">></span>\n<span class="token operator">>></span><span class="token operator">></span> type<span class="token punctuation">(</span>type<span class="token punctuation">)</span> is <span class="token builtin class-name">type</span>\nTrue</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>另外，由于 object 是所有类型的基类，理论上也是 type 的基类(<code class="language-text">__base__</code> 属性)：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23991693207737530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> issubclass(type, object)\nTrue\n>>> type.__base__\n<class \'object\'>`, `23991693207737530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> issubclass<span class="token punctuation">(</span>type, object<span class="token punctuation">)</span>\nTrue\n<span class="token operator">>></span><span class="token operator">></span> type.__base__\n<span class="token operator">&lt;</span>class <span class="token string">\'object\'</span><span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是 object 自身便不能有基类了。为什么呢？对于存在继承关系的类，成员属性和成员方法查找需要回溯继承链，不断查找基类。因此，继承链必须有一个终点，不然就死循环了。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-09-26-14-39-00-9ecc371a5f2678ab7021dfda7e417623-9e231.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 444px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 64.86486486486486%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsSAAALEgHS3X78AAACVElEQVQoz11S+U/bMBjN///bJDQNaUyTOCaujg3EzThKabKWNM3RpgSa1Dmb2rmc5iTtjBgV27Nl2Z+e36f3bAoi2LhrsOx9hKP5fD6bzcia53mr1WrSNND1RZEgTRNR4Adyn2wIh6KV88Pu+hG/TssXeZoXRVGVpaCoW8zjZnNQux9aEzSrnsvyOY5js7NvMWtua4Ov73UFiWJGJz/5z/viyq18hKAXRqGP4CXT2ew6X+pyTXR5WdHBKEnT3d1drf4VMSuwuWxwx8pQo1DoIjx2Q8uL0PwN0zSzUGD72Jz4ZVVFYeg4DsdxwcR86rVttZenke04VIynIw30JDnG8cLerKosA0gCb4AROUZRxLJsWRZAN6/rDaZ1H4bYdV2KVW9Oha1zcbut3GRJRmIo81xW9RMJHHSUywfLcqFtWQAASRKVZg00Nwx6Q5fqRIiiwUmt82mPX74dHE7G0A8C6LrXLW5fQWvM4FgN5OHItkzdMCwicbcKLj7AxsdH+rsfxtQksNHUdiODmH/vWUehpOp2gJ+rWYxxmqbEEYZGgsAUarH/QqZIN6Aa2hPQVLC4nGUpUJ9ErvPQEzHGCKGyLOf/gmhRv5WrM377TNihe5dpkmU5GVl/qB1yjwfsw5moAsshnf9m+X6SzjfKjx12aYtd+iXuIeiTYHEYXrW5b6y2ygy2u8CCPuFVb5/sVeX1Uaixb5ieanpD17deSFXleV6SF6Y/1VFkh9MJQkmSvP+kC1D/2RiPx+12W+73EYSkUhaFwPP9ft80zVdCEASEYxgGCeIPgoG69YDkYtYAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 09 26 14 39 00" title="" data-src="/static/2022-09-26-14-39-00-9ecc371a5f2678ab7021dfda7e417623-9e231.png" data-srcset="/static/2022-09-26-14-39-00-9ecc371a5f2678ab7021dfda7e417623-f72be.png 200w,\n/static/2022-09-26-14-39-00-9ecc371a5f2678ab7021dfda7e417623-0eb67.png 400w,\n/static/2022-09-26-14-39-00-9ecc371a5f2678ab7021dfda7e417623-9e231.png 444w" data-sizes="(max-width: 444px) 100vw, 444px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这就完整了！</p>\n<p>可以看到，所有类型的基类收敛于 object，所有类型的类型都是 type，包括它自己！这就是 Python 类型、对象体系全图，设计简洁、优雅、严谨。</p>\n<p>该图将成为后续阅读源码、探索 Python 对象模型的有力工具，像地图一样指明方向。图中所有实体在 Python 内部均以对象形式存在，至于对象到底长啥样，相互关系如何描述，这些问题先按下不表，后续一起到源码中探寻答案。</p>\n<h3 id="变量只是名字"><a href="#%E5%8F%98%E9%87%8F%E5%8F%AA%E6%98%AF%E5%90%8D%E5%AD%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>变量只是名字</h3>\n<p>先看一个例子，定义一个变量 a，并通过 id 内建函数取出其“地址”：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39907432190606220000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> a = 1\n>>> id(a)\n4302704784`, `39907432190606220000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> <span class="token number">1</span>\n<span class="token operator">>></span><span class="token operator">></span> id<span class="token punctuation">(</span>a<span class="token punctuation">)</span>\n<span class="token number">4302704784</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>定义另一个变量 b，以 a 赋值，并取出 b 的“地址”：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63674407997735670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> b = a\n>>> id(b)\n4302704784`, `63674407997735670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> b <span class="token operator">=</span> a\n<span class="token operator">>></span><span class="token operator">></span> id<span class="token punctuation">(</span>b<span class="token punctuation">)</span>\n<span class="token number">4302704784</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>惊奇地看到，a 和 b 这两个变量的地址居然是相同的！这不合常理呀！</p>\n<p>对于大多数语言（C 语言为例），定义变量 a 即为其分配内存并存储变量值</p>\n<p>变量 b 内存空间与 a 独立，<code class="language-text">赋值时进行拷贝，不赋值时还是原来地址</code></p>\n<p>在 Python 中，一切皆对象，整数也是如此，变量只是一个与对象关联的名字</p>\n<p>而变量赋值，只是将当前对象与另一个名字进行关联，背后的对象是同一个</p>\n<p>因此，在 Python 内部，变量只是一个名字，保存指向实际对象的指针，进而与其绑定。变量赋值只拷贝指针，并不拷贝指针背后的对象</p>\n<h3 id="可变对象与不可变对象"><a href="#%E5%8F%AF%E5%8F%98%E5%AF%B9%E8%B1%A1%E4%B8%8E%E4%B8%8D%E5%8F%AF%E5%8F%98%E5%AF%B9%E8%B1%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>可变对象与不可变对象</h3>\n<p>定义一个整数变量：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16751066727279040000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> a = 1\n>>> id(a)\n4302704784`, `16751066727279040000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> <span class="token number">1</span>\n<span class="token operator">>></span><span class="token operator">></span> id<span class="token punctuation">(</span>a<span class="token punctuation">)</span>\n<span class="token number">4302704784</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>然后，对其自增 1：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56445073806746616000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> a += 1\n>>> a\n2\n>>> id(a)\n4302704816`, `56445073806746616000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">+=</span> <span class="token number">1</span>\n<span class="token operator">>></span><span class="token operator">></span> a\n<span class="token number">2</span>\n<span class="token operator">>></span><span class="token operator">></span> id<span class="token punctuation">(</span>a<span class="token punctuation">)</span>\n<span class="token number">4302704816</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>数值符合预期，但是对象变了！初学者一脸懵逼，这是什么鬼？</p>\n<p>一切要从可变对象和不可变对象说起。可变对象在对象创建后，其值可以进行修改；而不可变对象在对象创建后的整个生命周期，其值都不可修改。</p>\n<p>在 Python 中，整数类型是不可变类型，整数对象是不可变对象。修改整数对象时，Python 将以新数值创建一个新对象，变量名与新对象进行绑定；旧对象如无其他引用，将被释放。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-09-26-14-55-02-edbe5bb603f09f86fadb5476e6d7b087-ec22f.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 21.51851851851852%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsSAAALEgHS3X78AAAAr0lEQVQI14WPzQ6CMBCEef9X0aOaeEQ8mGDiwSMXFA3hx0ILLdtu27VAPPtlN9lkkpnZCAz2ozJotdENq/jYOef8AhGtKqIl8oAyjPOOfkTFZ4izquWqF03y2CT5lkvGPt2zKGBS716dsqruBjBjWh7ScsenljwhYnCPwrolxDorFBOShSOEz3KoQLRGyWm85fH9dWaiAdCcc2NMRP/wNFtrnK7F8ZLv2VDP7wBYa7/D4uSVrSOjfAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 09 26 14 55 02" title="" data-src="/static/2022-09-26-14-55-02-edbe5bb603f09f86fadb5476e6d7b087-fee1c.png" data-srcset="/static/2022-09-26-14-55-02-edbe5bb603f09f86fadb5476e6d7b087-a67b7.png 200w,\n/static/2022-09-26-14-55-02-edbe5bb603f09f86fadb5476e6d7b087-0b187.png 400w,\n/static/2022-09-26-14-55-02-edbe5bb603f09f86fadb5476e6d7b087-fee1c.png 800w,\n/static/2022-09-26-14-55-02-edbe5bb603f09f86fadb5476e6d7b087-b1a91.png 1200w,\n/static/2022-09-26-14-55-02-edbe5bb603f09f86fadb5476e6d7b087-95179.png 1600w,\n/static/2022-09-26-14-55-02-edbe5bb603f09f86fadb5476e6d7b087-5d5ba.png 2400w,\n/static/2022-09-26-14-55-02-edbe5bb603f09f86fadb5476e6d7b087-ec22f.png 2700w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<blockquote>\n<p>每次修改整数对象都要创建新对象、回收旧对象，效率不是很低吗？确实是，后续章节将从源码角度来解答：Python 如何通过小整数池等手段进行优化。</p>\n</blockquote>\n<p>可变对象是指创建后可以修改的对象，典型的例子是列表（list）：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11434559860376803000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> l = [1, 2]\n>>> l\n[1, 2]\n>>> id(l)\n4385900424`, `11434559860376803000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> l <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span>, <span class="token number">2</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> l\n<span class="token punctuation">[</span><span class="token number">1</span>, <span class="token number">2</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> id<span class="token punctuation">(</span>l<span class="token punctuation">)</span>\n<span class="token number">4385900424</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>往列表里头追加数据，发现列表对象还是原来那个，只不过多了一个元素了：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66418956318514580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> l.append(3)\n>>> l\n[1, 2, 3]\n>>> id(l)\n4385900424`, `66418956318514580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> l.append<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> l\n<span class="token punctuation">[</span><span class="token number">1</span>, <span class="token number">2</span>, <span class="token number">3</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> id<span class="token punctuation">(</span>l<span class="token punctuation">)</span>\n<span class="token number">4385900424</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>实际上，列表对象内部维护了一个动态数组，存储元素对象的指针：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-09-26-14-57-36-c06c10d56c1cf0776568bd8279c06873-8132c.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 70.74509803921568%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsSAAALEgHS3X78AAACH0lEQVQoz5VSXW/SUBjm/3inF/4Br0zmbzDRqDHTxJgYjfEXeLEYFiQjGWqUxWgCMjslgIwxNspgKAwoo/SDj9qtlLa0UE4/PUCDS7kwvic5H2/O87zvc87jsW3bMk3LNCzLtP8V1iwWR4+u66ky8a3K5DFqKAqiJAmiAMBkygnHhasulikYLjWKQfaL7TPeNA0YMDuSwEQFLgAso8hjaSDrmuFUnmY10KHIOUwaCUgpGD7yb2VeRUuBAp6aVwIA8PygxVRz9QSKJVu/T0zT9CyI4QHO3T5x58Pl+x+v3nx95dbWpY3Uc5icTFSe7xu6lWlGkp3NWCsQx95rmuZxvUSvTz4NX3+B3HgWXnkSvRY6fGmbNtfn5tQk00wffd8/TmBU2Wl7gdQ1s9XBvJnVjeKjQOGxN3cvXPBPRrAGUFVVlmWBl2qVBtvtA1V3wH871y2ii62l7/ryD3zow7WD25/z62MZiJKoKLIGtDOhU28Xa3SREShHM8/z9XodwzBJHPbO6ciJN0YGoLDt0/UDHJmSzixgGXaOQtLMu1T77R7xydGsKArLshzHKfKoy9I7lc0feCjZDMWwINpMXNTVaFcSaHS3gJTxvLtt+IF0j/jyyxdvBePNN18xf7axMwM75huPx6cNnCJpeSgvP5jBcr0sHkVp5JDYzpKRagdd+Gl541k2nTJUSsc/07t7JEG53AmtMhgMzqFARXGD/zf+AJK4+JSIZDJuAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 09 26 14 57 36" title="" data-src="/static/2022-09-26-14-57-36-c06c10d56c1cf0776568bd8279c06873-fee1c.png" data-srcset="/static/2022-09-26-14-57-36-c06c10d56c1cf0776568bd8279c06873-a67b7.png 200w,\n/static/2022-09-26-14-57-36-c06c10d56c1cf0776568bd8279c06873-0b187.png 400w,\n/static/2022-09-26-14-57-36-c06c10d56c1cf0776568bd8279c06873-fee1c.png 800w,\n/static/2022-09-26-14-57-36-c06c10d56c1cf0776568bd8279c06873-b1a91.png 1200w,\n/static/2022-09-26-14-57-36-c06c10d56c1cf0776568bd8279c06873-8132c.png 1275w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>列表对象增减元素，需要修改该数组。例如，追加元素 3 ：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-09-26-14-57-53-2ae62b20e586d61ec644ac741bd4c6d4-8132c.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 88.23529411764706%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAIAAADUsmlHAAAACXBIWXMAAAsSAAALEgHS3X78AAACkklEQVQ4y5VTSW/TUBD2f+KAxIkLQtz4Ady4AAXSIiQkhBBivXFAQNMiNbQSoqGN1FXFDV2SpkqatkmaOrscmyS2Q+J63/3s8JyEigYq6Mh+fn6eb+abmc9Ip9NxHGDbtuM4nX+Z27XjVwQAEMEINE/tlL5LAi+KIi/whqG7HddxHXidFsUDw0eepJe393G67RGwbXiqy5amGl2vEwBN1SRB0VWznxnetmnilZJtW3BvWkY0Px/OTodiYxv5mXgR7eFhUQIv1BkySyTih2sV5kBWReSYg9NdRZUbDl68M3vhuv/8reC554vXesTZIxZYLlZLrpIfvhGBpeJovYUjPQIwcC+EqHCP5q4+XLpyP3j5wcKl1+hNYDscx2m65oUQmlsZNJpGE9i6okvI7w2Afg2m9i7qe78z5E/63iZuTMQeQ7amacK+qqqqyGrhsIyXSOFI6td8bAA4VLM+Grs3tuvzJ0dGk7cDsSdwApIk8TyvaZoo840WUSIwVmJ0Q/PAcDwkSRIEIUlys037EyPjmbvj6WF/emgq+RRmgyNwu30rUPsbjcl1YipcnaBYwgPDqDiOQzDPCT/azKf9l8H8i2Du1efcs1DqjSh6aWVZhp6NdjWCzUeyC1FskZPaJ2nbgGlSy5kAWpxEC5NfC4FwNthtpQvBMITAiTvx3Ww6VyOpfs3wW0+btg2aLWa9NB2nQwl6bpua3SrPO8D5NRHXNA2WaxG1qgUMAGxkQHSwvCOe3Uslw2toKrMHldBHdsddrKdWyx9XsMBKboJmSeSv0rUsW9N0uA6IucrkNytfIpXQZnmmJdDIaaL/c+/lB85B5iCdSldxYnDO//NLQsHoum4YxpnBsK+KogiCAGVzZvCA/QT5VdllU1ebPAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 09 26 14 57 53" title="" data-src="/static/2022-09-26-14-57-53-2ae62b20e586d61ec644ac741bd4c6d4-fee1c.png" data-srcset="/static/2022-09-26-14-57-53-2ae62b20e586d61ec644ac741bd4c6d4-a67b7.png 200w,\n/static/2022-09-26-14-57-53-2ae62b20e586d61ec644ac741bd4c6d4-0b187.png 400w,\n/static/2022-09-26-14-57-53-2ae62b20e586d61ec644ac741bd4c6d4-fee1c.png 800w,\n/static/2022-09-26-14-57-53-2ae62b20e586d61ec644ac741bd4c6d4-b1a91.png 1200w,\n/static/2022-09-26-14-57-53-2ae62b20e586d61ec644ac741bd4c6d4-8132c.png 1275w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h3 id="定长对象与变长对象"><a href="#%E5%AE%9A%E9%95%BF%E5%AF%B9%E8%B1%A1%E4%B8%8E%E5%8F%98%E9%95%BF%E5%AF%B9%E8%B1%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>定长对象与变长对象</h3>\n<p>Python 一个对象多大呢？相同类型对象大小是否相同呢？想回答类似的问题，需要考察影响对象大小的因素。</p>\n<p>标准库 sys 模块提供了一个查看对象大小的函数 getsizeof：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15794735989898535000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> import sys\n>>> sys.getsizeof(1)\n28`, `15794735989898535000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> <span class="token function">import</span> sys\n<span class="token operator">>></span><span class="token operator">></span> sys.getsizeof<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>\n<span class="token number">28</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>先观察整数对象：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9810679821539470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> sys.getsizeof(1)\n28\n>>> sys.getsizeof(100000000000000000)\n32\n>>> sys.getsizeof(100000000000000000000000000000000000000000000)\n44`, `9810679821539470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> sys.getsizeof<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>\n<span class="token number">28</span>\n<span class="token operator">>></span><span class="token operator">></span> sys.getsizeof<span class="token punctuation">(</span><span class="token number">100000000000000000</span><span class="token punctuation">)</span>\n<span class="token number">32</span>\n<span class="token operator">>></span><span class="token operator">></span> sys.getsizeof<span class="token punctuation">(</span><span class="token number">100000000000000000000000000000000000000000000</span><span class="token punctuation">)</span>\n<span class="token number">44</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可见整数对象的大小跟其数值有关，像这样大小不固定的对象称为变长对象。</p>\n<p>我们知道，位数固定的整数能够表示的数值范围是有限的，可能导致溢出。Python 为解决这个问题，采用类似 C++ 中大整数类的思路实现整数对象——串联多个普通 32 位整数，以便支持更大的数值范围。至于需要多少个 32 位整数，则视具体数值而定，数值不大的一个足矣，避免浪费</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-09-26-15-04-06-7f087bb66c838f08020f7f7ffb16d2e6-6cf8d.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 62.55555555555555%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsSAAALEgHS3X78AAAB40lEQVQoz6WS3U/TUBjG+RtJFL0x8cIEM7ZOjSNBbrzwRhQ3PtZRunXIWJbuCgSN0K6STFjXlpVi90HIxtbPuS0jxq0ltJ09juzCEDXhzZuTJ3nf33NOcp6xwS1qrPujLUr5ssq6XVG5isaJMl3VSsOxZdkVmS8pDJhqXFkDayWZ6/V/Alio5eAjT/TkCVKAIqxvhYXChUmcfTeE+z0jzsyuCl6U90dY7wrnQ3gfevRM0moAFht5VIBeph8EYncD0QloYXwu8/BDMTyCU+KrN+Sj6di956t3AujEi8T99eKM3DwH8EmNDtNeOOeHD/2RnH85Cy3Rj/F8cAgbfROjZ8OMZ/HrlLu2mPUs01MI81TSf8OVurD1DSaq8W0R2TyGydraTjmyx+Ojm7eFKNFAiTpG1GNkHSMl7GMJUXQJwGdSkThdz0pp8nTjs7iWbaQz1cS+uDWETcP8VEjEd18nqVDyS+j93vwGFUztL+ktFcB9o6e1ZL2tNDuq267QWlK7+/362Ya5U8CSB2/xXAinQ6mDoHvihwtqUwbw33/y0rxkzjK8SvIKxSuuoI41ijsnOt0WgJ2by/7Txh441sC6sq0rx7ac65D8M0bAauBcXHQ7nbbe1GVFdsX/wiOLG+J5m2z/Akj5pKm+ZpzuAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 09 26 15 04 06" title="" data-src="/static/2022-09-26-15-04-06-7f087bb66c838f08020f7f7ffb16d2e6-fee1c.png" data-srcset="/static/2022-09-26-15-04-06-7f087bb66c838f08020f7f7ffb16d2e6-a67b7.png 200w,\n/static/2022-09-26-15-04-06-7f087bb66c838f08020f7f7ffb16d2e6-0b187.png 400w,\n/static/2022-09-26-15-04-06-7f087bb66c838f08020f7f7ffb16d2e6-fee1c.png 800w,\n/static/2022-09-26-15-04-06-7f087bb66c838f08020f7f7ffb16d2e6-6cf8d.png 900w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>这样一来，整数对象需要在头部额外存储一些信息，记录对象用了多少个 32 位整数。这就是变长对象典型的结构，先有个大概印象即可，后续讲解整数对象源码时再展开。</p>\n<p>接着观察字符串对象：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32791622045173030000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> sys.getsizeof(\'a\')\n50\n>>> sys.getsizeof(\'abc\')\n52`, `32791622045173030000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> sys.getsizeof<span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">)</span>\n<span class="token number">50</span>\n<span class="token operator">>></span><span class="token operator">></span> sys.getsizeof<span class="token punctuation">(</span><span class="token string">\'abc\'</span><span class="token punctuation">)</span>\n<span class="token number">52</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-09-26-15-04-55-8a71f2afd1e7d2fd1f2ed9861baacdaf-6cf8d.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 70.44444444444444%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsSAAALEgHS3X78AAAB2klEQVQoz6XOX0/aUBgGcD/j5raL7W6JEsFkMVJvti9RiinS2okOt8i82GTIGLN0SltboECBWhBo5Y91UoK4RKrrdvB0yy6WSbInb9snPefX06kf/5EpcJ31O5LGlDpsqQsmDe6SnjL6bbhjvHrCyG24CobL64xhthws1j5jmZlAdh5Nz/pYl593o+JToZaEWKzt+aUZPDvv41wo68K4ObCZryYcLGlf8JznRfjJAn4fWX20sDyNHc6Cz0Ocb+4HJPfzV4+R1Yde4sEz7N6yMJdr0r9OVlNoyrPCeklxiRSWghzi23eLKu2cfMT4Djx4ejF4iBACssJ5UcbDK0kHV7TspzrFnkViZSIqB1ljK6lR4CXEip5PtcK8sR1XXsZKFGds72kbFS3nYFWT44V1pvo2Kq5FMyFQ4vL6kVaEWD7OvpcDCTUU4bEtDktUQ+8KeLEmOHgc+3Z+FxvW8aPcyMUUkm5sRjj/mwOUbm5+KBNyXfwD/y227eCPVYpuhHfL1G7ltiikXM9MihPHFKO/3ikEd4oEKHGVLDXuwjDDbxftr83uuX5qtk57rW7vpHOuXVwOJsIwlmUNh5eD/sDs9c2eCX/qbmyP8/3m5hp469oaWaOr0dWk+B/5CbZW3lUkMk5YAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 09 26 15 04 55" title="" data-src="/static/2022-09-26-15-04-55-8a71f2afd1e7d2fd1f2ed9861baacdaf-fee1c.png" data-srcset="/static/2022-09-26-15-04-55-8a71f2afd1e7d2fd1f2ed9861baacdaf-a67b7.png 200w,\n/static/2022-09-26-15-04-55-8a71f2afd1e7d2fd1f2ed9861baacdaf-0b187.png 400w,\n/static/2022-09-26-15-04-55-8a71f2afd1e7d2fd1f2ed9861baacdaf-fee1c.png 800w,\n/static/2022-09-26-15-04-55-8a71f2afd1e7d2fd1f2ed9861baacdaf-6cf8d.png 900w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>字符串对象也是变长对象，这个行为非常好理解，毕竟字符串长度不尽相同嘛。此外，注意到字符串对象大小比字符串本身大，因为对象同样需要维护一些额外的信息。至于具体需要维护哪些信息，同样留到源码剖析环节中详细介绍。</p>\n<p>那么，有啥对象是定长的呢——浮点数对象 float：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11728163272298820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> sys.getsizeof(1.)\n24\n>>> sys.getsizeof(1000000000000000000000000000000000.)\n24`, `11728163272298820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> sys.getsizeof<span class="token punctuation">(</span><span class="token number">1</span>.<span class="token punctuation">)</span>\n<span class="token number">24</span>\n<span class="token operator">>></span><span class="token operator">></span> sys.getsizeof<span class="token punctuation">(</span><span class="token number">1000000000000000000000000000000000</span>.<span class="token punctuation">)</span>\n<span class="token number">24</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>浮点数背后是由一个 double 实现，就算表示很大的数，浮点数对象的大小也不变。</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-09-26-15-05-08-6eb896c1bc58b81fae3e8a9f3afd2d8c-6cf8d.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 800px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 54.22222222222223%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAABm0lEQVQoz6WSS0/CQBSF+YUuTHTnxkdIRBCDuDRuiDFRwSDPYgUfkURjjKKANraCQIUibRFQiiBFQEWCxhXQFgda49bHyczNndz55pzFyDr/kAzs2luVYi9TFTxdxbu1glOlYPn1Qbzx/tGgS6FUOQJGvekV/RgqPN9KcPweWyXkEKU2RcfBshIqY3wEy+yLcJZNWhMKO6WyEAowNUcnzAn5IWmTYJoN2UjlrHtIbe6fgQfVxn5DeDRS8HSELpx7TMM3U3O7Q9PQgNYxoFjqW0SHz5iNDi86Mxd6TL4aVFkianN40hSc1AfG0KTkzBRTttiUPaqxxzRQXOMgtJaY8iAGSc53LIXknfjLni8DY8Xt8NMuWnKR+ZDonGezDr/OiSzA/nlQoROd83w+kDz6gh/oYwpGGfchsealXefZHW8KJpmw6Fwo5da9i1uIYeNUv42suHz6TWQZu/ZIMM/zLaBmi+O4drvd6h1AL8KCAAJ0Mwgdgec5ARSBA40E/0Tg0UbjrV6v12qvlXKl2Wz+AhYj9FJ0k35/kj/rE0+TOQq+UmcGAAAAAElFTkSuQmCC\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 09 26 15 05 08" title="" data-src="/static/2022-09-26-15-05-08-6eb896c1bc58b81fae3e8a9f3afd2d8c-fee1c.png" data-srcset="/static/2022-09-26-15-05-08-6eb896c1bc58b81fae3e8a9f3afd2d8c-a67b7.png 200w,\n/static/2022-09-26-15-05-08-6eb896c1bc58b81fae3e8a9f3afd2d8c-0b187.png 400w,\n/static/2022-09-26-15-05-08-6eb896c1bc58b81fae3e8a9f3afd2d8c-fee1c.png 800w,\n/static/2022-09-26-15-05-08-6eb896c1bc58b81fae3e8a9f3afd2d8c-6cf8d.png 900w" data-sizes="(max-width: 800px) 100vw, 800px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>为啥 64 位的 double 可以表示这么大的范围呢？答案是：牺牲了精度。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56721607381953110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> int(1000000000000000000000000000000000.)\n999999999999999945575230987042816`, `56721607381953110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> int<span class="token punctuation">(</span><span class="token number">1000000000000000000000000000000000</span>.<span class="token punctuation">)</span>\n<span class="token number">999999999999999945575230987042816</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>由于浮点数存储位数是固定的，它能表示的数值范围也是有限的，超出便会抛锚：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71155533295867880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> 10. ** 1000\nTraceback (most recent call last):\n   File &quot;<stdin>&quot;, line 1, in <module>\nOverflowError: (34, \'Result too large\')`, `71155533295867880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> <span class="token number">10</span>. ** <span class="token number">1000</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span>:\n   File <span class="token string">"&lt;stdin>"</span>, line <span class="token number">1</span>, <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\nOverflowError: <span class="token punctuation">(</span><span class="token number">34</span>, <span class="token string">\'Result too large\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>// TODO Python 源码剖析 <a href="https://fasionchan.com/python-source/object-model/pyobject/" target="_blank" rel="nofollow noreferrer noopener">https://fasionchan.com/python-source/object-model/pyobject/</a></p>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/Python源码剖析/index.md absPath of file >>> MarkdownRemark",timeToRead:7,frontmatter:{date:"2022-09-26 11:08:48",path:"/python-source-analysis/",tags:"后端, python, 读书笔记",title:"Python源码剖析",draft:null}},{excerpt:"版本一 版本二 工具 虚拟环境 对象自省 语法 异常 For - Else 三元运算符 Global Return open 函数  和  上下文管理器 // TODO  https://py.eastlakeside.cn/book/FunctionalProgramming/README.html",html:'<h1 id="版本一"><a href="#%E7%89%88%E6%9C%AC%E4%B8%80" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>版本一</h1>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61781922457361785000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# _*_ coding: utf-8 _*_\n\n&quot;&quot;&quot;类型和运算----类型和运算----类型和运算----类型和运算----类型和运算----类型和运算----类型和运算----类型和运算----类型和运算----类型和运算----类型和运算&quot;&quot;&quot;\n\n#-- 寻求帮助:\n    dir(obj)            # 简单的列出对象obj所包含的方法名称，返回一个字符串列表\n    help(obj.func)      # 查询obj.func的具体介绍和用法\n\n#-- 测试类型的三种方法，推荐第三种\n    if type(L) == type([]):\n        print(&quot;L is list&quot;)\n    if type(L) == list:\n        print(&quot;L is list&quot;)\n    if isinstance(L, list):\n        print(&quot;L is list&quot;)\n\n#-- Python数据类型：哈希类型、不可哈希类型\n    # 哈希类型，即在原地不能改变的变量类型，不可变类型。可利用hash函数查看其hash值，也可以作为字典的key\n    &quot;数字类型：int, float, decimal.Decimal, fractions.Fraction, complex&quot;\n    &quot;字符串类型：str, bytes&quot;\n    &quot;元组：tuple&quot;\n    &quot;冻结集合：frozenset&quot;\n    &quot;布尔类型：True, False&quot;\n    &quot;None&quot;\n    # 不可hash类型：原地可变类型：list、dict和set。它们不可以作为字典的key。\n\n#-- 数字常量\n    1234, -1234, 0, 999999999                    # 整数\n    1.23, 1., 3.14e-10, 4E210, 4.0e+210          # 浮点数\n    0o177, 0x9ff, 0X9FF, 0b101010                # 八进制、十六进制、二进制数字\n    3+4j, 3.0+4.0j, 3J                           # 复数常量，也可以用complex(real, image)来创建\n    hex(I), oct(I), bin(I)                       # 将十进制数转化为十六进制、八进制、二进制表示的“字符串”\n    int(string, base)                            # 将字符串转化为整数，base为进制数\n    # 2.x中，有两种整数类型：一般整数（32位）和长整数（无穷精度）。可以用l或L结尾，迫使一般整数成为长整数\n    float(\'inf\'), float(\'-inf\'), float(\'nan\')    # 无穷大, 无穷小, 非数\n\n#-- 数字的表达式操作符\n    yield x                                      # 生成器函数发送协议\n    lambda args: expression                      # 生成匿名函数\n    x if y else z                                # 三元选择表达式\n    x and y, x or y, not x                       # 逻辑与、逻辑或、逻辑非\n    x in y, x not in y                           # 成员对象测试\n    x is y, x is not y                           # 对象实体测试\n    x<y, x<=y, x>y, x>=y, x==y, x!=y             # 大小比较，集合子集或超集值相等性操作符\n    1 < a < 3                                    # Python中允许连续比较\n    x|y, x&y, x^y                                # 位或、位与、位异或\n    x<<y, x>>y                                   # 位操作：x左移、右移y位\n    +, -, *, /, //, %, **                        # 真除法、floor除法：返回不大于真除法结果的整数值、取余、幂运算\n    -x, +x, ~x                                   # 一元减法、识别、按位求补（取反）\n    x[i], x[i:j:k]                               # 索引、分片\n    int(3.14), float(3)                          # 强制类型转换\n\n#-- 整数可以利用bit_length函数测试所占的位数\n    a = 1;       a.bit_length()    # 1\n    a = 1024;    a.bit_length()    # 11\n\n#-- repr和str显示格式的区别\n    &quot;&quot;&quot;\n    repr格式：默认的交互模式回显，产生的结果看起来它们就像是代码。\n    str格式：打印语句，转化成一种对用户更加友好的格式。\n    &quot;&quot;&quot;\n\n#-- 数字相关的模块\n    # math模块\n    # Decimal模块：小数模块\n        import decimal\n        from decimal import Decimal\n        Decimal(&quot;0.01&quot;) + Decimal(&quot;0.02&quot;)        # 返回Decimal(&quot;0.03&quot;)\n        decimal.getcontext().prec = 4            # 设置全局精度为4 即小数点后边4位\n    # Fraction模块：分数模块\n        from fractions import Fraction\n        x = Fraction(4, 6)                       # 分数类型 4/6\n        x = Fraction(&quot;0.25&quot;)                     # 分数类型 1/4 接收字符串类型的参数\n\n#-- 集合set\n    &quot;&quot;&quot;\n    set是一个无序不重复元素集, 基本功能包括关系测试和消除重复元素。\n    set支持union(联合), intersection(交), difference(差)和symmetric difference(对称差集)等数学运算。\n    set支持x in set, len(set), for x in set。\n    set不记录元素位置或者插入点, 因此不支持indexing, slicing, 或其它类序列的操作\n    &quot;&quot;&quot;\n    s = set([3,5,9,10])                          # 创建一个数值集合，返回{3, 5, 9, 10}\n    t = set(&quot;Hello&quot;)                             # 创建一个字符的集合，返回{\'l\', \'H\', \'e\', \'o\'}\n    a = t | s;    t.union(s)                     # t 和 s的并集\n    b = t & s;    t.intersection(s)              # t 和 s的交集\n    c = t – s;    t.difference(s)                # 求差集（项在t中, 但不在s中）\n    d = t ^ s;    t.symmetric_difference(s)      # 对称差集（项在t或s中, 但不会同时出现在二者中）\n    t.add(\'x\');   t.remove(\'H\')                  # 增加/删除一个item\n    s.update([10,37,42])                         # 利用[......]更新s集合\n    x in s,  x not in s                          # 集合中是否存在某个值\n    s.issubset(t);      s <= t                   # 测试是否 s 中的每一个元素都在 t 中\n    s.issuperset(t);    s >= t                   # 测试是否 t 中的每一个元素都在 s 中\n    s.copy();\n    s.discard(x);                                # 删除s中x\n    s.clear()                                    # 清空s\n    {x**2 for x in [1, 2, 3, 4]}                 # 集合解析，结果：{16, 1, 4, 9}\n    {x for x in \'spam\'}                          # 集合解析，结果：{\'a\', \'p\', \'s\', \'m\'}\n\n#-- 集合frozenset，不可变对象\n    &quot;&quot;&quot;\n    set是可变对象，即不存在hash值，不能作为字典的键值。同样的还有list等(tuple是可以作为字典key的)\n    frozenset是不可变对象，即存在hash值，可作为字典的键值\n    frozenset对象没有add、remove等方法，但有union/intersection/difference等方法\n    &quot;&quot;&quot;\n    a = set([1, 2, 3])\n    b = set()\n    b.add(a)                     # error: set是不可哈希类型\n    b.add(frozenset(a))          # ok，将set变为frozenset，可哈希\n\n#-- 布尔类型bool\n    type(True)                   # 返回<class \'bool\'>\n    isinstance(False, int)       # bool类型属于整型，所以返回True\n    True == 1; True is 1         # 输出(True, False)\n\n#-- 动态类型简介\n    &quot;&quot;&quot;\n    变量名通过引用，指向对象。\n    Python中的“类型”属于对象，而不是变量，每个对象都包含有头部信息，比如&quot;类型标示符&quot; &quot;引用计数器&quot;等\n    &quot;&quot;&quot;\n    #共享引用及在原处修改：对于可变对象，要注意尽量不要共享引用！\n    #共享引用和相等测试：\n        L = [1], M = [1], L is M            # 返回False\n        L = M = [1, 2, 3], L is M           # 返回True，共享引用\n    #增强赋值和共享引用：普通+号会生成新的对象，而增强赋值+=会在原处修改\n        L = M = [1, 2]\n        L = L + [3, 4]                      # L = [1, 2, 3, 4], M = [1, 2]\n        L += [3, 4]                         # L = [1, 2, 3, 4], M = [1, 2, 3, 4]\n\n#-- 常见字符串常量和表达式\n    S = \'\'                                  # 空字符串\n    S = &quot;spam’s&quot;                            # 双引号和单引号相同\n    S = &quot;s\\np\\ta\\x00m&quot;                      # 转义字符\n    S = &quot;&quot;&quot;spam&quot;&quot;&quot;                          # 三重引号字符串，一般用于函数说明\n    S = r\'\\temp\'                            # Raw字符串，不会进行转义，抑制转义\n    S = b\'Spam\'                             # Python3中的字节字符串\n    S = u\'spam\'                             # Python2.6中的Unicode字符串\n    s1+s2, s1*3, s[i], s[i:j], len(s)       # 字符串操作\n    \'a %s parrot\' % \'kind\'                  # 字符串格式化表达式\n    \'a {1} {0} parrot\'.format(\'kind\', \'red\')# 字符串格式化方法\n    for x in s: print(x)                    # 字符串迭代，成员关系\n    [x*2 for x in s]                        # 字符串列表解析\n    \',\'.join([\'a\', \'b\', \'c\'])               # 字符串输出，结果：a,b,c\n\n#-- 内置str处理函数：\n    str1 = &quot;stringobject&quot;\n    str1.upper(); str1.lower(); str1.swapcase(); str1.capitalize(); str1.title()        # 全部大写，全部小写、大小写转换，首字母大写，每个单词的首字母都大写\n    str1.ljust(width)                       # 获取固定长度，左对齐，右边不够用空格补齐\n    str1.rjust(width)                       # 获取固定长度，右对齐，左边不够用空格补齐\n    str1.center(width)                      # 获取固定长度，中间对齐，两边不够用空格补齐\n    str1.zfill(width)                       # 获取固定长度，右对齐，左边不足用0补齐\n    str1.find(\'t\',start,end)                # 查找字符串，可以指定起始及结束位置搜索\n    str1.rfind(\'t\')                         # 从右边开始查找字符串\n    str1.count(\'t\')                         # 查找字符串出现的次数\n    #上面所有方法都可用index代替，不同的是使用index查找不到会抛异常，而find返回-1\n    str1.replace(\'old\',\'new\')               # 替换函数，替换old为new，参数中可以指定maxReplaceTimes，即替换指定次数的old为new\n    str1.strip();                           # 默认删除空白符\n    str1.strip(\'d\');                        # 删除str1字符串中开头、结尾处，位于 d 删除序列的字符\n    str1.lstrip();\n    str1.lstrip(\'d\');                       # 删除str1字符串中开头处，位于 d 删除序列的字符\n    str1.rstrip();\n    str1.rstrip(\'d\')                        # 删除str1字符串中结尾处，位于 d 删除序列的字符\n    str1.startswith(\'start\')                # 是否以start开头\n    str1.endswith(\'end\')                    # 是否以end结尾\n    str1.isalnum(); str1.isalpha(); str1.isdigit(); str1.islower(); str1.isupper()      # 判断字符串是否全为字符、数字、小写、大写\n\n#-- 三重引号编写多行字符串块，并且在代码折行处嵌入换行字符\\n\n    mantra = &quot;&quot;&quot;hello world\n            hello python\n            hello my friend&quot;&quot;&quot;\n    # mantra为&quot;&quot;&quot;hello world \\n hello python \\n hello my friend&quot;&quot;&quot;\n\n#-- 索引和分片：\n    S[0], S[len(S)–1], S[-1]                # 索引\n    S[1:3], S[1:], S[:-1], S[1:10:2]        # 分片，第三个参数指定步长，如\\`S[1:10:2]\\`是从1位到10位没隔2位获取一个字符。\n\n#-- 字符串转换工具：\n    int(\'42\'), str(42)                      # 返回(42, \'42\')\n    float(\'4.13\'), str(4.13)                # 返回(4.13, \'4.13\')\n    ord(\'s\'), chr(115)                      # 返回(115, \'s\')\n    int(\'1001\', 2)                          # 将字符串作为二进制数字，转化为数字，返回9\n    bin(13), oct(13), hex(13)               # 将整数转化为二进制/八进制/十六进制字符串，返回(\'0b1101\', \'015\', \'0xd\')\n\n#-- 另类字符串连接\n    name = &quot;wang&quot; &quot;hong&quot;                    # 单行，name = &quot;wanghong&quot;\n    name = &quot;wang&quot; \\\n            &quot;hong&quot;                          # 多行，name = &quot;wanghong&quot;\n\n#-- Python中的字符串格式化实现1--字符串格式化表达式\n    &quot;&quot;&quot;\n    基于C语言的\'print\'模型，并且在大多数的现有的语言中使用。\n    通用结构：%[(name)][flag][width].[precision]typecode\n    &quot;&quot;&quot;\n    &quot;this is %d %s bird&quot; % (1, \'dead\')                          # 一般的格式化表达式\n    &quot;%s---%s---%s&quot; % (42, 3.14, [1, 2, 3])                      # 字符串输出：\'42---3.14---[1, 2, 3]\'\n    &quot;%d...%6d...%-6d...%06d&quot; % (1234, 1234, 1234, 1234)         # 对齐方式及填充：&quot;1234...  1234...1234  ...001234&quot;\n    x = 1.23456789\n    &quot;%e | %f | %g&quot; % (x, x, x)                                  # 对齐方式：&quot;1.234568e+00 | 1.234568 | 1.23457&quot;\n    &quot;%6.2f*%-6.2f*%06.2f*%+6.2f&quot; % (x, x, x, x)                 # 对齐方式：\'  1.23*1.23  *001.23* +1.23\'\n    &quot;%(name1)d---%(name2)s&quot; % {&quot;name1&quot;:23, &quot;name2&quot;:&quot;value2&quot;}    # 基于字典的格式化表达式\n    &quot;%(name)s is %(age)d&quot; % vars()                              # vars()函数调用返回一个字典，包含了所有本函数调用时存在的变量\n\n#-- Python中的字符串格式化实现2--字符串格式化调用方法\n    # 普通调用\n    &quot;{0}, {1} and {2}&quot;.format(\'spam\', \'ham\', \'eggs\')            # 基于位置的调用\n    &quot;{motto} and {pork}&quot;.format(motto = \'spam\', pork = \'ham\')   # 基于Key的调用\n    &quot;{motto} and {0}&quot;.format(\'ham\', motto = \'spam\')             # 混合调用\n    # 添加键 属性 偏移量 (import sys)\n    &quot;my {1[spam]} runs {0.platform}&quot;.format(sys, {\'spam\':\'laptop\'})                 # 基于位置的键和属性\n    &quot;{config[spam]} {sys.platform}&quot;.format(sys = sys, config = {\'spam\':\'laptop\'})   # 基于Key的键和属性\n    &quot;first = {0[0]}, second = {0[1]}&quot;.format([\'A\', \'B\', \'C\'])                       # 基于位置的偏移量\n    # 具体格式化\n    &quot;{0:e}, {1:.3e}, {2:g}&quot;.format(3.14159, 3.14159, 3.14159)   # 输出\'3.141590e+00, 3.142e+00, 3.14159\'\n    &quot;{fieldname:format_spec}&quot;.format(......)\n    # 说明:\n    &quot;&quot;&quot;\n        fieldname是指定参数的一个数字或关键字, 后边可跟可选的&quot;.name&quot;或&quot;[index]&quot;成分引用\n        format_spec ::=  [[fill]align][sign][#][0][width][,][.precision][type]\n        fill        ::=  <any character>              #填充字符\n        align       ::=  &quot;<&quot; | &quot;>&quot; | &quot;=&quot; | &quot;^&quot;        #对齐方式\n        sign        ::=  &quot;+&quot; | &quot;-&quot; | &quot; &quot;              #符号说明\n        width       ::=  integer                      #字符串宽度\n        precision   ::=  integer                      #浮点数精度\n        type        ::=  &quot;b&quot; | &quot;c&quot; | &quot;d&quot; | &quot;e&quot; | &quot;E&quot; | &quot;f&quot; | &quot;F&quot; | &quot;g&quot; | &quot;G&quot; | &quot;n&quot; | &quot;o&quot; | &quot;s&quot; | &quot;x&quot; | &quot;X&quot; | &quot;%&quot;\n    &quot;&quot;&quot;\n    # 例子:\n        \'={0:10} = {1:10}\'.format(\'spam\', 123.456)    # 输出\'=spam       =    123.456\'\n        \'={0:>10}=\'.format(\'test\')                    # 输出\'=      test=\'\n        \'={0:<10}=\'.format(\'test\')                    # 输出\'=test      =\'\n        \'={0:^10}=\'.format(\'test\')                    # 输出\'=   test   =\'\n        \'{0:X}, {1:o}, {2:b}\'.format(255, 255, 255)   # 输出\'FF, 377, 11111111\'\n        \'My name is {0:{1}}.\'.format(\'Fred\', 8)       # 输出\'My name is Fred    .\'  动态指定参数\n\n#-- 常用列表常量和操作\n    L = [[1, 2], \'string\', {}]                        # 嵌套列表\n    L = list(\'spam\')                                  # 列表初始化\n    L = list(range(0, 4))                             # 列表初始化\n    list(map(ord, \'spam\'))                            # 列表解析\n    len(L)                                            # 求列表长度\n    L.count(value)                                    # 求列表中某个值的个数\n    L.append(obj)                                     # 向列表的尾部添加数据，比如append(2)，添加元素2\n    L.insert(index, obj)                              # 向列表的指定index位置添加数据，index及其之后的数据后移\n    L.extend(interable)                               # 通过添加iterable中的元素来扩展列表，比如extend([2])，添加元素2，注意和append的区别\n    L.index(value, [start, [stop]])                   # 返回列表中值value的第一个索引\n    L.pop([index])                                    # 删除并返回index处的元素，默认为删除并返回最后一个元素\n    L.remove(value)                                   # 删除列表中的value值，只删除第一次出现的value的值\n    L.reverse()                                       # 反转列表\n    L.sort(cmp=None, key=None, reverse=False)         # 排序列表\n    a = [1, 2, 3], b = a[10:]                         # 注意，这里不会引发IndexError异常，只会返回一个空的列表[]\n    a = [], a += [1]                                  # 这里实在原有列表的基础上进行操作，即列表的id没有改变\n    a = [], a = a + [1]                               # 这里最后的a要构建一个新的列表，即a的id发生了变化\n\n#-- 用切片来删除序列的某一段\n    a = [1, 2, 3, 4, 5, 6, 7]\n    a[1:4] = []                                       # a = [1, 5, 6, 7]\n    a = [0, 1, 2, 3, 4, 5, 6, 7]\n    del a[::2]                                        # 去除偶数项(偶数索引的)，a = [1, 3, 5, 7]\n\n#-- 常用字典常量和操作\n    D = {}\n    D = {\'spam\':2, \'tol\':{\'ham\':1}}                   # 嵌套字典\n    D = dict.fromkeys([\'s\', \'d\'], 8)                  # {\'s\': 8, \'d\': 8}\n    D = dict(name = \'tom\', age = 12)                  # {\'age\': 12, \'name\': \'tom\'}\n    D = dict([(\'name\', \'tom\'), (\'age\', 12)])          # {\'age\': 12, \'name\': \'tom\'}\n    D = dict(zip([\'name\', \'age\'], [\'tom\', 12]))       # {\'age\': 12, \'name\': \'tom\'}\n    D.keys(); D.values(); D.items()                   # 字典键、值以及键值对\n    D.get(key, default)                               # get函数\n    D.update(D_other)                                 # 合并字典，如果存在相同的键值，D_other的数据会覆盖掉D的数据\n    D.pop(key, [D])                                   # 删除字典中键值为key的项，返回键值为key的值，如果不存在，返回默认值D，否则异常\n    D.popitem()                                       # pop字典中随机的一项（一个键值对）\n    D.setdefault(k[, d])                              # 设置D中某一项的默认值。如果k存在，则返回D[k]，否则设置D[k]=d，同时返回D[k]。\n    del D                                             # 删除字典\n    del D[\'key\']                                      # 删除字典的某一项\n    if key in D:   if key not in D:                   # 测试字典键是否存在\n    # 字典注意事项：（1）对新索引赋值会添加一项（2）字典键不一定非得是字符串，也可以为任何的不可变对象\n    # 不可变对象：调用对象自身的任意方法，也不会改变该对象自身的内容，这些方法会创建新的对象并返回。\n    # 字符串、整数、tuple都是不可变对象，dict、set、list都是可变对象\n    D[(1,2,3)] = 2                                    # tuple作为字典的key\n\n#-- 字典解析\n    D = {k:8 for k in [\'s\', \'d\']}                     # {\'s\': 8, \'d\': 8}\n    D = {k:v for (k, v) in zip([\'name\', \'age\'], [\'tom\', 12])}       # {\'age\': 12, \'name\': tom}\n\n#-- 字典的特殊方法__missing__：当查找找不到key时，会执行该方法\n    class Dict(dict):\n        def __missing__(self, key):\n            self[key] = []\n            return self[key]\n    dct = dict()\n    dct[&quot;foo&quot;].append(1)    # 这有点类似于collections.defalutdict\n    dct[&quot;foo&quot;]              # [1]\n\n#-- 元组和列表的唯一区别在于元组是不可变对象，列表是可变对象\n    a = [1, 2, 3]           # a[1] = 0, OK\n    a = (1, 2, 3)           # a[1] = 0, Error\n    a = ([1, 2],)           # a[0][1] = 0, OK\n    a = [(1, 2)]            # a[0][1] = 0, Error\n\n#-- 元组的特殊语法: 逗号和圆括号\n    D = (12)                # 此时D为一个整数 即D = 12\n    D = (12, )              # 此时D为一个元组 即D = (12, )\n\n#-- 文件基本操作\n    output = open(r\'C:\\spam\', \'w\')          # 打开输出文件，用于写\n    input = open(\'data\', \'r\')               # 打开输入文件，用于读。打开的方式可以为\'w\', \'r\', \'a\', \'wb\', \'rb\', \'ab\'等\n    fp.read([size])                         # size为读取的长度，以byte为单位\n    fp.readline([size])                     # 读一行，如果定义了size，有可能返回的只是一行的一部分\n    fp.readlines([size])                    # 把文件每一行作为一个list的一个成员，并返回这个list。其实它的内部是通过循环调用readline()来实现的。如果提供size参数，size是表示读取内容的总长。\n    fp.readable()                           # 是否可读\n    fp.write(str)                           # 把str写到文件中，write()并不会在str后加上一个换行符\n    fp.writelines(seq)                      # 把seq的内容全部写到文件中(多行一次性写入)\n    fp.writeable()                          # 是否可写\n    fp.close()                              # 关闭文件。\n    fp.flush()                              # 把缓冲区的内容写入硬盘\n    fp.fileno()                             # 返回一个长整型的”文件标签“\n    fp.isatty()                             # 文件是否是一个终端设备文件（unix系统中的）\n    fp.tell()                               # 返回文件操作标记的当前位置，以文件的开头为原点\n    fp.next()                               # 返回下一行，并将文件操作标记位移到下一行。把一个file用于for … in file这样的语句时，就是调用next()函数来实现遍历的。\n    fp.seek(offset[,whence])                # 将文件打开操作标记移到offset的位置。whence为0表示从头开始计算，1表示以当前位置为原点计算。2表示以文件末尾为原点进行计算。\n    fp.seekable()                           # 是否可以seek\n    fp.truncate([size])                     # 把文件裁成规定的大小，默认的是裁到当前文件操作标记的位置。\n    for line in open(\'data\'):\n        print(line)                         # 使用for语句，比较适用于打开比较大的文件\n    with open(\'data\') as file:\n        print(file.readline())              # 使用with语句，可以保证文件关闭\n    with open(\'data\') as file:\n        lines = file.readlines()            # 一次读入文件所有行，并关闭文件\n    open(\'f.txt\', encoding = \'latin-1\')     # Python3.x Unicode文本文件\n    open(\'f.bin\', \'rb\')                     # Python3.x 二进制bytes文件\n    # 文件对象还有相应的属性：buffer closed encoding errors line_buffering name newlines等\n\n#-- 其他\n    # Python中的真假值含义：1. 数字如果非零，则为真，0为假。 2. 其他对象如果非空，则为真\n    # 通常意义下的类型分类：1. 数字、序列、映射。 2. 可变类型和不可变类型\n\n\n&quot;&quot;&quot;语法和语句----语法和语句----语法和语句----语法和语句----语法和语句----语法和语句----语法和语句----语法和语句----语法和语句----语法和语句----语法和语句&quot;&quot;&quot;\n\n#-- 赋值语句的形式\n    spam = \'spam\'                          # 基本形式\n    spam, ham = \'spam\', \'ham\'              # 元组赋值形式\n    [spam, ham] = [\'s\', \'h\']               # 列表赋值形式\n    a, b, c, d = \'abcd\'                    # 序列赋值形式\n    a, *b, c = \'spam\'                      # 序列解包形式（Python3.x中才有）\n    spam = ham = \'no\'                      # 多目标赋值运算，涉及到共享引用\n    spam += 42                             # 增强赋值，涉及到共享引用\n\n#-- 序列赋值 序列解包\n    [a, b, c] = (1, 2, 3)                  # a = 1, b = 2, c = 3\n    a, b, c, d = &quot;spam&quot;                    # a = \'s\', b = \'p\', c = \'a\', d = \'m\'\n    a, b, c = range(3)                     # a = 0, b = 1, c = 2\n    a, *b = [1, 2, 3, 4]                   # a = 1, b = [2, 3, 4]\n    *a, b = [1, 2, 3, 4]                   # a = [1, 2, 3], b = 4\n    a, *b, c = [1, 2, 3, 4]                # a = 1, b = [2, 3], c = 4\n    # 带有*时 会优先匹配*之外的变量 如\n    a, *b, c = [1, 2]                      # a = 1, c = 2, b = []\n\n#-- print函数原型\n    print(value, ..., sep=\' \', end=\'\\n\', file=sys.stdout, flush=False)\n    # 流的重定向\n    print(\'hello world\')                   # 等于sys.stdout.write(\'hello world\')\n    temp = sys.stdout                      # 原有流的保存\n    sys.stdout = open(\'log.log\', \'a\')      # 流的重定向\n    print(\'hello world\')                   # 写入到文件log.log\n    sys.stdout.close()\n    sys.stdout = temp                      # 原有流的复原\n\n#-- Python中and或or总是返回对象(左边的对象或右边的对象) 且具有短路求值的特性\n    1 or 2 or 3                            # 返回 1\n    1 and 2 and 3                          # 返回 3\n\n#-- if/else三元表达符（if语句在行内）\n    A = 1 if X else 2\n    A = 1 if X else (2 if Y else 3)\n    # 也可以使用and-or语句（一条语句实现多个if-else）\n    a = 6\n    result = (a > 20 and &quot;big than 20&quot; or a > 10 and &quot;big than 10&quot; or a > 5 and &quot;big than 5&quot;)    # 返回&quot;big than 5&quot;\n\n#-- Python的while语句或者for语句可以带else语句 当然也可以带continue/break/pass语句\n    while a > 1:\n        anything\n    else:\n        anything\n    # else语句会在循环结束后执行，除非在循环中执行了break，同样的还有for语句\n    for i in range(5):\n        anything\n    else:\n        anything\n\n#-- for循环的元组赋值\n    for (a, b) in [(1, 2), (3, 4)]:                   # 最简单的赋值\n    for ((a, b), c) in [((1, 2), 3), ((4, 5), 6)]:    # 自动解包赋值\n    for ((a, b), c) in [((1, 2), 3), (&quot;XY&quot;, 6)]:      # 自动解包 a = X, b = Y, c = 6\n    for (a, *b) in [(1, 2, 3), (4, 5, 6)]:            # 自动解包赋值\n\n#-- 列表解析语法\n    M = [[1,2,3], [4,5,6], [7,8,9]]\n    res = [sum(row) for row in M]                     # G = [6, 15, 24] 一般的列表解析 生成一个列表\n    res = [c * 2 for c in \'spam\']                     # [\'ss\', \'pp\', \'aa\', \'mm\']\n    res = [a * b for a in [1, 2] for b in [4, 5]]     # 多解析过程 返回[4, 5, 8, 10]\n    res = [a for a in [1, 2, 3] if a < 2]             # 带判断条件的解析过程\n    res = [a if a > 0 else 0 for a in [-1, 0, 1]]     # 带判断条件的高级解析过程\n    # 两个列表同时解析：使用zip函数\n    for teama, teamb in zip([&quot;Packers&quot;, &quot;49ers&quot;], [&quot;Ravens&quot;, &quot;Patriots&quot;]):\n        print(teama + &quot; vs. &quot; + teamb)\n    # 带索引的列表解析：使用enumerate函数\n    for index, team in enumerate([&quot;Packers&quot;, &quot;49ers&quot;, &quot;Ravens&quot;, &quot;Patriots&quot;]):\n        print(index, team)                            # 输出0, Packers \\n 1, 49ers \\n ......\n\n#-- 生成器表达式\n    G = (sum(row) for row in M)                       # 使用小括号可以创建所需结果的生成器generator object\n    next(G), next(G), next(G)                         # 输出(6, 15, 24)\n    G = {sum(row) for row in M}                       # G = {6, 15, 24} 解析语法还可以生成集合和字典\n    G = {i:sum(M[i]) for i in range(3)}               # G = {0: 6, 1: 15, 2: 24}\n\n#-- 文档字符串:出现在Module的开端以及其中函数或类的开端 使用三重引号字符串\n    &quot;&quot;&quot;\n    module document\n    &quot;&quot;&quot;\n    def func():\n        &quot;&quot;&quot;\n        function document\n        &quot;&quot;&quot;\n        print()\n    class Employee(object):\n        &quot;&quot;&quot;\n        class document\n        &quot;&quot;&quot;\n        print()\n    print(func.__doc__)                # 输出函数文档字符串\n    print(Employee.__doc__)            # 输出类的文档字符串\n\n#-- 命名惯例:\n    &quot;&quot;&quot;\n    以单一下划线开头的变量名(_X)不会被from module import*等语句导入\n    前后有两个下划线的变量名(__X__)是系统定义的变量名，对解释器有特殊意义\n    以两个下划线开头但不以下划线结尾的变量名(__X)是类的本地(私有)变量\n    &quot;&quot;&quot;\n\n#-- 列表解析 in成员关系测试 map sorted zip enumerate内置函数等都使用了迭代协议\n    \'first line\' in open(\'test.txt\')   # in测试 返回True或False\n    list(map(str.upper, open(\'t\')))    # map内置函数\n    sorted(iter([2, 5, 8, 3, 1]))      # sorted内置函数\n    list(zip([1, 2], [3, 4]))          # zip内置函数 [(1, 3), (2, 4)]\n\n#-- del语句: 手动删除某个变量\n    del X\n\n#-- 获取列表的子表的方法:\n    x = [1,2,3,4,5,6]\n    x[:3]                              # 前3个[1,2,3]\n    x[1:5]                             # 中间4个[2,3,4,5]\n    x[-3:]                             # 最后3个[4,5,6]\n    x[::2]                             # 奇数项[1,3,5]\n    x[1::2]                            # 偶数项[2,4,6]\n\n#-- 手动迭代：iter和next\n    L = [1, 2]\n    I = iter(L)                        # I为L的迭代器\n    I.next()                           # 返回1\n    I.next()                           # 返回2\n    I.next()                           # Error:StopIteration\n\n#-- Python中的可迭代对象\n    &quot;&quot;&quot;\n    1.range迭代器\n    2.map、zip和filter迭代器\n    3.字典视图迭代器：D.keys()), D.items()等\n    4.文件类型\n    &quot;&quot;&quot;\n\n\n&quot;&quot;&quot;函数语法规则----函数语法规则----函数语法规则----函数语法规则----函数语法规则----函数语法规则----函数语法规则----函数语法规则----函数语法规则----函数语法规则&quot;&quot;&quot;\n\n#-- 函数相关的语句和表达式\n    myfunc(\'spam\')                     # 函数调用\n    def myfunc():                      # 函数定义\n    return None                        # 函数返回值\n    global a                           # 全局变量\n    nonlocal x                         # 在函数或其他作用域中使用外层（非全局）变量\n    yield x                            # 生成器函数返回\n    lambda                             # 匿名函数\n\n#-- Python函数变量名解析:LEGB原则，即:\n    &quot;&quot;&quot;\n    local(functin) --> encloseing function locals --> global(module) --> build-in(python)\n    说明:以下边的函数maker为例 则相对于action而言 X为Local N为Encloseing\n    &quot;&quot;&quot;\n\n#-- 嵌套函数举例:工厂函数\n    def maker(N):\n        def action(X):\n            return X ** N\n        return action\n    f = maker(2)                       # pass 2 to N\n    f(3)                               # 9, pass 3 to X\n\n#-- 嵌套函数举例:lambda实例\n    def maker(N):\n        action = (lambda X: X**N)\n        return action\n    f = maker(2)                       # pass 2 to N\n    f(3)                               # 9, pass 3 to X\n\n#-- nonlocal和global语句的区别\n    # nonlocal应用于一个嵌套的函数的作用域中的一个名称 例如:\n    start = 100\n    def tester(start):\n        def nested(label):\n            nonlocal start             # 指定start为tester函数内的local变量 而不是global变量start\n            print(label, start)\n            start += 3\n        return nested\n    # global为全局的变量 即def之外的变量\n    def tester(start):\n        def nested(label):\n            global start               # 指定start为global变量start\n            print(label, start)\n            start += 3\n        return nested\n\n#-- 函数参数，不可变参数通过“值”传递，可变参数通过“引用”传递\n    def f(a, b, c): print(a, b, c)\n    f(1, 2, 3)                         # 参数位置匹配\n    f(1, c = 3, b = 2)                 # 参数关键字匹配\n    def f(a, b=1, c=2): print(a, b, c)\n    f(1)                               # 默认参数匹配\n    f(1, 2)                            # 默认参数匹配\n    f(a = 1, c = 3)                    # 关键字参数和默认参数的混合\n    # Keyword-Only参数:出现在*args之后 必须用关键字进行匹配\n    def keyOnly(a, *b, c): print(\'\')   # c就为keyword-only匹配 必须使用关键字c = value匹配\n    def keyOnly(a, *, b, c): ......    # b c为keyword-only匹配 必须使用关键字匹配\n    def keyOnly(a, *, b = 1): ......   # b有默认值 或者省略 或者使用关键字参数b = value\n\n#-- 可变参数匹配: * 和 **\n    def f(*args): print(args)          # 在元组中收集不匹配的位置参数\n    f(1, 2, 3)                         # 输出(1, 2, 3)\n    def f(**args): print(args)         # 在字典中收集不匹配的关键字参数\n    f(a = 1, b = 2)                    # 输出{\'a\':1, \'b\':2}\n    def f(a, *b, **c): print(a, b, c)  # 两者混合使用\n    f(1, 2, 3, x=4, y=5)               # 输出1, (2, 3), {\'x\':4, \'y\':5}\n\n#-- 函数调用时的参数解包: * 和 ** 分别解包元组和字典\n    func(1, *(2, 3))  <==>  func(1, 2, 3)\n    func(1, **{\'c\':3, \'b\':2})  <==>  func(1, b = 2, c = 3)\n    func(1, *(2, 3), **{\'c\':3, \'b\':2})  <==>  func(1, 2, 3, b = 2, c = 3)\n\n#-- 函数属性:(自己定义的)函数可以添加属性\n    def func():.....\n    func.count = 1                     # 自定义函数添加属性\n    print.count = 1                    # Error 内置函数不可以添加属性\n\n#-- 函数注解: 编写在def头部行 主要用于说明参数范围、参数类型、返回值类型等\n    def func(a:\'spam\', b:(1, 10), c:float) -> int :\n        print(a, b, c)\n    func.__annotations__               # {\'c\':<class \'float\'>, \'b\':(1, 10), \'a\':\'spam\', \'return\':<class \'int\'>}\n    # 编写注解的同时 还是可以使用函数默认值 并且注解的位置位于=号的前边\n    def func(a:\'spam\'=\'a\', b:(1, 10)=2, c:float=3) -> int :\n        print(a, b, c)\n\n#-- 匿名函数:lambda\n    f = lambda x, y, z : x + y + z     # 普通匿名函数，使用方法f(1, 2, 3)\n    f = lambda x = 1, y = 1: x + y     # 带默认参数的lambda函数\n    def action(x):                     # 嵌套lambda函数\n        return (lambda y : x + y)\n    f = lambda: a if xxx() else b      # 无参数的lambda函数，使用方法f()\n\n#-- lambda函数与map filter reduce函数的结合\n    list(map((lambda x: x + 1), [1, 2, 3]))              # [2, 3, 4]\n    list(filter((lambda x: x > 0), range(-4, 5)))        # [1, 2, 3, 4]\n    functools.reduce((lambda x, y: x + y), [1, 2, 3])    # 6\n    functools.reduce((lambda x, y: x * y), [2, 3, 4])    # 24\n\n#-- 生成器函数:yield VS return\n    def gensquare(N):\n        for i in range(N):\n            yield i** 2                # 状态挂起 可以恢复到此时的状态\n    for i in gensquare(5):             # 使用方法\n        print(i, end = \' \')            # [0, 1, 4, 9, 16]\n    x = gensquare(2)                   # x是一个生成对象\n    next(x)                            # 等同于x.__next__() 返回0\n    next(x)                            # 等同于x.__next__() 返回1\n    next(x)                            # 等同于x.__next__() 抛出异常StopIteration\n\n#-- 生成器表达式:小括号进行列表解析\n    G = (x ** 2 for x in range(3))     # 使用小括号可以创建所需结果的生成器generator object\n    next(G), next(G), next(G)          # 和上述中的生成器函数的返回值一致\n    #（1）生成器(生成器函数/生成器表达式)是单个迭代对象\n    G = (x ** 2 for x in range(4))\n    I1 = iter(G)                       # 这里实际上iter(G) = G\n    next(I1)                           # 输出0\n    next(G)                            # 输出1\n    next(I1)                           # 输出4\n    #（2）生成器不保留迭代后的结果\n    gen = (i for i in range(4))\n    2 in gen                           # 返回True\n    3 in gen                           # 返回True\n    1 in gen                           # 返回False，其实检测2的时候，1已经就不在生成器中了，即1已经被迭代过了，同理2、3也不在了\n\n#-- 本地变量是静态检测的\n    X = 22                             # 全局变量X的声明和定义\n    def test():\n        print(X)                       # 如果没有下一语句 则该句合法 打印全局变量X\n        X = 88                         # 这一语句使得上一语句非法 因为它使得X变成了本地变量 上一句变成了打印一个未定义的本地变量(局部变量)\n        if False:                      # 即使这样的语句 也会把print语句视为非法语句 因为:\n            X = 88                     # Python会无视if语句而仍然声明了局部变量X\n    def test():                        # 改进\n        global X                       # 声明变量X为全局变量\n        print(X)                       # 打印全局变量X\n        X = 88                         # 改变全局变量X\n\n#-- 函数的默认值是在函数定义的时候实例化的 而不是在调用的时候 例子:\n    def foo(numbers=[]):               # 这里的[]是可变的\n        numbers.append(9)\n        print(numbers)\n    foo()                              # first time, like before, [9]\n    foo()                              # second time, not like before, [9, 9]\n    foo()                              # third time, not like before too, [9, 9, 9]\n    # 改进:\n    def foo(numbers=None):\n        if numbers is None: numbers = []\n        numbers.append(9)\n        print(numbers)\n    # 另外一个例子 参数的默认值为不可变的:\n    def foo(count=0):                  # 这里的0是数字, 是不可变的\n        count += 1\n        print(count)\n    foo()                              # 输出1\n    foo()                              # 还是输出1\n    foo(3)                             # 输出4\n    foo()                              # 还是输出1\n\n\n&quot;&quot;&quot;函数例子----函数例子----函数例子----函数例子----函数例子----函数例子----函数例子----函数例子----函数例子----函数例子----函数例子----函数例子----函数例子&quot;&quot;&quot;\n\n    &quot;&quot;&quot;数学运算类&quot;&quot;&quot;\n    abs(x)                              # 求绝对值，参数可以是整型，也可以是复数，若参数是复数，则返回复数的模\n    complex([real[, imag]])             # 创建一个复数\n    divmod(a, b)                        # 分别取商和余数，注意：整型、浮点型都可以\n    float([x])                          # 将一个字符串或数转换为浮点数。如果无参数将返回0.0\n    int([x[, base]])                    # 将一个字符串或浮点数转换为int类型，base表示进制\n    long([x[, base]])                   # 将一个字符串或浮点数转换为long类型\n    pow(x, y)                           # 返回x的y次幂\n    range([start], stop[, step])        # 产生一个序列，默认从0开始\n    round(x[, n])                       # 四舍五入\n    sum(iterable[, start])              # 对集合求和\n    oct(x)                              # 将一个数字转化为8进制字符串\n    hex(x)                              # 将一个数字转换为16进制字符串\n    chr(i)                              # 返回给定int类型对应的ASCII字符\n    unichr(i)                           # 返回给定int类型的unicode\n    ord(c)                              # 返回ASCII字符对应的整数\n    bin(x)                              # 将整数x转换为二进制字符串\n    bool([x])                           # 将x转换为Boolean类型\n\n    &quot;&quot;&quot;集合类操作&quot;&quot;&quot;\n    basestring()                        # str和unicode的超类，不能直接调用，可以用作isinstance判断\n    format(value [, format_spec])       # 格式化输出字符串，格式化的参数顺序从0开始，如“I am {0},I like {1}”\n    enumerate(sequence[, start=0])      # 返回一个可枚举的对象，注意它有第二个参数\n    iter(obj[, sentinel])               # 生成一个对象的迭代器，第二个参数表示分隔符\n    max(iterable[, args...][key])       # 返回集合中的最大值\n    min(iterable[, args...][key])       # 返回集合中的最小值\n    dict([arg])                         # 创建数据字典\n    list([iterable])                    # 将一个集合类转换为另外一个集合类\n    set()                               # set对象实例化\n    frozenset([iterable])               # 产生一个不可变的set\n    tuple([iterable])                   # 生成一个tuple类型\n    str([object])                       # 转换为string类型\n    sorted(iterable[, cmp[, key[, reverse]]])             # 集合排序\n        L = [(\'b\',2),(\'a\',1),(\'c\',3),(\'d\',4)]\n        sorted(L, key=lambda x: x[1], reverse=True)       # 使用Key参数和reverse参数\n        sorted(L, key=lambda x: (x[0], x[1]))             # 使用key参数进行多条件排序，即如果x[0]相同，则比较x[1]\n\n    &quot;&quot;&quot;逻辑判断&quot;&quot;&quot;\n    all(iterable)                       # 集合中的元素都为真的时候为真，特别的，若为空串返回为True\n    any(iterable)                       # 集合中的元素有一个为真的时候为真，特别的，若为空串返回为False\n    cmp(x, y)                           # 如果x < y ,返回负数；x == y, 返回0；x > y,返回正数\n\n    &quot;&quot;&quot;IO操作&quot;&quot;&quot;\n    file(filename [, mode [, bufsize]]) # file类型的构造函数。\n    input([prompt])                     # 获取用户输入，推荐使用raw_input，因为该函数将不会捕获用户的错误输入，意思是自行判断类型\n    # 在 Built-in Functions 里有一句话是这样写的：Consider using the raw_input() function for general input from users.\n    raw_input([prompt])                 # 设置输入，输入都是作为字符串处理\n    open(name[, mode[, buffering]])     # 打开文件，与file有什么不同？推荐使用open\n\n    &quot;&quot;&quot;其他&quot;&quot;&quot;\n    callable(object)                    # 检查对象object是否可调用\n    classmethod(func)                   # 用来说明这个func是个类方法\n    staticmethod(func)                  # 用来说明这个func为静态方法\n    dir([object])                       # 不带参数时，返回当前范围内的变量、方法和定义的类型列表；带参数时，返回参数的属性、方法列表。\n    help(obj)                           # 返回obj的帮助信息\n    eval(expression)                    # 计算表达式expression的值，并返回\n    exec(str)                           # 将str作为Python语句执行\n    execfile(filename)                  # 用法类似exec()，不同的是execfile的参数filename为文件名，而exec的参数为字符串。\n    filter(function, iterable)          # 构造一个序列，等价于[item for item in iterable if function(item)]，function返回值为True或False的函数\n        list(filter(bool, range(-3, 4)))# 返回[-3, -2, -1, 1, 2, 3], 没有0\n    hasattr(object, name)               # 判断对象object是否包含名为name的特性\n    getattr(object, name [, defalut])   # 获取一个类的属性\n    setattr(object, name, value)        # 设置属性值\n    delattr(object, name)               # 删除object对象名为name的属性\n    globals()                           # 返回一个描述当前全局符号表的字典\n    hash(object)                        # 如果对象object为哈希表类型，返回对象object的哈希值\n    id(object)                          # 返回对象的唯一标识，一串数字\n    isinstance(object, classinfo)       # 判断object是否是class的实例\n        isinstance(1, int)              # 判断是不是int类型\n        isinstance(1, (int, float))     # isinstance的第二个参数接受一个元组类型\n    issubclass(class, classinfo)        # 判断class是否为classinfo的子类\n    locals()                            # 返回当前的变量列表\n    map(function, iterable, ...)        # 遍历每个元素，执行function操作\n        list(map(abs, range(-3, 4)))    # 返回[3, 2, 1, 0, 1, 2, 3]\n    next(iterator[, default])           # 类似于iterator.next()\n    property([fget[, fset[, fdel[, doc]]]])           # 属性访问的包装类，设置后可以通过c.x=value等来访问setter和getter\n    reduce(function, iterable[, initializer])         # 合并操作，从第一个开始是前两个参数，然后是前两个的结果与第三个合并进行处理，以此类推\n        def add(x,y):return x + y\n        reduce(add, range(1, 11))                     # 返回55 (注:1+2+3+4+5+6+7+8+9+10 = 55)\n        reduce(add, range(1, 11), 20)                 # 返回75\n    reload(module)                      # 重新加载模块\n    repr(object)                        # 将一个对象变幻为可打印的格式\n    slice(start, stop[, step])          # 产生分片对象\n    type(object)                        # 返回该object的类型\n    vars([object])                      # 返回对象的变量名、变量值的字典\n        a = Class();                    # Class为一个空类\n        a.name = \'qi\', a.age = 9\n        vars(a)                         # {\'name\':\'qi\', \'age\':9}\n    zip([iterable, ...])                # 返回对应数组\n        list(zip([1, 2, 3], [4, 5, 6])) # [(1, 4), (2, 5), (3, 6)]\n        a = [1, 2, 3],  b = [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]\n        z = zip(a, b)                   # 压缩：[(1, &quot;a&quot;), (2, &quot;b&quot;), (3, &quot;c&quot;)]\n        zip(*z)                         # 解压缩：[(1, 2, 3), (&quot;a&quot;, &quot;b&quot;, &quot;c&quot;)]\n    unicode(string, encoding, errors)   # 将字符串string转化为unicode形式，string为encoded string。\n\n\n&quot;&quot;&quot;模块Moudle----模块Moudle----模块Moudle----模块Moudle----模块Moudle----模块Moudle----模块Moudle----模块Moudle----模块Moudle----模块Moudle----模块Moudle&quot;&quot;&quot;\n\n#-- Python模块搜索路径:\n    &quot;&quot;&quot;\n    (1)程序的主目录    (2)PYTHONPATH目录 (3)标准链接库目录 (4)任何.pth文件的内容\n    &quot;&quot;&quot;\n\n#-- 查看全部的模块搜索路径\n    import sys\n    sys.path\n    sys.argv                            # 获得脚本的参数\n    sys.builtin_module_names            # 查找内建模块\n    sys.platform                        # 返回当前平台 出现如： &quot;win32&quot; &quot;linux&quot; &quot;darwin&quot;等\n    sys.modules                         # 查找已导入的模块\n    sys.modules.keys()\n    sys.stdout                          # stdout 和 stderr 都是类文件对象，但是它们都是只写的。它们都没有 read 方法，只有 write 方法\n    sys.stdout.write(&quot;hello&quot;)\n    sys.stderr\n    sys.stdin\n\n#-- 模块的使用代码\n    import module1, module2             # 导入module1 使用module1.printer()\n    from module1 import printer         # 导入module1中的printer变量 使用printer()\n    from module1 import *               # 导入module1中的全部变量 使用不必添加module1前缀\n\n#-- 重载模块reload: 这是一个内置函数 而不是一条语句\n    from imp import reload\n    reload(module)\n\n#-- 模块的包导入:使用点号(.)而不是路径(dir1\\dir2)进行导入\n    import dir1.dir2.mod                # d导入包(目录)dir1中的包dir2中的mod模块 此时dir1必须在Python可搜索路径中\n    from dir1.dir2.mod import *         # from语法的包导入\n\n#-- __init__.py包文件:每个导入的包中都应该包含这么一个文件\n    &quot;&quot;&quot;\n    该文件可以为空\n    首次进行包导入时 该文件会自动执行\n    高级功能:在该文件中使用__all__列表来定义包(目录)以from*的形式导入时 需要导入什么\n    &quot;&quot;&quot;\n\n#-- 包相对导入:使用点号(.) 只能使用from语句\n    from . import spam                  # 导入当前目录下的spam模块（Python2: 当前目录下的模块, 直接导入即可）\n    from .spam import name              # 导入当前目录下的spam模块的name属性（Python2: 当前目录下的模块, 直接导入即可，不用加.）\n    from .. import spam                 # 导入当前目录的父目录下的spam模块\n\n#-- 包相对导入与普通导入的区别\n    from string import *                # 这里导入的string模块为sys.path路径上的 而不是本目录下的string模块(如果存在也不是)\n    from .string import *               # 这里导入的string模块为本目录下的(不存在则导入失败) 而不是sys.path路径上的\n\n#-- 模块数据隐藏:最小化from*的破坏\n    _X                                  # 变量名前加下划线可以防止from*导入时该变量名被复制出去\n    __all__ = [\'x\', \'x1\', \'x2\']         # 使用__all__列表指定from*时复制出去的变量名(变量名在列表中为字符串形式)\n\n#-- 可以使用__name__进行模块的单元测试:当模块为顶层执行文件时值为\'__main__\' 当模块被导入时为模块名\n    if __name__ == \'__main__\':\n        doSomething\n    # 模块属性中还有其他属性，例如：\n    __doc__                             # 模块的说明文档\n    __file__                            # 模块文件的文件名，包括全路径\n    __name__                            # 主文件或者被导入文件\n    __package__                         # 模块所在的包\n\n#-- import语句from语句的as扩展\n    import modulename as name\n    from modulename import attrname as name\n\n#-- 得到模块属性的几种方法 假设为了得到name属性的值\n    M.name\n    M.__dict__[\'name\']\n    sys.modules[\'M\'].name\n    getattr(M, \'name\')\n\n\n&quot;&quot;&quot;类与面向对象----类与面向对象----类与面向对象----类与面向对象----类与面向对象----类与面向对象----类与面向对象----类与面向对象----类与面向对象----类与面向对象&quot;&quot;&quot;\n\n#-- 最普通的类\n    class C1(C2, C3):\n        spam = 42                       # 数据属性\n        def __init__(self, name):       # 函数属性:构造函数\n            self.name = name\n        def __del__(self):              # 函数属性:析构函数\n            print(&quot;goodbey &quot;, self.name)\n    I1 = C1(\'bob\')\n\n#-- Python的类没有基于参数的函数重载\n    class FirstClass(object):\n        def test(self, string):\n            print(string)\n        def test(self):                 # 此时类中只有一个test函数 即后者test(self) 它覆盖掉前者带参数的test函数\n            print(&quot;hello world&quot;)\n\n#-- 子类扩展超类: 尽量调用超类的方法\n    class Manager(Person):\n        def giveRaise(self, percent, bonus = .10):\n            self.pay = int(self.pay*(1 + percent + bonus))     # 不好的方式 复制粘贴超类代码\n            Person.giveRaise(self, percent + bonus)            # 好的方式 尽量调用超类方法\n\n#-- 类内省工具\n    bob = Person(\'bob\')\n    bob.__class__                       # <class \'Person\'>\n    bob.__class__.__name__              # \'Person\'\n    bob.__dict__                        # {\'pay\':0, \'name\':\'bob\', \'job\':\'Manager\'}\n\n#-- 返回1中 数据属性spam是属于类 而不是对象\n    I1 = C1(\'bob\'); I2 = C2(\'tom\')      # 此时I1和I2的spam都为42 但是都是返回的C1的spam属性\n    C1.spam = 24                        # 此时I1和I2的spam都为24\n    I1.spam = 3                         # 此时I1新增自有属性spam 值为3 I2和C1的spam还都为24\n\n#-- 类方法调用的两种方式\n    instance.method(arg...)\n    class.method(instance, arg...)\n\n#-- 抽象超类的实现方法\n    # (1)某个函数中调用未定义的函数 子类中定义该函数\n        def delegate(self):\n            self.action()               # 本类中不定义action函数 所以使用delegate函数时就会出错\n    # (2)定义action函数 但是返回异常\n        def action(self):\n            raise NotImplementedError(&quot;action must be defined&quot;)\n    # (3)上述的两种方法还都可以定义实例对象 实际上可以利用@装饰器语法生成不能定义的抽象超类\n        from abc import ABCMeta, abstractmethod\n        class Super(metaclass = ABCMeta):\n            @abstractmethod\n            def action(self): pass\n        x = Super()                     # 返回 TypeError: Can\'t instantiate abstract class Super with abstract methods action\n\n#-- # OOP和继承: &quot;is-a&quot;的关系\n    class A(B):\n        pass\n    a = A()\n    isinstance(a, B)                    # 返回True, A是B的子类 a也是B的一种\n    # OOP和组合: &quot;has-a&quot;的关系\n    pass\n    # OOP和委托: &quot;包装&quot;对象 在Python中委托通常是以&quot;__getattr__&quot;钩子方法实现的, 这个方法会拦截对不存在属性的读取\n    # 包装类(或者称为代理类)可以使用__getattr__把任意读取转发给被包装的对象\n    class wrapper(object):\n        def __init__(self, object):\n            self.wrapped = object\n        def __getattr(self, attrname):\n            print(\'Trace: \', attrname)\n            return getattr(self.wrapped, attrname)\n    # 注:这里使用getattr(X, N)内置函数以变量名字符串N从包装对象X中取出属性 类似于X.__dict__[N]\n    x = wrapper([1, 2, 3])\n    x.append(4)                         # 返回 &quot;Trace: append&quot; [1, 2, 3, 4]\n    x = wrapper({\'a\':1, \'b\':2})\n    list(x.keys())                      # 返回 &quot;Trace: keys&quot; [\'a\', \'b\']\n\n#-- 类的伪私有属性:使用__attr\n    class C1(object):\n        def __init__(self, name):\n            self.__name = name          # 此时类的__name属性为伪私有属性 原理 它会自动变成self._C1__name = name\n        def __str__(self):\n            return \'self.name = %s\' % self.__name\n    I = C1(\'tom\')\n    print(I)                            # 返回 self.name = tom\n    I.__name = \'jeey\'                   # 这里无法访问 __name为伪私有属性\n    I._C1__name = \'jeey\'                # 这里可以修改成功 self.name = jeey\n\n#-- 类方法是对象:无绑定类方法对象 / 绑定实例方法对象\n    class Spam(object):\n        def doit(self, message):\n            print(message)\n        def selfless(message)\n            print(message)\n    obj = Spam()\n    x = obj.doit                        # 类的绑定方法对象 实例 + 函数\n    x(\'hello world\')\n    x = Spam.doit                       # 类的无绑定方法对象 类名 + 函数\n    x(obj, \'hello world\')\n    x = Spam.selfless                   # 类的无绑定方法函数 在3.0之前无效\n    x(\'hello world\')\n\n#-- 获取对象信息: 属性和方法\n    a = MyObject()\n    dir(a)                              # 使用dir函数\n    hasattr(a, \'x\')                     # 测试是否有x属性或方法 即a.x是否已经存在\n    setattr(a, \'y\', 19)                 # 设置属性或方法 等同于a.y = 19\n    getattr(a, \'z\', 0)                  # 获取属性或方法 如果属性不存在 则返回默认值0\n    #这里有个小技巧，setattr可以设置一个不能访问到的属性，即只能用getattr获取\n    setattr(a, &quot;can\'t touch&quot;, 100)      # 这里的属性名带有空格，不能直接访问\n    getattr(a, &quot;can\'t touch&quot;, 0)        # 但是可以用getattr获取\n\n#-- 为类动态绑定属性或方法: MethodType方法\n    # 一般创建了一个class的实例后, 可以给该实例绑定任何属性和方法, 这就是动态语言的灵活性\n    class Student(object):\n        pass\n    s = Student()\n    s.name = \'Michael\'                  # 动态给实例绑定一个属性\n    def set_age(self, age):             # 定义一个函数作为实例方法\n        self.age = age\n    from types import MethodType\n    s.set_age = MethodType(set_age, s)  # 给实例绑定一个方法 类的其他实例不受此影响\n    s.set_age(25)                       # 调用实例方法\n    Student.set_age = MethodType(set_age, Student)    # 为类绑定一个方法 类的所有实例都拥有该方法\n\n\n&quot;&quot;&quot;类的高级话题----类的高级话题----类的高级话题----类的高级话题----类的高级话题----类的高级话题----类的高级话题----类的高级话题----类的高级话题----类的高级话题&quot;&quot;&quot;\n\n#-- 多重继承: &quot;混合类&quot;, 搜索方式&quot;从下到上 从左到右 广度优先&quot;\n    class A(B, C):\n        pass\n\n#-- 类的继承和子类的初始化\n    # 1.子类定义了__init__方法时，若未显示调用基类__init__方法，python不会帮你调用。\n    # 2.子类未定义__init__方法时，python会自动帮你调用首个基类的__init__方法，注意是首个。\n    # 3.子类显示调用基类的初始化函数：\n    class FooParent(object):\n        def __init__(self, a):\n            self.parent = \'I\\\'m the Parent.\'\n            print(\'Parent:a=\' + str(a))\n        def bar(self, message):\n            print(message + \' from Parent\')\n    class FooChild(FooParent):\n        def __init__(self, a):\n            FooParent.__init__(self, a)\n            print(\'Child:a=\' + str(a))\n        def bar(self, message):\n            FooParent.bar(self, message)\n            print(message + \' from Child\')\n    fooChild = FooChild(10)\n    fooChild.bar(\'HelloWorld\')\n\n#-- #实例方法 / 静态方法 / 类方法\n    class Methods(object):\n        def imeth(self, x): print(self, x)      # 实例方法：传入的是实例和数据，操作的是实例的属性\n        def smeth(x): print(x)                  # 静态方法：只传入数据 不传入实例，操作的是类的属性而不是实例的属性\n        def cmeth(cls, x): print(cls, x)        # 类方法：传入的是类对象和数据\n        smeth = staticmethod(smeth)             # 调用内置函数，也可以使用@staticmethod\n        cmeth = classmethod(cmeth)              # 调用内置函数，也可以使用@classmethod\n    obj = Methods()\n    obj.imeth(1)                                # 实例方法调用 <__main__.Methods object...> 1\n    Methods.imeth(obj, 2)                       # <__main__.Methods object...> 2\n    Methods.smeth(3)                            # 静态方法调用 3\n    obj.smeth(4)                                # 这里可以使用实例进行调用\n    Methods.cmeth(5)                            # 类方法调用 <class \'__main__.Methods\'> 5\n    obj.cmeth(6)                                # <class \'__main__.Methods\'> 6\n\n#-- 函数装饰器:是它后边的函数的运行时的声明 由@符号以及后边紧跟的&quot;元函数&quot;(metafunction)组成\n        @staticmethod\n        def smeth(x): print(x)\n    # 等同于:\n        def smeth(x): print(x)\n        smeth = staticmethod(smeth)\n    # 同理\n        @classmethod\n        def cmeth(cls, x): print(x)\n    # 等同于\n        def cmeth(cls, x): print(x)\n        cmeth = classmethod(cmeth)\n\n#-- 类修饰器:是它后边的类的运行时的声明 由@符号以及后边紧跟的&quot;元函数&quot;(metafunction)组成\n        def decorator(aClass):.....\n        @decorator\n        class C(object):....\n    # 等同于:\n        class C(object):....\n        C = decorator(C)\n\n#-- 限制class属性: __slots__属性\n    class Student(object):\n        __slots__ = (\'name\', \'age\')             # 限制Student及其实例只能拥有name和age属性\n    # __slots__属性只对当前类起作用, 对其子类不起作用\n    # __slots__属性能够节省内存\n    # __slots__属性可以为列表list，或者元组tuple\n\n#-- 类属性高级话题: @property\n    # 假设定义了一个类:C，该类必须继承自object类，有一私有变量_x\n    class C(object):\n        def __init__(self):\n            self.__x = None\n    # 第一种使用属性的方法\n        def getx(self):\n            return self.__x\n        def setx(self, value):\n            self.__x = value\n        def delx(self):\n            del self.__x\n        x = property(getx, setx, delx, \'\')\n    # property函数原型为property(fget=None,fset=None,fdel=None,doc=None)\n    # 使用\n    c = C()\n    c.x = 100                         # 自动调用setx方法\n    y = c.x                           # 自动调用getx方法\n    del c.x                           # 自动调用delx方法\n    # 第二种方法使用属性的方法\n        @property\n        def x(self):\n            return self.__x\n        @x.setter\n        def x(self, value):\n           self.__x = value\n        @x.deleter\n        def x(self):\n           del self.__x\n    # 使用\n    c = C()\n    c.x = 100                         # 自动调用setter方法\n    y = c.x                           # 自动调用x方法\n    del c.x                           # 自动调用deleter方法\n\n#-- 定制类: 重写类的方法\n    # (1)__str__方法、__repr__方法: 定制类的输出字符串\n    # (2)__iter__方法、next方法: 定制类的可迭代性\n    class Fib(object):\n        def __init__(self):\n            self.a, self.b = 0, 1     # 初始化两个计数器a，b\n        def __iter__(self):\n            return self               # 实例本身就是迭代对象，故返回自己\n        def next(self):\n            self.a, self.b = self.b, self.a + self.b\n            if self.a > 100000:       # 退出循环的条件\n                raise StopIteration()\n            return self.a             # 返回下一个值\n    for n in Fib():\n        print(n)                      # 使用\n    # (3)__getitem__方法、__setitem__方法: 定制类的下标操作[] 或者切片操作slice\n    class Indexer(object):\n        def __init__(self):\n            self.data = {}\n        def __getitem__(self, n):             # 定义getitem方法\n            print(\'getitem:\', n)\n            return self.data[n]\n        def __setitem__(self, key, value):    # 定义setitem方法\n            print(\'setitem:key = {0}, value = {1}\'.format(key, value))\n            self.data[key] = value\n    test = Indexer()\n    test[0] = 1;   test[3] = \'3\'              # 调用setitem方法\n    print(test[0])                            # 调用getitem方法\n    # (4)__getattr__方法: 定制类的属性操作\n    class Student(object):\n        def __getattr__(self, attr):          # 定义当获取类的属性时的返回值\n            if attr==\'age\':\n                return 25                     # 当获取age属性时返回25\n        raise AttributeError(\'object has no attribute: %s\' % attr)\n        # 注意: 只有当属性不存在时 才会调用该方法 且该方法默认返回None 需要在函数最后引发异常\n    s = Student()\n    s.age                                     # s中age属性不存在 故调用__getattr__方法 返回25\n    # (5)__call__方法: 定制类的\'可调用\'性\n    class Student(object):\n        def __call__(self):                   # 也可以带参数\n            print(\'Calling......\')\n    s = Student()\n    s()                                       # s变成了可调用的 也可以带参数\n    callable(s)                               # 测试s的可调用性 返回True\n    #    (6)__len__方法：求类的长度\n    def __len__(self):\n        return len(self.data)\n\n#-- 动态创建类type()\n    # 一般创建类 需要在代码中提前定义\n        class Hello(object):\n            def hello(self, name=\'world\'):\n                print(\'Hello, %s.\' % name)\n        h = Hello()\n        h.hello()                             # Hello, world\n        type(Hello)                           # Hello是一个type类型 返回<class \'type\'>\n        type(h)                               # h是一个Hello类型 返回<class \'Hello\'>\n    # 动态类型语言中 类可以动态创建 type函数可用于创建新类型\n        def fn(self, name=\'world\'):           # 先定义函数\n            print(\'Hello, %s.\' % name)\n        Hello = type(\'Hello\', (object,), dict(hello=fn))    # 创建Hello类 type原型: type(name, bases, dict)\n        h = Hello()                           # 此时的h和上边的h一致\n\n\n&quot;&quot;&quot;异常相关----异常相关----异常相关----异常相关----异常相关----异常相关----异常相关----异常相关----异常相关----异常相关----异常相关----异常相关----异常相关&quot;&quot;&quot;\n\n#-- #捕获异常:\n        try:\n        except:                               # 捕获所有的异常 等同于except Exception:\n        except name:                          # 捕获指定的异常\n        except name, value:                   # 捕获指定的异常和额外的数据(实例)\n        except (name1, name2):\n        except (name1, name2), value:\n        except name4 as X:\n        else:                                 # 如果没有发生异常\n        finally:                              # 总会执行的部分\n    # 引发异常: raise子句(raise IndexError)\n        raise <instance>                      # raise instance of a class, raise IndexError()\n        raise <class>                         # make and raise instance of a class, raise IndexError\n        raise                                 # reraise the most recent exception\n\n#-- Python3.x中的异常链: raise exception from otherException\n    except Exception as X:\n        raise IndexError(\'Bad\') from X\n\n#-- assert子句: assert <test>, <data>\n    assert x < 0, \'x must be negative\'\n\n#-- with/as环境管理器:作为常见的try/finally用法模式的替代方案\n    with expression [as variable], expression [as variable]:\n    # 例子:\n        with open(\'test.txt\') as myfile:\n            for line in myfile: print(line)\n    # 等同于:\n        myfile = open(\'test.txt\')\n        try:\n            for line in myfile: print(line)\n        finally:\n            myfile.close()\n\n#-- 用户自定义异常: class Bad(Exception):.....\n    &quot;&quot;&quot;\n    Exception超类 / except基类即可捕获到其所有子类\n    Exception超类有默认的打印消息和状态 当然也可以定制打印显示:\n    &quot;&quot;&quot;\n    class MyBad(Exception):\n        def __str__(self):\n            return \'定制的打印消息\'\n    try:\n        MyBad()\n    except MyBad as x:\n        print(x)\n\n#-- 用户定制异常数据\n    class FormatError(Exception):\n        def __init__(self, line ,file):\n            self.line = line\n            self.file = file\n    try:\n        raise FormatError(42, \'test.py\')\n    except FormatError as X:\n        print(\'Error at \', X.file, X.line)\n    # 用户定制异常行为(方法):以记录日志为例\n    class FormatError(Exception):\n        logfile = \'formaterror.txt\'\n        def __init__(self, line ,file):\n            self.line = line\n            self.file = file\n        def logger(self):\n            open(self.logfile, \'a\').write(\'Error at \', self.file, self.line)\n    try:\n        raise FormatError(42, \'test.py\')\n    except FormatError as X:\n        X.logger()\n\n#-- 关于sys.exc_info:允许一个异常处理器获取对最近引发的异常的访问\n    try:\n        ......\n    except:\n        # 此时sys.exc_info()返回一个元组(type, value, traceback)\n        # type:正在处理的异常的异常类型\n        # value:引发的异常的实例\n        # traceback:堆栈信息\n\n#-- 异常层次\n    BaseException\n    +-- SystemExit\n    +-- KeyboardInterrupt\n    +-- GeneratorExit\n    +-- Exception\n        +-- StopIteration\n        +-- ArithmeticError\n        +-- AssertionError\n        +-- AttributeError\n        +-- BufferError\n        +-- EOFError\n        +-- ImportError\n        +-- LookupError\n        +-- MemoryError\n        +-- NameError\n        +-- OSError\n        +-- ReferenceError\n        +-- RuntimeError\n        +-- SyntaxError\n        +-- SystemError\n        +-- TypeError\n        +-- ValueError\n        +-- Warning\n\n\n&quot;&quot;&quot;Unicode和字节字符串---Unicode和字节字符串----Unicode和字节字符串----Unicode和字节字符串----Unicode和字节字符串----Unicode和字节字符串----Unicode和字节字符串&quot;&quot;&quot;\n\n#-- Python的字符串类型\n    &quot;&quot;&quot;Python2.x&quot;&quot;&quot;\n    # 1.str表示8位文本和二进制数据\n    # 2.unicode表示宽字符Unicode文本\n    &quot;&quot;&quot;Python3.x&quot;&quot;&quot;\n    # 1.str表示Unicode文本（8位或者更宽）\n    # 2.bytes表示不可变的二进制数据\n    # 3.bytearray是一种可变的bytes类型\n\n#-- 字符编码方法\n    &quot;&quot;&quot;ASCII&quot;&quot;&quot;                   # 一个字节，只包含英文字符，0到127，共128个字符，利用函数可以进行字符和数字的相互转换\n    ord(\'a\')                      # 字符a的ASCII码为97，所以这里返回97\n    chr(97)                       # 和上边的过程相反，返回字符\'a\'\n    &quot;&quot;&quot;Latin-1&quot;&quot;&quot;                 # 一个字节，包含特殊字符，0到255，共256个字符，相当于对ASCII码的扩展\n    chr(196)                      # 返回一个特殊字符：Ä\n    &quot;&quot;&quot;Unicode&quot;&quot;&quot;                 # 宽字符，一个字符包含多个字节，一般用于亚洲的字符集，比如中文有好几万字\n    &quot;&quot;&quot;UTF-8&quot;&quot;&quot;                   # 可变字节数，小于128的字符表示为单个字节，128到0X7FF之间的代码转换为两个字节，0X7FF以上的代码转换为3或4个字节\n    # 注意：可以看出来，ASCII码是Latin-1和UTF-8的一个子集\n    # 注意：utf-8是unicode的一种实现方式，unicode、gbk、gb2312是编码字符集\n\n#-- 查看Python中的字符串编码名称，查看系统的编码\n    import encodings\n    help(encoding)\n    import sys\n    sys.platform                  # \'win64\'\n    sys.getdefaultencoding()      # \'utf-8\'\n    sys.getdefaultencoding()      # 返回当前系统平台的编码类型\n    sys.getsizeof(object)         # 返回object占有的bytes的大小\n\n#-- 源文件字符集编码声明: 添加注释来指定想要的编码形式 从而改变默认值 注释必须出现在脚本的第一行或者第二行\n    &quot;&quot;&quot;说明：其实这里只会检查#和coding:utf-8，其余的字符都是为了美观加上的&quot;&quot;&quot;\n    # _*_ coding: utf-8 _*_\n    # coding = utf-8\n\n#-- #编码: 字符串 --> 原始字节       #解码: 原始字节 --> 字符串\n\n#-- Python3.x中的字符串应用\n    s = \'...\'                     # 构建一个str对象，不可变对象\n    b = b\'...\'                    # 构建一个bytes对象，不可变对象\n    s[0], b[0]                    # 返回(\'.\', 113)\n    s[1:], b[1:]                  # 返回(\'..\', b\'..\')\n    B = B&quot;&quot;&quot;\n        xxxx\n        yyyy\n        &quot;&quot;&quot;\n    # B = b\'\\nxxxx\\nyyyy\\n\'\n    # 编码，将str字符串转化为其raw bytes形式：\n        str.encode(encoding = \'utf-8\', errors = \'strict\')\n        bytes(str, encoding)\n    # 编码例子：\n        S = \'egg\'\n        S.encode()                    # b\'egg\'\n        bytes(S, encoding = \'ascii\')  # b\'egg\'\n    # 解码，将raw bytes字符串转化为str形式：\n        bytes.decode(encoding = \'utf-8\', errors = \'strict\')\n        str(bytes_or_buffer[, encoding[, errors]])\n    # 解码例子：\n        B = b\'spam\'\n        B.decode()                # \'spam\'\n        str(B)                    # &quot;b\'spam\'&quot;，不带编码的str调用，结果为打印该bytes对象\n        str(B, encoding = \'ascii\')# \'spam\'，带编码的str调用，结果为转化该bytes对象\n\n#-- Python2.x的编码问题\n    u = u\'汉\'\n    print repr(u)                 # u\'\\xba\\xba\'\n    s = u.encode(\'UTF-8\')\n    print repr(s)                 # \'\\xc2\\xba\\xc2\\xba\'\n    u2 = s.decode(\'UTF-8\')\n    print repr(u2)                # u\'\\xba\\xba\'\n    # 对unicode进行解码是错误的\n    s2 = u.decode(\'UTF-8\')        # UnicodeEncodeError: \'ascii\' codec can\'t encode characters in position 0-1: ordinal not in range(128)\n    # 同样，对str进行编码也是错误的\n    u2 = s.encode(\'UTF-8\')        # UnicodeDecodeError: \'ascii\' codec can\'t decode byte 0xc2 in position 0: ordinal not in range(128)\n\n#-- bytes对象\n    B = b\'abc\'\n    B = bytes(\'abc\', \'ascii\')\n    B = bytes([97, 98, 99])\n    B = \'abc\'.encode()\n    # bytes对象的方法调用基本和str类型一致 但:B[0]返回的是ASCII码值97, 而不是b\'a\'\n\n#-- #文本文件: 根据Unicode编码来解释文件内容，要么是平台的默认编码，要么是指定的编码类型\n    # 二进制文件：表示字节值的整数的一个序列 open(\'bin.txt\', \'rb\')\n\n#-- Unicode文件\n    s = \'A\\xc4B\\xe8C\'             # s = \'A?BèC\'  len(s) = 5\n    #手动编码\n        l = s.encode(\'latin-1\')   # l = b\'A\\xc4B\\xe8C\'  len(l) = 5\n        u = s.encode(\'utf-8\')     # u = b\'A\\xc3\\x84B\\xc3\\xa8C\'  len(u) = 7\n    #文件输出编码\n        open(\'latindata\', \'w\', encoding = \'latin-1\').write(s)\n        l = open(\'latindata\', \'rb\').read()                        # l = b\'A\\xc4B\\xe8C\'  len(l) = 5\n        open(\'uft8data\', \'w\', encoding = \'utf-8\').write(s)\n        u = open(\'uft8data\', \'rb\').read()                         # u = b\'A\\xc3\\x84B\\xc3\\xa8C\'  len(u) = 7\n    #文件输入编码\n        s = open(\'latindata\', \'r\', encoding = \'latin-1\').read()   # s = \'A?BèC\'  len(s) = 5\n        s = open(\'latindata\', \'rb\').read().decode(\'latin-1\')      # s = \'A?BèC\'  len(s) = 5\n        s = open(\'utf8data\', \'r\', encoding = \'utf-8\').read()      # s = \'A?BèC\'  len(s) = 5\n        s = open(\'utf8data\', \'rb\').read().decode(\'utf-8\')         # s = \'A?BèC\'  len(s) = 5\n\n\n&quot;&quot;&quot;其他----其他----其他----其他----其他----其他----其他----其他----其他----其他----其他----其他----其他----其他----其他----其他----其他----其他----其他&quot;&quot;&quot;\n\n#-- Python实现任意深度的赋值 例如a[0] = \'value1\'; a[1][2] = \'value2\'; a[3][4][5] = \'value3\'\n    class MyDict(dict):\n        def __setitem__(self, key, value):                 # 该函数不做任何改动 这里只是为了输出\n            print(\'setitem:\', key, value, self)\n            super().__setitem__(key, value)\n        def __getitem__(self, item):                       # 主要技巧在该函数\n            print(\'getitem:\', item, self)                  # 输出信息\n            # 基本思路: a[1][2]赋值时 需要先取出a[1] 然后给a[1]的[2]赋值\n            if item not in self:                           # 如果a[1]不存在 则需要新建一个dict 并使得a[1] = dict\n                temp = MyDict()                            # 新建的dict: temp\n                super().__setitem__(item, temp)            # 赋值a[1] = temp\n                return temp                                # 返回temp 使得temp[2] = value有效\n            return super().__getitem__(item)               # 如果a[1]存在 则直接返回a[1]\n    # 例子:\n        test = MyDict()\n        test[0] = \'test\'\n        print(test[0])\n        test[1][2] = \'test1\'\n        print(test[1][2])\n        test[1][3] = \'test2\'\n        print(test[1][3])\n\n#-- Python中的多维数组\n    lists = [0] * 3                                        # 扩展list，结果为[0, 0, 0]\n    lists = [[]] * 3                                       # 多维数组，结果为[[], [], []]，但有问题，往下看\n    lists[0].append(3)                                     # 期望看到的结果[[3], [], []]，实际结果[[3], [3], [3]]，原因：list*n操作，是浅拷贝，如何避免？往下看\n    lists = [[] for i in range(3)]                         # 多维数组，结果为[[], [], []]\n    lists[0].append(3)                                     # 结果为[[3], [], []]\n    lists[1].append(6)                                     # 结果为[[3], [6], []]\n    lists[2].append(9)                                     # 结果为[[3], [6], [9]]\n    lists = [[[] for j in range(4)] for i in range(3)]     # 3行4列，且每一个元素为[]`, `61781922457361785000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment"># _*_ coding: utf-8 _*_</span>\n\n<span class="token triple-quoted-string string">"""类型和运算----类型和运算----类型和运算----类型和运算----类型和运算----类型和运算----类型和运算----类型和运算----类型和运算----类型和运算----类型和运算"""</span>\n\n<span class="token comment">#-- 寻求帮助:</span>\n    <span class="token builtin">dir</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>            <span class="token comment"># 简单的列出对象obj所包含的方法名称，返回一个字符串列表</span>\n    <span class="token builtin">help</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>func<span class="token punctuation">)</span>      <span class="token comment"># 查询obj.func的具体介绍和用法</span>\n\n<span class="token comment">#-- 测试类型的三种方法，推荐第三种</span>\n    <span class="token keyword">if</span> <span class="token builtin">type</span><span class="token punctuation">(</span>L<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"L is list"</span><span class="token punctuation">)</span>\n    <span class="token keyword">if</span> <span class="token builtin">type</span><span class="token punctuation">(</span>L<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token builtin">list</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"L is list"</span><span class="token punctuation">)</span>\n    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"L is list"</span><span class="token punctuation">)</span>\n\n<span class="token comment">#-- Python数据类型：哈希类型、不可哈希类型</span>\n    <span class="token comment"># 哈希类型，即在原地不能改变的变量类型，不可变类型。可利用hash函数查看其hash值，也可以作为字典的key</span>\n    <span class="token string">"数字类型：int, float, decimal.Decimal, fractions.Fraction, complex"</span>\n    <span class="token string">"字符串类型：str, bytes"</span>\n    <span class="token string">"元组：tuple"</span>\n    <span class="token string">"冻结集合：frozenset"</span>\n    <span class="token string">"布尔类型：True, False"</span>\n    <span class="token string">"None"</span>\n    <span class="token comment"># 不可hash类型：原地可变类型：list、dict和set。它们不可以作为字典的key。</span>\n\n<span class="token comment">#-- 数字常量</span>\n    <span class="token number">1234</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1234</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">999999999</span>                    <span class="token comment"># 整数</span>\n    <span class="token number">1.23</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">3.14e-10</span><span class="token punctuation">,</span> <span class="token number">4E210</span><span class="token punctuation">,</span> <span class="token number">4.0e+210</span>          <span class="token comment"># 浮点数</span>\n    <span class="token number">0o177</span><span class="token punctuation">,</span> <span class="token number">0x9ff</span><span class="token punctuation">,</span> <span class="token number">0X9FF</span><span class="token punctuation">,</span> <span class="token number">0b101010</span>                <span class="token comment"># 八进制、十六进制、二进制数字</span>\n    <span class="token number">3</span><span class="token operator">+</span><span class="token number">4j</span><span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token operator">+</span><span class="token number">4.0j</span><span class="token punctuation">,</span> <span class="token number">3J</span>                           <span class="token comment"># 复数常量，也可以用complex(real, image)来创建</span>\n    <span class="token builtin">hex</span><span class="token punctuation">(</span>I<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">oct</span><span class="token punctuation">(</span>I<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">bin</span><span class="token punctuation">(</span>I<span class="token punctuation">)</span>                       <span class="token comment"># 将十进制数转化为十六进制、八进制、二进制表示的“字符串”</span>\n    <span class="token builtin">int</span><span class="token punctuation">(</span>string<span class="token punctuation">,</span> base<span class="token punctuation">)</span>                            <span class="token comment"># 将字符串转化为整数，base为进制数</span>\n    <span class="token comment"># 2.x中，有两种整数类型：一般整数（32位）和长整数（无穷精度）。可以用l或L结尾，迫使一般整数成为长整数</span>\n    <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">\'inf\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">\'-inf\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">\'nan\'</span><span class="token punctuation">)</span>    <span class="token comment"># 无穷大, 无穷小, 非数</span>\n\n<span class="token comment">#-- 数字的表达式操作符</span>\n    <span class="token keyword">yield</span> x                                      <span class="token comment"># 生成器函数发送协议</span>\n    <span class="token keyword">lambda</span> args<span class="token punctuation">:</span> expression                      <span class="token comment"># 生成匿名函数</span>\n    x <span class="token keyword">if</span> y <span class="token keyword">else</span> z                                <span class="token comment"># 三元选择表达式</span>\n    x <span class="token keyword">and</span> y<span class="token punctuation">,</span> x <span class="token keyword">or</span> y<span class="token punctuation">,</span> <span class="token keyword">not</span> x                       <span class="token comment"># 逻辑与、逻辑或、逻辑非</span>\n    x <span class="token keyword">in</span> y<span class="token punctuation">,</span> x <span class="token keyword">not</span> <span class="token keyword">in</span> y                           <span class="token comment"># 成员对象测试</span>\n    x <span class="token keyword">is</span> y<span class="token punctuation">,</span> x <span class="token keyword">is</span> <span class="token keyword">not</span> y                           <span class="token comment"># 对象实体测试</span>\n    x<span class="token operator">&lt;</span>y<span class="token punctuation">,</span> x<span class="token operator">&lt;=</span>y<span class="token punctuation">,</span> x<span class="token operator">></span>y<span class="token punctuation">,</span> x<span class="token operator">>=</span>y<span class="token punctuation">,</span> x<span class="token operator">==</span>y<span class="token punctuation">,</span> x<span class="token operator">!=</span>y             <span class="token comment"># 大小比较，集合子集或超集值相等性操作符</span>\n    <span class="token number">1</span> <span class="token operator">&lt;</span> a <span class="token operator">&lt;</span> <span class="token number">3</span>                                    <span class="token comment"># Python中允许连续比较</span>\n    x<span class="token operator">|</span>y<span class="token punctuation">,</span> x<span class="token operator">&amp;</span>y<span class="token punctuation">,</span> x<span class="token operator">^</span>y                                <span class="token comment"># 位或、位与、位异或</span>\n    x<span class="token operator">&lt;&lt;</span>y<span class="token punctuation">,</span> x<span class="token operator">>></span>y                                   <span class="token comment"># 位操作：x左移、右移y位</span>\n    <span class="token operator">+</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token operator">/</span><span class="token punctuation">,</span> <span class="token operator">//</span><span class="token punctuation">,</span> <span class="token operator">%</span><span class="token punctuation">,</span> <span class="token operator">**</span>                        <span class="token comment"># 真除法、floor除法：返回不大于真除法结果的整数值、取余、幂运算</span>\n    <span class="token operator">-</span>x<span class="token punctuation">,</span> <span class="token operator">+</span>x<span class="token punctuation">,</span> <span class="token operator">~</span>x                                   <span class="token comment"># 一元减法、识别、按位求补（取反）</span>\n    x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> x<span class="token punctuation">[</span>i<span class="token punctuation">:</span>j<span class="token punctuation">:</span>k<span class="token punctuation">]</span>                               <span class="token comment"># 索引、分片</span>\n    <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token number">3.14</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>                          <span class="token comment"># 强制类型转换</span>\n\n<span class="token comment">#-- 整数可以利用bit_length函数测试所占的位数</span>\n    a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>       a<span class="token punctuation">.</span>bit_length<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment"># 1</span>\n    a <span class="token operator">=</span> <span class="token number">1024</span><span class="token punctuation">;</span>    a<span class="token punctuation">.</span>bit_length<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment"># 11</span>\n\n<span class="token comment">#-- repr和str显示格式的区别</span>\n    <span class="token triple-quoted-string string">"""\n    repr格式：默认的交互模式回显，产生的结果看起来它们就像是代码。\n    str格式：打印语句，转化成一种对用户更加友好的格式。\n    """</span>\n\n<span class="token comment">#-- 数字相关的模块</span>\n    <span class="token comment"># math模块</span>\n    <span class="token comment"># Decimal模块：小数模块</span>\n        <span class="token keyword">import</span> decimal\n        <span class="token keyword">from</span> decimal <span class="token keyword">import</span> Decimal\n        Decimal<span class="token punctuation">(</span><span class="token string">"0.01"</span><span class="token punctuation">)</span> <span class="token operator">+</span> Decimal<span class="token punctuation">(</span><span class="token string">"0.02"</span><span class="token punctuation">)</span>        <span class="token comment"># 返回Decimal("0.03")</span>\n        decimal<span class="token punctuation">.</span>getcontext<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>prec <span class="token operator">=</span> <span class="token number">4</span>            <span class="token comment"># 设置全局精度为4 即小数点后边4位</span>\n    <span class="token comment"># Fraction模块：分数模块</span>\n        <span class="token keyword">from</span> fractions <span class="token keyword">import</span> Fraction\n        x <span class="token operator">=</span> Fraction<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span>                       <span class="token comment"># 分数类型 4/6</span>\n        x <span class="token operator">=</span> Fraction<span class="token punctuation">(</span><span class="token string">"0.25"</span><span class="token punctuation">)</span>                     <span class="token comment"># 分数类型 1/4 接收字符串类型的参数</span>\n\n<span class="token comment">#-- 集合set</span>\n    <span class="token triple-quoted-string string">"""\n    set是一个无序不重复元素集, 基本功能包括关系测试和消除重复元素。\n    set支持union(联合), intersection(交), difference(差)和symmetric difference(对称差集)等数学运算。\n    set支持x in set, len(set), for x in set。\n    set不记录元素位置或者插入点, 因此不支持indexing, slicing, 或其它类序列的操作\n    """</span>\n    s <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                          <span class="token comment"># 创建一个数值集合，返回{3, 5, 9, 10}</span>\n    t <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">)</span>                             <span class="token comment"># 创建一个字符的集合，返回{\'l\', \'H\', \'e\', \'o\'}</span>\n    a <span class="token operator">=</span> t <span class="token operator">|</span> s<span class="token punctuation">;</span>    t<span class="token punctuation">.</span>union<span class="token punctuation">(</span>s<span class="token punctuation">)</span>                     <span class="token comment"># t 和 s的并集</span>\n    b <span class="token operator">=</span> t <span class="token operator">&amp;</span> s<span class="token punctuation">;</span>    t<span class="token punctuation">.</span>intersection<span class="token punctuation">(</span>s<span class="token punctuation">)</span>              <span class="token comment"># t 和 s的交集</span>\n    c <span class="token operator">=</span> t – s<span class="token punctuation">;</span>    t<span class="token punctuation">.</span>difference<span class="token punctuation">(</span>s<span class="token punctuation">)</span>                <span class="token comment"># 求差集（项在t中, 但不在s中）</span>\n    d <span class="token operator">=</span> t <span class="token operator">^</span> s<span class="token punctuation">;</span>    t<span class="token punctuation">.</span>symmetric_difference<span class="token punctuation">(</span>s<span class="token punctuation">)</span>      <span class="token comment"># 对称差集（项在t或s中, 但不会同时出现在二者中）</span>\n    t<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token string">\'x\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   t<span class="token punctuation">.</span>remove<span class="token punctuation">(</span><span class="token string">\'H\'</span><span class="token punctuation">)</span>                  <span class="token comment"># 增加/删除一个item</span>\n    s<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">37</span><span class="token punctuation">,</span><span class="token number">42</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                         <span class="token comment"># 利用[......]更新s集合</span>\n    x <span class="token keyword">in</span> s<span class="token punctuation">,</span>  x <span class="token keyword">not</span> <span class="token keyword">in</span> s                          <span class="token comment"># 集合中是否存在某个值</span>\n    s<span class="token punctuation">.</span>issubset<span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>      s <span class="token operator">&lt;=</span> t                   <span class="token comment"># 测试是否 s 中的每一个元素都在 t 中</span>\n    s<span class="token punctuation">.</span>issuperset<span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>    s <span class="token operator">>=</span> t                   <span class="token comment"># 测试是否 t 中的每一个元素都在 s 中</span>\n    s<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    s<span class="token punctuation">.</span>discard<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>                                <span class="token comment"># 删除s中x</span>\n    s<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>                                    <span class="token comment"># 清空s</span>\n    <span class="token punctuation">{</span>x<span class="token operator">**</span><span class="token number">2</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">}</span>                 <span class="token comment"># 集合解析，结果：{16, 1, 4, 9}</span>\n    <span class="token punctuation">{</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token string">\'spam\'</span><span class="token punctuation">}</span>                          <span class="token comment"># 集合解析，结果：{\'a\', \'p\', \'s\', \'m\'}</span>\n\n<span class="token comment">#-- 集合frozenset，不可变对象</span>\n    <span class="token triple-quoted-string string">"""\n    set是可变对象，即不存在hash值，不能作为字典的键值。同样的还有list等(tuple是可以作为字典key的)\n    frozenset是不可变对象，即存在hash值，可作为字典的键值\n    frozenset对象没有add、remove等方法，但有union/intersection/difference等方法\n    """</span>\n    a <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n    b <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    b<span class="token punctuation">.</span>add<span class="token punctuation">(</span>a<span class="token punctuation">)</span>                     <span class="token comment"># error: set是不可哈希类型</span>\n    b<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token builtin">frozenset</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>          <span class="token comment"># ok，将set变为frozenset，可哈希</span>\n\n<span class="token comment">#-- 布尔类型bool</span>\n    <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span>                   <span class="token comment"># 返回&lt;class \'bool\'></span>\n    <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span>       <span class="token comment"># bool类型属于整型，所以返回True</span>\n    <span class="token boolean">True</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token boolean">True</span> <span class="token keyword">is</span> <span class="token number">1</span>         <span class="token comment"># 输出(True, False)</span>\n\n<span class="token comment">#-- 动态类型简介</span>\n    <span class="token triple-quoted-string string">"""\n    变量名通过引用，指向对象。\n    Python中的“类型”属于对象，而不是变量，每个对象都包含有头部信息，比如"类型标示符" "引用计数器"等\n    """</span>\n    <span class="token comment">#共享引用及在原处修改：对于可变对象，要注意尽量不要共享引用！</span>\n    <span class="token comment">#共享引用和相等测试：</span>\n        L <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> M <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> L <span class="token keyword">is</span> M            <span class="token comment"># 返回False</span>\n        L <span class="token operator">=</span> M <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> L <span class="token keyword">is</span> M           <span class="token comment"># 返回True，共享引用</span>\n    <span class="token comment">#增强赋值和共享引用：普通+号会生成新的对象，而增强赋值+=会在原处修改</span>\n        L <span class="token operator">=</span> M <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>\n        L <span class="token operator">=</span> L <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>                      <span class="token comment"># L = [1, 2, 3, 4], M = [1, 2]</span>\n        L <span class="token operator">+=</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>                         <span class="token comment"># L = [1, 2, 3, 4], M = [1, 2, 3, 4]</span>\n\n<span class="token comment">#-- 常见字符串常量和表达式</span>\n    S <span class="token operator">=</span> <span class="token string">\'\'</span>                                  <span class="token comment"># 空字符串</span>\n    S <span class="token operator">=</span> <span class="token string">"spam’s"</span>                            <span class="token comment"># 双引号和单引号相同</span>\n    S <span class="token operator">=</span> <span class="token string">"s\\np\\ta\\x00m"</span>                      <span class="token comment"># 转义字符</span>\n    S <span class="token operator">=</span> <span class="token triple-quoted-string string">"""spam"""</span>                          <span class="token comment"># 三重引号字符串，一般用于函数说明</span>\n    S <span class="token operator">=</span> <span class="token string">r\'\\temp\'</span>                            <span class="token comment"># Raw字符串，不会进行转义，抑制转义</span>\n    S <span class="token operator">=</span> <span class="token string">b\'Spam\'</span>                             <span class="token comment"># Python3中的字节字符串</span>\n    S <span class="token operator">=</span> <span class="token string">u\'spam\'</span>                             <span class="token comment"># Python2.6中的Unicode字符串</span>\n    s1<span class="token operator">+</span>s2<span class="token punctuation">,</span> s1<span class="token operator">*</span><span class="token number">3</span><span class="token punctuation">,</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> s<span class="token punctuation">[</span>i<span class="token punctuation">:</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>       <span class="token comment"># 字符串操作</span>\n    <span class="token string">\'a %s parrot\'</span> <span class="token operator">%</span> <span class="token string">\'kind\'</span>                  <span class="token comment"># 字符串格式化表达式</span>\n    <span class="token string">\'a {1} {0} parrot\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">\'kind\'</span><span class="token punctuation">,</span> <span class="token string">\'red\'</span><span class="token punctuation">)</span><span class="token comment"># 字符串格式化方法</span>\n    <span class="token keyword">for</span> x <span class="token keyword">in</span> s<span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>                    <span class="token comment"># 字符串迭代，成员关系</span>\n    <span class="token punctuation">[</span>x<span class="token operator">*</span><span class="token number">2</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> s<span class="token punctuation">]</span>                        <span class="token comment"># 字符串列表解析</span>\n    <span class="token string">\',\'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>               <span class="token comment"># 字符串输出，结果：a,b,c</span>\n\n<span class="token comment">#-- 内置str处理函数：</span>\n    str1 <span class="token operator">=</span> <span class="token string">"stringobject"</span>\n    str1<span class="token punctuation">.</span>upper<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> str1<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> str1<span class="token punctuation">.</span>swapcase<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> str1<span class="token punctuation">.</span>capitalize<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> str1<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment"># 全部大写，全部小写、大小写转换，首字母大写，每个单词的首字母都大写</span>\n    str1<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span>width<span class="token punctuation">)</span>                       <span class="token comment"># 获取固定长度，左对齐，右边不够用空格补齐</span>\n    str1<span class="token punctuation">.</span>rjust<span class="token punctuation">(</span>width<span class="token punctuation">)</span>                       <span class="token comment"># 获取固定长度，右对齐，左边不够用空格补齐</span>\n    str1<span class="token punctuation">.</span>center<span class="token punctuation">(</span>width<span class="token punctuation">)</span>                      <span class="token comment"># 获取固定长度，中间对齐，两边不够用空格补齐</span>\n    str1<span class="token punctuation">.</span>zfill<span class="token punctuation">(</span>width<span class="token punctuation">)</span>                       <span class="token comment"># 获取固定长度，右对齐，左边不足用0补齐</span>\n    str1<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">\'t\'</span><span class="token punctuation">,</span>start<span class="token punctuation">,</span>end<span class="token punctuation">)</span>                <span class="token comment"># 查找字符串，可以指定起始及结束位置搜索</span>\n    str1<span class="token punctuation">.</span>rfind<span class="token punctuation">(</span><span class="token string">\'t\'</span><span class="token punctuation">)</span>                         <span class="token comment"># 从右边开始查找字符串</span>\n    str1<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">\'t\'</span><span class="token punctuation">)</span>                         <span class="token comment"># 查找字符串出现的次数</span>\n    <span class="token comment">#上面所有方法都可用index代替，不同的是使用index查找不到会抛异常，而find返回-1</span>\n    str1<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">\'old\'</span><span class="token punctuation">,</span><span class="token string">\'new\'</span><span class="token punctuation">)</span>               <span class="token comment"># 替换函数，替换old为new，参数中可以指定maxReplaceTimes，即替换指定次数的old为new</span>\n    str1<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                           <span class="token comment"># 默认删除空白符</span>\n    str1<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">\'d\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment"># 删除str1字符串中开头、结尾处，位于 d 删除序列的字符</span>\n    str1<span class="token punctuation">.</span>lstrip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    str1<span class="token punctuation">.</span>lstrip<span class="token punctuation">(</span><span class="token string">\'d\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                       <span class="token comment"># 删除str1字符串中开头处，位于 d 删除序列的字符</span>\n    str1<span class="token punctuation">.</span>rstrip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    str1<span class="token punctuation">.</span>rstrip<span class="token punctuation">(</span><span class="token string">\'d\'</span><span class="token punctuation">)</span>                        <span class="token comment"># 删除str1字符串中结尾处，位于 d 删除序列的字符</span>\n    str1<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">\'start\'</span><span class="token punctuation">)</span>                <span class="token comment"># 是否以start开头</span>\n    str1<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">\'end\'</span><span class="token punctuation">)</span>                    <span class="token comment"># 是否以end结尾</span>\n    str1<span class="token punctuation">.</span>isalnum<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> str1<span class="token punctuation">.</span>isalpha<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> str1<span class="token punctuation">.</span>isdigit<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> str1<span class="token punctuation">.</span>islower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> str1<span class="token punctuation">.</span>isupper<span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token comment"># 判断字符串是否全为字符、数字、小写、大写</span>\n\n<span class="token comment">#-- 三重引号编写多行字符串块，并且在代码折行处嵌入换行字符\\n</span>\n    mantra <span class="token operator">=</span> <span class="token triple-quoted-string string">"""hello world\n            hello python\n            hello my friend"""</span>\n    <span class="token comment"># mantra为"""hello world \\n hello python \\n hello my friend"""</span>\n\n<span class="token comment">#-- 索引和分片：</span>\n    S<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> S<span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>S<span class="token punctuation">)</span>–<span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> S<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>                <span class="token comment"># 索引</span>\n    S<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> S<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> S<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> S<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>        <span class="token comment"># 分片，第三个参数指定步长，如`S[1:10:2]`是从1位到10位没隔2位获取一个字符。</span>\n\n<span class="token comment">#-- 字符串转换工具：</span>\n    <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token string">\'42\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>                      <span class="token comment"># 返回(42, \'42\')</span>\n    <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">\'4.13\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">4.13</span><span class="token punctuation">)</span>                <span class="token comment"># 返回(4.13, \'4.13\')</span>\n    <span class="token builtin">ord</span><span class="token punctuation">(</span><span class="token string">\'s\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token number">115</span><span class="token punctuation">)</span>                      <span class="token comment"># 返回(115, \'s\')</span>\n    <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token string">\'1001\'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>                          <span class="token comment"># 将字符串作为二进制数字，转化为数字，返回9</span>\n    <span class="token builtin">bin</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">oct</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span>               <span class="token comment"># 将整数转化为二进制/八进制/十六进制字符串，返回(\'0b1101\', \'015\', \'0xd\')</span>\n\n<span class="token comment">#-- 另类字符串连接</span>\n    name <span class="token operator">=</span> <span class="token string">"wang"</span> <span class="token string">"hong"</span>                    <span class="token comment"># 单行，name = "wanghong"</span>\n    name <span class="token operator">=</span> <span class="token string">"wang"</span> \\\n            <span class="token string">"hong"</span>                          <span class="token comment"># 多行，name = "wanghong"</span>\n\n<span class="token comment">#-- Python中的字符串格式化实现1--字符串格式化表达式</span>\n    <span class="token triple-quoted-string string">"""\n    基于C语言的\'print\'模型，并且在大多数的现有的语言中使用。\n    通用结构：%[(name)][flag][width].[precision]typecode\n    """</span>\n    <span class="token string">"this is %d %s bird"</span> <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'dead\'</span><span class="token punctuation">)</span>                          <span class="token comment"># 一般的格式化表达式</span>\n    <span class="token string">"%s---%s---%s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">,</span> <span class="token number">3.14</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                      <span class="token comment"># 字符串输出：\'42---3.14---[1, 2, 3]\'</span>\n    <span class="token string">"%d...%6d...%-6d...%06d"</span> <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token number">1234</span><span class="token punctuation">,</span> <span class="token number">1234</span><span class="token punctuation">,</span> <span class="token number">1234</span><span class="token punctuation">,</span> <span class="token number">1234</span><span class="token punctuation">)</span>         <span class="token comment"># 对齐方式及填充："1234...  1234...1234  ...001234"</span>\n    x <span class="token operator">=</span> <span class="token number">1.23456789</span>\n    <span class="token string">"%e | %f | %g"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> x<span class="token punctuation">,</span> x<span class="token punctuation">)</span>                                  <span class="token comment"># 对齐方式："1.234568e+00 | 1.234568 | 1.23457"</span>\n    <span class="token string">"%6.2f*%-6.2f*%06.2f*%+6.2f"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> x<span class="token punctuation">,</span> x<span class="token punctuation">,</span> x<span class="token punctuation">)</span>                 <span class="token comment"># 对齐方式：\'  1.23*1.23  *001.23* +1.23\'</span>\n    <span class="token string">"%(name1)d---%(name2)s"</span> <span class="token operator">%</span> <span class="token punctuation">{</span><span class="token string">"name1"</span><span class="token punctuation">:</span><span class="token number">23</span><span class="token punctuation">,</span> <span class="token string">"name2"</span><span class="token punctuation">:</span><span class="token string">"value2"</span><span class="token punctuation">}</span>    <span class="token comment"># 基于字典的格式化表达式</span>\n    <span class="token string">"%(name)s is %(age)d"</span> <span class="token operator">%</span> <span class="token builtin">vars</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                              <span class="token comment"># vars()函数调用返回一个字典，包含了所有本函数调用时存在的变量</span>\n\n<span class="token comment">#-- Python中的字符串格式化实现2--字符串格式化调用方法</span>\n    <span class="token comment"># 普通调用</span>\n    <span class="token string">"{0}, {1} and {2}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">\'spam\'</span><span class="token punctuation">,</span> <span class="token string">\'ham\'</span><span class="token punctuation">,</span> <span class="token string">\'eggs\'</span><span class="token punctuation">)</span>            <span class="token comment"># 基于位置的调用</span>\n    <span class="token string">"{motto} and {pork}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>motto <span class="token operator">=</span> <span class="token string">\'spam\'</span><span class="token punctuation">,</span> pork <span class="token operator">=</span> <span class="token string">\'ham\'</span><span class="token punctuation">)</span>   <span class="token comment"># 基于Key的调用</span>\n    <span class="token string">"{motto} and {0}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">\'ham\'</span><span class="token punctuation">,</span> motto <span class="token operator">=</span> <span class="token string">\'spam\'</span><span class="token punctuation">)</span>             <span class="token comment"># 混合调用</span>\n    <span class="token comment"># 添加键 属性 偏移量 (import sys)</span>\n    <span class="token string">"my {1[spam]} runs {0.platform}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>sys<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">\'spam\'</span><span class="token punctuation">:</span><span class="token string">\'laptop\'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>                 <span class="token comment"># 基于位置的键和属性</span>\n    <span class="token string">"{config[spam]} {sys.platform}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>sys <span class="token operator">=</span> sys<span class="token punctuation">,</span> config <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">\'spam\'</span><span class="token punctuation">:</span><span class="token string">\'laptop\'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>   <span class="token comment"># 基于Key的键和属性</span>\n    <span class="token string">"first = {0[0]}, second = {0[1]}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'A\'</span><span class="token punctuation">,</span> <span class="token string">\'B\'</span><span class="token punctuation">,</span> <span class="token string">\'C\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                       <span class="token comment"># 基于位置的偏移量</span>\n    <span class="token comment"># 具体格式化</span>\n    <span class="token string">"{0:e}, {1:.3e}, {2:g}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token number">3.14159</span><span class="token punctuation">,</span> <span class="token number">3.14159</span><span class="token punctuation">,</span> <span class="token number">3.14159</span><span class="token punctuation">)</span>   <span class="token comment"># 输出\'3.141590e+00, 3.142e+00, 3.14159\'</span>\n    <span class="token string">"{fieldname:format_spec}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>\n    <span class="token comment"># 说明:</span>\n    <span class="token triple-quoted-string string">"""\n        fieldname是指定参数的一个数字或关键字, 后边可跟可选的".name"或"[index]"成分引用\n        format_spec ::=  [[fill]align][sign][#][0][width][,][.precision][type]\n        fill        ::=  &lt;any character>              #填充字符\n        align       ::=  "&lt;" | ">" | "=" | "^"        #对齐方式\n        sign        ::=  "+" | "-" | " "              #符号说明\n        width       ::=  integer                      #字符串宽度\n        precision   ::=  integer                      #浮点数精度\n        type        ::=  "b" | "c" | "d" | "e" | "E" | "f" | "F" | "g" | "G" | "n" | "o" | "s" | "x" | "X" | "%"\n    """</span>\n    <span class="token comment"># 例子:</span>\n        <span class="token string">\'={0:10} = {1:10}\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">\'spam\'</span><span class="token punctuation">,</span> <span class="token number">123.456</span><span class="token punctuation">)</span>    <span class="token comment"># 输出\'=spam       =    123.456\'</span>\n        <span class="token string">\'={0:>10}=\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">\'test\'</span><span class="token punctuation">)</span>                    <span class="token comment"># 输出\'=      test=\'</span>\n        <span class="token string">\'={0:&lt;10}=\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">\'test\'</span><span class="token punctuation">)</span>                    <span class="token comment"># 输出\'=test      =\'</span>\n        <span class="token string">\'={0:^10}=\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">\'test\'</span><span class="token punctuation">)</span>                    <span class="token comment"># 输出\'=   test   =\'</span>\n        <span class="token string">\'{0:X}, {1:o}, {2:b}\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span>   <span class="token comment"># 输出\'FF, 377, 11111111\'</span>\n        <span class="token string">\'My name is {0:{1}}.\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">\'Fred\'</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span>       <span class="token comment"># 输出\'My name is Fred    .\'  动态指定参数</span>\n\n<span class="token comment">#-- 常用列表常量和操作</span>\n    L <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">\'string\'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">]</span>                        <span class="token comment"># 嵌套列表</span>\n    L <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token string">\'spam\'</span><span class="token punctuation">)</span>                                  <span class="token comment"># 列表初始化</span>\n    L <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                             <span class="token comment"># 列表初始化</span>\n    <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token builtin">ord</span><span class="token punctuation">,</span> <span class="token string">\'spam\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                            <span class="token comment"># 列表解析</span>\n    <span class="token builtin">len</span><span class="token punctuation">(</span>L<span class="token punctuation">)</span>                                            <span class="token comment"># 求列表长度</span>\n    L<span class="token punctuation">.</span>count<span class="token punctuation">(</span>value<span class="token punctuation">)</span>                                    <span class="token comment"># 求列表中某个值的个数</span>\n    L<span class="token punctuation">.</span>append<span class="token punctuation">(</span>obj<span class="token punctuation">)</span>                                     <span class="token comment"># 向列表的尾部添加数据，比如append(2)，添加元素2</span>\n    L<span class="token punctuation">.</span>insert<span class="token punctuation">(</span>index<span class="token punctuation">,</span> obj<span class="token punctuation">)</span>                              <span class="token comment"># 向列表的指定index位置添加数据，index及其之后的数据后移</span>\n    L<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>interable<span class="token punctuation">)</span>                               <span class="token comment"># 通过添加iterable中的元素来扩展列表，比如extend([2])，添加元素2，注意和append的区别</span>\n    L<span class="token punctuation">.</span>index<span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token punctuation">[</span>start<span class="token punctuation">,</span> <span class="token punctuation">[</span>stop<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                   <span class="token comment"># 返回列表中值value的第一个索引</span>\n    L<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span>                                    <span class="token comment"># 删除并返回index处的元素，默认为删除并返回最后一个元素</span>\n    L<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>value<span class="token punctuation">)</span>                                   <span class="token comment"># 删除列表中的value值，只删除第一次出现的value的值</span>\n    L<span class="token punctuation">.</span>reverse<span class="token punctuation">(</span><span class="token punctuation">)</span>                                       <span class="token comment"># 反转列表</span>\n    L<span class="token punctuation">.</span>sort<span class="token punctuation">(</span><span class="token builtin">cmp</span><span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>         <span class="token comment"># 排序列表</span>\n    a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> b <span class="token operator">=</span> a<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">:</span><span class="token punctuation">]</span>                         <span class="token comment"># 注意，这里不会引发IndexError异常，只会返回一个空的列表[]</span>\n    a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a <span class="token operator">+=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>                                  <span class="token comment"># 这里实在原有列表的基础上进行操作，即列表的id没有改变</span>\n    a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a <span class="token operator">=</span> a <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>                               <span class="token comment"># 这里最后的a要构建一个新的列表，即a的id发生了变化</span>\n\n<span class="token comment">#-- 用切片来删除序列的某一段</span>\n    a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span>\n    a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>                                       <span class="token comment"># a = [1, 5, 6, 7]</span>\n    a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span>\n    <span class="token keyword">del</span> a<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>                                        <span class="token comment"># 去除偶数项(偶数索引的)，a = [1, 3, 5, 7]</span>\n\n<span class="token comment">#-- 常用字典常量和操作</span>\n    D <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n    D <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">\'spam\'</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">\'tol\'</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token string">\'ham\'</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span>                   <span class="token comment"># 嵌套字典</span>\n    D <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">.</span>fromkeys<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'s\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span>                  <span class="token comment"># {\'s\': 8, \'d\': 8}</span>\n    D <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">\'tom\'</span><span class="token punctuation">,</span> age <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">)</span>                  <span class="token comment"># {\'age\': 12, \'name\': \'tom\'}</span>\n    D <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'name\'</span><span class="token punctuation">,</span> <span class="token string">\'tom\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">\'age\'</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>          <span class="token comment"># {\'age\': 12, \'name\': \'tom\'}</span>\n    D <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'name\'</span><span class="token punctuation">,</span> <span class="token string">\'age\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'tom\'</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>       <span class="token comment"># {\'age\': 12, \'name\': \'tom\'}</span>\n    D<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> D<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> D<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span>                   <span class="token comment"># 字典键、值以及键值对</span>\n    D<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">,</span> default<span class="token punctuation">)</span>                               <span class="token comment"># get函数</span>\n    D<span class="token punctuation">.</span>update<span class="token punctuation">(</span>D_other<span class="token punctuation">)</span>                                 <span class="token comment"># 合并字典，如果存在相同的键值，D_other的数据会覆盖掉D的数据</span>\n    D<span class="token punctuation">.</span>pop<span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">[</span>D<span class="token punctuation">]</span><span class="token punctuation">)</span>                                   <span class="token comment"># 删除字典中键值为key的项，返回键值为key的值，如果不存在，返回默认值D，否则异常</span>\n    D<span class="token punctuation">.</span>popitem<span class="token punctuation">(</span><span class="token punctuation">)</span>                                       <span class="token comment"># pop字典中随机的一项（一个键值对）</span>\n    D<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span>k<span class="token punctuation">[</span><span class="token punctuation">,</span> d<span class="token punctuation">]</span><span class="token punctuation">)</span>                              <span class="token comment"># 设置D中某一项的默认值。如果k存在，则返回D[k]，否则设置D[k]=d，同时返回D[k]。</span>\n    <span class="token keyword">del</span> D                                             <span class="token comment"># 删除字典</span>\n    <span class="token keyword">del</span> D<span class="token punctuation">[</span><span class="token string">\'key\'</span><span class="token punctuation">]</span>                                      <span class="token comment"># 删除字典的某一项</span>\n    <span class="token keyword">if</span> key <span class="token keyword">in</span> D<span class="token punctuation">:</span>   <span class="token keyword">if</span> key <span class="token keyword">not</span> <span class="token keyword">in</span> D<span class="token punctuation">:</span>                   <span class="token comment"># 测试字典键是否存在</span>\n    <span class="token comment"># 字典注意事项：（1）对新索引赋值会添加一项（2）字典键不一定非得是字符串，也可以为任何的不可变对象</span>\n    <span class="token comment"># 不可变对象：调用对象自身的任意方法，也不会改变该对象自身的内容，这些方法会创建新的对象并返回。</span>\n    <span class="token comment"># 字符串、整数、tuple都是不可变对象，dict、set、list都是可变对象</span>\n    D<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span>                                    <span class="token comment"># tuple作为字典的key</span>\n\n<span class="token comment">#-- 字典解析</span>\n    D <span class="token operator">=</span> <span class="token punctuation">{</span>k<span class="token punctuation">:</span><span class="token number">8</span> <span class="token keyword">for</span> k <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">\'s\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">]</span><span class="token punctuation">}</span>                     <span class="token comment"># {\'s\': 8, \'d\': 8}</span>\n    D <span class="token operator">=</span> <span class="token punctuation">{</span>k<span class="token punctuation">:</span>v <span class="token keyword">for</span> <span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'name\'</span><span class="token punctuation">,</span> <span class="token string">\'age\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'tom\'</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span>       <span class="token comment"># {\'age\': 12, \'name\': tom}</span>\n\n<span class="token comment">#-- 字典的特殊方法__missing__：当查找找不到key时，会执行该方法</span>\n    <span class="token keyword">class</span> <span class="token class-name">Dict</span><span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">__missing__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            self<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n            <span class="token keyword">return</span> self<span class="token punctuation">[</span>key<span class="token punctuation">]</span>\n    dct <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    dct<span class="token punctuation">[</span><span class="token string">"foo"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token comment"># 这有点类似于collections.defalutdict</span>\n    dct<span class="token punctuation">[</span><span class="token string">"foo"</span><span class="token punctuation">]</span>              <span class="token comment"># [1]</span>\n\n<span class="token comment">#-- 元组和列表的唯一区别在于元组是不可变对象，列表是可变对象</span>\n    a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>           <span class="token comment"># a[1] = 0, OK</span>\n    a <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>           <span class="token comment"># a[1] = 0, Error</span>\n    a <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">)</span>           <span class="token comment"># a[0][1] = 0, OK</span>\n    a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span>            <span class="token comment"># a[0][1] = 0, Error</span>\n\n<span class="token comment">#-- 元组的特殊语法: 逗号和圆括号</span>\n    D <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span>                <span class="token comment"># 此时D为一个整数 即D = 12</span>\n    D <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token punctuation">)</span>              <span class="token comment"># 此时D为一个元组 即D = (12, )</span>\n\n<span class="token comment">#-- 文件基本操作</span>\n    output <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">r\'C:\\spam\'</span><span class="token punctuation">,</span> <span class="token string">\'w\'</span><span class="token punctuation">)</span>          <span class="token comment"># 打开输出文件，用于写</span>\n    <span class="token builtin">input</span> <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'data\'</span><span class="token punctuation">,</span> <span class="token string">\'r\'</span><span class="token punctuation">)</span>               <span class="token comment"># 打开输入文件，用于读。打开的方式可以为\'w\', \'r\', \'a\', \'wb\', \'rb\', \'ab\'等</span>\n    fp<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">[</span>size<span class="token punctuation">]</span><span class="token punctuation">)</span>                         <span class="token comment"># size为读取的长度，以byte为单位</span>\n    fp<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">[</span>size<span class="token punctuation">]</span><span class="token punctuation">)</span>                     <span class="token comment"># 读一行，如果定义了size，有可能返回的只是一行的一部分</span>\n    fp<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">[</span>size<span class="token punctuation">]</span><span class="token punctuation">)</span>                    <span class="token comment"># 把文件每一行作为一个list的一个成员，并返回这个list。其实它的内部是通过循环调用readline()来实现的。如果提供size参数，size是表示读取内容的总长。</span>\n    fp<span class="token punctuation">.</span>readable<span class="token punctuation">(</span><span class="token punctuation">)</span>                           <span class="token comment"># 是否可读</span>\n    fp<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">)</span>                           <span class="token comment"># 把str写到文件中，write()并不会在str后加上一个换行符</span>\n    fp<span class="token punctuation">.</span>writelines<span class="token punctuation">(</span>seq<span class="token punctuation">)</span>                      <span class="token comment"># 把seq的内容全部写到文件中(多行一次性写入)</span>\n    fp<span class="token punctuation">.</span>writeable<span class="token punctuation">(</span><span class="token punctuation">)</span>                          <span class="token comment"># 是否可写</span>\n    fp<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>                              <span class="token comment"># 关闭文件。</span>\n    fp<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>                              <span class="token comment"># 把缓冲区的内容写入硬盘</span>\n    fp<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span>                             <span class="token comment"># 返回一个长整型的”文件标签“</span>\n    fp<span class="token punctuation">.</span>isatty<span class="token punctuation">(</span><span class="token punctuation">)</span>                             <span class="token comment"># 文件是否是一个终端设备文件（unix系统中的）</span>\n    fp<span class="token punctuation">.</span>tell<span class="token punctuation">(</span><span class="token punctuation">)</span>                               <span class="token comment"># 返回文件操作标记的当前位置，以文件的开头为原点</span>\n    fp<span class="token punctuation">.</span><span class="token builtin">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                               <span class="token comment"># 返回下一行，并将文件操作标记位移到下一行。把一个file用于for … in file这样的语句时，就是调用next()函数来实现遍历的。</span>\n    fp<span class="token punctuation">.</span>seek<span class="token punctuation">(</span>offset<span class="token punctuation">[</span><span class="token punctuation">,</span>whence<span class="token punctuation">]</span><span class="token punctuation">)</span>                <span class="token comment"># 将文件打开操作标记移到offset的位置。whence为0表示从头开始计算，1表示以当前位置为原点计算。2表示以文件末尾为原点进行计算。</span>\n    fp<span class="token punctuation">.</span>seekable<span class="token punctuation">(</span><span class="token punctuation">)</span>                           <span class="token comment"># 是否可以seek</span>\n    fp<span class="token punctuation">.</span>truncate<span class="token punctuation">(</span><span class="token punctuation">[</span>size<span class="token punctuation">]</span><span class="token punctuation">)</span>                     <span class="token comment"># 把文件裁成规定的大小，默认的是裁到当前文件操作标记的位置。</span>\n    <span class="token keyword">for</span> line <span class="token keyword">in</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'data\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span>                         <span class="token comment"># 使用for语句，比较适用于打开比较大的文件</span>\n    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'data\'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">file</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>              <span class="token comment"># 使用with语句，可以保证文件关闭</span>\n    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'data\'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">file</span><span class="token punctuation">:</span>\n        lines <span class="token operator">=</span> <span class="token builtin">file</span><span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token comment"># 一次读入文件所有行，并关闭文件</span>\n    <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'f.txt\'</span><span class="token punctuation">,</span> encoding <span class="token operator">=</span> <span class="token string">\'latin-1\'</span><span class="token punctuation">)</span>     <span class="token comment"># Python3.x Unicode文本文件</span>\n    <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'f.bin\'</span><span class="token punctuation">,</span> <span class="token string">\'rb\'</span><span class="token punctuation">)</span>                     <span class="token comment"># Python3.x 二进制bytes文件</span>\n    <span class="token comment"># 文件对象还有相应的属性：buffer closed encoding errors line_buffering name newlines等</span>\n\n<span class="token comment">#-- 其他</span>\n    <span class="token comment"># Python中的真假值含义：1. 数字如果非零，则为真，0为假。 2. 其他对象如果非空，则为真</span>\n    <span class="token comment"># 通常意义下的类型分类：1. 数字、序列、映射。 2. 可变类型和不可变类型</span>\n\n\n<span class="token triple-quoted-string string">"""语法和语句----语法和语句----语法和语句----语法和语句----语法和语句----语法和语句----语法和语句----语法和语句----语法和语句----语法和语句----语法和语句"""</span>\n\n<span class="token comment">#-- 赋值语句的形式</span>\n    spam <span class="token operator">=</span> <span class="token string">\'spam\'</span>                          <span class="token comment"># 基本形式</span>\n    spam<span class="token punctuation">,</span> ham <span class="token operator">=</span> <span class="token string">\'spam\'</span><span class="token punctuation">,</span> <span class="token string">\'ham\'</span>              <span class="token comment"># 元组赋值形式</span>\n    <span class="token punctuation">[</span>spam<span class="token punctuation">,</span> ham<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'s\'</span><span class="token punctuation">,</span> <span class="token string">\'h\'</span><span class="token punctuation">]</span>               <span class="token comment"># 列表赋值形式</span>\n    a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d <span class="token operator">=</span> <span class="token string">\'abcd\'</span>                    <span class="token comment"># 序列赋值形式</span>\n    a<span class="token punctuation">,</span> <span class="token operator">*</span>b<span class="token punctuation">,</span> c <span class="token operator">=</span> <span class="token string">\'spam\'</span>                      <span class="token comment"># 序列解包形式（Python3.x中才有）</span>\n    spam <span class="token operator">=</span> ham <span class="token operator">=</span> <span class="token string">\'no\'</span>                      <span class="token comment"># 多目标赋值运算，涉及到共享引用</span>\n    spam <span class="token operator">+=</span> <span class="token number">42</span>                             <span class="token comment"># 增强赋值，涉及到共享引用</span>\n\n<span class="token comment">#-- 序列赋值 序列解包</span>\n    <span class="token punctuation">[</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>                  <span class="token comment"># a = 1, b = 2, c = 3</span>\n    a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d <span class="token operator">=</span> <span class="token string">"spam"</span>                    <span class="token comment"># a = \'s\', b = \'p\', c = \'a\', d = \'m\'</span>\n    a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c <span class="token operator">=</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>                     <span class="token comment"># a = 0, b = 1, c = 2</span>\n    a<span class="token punctuation">,</span> <span class="token operator">*</span>b <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>                   <span class="token comment"># a = 1, b = [2, 3, 4]</span>\n    <span class="token operator">*</span>a<span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>                   <span class="token comment"># a = [1, 2, 3], b = 4</span>\n    a<span class="token punctuation">,</span> <span class="token operator">*</span>b<span class="token punctuation">,</span> c <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>                <span class="token comment"># a = 1, b = [2, 3], c = 4</span>\n    <span class="token comment"># 带有*时 会优先匹配*之外的变量 如</span>\n    a<span class="token punctuation">,</span> <span class="token operator">*</span>b<span class="token punctuation">,</span> c <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>                      <span class="token comment"># a = 1, c = 2, b = []</span>\n\n<span class="token comment">#-- print函数原型</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">\' \'</span><span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">\'\\n\'</span><span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token operator">=</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">,</span> flush<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>\n    <span class="token comment"># 流的重定向</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'hello world\'</span><span class="token punctuation">)</span>                   <span class="token comment"># 等于sys.stdout.write(\'hello world\')</span>\n    temp <span class="token operator">=</span> sys<span class="token punctuation">.</span>stdout                      <span class="token comment"># 原有流的保存</span>\n    sys<span class="token punctuation">.</span>stdout <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'log.log\'</span><span class="token punctuation">,</span> <span class="token string">\'a\'</span><span class="token punctuation">)</span>      <span class="token comment"># 流的重定向</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'hello world\'</span><span class="token punctuation">)</span>                   <span class="token comment"># 写入到文件log.log</span>\n    sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    sys<span class="token punctuation">.</span>stdout <span class="token operator">=</span> temp                      <span class="token comment"># 原有流的复原</span>\n\n<span class="token comment">#-- Python中and或or总是返回对象(左边的对象或右边的对象) 且具有短路求值的特性</span>\n    <span class="token number">1</span> <span class="token keyword">or</span> <span class="token number">2</span> <span class="token keyword">or</span> <span class="token number">3</span>                            <span class="token comment"># 返回 1</span>\n    <span class="token number">1</span> <span class="token keyword">and</span> <span class="token number">2</span> <span class="token keyword">and</span> <span class="token number">3</span>                          <span class="token comment"># 返回 3</span>\n\n<span class="token comment">#-- if/else三元表达符（if语句在行内）</span>\n    A <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">if</span> X <span class="token keyword">else</span> <span class="token number">2</span>\n    A <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">if</span> X <span class="token keyword">else</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token keyword">if</span> Y <span class="token keyword">else</span> <span class="token number">3</span><span class="token punctuation">)</span>\n    <span class="token comment"># 也可以使用and-or语句（一条语句实现多个if-else）</span>\n    a <span class="token operator">=</span> <span class="token number">6</span>\n    result <span class="token operator">=</span> <span class="token punctuation">(</span>a <span class="token operator">></span> <span class="token number">20</span> <span class="token keyword">and</span> <span class="token string">"big than 20"</span> <span class="token keyword">or</span> a <span class="token operator">></span> <span class="token number">10</span> <span class="token keyword">and</span> <span class="token string">"big than 10"</span> <span class="token keyword">or</span> a <span class="token operator">></span> <span class="token number">5</span> <span class="token keyword">and</span> <span class="token string">"big than 5"</span><span class="token punctuation">)</span>    <span class="token comment"># 返回"big than 5"</span>\n\n<span class="token comment">#-- Python的while语句或者for语句可以带else语句 当然也可以带continue/break/pass语句</span>\n    <span class="token keyword">while</span> a <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">:</span>\n        anything\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        anything\n    <span class="token comment"># else语句会在循环结束后执行，除非在循环中执行了break，同样的还有for语句</span>\n    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        anything\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        anything\n\n<span class="token comment">#-- for循环的元组赋值</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">:</span>                   <span class="token comment"># 最简单的赋值</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">:</span>    <span class="token comment"># 自动解包赋值</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"XY"</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">:</span>      <span class="token comment"># 自动解包 a = X, b = Y, c = 6</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token operator">*</span>b<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">:</span>            <span class="token comment"># 自动解包赋值</span>\n\n<span class="token comment">#-- 列表解析语法</span>\n    M <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">]</span>\n    res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">sum</span><span class="token punctuation">(</span>row<span class="token punctuation">)</span> <span class="token keyword">for</span> row <span class="token keyword">in</span> M<span class="token punctuation">]</span>                     <span class="token comment"># G = [6, 15, 24] 一般的列表解析 生成一个列表</span>\n    res <span class="token operator">=</span> <span class="token punctuation">[</span>c <span class="token operator">*</span> <span class="token number">2</span> <span class="token keyword">for</span> c <span class="token keyword">in</span> <span class="token string">\'spam\'</span><span class="token punctuation">]</span>                     <span class="token comment"># [\'ss\', \'pp\', \'aa\', \'mm\']</span>\n    res <span class="token operator">=</span> <span class="token punctuation">[</span>a <span class="token operator">*</span> b <span class="token keyword">for</span> a <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token keyword">for</span> b <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">]</span>     <span class="token comment"># 多解析过程 返回[4, 5, 8, 10]</span>\n    res <span class="token operator">=</span> <span class="token punctuation">[</span>a <span class="token keyword">for</span> a <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token keyword">if</span> a <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">]</span>             <span class="token comment"># 带判断条件的解析过程</span>\n    res <span class="token operator">=</span> <span class="token punctuation">[</span>a <span class="token keyword">if</span> a <span class="token operator">></span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">for</span> a <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>     <span class="token comment"># 带判断条件的高级解析过程</span>\n    <span class="token comment"># 两个列表同时解析：使用zip函数</span>\n    <span class="token keyword">for</span> teama<span class="token punctuation">,</span> teamb <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"Packers"</span><span class="token punctuation">,</span> <span class="token string">"49ers"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">"Ravens"</span><span class="token punctuation">,</span> <span class="token string">"Patriots"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>teama <span class="token operator">+</span> <span class="token string">" vs. "</span> <span class="token operator">+</span> teamb<span class="token punctuation">)</span>\n    <span class="token comment"># 带索引的列表解析：使用enumerate函数</span>\n    <span class="token keyword">for</span> index<span class="token punctuation">,</span> team <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"Packers"</span><span class="token punctuation">,</span> <span class="token string">"49ers"</span><span class="token punctuation">,</span> <span class="token string">"Ravens"</span><span class="token punctuation">,</span> <span class="token string">"Patriots"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> team<span class="token punctuation">)</span>                            <span class="token comment"># 输出0, Packers \\n 1, 49ers \\n ......</span>\n\n<span class="token comment">#-- 生成器表达式</span>\n    G <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token builtin">sum</span><span class="token punctuation">(</span>row<span class="token punctuation">)</span> <span class="token keyword">for</span> row <span class="token keyword">in</span> M<span class="token punctuation">)</span>                       <span class="token comment"># 使用小括号可以创建所需结果的生成器generator object</span>\n    <span class="token builtin">next</span><span class="token punctuation">(</span>G<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">next</span><span class="token punctuation">(</span>G<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">next</span><span class="token punctuation">(</span>G<span class="token punctuation">)</span>                         <span class="token comment"># 输出(6, 15, 24)</span>\n    G <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token builtin">sum</span><span class="token punctuation">(</span>row<span class="token punctuation">)</span> <span class="token keyword">for</span> row <span class="token keyword">in</span> M<span class="token punctuation">}</span>                       <span class="token comment"># G = {6, 15, 24} 解析语法还可以生成集合和字典</span>\n    G <span class="token operator">=</span> <span class="token punctuation">{</span>i<span class="token punctuation">:</span><span class="token builtin">sum</span><span class="token punctuation">(</span>M<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">}</span>               <span class="token comment"># G = {0: 6, 1: 15, 2: 24}</span>\n\n<span class="token comment">#-- 文档字符串:出现在Module的开端以及其中函数或类的开端 使用三重引号字符串</span>\n    <span class="token triple-quoted-string string">"""\n    module document\n    """</span>\n    <span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token triple-quoted-string string">"""\n        function document\n        """</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">class</span> <span class="token class-name">Employee</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token triple-quoted-string string">"""\n        class document\n        """</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span>func<span class="token punctuation">.</span>__doc__<span class="token punctuation">)</span>                <span class="token comment"># 输出函数文档字符串</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span>Employee<span class="token punctuation">.</span>__doc__<span class="token punctuation">)</span>            <span class="token comment"># 输出类的文档字符串</span>\n\n<span class="token comment">#-- 命名惯例:</span>\n    <span class="token triple-quoted-string string">"""\n    以单一下划线开头的变量名(_X)不会被from module import*等语句导入\n    前后有两个下划线的变量名(__X__)是系统定义的变量名，对解释器有特殊意义\n    以两个下划线开头但不以下划线结尾的变量名(__X)是类的本地(私有)变量\n    """</span>\n\n<span class="token comment">#-- 列表解析 in成员关系测试 map sorted zip enumerate内置函数等都使用了迭代协议</span>\n    <span class="token string">\'first line\'</span> <span class="token keyword">in</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'test.txt\'</span><span class="token punctuation">)</span>   <span class="token comment"># in测试 返回True或False</span>\n    <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">.</span>upper<span class="token punctuation">,</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'t\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment"># map内置函数</span>\n    <span class="token builtin">sorted</span><span class="token punctuation">(</span><span class="token builtin">iter</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token comment"># sorted内置函数</span>\n    <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>          <span class="token comment"># zip内置函数 [(1, 3), (2, 4)]</span>\n\n<span class="token comment">#-- del语句: 手动删除某个变量</span>\n    <span class="token keyword">del</span> X\n\n<span class="token comment">#-- 获取列表的子表的方法:</span>\n    x <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span>\n    x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span>                              <span class="token comment"># 前3个[1,2,3]</span>\n    x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span>                             <span class="token comment"># 中间4个[2,3,4,5]</span>\n    x<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">]</span>                             <span class="token comment"># 最后3个[4,5,6]</span>\n    x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>                             <span class="token comment"># 奇数项[1,3,5]</span>\n    x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>                            <span class="token comment"># 偶数项[2,4,6]</span>\n\n<span class="token comment">#-- 手动迭代：iter和next</span>\n    L <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>\n    I <span class="token operator">=</span> <span class="token builtin">iter</span><span class="token punctuation">(</span>L<span class="token punctuation">)</span>                        <span class="token comment"># I为L的迭代器</span>\n    I<span class="token punctuation">.</span><span class="token builtin">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                           <span class="token comment"># 返回1</span>\n    I<span class="token punctuation">.</span><span class="token builtin">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                           <span class="token comment"># 返回2</span>\n    I<span class="token punctuation">.</span><span class="token builtin">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                           <span class="token comment"># Error:StopIteration</span>\n\n<span class="token comment">#-- Python中的可迭代对象</span>\n    <span class="token triple-quoted-string string">"""\n    1.range迭代器\n    2.map、zip和filter迭代器\n    3.字典视图迭代器：D.keys()), D.items()等\n    4.文件类型\n    """</span>\n\n\n<span class="token triple-quoted-string string">"""函数语法规则----函数语法规则----函数语法规则----函数语法规则----函数语法规则----函数语法规则----函数语法规则----函数语法规则----函数语法规则----函数语法规则"""</span>\n\n<span class="token comment">#-- 函数相关的语句和表达式</span>\n    myfunc<span class="token punctuation">(</span><span class="token string">\'spam\'</span><span class="token punctuation">)</span>                     <span class="token comment"># 函数调用</span>\n    <span class="token keyword">def</span> <span class="token function">myfunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                      <span class="token comment"># 函数定义</span>\n    <span class="token keyword">return</span> <span class="token boolean">None</span>                        <span class="token comment"># 函数返回值</span>\n    <span class="token keyword">global</span> a                           <span class="token comment"># 全局变量</span>\n    <span class="token keyword">nonlocal</span> x                         <span class="token comment"># 在函数或其他作用域中使用外层（非全局）变量</span>\n    <span class="token keyword">yield</span> x                            <span class="token comment"># 生成器函数返回</span>\n    <span class="token keyword">lambda</span>                             <span class="token comment"># 匿名函数</span>\n\n<span class="token comment">#-- Python函数变量名解析:LEGB原则，即:</span>\n    <span class="token triple-quoted-string string">"""\n    local(functin) --> encloseing function locals --> global(module) --> build-in(python)\n    说明:以下边的函数maker为例 则相对于action而言 X为Local N为Encloseing\n    """</span>\n\n<span class="token comment">#-- 嵌套函数举例:工厂函数</span>\n    <span class="token keyword">def</span> <span class="token function">maker</span><span class="token punctuation">(</span>N<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">action</span><span class="token punctuation">(</span>X<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> X <span class="token operator">**</span> N\n        <span class="token keyword">return</span> action\n    f <span class="token operator">=</span> maker<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>                       <span class="token comment"># pass 2 to N</span>\n    f<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>                               <span class="token comment"># 9, pass 3 to X</span>\n\n<span class="token comment">#-- 嵌套函数举例:lambda实例</span>\n    <span class="token keyword">def</span> <span class="token function">maker</span><span class="token punctuation">(</span>N<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        action <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">lambda</span> X<span class="token punctuation">:</span> X<span class="token operator">**</span>N<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> action\n    f <span class="token operator">=</span> maker<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>                       <span class="token comment"># pass 2 to N</span>\n    f<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>                               <span class="token comment"># 9, pass 3 to X</span>\n\n<span class="token comment">#-- nonlocal和global语句的区别</span>\n    <span class="token comment"># nonlocal应用于一个嵌套的函数的作用域中的一个名称 例如:</span>\n    start <span class="token operator">=</span> <span class="token number">100</span>\n    <span class="token keyword">def</span> <span class="token function">tester</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">nested</span><span class="token punctuation">(</span>label<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">nonlocal</span> start             <span class="token comment"># 指定start为tester函数内的local变量 而不是global变量start</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span>label<span class="token punctuation">,</span> start<span class="token punctuation">)</span>\n            start <span class="token operator">+=</span> <span class="token number">3</span>\n        <span class="token keyword">return</span> nested\n    <span class="token comment"># global为全局的变量 即def之外的变量</span>\n    <span class="token keyword">def</span> <span class="token function">tester</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">nested</span><span class="token punctuation">(</span>label<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">global</span> start               <span class="token comment"># 指定start为global变量start</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span>label<span class="token punctuation">,</span> start<span class="token punctuation">)</span>\n            start <span class="token operator">+=</span> <span class="token number">3</span>\n        <span class="token keyword">return</span> nested\n\n<span class="token comment">#-- 函数参数，不可变参数通过“值”传递，可变参数通过“引用”传递</span>\n    <span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span>\n    f<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>                         <span class="token comment"># 参数位置匹配</span>\n    f<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> c <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span>                 <span class="token comment"># 参数关键字匹配</span>\n    <span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> c<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span>\n    f<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>                               <span class="token comment"># 默认参数匹配</span>\n    f<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>                            <span class="token comment"># 默认参数匹配</span>\n    f<span class="token punctuation">(</span>a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> c <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">)</span>                    <span class="token comment"># 关键字参数和默认参数的混合</span>\n    <span class="token comment"># Keyword-Only参数:出现在*args之后 必须用关键字进行匹配</span>\n    <span class="token keyword">def</span> <span class="token function">keyOnly</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token operator">*</span>b<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'\'</span><span class="token punctuation">)</span>   <span class="token comment"># c就为keyword-only匹配 必须使用关键字c = value匹配</span>\n    <span class="token keyword">def</span> <span class="token function">keyOnly</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment"># b c为keyword-only匹配 必须使用关键字匹配</span>\n    <span class="token keyword">def</span> <span class="token function">keyOnly</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   <span class="token comment"># b有默认值 或者省略 或者使用关键字参数b = value</span>\n\n<span class="token comment">#-- 可变参数匹配: * 和 **</span>\n    <span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>          <span class="token comment"># 在元组中收集不匹配的位置参数</span>\n    f<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>                         <span class="token comment"># 输出(1, 2, 3)</span>\n    <span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token operator">**</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>         <span class="token comment"># 在字典中收集不匹配的关键字参数</span>\n    f<span class="token punctuation">(</span>a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span>                    <span class="token comment"># 输出{\'a\':1, \'b\':2}</span>\n    <span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token operator">*</span>b<span class="token punctuation">,</span> <span class="token operator">**</span>c<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span>  <span class="token comment"># 两者混合使用</span>\n    f<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> x<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>               <span class="token comment"># 输出1, (2, 3), {\'x\':4, \'y\':5}</span>\n\n<span class="token comment">#-- 函数调用时的参数解包: * 和 ** 分别解包元组和字典</span>\n    func<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token operator">&lt;=</span><span class="token operator">=</span><span class="token operator">></span>  func<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>\n    func<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">**</span><span class="token punctuation">{</span><span class="token string">\'c\'</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token operator">&lt;=</span><span class="token operator">=</span><span class="token operator">></span>  func<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> c <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">)</span>\n    func<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">**</span><span class="token punctuation">{</span><span class="token string">\'c\'</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token operator">&lt;=</span><span class="token operator">=</span><span class="token operator">></span>  func<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> c <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">)</span>\n\n<span class="token comment">#-- 函数属性:(自己定义的)函数可以添加属性</span>\n    <span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n    func<span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">1</span>                     <span class="token comment"># 自定义函数添加属性</span>\n    <span class="token keyword">print</span><span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">1</span>                    <span class="token comment"># Error 内置函数不可以添加属性</span>\n\n<span class="token comment">#-- 函数注解: 编写在def头部行 主要用于说明参数范围、参数类型、返回值类型等</span>\n    <span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span>a<span class="token punctuation">:</span><span class="token string">\'spam\'</span><span class="token punctuation">,</span> b<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> c<span class="token punctuation">:</span><span class="token builtin">float</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">int</span> <span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span>\n    func<span class="token punctuation">.</span>__annotations__               <span class="token comment"># {\'c\':&lt;class \'float\'>, \'b\':(1, 10), \'a\':\'spam\', \'return\':&lt;class \'int\'>}</span>\n    <span class="token comment"># 编写注解的同时 还是可以使用函数默认值 并且注解的位置位于=号的前边</span>\n    <span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span>a<span class="token punctuation">:</span><span class="token string">\'spam\'</span><span class="token operator">=</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> b<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> c<span class="token punctuation">:</span><span class="token builtin">float</span><span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">int</span> <span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span>\n\n<span class="token comment">#-- 匿名函数:lambda</span>\n    f <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z <span class="token punctuation">:</span> x <span class="token operator">+</span> y <span class="token operator">+</span> z     <span class="token comment"># 普通匿名函数，使用方法f(1, 2, 3)</span>\n    f <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> y <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">:</span> x <span class="token operator">+</span> y     <span class="token comment"># 带默认参数的lambda函数</span>\n    <span class="token keyword">def</span> <span class="token function">action</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>                     <span class="token comment"># 嵌套lambda函数</span>\n        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">lambda</span> y <span class="token punctuation">:</span> x <span class="token operator">+</span> y<span class="token punctuation">)</span>\n    f <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> a <span class="token keyword">if</span> xxx<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> b      <span class="token comment"># 无参数的lambda函数，使用方法f()</span>\n\n<span class="token comment">#-- lambda函数与map filter reduce函数的结合</span>\n    <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>              <span class="token comment"># [2, 3, 4]</span>\n    <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token comment"># [1, 2, 3, 4]</span>\n    functools<span class="token punctuation">.</span><span class="token builtin">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> x <span class="token operator">+</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token comment"># 6</span>\n    functools<span class="token punctuation">.</span><span class="token builtin">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> x <span class="token operator">*</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token comment"># 24</span>\n\n<span class="token comment">#-- 生成器函数:yield VS return</span>\n    <span class="token keyword">def</span> <span class="token function">gensquare</span><span class="token punctuation">(</span>N<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>N<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">yield</span> i<span class="token operator">**</span> <span class="token number">2</span>                <span class="token comment"># 状态挂起 可以恢复到此时的状态</span>\n    <span class="token keyword">for</span> i <span class="token keyword">in</span> gensquare<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>             <span class="token comment"># 使用方法</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> end <span class="token operator">=</span> <span class="token string">\' \'</span><span class="token punctuation">)</span>            <span class="token comment"># [0, 1, 4, 9, 16]</span>\n    x <span class="token operator">=</span> gensquare<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>                   <span class="token comment"># x是一个生成对象</span>\n    <span class="token builtin">next</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>                            <span class="token comment"># 等同于x.__next__() 返回0</span>\n    <span class="token builtin">next</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>                            <span class="token comment"># 等同于x.__next__() 返回1</span>\n    <span class="token builtin">next</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>                            <span class="token comment"># 等同于x.__next__() 抛出异常StopIteration</span>\n\n<span class="token comment">#-- 生成器表达式:小括号进行列表解析</span>\n    G <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">**</span> <span class="token number">2</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>     <span class="token comment"># 使用小括号可以创建所需结果的生成器generator object</span>\n    <span class="token builtin">next</span><span class="token punctuation">(</span>G<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">next</span><span class="token punctuation">(</span>G<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">next</span><span class="token punctuation">(</span>G<span class="token punctuation">)</span>          <span class="token comment"># 和上述中的生成器函数的返回值一致</span>\n    <span class="token comment">#（1）生成器(生成器函数/生成器表达式)是单个迭代对象</span>\n    G <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">**</span> <span class="token number">2</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    I1 <span class="token operator">=</span> <span class="token builtin">iter</span><span class="token punctuation">(</span>G<span class="token punctuation">)</span>                       <span class="token comment"># 这里实际上iter(G) = G</span>\n    <span class="token builtin">next</span><span class="token punctuation">(</span>I1<span class="token punctuation">)</span>                           <span class="token comment"># 输出0</span>\n    <span class="token builtin">next</span><span class="token punctuation">(</span>G<span class="token punctuation">)</span>                            <span class="token comment"># 输出1</span>\n    <span class="token builtin">next</span><span class="token punctuation">(</span>I1<span class="token punctuation">)</span>                           <span class="token comment"># 输出4</span>\n    <span class="token comment">#（2）生成器不保留迭代后的结果</span>\n    gen <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token number">2</span> <span class="token keyword">in</span> gen                           <span class="token comment"># 返回True</span>\n    <span class="token number">3</span> <span class="token keyword">in</span> gen                           <span class="token comment"># 返回True</span>\n    <span class="token number">1</span> <span class="token keyword">in</span> gen                           <span class="token comment"># 返回False，其实检测2的时候，1已经就不在生成器中了，即1已经被迭代过了，同理2、3也不在了</span>\n\n<span class="token comment">#-- 本地变量是静态检测的</span>\n    X <span class="token operator">=</span> <span class="token number">22</span>                             <span class="token comment"># 全局变量X的声明和定义</span>\n    <span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>X<span class="token punctuation">)</span>                       <span class="token comment"># 如果没有下一语句 则该句合法 打印全局变量X</span>\n        X <span class="token operator">=</span> <span class="token number">88</span>                         <span class="token comment"># 这一语句使得上一语句非法 因为它使得X变成了本地变量 上一句变成了打印一个未定义的本地变量(局部变量)</span>\n        <span class="token keyword">if</span> <span class="token boolean">False</span><span class="token punctuation">:</span>                      <span class="token comment"># 即使这样的语句 也会把print语句视为非法语句 因为:</span>\n            X <span class="token operator">=</span> <span class="token number">88</span>                     <span class="token comment"># Python会无视if语句而仍然声明了局部变量X</span>\n    <span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                        <span class="token comment"># 改进</span>\n        <span class="token keyword">global</span> X                       <span class="token comment"># 声明变量X为全局变量</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>X<span class="token punctuation">)</span>                       <span class="token comment"># 打印全局变量X</span>\n        X <span class="token operator">=</span> <span class="token number">88</span>                         <span class="token comment"># 改变全局变量X</span>\n\n<span class="token comment">#-- 函数的默认值是在函数定义的时候实例化的 而不是在调用的时候 例子:</span>\n    <span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span>numbers<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>               <span class="token comment"># 这里的[]是可变的</span>\n        numbers<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n    foo<span class="token punctuation">(</span><span class="token punctuation">)</span>                              <span class="token comment"># first time, like before, [9]</span>\n    foo<span class="token punctuation">(</span><span class="token punctuation">)</span>                              <span class="token comment"># second time, not like before, [9, 9]</span>\n    foo<span class="token punctuation">(</span><span class="token punctuation">)</span>                              <span class="token comment"># third time, not like before too, [9, 9, 9]</span>\n    <span class="token comment"># 改进:</span>\n    <span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span>numbers<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> numbers <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span> numbers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n        numbers<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>\n    <span class="token comment"># 另外一个例子 参数的默认值为不可变的:</span>\n    <span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span>count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                  <span class="token comment"># 这里的0是数字, 是不可变的</span>\n        count <span class="token operator">+=</span> <span class="token number">1</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span>\n    foo<span class="token punctuation">(</span><span class="token punctuation">)</span>                              <span class="token comment"># 输出1</span>\n    foo<span class="token punctuation">(</span><span class="token punctuation">)</span>                              <span class="token comment"># 还是输出1</span>\n    foo<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>                             <span class="token comment"># 输出4</span>\n    foo<span class="token punctuation">(</span><span class="token punctuation">)</span>                              <span class="token comment"># 还是输出1</span>\n\n\n<span class="token triple-quoted-string string">"""函数例子----函数例子----函数例子----函数例子----函数例子----函数例子----函数例子----函数例子----函数例子----函数例子----函数例子----函数例子----函数例子"""</span>\n\n    <span class="token triple-quoted-string string">"""数学运算类"""</span>\n    <span class="token builtin">abs</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>                              <span class="token comment"># 求绝对值，参数可以是整型，也可以是复数，若参数是复数，则返回复数的模</span>\n    <span class="token builtin">complex</span><span class="token punctuation">(</span><span class="token punctuation">[</span>real<span class="token punctuation">[</span><span class="token punctuation">,</span> imag<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>             <span class="token comment"># 创建一个复数</span>\n    <span class="token builtin">divmod</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>                        <span class="token comment"># 分别取商和余数，注意：整型、浮点型都可以</span>\n    <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">)</span>                          <span class="token comment"># 将一个字符串或数转换为浮点数。如果无参数将返回0.0</span>\n    <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">[</span><span class="token punctuation">,</span> base<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                    <span class="token comment"># 将一个字符串或浮点数转换为int类型，base表示进制</span>\n    <span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">[</span><span class="token punctuation">,</span> base<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                   <span class="token comment"># 将一个字符串或浮点数转换为long类型</span>\n    <span class="token builtin">pow</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>                           <span class="token comment"># 返回x的y次幂</span>\n    <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token punctuation">[</span>start<span class="token punctuation">]</span><span class="token punctuation">,</span> stop<span class="token punctuation">[</span><span class="token punctuation">,</span> step<span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token comment"># 产生一个序列，默认从0开始</span>\n    <span class="token builtin">round</span><span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token punctuation">,</span> n<span class="token punctuation">]</span><span class="token punctuation">)</span>                       <span class="token comment"># 四舍五入</span>\n    <span class="token builtin">sum</span><span class="token punctuation">(</span>iterable<span class="token punctuation">[</span><span class="token punctuation">,</span> start<span class="token punctuation">]</span><span class="token punctuation">)</span>              <span class="token comment"># 对集合求和</span>\n    <span class="token builtin">oct</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>                              <span class="token comment"># 将一个数字转化为8进制字符串</span>\n    <span class="token builtin">hex</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>                              <span class="token comment"># 将一个数字转换为16进制字符串</span>\n    <span class="token builtin">chr</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>                              <span class="token comment"># 返回给定int类型对应的ASCII字符</span>\n    <span class="token builtin">unichr</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>                           <span class="token comment"># 返回给定int类型的unicode</span>\n    <span class="token builtin">ord</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>                              <span class="token comment"># 返回ASCII字符对应的整数</span>\n    <span class="token builtin">bin</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>                              <span class="token comment"># 将整数x转换为二进制字符串</span>\n    <span class="token builtin">bool</span><span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">)</span>                           <span class="token comment"># 将x转换为Boolean类型</span>\n\n    <span class="token triple-quoted-string string">"""集合类操作"""</span>\n    <span class="token builtin">basestring</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                        <span class="token comment"># str和unicode的超类，不能直接调用，可以用作isinstance判断</span>\n    <span class="token builtin">format</span><span class="token punctuation">(</span>value <span class="token punctuation">[</span><span class="token punctuation">,</span> format_spec<span class="token punctuation">]</span><span class="token punctuation">)</span>       <span class="token comment"># 格式化输出字符串，格式化的参数顺序从0开始，如“I am {0},I like {1}”</span>\n    <span class="token builtin">enumerate</span><span class="token punctuation">(</span>sequence<span class="token punctuation">[</span><span class="token punctuation">,</span> start<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>      <span class="token comment"># 返回一个可枚举的对象，注意它有第二个参数</span>\n    <span class="token builtin">iter</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token punctuation">,</span> sentinel<span class="token punctuation">]</span><span class="token punctuation">)</span>               <span class="token comment"># 生成一个对象的迭代器，第二个参数表示分隔符</span>\n    <span class="token builtin">max</span><span class="token punctuation">(</span>iterable<span class="token punctuation">[</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>       <span class="token comment"># 返回集合中的最大值</span>\n    <span class="token builtin">min</span><span class="token punctuation">(</span>iterable<span class="token punctuation">[</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>       <span class="token comment"># 返回集合中的最小值</span>\n    <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">[</span>arg<span class="token punctuation">]</span><span class="token punctuation">)</span>                         <span class="token comment"># 创建数据字典</span>\n    <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">[</span>iterable<span class="token punctuation">]</span><span class="token punctuation">)</span>                    <span class="token comment"># 将一个集合类转换为另外一个集合类</span>\n    <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                               <span class="token comment"># set对象实例化</span>\n    <span class="token builtin">frozenset</span><span class="token punctuation">(</span><span class="token punctuation">[</span>iterable<span class="token punctuation">]</span><span class="token punctuation">)</span>               <span class="token comment"># 产生一个不可变的set</span>\n    <span class="token builtin">tuple</span><span class="token punctuation">(</span><span class="token punctuation">[</span>iterable<span class="token punctuation">]</span><span class="token punctuation">)</span>                   <span class="token comment"># 生成一个tuple类型</span>\n    <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">object</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                       <span class="token comment"># 转换为string类型</span>\n    <span class="token builtin">sorted</span><span class="token punctuation">(</span>iterable<span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token builtin">cmp</span><span class="token punctuation">[</span><span class="token punctuation">,</span> key<span class="token punctuation">[</span><span class="token punctuation">,</span> reverse<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>             <span class="token comment"># 集合排序</span>\n        L <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">\'b\'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">\'c\'</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">\'d\'</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n        <span class="token builtin">sorted</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>       <span class="token comment"># 使用Key参数和reverse参数</span>\n        <span class="token builtin">sorted</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>             <span class="token comment"># 使用key参数进行多条件排序，即如果x[0]相同，则比较x[1]</span>\n\n    <span class="token triple-quoted-string string">"""逻辑判断"""</span>\n    <span class="token builtin">all</span><span class="token punctuation">(</span>iterable<span class="token punctuation">)</span>                       <span class="token comment"># 集合中的元素都为真的时候为真，特别的，若为空串返回为True</span>\n    <span class="token builtin">any</span><span class="token punctuation">(</span>iterable<span class="token punctuation">)</span>                       <span class="token comment"># 集合中的元素有一个为真的时候为真，特别的，若为空串返回为False</span>\n    <span class="token builtin">cmp</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>                           <span class="token comment"># 如果x &lt; y ,返回负数；x == y, 返回0；x > y,返回正数</span>\n\n    <span class="token triple-quoted-string string">"""IO操作"""</span>\n    <span class="token builtin">file</span><span class="token punctuation">(</span>filename <span class="token punctuation">[</span><span class="token punctuation">,</span> mode <span class="token punctuation">[</span><span class="token punctuation">,</span> bufsize<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># file类型的构造函数。</span>\n    <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token punctuation">[</span>prompt<span class="token punctuation">]</span><span class="token punctuation">)</span>                     <span class="token comment"># 获取用户输入，推荐使用raw_input，因为该函数将不会捕获用户的错误输入，意思是自行判断类型</span>\n    <span class="token comment"># 在 Built-in Functions 里有一句话是这样写的：Consider using the raw_input() function for general input from users.</span>\n    <span class="token builtin">raw_input</span><span class="token punctuation">(</span><span class="token punctuation">[</span>prompt<span class="token punctuation">]</span><span class="token punctuation">)</span>                 <span class="token comment"># 设置输入，输入都是作为字符串处理</span>\n    <span class="token builtin">open</span><span class="token punctuation">(</span>name<span class="token punctuation">[</span><span class="token punctuation">,</span> mode<span class="token punctuation">[</span><span class="token punctuation">,</span> buffering<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>     <span class="token comment"># 打开文件，与file有什么不同？推荐使用open</span>\n\n    <span class="token triple-quoted-string string">"""其他"""</span>\n    <span class="token builtin">callable</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span>                    <span class="token comment"># 检查对象object是否可调用</span>\n    <span class="token builtin">classmethod</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span>                   <span class="token comment"># 用来说明这个func是个类方法</span>\n    <span class="token builtin">staticmethod</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span>                  <span class="token comment"># 用来说明这个func为静态方法</span>\n    <span class="token builtin">dir</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">object</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                       <span class="token comment"># 不带参数时，返回当前范围内的变量、方法和定义的类型列表；带参数时，返回参数的属性、方法列表。</span>\n    <span class="token builtin">help</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>                           <span class="token comment"># 返回obj的帮助信息</span>\n    <span class="token builtin">eval</span><span class="token punctuation">(</span>expression<span class="token punctuation">)</span>                    <span class="token comment"># 计算表达式expression的值，并返回</span>\n    <span class="token keyword">exec</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">)</span>                           <span class="token comment"># 将str作为Python语句执行</span>\n    <span class="token builtin">execfile</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span>                  <span class="token comment"># 用法类似exec()，不同的是execfile的参数filename为文件名，而exec的参数为字符串。</span>\n    <span class="token builtin">filter</span><span class="token punctuation">(</span>function<span class="token punctuation">,</span> iterable<span class="token punctuation">)</span>          <span class="token comment"># 构造一个序列，等价于[item for item in iterable if function(item)]，function返回值为True或False的函数</span>\n        <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># 返回[-3, -2, -1, 1, 2, 3], 没有0</span>\n    <span class="token builtin">hasattr</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>               <span class="token comment"># 判断对象object是否包含名为name的特性</span>\n    <span class="token builtin">getattr</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">,</span> name <span class="token punctuation">[</span><span class="token punctuation">,</span> defalut<span class="token punctuation">]</span><span class="token punctuation">)</span>   <span class="token comment"># 获取一个类的属性</span>\n    <span class="token builtin">setattr</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>        <span class="token comment"># 设置属性值</span>\n    <span class="token builtin">delattr</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>               <span class="token comment"># 删除object对象名为name的属性</span>\n    <span class="token builtin">globals</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                           <span class="token comment"># 返回一个描述当前全局符号表的字典</span>\n    <span class="token builtin">hash</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span>                        <span class="token comment"># 如果对象object为哈希表类型，返回对象object的哈希值</span>\n    <span class="token builtin">id</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span>                          <span class="token comment"># 返回对象的唯一标识，一串数字</span>\n    <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">,</span> classinfo<span class="token punctuation">)</span>       <span class="token comment"># 判断object是否是class的实例</span>\n        <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span>              <span class="token comment"># 判断是不是int类型</span>\n        <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">)</span>     <span class="token comment"># isinstance的第二个参数接受一个元组类型</span>\n    <span class="token builtin">issubclass</span><span class="token punctuation">(</span><span class="token keyword">class</span><span class="token punctuation">,</span> classinfo<span class="token punctuation">)</span>        <span class="token comment"># 判断class是否为classinfo的子类</span>\n    <span class="token builtin">locals</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                            <span class="token comment"># 返回当前的变量列表</span>\n    <span class="token builtin">map</span><span class="token punctuation">(</span>function<span class="token punctuation">,</span> iterable<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>        <span class="token comment"># 遍历每个元素，执行function操作</span>\n        <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token builtin">abs</span><span class="token punctuation">,</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment"># 返回[3, 2, 1, 0, 1, 2, 3]</span>\n    <span class="token builtin">next</span><span class="token punctuation">(</span>iterator<span class="token punctuation">[</span><span class="token punctuation">,</span> default<span class="token punctuation">]</span><span class="token punctuation">)</span>           <span class="token comment"># 类似于iterator.next()</span>\n    <span class="token builtin">property</span><span class="token punctuation">(</span><span class="token punctuation">[</span>fget<span class="token punctuation">[</span><span class="token punctuation">,</span> fset<span class="token punctuation">[</span><span class="token punctuation">,</span> fdel<span class="token punctuation">[</span><span class="token punctuation">,</span> doc<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>           <span class="token comment"># 属性访问的包装类，设置后可以通过c.x=value等来访问setter和getter</span>\n    <span class="token builtin">reduce</span><span class="token punctuation">(</span>function<span class="token punctuation">,</span> iterable<span class="token punctuation">[</span><span class="token punctuation">,</span> initializer<span class="token punctuation">]</span><span class="token punctuation">)</span>         <span class="token comment"># 合并操作，从第一个开始是前两个参数，然后是前两个的结果与第三个合并进行处理，以此类推</span>\n        <span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">return</span> x <span class="token operator">+</span> y\n        <span class="token builtin">reduce</span><span class="token punctuation">(</span>add<span class="token punctuation">,</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                     <span class="token comment"># 返回55 (注:1+2+3+4+5+6+7+8+9+10 = 55)</span>\n        <span class="token builtin">reduce</span><span class="token punctuation">(</span>add<span class="token punctuation">,</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span>                 <span class="token comment"># 返回75</span>\n    <span class="token builtin">reload</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span>                      <span class="token comment"># 重新加载模块</span>\n    <span class="token builtin">repr</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span>                        <span class="token comment"># 将一个对象变幻为可打印的格式</span>\n    <span class="token builtin">slice</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> stop<span class="token punctuation">[</span><span class="token punctuation">,</span> step<span class="token punctuation">]</span><span class="token punctuation">)</span>          <span class="token comment"># 产生分片对象</span>\n    <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span>                        <span class="token comment"># 返回该object的类型</span>\n    <span class="token builtin">vars</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">object</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                      <span class="token comment"># 返回对象的变量名、变量值的字典</span>\n        a <span class="token operator">=</span> Class<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment"># Class为一个空类</span>\n        a<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">\'qi\'</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">9</span>\n        <span class="token builtin">vars</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>                         <span class="token comment"># {\'name\':\'qi\', \'age\':9}</span>\n    <span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token punctuation">[</span>iterable<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                <span class="token comment"># 返回对应数组</span>\n        <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># [(1, 4), (2, 5), (3, 6)]</span>\n        a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  b <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">]</span>\n        z <span class="token operator">=</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>                   <span class="token comment"># 压缩：[(1, "a"), (2, "b"), (3, "c")]</span>\n        <span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token operator">*</span>z<span class="token punctuation">)</span>                         <span class="token comment"># 解压缩：[(1, 2, 3), ("a", "b", "c")]</span>\n    <span class="token builtin">unicode</span><span class="token punctuation">(</span>string<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> errors<span class="token punctuation">)</span>   <span class="token comment"># 将字符串string转化为unicode形式，string为encoded string。</span>\n\n\n<span class="token triple-quoted-string string">"""模块Moudle----模块Moudle----模块Moudle----模块Moudle----模块Moudle----模块Moudle----模块Moudle----模块Moudle----模块Moudle----模块Moudle----模块Moudle"""</span>\n\n<span class="token comment">#-- Python模块搜索路径:</span>\n    <span class="token triple-quoted-string string">"""\n    (1)程序的主目录    (2)PYTHONPATH目录 (3)标准链接库目录 (4)任何.pth文件的内容\n    """</span>\n\n<span class="token comment">#-- 查看全部的模块搜索路径</span>\n    <span class="token keyword">import</span> sys\n    sys<span class="token punctuation">.</span>path\n    sys<span class="token punctuation">.</span>argv                            <span class="token comment"># 获得脚本的参数</span>\n    sys<span class="token punctuation">.</span>builtin_module_names            <span class="token comment"># 查找内建模块</span>\n    sys<span class="token punctuation">.</span>platform                        <span class="token comment"># 返回当前平台 出现如： "win32" "linux" "darwin"等</span>\n    sys<span class="token punctuation">.</span>modules                         <span class="token comment"># 查找已导入的模块</span>\n    sys<span class="token punctuation">.</span>modules<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    sys<span class="token punctuation">.</span>stdout                          <span class="token comment"># stdout 和 stderr 都是类文件对象，但是它们都是只写的。它们都没有 read 方法，只有 write 方法</span>\n    sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span>\n    sys<span class="token punctuation">.</span>stderr\n    sys<span class="token punctuation">.</span>stdin\n\n<span class="token comment">#-- 模块的使用代码</span>\n    <span class="token keyword">import</span> module1<span class="token punctuation">,</span> module2             <span class="token comment"># 导入module1 使用module1.printer()</span>\n    <span class="token keyword">from</span> module1 <span class="token keyword">import</span> printer         <span class="token comment"># 导入module1中的printer变量 使用printer()</span>\n    <span class="token keyword">from</span> module1 <span class="token keyword">import</span> <span class="token operator">*</span>               <span class="token comment"># 导入module1中的全部变量 使用不必添加module1前缀</span>\n\n<span class="token comment">#-- 重载模块reload: 这是一个内置函数 而不是一条语句</span>\n    <span class="token keyword">from</span> imp <span class="token keyword">import</span> <span class="token builtin">reload</span>\n    <span class="token builtin">reload</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span>\n\n<span class="token comment">#-- 模块的包导入:使用点号(.)而不是路径(dir1\\dir2)进行导入</span>\n    <span class="token keyword">import</span> dir1<span class="token punctuation">.</span>dir2<span class="token punctuation">.</span>mod                <span class="token comment"># d导入包(目录)dir1中的包dir2中的mod模块 此时dir1必须在Python可搜索路径中</span>\n    <span class="token keyword">from</span> dir1<span class="token punctuation">.</span>dir2<span class="token punctuation">.</span>mod <span class="token keyword">import</span> <span class="token operator">*</span>         <span class="token comment"># from语法的包导入</span>\n\n<span class="token comment">#-- __init__.py包文件:每个导入的包中都应该包含这么一个文件</span>\n    <span class="token triple-quoted-string string">"""\n    该文件可以为空\n    首次进行包导入时 该文件会自动执行\n    高级功能:在该文件中使用__all__列表来定义包(目录)以from*的形式导入时 需要导入什么\n    """</span>\n\n<span class="token comment">#-- 包相对导入:使用点号(.) 只能使用from语句</span>\n    <span class="token keyword">from</span> <span class="token punctuation">.</span> <span class="token keyword">import</span> spam                  <span class="token comment"># 导入当前目录下的spam模块（Python2: 当前目录下的模块, 直接导入即可）</span>\n    <span class="token keyword">from</span> <span class="token punctuation">.</span>spam <span class="token keyword">import</span> name              <span class="token comment"># 导入当前目录下的spam模块的name属性（Python2: 当前目录下的模块, 直接导入即可，不用加.）</span>\n    <span class="token keyword">from</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">import</span> spam                 <span class="token comment"># 导入当前目录的父目录下的spam模块</span>\n\n<span class="token comment">#-- 包相对导入与普通导入的区别</span>\n    <span class="token keyword">from</span> string <span class="token keyword">import</span> <span class="token operator">*</span>                <span class="token comment"># 这里导入的string模块为sys.path路径上的 而不是本目录下的string模块(如果存在也不是)</span>\n    <span class="token keyword">from</span> <span class="token punctuation">.</span>string <span class="token keyword">import</span> <span class="token operator">*</span>               <span class="token comment"># 这里导入的string模块为本目录下的(不存在则导入失败) 而不是sys.path路径上的</span>\n\n<span class="token comment">#-- 模块数据隐藏:最小化from*的破坏</span>\n    _X                                  <span class="token comment"># 变量名前加下划线可以防止from*导入时该变量名被复制出去</span>\n    __all__ <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'x\'</span><span class="token punctuation">,</span> <span class="token string">\'x1\'</span><span class="token punctuation">,</span> <span class="token string">\'x2\'</span><span class="token punctuation">]</span>         <span class="token comment"># 使用__all__列表指定from*时复制出去的变量名(变量名在列表中为字符串形式)</span>\n\n<span class="token comment">#-- 可以使用__name__进行模块的单元测试:当模块为顶层执行文件时值为\'__main__\' 当模块被导入时为模块名</span>\n    <span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">\'__main__\'</span><span class="token punctuation">:</span>\n        doSomething\n    <span class="token comment"># 模块属性中还有其他属性，例如：</span>\n    __doc__                             <span class="token comment"># 模块的说明文档</span>\n    __file__                            <span class="token comment"># 模块文件的文件名，包括全路径</span>\n    __name__                            <span class="token comment"># 主文件或者被导入文件</span>\n    __package__                         <span class="token comment"># 模块所在的包</span>\n\n<span class="token comment">#-- import语句from语句的as扩展</span>\n    <span class="token keyword">import</span> modulename <span class="token keyword">as</span> name\n    <span class="token keyword">from</span> modulename <span class="token keyword">import</span> attrname <span class="token keyword">as</span> name\n\n<span class="token comment">#-- 得到模块属性的几种方法 假设为了得到name属性的值</span>\n    M<span class="token punctuation">.</span>name\n    M<span class="token punctuation">.</span>__dict__<span class="token punctuation">[</span><span class="token string">\'name\'</span><span class="token punctuation">]</span>\n    sys<span class="token punctuation">.</span>modules<span class="token punctuation">[</span><span class="token string">\'M\'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name\n    <span class="token builtin">getattr</span><span class="token punctuation">(</span>M<span class="token punctuation">,</span> <span class="token string">\'name\'</span><span class="token punctuation">)</span>\n\n\n<span class="token triple-quoted-string string">"""类与面向对象----类与面向对象----类与面向对象----类与面向对象----类与面向对象----类与面向对象----类与面向对象----类与面向对象----类与面向对象----类与面向对象"""</span>\n\n<span class="token comment">#-- 最普通的类</span>\n    <span class="token keyword">class</span> <span class="token class-name">C1</span><span class="token punctuation">(</span>C2<span class="token punctuation">,</span> C3<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        spam <span class="token operator">=</span> <span class="token number">42</span>                       <span class="token comment"># 数据属性</span>\n        <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>       <span class="token comment"># 函数属性:构造函数</span>\n            self<span class="token punctuation">.</span>name <span class="token operator">=</span> name\n        <span class="token keyword">def</span> <span class="token function">__del__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>              <span class="token comment"># 函数属性:析构函数</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"goodbey "</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>name<span class="token punctuation">)</span>\n    I1 <span class="token operator">=</span> C1<span class="token punctuation">(</span><span class="token string">\'bob\'</span><span class="token punctuation">)</span>\n\n<span class="token comment">#-- Python的类没有基于参数的函数重载</span>\n    <span class="token keyword">class</span> <span class="token class-name">FirstClass</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> string<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span>\n        <span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>                 <span class="token comment"># 此时类中只有一个test函数 即后者test(self) 它覆盖掉前者带参数的test函数</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"hello world"</span><span class="token punctuation">)</span>\n\n<span class="token comment">#-- 子类扩展超类: 尽量调用超类的方法</span>\n    <span class="token keyword">class</span> <span class="token class-name">Manager</span><span class="token punctuation">(</span>Person<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">giveRaise</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> percent<span class="token punctuation">,</span> bonus <span class="token operator">=</span> <span class="token number">.10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            self<span class="token punctuation">.</span>pay <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>pay<span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> percent <span class="token operator">+</span> bonus<span class="token punctuation">)</span><span class="token punctuation">)</span>     <span class="token comment"># 不好的方式 复制粘贴超类代码</span>\n            Person<span class="token punctuation">.</span>giveRaise<span class="token punctuation">(</span>self<span class="token punctuation">,</span> percent <span class="token operator">+</span> bonus<span class="token punctuation">)</span>            <span class="token comment"># 好的方式 尽量调用超类方法</span>\n\n<span class="token comment">#-- 类内省工具</span>\n    bob <span class="token operator">=</span> Person<span class="token punctuation">(</span><span class="token string">\'bob\'</span><span class="token punctuation">)</span>\n    bob<span class="token punctuation">.</span>__class__                       <span class="token comment"># &lt;class \'Person\'></span>\n    bob<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__              <span class="token comment"># \'Person\'</span>\n    bob<span class="token punctuation">.</span>__dict__                        <span class="token comment"># {\'pay\':0, \'name\':\'bob\', \'job\':\'Manager\'}</span>\n\n<span class="token comment">#-- 返回1中 数据属性spam是属于类 而不是对象</span>\n    I1 <span class="token operator">=</span> C1<span class="token punctuation">(</span><span class="token string">\'bob\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> I2 <span class="token operator">=</span> C2<span class="token punctuation">(</span><span class="token string">\'tom\'</span><span class="token punctuation">)</span>      <span class="token comment"># 此时I1和I2的spam都为42 但是都是返回的C1的spam属性</span>\n    C1<span class="token punctuation">.</span>spam <span class="token operator">=</span> <span class="token number">24</span>                        <span class="token comment"># 此时I1和I2的spam都为24</span>\n    I1<span class="token punctuation">.</span>spam <span class="token operator">=</span> <span class="token number">3</span>                         <span class="token comment"># 此时I1新增自有属性spam 值为3 I2和C1的spam还都为24</span>\n\n<span class="token comment">#-- 类方法调用的两种方式</span>\n    instance<span class="token punctuation">.</span>method<span class="token punctuation">(</span>arg<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>\n    <span class="token keyword">class</span><span class="token punctuation">.</span>method<span class="token punctuation">(</span>instance<span class="token punctuation">,</span> arg<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>\n\n<span class="token comment">#-- 抽象超类的实现方法</span>\n    <span class="token comment"># (1)某个函数中调用未定义的函数 子类中定义该函数</span>\n        <span class="token keyword">def</span> <span class="token function">delegate</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            self<span class="token punctuation">.</span>action<span class="token punctuation">(</span><span class="token punctuation">)</span>               <span class="token comment"># 本类中不定义action函数 所以使用delegate函数时就会出错</span>\n    <span class="token comment"># (2)定义action函数 但是返回异常</span>\n        <span class="token keyword">def</span> <span class="token function">action</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span> NotImplementedError<span class="token punctuation">(</span><span class="token string">"action must be defined"</span><span class="token punctuation">)</span>\n    <span class="token comment"># (3)上述的两种方法还都可以定义实例对象 实际上可以利用@装饰器语法生成不能定义的抽象超类</span>\n        <span class="token keyword">from</span> abc <span class="token keyword">import</span> ABCMeta<span class="token punctuation">,</span> abstractmethod\n        <span class="token keyword">class</span> <span class="token class-name">Super</span><span class="token punctuation">(</span>metaclass <span class="token operator">=</span> ABCMeta<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            @abstractmethod\n            <span class="token keyword">def</span> <span class="token function">action</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">pass</span>\n        x <span class="token operator">=</span> Super<span class="token punctuation">(</span><span class="token punctuation">)</span>                     <span class="token comment"># 返回 TypeError: Can\'t instantiate abstract class Super with abstract methods action</span>\n\n<span class="token comment">#-- # OOP和继承: "is-a"的关系</span>\n    <span class="token keyword">class</span> <span class="token class-name">A</span><span class="token punctuation">(</span>B<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">pass</span>\n    a <span class="token operator">=</span> A<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token builtin">isinstance</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> B<span class="token punctuation">)</span>                    <span class="token comment"># 返回True, A是B的子类 a也是B的一种</span>\n    <span class="token comment"># OOP和组合: "has-a"的关系</span>\n    <span class="token keyword">pass</span>\n    <span class="token comment"># OOP和委托: "包装"对象 在Python中委托通常是以"__getattr__"钩子方法实现的, 这个方法会拦截对不存在属性的读取</span>\n    <span class="token comment"># 包装类(或者称为代理类)可以使用__getattr__把任意读取转发给被包装的对象</span>\n    <span class="token keyword">class</span> <span class="token class-name">wrapper</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            self<span class="token punctuation">.</span>wrapped <span class="token operator">=</span> <span class="token builtin">object</span>\n        <span class="token keyword">def</span> <span class="token function">__getattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> attrname<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Trace: \'</span><span class="token punctuation">,</span> attrname<span class="token punctuation">)</span>\n            <span class="token keyword">return</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>wrapped<span class="token punctuation">,</span> attrname<span class="token punctuation">)</span>\n    <span class="token comment"># 注:这里使用getattr(X, N)内置函数以变量名字符串N从包装对象X中取出属性 类似于X.__dict__[N]</span>\n    x <span class="token operator">=</span> wrapper<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n    x<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>                         <span class="token comment"># 返回 "Trace: append" [1, 2, 3, 4]</span>\n    x <span class="token operator">=</span> wrapper<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'a\'</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">)</span>\n    <span class="token builtin">list</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                      <span class="token comment"># 返回 "Trace: keys" [\'a\', \'b\']</span>\n\n<span class="token comment">#-- 类的伪私有属性:使用__attr</span>\n    <span class="token keyword">class</span> <span class="token class-name">C1</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            self<span class="token punctuation">.</span>__name <span class="token operator">=</span> name          <span class="token comment"># 此时类的__name属性为伪私有属性 原理 它会自动变成self._C1__name = name</span>\n        <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token string">\'self.name = %s\'</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>__name\n    I <span class="token operator">=</span> C1<span class="token punctuation">(</span><span class="token string">\'tom\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span>I<span class="token punctuation">)</span>                            <span class="token comment"># 返回 self.name = tom</span>\n    I<span class="token punctuation">.</span>__name <span class="token operator">=</span> <span class="token string">\'jeey\'</span>                   <span class="token comment"># 这里无法访问 __name为伪私有属性</span>\n    I<span class="token punctuation">.</span>_C1__name <span class="token operator">=</span> <span class="token string">\'jeey\'</span>                <span class="token comment"># 这里可以修改成功 self.name = jeey</span>\n\n<span class="token comment">#-- 类方法是对象:无绑定类方法对象 / 绑定实例方法对象</span>\n    <span class="token keyword">class</span> <span class="token class-name">Spam</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">doit</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>\n        <span class="token keyword">def</span> <span class="token function">selfless</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>\n    obj <span class="token operator">=</span> Spam<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    x <span class="token operator">=</span> obj<span class="token punctuation">.</span>doit                        <span class="token comment"># 类的绑定方法对象 实例 + 函数</span>\n    x<span class="token punctuation">(</span><span class="token string">\'hello world\'</span><span class="token punctuation">)</span>\n    x <span class="token operator">=</span> Spam<span class="token punctuation">.</span>doit                       <span class="token comment"># 类的无绑定方法对象 类名 + 函数</span>\n    x<span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">\'hello world\'</span><span class="token punctuation">)</span>\n    x <span class="token operator">=</span> Spam<span class="token punctuation">.</span>selfless                   <span class="token comment"># 类的无绑定方法函数 在3.0之前无效</span>\n    x<span class="token punctuation">(</span><span class="token string">\'hello world\'</span><span class="token punctuation">)</span>\n\n<span class="token comment">#-- 获取对象信息: 属性和方法</span>\n    a <span class="token operator">=</span> MyObject<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token builtin">dir</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>                              <span class="token comment"># 使用dir函数</span>\n    <span class="token builtin">hasattr</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token string">\'x\'</span><span class="token punctuation">)</span>                     <span class="token comment"># 测试是否有x属性或方法 即a.x是否已经存在</span>\n    <span class="token builtin">setattr</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token string">\'y\'</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">)</span>                 <span class="token comment"># 设置属性或方法 等同于a.y = 19</span>\n    <span class="token builtin">getattr</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token string">\'z\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>                  <span class="token comment"># 获取属性或方法 如果属性不存在 则返回默认值0</span>\n    <span class="token comment">#这里有个小技巧，setattr可以设置一个不能访问到的属性，即只能用getattr获取</span>\n    <span class="token builtin">setattr</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token string">"can\'t touch"</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>      <span class="token comment"># 这里的属性名带有空格，不能直接访问</span>\n    <span class="token builtin">getattr</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token string">"can\'t touch"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token comment"># 但是可以用getattr获取</span>\n\n<span class="token comment">#-- 为类动态绑定属性或方法: MethodType方法</span>\n    <span class="token comment"># 一般创建了一个class的实例后, 可以给该实例绑定任何属性和方法, 这就是动态语言的灵活性</span>\n    <span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">pass</span>\n    s <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    s<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">\'Michael\'</span>                  <span class="token comment"># 动态给实例绑定一个属性</span>\n    <span class="token keyword">def</span> <span class="token function">set_age</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">:</span>             <span class="token comment"># 定义一个函数作为实例方法</span>\n        self<span class="token punctuation">.</span>age <span class="token operator">=</span> age\n    <span class="token keyword">from</span> types <span class="token keyword">import</span> MethodType\n    s<span class="token punctuation">.</span>set_age <span class="token operator">=</span> MethodType<span class="token punctuation">(</span>set_age<span class="token punctuation">,</span> s<span class="token punctuation">)</span>  <span class="token comment"># 给实例绑定一个方法 类的其他实例不受此影响</span>\n    s<span class="token punctuation">.</span>set_age<span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span>                       <span class="token comment"># 调用实例方法</span>\n    Student<span class="token punctuation">.</span>set_age <span class="token operator">=</span> MethodType<span class="token punctuation">(</span>set_age<span class="token punctuation">,</span> Student<span class="token punctuation">)</span>    <span class="token comment"># 为类绑定一个方法 类的所有实例都拥有该方法</span>\n\n\n<span class="token triple-quoted-string string">"""类的高级话题----类的高级话题----类的高级话题----类的高级话题----类的高级话题----类的高级话题----类的高级话题----类的高级话题----类的高级话题----类的高级话题"""</span>\n\n<span class="token comment">#-- 多重继承: "混合类", 搜索方式"从下到上 从左到右 广度优先"</span>\n    <span class="token keyword">class</span> <span class="token class-name">A</span><span class="token punctuation">(</span>B<span class="token punctuation">,</span> C<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">pass</span>\n\n<span class="token comment">#-- 类的继承和子类的初始化</span>\n    <span class="token comment"># 1.子类定义了__init__方法时，若未显示调用基类__init__方法，python不会帮你调用。</span>\n    <span class="token comment"># 2.子类未定义__init__方法时，python会自动帮你调用首个基类的__init__方法，注意是首个。</span>\n    <span class="token comment"># 3.子类显示调用基类的初始化函数：</span>\n    <span class="token keyword">class</span> <span class="token class-name">FooParent</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            self<span class="token punctuation">.</span>parent <span class="token operator">=</span> <span class="token string">\'I\\\'m the Parent.\'</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Parent:a=\'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>\n        <span class="token keyword">def</span> <span class="token function">bar</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span>message <span class="token operator">+</span> <span class="token string">\' from Parent\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">class</span> <span class="token class-name">FooChild</span><span class="token punctuation">(</span>FooParent<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            FooParent<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> a<span class="token punctuation">)</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Child:a=\'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>\n        <span class="token keyword">def</span> <span class="token function">bar</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            FooParent<span class="token punctuation">.</span>bar<span class="token punctuation">(</span>self<span class="token punctuation">,</span> message<span class="token punctuation">)</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span>message <span class="token operator">+</span> <span class="token string">\' from Child\'</span><span class="token punctuation">)</span>\n    fooChild <span class="token operator">=</span> FooChild<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>\n    fooChild<span class="token punctuation">.</span>bar<span class="token punctuation">(</span><span class="token string">\'HelloWorld\'</span><span class="token punctuation">)</span>\n\n<span class="token comment">#-- #实例方法 / 静态方法 / 类方法</span>\n    <span class="token keyword">class</span> <span class="token class-name">Methods</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">imeth</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span>      <span class="token comment"># 实例方法：传入的是实例和数据，操作的是实例的属性</span>\n        <span class="token keyword">def</span> <span class="token function">smeth</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>                  <span class="token comment"># 静态方法：只传入数据 不传入实例，操作的是类的属性而不是实例的属性</span>\n        <span class="token keyword">def</span> <span class="token function">cmeth</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> x<span class="token punctuation">)</span>        <span class="token comment"># 类方法：传入的是类对象和数据</span>\n        smeth <span class="token operator">=</span> <span class="token builtin">staticmethod</span><span class="token punctuation">(</span>smeth<span class="token punctuation">)</span>             <span class="token comment"># 调用内置函数，也可以使用@staticmethod</span>\n        cmeth <span class="token operator">=</span> <span class="token builtin">classmethod</span><span class="token punctuation">(</span>cmeth<span class="token punctuation">)</span>              <span class="token comment"># 调用内置函数，也可以使用@classmethod</span>\n    obj <span class="token operator">=</span> Methods<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    obj<span class="token punctuation">.</span>imeth<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>                                <span class="token comment"># 实例方法调用 &lt;__main__.Methods object...> 1</span>\n    Methods<span class="token punctuation">.</span>imeth<span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>                       <span class="token comment"># &lt;__main__.Methods object...> 2</span>\n    Methods<span class="token punctuation">.</span>smeth<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>                            <span class="token comment"># 静态方法调用 3</span>\n    obj<span class="token punctuation">.</span>smeth<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>                                <span class="token comment"># 这里可以使用实例进行调用</span>\n    Methods<span class="token punctuation">.</span>cmeth<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>                            <span class="token comment"># 类方法调用 &lt;class \'__main__.Methods\'> 5</span>\n    obj<span class="token punctuation">.</span>cmeth<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>                                <span class="token comment"># &lt;class \'__main__.Methods\'> 6</span>\n\n<span class="token comment">#-- 函数装饰器:是它后边的函数的运行时的声明 由@符号以及后边紧跟的"元函数"(metafunction)组成</span>\n        <span class="token decorator annotation punctuation">@staticmethod</span>\n        <span class="token keyword">def</span> <span class="token function">smeth</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>\n    <span class="token comment"># 等同于:</span>\n        <span class="token keyword">def</span> <span class="token function">smeth</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>\n        smeth <span class="token operator">=</span> <span class="token builtin">staticmethod</span><span class="token punctuation">(</span>smeth<span class="token punctuation">)</span>\n    <span class="token comment"># 同理</span>\n        <span class="token decorator annotation punctuation">@classmethod</span>\n        <span class="token keyword">def</span> <span class="token function">cmeth</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>\n    <span class="token comment"># 等同于</span>\n        <span class="token keyword">def</span> <span class="token function">cmeth</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>\n        cmeth <span class="token operator">=</span> <span class="token builtin">classmethod</span><span class="token punctuation">(</span>cmeth<span class="token punctuation">)</span>\n\n<span class="token comment">#-- 类修饰器:是它后边的类的运行时的声明 由@符号以及后边紧跟的"元函数"(metafunction)组成</span>\n        <span class="token keyword">def</span> <span class="token function">decorator</span><span class="token punctuation">(</span>aClass<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n        @decorator\n        <span class="token keyword">class</span> <span class="token class-name">C</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n    <span class="token comment"># 等同于:</span>\n        <span class="token keyword">class</span> <span class="token class-name">C</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n        C <span class="token operator">=</span> decorator<span class="token punctuation">(</span>C<span class="token punctuation">)</span>\n\n<span class="token comment">#-- 限制class属性: __slots__属性</span>\n    <span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        __slots__ <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">\'name\'</span><span class="token punctuation">,</span> <span class="token string">\'age\'</span><span class="token punctuation">)</span>             <span class="token comment"># 限制Student及其实例只能拥有name和age属性</span>\n    <span class="token comment"># __slots__属性只对当前类起作用, 对其子类不起作用</span>\n    <span class="token comment"># __slots__属性能够节省内存</span>\n    <span class="token comment"># __slots__属性可以为列表list，或者元组tuple</span>\n\n<span class="token comment">#-- 类属性高级话题: @property</span>\n    <span class="token comment"># 假设定义了一个类:C，该类必须继承自object类，有一私有变量_x</span>\n    <span class="token keyword">class</span> <span class="token class-name">C</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            self<span class="token punctuation">.</span>__x <span class="token operator">=</span> <span class="token boolean">None</span>\n    <span class="token comment"># 第一种使用属性的方法</span>\n        <span class="token keyword">def</span> <span class="token function">getx</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self<span class="token punctuation">.</span>__x\n        <span class="token keyword">def</span> <span class="token function">setx</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            self<span class="token punctuation">.</span>__x <span class="token operator">=</span> value\n        <span class="token keyword">def</span> <span class="token function">delx</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">del</span> self<span class="token punctuation">.</span>__x\n        x <span class="token operator">=</span> <span class="token builtin">property</span><span class="token punctuation">(</span>getx<span class="token punctuation">,</span> setx<span class="token punctuation">,</span> delx<span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span>\n    <span class="token comment"># property函数原型为property(fget=None,fset=None,fdel=None,doc=None)</span>\n    <span class="token comment"># 使用</span>\n    c <span class="token operator">=</span> C<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    c<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token number">100</span>                         <span class="token comment"># 自动调用setx方法</span>\n    y <span class="token operator">=</span> c<span class="token punctuation">.</span>x                           <span class="token comment"># 自动调用getx方法</span>\n    <span class="token keyword">del</span> c<span class="token punctuation">.</span>x                           <span class="token comment"># 自动调用delx方法</span>\n    <span class="token comment"># 第二种方法使用属性的方法</span>\n        <span class="token decorator annotation punctuation">@property</span>\n        <span class="token keyword">def</span> <span class="token function">x</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self<span class="token punctuation">.</span>__x\n        @x<span class="token punctuation">.</span>setter\n        <span class="token keyword">def</span> <span class="token function">x</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n           self<span class="token punctuation">.</span>__x <span class="token operator">=</span> value\n        @x<span class="token punctuation">.</span>deleter\n        <span class="token keyword">def</span> <span class="token function">x</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n           <span class="token keyword">del</span> self<span class="token punctuation">.</span>__x\n    <span class="token comment"># 使用</span>\n    c <span class="token operator">=</span> C<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    c<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token number">100</span>                         <span class="token comment"># 自动调用setter方法</span>\n    y <span class="token operator">=</span> c<span class="token punctuation">.</span>x                           <span class="token comment"># 自动调用x方法</span>\n    <span class="token keyword">del</span> c<span class="token punctuation">.</span>x                           <span class="token comment"># 自动调用deleter方法</span>\n\n<span class="token comment">#-- 定制类: 重写类的方法</span>\n    <span class="token comment"># (1)__str__方法、__repr__方法: 定制类的输出字符串</span>\n    <span class="token comment"># (2)__iter__方法、next方法: 定制类的可迭代性</span>\n    <span class="token keyword">class</span> <span class="token class-name">Fib</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            self<span class="token punctuation">.</span>a<span class="token punctuation">,</span> self<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span>     <span class="token comment"># 初始化两个计数器a，b</span>\n        <span class="token keyword">def</span> <span class="token function">__iter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self               <span class="token comment"># 实例本身就是迭代对象，故返回自己</span>\n        <span class="token keyword">def</span> <span class="token function">next</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            self<span class="token punctuation">.</span>a<span class="token punctuation">,</span> self<span class="token punctuation">.</span>b <span class="token operator">=</span> self<span class="token punctuation">.</span>b<span class="token punctuation">,</span> self<span class="token punctuation">.</span>a <span class="token operator">+</span> self<span class="token punctuation">.</span>b\n            <span class="token keyword">if</span> self<span class="token punctuation">.</span>a <span class="token operator">></span> <span class="token number">100000</span><span class="token punctuation">:</span>       <span class="token comment"># 退出循环的条件</span>\n                <span class="token keyword">raise</span> StopIteration<span class="token punctuation">(</span><span class="token punctuation">)</span>\n            <span class="token keyword">return</span> self<span class="token punctuation">.</span>a             <span class="token comment"># 返回下一个值</span>\n    <span class="token keyword">for</span> n <span class="token keyword">in</span> Fib<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>                      <span class="token comment"># 使用</span>\n    <span class="token comment"># (3)__getitem__方法、__setitem__方法: 定制类的下标操作[] 或者切片操作slice</span>\n    <span class="token keyword">class</span> <span class="token class-name">Indexer</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            self<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n        <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">:</span>             <span class="token comment"># 定义getitem方法</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'getitem:\'</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span>\n            <span class="token keyword">return</span> self<span class="token punctuation">.</span>data<span class="token punctuation">[</span>n<span class="token punctuation">]</span>\n        <span class="token keyword">def</span> <span class="token function">__setitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># 定义setitem方法</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'setitem:key = {0}, value = {1}\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span>\n            self<span class="token punctuation">.</span>data<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value\n    test <span class="token operator">=</span> Indexer<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    test<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>   test<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">\'3\'</span>              <span class="token comment"># 调用setitem方法</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span>test<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                            <span class="token comment"># 调用getitem方法</span>\n    <span class="token comment"># (4)__getattr__方法: 定制类的属性操作</span>\n    <span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">__getattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> attr<span class="token punctuation">)</span><span class="token punctuation">:</span>          <span class="token comment"># 定义当获取类的属性时的返回值</span>\n            <span class="token keyword">if</span> attr<span class="token operator">==</span><span class="token string">\'age\'</span><span class="token punctuation">:</span>\n                <span class="token keyword">return</span> <span class="token number">25</span>                     <span class="token comment"># 当获取age属性时返回25</span>\n        <span class="token keyword">raise</span> AttributeError<span class="token punctuation">(</span><span class="token string">\'object has no attribute: %s\'</span> <span class="token operator">%</span> attr<span class="token punctuation">)</span>\n        <span class="token comment"># 注意: 只有当属性不存在时 才会调用该方法 且该方法默认返回None 需要在函数最后引发异常</span>\n    s <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    s<span class="token punctuation">.</span>age                                     <span class="token comment"># s中age属性不存在 故调用__getattr__方法 返回25</span>\n    <span class="token comment"># (5)__call__方法: 定制类的\'可调用\'性</span>\n    <span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>                   <span class="token comment"># 也可以带参数</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Calling......\'</span><span class="token punctuation">)</span>\n    s <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    s<span class="token punctuation">(</span><span class="token punctuation">)</span>                                       <span class="token comment"># s变成了可调用的 也可以带参数</span>\n    <span class="token builtin">callable</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>                               <span class="token comment"># 测试s的可调用性 返回True</span>\n    <span class="token comment">#    (6)__len__方法：求类的长度</span>\n    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">)</span>\n\n<span class="token comment">#-- 动态创建类type()</span>\n    <span class="token comment"># 一般创建类 需要在代码中提前定义</span>\n        <span class="token keyword">class</span> <span class="token class-name">Hello</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">def</span> <span class="token function">hello</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">\'world\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Hello, %s.\'</span> <span class="token operator">%</span> name<span class="token punctuation">)</span>\n        h <span class="token operator">=</span> Hello<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        h<span class="token punctuation">.</span>hello<span class="token punctuation">(</span><span class="token punctuation">)</span>                             <span class="token comment"># Hello, world</span>\n        <span class="token builtin">type</span><span class="token punctuation">(</span>Hello<span class="token punctuation">)</span>                           <span class="token comment"># Hello是一个type类型 返回&lt;class \'type\'></span>\n        <span class="token builtin">type</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span>                               <span class="token comment"># h是一个Hello类型 返回&lt;class \'Hello\'></span>\n    <span class="token comment"># 动态类型语言中 类可以动态创建 type函数可用于创建新类型</span>\n        <span class="token keyword">def</span> <span class="token function">fn</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">\'world\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>           <span class="token comment"># 先定义函数</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Hello, %s.\'</span> <span class="token operator">%</span> name<span class="token punctuation">)</span>\n        Hello <span class="token operator">=</span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token string">\'Hello\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>hello<span class="token operator">=</span>fn<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment"># 创建Hello类 type原型: type(name, bases, dict)</span>\n        h <span class="token operator">=</span> Hello<span class="token punctuation">(</span><span class="token punctuation">)</span>                           <span class="token comment"># 此时的h和上边的h一致</span>\n\n\n<span class="token triple-quoted-string string">"""异常相关----异常相关----异常相关----异常相关----异常相关----异常相关----异常相关----异常相关----异常相关----异常相关----异常相关----异常相关----异常相关"""</span>\n\n<span class="token comment">#-- #捕获异常:</span>\n        <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">except</span><span class="token punctuation">:</span>                               <span class="token comment"># 捕获所有的异常 等同于except Exception:</span>\n        <span class="token keyword">except</span> name<span class="token punctuation">:</span>                          <span class="token comment"># 捕获指定的异常</span>\n        <span class="token keyword">except</span> name<span class="token punctuation">,</span> value<span class="token punctuation">:</span>                   <span class="token comment"># 捕获指定的异常和额外的数据(实例)</span>\n        <span class="token keyword">except</span> <span class="token punctuation">(</span>name1<span class="token punctuation">,</span> name2<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">except</span> <span class="token punctuation">(</span>name1<span class="token punctuation">,</span> name2<span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span>\n        <span class="token keyword">except</span> name4 <span class="token keyword">as</span> X<span class="token punctuation">:</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>                                 <span class="token comment"># 如果没有发生异常</span>\n        <span class="token keyword">finally</span><span class="token punctuation">:</span>                              <span class="token comment"># 总会执行的部分</span>\n    <span class="token comment"># 引发异常: raise子句(raise IndexError)</span>\n        <span class="token keyword">raise</span> <span class="token operator">&lt;</span>instance<span class="token operator">></span>                      <span class="token comment"># raise instance of a class, raise IndexError()</span>\n        <span class="token keyword">raise</span> <span class="token operator">&lt;</span><span class="token keyword">class</span><span class="token operator">></span>                         <span class="token comment"># make and raise instance of a class, raise IndexError</span>\n        <span class="token keyword">raise</span>                                 <span class="token comment"># reraise the most recent exception</span>\n\n<span class="token comment">#-- Python3.x中的异常链: raise exception from otherException</span>\n    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> X<span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> IndexError<span class="token punctuation">(</span><span class="token string">\'Bad\'</span><span class="token punctuation">)</span> <span class="token keyword">from</span> X\n\n<span class="token comment">#-- assert子句: assert &lt;test>, &lt;data></span>\n    <span class="token keyword">assert</span> x <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">\'x must be negative\'</span>\n\n<span class="token comment">#-- with/as环境管理器:作为常见的try/finally用法模式的替代方案</span>\n    <span class="token keyword">with</span> expression <span class="token punctuation">[</span><span class="token keyword">as</span> variable<span class="token punctuation">]</span><span class="token punctuation">,</span> expression <span class="token punctuation">[</span><span class="token keyword">as</span> variable<span class="token punctuation">]</span><span class="token punctuation">:</span>\n    <span class="token comment"># 例子:</span>\n        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'test.txt\'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> myfile<span class="token punctuation">:</span>\n            <span class="token keyword">for</span> line <span class="token keyword">in</span> myfile<span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span>\n    <span class="token comment"># 等同于:</span>\n        myfile <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'test.txt\'</span><span class="token punctuation">)</span>\n        <span class="token keyword">try</span><span class="token punctuation">:</span>\n            <span class="token keyword">for</span> line <span class="token keyword">in</span> myfile<span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span>\n        <span class="token keyword">finally</span><span class="token punctuation">:</span>\n            myfile<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token comment">#-- 用户自定义异常: class Bad(Exception):.....</span>\n    <span class="token triple-quoted-string string">"""\n    Exception超类 / except基类即可捕获到其所有子类\n    Exception超类有默认的打印消息和状态 当然也可以定制打印显示:\n    """</span>\n    <span class="token keyword">class</span> <span class="token class-name">MyBad</span><span class="token punctuation">(</span>Exception<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token string">\'定制的打印消息\'</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        MyBad<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">except</span> MyBad <span class="token keyword">as</span> x<span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>\n\n<span class="token comment">#-- 用户定制异常数据</span>\n    <span class="token keyword">class</span> <span class="token class-name">FormatError</span><span class="token punctuation">(</span>Exception<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> line <span class="token punctuation">,</span><span class="token builtin">file</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            self<span class="token punctuation">.</span>line <span class="token operator">=</span> line\n            self<span class="token punctuation">.</span><span class="token builtin">file</span> <span class="token operator">=</span> <span class="token builtin">file</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> FormatError<span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">,</span> <span class="token string">\'test.py\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">except</span> FormatError <span class="token keyword">as</span> X<span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Error at \'</span><span class="token punctuation">,</span> X<span class="token punctuation">.</span><span class="token builtin">file</span><span class="token punctuation">,</span> X<span class="token punctuation">.</span>line<span class="token punctuation">)</span>\n    <span class="token comment"># 用户定制异常行为(方法):以记录日志为例</span>\n    <span class="token keyword">class</span> <span class="token class-name">FormatError</span><span class="token punctuation">(</span>Exception<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        logfile <span class="token operator">=</span> <span class="token string">\'formaterror.txt\'</span>\n        <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> line <span class="token punctuation">,</span><span class="token builtin">file</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            self<span class="token punctuation">.</span>line <span class="token operator">=</span> line\n            self<span class="token punctuation">.</span><span class="token builtin">file</span> <span class="token operator">=</span> <span class="token builtin">file</span>\n        <span class="token keyword">def</span> <span class="token function">logger</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token builtin">open</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>logfile<span class="token punctuation">,</span> <span class="token string">\'a\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">\'Error at \'</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span><span class="token builtin">file</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>line<span class="token punctuation">)</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> FormatError<span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">,</span> <span class="token string">\'test.py\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">except</span> FormatError <span class="token keyword">as</span> X<span class="token punctuation">:</span>\n        X<span class="token punctuation">.</span>logger<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token comment">#-- 关于sys.exc_info:允许一个异常处理器获取对最近引发的异常的访问</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n    <span class="token keyword">except</span><span class="token punctuation">:</span>\n        <span class="token comment"># 此时sys.exc_info()返回一个元组(type, value, traceback)</span>\n        <span class="token comment"># type:正在处理的异常的异常类型</span>\n        <span class="token comment"># value:引发的异常的实例</span>\n        <span class="token comment"># traceback:堆栈信息</span>\n\n<span class="token comment">#-- 异常层次</span>\n    BaseException\n    <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> SystemExit\n    <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> KeyboardInterrupt\n    <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> GeneratorExit\n    <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> Exception\n        <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> StopIteration\n        <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> ArithmeticError\n        <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> AssertionError\n        <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> AttributeError\n        <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> BufferError\n        <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> EOFError\n        <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> ImportError\n        <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> LookupError\n        <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> MemoryError\n        <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> NameError\n        <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> OSError\n        <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> ReferenceError\n        <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> RuntimeError\n        <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> SyntaxError\n        <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> SystemError\n        <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> TypeError\n        <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> ValueError\n        <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> Warning\n\n\n<span class="token triple-quoted-string string">"""Unicode和字节字符串---Unicode和字节字符串----Unicode和字节字符串----Unicode和字节字符串----Unicode和字节字符串----Unicode和字节字符串----Unicode和字节字符串"""</span>\n\n<span class="token comment">#-- Python的字符串类型</span>\n    <span class="token triple-quoted-string string">"""Python2.x"""</span>\n    <span class="token comment"># 1.str表示8位文本和二进制数据</span>\n    <span class="token comment"># 2.unicode表示宽字符Unicode文本</span>\n    <span class="token triple-quoted-string string">"""Python3.x"""</span>\n    <span class="token comment"># 1.str表示Unicode文本（8位或者更宽）</span>\n    <span class="token comment"># 2.bytes表示不可变的二进制数据</span>\n    <span class="token comment"># 3.bytearray是一种可变的bytes类型</span>\n\n<span class="token comment">#-- 字符编码方法</span>\n    <span class="token triple-quoted-string string">"""ASCII"""</span>                   <span class="token comment"># 一个字节，只包含英文字符，0到127，共128个字符，利用函数可以进行字符和数字的相互转换</span>\n    <span class="token builtin">ord</span><span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">)</span>                      <span class="token comment"># 字符a的ASCII码为97，所以这里返回97</span>\n    <span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token number">97</span><span class="token punctuation">)</span>                       <span class="token comment"># 和上边的过程相反，返回字符\'a\'</span>\n    <span class="token triple-quoted-string string">"""Latin-1"""</span>                 <span class="token comment"># 一个字节，包含特殊字符，0到255，共256个字符，相当于对ASCII码的扩展</span>\n    <span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token number">196</span><span class="token punctuation">)</span>                      <span class="token comment"># 返回一个特殊字符：Ä</span>\n    <span class="token triple-quoted-string string">"""Unicode"""</span>                 <span class="token comment"># 宽字符，一个字符包含多个字节，一般用于亚洲的字符集，比如中文有好几万字</span>\n    <span class="token triple-quoted-string string">"""UTF-8"""</span>                   <span class="token comment"># 可变字节数，小于128的字符表示为单个字节，128到0X7FF之间的代码转换为两个字节，0X7FF以上的代码转换为3或4个字节</span>\n    <span class="token comment"># 注意：可以看出来，ASCII码是Latin-1和UTF-8的一个子集</span>\n    <span class="token comment"># 注意：utf-8是unicode的一种实现方式，unicode、gbk、gb2312是编码字符集</span>\n\n<span class="token comment">#-- 查看Python中的字符串编码名称，查看系统的编码</span>\n    <span class="token keyword">import</span> encodings\n    <span class="token builtin">help</span><span class="token punctuation">(</span>encoding<span class="token punctuation">)</span>\n    <span class="token keyword">import</span> sys\n    sys<span class="token punctuation">.</span>platform                  <span class="token comment"># \'win64\'</span>\n    sys<span class="token punctuation">.</span>getdefaultencoding<span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token comment"># \'utf-8\'</span>\n    sys<span class="token punctuation">.</span>getdefaultencoding<span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token comment"># 返回当前系统平台的编码类型</span>\n    sys<span class="token punctuation">.</span>getsizeof<span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span>         <span class="token comment"># 返回object占有的bytes的大小</span>\n\n<span class="token comment">#-- 源文件字符集编码声明: 添加注释来指定想要的编码形式 从而改变默认值 注释必须出现在脚本的第一行或者第二行</span>\n    <span class="token triple-quoted-string string">"""说明：其实这里只会检查#和coding:utf-8，其余的字符都是为了美观加上的"""</span>\n    <span class="token comment"># _*_ coding: utf-8 _*_</span>\n    <span class="token comment"># coding = utf-8</span>\n\n<span class="token comment">#-- #编码: 字符串 --> 原始字节       #解码: 原始字节 --> 字符串</span>\n\n<span class="token comment">#-- Python3.x中的字符串应用</span>\n    s <span class="token operator">=</span> <span class="token string">\'...\'</span>                     <span class="token comment"># 构建一个str对象，不可变对象</span>\n    b <span class="token operator">=</span> <span class="token string">b\'...\'</span>                    <span class="token comment"># 构建一个bytes对象，不可变对象</span>\n    s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>                    <span class="token comment"># 返回(\'.\', 113)</span>\n    s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> b<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>                  <span class="token comment"># 返回(\'..\', b\'..\')</span>\n    B <span class="token operator">=</span> <span class="token triple-quoted-string string">B"""\n        xxxx\n        yyyy\n        """</span>\n    <span class="token comment"># B = b\'\\nxxxx\\nyyyy\\n\'</span>\n    <span class="token comment"># 编码，将str字符串转化为其raw bytes形式：</span>\n        <span class="token builtin">str</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span>encoding <span class="token operator">=</span> <span class="token string">\'utf-8\'</span><span class="token punctuation">,</span> errors <span class="token operator">=</span> <span class="token string">\'strict\'</span><span class="token punctuation">)</span>\n        <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">,</span> encoding<span class="token punctuation">)</span>\n    <span class="token comment"># 编码例子：</span>\n        S <span class="token operator">=</span> <span class="token string">\'egg\'</span>\n        S<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>                    <span class="token comment"># b\'egg\'</span>\n        <span class="token builtin">bytes</span><span class="token punctuation">(</span>S<span class="token punctuation">,</span> encoding <span class="token operator">=</span> <span class="token string">\'ascii\'</span><span class="token punctuation">)</span>  <span class="token comment"># b\'egg\'</span>\n    <span class="token comment"># 解码，将raw bytes字符串转化为str形式：</span>\n        <span class="token builtin">bytes</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span>encoding <span class="token operator">=</span> <span class="token string">\'utf-8\'</span><span class="token punctuation">,</span> errors <span class="token operator">=</span> <span class="token string">\'strict\'</span><span class="token punctuation">)</span>\n        <span class="token builtin">str</span><span class="token punctuation">(</span>bytes_or_buffer<span class="token punctuation">[</span><span class="token punctuation">,</span> encoding<span class="token punctuation">[</span><span class="token punctuation">,</span> errors<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n    <span class="token comment"># 解码例子：</span>\n        B <span class="token operator">=</span> <span class="token string">b\'spam\'</span>\n        B<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token comment"># \'spam\'</span>\n        <span class="token builtin">str</span><span class="token punctuation">(</span>B<span class="token punctuation">)</span>                    <span class="token comment"># "b\'spam\'"，不带编码的str调用，结果为打印该bytes对象</span>\n        <span class="token builtin">str</span><span class="token punctuation">(</span>B<span class="token punctuation">,</span> encoding <span class="token operator">=</span> <span class="token string">\'ascii\'</span><span class="token punctuation">)</span><span class="token comment"># \'spam\'，带编码的str调用，结果为转化该bytes对象</span>\n\n<span class="token comment">#-- Python2.x的编码问题</span>\n    u <span class="token operator">=</span> <span class="token string">u\'汉\'</span>\n    <span class="token keyword">print</span> <span class="token builtin">repr</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span>                 <span class="token comment"># u\'\\xba\\xba\'</span>\n    s <span class="token operator">=</span> u<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">\'UTF-8\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span> <span class="token builtin">repr</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>                 <span class="token comment"># \'\\xc2\\xba\\xc2\\xba\'</span>\n    u2 <span class="token operator">=</span> s<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">\'UTF-8\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span> <span class="token builtin">repr</span><span class="token punctuation">(</span>u2<span class="token punctuation">)</span>                <span class="token comment"># u\'\\xba\\xba\'</span>\n    <span class="token comment"># 对unicode进行解码是错误的</span>\n    s2 <span class="token operator">=</span> u<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">\'UTF-8\'</span><span class="token punctuation">)</span>        <span class="token comment"># UnicodeEncodeError: \'ascii\' codec can\'t encode characters in position 0-1: ordinal not in range(128)</span>\n    <span class="token comment"># 同样，对str进行编码也是错误的</span>\n    u2 <span class="token operator">=</span> s<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">\'UTF-8\'</span><span class="token punctuation">)</span>        <span class="token comment"># UnicodeDecodeError: \'ascii\' codec can\'t decode byte 0xc2 in position 0: ordinal not in range(128)</span>\n\n<span class="token comment">#-- bytes对象</span>\n    B <span class="token operator">=</span> <span class="token string">b\'abc\'</span>\n    B <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token string">\'abc\'</span><span class="token punctuation">,</span> <span class="token string">\'ascii\'</span><span class="token punctuation">)</span>\n    B <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">97</span><span class="token punctuation">,</span> <span class="token number">98</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n    B <span class="token operator">=</span> <span class="token string">\'abc\'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token comment"># bytes对象的方法调用基本和str类型一致 但:B[0]返回的是ASCII码值97, 而不是b\'a\'</span>\n\n<span class="token comment">#-- #文本文件: 根据Unicode编码来解释文件内容，要么是平台的默认编码，要么是指定的编码类型</span>\n    <span class="token comment"># 二进制文件：表示字节值的整数的一个序列 open(\'bin.txt\', \'rb\')</span>\n\n<span class="token comment">#-- Unicode文件</span>\n    s <span class="token operator">=</span> <span class="token string">\'A\\xc4B\\xe8C\'</span>             <span class="token comment"># s = \'A?BèC\'  len(s) = 5</span>\n    <span class="token comment">#手动编码</span>\n        l <span class="token operator">=</span> s<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">\'latin-1\'</span><span class="token punctuation">)</span>   <span class="token comment"># l = b\'A\\xc4B\\xe8C\'  len(l) = 5</span>\n        u <span class="token operator">=</span> s<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">\'utf-8\'</span><span class="token punctuation">)</span>     <span class="token comment"># u = b\'A\\xc3\\x84B\\xc3\\xa8C\'  len(u) = 7</span>\n    <span class="token comment">#文件输出编码</span>\n        <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'latindata\'</span><span class="token punctuation">,</span> <span class="token string">\'w\'</span><span class="token punctuation">,</span> encoding <span class="token operator">=</span> <span class="token string">\'latin-1\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span>s<span class="token punctuation">)</span>\n        l <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'latindata\'</span><span class="token punctuation">,</span> <span class="token string">\'rb\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>                        <span class="token comment"># l = b\'A\\xc4B\\xe8C\'  len(l) = 5</span>\n        <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'uft8data\'</span><span class="token punctuation">,</span> <span class="token string">\'w\'</span><span class="token punctuation">,</span> encoding <span class="token operator">=</span> <span class="token string">\'utf-8\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span>s<span class="token punctuation">)</span>\n        u <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'uft8data\'</span><span class="token punctuation">,</span> <span class="token string">\'rb\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>                         <span class="token comment"># u = b\'A\\xc3\\x84B\\xc3\\xa8C\'  len(u) = 7</span>\n    <span class="token comment">#文件输入编码</span>\n        s <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'latindata\'</span><span class="token punctuation">,</span> <span class="token string">\'r\'</span><span class="token punctuation">,</span> encoding <span class="token operator">=</span> <span class="token string">\'latin-1\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment"># s = \'A?BèC\'  len(s) = 5</span>\n        s <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'latindata\'</span><span class="token punctuation">,</span> <span class="token string">\'rb\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">\'latin-1\'</span><span class="token punctuation">)</span>      <span class="token comment"># s = \'A?BèC\'  len(s) = 5</span>\n        s <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'utf8data\'</span><span class="token punctuation">,</span> <span class="token string">\'r\'</span><span class="token punctuation">,</span> encoding <span class="token operator">=</span> <span class="token string">\'utf-8\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token comment"># s = \'A?BèC\'  len(s) = 5</span>\n        s <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'utf8data\'</span><span class="token punctuation">,</span> <span class="token string">\'rb\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">\'utf-8\'</span><span class="token punctuation">)</span>         <span class="token comment"># s = \'A?BèC\'  len(s) = 5</span>\n\n\n<span class="token triple-quoted-string string">"""其他----其他----其他----其他----其他----其他----其他----其他----其他----其他----其他----其他----其他----其他----其他----其他----其他----其他----其他"""</span>\n\n<span class="token comment">#-- Python实现任意深度的赋值 例如a[0] = \'value1\'; a[1][2] = \'value2\'; a[3][4][5] = \'value3\'</span>\n    <span class="token keyword">class</span> <span class="token class-name">MyDict</span><span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">__setitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>                 <span class="token comment"># 该函数不做任何改动 这里只是为了输出</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'setitem:\'</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> self<span class="token punctuation">)</span>\n            <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__setitem__<span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n        <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">:</span>                       <span class="token comment"># 主要技巧在该函数</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'getitem:\'</span><span class="token punctuation">,</span> item<span class="token punctuation">,</span> self<span class="token punctuation">)</span>                  <span class="token comment"># 输出信息</span>\n            <span class="token comment"># 基本思路: a[1][2]赋值时 需要先取出a[1] 然后给a[1]的[2]赋值</span>\n            <span class="token keyword">if</span> item <span class="token keyword">not</span> <span class="token keyword">in</span> self<span class="token punctuation">:</span>                           <span class="token comment"># 如果a[1]不存在 则需要新建一个dict 并使得a[1] = dict</span>\n                temp <span class="token operator">=</span> MyDict<span class="token punctuation">(</span><span class="token punctuation">)</span>                            <span class="token comment"># 新建的dict: temp</span>\n                <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__setitem__<span class="token punctuation">(</span>item<span class="token punctuation">,</span> temp<span class="token punctuation">)</span>            <span class="token comment"># 赋值a[1] = temp</span>\n                <span class="token keyword">return</span> temp                                <span class="token comment"># 返回temp 使得temp[2] = value有效</span>\n            <span class="token keyword">return</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__getitem__<span class="token punctuation">(</span>item<span class="token punctuation">)</span>               <span class="token comment"># 如果a[1]存在 则直接返回a[1]</span>\n    <span class="token comment"># 例子:</span>\n        test <span class="token operator">=</span> MyDict<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        test<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">\'test\'</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>test<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n        test<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">\'test1\'</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>test<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n        test<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">\'test2\'</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>test<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n<span class="token comment">#-- Python中的多维数组</span>\n    lists <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">3</span>                                        <span class="token comment"># 扩展list，结果为[0, 0, 0]</span>\n    lists <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">3</span>                                       <span class="token comment"># 多维数组，结果为[[], [], []]，但有问题，往下看</span>\n    lists<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>                                     <span class="token comment"># 期望看到的结果[[3], [], []]，实际结果[[3], [3], [3]]，原因：list*n操作，是浅拷贝，如何避免？往下看</span>\n    lists <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span>                         <span class="token comment"># 多维数组，结果为[[], [], []]</span>\n    lists<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>                                     <span class="token comment"># 结果为[[3], [], []]</span>\n    lists<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>                                     <span class="token comment"># 结果为[[3], [6], []]</span>\n    lists<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span>                                     <span class="token comment"># 结果为[[3], [6], [9]]</span>\n    lists <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span>     <span class="token comment"># 3行4列，且每一个元素为[]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="版本二"><a href="#%E7%89%88%E6%9C%AC%E4%BA%8C" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>版本二</h1>\n<h2 id="工具"><a href="#%E5%B7%A5%E5%85%B7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>工具</h2>\n<h3 id="虚拟环境"><a href="#%E8%99%9A%E6%8B%9F%E7%8E%AF%E5%A2%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>虚拟环境</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22605876847766536000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 安装\n\\$ pip install virtualenv\n\n# 创建环境\n\\$ virtualenv myproject\n\\$ source myproject/bin/activate\n\n# virtualenv 使用系统全局模块\n\\$ virtualenv --system-site-packages mycoolproject\n\n# 退出这个 virtualenv\n\\$ deactivate`, `22605876847766536000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># 安装</span>\n$ pip <span class="token function">install</span> virtualenv\n\n<span class="token comment"># 创建环境</span>\n$ virtualenv myproject\n$ <span class="token builtin class-name">source</span> myproject/bin/activate\n\n<span class="token comment"># virtualenv 使用系统全局模块</span>\n$ virtualenv --system-site-packages mycoolproject\n\n<span class="token comment"># 退出这个 virtualenv</span>\n$ deactivate</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="对象自省"><a href="#%E5%AF%B9%E8%B1%A1%E8%87%AA%E7%9C%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>对象自省</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28765099038891307000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`my_list = [1, 2, 3]\n# 列出一个对象所拥有的属性和方法\ndir(my_list)\n# 返回当前作用域的所有名字\ndir()\n\n# type 函数返回一个对象的类型\nprint(type(\'\')) # Output: <type \'str\'>\n\n# 函数返回任意不同种类对象的唯一 ID\nname = &quot;Yasoob&quot;\nprint(id(name)) # Output: 139972439030304\n\n# 查看一个对象的成员\nimport inspect\nprint(inspect.getmembers(str)) # Output: [(\'__add__\', <slot wrapper \'__add__\' of ... ...`, `28765099038891307000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">my_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>\n<span class="token comment"># 列出一个对象所拥有的属性和方法</span>\n<span class="token builtin">dir</span><span class="token punctuation">(</span>my_list<span class="token punctuation">)</span>\n<span class="token comment"># 返回当前作用域的所有名字</span>\n<span class="token builtin">dir</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token comment"># type 函数返回一个对象的类型</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span><span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># Output: &lt;type \'str\'></span>\n\n<span class="token comment"># 函数返回任意不同种类对象的唯一 ID</span>\nname <span class="token operator">=</span> <span class="token string">"Yasoob"</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># Output: 139972439030304</span>\n\n<span class="token comment"># 查看一个对象的成员</span>\n<span class="token keyword">import</span> inspect\n<span class="token keyword">print</span><span class="token punctuation">(</span>inspect<span class="token punctuation">.</span>getmembers<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># Output: [(\'__add__\', &lt;slot wrapper \'__add__\' of ... ...</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="语法"><a href="#%E8%AF%AD%E6%B3%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>语法</h2>\n<h3 id="异常"><a href="#%E5%BC%82%E5%B8%B8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>异常</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68679646833259980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 正常例子\ntry:\n    file = open(\'test.txt\', \'rb\')\nexcept IOError as e:\n    print(\'An IOError occurred. {}\'.format(e.args[-1]))\n\n# 处理多个异常，有 3 种方法\n## 方法 1：\ntry:\n    file = open(\'test.txt\', \'rb\')\nexcept (IOError, EOFError) as e:\n    print(&quot;An error occurred. {}&quot;.format(e.args[-1]))\n##　方法 2：\ntry:\n    file = open(\'test.txt\', \'rb\')\nexcept EOFError as e:\n    print(&quot;An EOF error occurred.&quot;)\n    raise e\nexcept IOError as e:\n    print(&quot;An error occurred.&quot;)\n    raise e\n## 方法 3：\ntry:\n    file = open(\'test.txt\', \'rb\')\nexcept Exception:\n    # 打印一些异常日志，如果你想要的话\n    raise\n\n# finally 从句\ntry:\n    file = open(\'test.txt\', \'rb\')\nexcept IOError as e:\n    print(\'An IOError occurred. {}\'.format(e.args[-1]))\nfinally:\n    print(&quot;This would be printed whether or not an exception occurred!&quot;)\n# Output: An IOError occurred. No such file or directory\n# This would be printed whether or not an exception occurred!\n\n# try/else 从句\ntry:\n    print(\'I am sure no exception is going to occur!\')\nexcept Exception:\n    print(\'exception\')\nelse:\n    # 这里的代码只会在 try 语句里没有触发异常时运行,\n    # 但是这里的异常将 *不会* 被捕获\n    print(\'This would only run if no exception occurs. And an error here would NOT be caught.\')\nfinally:\n    print(\'This would be printed in every case.\')\n\n# Output: I am sure no exception is going to occur!\n# This would only run if no exception occurs. And an error here would NOT be caught.\n# This would be printed in every case.`, `68679646833259980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment"># 正常例子</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    <span class="token builtin">file</span> <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'test.txt\'</span><span class="token punctuation">,</span> <span class="token string">\'rb\'</span><span class="token punctuation">)</span>\n<span class="token keyword">except</span> IOError <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'An IOError occurred. {}\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token comment"># 处理多个异常，有 3 种方法</span>\n<span class="token comment">## 方法 1：</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    <span class="token builtin">file</span> <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'test.txt\'</span><span class="token punctuation">,</span> <span class="token string">\'rb\'</span><span class="token punctuation">)</span>\n<span class="token keyword">except</span> <span class="token punctuation">(</span>IOError<span class="token punctuation">,</span> EOFError<span class="token punctuation">)</span> <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"An error occurred. {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token comment">##　方法 2：</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    <span class="token builtin">file</span> <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'test.txt\'</span><span class="token punctuation">,</span> <span class="token string">\'rb\'</span><span class="token punctuation">)</span>\n<span class="token keyword">except</span> EOFError <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"An EOF error occurred."</span><span class="token punctuation">)</span>\n    <span class="token keyword">raise</span> e\n<span class="token keyword">except</span> IOError <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"An error occurred."</span><span class="token punctuation">)</span>\n    <span class="token keyword">raise</span> e\n<span class="token comment">## 方法 3：</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    <span class="token builtin">file</span> <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'test.txt\'</span><span class="token punctuation">,</span> <span class="token string">\'rb\'</span><span class="token punctuation">)</span>\n<span class="token keyword">except</span> Exception<span class="token punctuation">:</span>\n    <span class="token comment"># 打印一些异常日志，如果你想要的话</span>\n    <span class="token keyword">raise</span>\n\n<span class="token comment"># finally 从句</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    <span class="token builtin">file</span> <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'test.txt\'</span><span class="token punctuation">,</span> <span class="token string">\'rb\'</span><span class="token punctuation">)</span>\n<span class="token keyword">except</span> IOError <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'An IOError occurred. {}\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">finally</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"This would be printed whether or not an exception occurred!"</span><span class="token punctuation">)</span>\n<span class="token comment"># Output: An IOError occurred. No such file or directory</span>\n<span class="token comment"># This would be printed whether or not an exception occurred!</span>\n\n<span class="token comment"># try/else 从句</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'I am sure no exception is going to occur!\'</span><span class="token punctuation">)</span>\n<span class="token keyword">except</span> Exception<span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'exception\'</span><span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    <span class="token comment"># 这里的代码只会在 try 语句里没有触发异常时运行,</span>\n    <span class="token comment"># 但是这里的异常将 *不会* 被捕获</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'This would only run if no exception occurs. And an error here would NOT be caught.\'</span><span class="token punctuation">)</span>\n<span class="token keyword">finally</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'This would be printed in every case.\'</span><span class="token punctuation">)</span>\n\n<span class="token comment"># Output: I am sure no exception is going to occur!</span>\n<span class="token comment"># This would only run if no exception occurs. And an error here would NOT be caught.</span>\n<span class="token comment"># This would be printed in every case.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="for---else"><a href="#for---else" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>For - Else</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92951279522197820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`for n in range(2, 10):\n    for x in range(2, n):\n        if n % x == 0:\n            print(n, \'equals\', x, \'*\', n / x)\n            break\n    else: # 这个 else 从句会在循环正常结束时执行即循环没有遇到任何 break\n        # loop fell through without finding a factor\n        print(n, \'is a prime number\')`, `92951279522197820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">for</span> n <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> n <span class="token operator">%</span> x <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token string">\'equals\'</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> <span class="token string">\'*\'</span><span class="token punctuation">,</span> n <span class="token operator">/</span> x<span class="token punctuation">)</span>\n            <span class="token keyword">break</span>\n    <span class="token keyword">else</span><span class="token punctuation">:</span> <span class="token comment"># 这个 else 从句会在循环正常结束时执行即循环没有遇到任何 break</span>\n        <span class="token comment"># loop fell through without finding a factor</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token string">\'is a prime number\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="三元运算符"><a href="#%E4%B8%89%E5%85%83%E8%BF%90%E7%AE%97%E7%AC%A6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>三元运算符</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17880737300826755000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 正常例子\nis_fat = True\nstate = &quot;fat&quot; if is_fat else &quot;not fat&quot;\n\n# 另一种用法，较少使用，会把 2 个条件都执行\nfat = True\nfitness = (&quot;skinny&quot;, &quot;fat&quot;)[fat]\nprint(&quot;Ali is&quot;, fitness)\n# 输出: Ali is fat`, `17880737300826755000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment"># 正常例子</span>\nis_fat <span class="token operator">=</span> <span class="token boolean">True</span>\nstate <span class="token operator">=</span> <span class="token string">"fat"</span> <span class="token keyword">if</span> is_fat <span class="token keyword">else</span> <span class="token string">"not fat"</span>\n\n<span class="token comment"># 另一种用法，较少使用，会把 2 个条件都执行</span>\nfat <span class="token operator">=</span> <span class="token boolean">True</span>\nfitness <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">"skinny"</span><span class="token punctuation">,</span> <span class="token string">"fat"</span><span class="token punctuation">)</span><span class="token punctuation">[</span>fat<span class="token punctuation">]</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Ali is"</span><span class="token punctuation">,</span> fitness<span class="token punctuation">)</span>\n<span class="token comment"># 输出: Ali is fat</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="global"><a href="#global" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Global</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91946478855848170000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 首先，是没有使用 global 变量\ndef add(value1, value2):\n    result = value1 + value2\n\nadd(2, 4)\nprint(result)\n\n# Oh 糟了，我们遇到异常了。为什么会这样？\n# python 解释器报错说没有一个叫 result 的变量。\n# 这是因为 result 变量只能在创建它的函数内部才允许访问，除非它是全局的(global)。\nTraceback (most recent call last):\n  File &quot;&quot;, line 1, in\n    result\nNameError: name \'result\' is not defined\n\n# 现在我们运行相同的代码，不过是在将 result 变量设为 global 之后\ndef add(value1, value2):\n    global result\n    result = value1 + value2\n\nadd(2, 4)\nprint(result)\n6`, `91946478855848170000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment"># 首先，是没有使用 global 变量</span>\n<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>value1<span class="token punctuation">,</span> value2<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    result <span class="token operator">=</span> value1 <span class="token operator">+</span> value2\n\nadd<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>\n\n<span class="token comment"># Oh 糟了，我们遇到异常了。为什么会这样？</span>\n<span class="token comment"># python 解释器报错说没有一个叫 result 的变量。</span>\n<span class="token comment"># 这是因为 result 变量只能在创建它的函数内部才允许访问，除非它是全局的(global)。</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  File <span class="token string">""</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span>\n    result\nNameError<span class="token punctuation">:</span> name <span class="token string">\'result\'</span> <span class="token keyword">is</span> <span class="token keyword">not</span> defined\n\n<span class="token comment"># 现在我们运行相同的代码，不过是在将 result 变量设为 global 之后</span>\n<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>value1<span class="token punctuation">,</span> value2<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">global</span> result\n    result <span class="token operator">=</span> value1 <span class="token operator">+</span> value2\n\nadd<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>\n<span class="token number">6</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="return"><a href="#return" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Return</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14110068445809066000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 方法 1：\ndef profile():\n    name = &quot;Danny&quot;\n    age = 30\n    return (name, age)\n\nprofile_data = profile()\nprint(profile_data[0])\n# Output: Danny\n\nprint(profile_data[1])\n# Output: 30\n\n# 方法二：\ndef profile():\n    name = &quot;Danny&quot;\n    age = 30\n    return name, age`, `14110068445809066000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment"># 方法 1：</span>\n<span class="token keyword">def</span> <span class="token function">profile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    name <span class="token operator">=</span> <span class="token string">"Danny"</span>\n    age <span class="token operator">=</span> <span class="token number">30</span>\n    <span class="token keyword">return</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>\n\nprofile_data <span class="token operator">=</span> profile<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>profile_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token comment"># Output: Danny</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span>profile_data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token comment"># Output: 30</span>\n\n<span class="token comment"># 方法二：</span>\n<span class="token keyword">def</span> <span class="token function">profile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    name <span class="token operator">=</span> <span class="token string">"Danny"</span>\n    age <span class="token operator">=</span> <span class="token number">30</span>\n    <span class="token keyword">return</span> name<span class="token punctuation">,</span> age</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="open-函数"><a href="#open-%E5%87%BD%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>open 函数</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46525224904601805000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 以下代码有问题\nf = open(\'photo.jpg\', \'r+\')\njpgdata = f.read()\nf.close()\n\n# 异常产生不会调用到 f.close()，需要包裹成 with 语句\n# 读取文件，传入 r；\n# 读取并写入文件，传入 r+；\n# 覆盖写入文件，传入 w；\n# 在文件末尾附加内容，传入 a；\nwith open(\'photo.jpg\', \'r+\') as f:\n    jpgdata = f.read()\n\n# 检测文件格式\nimport io\n# 二进制模式打开\nwith open(\'photo.jpg\', \'rb\') as inf:\n    jpgdata = inf.read()\n# 检测文件格式\nif jpgdata.startswith(b\'\\xff\\xd8\'):\n    text = u\'This is a JPEG file (%d bytes long)\\n\'\nelse:\n    text = u\'This is a random file (%d bytes long)\\n\'\n# io.open 兼容 python2.x 和 python3.x\nwith io.open(\'summary.txt\', \'w\', encoding=\'utf-8\') as outf:\n    outf.write(text % len(jpgdata))`, `46525224904601805000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment"># 以下代码有问题</span>\nf <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'photo.jpg\'</span><span class="token punctuation">,</span> <span class="token string">\'r+\'</span><span class="token punctuation">)</span>\njpgdata <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>\nf<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token comment"># 异常产生不会调用到 f.close()，需要包裹成 with 语句</span>\n<span class="token comment"># 读取文件，传入 r；</span>\n<span class="token comment"># 读取并写入文件，传入 r+；</span>\n<span class="token comment"># 覆盖写入文件，传入 w；</span>\n<span class="token comment"># 在文件末尾附加内容，传入 a；</span>\n<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'photo.jpg\'</span><span class="token punctuation">,</span> <span class="token string">\'r+\'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>\n    jpgdata <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token comment"># 检测文件格式</span>\n<span class="token keyword">import</span> io\n<span class="token comment"># 二进制模式打开</span>\n<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'photo.jpg\'</span><span class="token punctuation">,</span> <span class="token string">\'rb\'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> inf<span class="token punctuation">:</span>\n    jpgdata <span class="token operator">=</span> inf<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token comment"># 检测文件格式</span>\n<span class="token keyword">if</span> jpgdata<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">b\'\\xff\\xd8\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    text <span class="token operator">=</span> <span class="token string">u\'This is a JPEG file (%d bytes long)\\n\'</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    text <span class="token operator">=</span> <span class="token string">u\'This is a random file (%d bytes long)\\n\'</span>\n<span class="token comment"># io.open 兼容 python2.x 和 python3.x</span>\n<span class="token keyword">with</span> io<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'summary.txt\'</span><span class="token punctuation">,</span> <span class="token string">\'w\'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">\'utf-8\'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> outf<span class="token punctuation">:</span>\n    outf<span class="token punctuation">.</span>write<span class="token punctuation">(</span>text <span class="token operator">%</span> <span class="token builtin">len</span><span class="token punctuation">(</span>jpgdata<span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="args-和-kwargs"><a href="#args-%E5%92%8C-kwargs" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code class="language-text">*args</code> 和 <code class="language-text">**kwargs</code></h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12228421019259494000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# *args\ndef test_var_args(f_arg, *argv):\n    print(&quot;first normal arg:&quot;, f_arg)\n    for arg in argv:\n        print(&quot;another arg through *argv:&quot;, arg)\n\ntest_var_args(\'yasoob\', \'python\', \'eggs\', \'test\')\n# Output:\n# first normal arg: yasoob\n# another arg through *argv: python\n# another arg through *argv: eggs\n# another arg through *argv: test\n\n## **kwargs\ndef greet_me(**kwargs):\n    for key, value in kwargs.items():\n        print(&quot;{0} == {1}&quot;.format(key, value))\ngreet_me(name=&quot;yasoob&quot;)\n# Output:\n# name == yasoob`, `12228421019259494000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment"># *args</span>\n<span class="token keyword">def</span> <span class="token function">test_var_args</span><span class="token punctuation">(</span>f_arg<span class="token punctuation">,</span> <span class="token operator">*</span>argv<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"first normal arg:"</span><span class="token punctuation">,</span> f_arg<span class="token punctuation">)</span>\n    <span class="token keyword">for</span> arg <span class="token keyword">in</span> argv<span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"another arg through *argv:"</span><span class="token punctuation">,</span> arg<span class="token punctuation">)</span>\n\ntest_var_args<span class="token punctuation">(</span><span class="token string">\'yasoob\'</span><span class="token punctuation">,</span> <span class="token string">\'python\'</span><span class="token punctuation">,</span> <span class="token string">\'eggs\'</span><span class="token punctuation">,</span> <span class="token string">\'test\'</span><span class="token punctuation">)</span>\n<span class="token comment"># Output:</span>\n<span class="token comment"># first normal arg: yasoob</span>\n<span class="token comment"># another arg through *argv: python</span>\n<span class="token comment"># another arg through *argv: eggs</span>\n<span class="token comment"># another arg through *argv: test</span>\n\n<span class="token comment">## **kwargs</span>\n<span class="token keyword">def</span> <span class="token function">greet_me</span><span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> kwargs<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"{0} == {1}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span>\ngreet_me<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"yasoob"</span><span class="token punctuation">)</span>\n<span class="token comment"># Output:</span>\n<span class="token comment"># name == yasoob</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="上下文管理器"><a href="#%E4%B8%8A%E4%B8%8B%E6%96%87%E7%AE%A1%E7%90%86%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>上下文管理器</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82244340289961770000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`with open(\'some_file\', \'w\') as opened_file:\n    opened_file.write(\'Hola!\')\n# 等价于\nfile = open(\'some_file\', \'w\')\ntry:\n    file.write(\'Hola!\')\nfinally:\n    file.close()\n\n# 实现上下文管理器\n# 1. with 语句先暂存了 File 类的 __exit__ 方法。\n# 2. 然后它调用 File 类的 __enter__ 方法。\n# 3. __enter__ 方法打开文件并返回给 with 语句。\n# 4. 打开的文件句柄被传递给 opened_file 参数。\n# 5. 我们使用 .write() 来写文件。\n# 6. with 语句调用之前暂存的 __exit__ 方法。\n# 7. __exit__ 方法关闭了文件。\nclass File(object):\n    def __init__(self, file_name, method):\n        self.file_obj = open(file_name, method)\n    def __enter__(self):\n        return self.file_obj\n    def __exit__(self, type, value, traceback):\n        self.file_obj.close()\n# 使用\nwith File(\'demo.txt\', \'w\') as opened_file:\n    opened_file.write(\'Hola!\')\n\n# 尝试下在 __exit__ 方法中处理异常\n# 1. 它把异常的 type，value 和 traceback 传递给 __exit__方法。\n# 2. 它让 __exit__ 方法来处理异常。\n# 3. 如果 __exit__ 返回的是 True，那么这个异常就被优雅地处理了。\n# 4. 如果 __exit__ 返回的是 True 以外的任何东西，那么这个异常将被 with 语句抛出。\nclass File(object):\n    def __init__(self, file_name, method):\n        self.file_obj = open(file_name, method)\n    def __enter__(self):\n        return self.file_obj\n    def __exit__(self, type, value, traceback):\n        print(&quot;Exception has been handled&quot;)\n        self.file_obj.close()\n        return True\nwith File(\'demo.txt\', \'w\') as opened_file:\n    opened_file.undefined_function()\n# Output: Exception has been handled\n\n# 基于生成器的实现\n# 1. Python 解释器遇到了 yield 关键字。因为这个缘故它创建了一个生成器而不是一个普通的函数。\n# 2. 因为这个装饰器，contextmanager 会被调用并传入函数名（open_file）作为参数。\n# 3. contextmanager 函数返回一个以 GeneratorContextManager 对象封装过的生成器。\n# 4. 这个 GeneratorContextManager 被赋值给 open_file 函数，我们实际上是在调用 GeneratorContextManager 对象。\nfrom contextlib import contextmanager\n\n@contextmanager\ndef open_file(name):\n    f = open(name, \'w\')\n    yield f\n    f.close()\n# 使用\nwith open_file(\'some_file\') as f:\n    f.write(\'hola!\')`, `82244340289961770000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'some_file\'</span><span class="token punctuation">,</span> <span class="token string">\'w\'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> opened_file<span class="token punctuation">:</span>\n    opened_file<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">\'Hola!\'</span><span class="token punctuation">)</span>\n<span class="token comment"># 等价于</span>\n<span class="token builtin">file</span> <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'some_file\'</span><span class="token punctuation">,</span> <span class="token string">\'w\'</span><span class="token punctuation">)</span>\n<span class="token keyword">try</span><span class="token punctuation">:</span>\n    <span class="token builtin">file</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">\'Hola!\'</span><span class="token punctuation">)</span>\n<span class="token keyword">finally</span><span class="token punctuation">:</span>\n    <span class="token builtin">file</span><span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token comment"># 实现上下文管理器</span>\n<span class="token comment"># 1. with 语句先暂存了 File 类的 __exit__ 方法。</span>\n<span class="token comment"># 2. 然后它调用 File 类的 __enter__ 方法。</span>\n<span class="token comment"># 3. __enter__ 方法打开文件并返回给 with 语句。</span>\n<span class="token comment"># 4. 打开的文件句柄被传递给 opened_file 参数。</span>\n<span class="token comment"># 5. 我们使用 .write() 来写文件。</span>\n<span class="token comment"># 6. with 语句调用之前暂存的 __exit__ 方法。</span>\n<span class="token comment"># 7. __exit__ 方法关闭了文件。</span>\n<span class="token keyword">class</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> file_name<span class="token punctuation">,</span> method<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>file_obj <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_name<span class="token punctuation">,</span> method<span class="token punctuation">)</span>\n    <span class="token keyword">def</span> <span class="token function">__enter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>file_obj\n    <span class="token keyword">def</span> <span class="token function">__exit__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> traceback<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>file_obj<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token comment"># 使用</span>\n<span class="token keyword">with</span> File<span class="token punctuation">(</span><span class="token string">\'demo.txt\'</span><span class="token punctuation">,</span> <span class="token string">\'w\'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> opened_file<span class="token punctuation">:</span>\n    opened_file<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">\'Hola!\'</span><span class="token punctuation">)</span>\n\n<span class="token comment"># 尝试下在 __exit__ 方法中处理异常</span>\n<span class="token comment"># 1. 它把异常的 type，value 和 traceback 传递给 __exit__方法。</span>\n<span class="token comment"># 2. 它让 __exit__ 方法来处理异常。</span>\n<span class="token comment"># 3. 如果 __exit__ 返回的是 True，那么这个异常就被优雅地处理了。</span>\n<span class="token comment"># 4. 如果 __exit__ 返回的是 True 以外的任何东西，那么这个异常将被 with 语句抛出。</span>\n<span class="token keyword">class</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> file_name<span class="token punctuation">,</span> method<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>file_obj <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_name<span class="token punctuation">,</span> method<span class="token punctuation">)</span>\n    <span class="token keyword">def</span> <span class="token function">__enter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>file_obj\n    <span class="token keyword">def</span> <span class="token function">__exit__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> traceback<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Exception has been handled"</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>file_obj<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token boolean">True</span>\n<span class="token keyword">with</span> File<span class="token punctuation">(</span><span class="token string">\'demo.txt\'</span><span class="token punctuation">,</span> <span class="token string">\'w\'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> opened_file<span class="token punctuation">:</span>\n    opened_file<span class="token punctuation">.</span>undefined_function<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token comment"># Output: Exception has been handled</span>\n\n<span class="token comment"># 基于生成器的实现</span>\n<span class="token comment"># 1. Python 解释器遇到了 yield 关键字。因为这个缘故它创建了一个生成器而不是一个普通的函数。</span>\n<span class="token comment"># 2. 因为这个装饰器，contextmanager 会被调用并传入函数名（open_file）作为参数。</span>\n<span class="token comment"># 3. contextmanager 函数返回一个以 GeneratorContextManager 对象封装过的生成器。</span>\n<span class="token comment"># 4. 这个 GeneratorContextManager 被赋值给 open_file 函数，我们实际上是在调用 GeneratorContextManager 对象。</span>\n<span class="token keyword">from</span> contextlib <span class="token keyword">import</span> contextmanager\n\n@contextmanager\n<span class="token keyword">def</span> <span class="token function">open_file</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">\'w\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> f\n    f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token comment"># 使用</span>\n<span class="token keyword">with</span> open_file<span class="token punctuation">(</span><span class="token string">\'some_file\'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>\n    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">\'hola!\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>// TODO <a href="https://py.eastlakeside.cn/book/FunctionalProgramming/README.html" target="_blank" rel="nofollow noreferrer noopener">https://py.eastlakeside.cn/book/FunctionalProgramming/README.html</a></p>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/Python语法一览/index.md absPath of file >>> MarkdownRemark",timeToRead:28,frontmatter:{date:"2022-04-18 14:16:27",path:"/python-syntax-overview/",tags:"后端, python, 读书笔记",title:"Python语法一览",draft:null}},{excerpt:"背景资料 Python-100-Days Python 教程 因本人具有前端背景，以下内容只列举和 javascript 不同的地方 解释器 Python 的解释器很多，但使用最广泛的还是 CPython。如果要和 Java 或 .Net 平台交互，最好的办法不是用 Jython 或 IronPython，而是通过网络调用来交互，确保各程序之间的独立性。 直接运行 py 文件 一般是通过   运行，但是可以按照以下步骤在 Mac 和 Linux 上直接运行  然后，通过命令给 hello.py…",html:'<h1 id="背景资料"><a href="#%E8%83%8C%E6%99%AF%E8%B5%84%E6%96%99" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>背景资料</h1>\n<ul>\n<li><a href="https://github.com/jackfrued/Python-100-Days" target="_blank" rel="nofollow noreferrer noopener">Python-100-Days</a></li>\n<li><a href="https://www.liaoxuefeng.com/wiki/1016959663602400" target="_blank" rel="nofollow noreferrer noopener">Python 教程</a></li>\n</ul>\n<p>因本人具有前端背景，以下内容只列举和 javascript 不同的地方</p>\n<h1 id="解释器"><a href="#%E8%A7%A3%E9%87%8A%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>解释器</h1>\n<p>Python 的解释器很多，但使用最广泛的还是 CPython。如果要和 Java 或 .Net 平台交互，最好的办法不是用 Jython 或 IronPython，而是通过网络调用来交互，确保各程序之间的独立性。</p>\n<h2 id="直接运行-py-文件"><a href="#%E7%9B%B4%E6%8E%A5%E8%BF%90%E8%A1%8C-py-%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>直接运行 py 文件</h2>\n<p>一般是通过 <code class="language-text">python hello.py</code> 运行，但是可以按照以下步骤在 Mac 和 Linux 上直接运行 <code class="language-text">./hello.py</code></p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15339414033896337000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`#!/usr/bin/env python3\n\nprint(\'hello, world\')`, `15339414033896337000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment">#!/usr/bin/env python3</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'hello, world\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>然后，通过命令给 hello.py 以执行权限，就可以直接运行</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72767674508138815000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`chmod a+x hello.py`, `72767674508138815000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token function">chmod</span> a+x hello.py</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h1 id="基础"><a href="#%E5%9F%BA%E7%A1%80" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>基础</h1>\n<ul>\n<li>解释型动态语言，运行速度慢，代码安全性差（不能加密）</li>\n<li><code class="language-text">#</code> 开头的是注释，语句以 <code class="language-text">:</code> 结尾时，缩进的语句是为代码块，一般缩进 4 个空格</li>\n<li>大小写敏感</li>\n</ul>\n<h2 id="数据类型与变量"><a href="#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B8%8E%E5%8F%98%E9%87%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>数据类型与变量</h2>\n<h3 id="数据类型"><a href="#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>数据类型</h3>\n<ul>\n<li>\n<p>整数：允许在数字中间以 <code class="language-text">_</code> 分隔，没有大小限制，<code class="language-text">//</code> 称为地板除，即只保留整数部分</p>\n</li>\n<li>\n<p>浮点数：浮点数运算有四舍五入的误差，整数运算是精确的，没有大小限制，超过一定范围表示为 <code class="language-text">inf</code>（无限大）</p>\n</li>\n<li>\n<p>字符串：</p>\n<ul>\n<li>以 <code class="language-text">&#39;</code> 或 <code class="language-text">&quot;</code> 括起来的文本，转义字符 <code class="language-text">\\</code> 可以用来转义</li>\n<li>使用 <code class="language-text">r&#39;&#39;</code> 表示 <code class="language-text">&#39;&#39;</code> 内部的字符串默认不转义</li>\n<li>用 <code class="language-text">&#39;&#39;&#39;...&#39;&#39;&#39;</code> 表示多行内容，可以和上面的 <code class="language-text">r</code> 结合使用，即 <code class="language-text">r&#39;&#39;&#39;...&#39;&#39;&#39;</code></li>\n</ul>\n</li>\n<li>\n<p>布尔值：值为 <code class="language-text">True</code> 或 <code class="language-text">False</code>，运算符为 <code class="language-text">and</code>、<code class="language-text">or</code>、<code class="language-text">not</code></p>\n</li>\n<li>\n<p>空值：值为 <code class="language-text">None</code></p>\n</li>\n</ul>\n<h3 id="变量与常量"><a href="#%E5%8F%98%E9%87%8F%E4%B8%8E%E5%B8%B8%E9%87%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>变量与常量</h3>\n<p>变量可以动态赋值，常量可以用全部大写的变量名表示，但没有任何机制可以保证不改变</p>\n<h2 id="字符串和编码"><a href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%92%8C%E7%BC%96%E7%A0%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>字符串和编码</h2>\n<h3 id="字符编码"><a href="#%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>字符编码</h3>\n<p>Unicode 把所有语言都统一到一套编码里，最常用的是 UCS-16 编码，用两个字节表示一个字符（如果要用到非常偏僻的字符，就需要 4 个字节）。现代操作系统和大多数编程语言都直接支持 Unicode。</p>\n<p>ASCII 编码和 Unicode 编码的区别：ASCII 编码是 1 个字节，而 Unicode 编码通常是 2 个字节。</p>\n<p>如果统一成 Unicode 编码，乱码问题从此消失了。但是，如果你写的文本基本上全部是英文的话，用 Unicode 编码比 ASCII 编码需要多一倍的存储空间，在存储和传输上就十分不划算。</p>\n<p>于是出现了把 Unicode 编码转化为“可变长编码”的 UTF-8 编码，如下表</p>\n<table>\n<thead>\n<tr>\n<th align="left">字符</th>\n<th align="left">ASCII</th>\n<th align="left">Unicode</th>\n<th align="left">UTF-8</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="left">A</td>\n<td align="left">01000001</td>\n<td align="left">00000000 01000001</td>\n<td align="left">01000001</td>\n</tr>\n<tr>\n<td align="left">中</td>\n<td align="left">x</td>\n<td align="left">01001110 00101101</td>\n<td align="left">11100100 10111000 10101101</td>\n</tr>\n</tbody>\n</table>\n<p>UTF-8 编码有一个额外的好处，就是 ASCII 编码实际上可以被看成是 UTF-8 编码的一部分，所以，大量只支持 ASCII 编码的历史遗留软件可以在 UTF-8 编码下继续工作。</p>\n<p>总结一下现在计算机系统通用的字符编码工作方式：</p>\n<p>在计算机内存中，统一使用 Unicode 编码，当需要保存到硬盘或者需要传输的时候，就转换为 UTF-8 编码。</p>\n<p>用记事本编辑的时候，从文件读取的 UTF-8 字符被转换为 Unicode 字符到内存里，编辑完成后，保存的时候再把 Unicode 转换为 UTF-8 保存到文件：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-04-03-18-12-23-cb32e16c63d13b9493f2f3f5dd74b01e-344e0.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 307px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 90.55374592833876%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAIAAADUsmlHAAAACXBIWXMAAAsSAAALEgHS3X78AAACQklEQVQ4y42Ty5KiQBBF+f9f8BdcdK+McNmGC3yEYRjtiI+xbaFFXgUIBQw+5hQ147CbzkihrMrKvHnzYiRJej57Lj/PjyIRhpHyqOVhFIQhzoIA7UEQxnFinE7u8v19OBz+WC6v1+vj2yZEbJCv+qWsruv7/c6iLEvWHPOXdFJKisZxnOe53sR4p2lqgKe19Ti77mg0mk6ni8ViPB4PBoNer9fpdF5fX+bzuY7UlelXXa6vynRlypIyyzJKJUkcNy/P83hfLtntdqv/Gp0bRIsmIrmkrnv+/DxmeZ6k6QXLMhy0sihyKdkjC7ucUYCLxhMG1uSL2tgo1SAgHiwJIyEV+SIhqqoyiCiKUhNGhB8EdFGWVVEUj4Y/duiWcYBvtVq9vQ1Mc+Q4TkFl7nD80Rgc/NzvPw4H23Y83+cmXFCQIkJEu91uvV5vt1spc3oiu0GEEGI2m00mE9pjYZomEciAEQKbLPQMJ7bjnE4n1ATSs+cTDGEVBQEPks1mczgcSE/PNCZlwT5lKVI1hsZoCsDcJ6+CHSgNJFqJztcXT9Lxl8ptSakGfb9NJ7BrauBMAvf9gDWXSQd/T2dk6BFCdCQ79GsEQXA8HiEDkHwblCU9p1WFTqvyn4GaiVx54sAmksshl6EaVPv93rZt13XVnP5nSp6o7Klt3QzqIR20IRjLstA5cyav1syfsPs95TLVnxzoJyig3bJWMM+H0e12+/0+I2xThanvuZF1qkSX5dqVmKXUjUEEz2ZapaZNO5zxRfwGn2n3zQIgDBkAAAAASUVORK5CYII=\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 04 03 18 12 23" title="" data-src="/static/2022-04-03-18-12-23-cb32e16c63d13b9493f2f3f5dd74b01e-344e0.png" data-srcset="/static/2022-04-03-18-12-23-cb32e16c63d13b9493f2f3f5dd74b01e-73b08.png 200w,\n/static/2022-04-03-18-12-23-cb32e16c63d13b9493f2f3f5dd74b01e-344e0.png 307w" data-sizes="(max-width: 307px) 100vw, 307px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<p>浏览网页的时候，服务器会把动态生成的 Unicode 内容转换为 UTF-8 再传输到浏览器：</p>\n<p><html><head></head><body><a class="gatsby-resp-image-link" href="/static/2022-04-03-18-13-07-5f58825fa7ef45001ea13bc2dbf5dcda-7d4e5.png" style="display: block" target="_blank" rel="noopener">\n  \n  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block; ; max-width: 302px; margin-left: auto; margin-right: auto;">\n    <span class="gatsby-resp-image-background-image" style="padding-bottom: 88.0794701986755%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAIAAADUsmlHAAAACXBIWXMAAAsSAAALEgHS3X78AAABoklEQVQ4y41T226CQBDl///B37AP9c14w1s0phhTEiONILDAAstVoYdF0brSODkZlmHOzhXJgbgu4HkUCi9vghBHwuNLUWaz2Xg8PhwOZVkWRVG+IXmeS/wax7IsXddd1/2fUNzkSiaO8xgtCALDMAghuIhSanCRZXmxWOx2u9sV5TO55iOF+Xy+2WygQej3+8PhsNPpdLsfsJzP5yZSRbZsG6fL5dLw27JtfGq3NMsk3/erdrteDd52CAVgNy3LoxSmK9w78FUSg4Rh6AcBNK48HnXGGF59P8jS7MlZalKtHzUTRpSUpmmcJDkXnOvu/CHfY3Kdptm3qk7lqaqq+/3+R9OU7XYwGMBIqd9O5imwKDqZpqZppmlibIiJLmBafA+9VnJ5jZyiVYxFqLqinU4oBGeERdmtNTeCkWCe0HEcI2DBRwqL6CkVgjTfoijCzjYViZ71bruPA6yBJDFum9goAWfRB82XbELEPylJkslkgvUcjUbYUEVRRJ9qPW3ivCSv1+vlcolftdf7XK1Wr8l8BN4T0PCQMa9qcQAFiD4g/gLi+gXiblyElAAAAABJRU5ErkJggg==\'); background-size: cover; display: block;">\n      <img class="gatsby-resp-image-image lazy" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px #fafafa;" alt="2022 04 03 18 13 07" title="" data-src="/static/2022-04-03-18-13-07-5f58825fa7ef45001ea13bc2dbf5dcda-7d4e5.png" data-srcset="/static/2022-04-03-18-13-07-5f58825fa7ef45001ea13bc2dbf5dcda-8a177.png 200w,\n/static/2022-04-03-18-13-07-5f58825fa7ef45001ea13bc2dbf5dcda-7d4e5.png 302w" data-sizes="(max-width: 302px) 100vw, 302px">\n    </span>\n  </span>\n  \n  </a>\n    </body></html></p>\n<h3 id="python-的字符串"><a href="#python-%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Python 的字符串</h3>\n<p>对于单个字符的编码，Python 提供了 ord() 函数获取字符的整数表示，chr() 函数把编码转换为对应的字符：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98325813894828770000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> ord(\'A\')\n65\n>>> ord(\'中\')\n20013\n>>> chr(66)\n\'B\'\n>>> chr(25991)\n\'文\'`, `98325813894828770000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">ord</span><span class="token punctuation">(</span><span class="token string">\'A\'</span><span class="token punctuation">)</span>\n<span class="token number">65</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">ord</span><span class="token punctuation">(</span><span class="token string">\'中\'</span><span class="token punctuation">)</span>\n<span class="token number">20013</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token number">66</span><span class="token punctuation">)</span>\n<span class="token string">\'B\'</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token number">25991</span><span class="token punctuation">)</span>\n<span class="token string">\'文\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果知道字符的整数编码，还可以用十六进制这么写 str：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49118813854486240000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> \'\\u4e2d\\u6587\'\n\'中文\'`, `49118813854486240000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token string">\'\\u4e2d\\u6587\'</span>\n<span class="token string">\'中文\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>两种写法完全是等价的。</p>\n<p>由于 Python 的字符串类型是 str，在内存中以 Unicode 表示，一个字符对应若干个字节。如果要在网络上传输，或者保存到磁盘上，就需要把 str 变为以字节为单位的 bytes。</p>\n<p>Python 对 bytes 类型的数据用带 b 前缀的单引号或双引号表示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4754620138733135000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`x = b\'ABC\'`, `4754620138733135000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">x <span class="token operator">=</span> <span class="token string">b\'ABC\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>要注意区分 <code class="language-text">&#39;ABC&#39;</code> 和 <code class="language-text">b&#39;ABC&#39;</code>，前者是 str，后者虽然内容显示得和前者一样，但 bytes 的每个字符都只占用一个字节。</p>\n<p>以 Unicode 表示的 str 通过 <code class="language-text">encode()</code> 方法可以编码为指定的 bytes，例如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80535844047212150000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> \'ABC\'.encode(\'ascii\')\nb\'ABC\'\n>>> \'中文\'.encode(\'utf-8\')\nb\'\\xe4\\xb8\\xad\\xe6\\x96\\x87\'\n>>> \'中文\'.encode(\'ascii\')\nTraceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\nUnicodeEncodeError: \'ascii\' codec can\'t encode characters in position 0-1: ordinal not in range(128)`, `80535844047212150000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token string">\'ABC\'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">\'ascii\'</span><span class="token punctuation">)</span>\n<span class="token string">b\'ABC\'</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token string">\'中文\'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">\'utf-8\'</span><span class="token punctuation">)</span>\n<span class="token string">b\'\\xe4\\xb8\\xad\\xe6\\x96\\x87\'</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token string">\'中文\'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">\'ascii\'</span><span class="token punctuation">)</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\nUnicodeEncodeError<span class="token punctuation">:</span> <span class="token string">\'ascii\'</span> codec can\'t encode characters <span class="token keyword">in</span> position <span class="token number">0</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span> ordinal <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>纯英文的 str 可以用 ASCII 编码为 bytes，内容是一样的，含有中文的 str 可以用 UTF-8 编码为 bytes。含有中文的 str 无法用 ASCII 编码，因为中文编码的范围超过了 ASCII 编码的范围，Python 会报错。</p>\n<p>在 bytes 中，无法显示为 ASCII 字符的字节，用 <code class="language-text">\\x##</code> 显示。</p>\n<p>反过来，如果我们从网络或磁盘上读取了字节流，那么读到的数据就是 bytes。要把 bytes 变为 str，就需要用 <code class="language-text">decode()</code> 方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52815316354703290000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> b\'ABC\'.decode(\'ascii\')\n\'ABC\'\n>>> b\'\\xe4\\xb8\\xad\\xe6\\x96\\x87\'.decode(\'utf-8\')\n\'中文\'`, `52815316354703290000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token string">b\'ABC\'</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">\'ascii\'</span><span class="token punctuation">)</span>\n<span class="token string">\'ABC\'</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token string">b\'\\xe4\\xb8\\xad\\xe6\\x96\\x87\'</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">\'utf-8\'</span><span class="token punctuation">)</span>\n<span class="token string">\'中文\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果 bytes 中包含无法解码的字节，<code class="language-text">decode()</code> 方法会报错：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97365608884391310000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> b\'\\xe4\\xb8\\xad\\xff\'.decode(\'utf-8\')\nTraceback (most recent call last):\n  ...\nUnicodeDecodeError: \'utf-8\' codec can\'t decode byte 0xff in position 3: invalid start byte`, `97365608884391310000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token string">b\'\\xe4\\xb8\\xad\\xff\'</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">\'utf-8\'</span><span class="token punctuation">)</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nUnicodeDecodeError<span class="token punctuation">:</span> <span class="token string">\'utf-8\'</span> codec can\'t decode byte <span class="token number">0xff</span> <span class="token keyword">in</span> position <span class="token number">3</span><span class="token punctuation">:</span> invalid start byte</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果 bytes 中只有一小部分无效的字节，可以传入 <code class="language-text">errors=&#39;ignore&#39;</code> 忽略错误的字节：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89923317129566030000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> b\'\\xe4\\xb8\\xad\\xff\'.decode(\'utf-8\', errors=\'ignore\')\n\'中\'`, `89923317129566030000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token string">b\'\\xe4\\xb8\\xad\\xff\'</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">\'utf-8\'</span><span class="token punctuation">,</span> errors<span class="token operator">=</span><span class="token string">\'ignore\'</span><span class="token punctuation">)</span>\n<span class="token string">\'中\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>要计算 str 包含多少个字符，可以用 <code class="language-text">len()</code> 函数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87735891605509520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> len(\'ABC\')\n3\n>>> len(\'中文\')\n2`, `87735891605509520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token string">\'ABC\'</span><span class="token punctuation">)</span>\n<span class="token number">3</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token string">\'中文\'</span><span class="token punctuation">)</span>\n<span class="token number">2</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p><code class="language-text">len()</code> 函数计算的是 str 的字符数，如果换成 bytes，<code class="language-text">len()</code> 函数就计算字节数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29077078936734323000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> len(b\'ABC\')\n3\n>>> len(b\'\\xe4\\xb8\\xad\\xe6\\x96\\x87\')\n6\n>>> len(\'中文\'.encode(\'utf-8\'))\n6`, `29077078936734323000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token string">b\'ABC\'</span><span class="token punctuation">)</span>\n<span class="token number">3</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token string">b\'\\xe4\\xb8\\xad\\xe6\\x96\\x87\'</span><span class="token punctuation">)</span>\n<span class="token number">6</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token string">\'中文\'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">\'utf-8\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token number">6</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可见，1 个中文字符经过 UTF-8 编码后通常会占用 3 个字节，而 1 个英文字符只占用 1 个字节。</p>\n<p>在操作字符串时，我们经常遇到 str 和 bytes 的互相转换。为了避免乱码问题，应当始终坚持使用 UTF-8 编码对 str 和 bytes 进行转换。</p>\n<p>由于 Python 源代码也是一个文本文件，所以，当你的源代码中包含中文的时候，在保存源代码时，就需要务必指定保存为 UTF-8 编码。当 Python 解释器读取源代码时，为了让它按 UTF-8 编码读取，我们通常在文件开头写上这两行：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27222234153160495000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`#!/usr/bin/env python3\n# -*- coding: utf-8 -*-`, `27222234153160495000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment">#!/usr/bin/env python3</span>\n<span class="token comment"># -*- coding: utf-8 -*-</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>第一行注释是为了告诉 Linux/OS X 系统，这是一个 Python 可执行程序，Windows 系统会忽略这个注释；</p>\n<p>第二行注释是为了告诉 Python 解释器，按照 UTF-8 编码读取源代码，否则，你在源代码中写的中文输出可能会有乱码。</p>\n<p>申明了 UTF-8 编码并不意味着你的 .py 文件就是 UTF-8 编码的，必须并且要确保文本编辑器正在使用 UTF-8 without BOM 编码：</p>\n<p>如果 .py 文件本身使用 UTF-8 编码，并且也申明了 <code class="language-text"># -*- coding: utf-8 -*-</code>，打开命令提示符测试就可以正常显示中文：</p>\n<h3 id="格式化"><a href="#%E6%A0%BC%E5%BC%8F%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>格式化</h3>\n<p>最后一个常见的问题是如何输出格式化的字符串。我们经常会输出类似’亲爱的 xxx 你好！你 xx 月的话费是 xx，余额是 xx’之类的字符串，而 xxx 的内容都是根据变量变化的，所以，需要一种简便的格式化字符串的方式。</p>\n<p>在 Python 中，采用的格式化方式和 C 语言是一致的，用 % 实现，举例如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4072641310255087000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> \'Hello, %s\' % \'world\'\n\'Hello, world\'\n>>> \'Hi, %s, you have \\$%d.\' % (\'Michael\', 1000000)\n\'Hi, Michael, you have \\$1000000.\'`, `4072641310255087000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token string">\'Hello, %s\'</span> <span class="token operator">%</span> <span class="token string">\'world\'</span>\n<span class="token string">\'Hello, world\'</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token string">\'Hi, %s, you have $%d.\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token string">\'Michael\'</span><span class="token punctuation">,</span> <span class="token number">1000000</span><span class="token punctuation">)</span>\n<span class="token string">\'Hi, Michael, you have $1000000.\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>你可能猜到了，% 运算符就是用来格式化字符串的。在字符串内部，%s 表示用字符串替换，%d 表示用整数替换，有几个 %? 占位符，后面就跟几个变量或者值，顺序要对应好。如果只有一个 %?，括号可以省略。</p>\n<p>常见的占位符有：</p>\n<table>\n<thead>\n<tr>\n<th align="left">占位符</th>\n<th align="left">替换内容</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="left">%d</td>\n<td align="left">整数</td>\n</tr>\n<tr>\n<td align="left">%f</td>\n<td align="left">浮点数</td>\n</tr>\n<tr>\n<td align="left">%s</td>\n<td align="left">字符串</td>\n</tr>\n<tr>\n<td align="left">%x</td>\n<td align="left">十六进制整数</td>\n</tr>\n</tbody>\n</table>\n<p>其中，格式化整数和浮点数还可以指定是否补 0 和整数与小数的位数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51341167172656110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`print(\'%2d-%02d\' % (3, 1)) # 3-01\nprint(\'%.2f\' % 3.1415926) # 3.14`, `51341167172656110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'%2d-%02d\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 3-01</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'%.2f\'</span> <span class="token operator">%</span> <span class="token number">3.1415926</span><span class="token punctuation">)</span> <span class="token comment"># 3.14</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>如果你不太确定应该用什么，%s 永远起作用，它会把任何数据类型转换为字符串：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51828396125963970000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> \'Age: %s. Gender: %s\' % (25, True)\n\'Age: 25. Gender: True\'`, `51828396125963970000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token string">\'Age: %s. Gender: %s\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span>\n<span class="token string">\'Age: 25. Gender: True\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>有些时候，字符串里面的 % 是一个普通字符怎么办？这个时候就需要转义，用 %% 来表示一个 %：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26168260139423547000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> \'growth rate: %d %%\' % 7\n\'growth rate: 7 %\'`, `26168260139423547000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token string">\'growth rate: %d %%\'</span> <span class="token operator">%</span> <span class="token number">7</span>\n<span class="token string">\'growth rate: 7 %\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h4 id="format"><a href="#format" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>format()</h4>\n<p>另一种格式化字符串的方法是使用字符串的 format() 方法，它会用传入的参数依次替换字符串内的占位符 <code class="language-text">{0}、{1}……</code>，不过这种方式写起来比 % 要麻烦得多：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93288199043544300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> \'Hello, {0}, 成绩提升了 {1:.1f}%\'.format(\'小明\', 17.125)\n\'Hello, 小明, 成绩提升了 17.1%\'`, `93288199043544300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token string">\'Hello, {0}, 成绩提升了 {1:.1f}%\'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">\'小明\'</span><span class="token punctuation">,</span> <span class="token number">17.125</span><span class="token punctuation">)</span>\n<span class="token string">\'Hello, 小明, 成绩提升了 17.1%\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h4 id="f-string"><a href="#f-string" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>f-string</h4>\n<p>最后一种格式化字符串的方法是使用以 f 开头的字符串，称之为 f-string，它和普通字符串不同之处在于，字符串如果包含 {xxx}，就会以对应的变量替换：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39340536878205130000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> r = 2.5\n>>> s = 3.14 * r ** 2\n>>> print(f\'The area of a circle with radius {r} is {s:.2f}\')\nThe area of a circle with radius 2.5 is 19.62`, `39340536878205130000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> r <span class="token operator">=</span> <span class="token number">2.5</span>\n<span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> <span class="token number">3.14</span> <span class="token operator">*</span> r <span class="token operator">**</span> <span class="token number">2</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f\'The area of a circle with radius </span><span class="token interpolation"><span class="token punctuation">{</span>r<span class="token punctuation">}</span></span><span class="token string"> is </span><span class="token interpolation"><span class="token punctuation">{</span>s<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">\'</span></span><span class="token punctuation">)</span>\nThe area of a circle <span class="token keyword">with</span> radius <span class="token number">2.5</span> <span class="token keyword">is</span> <span class="token number">19.62</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上述代码中，{r} 被变量 r 的值替换，{s:.2f} 被变量 s 的值替换，并且 : 后面的 .2f 指定了格式化参数（即保留两位小数），因此，{s:.2f} 的替换结果是 19.62。</p>\n<h2 id="使用-list-和-tuple"><a href="#%E4%BD%BF%E7%94%A8-list-%E5%92%8C-tuple" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 list 和 tuple</h2>\n<h3 id="list"><a href="#list" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>list</h3>\n<p>Python 内置的一种数据类型是列表：list。list 是一种有序的集合，可以随时添加和删除其中的元素。</p>\n<p>比如，列出班里所有同学的名字，就可以用一个 list 表示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4957349225248154000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> classmates = [\'Michael\', \'Bob\', \'Tracy\']\n>>> classmates\n[\'Michael\', \'Bob\', \'Tracy\']`, `4957349225248154000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> classmates <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'Michael\'</span><span class="token punctuation">,</span> <span class="token string">\'Bob\'</span><span class="token punctuation">,</span> <span class="token string">\'Tracy\'</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> classmates\n<span class="token punctuation">[</span><span class="token string">\'Michael\'</span><span class="token punctuation">,</span> <span class="token string">\'Bob\'</span><span class="token punctuation">,</span> <span class="token string">\'Tracy\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>变量 classmates 就是一个 list。用 len() 函数可以获得 list 元素的个数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29800180375657746000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> len(classmates)\n3`, `29800180375657746000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">len</span><span class="token punctuation">(</span>classmates<span class="token punctuation">)</span>\n<span class="token number">3</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>用索引来访问 list 中每一个位置的元素，记得索引是从 0 开始的：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40993873232771820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> classmates[0]\n\'Michael\'\n>>> classmates[1]\n\'Bob\'\n>>> classmates[2]\n\'Tracy\'\n>>> classmates[3]\nTraceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\nIndexError: list index out of range`, `40993873232771820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> classmates<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>\n<span class="token string">\'Michael\'</span>\n<span class="token operator">>></span><span class="token operator">></span> classmates<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>\n<span class="token string">\'Bob\'</span>\n<span class="token operator">>></span><span class="token operator">></span> classmates<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>\n<span class="token string">\'Tracy\'</span>\n<span class="token operator">>></span><span class="token operator">></span> classmates<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\nIndexError<span class="token punctuation">:</span> <span class="token builtin">list</span> index out of <span class="token builtin">range</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当索引超出了范围时，Python 会报一个 IndexError 错误，所以，要确保索引不要越界，记得最后一个元素的索引是 <code class="language-text">len(classmates) - 1</code>。</p>\n<p>如果要取最后一个元素，除了计算索引位置外，还可以用 -1 做索引，直接获取最后一个元素：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98705391673835600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> classmates[-1]\n\'Tracy\'`, `98705391673835600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> classmates<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>\n<span class="token string">\'Tracy\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>以此类推，可以获取倒数第 2 个、倒数第 3 个：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80581256716826940000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> classmates[-2]\n\'Bob\'\n>>> classmates[-3]\n\'Michael\'\n>>> classmates[-4]\nTraceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\nIndexError: list index out of range`, `80581256716826940000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> classmates<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span>\n<span class="token string">\'Bob\'</span>\n<span class="token operator">>></span><span class="token operator">></span> classmates<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span>\n<span class="token string">\'Michael\'</span>\n<span class="token operator">>></span><span class="token operator">></span> classmates<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\nIndexError<span class="token punctuation">:</span> <span class="token builtin">list</span> index out of <span class="token builtin">range</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当然，倒数第 4 个就越界了。</p>\n<p>list 是一个可变的有序表，所以，可以往 list 中追加元素到末尾：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45624513768143940000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> classmates.append(\'Adam\')\n>>> classmates\n[\'Michael\', \'Bob\', \'Tracy\', \'Adam\']`, `45624513768143940000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> classmates<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">\'Adam\'</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> classmates\n<span class="token punctuation">[</span><span class="token string">\'Michael\'</span><span class="token punctuation">,</span> <span class="token string">\'Bob\'</span><span class="token punctuation">,</span> <span class="token string">\'Tracy\'</span><span class="token punctuation">,</span> <span class="token string">\'Adam\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>也可以把元素插入到指定的位置，比如索引号为 1 的位置：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8140236667125023000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> classmates.insert(1, \'Jack\')\n>>> classmates\n[\'Michael\', \'Jack\', \'Bob\', \'Tracy\', \'Adam\']`, `8140236667125023000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> classmates<span class="token punctuation">.</span>insert<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'Jack\'</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> classmates\n<span class="token punctuation">[</span><span class="token string">\'Michael\'</span><span class="token punctuation">,</span> <span class="token string">\'Jack\'</span><span class="token punctuation">,</span> <span class="token string">\'Bob\'</span><span class="token punctuation">,</span> <span class="token string">\'Tracy\'</span><span class="token punctuation">,</span> <span class="token string">\'Adam\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>要删除 list 末尾的元素，用 pop() 方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32136007458494763000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> classmates.pop()\n\'Adam\'\n>>> classmates\n[\'Michael\', \'Jack\', \'Bob\', \'Tracy\']`, `32136007458494763000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> classmates<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token string">\'Adam\'</span>\n<span class="token operator">>></span><span class="token operator">></span> classmates\n<span class="token punctuation">[</span><span class="token string">\'Michael\'</span><span class="token punctuation">,</span> <span class="token string">\'Jack\'</span><span class="token punctuation">,</span> <span class="token string">\'Bob\'</span><span class="token punctuation">,</span> <span class="token string">\'Tracy\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>要删除指定位置的元素，用 pop(i) 方法，其中 i 是索引位置：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94296551215747510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> classmates.pop(1)\n\'Jack\'\n>>> classmates\n[\'Michael\', \'Bob\', \'Tracy\']`, `94296551215747510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> classmates<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>\n<span class="token string">\'Jack\'</span>\n<span class="token operator">>></span><span class="token operator">></span> classmates\n<span class="token punctuation">[</span><span class="token string">\'Michael\'</span><span class="token punctuation">,</span> <span class="token string">\'Bob\'</span><span class="token punctuation">,</span> <span class="token string">\'Tracy\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>要把某个元素替换成别的元素，可以直接赋值给对应的索引位置：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44082163329704624000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> classmates[1] = \'Sarah\'\n>>> classmates\n[\'Michael\', \'Sarah\', \'Tracy\']`, `44082163329704624000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> classmates<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">\'Sarah\'</span>\n<span class="token operator">>></span><span class="token operator">></span> classmates\n<span class="token punctuation">[</span><span class="token string">\'Michael\'</span><span class="token punctuation">,</span> <span class="token string">\'Sarah\'</span><span class="token punctuation">,</span> <span class="token string">\'Tracy\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>list 里面的元素的数据类型也可以不同，比如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76220987021013710000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> L = [\'Apple\', 123, True]`, `76220987021013710000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> L <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'Apple\'</span><span class="token punctuation">,</span> <span class="token number">123</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>list 元素也可以是另一个 list，比如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81548651328703800000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> s = [\'python\', \'java\', [\'asp\', \'php\'], \'scheme\']\n>>> len(s)\n4`, `81548651328703800000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'python\'</span><span class="token punctuation">,</span> <span class="token string">\'java\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'asp\'</span><span class="token punctuation">,</span> <span class="token string">\'php\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">\'scheme\'</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>\n<span class="token number">4</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>要注意 s 只有 4 个元素，其中 <code class="language-text">s[2]</code> 又是一个 list，如果拆开写就更容易理解了：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77467736953168460000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> p = [\'asp\', \'php\']\n>>> s = [\'python\', \'java\', p, \'scheme\']`, `77467736953168460000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> p <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'asp\'</span><span class="token punctuation">,</span> <span class="token string">\'php\'</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'python\'</span><span class="token punctuation">,</span> <span class="token string">\'java\'</span><span class="token punctuation">,</span> p<span class="token punctuation">,</span> <span class="token string">\'scheme\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>要拿到 <code class="language-text">&#39;php&#39;</code> 可以写 <code class="language-text">p[1]</code> 或者 <code class="language-text">s[2][1]</code>，因此 s 可以看成是一个二维数组，类似的还有三维、四维……数组，不过很少用到。</p>\n<p>如果一个 list 中一个元素也没有，就是一个空的 list，它的长度为 0：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83680589735980270000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> L = []\n>>> len(L)\n0`, `83680589735980270000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> L <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">len</span><span class="token punctuation">(</span>L<span class="token punctuation">)</span>\n<span class="token number">0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h3 id="tuple"><a href="#tuple" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>tuple</h3>\n<p>另一种有序列表叫元组：tuple。tuple 和 list 非常类似，但是 tuple 一旦初始化就不能修改，比如同样是列出同学的名字：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41839042647837290000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> classmates = (\'Michael\', \'Bob\', \'Tracy\')`, `41839042647837290000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> classmates <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">\'Michael\'</span><span class="token punctuation">,</span> <span class="token string">\'Bob\'</span><span class="token punctuation">,</span> <span class="token string">\'Tracy\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>现在，classmates 这个 tuple 不能变了，它也没有 append()，insert() 这样的方法。其他获取元素的方法和 list 是一样的，你可以正常地使用 <code class="language-text">classmates[0]</code>，<code class="language-text">classmates[-1]</code>，但不能赋值成另外的元素。</p>\n<p>不可变的 tuple 有什么意义？因为 tuple 不可变，所以代码更安全。如果可能，能用 tuple 代替 list 就尽量用 tuple。</p>\n<p>tuple 的陷阱：当你定义一个 tuple 时，在定义的时候，tuple 的元素就必须被确定下来，比如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39461003895821590000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> t = (1, 2)\n>>> t\n(1, 2)`, `39461003895821590000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> t <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> t\n<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>如果要定义一个空的 tuple，可以写成 ()：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35274951062740455000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> t = ()\n>>> t\n()`, `35274951062740455000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> t <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> t\n<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>但是，要定义一个只有 1 个元素的 tuple，如果你这么定义：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46446520027031265000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> t = (1)\n>>> t\n1`, `46446520027031265000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> t <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> t\n<span class="token number">1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>定义的不是 tuple，是 1 这个数，这是因为括号 () 既可以表示 tuple，又可以表示数学公式中的小括号，这就产生了歧义，因此，Python 规定，这种情况下，按小括号进行计算，计算结果自然是 1。</p>\n<p>所以，只有 1 个元素的 tuple 定义时必须加一个逗号 <code class="language-text">,</code>，来消除歧义：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46306832271582585000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> t = (1,)\n>>> t\n(1,)`, `46306832271582585000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> t <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> t\n<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>Python 在显示只有 1 个元素的 tuple 时，也会加一个逗号 <code class="language-text">,</code>，以免你误解成数学计算意义上的括号。</p>\n<p>最后来看一个 “可变的” tuple：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56597119016704680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> t = (\'a\', \'b\', [\'A\', \'B\'])\n>>> t[2][0] = \'X\'\n>>> t[2][1] = \'Y\'\n>>> t\n(\'a\', \'b\', [\'X\', \'Y\'])`, `56597119016704680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> t <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'A\'</span><span class="token punctuation">,</span> <span class="token string">\'B\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> t<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">\'X\'</span>\n<span class="token operator">>></span><span class="token operator">></span> t<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">\'Y\'</span>\n<span class="token operator">>></span><span class="token operator">></span> t\n<span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">\'X\'</span><span class="token punctuation">,</span> <span class="token string">\'Y\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>tuple 所谓的“不变”是说，tuple 的每个元素，指向永远不变。即指向 ‘a’，就不能改成指向 ‘b’，指向一个 list，就不能改成指向其他对象，但指向的这个 list 本身是可变的！</p>\n<h2 id="条件判断"><a href="#%E6%9D%A1%E4%BB%B6%E5%88%A4%E6%96%AD" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>条件判断</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26763674244615164000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`age = 3\nif age >= 18:\n    print(\'adult\')\nelif age >= 6:\n    print(\'teenager\')\nelse:\n    print(\'kid\')`, `26763674244615164000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">age <span class="token operator">=</span> <span class="token number">3</span>\n<span class="token keyword">if</span> age <span class="token operator">>=</span> <span class="token number">18</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'adult\'</span><span class="token punctuation">)</span>\n<span class="token keyword">elif</span> age <span class="token operator">>=</span> <span class="token number">6</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'teenager\'</span><span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'kid\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>if 判断条件还可以简写，比如写：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25624459287865100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if x:\n    print(\'True\')`, `25624459287865100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">if</span> x<span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'True\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>只要 x 是非零数值、非空字符串、非空 list 等，就判断为 True，否则为 False。</p>\n<h3 id="再议-input"><a href="#%E5%86%8D%E8%AE%AE-input" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>再议 input</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77271720556592400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`birth = input(\'birth: \')\nif birth < 2000:\n    print(\'00前\')\nelse:\n    print(\'00后\')`, `77271720556592400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">birth <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">\'birth: \'</span><span class="token punctuation">)</span>\n<span class="token keyword">if</span> birth <span class="token operator">&lt;</span> <span class="token number">2000</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'00前\'</span><span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'00后\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>输入 1982，结果报错：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27778443673578844000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Traceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\nTypeError: unorderable types: str() > int()`, `27778443673578844000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">Traceback (most recent call last):\n  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;\nTypeError: unorderable types: str() &gt; int()</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>这是因为 input() 返回的数据类型是 str，str 不能直接和整数比较，必须先把 str 转换成整数。Python 提供了 int() 函数来完成这件事情：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92706115905872660000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`s = input(\'birth: \')\nbirth = int(s)\nif birth < 2000:\n    print(\'00前\')\nelse:\n    print(\'00后\')`, `92706115905872660000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">s <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">\'birth: \'</span><span class="token punctuation">)</span>\nbirth <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>\n<span class="token keyword">if</span> birth <span class="token operator">&lt;</span> <span class="token number">2000</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'00前\'</span><span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'00后\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>再次运行，就可以得到正确地结果。但是，如果输入 abc 呢？又会得到一个错误信息：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56633508979031966000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Traceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\nValueError: invalid literal for int() with base 10: \'abc\'`, `56633508979031966000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\nValueError<span class="token punctuation">:</span> invalid literal <span class="token keyword">for</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">with</span> base <span class="token number">10</span><span class="token punctuation">:</span> <span class="token string">\'abc\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>原来 int() 函数发现一个字符串并不是合法的数字时就会报错，程序就退出了。</p>\n<p>如何检查并捕获程序运行期的错误呢？后面的错误和调试会讲到。</p>\n<h2 id="循环"><a href="#%E5%BE%AA%E7%8E%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>循环</h2>\n<p>Python 的循环有两种，一种是 for…in 循环，依次把 list 或 tuple 中的每个元素迭代出来，看例子：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38498064997517620000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`names = [\'Michael\', \'Bob\', \'Tracy\']\nfor name in names:\n    print(name)`, `38498064997517620000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'Michael\'</span><span class="token punctuation">,</span> <span class="token string">\'Bob\'</span><span class="token punctuation">,</span> <span class="token string">\'Tracy\'</span><span class="token punctuation">]</span>\n<span class="token keyword">for</span> name <span class="token keyword">in</span> names<span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>第二种循环是 while 循环，只要条件满足，就不断循环，条件不满足时退出循环。比如我们要计算 100 以内所有奇数之和，可以用 while 循环实现：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28319531130380170000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`sum = 0\nn = 99\nwhile n > 0:\n    sum = sum + n\n    n = n - 2\nprint(sum)`, `28319531130380170000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token builtin">sum</span> <span class="token operator">=</span> <span class="token number">0</span>\nn <span class="token operator">=</span> <span class="token number">99</span>\n<span class="token keyword">while</span> n <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>\n    <span class="token builtin">sum</span> <span class="token operator">=</span> <span class="token builtin">sum</span> <span class="token operator">+</span> n\n    n <span class="token operator">=</span> n <span class="token operator">-</span> <span class="token number">2</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">sum</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>break 提前结束循环，continue 提前结束本轮循环，并直接开始下一轮循环。</p>\n<h2 id="使用-dict-和-set"><a href="#%E4%BD%BF%E7%94%A8-dict-%E5%92%8C-set" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 dict 和 set</h2>\n<h3 id="dict"><a href="#dict" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>dict</h3>\n<p>Python 内置了字典：dict 的支持，dict 全称 dictionary，在其他语言中也称为 map，使用键-值（key-value）存储，具有极快的查找速度。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32575314579156967000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> d = {\'Michael\': 95, \'Bob\': 75, \'Tracy\': 85}\n>>> d[\'Michael\']\n95`, `32575314579156967000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> d <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">\'Michael\'</span><span class="token punctuation">:</span> <span class="token number">95</span><span class="token punctuation">,</span> <span class="token string">\'Bob\'</span><span class="token punctuation">:</span> <span class="token number">75</span><span class="token punctuation">,</span> <span class="token string">\'Tracy\'</span><span class="token punctuation">:</span> <span class="token number">85</span><span class="token punctuation">}</span>\n<span class="token operator">>></span><span class="token operator">></span> d<span class="token punctuation">[</span><span class="token string">\'Michael\'</span><span class="token punctuation">]</span>\n<span class="token number">95</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>如果 key 不存在，dict 就会报错：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36211626521824813000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> d[\'Thomas\']\nTraceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\nKeyError: \'Thomas\'`, `36211626521824813000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> d<span class="token punctuation">[</span><span class="token string">\'Thomas\'</span><span class="token punctuation">]</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\nKeyError<span class="token punctuation">:</span> <span class="token string">\'Thomas\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>要避免 key 不存在的错误，有两种办法，一是通过 in 判断 key 是否存在：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53165012766393520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> \'Thomas\' in d\nFalse`, `53165012766393520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token string">\'Thomas\'</span> <span class="token keyword">in</span> d\n<span class="token boolean">False</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>二是通过 dict 提供的 get() 方法，如果 key 不存在，可以返回 None，或者自己指定的 value：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60346036100053830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> d.get(\'Thomas\')\n>>> d.get(\'Thomas\', -1)\n-1`, `60346036100053830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> d<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'Thomas\'</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> d<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'Thomas\'</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>\n<span class="token operator">-</span><span class="token number">1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>注意：返回 None 的时候 Python 的交互环境不显示结果。</p>\n<p>要删除一个 key，用 pop(key) 方法，对应的 value 也会从 dict 中删除：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4834711335628672000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> d.pop(\'Bob\')\n75\n>>> d\n{\'Michael\': 95, \'Tracy\': 85}`, `4834711335628672000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> d<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">\'Bob\'</span><span class="token punctuation">)</span>\n<span class="token number">75</span>\n<span class="token operator">>></span><span class="token operator">></span> d\n<span class="token punctuation">{</span><span class="token string">\'Michael\'</span><span class="token punctuation">:</span> <span class="token number">95</span><span class="token punctuation">,</span> <span class="token string">\'Tracy\'</span><span class="token punctuation">:</span> <span class="token number">85</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>请务必注意，dict 内部存放的顺序和 key 放入的顺序是没有关系的。</p>\n<p>和 list 比较，dict 有以下几个特点：</p>\n<ol>\n<li>查找和插入的速度极快，不会随着 key 的增加而变慢；</li>\n<li>需要占用大量的内存，内存浪费多。</li>\n</ol>\n<p>而 list 相反：</p>\n<ol>\n<li>查找和插入的时间随着元素的增加而增加；</li>\n<li>占用空间小，浪费内存很少。</li>\n</ol>\n<p>所以，dict 是用空间来换取时间的一种方法。</p>\n<p>dict 可以用在需要高速查找的很多地方，在 Python 代码中几乎无处不在，正确使用 dict 非常重要，需要牢记的第一条就是 dict 的 key 必须是不可变对象。</p>\n<p>这是因为 dict 根据 key 来计算 value 的存储位置，如果每次计算相同的 key 得出的结果不同，那 dict 内部就完全混乱了。这个通过 key 计算位置的算法称为哈希算法（Hash）。</p>\n<p>要保证 hash 的正确性，作为 key 的对象就不能变。在 Python 中，字符串、整数等都是不可变的，因此，可以放心地作为 key。而 list 是可变的，就不能作为 key：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25450835446643550000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> key = [1, 2, 3]\n>>> d[key] = \'a list\'\nTraceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\nTypeError: unhashable type: \'list\'`, `25450835446643550000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> key <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> d<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">\'a list\'</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\nTypeError<span class="token punctuation">:</span> unhashable <span class="token builtin">type</span><span class="token punctuation">:</span> <span class="token string">\'list\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="set"><a href="#set" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>set</h3>\n<p>set 和 dict 类似，也是一组 key 的集合，但不存储 value。由于 key 不能重复，所以，在 set 中，没有重复的 key。</p>\n<p>要创建一个 set，需要提供一个 list 作为输入集合：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45332279938195840000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> s = set([1, 2, 3])\n>>> s\n{1, 2, 3}`, `45332279938195840000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> s\n<span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>注意，传入的参数[1, 2, 3]是一个 list，而显示的{1, 2, 3}只是告诉你这个 set 内部有 1，2，3 这 3 个元素，显示的顺序也不表示 set 是有序的。。</p>\n<p>重复元素在 set 中自动被过滤：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18581259116976520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> s = set([1, 1, 2, 2, 3, 3])\n>>> s\n{1, 2, 3}`, `18581259116976520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> s\n<span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>通过 add(key) 方法可以添加元素到 set 中，可以重复添加，但不会有效果：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38657416928485030000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> s.add(4)\n>>> s\n{1, 2, 3, 4}\n>>> s.add(4)\n>>> s\n{1, 2, 3, 4}`, `38657416928485030000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> s\n<span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">}</span>\n<span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> s\n<span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>通过 remove(key) 方法可以删除元素：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26908677423019078000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> s.remove(4)\n>>> s\n{1, 2, 3}`, `26908677423019078000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>remove<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> s\n<span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>set 可以看成数学意义上的无序和无重复元素的集合，因此，两个 set 可以做数学意义上的交集、并集等操作：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88280463099701080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> s1 = set([1, 2, 3])\n>>> s2 = set([2, 3, 4])\n>>> s1 & s2\n{2, 3}\n>>> s1 | s2\n{1, 2, 3, 4}`, `88280463099701080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> s1 <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> s2 <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> s1 <span class="token operator">&amp;</span> s2\n<span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span>\n<span class="token operator">>></span><span class="token operator">></span> s1 <span class="token operator">|</span> s2\n<span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>set 和 dict 的唯一区别仅在于没有存储对应的 value，但是，set 的原理和 dict 一样，所以，同样不可以放入可变对象，因为无法判断两个可变对象是否相等，也就无法保证 set 内部“不会有重复元素”。试试把 list 放入 set，看看是否会报错。</p>\n<h3 id="再议不可变对象"><a href="#%E5%86%8D%E8%AE%AE%E4%B8%8D%E5%8F%AF%E5%8F%98%E5%AF%B9%E8%B1%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>再议不可变对象</h3>\n<p>上面我们讲了，str 是不变对象，而 list 是可变对象。</p>\n<p>对于可变对象，比如 list，对 list 进行操作，list 内部的内容是会变化的，比如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73051764141343736000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> a = [\'c\', \'b\', \'a\']\n>>> a.sort()\n>>> a\n[\'a\', \'b\', \'c\']`, `73051764141343736000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'a\'</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> a<span class="token punctuation">.</span>sort<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> a\n<span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>而对于不可变对象，比如 str，对 str 进行操作呢：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8839657866539641000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> a = \'abc\'\n>>> a.replace(\'a\', \'A\')\n\'Abc\'\n>>> a\n\'abc\'`, `8839657866539641000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> <span class="token string">\'abc\'</span>\n<span class="token operator">>></span><span class="token operator">></span> a<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'A\'</span><span class="token punctuation">)</span>\n<span class="token string">\'Abc\'</span>\n<span class="token operator">>></span><span class="token operator">></span> a\n<span class="token string">\'abc\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>虽然字符串有个 replace() 方法，也确实变出了 ‘Abc’，但变量 a 最后仍是 ‘abc’，应该怎么理解呢？</p>\n<p>我们先把代码改成下面这样：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54065163656111670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> a = \'abc\'\n>>> b = a.replace(\'a\', \'A\')\n>>> b\n\'Abc\'\n>>> a\n\'abc\'`, `54065163656111670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> <span class="token string">\'abc\'</span>\n<span class="token operator">>></span><span class="token operator">></span> b <span class="token operator">=</span> a<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'A\'</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> b\n<span class="token string">\'Abc\'</span>\n<span class="token operator">>></span><span class="token operator">></span> a\n<span class="token string">\'abc\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>要始终牢记的是，a 是变量，而 ‘abc’ 才是字符串对象！有些时候，我们经常说，对象 a 的内容是 ‘abc’，但其实是指，a 本身是一个变量，它指向的对象的内容才是 ‘abc’</p>\n<p>当我们调用 a.replace(‘a’, ‘A’) 时，实际上调用方法 replace 是作用在字符串对象 ‘abc’ 上的，而这个方法虽然名字叫 replace，但却没有改变字符串 ‘abc’ 的内容。相反，replace 方法创建了一个新字符串 ‘Abc’ 并返回，如果我们用变量 b 指向该新字符串，就容易理解了，变量 a 仍指向原有的字符串 ‘abc’，但变量 b 却指向新字符串 ‘Abc’ 了</p>\n<p>所以，对于不变对象来说，调用对象自身的任意方法，也不会改变该对象自身的内容。相反，这些方法会创建新的对象并返回，这样，就保证了不可变对象本身永远是不可变的。</p>\n<h1 id="函数"><a href="#%E5%87%BD%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>函数</h1>\n<h2 id="调用函数"><a href="#%E8%B0%83%E7%94%A8%E5%87%BD%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>调用函数</h2>\n<p>Python 内置了很多有用的函数，我们可以直接调用</p>\n<p>可以直接从 Python 的官方网站查看<a href="http://docs.python.org/3/library/functions.html#abs" target="_blank" rel="nofollow noreferrer noopener">文档</a>，也可以在交互式命令行通过 help(abs) 查看 abs 函数的帮助信息</p>\n<h3 id="数据类型转换"><a href="#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>数据类型转换</h3>\n<p>Python 内置的常用函数还包括数据类型转换函数，比如 int() 函数可以把其他数据类型转换为整数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52892147517237360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> int(\'123\')\n123\n>>> int(12.34)\n12\n>>> float(\'12.34\')\n12.34\n>>> str(1.23)\n\'1.23\'\n>>> str(100)\n\'100\'\n>>> bool(1)\nTrue\n>>> bool(\'\')\nFalse`, `52892147517237360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token string">\'123\'</span><span class="token punctuation">)</span>\n<span class="token number">123</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token number">12.34</span><span class="token punctuation">)</span>\n<span class="token number">12</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">\'12.34\'</span><span class="token punctuation">)</span>\n<span class="token number">12.34</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">1.23</span><span class="token punctuation">)</span>\n<span class="token string">\'1.23\'</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>\n<span class="token string">\'100\'</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">bool</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">bool</span><span class="token punctuation">(</span><span class="token string">\'\'</span><span class="token punctuation">)</span>\n<span class="token boolean">False</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>函数名其实就是指向一个函数对象的引用，完全可以把函数名赋给一个变量，相当于给这个函数起了一个“别名”：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63551417868856700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> a = abs # 变量 a 指向 abs 函数\n>>> a(-1) # 所以也可以通过 a 调用 abs 函数\n1`, `63551417868856700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> <span class="token builtin">abs</span> <span class="token comment"># 变量 a 指向 abs 函数</span>\n<span class="token operator">>></span><span class="token operator">></span> a<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment"># 所以也可以通过 a 调用 abs 函数</span>\n<span class="token number">1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h3 id="定义函数"><a href="#%E5%AE%9A%E4%B9%89%E5%87%BD%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>定义函数</h3>\n<p>在 Python 中，定义一个函数要使用 def 语句，依次写出函数名、括号、括号中的参数和冒号 :，然后，在缩进块中编写函数体，函数的返回值用 return 语句返回。</p>\n<p>我们以自定义一个求绝对值的 my_abs 函数为例：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44508703519646155000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def my_abs(x):\n    if x >= 0:\n        return x\n    else:\n        return -x\n\nprint(my_abs(-99))`, `44508703519646155000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">my_abs</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> x <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> x\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token operator">-</span>x\n\n<span class="token keyword">print</span><span class="token punctuation">(</span>my_abs<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">99</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果没有 return 语句，函数执行完毕后也会返回结果，只是结果为 None。return None 可以简写为 return。</p>\n<h3 id="空函数"><a href="#%E7%A9%BA%E5%87%BD%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>空函数</h3>\n<p>如果想定义一个什么事也不做的空函数，可以用 pass 语句：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3033116802732127700"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def nop():\n    pass`, `3033116802732127700`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">nop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>pass 语句什么都不做，那有什么用？实际上 pass 可以用来作为占位符，比如现在还没想好怎么写函数的代码，就可以先放一个 pass，让代码能运行起来。</p>\n<p>pass 还可以用在其他语句里，比如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88926420512315210000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if age >= 18:\n    pass`, `88926420512315210000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">if</span> age <span class="token operator">>=</span> <span class="token number">18</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>缺少了 pass，代码运行就会有语法错误。</p>\n<h3 id="参数检查"><a href="#%E5%8F%82%E6%95%B0%E6%A3%80%E6%9F%A5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>参数检查</h3>\n<p>调用函数时，如果参数个数不对，Python 解释器会自动检查出来，并抛出 TypeError：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46504981458502345000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> my_abs(1, 2)\nTraceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\nTypeError: my_abs() takes 1 positional argument but 2 were given`, `46504981458502345000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> my_abs<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\nTypeError<span class="token punctuation">:</span> my_abs<span class="token punctuation">(</span><span class="token punctuation">)</span> takes <span class="token number">1</span> positional argument but <span class="token number">2</span> were given</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是如果参数类型不对，Python 解释器就无法帮我们检查。试试 my_abs 和内置函数 abs 的差别：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29414620539094917000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> my_abs(\'A\')\nTraceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\n  File &quot;<stdin>&quot;, line 2, in my_abs\nTypeError: unorderable types: str() >= int()\n>>> abs(\'A\')\nTraceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\nTypeError: bad operand type for abs(): \'str\'`, `29414620539094917000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> my_abs<span class="token punctuation">(</span><span class="token string">\'A\'</span><span class="token punctuation">)</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">in</span> my_abs\nTypeError<span class="token punctuation">:</span> unorderable types<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">abs</span><span class="token punctuation">(</span><span class="token string">\'A\'</span><span class="token punctuation">)</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\nTypeError<span class="token punctuation">:</span> bad operand <span class="token builtin">type</span> <span class="token keyword">for</span> <span class="token builtin">abs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token string">\'str\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当传入了不恰当的参数时，内置函数 abs 会检查出参数错误，而我们定义的 my_abs 没有参数检查，会导致 if 语句出错，出错信息和 abs 不一样。所以，这个函数定义不够完善。</p>\n<p>让我们修改一下 my_abs 的定义，对参数类型做检查，只允许整数和浮点数类型的参数。数据类型检查可以用内置函数 isinstance() 实现：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53382452766659830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def my_abs(x):\n    if not isinstance(x, (int, float)):\n        raise TypeError(\'bad operand type\')\n    if x >= 0:\n        return x\n    else:\n        return -x`, `53382452766659830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">my_abs</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> TypeError<span class="token punctuation">(</span><span class="token string">\'bad operand type\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">if</span> x <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> x\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token operator">-</span>x</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>添加了参数检查后，如果传入错误的参数类型，函数就可以抛出一个错误：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35552145477205733000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> my_abs(\'A\')\nTraceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\n  File &quot;<stdin>&quot;, line 3, in my_abs\nTypeError: bad operand type`, `35552145477205733000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> my_abs<span class="token punctuation">(</span><span class="token string">\'A\'</span><span class="token punctuation">)</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">3</span><span class="token punctuation">,</span> <span class="token keyword">in</span> my_abs\nTypeError<span class="token punctuation">:</span> bad operand <span class="token builtin">type</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>错误和异常处理将在后续讲到。</p>\n<h3 id="返回多个值"><a href="#%E8%BF%94%E5%9B%9E%E5%A4%9A%E4%B8%AA%E5%80%BC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>返回多个值</h3>\n<p>函数可以返回多个值吗？答案是肯定的。</p>\n<p>比如在游戏中经常需要从一个点移动到另一个点，给出坐标、位移和角度，就可以计算出新的坐标：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="51840016863427854000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import math\n\ndef move(x, y, step, angle=0):\n    nx = x + step * math.cos(angle)\n    ny = y - step * math.sin(angle)\n    return nx, ny`, `51840016863427854000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> math\n\n<span class="token keyword">def</span> <span class="token function">move</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> step<span class="token punctuation">,</span> angle<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    nx <span class="token operator">=</span> x <span class="token operator">+</span> step <span class="token operator">*</span> math<span class="token punctuation">.</span>cos<span class="token punctuation">(</span>angle<span class="token punctuation">)</span>\n    ny <span class="token operator">=</span> y <span class="token operator">-</span> step <span class="token operator">*</span> math<span class="token punctuation">.</span>sin<span class="token punctuation">(</span>angle<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> nx<span class="token punctuation">,</span> ny</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>import math 语句表示导入 math 包，并允许后续代码引用 math 包里的 sin、cos 等函数。</p>\n<p>然后，我们就可以同时获得返回值：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10485053543326138000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> x, y = move(100, 100, 60, math.pi / 6)\n>>> print(x, y)\n151.96152422706632 70.0`, `10485053543326138000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> x<span class="token punctuation">,</span> y <span class="token operator">=</span> move<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> math<span class="token punctuation">.</span>pi <span class="token operator">/</span> <span class="token number">6</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>\n<span class="token number">151.96152422706632</span> <span class="token number">70.0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>但其实这只是一种假象，Python 函数返回的仍然是单一值：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="40666387589105790000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> r = move(100, 100, 60, math.pi / 6)\n>>> print(r)\n(151.96152422706632, 70.0)`, `40666387589105790000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> r <span class="token operator">=</span> move<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> math<span class="token punctuation">.</span>pi <span class="token operator">/</span> <span class="token number">6</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>\n<span class="token punctuation">(</span><span class="token number">151.96152422706632</span><span class="token punctuation">,</span> <span class="token number">70.0</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>原来返回值是一个 tuple！但是，在语法上，返回一个 tuple 可以省略括号，而多个变量可以同时接收一个 tuple，按位置赋给对应的值，所以，Python 的函数返回多值其实就是返回一个 tuple，但写起来更方便。</p>\n<h2 id="函数的参数"><a href="#%E5%87%BD%E6%95%B0%E7%9A%84%E5%8F%82%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>函数的参数</h2>\n<h3 id="位置参数"><a href="#%E4%BD%8D%E7%BD%AE%E5%8F%82%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>位置参数</h3>\n<p>power(x, n)函数有两个参数：x 和 n，这两个参数都是位置参数，调用函数时，传入的两个值按照位置顺序依次赋给参数 x 和 n。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19917153376732967000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def power(x, n):\n    s = 1\n    while n > 0:\n        n = n - 1\n        s = s * x\n    return s`, `19917153376732967000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">power</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    s <span class="token operator">=</span> <span class="token number">1</span>\n    <span class="token keyword">while</span> n <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>\n        n <span class="token operator">=</span> n <span class="token operator">-</span> <span class="token number">1</span>\n        s <span class="token operator">=</span> s <span class="token operator">*</span> x\n    <span class="token keyword">return</span> s</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="默认参数"><a href="#%E9%BB%98%E8%AE%A4%E5%8F%82%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>默认参数</h3>\n<p>设置默认参数时，注意点如下：</p>\n<ol>\n<li>必选参数在前，默认参数在后，否则 Python 的解释器会报错（思考一下为什么默认参数不能放在必选参数前面）</li>\n<li>当函数有多个参数时，把变化大的参数放前面，变化小的参数放后面。变化小的参数就可以作为默认参数</li>\n</ol>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67470310758558940000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def enroll(name, gender, age=6, city=\'Beijing\'):\n    print(\'name:\', name)\n    print(\'gender:\', gender)\n    print(\'age:\', age)\n    print(\'city:\', city)`, `67470310758558940000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">enroll</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> gender<span class="token punctuation">,</span> age<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">,</span> city<span class="token operator">=</span><span class="token string">\'Beijing\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'name:\'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'gender:\'</span><span class="token punctuation">,</span> gender<span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'age:\'</span><span class="token punctuation">,</span> age<span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'city:\'</span><span class="token punctuation">,</span> city<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>有多个默认参数时，调用的时候，既可以按顺序提供默认参数，比如调用 <code class="language-text">enroll(&#39;Bob&#39;, &#39;M&#39;, 7)</code>，意思是，除了 name，gender 这两个参数外，最后 1 个参数应用在参数 age 上，city 参数由于没有提供，仍然使用默认值。</p>\n<p>也可以不按顺序提供部分默认参数。当不按顺序提供部分默认参数时，需要把参数名写上。比如调用 <code class="language-text">enroll(&#39;Adam&#39;, &#39;M&#39;, city=&#39;Tianjin&#39;)</code>，意思是，city 参数用传进去的值，其他默认参数继续使用默认值。</p>\n<p>默认参数很有用，但使用不当，也会掉坑里。默认参数有个最大的坑，演示如下：</p>\n<p>先定义一个函数，传入一个 list，添加一个 END 再返回：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6915933426076126000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def add_end(L=[]):\n    L.append(\'END\')\n    return L`, `6915933426076126000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">add_end</span><span class="token punctuation">(</span>L<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    L<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">\'END\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">return</span> L</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>当你正常调用时，结果似乎不错：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49442017621842395000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> add_end([1, 2, 3])\n[1, 2, 3, \'END\']\n>>> add_end([\'x\', \'y\', \'z\'])\n[\'x\', \'y\', \'z\', \'END\']`, `49442017621842395000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> add_end<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">\'END\'</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> add_end<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'x\'</span><span class="token punctuation">,</span> <span class="token string">\'y\'</span><span class="token punctuation">,</span> <span class="token string">\'z\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token punctuation">[</span><span class="token string">\'x\'</span><span class="token punctuation">,</span> <span class="token string">\'y\'</span><span class="token punctuation">,</span> <span class="token string">\'z\'</span><span class="token punctuation">,</span> <span class="token string">\'END\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当你使用默认参数调用时，一开始结果也是对的：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44648230653372826000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> add_end()\n[\'END\']`, `44648230653372826000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> add_end<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">[</span><span class="token string">\'END\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>但是，再次调用 add_end() 时，结果就不对了：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20290103761669222000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> add_end()\n[\'END\', \'END\']\n>>> add_end()\n[\'END\', \'END\', \'END\']`, `20290103761669222000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> add_end<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">[</span><span class="token string">\'END\'</span><span class="token punctuation">,</span> <span class="token string">\'END\'</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> add_end<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">[</span><span class="token string">\'END\'</span><span class="token punctuation">,</span> <span class="token string">\'END\'</span><span class="token punctuation">,</span> <span class="token string">\'END\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>原因解释如下：</p>\n<p>Python 函数在定义的时候，默认参数 L 的值就被计算出来了，即 []，因为默认参数 L 也是一个变量，它指向对象 []，每次调用该函数，如果改变了 L 的内容，则下次调用时，默认参数的内容就变了，不再是函数定义时的 [] 了。</p>\n<blockquote>\n<p>定义默认参数要牢记一点：默认参数必须指向不变对象！</p>\n</blockquote>\n<p>要修改上面的例子，我们可以用 None 这个不变对象来实现：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90277181518014840000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def add_end(L=None):\n    if L is None:\n        L = []\n    L.append(\'END\')\n    return L`, `90277181518014840000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">add_end</span><span class="token punctuation">(</span>L<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> L <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n        L <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n    L<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">\'END\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">return</span> L</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在，无论调用多少次，都不会有问题：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99104449337416220000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> add_end()\n[\'END\']\n>>> add_end()\n[\'END\']`, `99104449337416220000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> add_end<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">[</span><span class="token string">\'END\'</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> add_end<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">[</span><span class="token string">\'END\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>为什么要设计 str、None 这样的不变对象呢？因为不变对象一旦创建，对象内部的数据就不能修改，这样就减少了由于修改数据导致的错误。此外，由于对象不变，多任务环境下同时读取对象不需要加锁，同时读一点问题都没有。我们在编写程序时，如果可以设计一个不变对象，那就尽量设计成不变对象。</p>\n<h3 id="可变参数"><a href="#%E5%8F%AF%E5%8F%98%E5%8F%82%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>可变参数</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30229410180969830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def calc(numbers):\n    sum = 0\n    for n in numbers:\n        sum = sum + n * n\n    return sum`, `30229410180969830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">calc</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token builtin">sum</span> <span class="token operator">=</span> <span class="token number">0</span>\n    <span class="token keyword">for</span> n <span class="token keyword">in</span> numbers<span class="token punctuation">:</span>\n        <span class="token builtin">sum</span> <span class="token operator">=</span> <span class="token builtin">sum</span> <span class="token operator">+</span> n <span class="token operator">*</span> n\n    <span class="token keyword">return</span> <span class="token builtin">sum</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是调用的时候，需要先组装出一个 list 或 tuple：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3465494071744657000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> calc([1, 2, 3])\n14\n>>> calc((1, 3, 5, 7))\n84`, `3465494071744657000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> calc<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token number">14</span>\n<span class="token operator">>></span><span class="token operator">></span> calc<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token number">84</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果利用可变参数，调用函数的方式可以简化成这样：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31480950832545784000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> calc(1, 2, 3)\n14\n>>> calc(1, 3, 5, 7)\n84`, `31480950832545784000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> calc<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>\n<span class="token number">14</span>\n<span class="token operator">>></span><span class="token operator">></span> calc<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span>\n<span class="token number">84</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>所以，我们把函数的参数改为可变参数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90280525529042930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def calc(*numbers):\n    sum = 0\n    for n in numbers:\n        sum = sum + n * n\n    return sum`, `90280525529042930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">calc</span><span class="token punctuation">(</span><span class="token operator">*</span>numbers<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token builtin">sum</span> <span class="token operator">=</span> <span class="token number">0</span>\n    <span class="token keyword">for</span> n <span class="token keyword">in</span> numbers<span class="token punctuation">:</span>\n        <span class="token builtin">sum</span> <span class="token operator">=</span> <span class="token builtin">sum</span> <span class="token operator">+</span> n <span class="token operator">*</span> n\n    <span class="token keyword">return</span> <span class="token builtin">sum</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在函数内部，参数 numbers 接收到的是一个 tuple，因此，函数代码完全不变。但是，调用该函数时，可以传入任意个参数，包括 0 个参数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49249372425312950000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> calc(1, 2)\n5\n>>> calc()\n0`, `49249372425312950000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> calc<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>\n<span class="token number">5</span>\n<span class="token operator">>></span><span class="token operator">></span> calc<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token number">0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果已经有一个 list 或者 tuple，要调用一个可变参数怎么办？可以这样做：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85453269140483080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> nums = [1, 2, 3]\n>>> calc(nums[0], nums[1], nums[2])\n14`, `85453269140483080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> nums <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> calc<span class="token punctuation">(</span>nums<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> nums<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> nums<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token number">14</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>这种写法当然是可行的，问题是太繁琐，所以 Python 允许你在 list 或 tuple 前面加一个 * 号，把 list 或 tuple 的元素变成可变参数传进去：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97831399987064400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> nums = [1, 2, 3]\n>>> calc(*nums)\n14`, `97831399987064400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> nums <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> calc<span class="token punctuation">(</span><span class="token operator">*</span>nums<span class="token punctuation">)</span>\n<span class="token number">14</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>*nums 表示把 nums 这个 list 的所有元素作为可变参数传进去。这种写法相当有用，而且很常见。</p>\n<h3 id="关键字参数"><a href="#%E5%85%B3%E9%94%AE%E5%AD%97%E5%8F%82%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>关键字参数</h3>\n<p>可变参数允许你传入 0 个或任意个参数，这些可变参数在函数调用时自动组装为一个 tuple。而关键字参数允许你传入 0 个或任意个含参数名的参数，这些关键字参数在函数内部自动组装为一个 dict。请看示例：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5543876576871187000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def person(name, age, **kw):\n    print(\'name:\', name, \'age:\', age, \'other:\', kw)`, `5543876576871187000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">person</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'name:\'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token string">\'age:\'</span><span class="token punctuation">,</span> age<span class="token punctuation">,</span> <span class="token string">\'other:\'</span><span class="token punctuation">,</span> kw<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>函数 person 除了必选参数 name 和 age 外，还接受关键字参数 kw。在调用该函数时，可以只传入必选参数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15968654407372517000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> person(\'Michael\', 30)\nname: Michael age: 30 other: {}`, `15968654407372517000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> person<span class="token punctuation">(</span><span class="token string">\'Michael\'</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span>\nname<span class="token punctuation">:</span> Michael age<span class="token punctuation">:</span> <span class="token number">30</span> other<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>也可以传入任意个数的关键字参数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76022178355503460000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> person(\'Bob\', 35, city=\'Beijing\')\nname: Bob age: 35 other: {\'city\': \'Beijing\'}\n>>> person(\'Adam\', 45, gender=\'M\', job=\'Engineer\')\nname: Adam age: 45 other: {\'gender\': \'M\', \'job\': \'Engineer\'}`, `76022178355503460000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> person<span class="token punctuation">(</span><span class="token string">\'Bob\'</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">,</span> city<span class="token operator">=</span><span class="token string">\'Beijing\'</span><span class="token punctuation">)</span>\nname<span class="token punctuation">:</span> Bob age<span class="token punctuation">:</span> <span class="token number">35</span> other<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'city\'</span><span class="token punctuation">:</span> <span class="token string">\'Beijing\'</span><span class="token punctuation">}</span>\n<span class="token operator">>></span><span class="token operator">></span> person<span class="token punctuation">(</span><span class="token string">\'Adam\'</span><span class="token punctuation">,</span> <span class="token number">45</span><span class="token punctuation">,</span> gender<span class="token operator">=</span><span class="token string">\'M\'</span><span class="token punctuation">,</span> job<span class="token operator">=</span><span class="token string">\'Engineer\'</span><span class="token punctuation">)</span>\nname<span class="token punctuation">:</span> Adam age<span class="token punctuation">:</span> <span class="token number">45</span> other<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'gender\'</span><span class="token punctuation">:</span> <span class="token string">\'M\'</span><span class="token punctuation">,</span> <span class="token string">\'job\'</span><span class="token punctuation">:</span> <span class="token string">\'Engineer\'</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>关键字参数有什么用？它可以扩展函数的功能。比如，在 person 函数里，我们保证能接收到 name 和 age 这两个参数，但是，如果调用者愿意提供更多的参数，我们也能收到。试想你正在做一个用户注册的功能，除了用户名和年龄是必填项外，其他都是可选项，利用关键字参数来定义这个函数就能满足注册的需求。</p>\n<p>和可变参数类似，也可以先组装出一个 dict，然后，把该 dict 转换为关键字参数传进去：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86984410412178700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> extra = {\'city\': \'Beijing\', \'job\': \'Engineer\'}\n>>> person(\'Jack\', 24, city=extra[\'city\'], job=extra[\'job\'])\nname: Jack age: 24 other: {\'city\': \'Beijing\', \'job\': \'Engineer\'}`, `86984410412178700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> extra <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">\'city\'</span><span class="token punctuation">:</span> <span class="token string">\'Beijing\'</span><span class="token punctuation">,</span> <span class="token string">\'job\'</span><span class="token punctuation">:</span> <span class="token string">\'Engineer\'</span><span class="token punctuation">}</span>\n<span class="token operator">>></span><span class="token operator">></span> person<span class="token punctuation">(</span><span class="token string">\'Jack\'</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> city<span class="token operator">=</span>extra<span class="token punctuation">[</span><span class="token string">\'city\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> job<span class="token operator">=</span>extra<span class="token punctuation">[</span><span class="token string">\'job\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\nname<span class="token punctuation">:</span> Jack age<span class="token punctuation">:</span> <span class="token number">24</span> other<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'city\'</span><span class="token punctuation">:</span> <span class="token string">\'Beijing\'</span><span class="token punctuation">,</span> <span class="token string">\'job\'</span><span class="token punctuation">:</span> <span class="token string">\'Engineer\'</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>当然，上面复杂的调用可以用简化的写法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34427562827048088000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> extra = {\'city\': \'Beijing\', \'job\': \'Engineer\'}\n>>> person(\'Jack\', 24, **extra)\nname: Jack age: 24 other: {\'city\': \'Beijing\', \'job\': \'Engineer\'}`, `34427562827048088000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> extra <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">\'city\'</span><span class="token punctuation">:</span> <span class="token string">\'Beijing\'</span><span class="token punctuation">,</span> <span class="token string">\'job\'</span><span class="token punctuation">:</span> <span class="token string">\'Engineer\'</span><span class="token punctuation">}</span>\n<span class="token operator">>></span><span class="token operator">></span> person<span class="token punctuation">(</span><span class="token string">\'Jack\'</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token operator">**</span>extra<span class="token punctuation">)</span>\nname<span class="token punctuation">:</span> Jack age<span class="token punctuation">:</span> <span class="token number">24</span> other<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">\'city\'</span><span class="token punctuation">:</span> <span class="token string">\'Beijing\'</span><span class="token punctuation">,</span> <span class="token string">\'job\'</span><span class="token punctuation">:</span> <span class="token string">\'Engineer\'</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p><code class="language-text">**extra</code> 表示把 extra 这个 dict 的所有 key-value 用关键字参数传入到函数的 <code class="language-text">**kw</code> 参数，kw 将获得一个 dict，注意 kw 获得的 dict 是 extra 的一份拷贝，对 kw 的改动不会影响到函数外的 extra。</p>\n<h3 id="命名关键字参数"><a href="#%E5%91%BD%E5%90%8D%E5%85%B3%E9%94%AE%E5%AD%97%E5%8F%82%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>命名关键字参数</h3>\n<p>对于关键字参数，函数的调用者可以传入任意不受限制的关键字参数。至于到底传入了哪些，就需要在函数内部通过 kw 检查。</p>\n<p>仍以 person() 函数为例，我们希望检查是否有 city 和 job 参数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12195726193705126000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def person(name, age, **kw):\n    if \'city\' in kw:\n        # 有 city 参数\n        pass\n    if \'job\' in kw:\n        # 有 job 参数\n        pass\n    print(\'name:\', name, \'age:\', age, \'other:\', kw)`, `12195726193705126000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">person</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> <span class="token string">\'city\'</span> <span class="token keyword">in</span> kw<span class="token punctuation">:</span>\n        <span class="token comment"># 有 city 参数</span>\n        <span class="token keyword">pass</span>\n    <span class="token keyword">if</span> <span class="token string">\'job\'</span> <span class="token keyword">in</span> kw<span class="token punctuation">:</span>\n        <span class="token comment"># 有 job 参数</span>\n        <span class="token keyword">pass</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'name:\'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token string">\'age:\'</span><span class="token punctuation">,</span> age<span class="token punctuation">,</span> <span class="token string">\'other:\'</span><span class="token punctuation">,</span> kw<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是调用者仍可以传入不受限制的关键字参数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90226675461586390000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> person(\'Jack\', 24, city=\'Beijing\', addr=\'Chaoyang\', zipcode=123456)`, `90226675461586390000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> person<span class="token punctuation">(</span><span class="token string">\'Jack\'</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> city<span class="token operator">=</span><span class="token string">\'Beijing\'</span><span class="token punctuation">,</span> addr<span class="token operator">=</span><span class="token string">\'Chaoyang\'</span><span class="token punctuation">,</span> zipcode<span class="token operator">=</span><span class="token number">123456</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>如果要限制关键字参数的名字，就可以用命名关键字参数，例如，只接收 city 和 job 作为关键字参数。这种方式定义的函数如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22826676552066960000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def person(name, age, *, city, job):\n    print(name, age, city, job)`, `22826676552066960000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">person</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span> city<span class="token punctuation">,</span> job<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> city<span class="token punctuation">,</span> job<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>和关键字参数 <code class="language-text">**kw</code> 不同，命名关键字参数需要一个特殊分隔符 <code class="language-text">*</code>，<code class="language-text">*</code> 后面的参数被视为命名关键字参数。</p>\n<p>调用方式如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4661890409744963000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> person(\'Jack\', 24, city=\'Beijing\', job=\'Engineer\')\nJack 24 Beijing Engineer`, `4661890409744963000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> person<span class="token punctuation">(</span><span class="token string">\'Jack\'</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> city<span class="token operator">=</span><span class="token string">\'Beijing\'</span><span class="token punctuation">,</span> job<span class="token operator">=</span><span class="token string">\'Engineer\'</span><span class="token punctuation">)</span>\nJack <span class="token number">24</span> Beijing Engineer</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>如果函数定义中已经有了一个可变参数，后面跟着的命名关键字参数就不再需要一个特殊分隔符 <code class="language-text">*</code> 了：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="68281243790910870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def person(name, age, *args, city, job):\n    print(name, age, args, city, job)`, `68281243790910870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">person</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> city<span class="token punctuation">,</span> job<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> args<span class="token punctuation">,</span> city<span class="token punctuation">,</span> job<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>命名关键字参数必须传入参数名，这和位置参数不同。如果没有传入参数名，调用将报错：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46708584448153575000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> person(\'Jack\', 24, \'Beijing\', \'Engineer\')\nTraceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\nTypeError: person() missing 2 required keyword-only arguments: \'city\' and \'job\'`, `46708584448153575000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> person<span class="token punctuation">(</span><span class="token string">\'Jack\'</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token string">\'Beijing\'</span><span class="token punctuation">,</span> <span class="token string">\'Engineer\'</span><span class="token punctuation">)</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\nTypeError<span class="token punctuation">:</span> person<span class="token punctuation">(</span><span class="token punctuation">)</span> missing <span class="token number">2</span> required keyword<span class="token operator">-</span>only arguments<span class="token punctuation">:</span> <span class="token string">\'city\'</span> <span class="token keyword">and</span> <span class="token string">\'job\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>由于调用时缺少参数名 city 和 job，Python 解释器把前两个参数视为位置参数，后两个参数传给 <code class="language-text">*args</code>，但缺少命名关键字参数导致报错。</p>\n<p>命名关键字参数可以有缺省值，从而简化调用：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89426324654697820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def person(name, age, *, city=\'Beijing\', job):\n    print(name, age, city, job)`, `89426324654697820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">person</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span> city<span class="token operator">=</span><span class="token string">\'Beijing\'</span><span class="token punctuation">,</span> job<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> city<span class="token punctuation">,</span> job<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>由于命名关键字参数 city 具有默认值，调用时，可不传入 city 参数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86767345707458970000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> person(\'Jack\', 24, job=\'Engineer\')\nJack 24 Beijing Engineer`, `86767345707458970000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> person<span class="token punctuation">(</span><span class="token string">\'Jack\'</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> job<span class="token operator">=</span><span class="token string">\'Engineer\'</span><span class="token punctuation">)</span>\nJack <span class="token number">24</span> Beijing Engineer</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>使用命名关键字参数时，要特别注意，如果没有可变参数，就必须加一个 <code class="language-text">*</code> 作为特殊分隔符。如果缺少 <code class="language-text">*</code>，Python 解释器将无法识别位置参数和命名关键字参数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33834330982470574000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def person(name, age, city, job):\n    # 缺少 *，city 和 job 被视为位置参数\n    pass`, `33834330982470574000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">person</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> city<span class="token punctuation">,</span> job<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token comment"># 缺少 *，city 和 job 被视为位置参数</span>\n    <span class="token keyword">pass</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h3 id="参数组合"><a href="#%E5%8F%82%E6%95%B0%E7%BB%84%E5%90%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>参数组合</h3>\n<p>在 Python 中定义函数，可以用必选参数、默认参数、可变参数、关键字参数和命名关键字参数，这 5 种参数都可以组合使用。但是请注意，参数定义的顺序必须是：必选参数、默认参数、可变参数、命名关键字参数和关键字参数。</p>\n<p>比如定义一个函数，包含上述若干种参数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86036352835785520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def f1(a, b, c=0, *args, **kw):\n    print(\'a =\', a, \'b =\', b, \'c =\', c, \'args =\', args, \'kw =\', kw)\n\ndef f2(a, b, c=0, *, d, **kw):\n    print(\'a =\', a, \'b =\', b, \'c =\', c, \'d =\', d, \'kw =\', kw)`, `86036352835785520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">f1</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'a =\'</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token string">\'b =\'</span><span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token string">\'c =\'</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> <span class="token string">\'args =\'</span><span class="token punctuation">,</span> args<span class="token punctuation">,</span> <span class="token string">\'kw =\'</span><span class="token punctuation">,</span> kw<span class="token punctuation">)</span>\n\n<span class="token keyword">def</span> <span class="token function">f2</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span> d<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'a =\'</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token string">\'b =\'</span><span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token string">\'c =\'</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> <span class="token string">\'d =\'</span><span class="token punctuation">,</span> d<span class="token punctuation">,</span> <span class="token string">\'kw =\'</span><span class="token punctuation">,</span> kw<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在函数调用的时候，Python 解释器自动按照参数位置和参数名把对应的参数传进去。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50439250297165720000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> f1(1, 2)\na = 1 b = 2 c = 0 args = () kw = {}\n>>> f1(1, 2, c=3)\na = 1 b = 2 c = 3 args = () kw = {}\n>>> f1(1, 2, 3, \'a\', \'b\')\na = 1 b = 2 c = 3 args = (\'a\', \'b\') kw = {}\n>>> f1(1, 2, 3, \'a\', \'b\', x=99)\na = 1 b = 2 c = 3 args = (\'a\', \'b\') kw = {\'x\': 99}\n>>> f2(1, 2, d=99, ext=None)\na = 1 b = 2 c = 0 d = 99 kw = {\'ext\': None}`, `50439250297165720000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> f1<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>\na <span class="token operator">=</span> <span class="token number">1</span> b <span class="token operator">=</span> <span class="token number">2</span> c <span class="token operator">=</span> <span class="token number">0</span> args <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> kw <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n<span class="token operator">>></span><span class="token operator">></span> f1<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> c<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>\na <span class="token operator">=</span> <span class="token number">1</span> b <span class="token operator">=</span> <span class="token number">2</span> c <span class="token operator">=</span> <span class="token number">3</span> args <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> kw <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n<span class="token operator">>></span><span class="token operator">></span> f1<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">)</span>\na <span class="token operator">=</span> <span class="token number">1</span> b <span class="token operator">=</span> <span class="token number">2</span> c <span class="token operator">=</span> <span class="token number">3</span> args <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">)</span> kw <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n<span class="token operator">>></span><span class="token operator">></span> f1<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> x<span class="token operator">=</span><span class="token number">99</span><span class="token punctuation">)</span>\na <span class="token operator">=</span> <span class="token number">1</span> b <span class="token operator">=</span> <span class="token number">2</span> c <span class="token operator">=</span> <span class="token number">3</span> args <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">)</span> kw <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">\'x\'</span><span class="token punctuation">:</span> <span class="token number">99</span><span class="token punctuation">}</span>\n<span class="token operator">>></span><span class="token operator">></span> f2<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> d<span class="token operator">=</span><span class="token number">99</span><span class="token punctuation">,</span> ext<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>\na <span class="token operator">=</span> <span class="token number">1</span> b <span class="token operator">=</span> <span class="token number">2</span> c <span class="token operator">=</span> <span class="token number">0</span> d <span class="token operator">=</span> <span class="token number">99</span> kw <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">\'ext\'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>最神奇的是通过一个 tuple 和 dict，你也可以调用上述函数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76441238592723530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> args = (1, 2, 3, 4)\n>>> kw = {\'d\': 99, \'x\': \'#\'}\n>>> f1(*args, **kw)\na = 1 b = 2 c = 3 args = (4,) kw = {\'d\': 99, \'x\': \'#\'}\n>>> args = (1, 2, 3)\n>>> kw = {\'d\': 88, \'x\': \'#\'}\n>>> f2(*args, **kw)\na = 1 b = 2 c = 3 d = 88 kw = {\'x\': \'#\'}`, `76441238592723530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> args <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> kw <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">\'d\'</span><span class="token punctuation">:</span> <span class="token number">99</span><span class="token punctuation">,</span> <span class="token string">\'x\'</span><span class="token punctuation">:</span> <span class="token string">\'#\'</span><span class="token punctuation">}</span>\n<span class="token operator">>></span><span class="token operator">></span> f1<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span>\na <span class="token operator">=</span> <span class="token number">1</span> b <span class="token operator">=</span> <span class="token number">2</span> c <span class="token operator">=</span> <span class="token number">3</span> args <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token punctuation">)</span> kw <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">\'d\'</span><span class="token punctuation">:</span> <span class="token number">99</span><span class="token punctuation">,</span> <span class="token string">\'x\'</span><span class="token punctuation">:</span> <span class="token string">\'#\'</span><span class="token punctuation">}</span>\n<span class="token operator">>></span><span class="token operator">></span> args <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> kw <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">\'d\'</span><span class="token punctuation">:</span> <span class="token number">88</span><span class="token punctuation">,</span> <span class="token string">\'x\'</span><span class="token punctuation">:</span> <span class="token string">\'#\'</span><span class="token punctuation">}</span>\n<span class="token operator">>></span><span class="token operator">></span> f2<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span>\na <span class="token operator">=</span> <span class="token number">1</span> b <span class="token operator">=</span> <span class="token number">2</span> c <span class="token operator">=</span> <span class="token number">3</span> d <span class="token operator">=</span> <span class="token number">88</span> kw <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">\'x\'</span><span class="token punctuation">:</span> <span class="token string">\'#\'</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>所以，对于任意函数，都可以通过类似 <code class="language-text">func(*args, **kw)</code> 的形式调用它，无论它的参数是如何定义的。</p>\n<blockquote>\n<p>虽然可以组合多达 5 种参数，但不要同时使用太多的组合，否则函数接口的可理解性很差。</p>\n</blockquote>\n<h3 id="小结"><a href="#%E5%B0%8F%E7%BB%93" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>Python 的函数具有非常灵活的参数形态，既可以实现简单的调用，又可以传入非常复杂的参数。</p>\n<p>默认参数一定要用不可变对象，如果是可变对象，程序运行时会有逻辑错误！</p>\n<p>要注意定义可变参数和关键字参数的语法：</p>\n<ul>\n<li><code class="language-text">*args</code> 是可变参数，args 接收的是一个 tuple；</li>\n<li><code class="language-text">**kw</code> 是关键字参数，kw 接收的是一个 dict。</li>\n</ul>\n<p>以及调用函数时如何传入可变参数和关键字参数的语法：</p>\n<ul>\n<li>可变参数既可以直接传入：<code class="language-text">func(1, 2, 3)</code>，又可以先组装 list 或 tuple，再通过 <code class="language-text">*args</code> 传入：<code class="language-text">func(*(1, 2, 3))</code>；</li>\n<li>关键字参数既可以直接传入：<code class="language-text">func(a=1, b=2)</code>，又可以先组装 dict，再通过 <code class="language-text">**kw</code> 传入：<code class="language-text">func(**{&#39;a&#39;: 1, &#39;b&#39;: 2})</code>。</li>\n</ul>\n<p>使用 <code class="language-text">*args</code> 和 <code class="language-text">**kw</code> 是 Python 的习惯写法，当然也可以用其他参数名，但最好使用习惯用法。</p>\n<p>命名的关键字参数是为了限制调用者可以传入的参数名，同时可以提供默认值。</p>\n<p>定义命名的关键字参数在没有可变参数的情况下不要忘了写分隔符 <code class="language-text">*</code>，否则定义的将是位置参数。</p>\n<h2 id="递归函数"><a href="#%E9%80%92%E5%BD%92%E5%87%BD%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>递归函数</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66049917352025300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def fact(n):\n    return fact_iter(n, 1)\n\ndef fact_iter(num, product):\n    if num == 1:\n        return product\n    return fact_iter(num - 1, num * product)`, `66049917352025300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">fact</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> fact_iter<span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>\n\n<span class="token keyword">def</span> <span class="token function">fact_iter</span><span class="token punctuation">(</span>num<span class="token punctuation">,</span> product<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> num <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> product\n    <span class="token keyword">return</span> fact_iter<span class="token punctuation">(</span>num <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> num <span class="token operator">*</span> product<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，<code class="language-text">return fact_iter(num - 1, num * product)</code> 仅返回递归函数本身，<code class="language-text">num - 1</code> 和 <code class="language-text">num * product</code> 在函数调用前就会被计算，不影响函数调用。</p>\n<p><code class="language-text">fact(5)</code> 对应的 <code class="language-text">fact_iter(5, 1)</code> 的调用如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55479678298545590000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`===> fact_iter(5, 1)\n===> fact_iter(4, 5)\n===> fact_iter(3, 20)\n===> fact_iter(2, 60)\n===> fact_iter(1, 120)\n===> 120`, `55479678298545590000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">></span> fact_iter<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>\n<span class="token operator">==</span><span class="token operator">=</span><span class="token operator">></span> fact_iter<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>\n<span class="token operator">==</span><span class="token operator">=</span><span class="token operator">></span> fact_iter<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span>\n<span class="token operator">==</span><span class="token operator">=</span><span class="token operator">></span> fact_iter<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span>\n<span class="token operator">==</span><span class="token operator">=</span><span class="token operator">></span> fact_iter<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">)</span>\n<span class="token operator">==</span><span class="token operator">=</span><span class="token operator">></span> <span class="token number">120</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>尾递归调用时，如果做了优化，栈不会增长，因此，无论多少次调用也不会导致栈溢出。</p>\n<p>遗憾的是，大多数编程语言没有针对尾递归做优化，Python 解释器也没有做优化，所以，即使把上面的 fact(n) 函数改成尾递归方式，也会导致栈溢出。</p>\n<h3 id="小结-1"><a href="#%E5%B0%8F%E7%BB%93-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>使用递归函数的优点是逻辑简单清晰，缺点是过深的调用会导致栈溢出。</p>\n<p>针对尾递归优化的语言可以通过尾递归防止栈溢出。尾递归事实上和循环是等价的，没有循环语句的编程语言只能通过尾递归实现循环。</p>\n<p>Python 标准的解释器没有针对尾递归做优化，任何递归函数都存在栈溢出的问题。</p>\n<h1 id="高级特性"><a href="#%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>高级特性</h1>\n<h2 id="切片"><a href="#%E5%88%87%E7%89%87" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>切片</h2>\n<p>取一个 list 或 tuple 的部分元素是非常常见的操作。比如，一个 list 如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77354791419723070000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> L = [\'Michael\', \'Sarah\', \'Tracy\', \'Bob\', \'Jack\']`, `77354791419723070000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> L <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'Michael\'</span><span class="token punctuation">,</span> <span class="token string">\'Sarah\'</span><span class="token punctuation">,</span> <span class="token string">\'Tracy\'</span><span class="token punctuation">,</span> <span class="token string">\'Bob\'</span><span class="token punctuation">,</span> <span class="token string">\'Jack\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>取前 3 个元素，应该怎么做？</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20955276534394884000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> L[0:3]\n[\'Michael\', \'Sarah\', \'Tracy\']`, `20955276534394884000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> L<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token string">\'Michael\'</span><span class="token punctuation">,</span> <span class="token string">\'Sarah\'</span><span class="token punctuation">,</span> <span class="token string">\'Tracy\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>如果第一个索引是 0，还可以省略：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60091195045957770000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> L[:3]\n[\'Michael\', \'Sarah\', \'Tracy\']`, `60091195045957770000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> L<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token string">\'Michael\'</span><span class="token punctuation">,</span> <span class="token string">\'Sarah\'</span><span class="token punctuation">,</span> <span class="token string">\'Tracy\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>也可以从索引 1 开始，取出 2 个元素出来：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19650628432262463000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> L[1:3]\n[\'Sarah\', \'Tracy\']`, `19650628432262463000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> L<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token string">\'Sarah\'</span><span class="token punctuation">,</span> <span class="token string">\'Tracy\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>类似的，既然 Python 支持 <code class="language-text">L[-1]</code> 取倒数第一个元素，那么它同样支持倒数切片，试试：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12915272832145197000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> L[-2:]\n[\'Bob\', \'Jack\']\n>>> L[-2:-1]\n[\'Bob\']`, `12915272832145197000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> L<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token string">\'Bob\'</span><span class="token punctuation">,</span> <span class="token string">\'Jack\'</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> L<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token string">\'Bob\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>记住倒数第一个元素的索引是 -1。</p>\n<p>切片操作十分有用。我们先创建一个 0-99 的数列：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80391304324900960000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> L = list(range(100))\n>>> L\n[0, 1, 2, 3, ..., 99]`, `80391304324900960000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> L <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> L\n<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>可以通过切片轻松取出某一段数列。比如前 10 个数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49341473592857010000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> L[:10]\n[0, 1, 2, 3, 4, 5, 6, 7, 8, 9]`, `49341473592857010000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> L<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>后 10 个数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44072428156658240000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> L[-10:]\n[90, 91, 92, 93, 94, 95, 96, 97, 98, 99]`, `44072428156658240000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> L<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">:</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">91</span><span class="token punctuation">,</span> <span class="token number">92</span><span class="token punctuation">,</span> <span class="token number">93</span><span class="token punctuation">,</span> <span class="token number">94</span><span class="token punctuation">,</span> <span class="token number">95</span><span class="token punctuation">,</span> <span class="token number">96</span><span class="token punctuation">,</span> <span class="token number">97</span><span class="token punctuation">,</span> <span class="token number">98</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>前 11-20 个数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59727198811544870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> L[10:20]\n[10, 11, 12, 13, 14, 15, 16, 17, 18, 19]`, `59727198811544870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> L<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>前 10 个数，每两个取一个：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3304721479426198000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> L[:10:2]\n[0, 2, 4, 6, 8]`, `3304721479426198000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> L<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>所有数，每 5 个取一个：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36304182315685974000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> L[::5]\n[0, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80, 85, 90, 95]`, `36304182315685974000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> L<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">45</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">65</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">,</span> <span class="token number">75</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">85</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">95</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>甚至什么都不写，只写 <code class="language-text">[:]</code> 就可以原样复制一个 list：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84377490009285890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> L[:]\n[0, 1, 2, 3, ..., 99]`, `84377490009285890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> L<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>tuple 也是一种 list，唯一区别是 tuple 不可变。因此，tuple 也可以用切片操作，只是操作的结果仍是 tuple：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18970143043420484000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> (0, 1, 2, 3, 4, 5)[:3]\n(0, 1, 2)`, `18970143043420484000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span>\n<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>字符串 ‘xxx’ 也可以看成是一种 list，每个元素就是一个字符。因此，字符串也可以用切片操作，只是操作结果仍是字符串：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35044110066996880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> \'ABCDEFG\'[:3]\n\'ABC\'\n>>> \'ABCDEFG\'[::2]\n\'ACEG\'`, `35044110066996880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token string">\'ABCDEFG\'</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span>\n<span class="token string">\'ABC\'</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token string">\'ABCDEFG\'</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>\n<span class="token string">\'ACEG\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在很多编程语言中，针对字符串提供了很多各种截取函数（例如，substring），其实目的就是对字符串切片。Python 没有针对字符串的截取函数，只需要切片一个操作就可以完成，非常简单。</p>\n<h2 id="迭代"><a href="#%E8%BF%AD%E4%BB%A3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>迭代</h2>\n<p>Python 的 for 循环不仅可以用在 list 或 tuple 上，还可以作用在其他可迭代对象上。</p>\n<p>list 这种数据类型虽然有下标，但很多其他数据类型是没有下标的，但是，只要是可迭代对象，无论有无下标，都可以迭代，比如 dict 就可以迭代：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26579474964162440000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> d = {\'a\': 1, \'b\': 2, \'c\': 3}\n>>> for key in d:\n...     print(key)\n...\na\nc\nb`, `26579474964162440000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> d <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">\'a\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">}</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">for</span> key <span class="token keyword">in</span> d<span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\na\nc\nb</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>因为 dict 的存储不是按照 list 的方式顺序排列，所以，迭代出的结果顺序很可能不一样。</p>\n<p>默认情况下，dict 迭代的是 key。如果要迭代 value，可以用 <code class="language-text">for value in d.values()</code>，如果要同时迭代 key 和 value，可以用 <code class="language-text">for k, v in d.items()</code>。</p>\n<p>由于字符串也是可迭代对象，因此，也可以作用于 for 循环：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79852975896381360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> for ch in \'ABC\':\n...     print(ch)\n...\nA\nB\nC`, `79852975896381360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">for</span> ch <span class="token keyword">in</span> <span class="token string">\'ABC\'</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nA\nB\nC</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>所以，当我们使用 for 循环时，只要作用于一个可迭代对象，for 循环就可以正常运行，而我们不太关心该对象究竟是 list 还是其他数据类型。</p>\n<p>那么，如何判断一个对象是可迭代对象呢？方法是通过 collections.abc 模块的 Iterable 类型判断：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56978790802533540000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> from collections.abc import Iterable\n>>> isinstance(\'abc\', Iterable) # str 是否可迭代\nTrue\n>>> isinstance([1,2,3], Iterable) # list 是否可迭代\nTrue\n>>> isinstance(123, Iterable) # 整数是否可迭代\nFalse`, `56978790802533540000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> collections<span class="token punctuation">.</span>abc <span class="token keyword">import</span> Iterable\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token string">\'abc\'</span><span class="token punctuation">,</span> Iterable<span class="token punctuation">)</span> <span class="token comment"># str 是否可迭代</span>\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Iterable<span class="token punctuation">)</span> <span class="token comment"># list 是否可迭代</span>\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">,</span> Iterable<span class="token punctuation">)</span> <span class="token comment"># 整数是否可迭代</span>\n<span class="token boolean">False</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>最后一个小问题，如果要对 list 实现类似 Java 那样的下标循环怎么办？Python 内置的 enumerate 函数可以把一个 list 变成索引-元素对，这样就可以在 for 循环中同时迭代索引和元素本身：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18384508159278256000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> for i, value in enumerate([\'A\', \'B\', \'C\']):\n...     print(i, value)\n...\n0 A\n1 B\n2 C`, `18384508159278256000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">for</span> i<span class="token punctuation">,</span> value <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'A\'</span><span class="token punctuation">,</span> <span class="token string">\'B\'</span><span class="token punctuation">,</span> <span class="token string">\'C\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> value<span class="token punctuation">)</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token number">0</span> A\n<span class="token number">1</span> B\n<span class="token number">2</span> C</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面的 for 循环里，同时引用了两个变量，在 Python 里是很常见的，比如下面的代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25732920607464018000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> for x, y in [(1, 1), (2, 4), (3, 9)]:\n...     print(x, y)\n...\n1 1\n2 4\n3 9`, `25732920607464018000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">for</span> x<span class="token punctuation">,</span> y <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token number">1</span> <span class="token number">1</span>\n<span class="token number">2</span> <span class="token number">4</span>\n<span class="token number">3</span> <span class="token number">9</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="小结-2"><a href="#%E5%B0%8F%E7%BB%93-2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>任何可迭代对象都可以作用于 for 循环，包括我们自定义的数据类型，只要符合迭代条件，就可以使用 for 循环。</p>\n<h2 id="列表生成式"><a href="#%E5%88%97%E8%A1%A8%E7%94%9F%E6%88%90%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>列表生成式</h2>\n<p>列表生成式即 List Comprehensions，是 Python 内置的非常简单却强大的可以用来创建 list 的生成式。</p>\n<p>举个例子，要生成 list <code class="language-text">[1, 2, 3, 4, 5, 6, 7, 8, 9, 10]</code> 可以用 <code class="language-text">list(range(1, 11))</code>：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52443284607697000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> list(range(1, 11))\n[1, 2, 3, 4, 5, 6, 7, 8, 9, 10]`, `52443284607697000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>但如果要生成 <code class="language-text">[1x1, 2x2, 3x3, ..., 10x10]</code> 怎么做？方法一是循环：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15041543997476215000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> L = []\n>>> for x in range(1, 11):\n...    L.append(x * x)\n...\n>>> L\n[1, 4, 9, 16, 25, 36, 49, 64, 81, 100]`, `15041543997476215000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> L <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    L<span class="token punctuation">.</span>append<span class="token punctuation">(</span>x <span class="token operator">*</span> x<span class="token punctuation">)</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token operator">>></span><span class="token operator">></span> L\n<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">49</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">81</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是循环太繁琐，而列表生成式则可以用一行语句代替循环生成上面的 list：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21079319398264107000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> [x * x for x in range(1, 11)]\n[1, 4, 9, 16, 25, 36, 49, 64, 81, 100]`, `21079319398264107000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">[</span>x <span class="token operator">*</span> x <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">49</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">81</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>写列表生成式时，把要生成的元素 <code class="language-text">x * x</code> 放到前面，后面跟 for 循环，就可以把 list 创建出来，十分有用，多写几次，很快就可以熟悉这种语法。</p>\n<p>for 循环后面还可以加上 if 判断，这样我们就可以筛选出仅偶数的平方：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96397357101594690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> [x * x for x in range(1, 11) if x % 2 == 0]\n[4, 16, 36, 64, 100]`, `96397357101594690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">[</span>x <span class="token operator">*</span> x <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">if</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>还可以使用两层循环，可以生成全排列：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21421831615058686000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> [m + n for m in \'ABC\' for n in \'XYZ\']\n[\'AX\', \'AY\', \'AZ\', \'BX\', \'BY\', \'BZ\', \'CX\', \'CY\', \'CZ\']`, `21421831615058686000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">[</span>m <span class="token operator">+</span> n <span class="token keyword">for</span> m <span class="token keyword">in</span> <span class="token string">\'ABC\'</span> <span class="token keyword">for</span> n <span class="token keyword">in</span> <span class="token string">\'XYZ\'</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token string">\'AX\'</span><span class="token punctuation">,</span> <span class="token string">\'AY\'</span><span class="token punctuation">,</span> <span class="token string">\'AZ\'</span><span class="token punctuation">,</span> <span class="token string">\'BX\'</span><span class="token punctuation">,</span> <span class="token string">\'BY\'</span><span class="token punctuation">,</span> <span class="token string">\'BZ\'</span><span class="token punctuation">,</span> <span class="token string">\'CX\'</span><span class="token punctuation">,</span> <span class="token string">\'CY\'</span><span class="token punctuation">,</span> <span class="token string">\'CZ\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>三层和三层以上的循环就很少用到了。</p>\n<p>运用列表生成式，可以写出非常简洁的代码。例如，列出当前目录下的所有文件和目录名，可以通过一行代码实现：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18759768686189937000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> import os # 导入 os 模块，模块的概念后面讲到\n>>> [d for d in os.listdir(\'.\')] # os.listdir 可以列出文件和目录\n[\'.emacs.d\', \'.ssh\', \'.Trash\', \'Adlm\', \'Applications\', \'Desktop\', \'Documents\', \'Downloads\', \'Library\', \'Movies\', \'Music\', \'Pictures\', \'Public\', \'VirtualBox VMs\', \'Workspace\', \'XCode\']`, `18759768686189937000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> os <span class="token comment"># 导入 os 模块，模块的概念后面讲到</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">[</span>d <span class="token keyword">for</span> d <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span><span class="token string">\'.\'</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token comment"># os.listdir 可以列出文件和目录</span>\n<span class="token punctuation">[</span><span class="token string">\'.emacs.d\'</span><span class="token punctuation">,</span> <span class="token string">\'.ssh\'</span><span class="token punctuation">,</span> <span class="token string">\'.Trash\'</span><span class="token punctuation">,</span> <span class="token string">\'Adlm\'</span><span class="token punctuation">,</span> <span class="token string">\'Applications\'</span><span class="token punctuation">,</span> <span class="token string">\'Desktop\'</span><span class="token punctuation">,</span> <span class="token string">\'Documents\'</span><span class="token punctuation">,</span> <span class="token string">\'Downloads\'</span><span class="token punctuation">,</span> <span class="token string">\'Library\'</span><span class="token punctuation">,</span> <span class="token string">\'Movies\'</span><span class="token punctuation">,</span> <span class="token string">\'Music\'</span><span class="token punctuation">,</span> <span class="token string">\'Pictures\'</span><span class="token punctuation">,</span> <span class="token string">\'Public\'</span><span class="token punctuation">,</span> <span class="token string">\'VirtualBox VMs\'</span><span class="token punctuation">,</span> <span class="token string">\'Workspace\'</span><span class="token punctuation">,</span> <span class="token string">\'XCode\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>for 循环其实可以同时使用两个甚至多个变量，比如 dict 的 items() 可以同时迭代 key 和 value：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19526340478763670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> d = {\'x\': \'A\', \'y\': \'B\', \'z\': \'C\' }\n>>> for k, v in d.items():\n...     print(k, \'=\', v)\n...\ny = B\nx = A\nz = C`, `19526340478763670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> d <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">\'x\'</span><span class="token punctuation">:</span> <span class="token string">\'A\'</span><span class="token punctuation">,</span> <span class="token string">\'y\'</span><span class="token punctuation">:</span> <span class="token string">\'B\'</span><span class="token punctuation">,</span> <span class="token string">\'z\'</span><span class="token punctuation">:</span> <span class="token string">\'C\'</span> <span class="token punctuation">}</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> d<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> <span class="token string">\'=\'</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\ny <span class="token operator">=</span> B\nx <span class="token operator">=</span> A\nz <span class="token operator">=</span> C</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>因此，列表生成式也可以使用两个变量来生成 list：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26068982377361637000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> d = {\'x\': \'A\', \'y\': \'B\', \'z\': \'C\' }\n>>> [k + \'=\' + v for k, v in d.items()]\n[\'y=B\', \'x=A\', \'z=C\']`, `26068982377361637000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> d <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">\'x\'</span><span class="token punctuation">:</span> <span class="token string">\'A\'</span><span class="token punctuation">,</span> <span class="token string">\'y\'</span><span class="token punctuation">:</span> <span class="token string">\'B\'</span><span class="token punctuation">,</span> <span class="token string">\'z\'</span><span class="token punctuation">:</span> <span class="token string">\'C\'</span> <span class="token punctuation">}</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">[</span>k <span class="token operator">+</span> <span class="token string">\'=\'</span> <span class="token operator">+</span> v <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> d<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token string">\'y=B\'</span><span class="token punctuation">,</span> <span class="token string">\'x=A\'</span><span class="token punctuation">,</span> <span class="token string">\'z=C\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>最后把一个 list 中所有的字符串变成小写：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77313837786807010000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> L = [\'Hello\', \'World\', \'IBM\', \'Apple\']\n>>> [s.lower() for s in L]\n[\'hello\', \'world\', \'ibm\', \'apple\']`, `77313837786807010000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> L <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">\'Hello\'</span><span class="token punctuation">,</span> <span class="token string">\'World\'</span><span class="token punctuation">,</span> <span class="token string">\'IBM\'</span><span class="token punctuation">,</span> <span class="token string">\'Apple\'</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">[</span>s<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> s <span class="token keyword">in</span> L<span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token string">\'hello\'</span><span class="token punctuation">,</span> <span class="token string">\'world\'</span><span class="token punctuation">,</span> <span class="token string">\'ibm\'</span><span class="token punctuation">,</span> <span class="token string">\'apple\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>在一个列表生成式中，for 前面的 <code class="language-text">if ... else</code> 是表达式，而 for 后面的 if 是过滤条件，不能带 else。</p>\n<p>即以下 2 种形式是错误的：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96035706388804830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> [x for x in range(1, 11) if x % 2 == 0 else 0]\n  File &quot;<stdin>&quot;, line 1\n    [x for x in range(1, 11) if x % 2 == 0 else 0]\n                                              ^\nSyntaxError: invalid syntax`, `96035706388804830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">[</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">if</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token number">0</span><span class="token punctuation">]</span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span>\n    <span class="token punctuation">[</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">if</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token number">0</span><span class="token punctuation">]</span>\n                                              <span class="token operator">^</span>\nSyntaxError<span class="token punctuation">:</span> invalid syntax</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41483911750808410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> [x if x % 2 == 0 for x in range(1, 11)]\n  File &quot;<stdin>&quot;, line 1\n    [x if x % 2 == 0 for x in range(1, 11)]\n                       ^\nSyntaxError: invalid syntax`, `41483911750808410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">[</span>x <span class="token keyword">if</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span>\n    <span class="token punctuation">[</span>x <span class="token keyword">if</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n                       <span class="token operator">^</span>\nSyntaxError<span class="token punctuation">:</span> invalid syntax</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="生成器"><a href="#%E7%94%9F%E6%88%90%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>生成器</h2>\n<p>在 Python 中一边循环一边计算的机制，称为生成器：generator。</p>\n<p>要创建一个 generator，有很多种方法。第一种方法很简单，只要把一个列表生成式的 [] 改成 ()，就创建了一个 generator：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89157550975344640000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> L = [x * x for x in range(10)]\n>>> L\n[0, 1, 4, 9, 16, 25, 36, 49, 64, 81]\n>>> g = (x * x for x in range(10))\n>>> g\n<generator object <genexpr> at 0x1022ef630>`, `89157550975344640000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> L <span class="token operator">=</span> <span class="token punctuation">[</span>x <span class="token operator">*</span> x <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> L\n<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">49</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">81</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> g <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">*</span> x <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> g\n<span class="token operator">&lt;</span>generator <span class="token builtin">object</span> <span class="token operator">&lt;</span>genexpr<span class="token operator">></span> at <span class="token number">0x1022ef630</span><span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>创建 L 和 g 的区别仅在于最外层的 [] 和 ()，L 是一个 list，而 g 是一个 generator。</p>\n<p>我们可以直接打印出 list 的每一个元素，但我们怎么打印出 generator 的每一个元素呢？</p>\n<p>如果要一个一个打印出来，可以通过 next() 函数获得 generator 的下一个返回值：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70811823136740970000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> next(g)\n0\n>>> next(g)\n1\n>>> next(g)\n4\n>>> next(g)\n9\n>>> next(g)\n16\n>>> next(g)\n25\n>>> next(g)\n36\n>>> next(g)\n49\n>>> next(g)\n64\n>>> next(g)\n81\n>>> next(g)\nTraceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\nStopIteration`, `70811823136740970000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span>\n<span class="token number">0</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span>\n<span class="token number">1</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span>\n<span class="token number">4</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span>\n<span class="token number">9</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span>\n<span class="token number">16</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span>\n<span class="token number">25</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span>\n<span class="token number">36</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span>\n<span class="token number">49</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span>\n<span class="token number">64</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span>\n<span class="token number">81</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\nStopIteration</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们讲过，generator 保存的是算法，每次调用 next(g)，就计算出 g 的下一个元素的值，直到计算到最后一个元素，没有更多的元素时，抛出 StopIteration 的错误。</p>\n<p>当然，上面这种不断调用 next(g) 实在是太变态了，正确的方法是使用 for 循环，因为 generator 也是可迭代对象：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80878901361877700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> g = (x * x for x in range(10))\n>>> for n in g:\n...     print(n)\n...\n0\n1\n4\n9\n16\n25\n36\n49\n64\n81`, `80878901361877700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> g <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">*</span> x <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">for</span> n <span class="token keyword">in</span> g<span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token number">0</span>\n<span class="token number">1</span>\n<span class="token number">4</span>\n<span class="token number">9</span>\n<span class="token number">16</span>\n<span class="token number">25</span>\n<span class="token number">36</span>\n<span class="token number">49</span>\n<span class="token number">64</span>\n<span class="token number">81</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>所以，我们创建了一个 generator 后，基本上永远不会调用 next()，而是通过 for 循环来迭代它，并且不需要关心 StopIteration 的错误。</p>\n<p>generator 非常强大。如果推算的算法比较复杂，用类似列表生成式的 for 循环无法实现的时候，还可以用函数来实现。</p>\n<p>比如，著名的斐波拉契数列（Fibonacci），除第一个和第二个数外，任意一个数都可由前两个数相加得到：</p>\n<p>1, 1, 2, 3, 5, 8, 13, 21, 34, …</p>\n<p>斐波拉契数列用列表生成式写不出来，但是，用函数把它打印出来却很容易：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17264652962357375000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def fib(max):\n    n, a, b = 0, 0, 1\n    while n < max:\n        print(b)\n        a, b = b, a + b\n        n = n + 1\n    return \'done\'`, `17264652962357375000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">fib</span><span class="token punctuation">(</span><span class="token builtin">max</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    n<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span>\n    <span class="token keyword">while</span> n <span class="token operator">&lt;</span> <span class="token builtin">max</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>\n        a<span class="token punctuation">,</span> b <span class="token operator">=</span> b<span class="token punctuation">,</span> a <span class="token operator">+</span> b\n        n <span class="token operator">=</span> n <span class="token operator">+</span> <span class="token number">1</span>\n    <span class="token keyword">return</span> <span class="token string">\'done\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意，赋值语句：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56196000627239710000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a, b = b, a + b`, `56196000627239710000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a<span class="token punctuation">,</span> b <span class="token operator">=</span> b<span class="token punctuation">,</span> a <span class="token operator">+</span> b</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>相当于：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9806993002438769000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`t = (b, a + b) # t 是一个 tuple\na = t[0]\nb = t[1]`, `9806993002438769000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">t <span class="token operator">=</span> <span class="token punctuation">(</span>b<span class="token punctuation">,</span> a <span class="token operator">+</span> b<span class="token punctuation">)</span> <span class="token comment"># t 是一个 tuple</span>\na <span class="token operator">=</span> t<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>\nb <span class="token operator">=</span> t<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>但不必显式写出临时变量 t 就可以赋值。</p>\n<p>上面的函数可以输出斐波那契数列的前 N 个数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84993825286636860000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> fib(6)\n1\n1\n2\n3\n5\n8\n\'done\'`, `84993825286636860000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> fib<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>\n<span class="token number">1</span>\n<span class="token number">1</span>\n<span class="token number">2</span>\n<span class="token number">3</span>\n<span class="token number">5</span>\n<span class="token number">8</span>\n<span class="token string">\'done\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>仔细观察，可以看出，fib 函数实际上是定义了斐波拉契数列的推算规则，可以从第一个元素开始，推算出后续任意的元素，这种逻辑其实非常类似 generator。</p>\n<p>也就是说，上面的函数和 generator 仅一步之遥。要把 fib 函数变成 generator 函数，只需要把 print(b) 改为 yield b 就可以了：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73114764608465690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def fib(max):\n    n, a, b = 0, 0, 1\n    while n < max:\n        yield b\n        a, b = b, a + b\n        n = n + 1\n    return \'done\'`, `73114764608465690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">fib</span><span class="token punctuation">(</span><span class="token builtin">max</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    n<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span>\n    <span class="token keyword">while</span> n <span class="token operator">&lt;</span> <span class="token builtin">max</span><span class="token punctuation">:</span>\n        <span class="token keyword">yield</span> b\n        a<span class="token punctuation">,</span> b <span class="token operator">=</span> b<span class="token punctuation">,</span> a <span class="token operator">+</span> b\n        n <span class="token operator">=</span> n <span class="token operator">+</span> <span class="token number">1</span>\n    <span class="token keyword">return</span> <span class="token string">\'done\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这就是定义 generator 的另一种方法。如果一个函数定义中包含 yield 关键字，那么这个函数就不再是一个普通函数，而是一个 generator 函数，调用一个 generator 函数将返回一个 generator：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70548542414148630000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> f = fib(6)\n>>> f\n<generator object fib at 0x104feaaa0>`, `70548542414148630000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> f <span class="token operator">=</span> fib<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> f\n<span class="token operator">&lt;</span>generator <span class="token builtin">object</span> fib at <span class="token number">0x104feaaa0</span><span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>这里，最难理解的就是 generator 函数和普通函数的执行流程不一样。普通函数是顺序执行，遇到 return 语句或者最后一行函数语句就返回。而变成 generator 的函数，在每次调用 next() 的时候执行，遇到 yield 语句返回，再次执行时从上次返回的 yield 语句处继续执行。</p>\n<p>举个简单的例子，定义一个 generator 函数，依次返回数字 1，3，5：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14634100147540185000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def odd():\n    print(\'step 1\')\n    yield 1\n    print(\'step 2\')\n    yield(3)\n    print(\'step 3\')\n    yield(5)`, `14634100147540185000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">odd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'step 1\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token number">1</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'step 2\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'step 3\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>调用该 generator 函数时，首先要生成一个 generator 对象，然后用 next() 函数不断获得下一个返回值：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73470739144160780000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> o = odd()\n>>> next(o)\nstep 1\n1\n>>> next(o)\nstep 2\n3\n>>> next(o)\nstep 3\n5\n>>> next(o)\nTraceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\nStopIteration`, `73470739144160780000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> o <span class="token operator">=</span> odd<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span>\nstep <span class="token number">1</span>\n<span class="token number">1</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span>\nstep <span class="token number">2</span>\n<span class="token number">3</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span>\nstep <span class="token number">3</span>\n<span class="token number">5</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\nStopIteration</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，odd 不是普通函数，而是 generator 函数，在执行过程中，遇到 yield 就中断，下次又继续执行。执行 3 次 yield 后，已经没有 yield 可以执行了，所以，第 4 次调用 <code class="language-text">next(o)</code> 就报错。</p>\n<blockquote>\n<p>请务必注意：调用 generator 函数会创建一个 generator 对象，多次调用 generator 函数会创建多个相互独立的 generator。</p>\n</blockquote>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69525097556584230000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> next(odd())\nstep 1\n1\n>>> next(odd())\nstep 1\n1\n>>> next(odd())\nstep 1\n1`, `69525097556584230000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>odd<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\nstep <span class="token number">1</span>\n<span class="token number">1</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>odd<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\nstep <span class="token number">1</span>\n<span class="token number">1</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>odd<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\nstep <span class="token number">1</span>\n<span class="token number">1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>原因在于 odd() 会创建一个新的 generator 对象，上述代码实际上创建了 3 个完全独立的 generator，对 3 个 generator 分别调用 next() 当然每个都会返回第一个值。</p>\n<p>正确的写法是创建一个 generator 对象，然后不断对这一个 generator 对象调用 next()：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62361755262786250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> g = odd()\n>>> next(g)\nstep 1\n1\n>>> next(g)\nstep 2\n3\n>>> next(g)\nstep 3\n5`, `62361755262786250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> g <span class="token operator">=</span> odd<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span>\nstep <span class="token number">1</span>\n<span class="token number">1</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span>\nstep <span class="token number">2</span>\n<span class="token number">3</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">next</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span>\nstep <span class="token number">3</span>\n<span class="token number">5</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>回到 fib 的例子，我们在循环过程中不断调用 yield，就会不断中断。当然要给循环设置一个条件来退出循环，不然就会产生一个无限数列出来。</p>\n<p>同样的，把函数改成 generator 函数后，我们基本上从来不会用 next() 来获取下一个返回值，而是直接使用 for 循环来迭代：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60626155977974120000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> for n in fib(6):\n...     print(n)\n...\n1\n1\n2\n3\n5\n8`, `60626155977974120000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">for</span> n <span class="token keyword">in</span> fib<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token number">1</span>\n<span class="token number">1</span>\n<span class="token number">2</span>\n<span class="token number">3</span>\n<span class="token number">5</span>\n<span class="token number">8</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是用 for 循环调用 generator 时，发现拿不到 generator 的 return 语句的返回值。如果想要拿到返回值，必须捕获 StopIteration 错误，返回值包含在 StopIteration 的 value 中：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63165290644259460000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> g = fib(6)\n>>> while True:\n...     try:\n...         x = next(g)\n...         print(\'g:\', x)\n...     except StopIteration as e:\n...         print(\'Generator return value:\', e.value)\n...         break\n...\ng: 1\ng: 1\ng: 2\ng: 3\ng: 5\ng: 8\nGenerator return value: done`, `63165290644259460000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> g <span class="token operator">=</span> fib<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">try</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         x <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'g:\'</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">except</span> StopIteration <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Generator return value:\'</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>value<span class="token punctuation">)</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">break</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\ng<span class="token punctuation">:</span> <span class="token number">1</span>\ng<span class="token punctuation">:</span> <span class="token number">1</span>\ng<span class="token punctuation">:</span> <span class="token number">2</span>\ng<span class="token punctuation">:</span> <span class="token number">3</span>\ng<span class="token punctuation">:</span> <span class="token number">5</span>\ng<span class="token punctuation">:</span> <span class="token number">8</span>\nGenerator <span class="token keyword">return</span> value<span class="token punctuation">:</span> done</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>关于如何捕获错误，后面的错误处理还会详细讲解。</p>\n<h3 id="小结-3"><a href="#%E5%B0%8F%E7%BB%93-3" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>generator 是非常强大的工具，在 Python 中，可以简单地把列表生成式改成 generator，也可以通过函数实现复杂逻辑的 generator。</p>\n<p>要理解 generator 的工作原理，它是在 for 循环的过程中不断计算出下一个元素，并在适当的条件结束 for 循环。对于函数改成的 generator 来说，遇到 return 语句或者执行到函数体最后一行语句，就是结束 generator 的指令，for 循环随之结束。</p>\n<p>请注意区分普通函数和 generator 函数，普通函数调用直接返回结果：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58250280465351190000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> r = abs(6)\n>>> r\n6`, `58250280465351190000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> r <span class="token operator">=</span> <span class="token builtin">abs</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> r\n<span class="token number">6</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>generator 函数的调用实际返回一个 generator 对象：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55756492993580966000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> g = fib(6)\n>>> g\n<generator object fib at 0x1022ef948>`, `55756492993580966000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> g <span class="token operator">=</span> fib<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> g\n<span class="token operator">&lt;</span>generator <span class="token builtin">object</span> fib at <span class="token number">0x1022ef948</span><span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h2 id="迭代器"><a href="#%E8%BF%AD%E4%BB%A3%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>迭代器</h2>\n<p>我们已经知道，可以直接作用于 for 循环的数据类型有以下几种：</p>\n<p>一类是集合数据类型，如 list、tuple、dict、set、str 等；</p>\n<p>一类是 generator，包括生成器和带 yield 的 generator function。</p>\n<p>这些可以直接作用于 for 循环的对象统称为可迭代对象：Iterable。</p>\n<p>可以使用 isinstance() 判断一个对象是否是 Iterable 对象：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30694053652303356000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> from collections.abc import Iterable\n>>> isinstance([], Iterable)\nTrue\n>>> isinstance({}, Iterable)\nTrue\n>>> isinstance(\'abc\', Iterable)\nTrue\n>>> isinstance((x for x in range(10)), Iterable)\nTrue\n>>> isinstance(100, Iterable)\nFalse`, `30694053652303356000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> collections<span class="token punctuation">.</span>abc <span class="token keyword">import</span> Iterable\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Iterable<span class="token punctuation">)</span>\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> Iterable<span class="token punctuation">)</span>\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token string">\'abc\'</span><span class="token punctuation">,</span> Iterable<span class="token punctuation">)</span>\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Iterable<span class="token punctuation">)</span>\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> Iterable<span class="token punctuation">)</span>\n<span class="token boolean">False</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>而生成器不但可以作用于 for 循环，还可以被 next() 函数不断调用并返回下一个值，直到最后抛出 StopIteration 错误表示无法继续返回下一个值了。</p>\n<p>可以被 next() 函数调用并不断返回下一个值的对象称为迭代器：Iterator。</p>\n<p>可以使用 isinstance() 判断一个对象是否是 Iterator 对象：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38562984766978640000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> from collections.abc import Iterator\n>>> isinstance((x for x in range(10)), Iterator)\nTrue\n>>> isinstance([], Iterator)\nFalse\n>>> isinstance({}, Iterator)\nFalse\n>>> isinstance(\'abc\', Iterator)\nFalse`, `38562984766978640000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> collections<span class="token punctuation">.</span>abc <span class="token keyword">import</span> Iterator\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Iterator<span class="token punctuation">)</span>\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Iterator<span class="token punctuation">)</span>\n<span class="token boolean">False</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> Iterator<span class="token punctuation">)</span>\n<span class="token boolean">False</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token string">\'abc\'</span><span class="token punctuation">,</span> Iterator<span class="token punctuation">)</span>\n<span class="token boolean">False</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>生成器都是 Iterator 对象，但 list、dict、str 虽然是 Iterable，却不是 Iterator。</p>\n<p>把 list、dict、str 等 Iterable 变成 Iterator 可以使用 iter() 函数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91357563763533430000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> isinstance(iter([]), Iterator)\nTrue\n>>> isinstance(iter(\'abc\'), Iterator)\nTrue`, `91357563763533430000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token builtin">iter</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Iterator<span class="token punctuation">)</span>\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token builtin">iter</span><span class="token punctuation">(</span><span class="token string">\'abc\'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Iterator<span class="token punctuation">)</span>\n<span class="token boolean">True</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>你可能会问，为什么 list、dict、str 等数据类型不是 Iterator？</p>\n<p>这是因为 Python 的 Iterator 对象表示的是一个数据流，Iterator 对象可以被 next() 函数调用并不断返回下一个数据，直到没有数据时抛出 StopIteration 错误。可以把这个数据流看做是一个有序序列，但我们却不能提前知道序列的长度，只能不断通过 next() 函数实现按需计算下一个数据，所以 Iterator 的计算是惰性的，只有在需要返回下一个数据时它才会计算。</p>\n<p>Iterator 甚至可以表示一个无限大的数据流，例如全体自然数。而使用 list 是永远不可能存储全体自然数的。</p>\n<h3 id="小结-4"><a href="#%E5%B0%8F%E7%BB%93-4" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>凡是可作用于 for 循环的对象都是 Iterable 类型；</p>\n<p>凡是可作用于 next() 函数的对象都是 Iterator 类型，它们表示一个惰性计算的序列；</p>\n<p>集合数据类型如 list、dict、str 等是 Iterable 但不是 Iterator，不过可以通过 iter() 函数获得一个 Iterator 对象。</p>\n<p>Python 的 for 循环本质上就是通过不断调用 next() 函数实现的，例如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88180534114481900000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`for x in [1, 2, 3, 4, 5]:\n    pass`, `88180534114481900000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>实际上完全等价于：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42241243283826190000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 首先获得 Iterator 对象:\nit = iter([1, 2, 3, 4, 5])\n# 循环:\nwhile True:\n    try:\n        # 获得下一个值:\n        x = next(it)\n    except StopIteration:\n        # 遇到 StopIteration 就退出循环\n        break`, `42241243283826190000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment"># 首先获得 Iterator 对象:</span>\nit <span class="token operator">=</span> <span class="token builtin">iter</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token comment"># 循环:</span>\n<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        <span class="token comment"># 获得下一个值:</span>\n        x <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span>\n    <span class="token keyword">except</span> StopIteration<span class="token punctuation">:</span>\n        <span class="token comment"># 遇到 StopIteration 就退出循环</span>\n        <span class="token keyword">break</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1 id="函数式编程"><a href="#%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>函数式编程</h1>\n<h2 id="高阶函数"><a href="#%E9%AB%98%E9%98%B6%E5%87%BD%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>高阶函数</h2>\n<h3 id="变量可以指向函数"><a href="#%E5%8F%98%E9%87%8F%E5%8F%AF%E4%BB%A5%E6%8C%87%E5%90%91%E5%87%BD%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>变量可以指向函数</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79566601046700400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> f = abs\n>>> f(-10)\n10`, `79566601046700400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> f <span class="token operator">=</span> <span class="token builtin">abs</span>\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">)</span>\n<span class="token number">10</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h3 id="函数名也是变量"><a href="#%E5%87%BD%E6%95%B0%E5%90%8D%E4%B9%9F%E6%98%AF%E5%8F%98%E9%87%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>函数名也是变量</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69149116234531350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> abs = 10\n>>> abs(-10)\nTraceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\nTypeError: \'int\' object is not callable`, `69149116234531350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">abs</span> <span class="token operator">=</span> <span class="token number">10</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">abs</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">)</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\nTypeError<span class="token punctuation">:</span> <span class="token string">\'int\'</span> <span class="token builtin">object</span> <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token builtin">callable</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>由于 abs 函数实际上是定义在 <code class="language-text">import builtins</code> 模块中的，所以要让修改 abs 变量的指向在其它模块也生效，要用 <code class="language-text">import builtins; builtins.abs = 10</code>。</p>\n</blockquote>\n<h3 id="传入函数"><a href="#%E4%BC%A0%E5%85%A5%E5%87%BD%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>传入函数</h3>\n<p>一个函数就可以接收另一个函数作为参数，这种函数就称之为高阶函数</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73524210405745795000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def add(x, y, f):\n    return f(x) + f(y)\n\nprint(add(-5, 6, abs))`, `73524210405745795000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> f<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> f<span class="token punctuation">(</span>y<span class="token punctuation">)</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span>add<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token builtin">abs</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="map"><a href="#map" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>map</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98153888479189830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> def f(x):\n...     return x * x\n...\n>>> r = map(f, [1, 2, 3, 4, 5, 6, 7, 8, 9])\n>>> list(r)\n[1, 4, 9, 16, 25, 36, 49, 64, 81]\n>>> list(map(str, [1, 2, 3, 4, 5, 6, 7, 8, 9]))\n[\'1\', \'2\', \'3\', \'4\', \'5\', \'6\', \'7\', \'8\', \'9\']`, `98153888479189830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">return</span> x <span class="token operator">*</span> x\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token operator">>></span><span class="token operator">></span> r <span class="token operator">=</span> <span class="token builtin">map</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">list</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>\n<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">49</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">81</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token punctuation">[</span><span class="token string">\'1\'</span><span class="token punctuation">,</span> <span class="token string">\'2\'</span><span class="token punctuation">,</span> <span class="token string">\'3\'</span><span class="token punctuation">,</span> <span class="token string">\'4\'</span><span class="token punctuation">,</span> <span class="token string">\'5\'</span><span class="token punctuation">,</span> <span class="token string">\'6\'</span><span class="token punctuation">,</span> <span class="token string">\'7\'</span><span class="token punctuation">,</span> <span class="token string">\'8\'</span><span class="token punctuation">,</span> <span class="token string">\'9\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="reduce"><a href="#reduce" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>reduce</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24270570391699220000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`reduce(f, [x1, x2, x3, x4]) = f(f(f(x1, x2), x3), x4)`, `24270570391699220000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token builtin">reduce</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token punctuation">[</span>x1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> x3<span class="token punctuation">,</span> x4<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=</span> f<span class="token punctuation">(</span>f<span class="token punctuation">(</span>f<span class="token punctuation">(</span>x1<span class="token punctuation">,</span> x2<span class="token punctuation">)</span><span class="token punctuation">,</span> x3<span class="token punctuation">)</span><span class="token punctuation">,</span> x4<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88780449334163370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from functools import reduce\n\nDIGITS = {\'0\': 0, \'1\': 1, \'2\': 2, \'3\': 3, \'4\': 4, \'5\': 5, \'6\': 6, \'7\': 7, \'8\': 8, \'9\': 9}\n\ndef str2int(s):\n    def fn(x, y):\n        return x * 10 + y\n    def char2num(s):\n        return DIGITS[s]\n    return reduce(fn, map(char2num, s))`, `88780449334163370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> functools <span class="token keyword">import</span> <span class="token builtin">reduce</span>\n\nDIGITS <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">\'0\'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">\'1\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'2\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">\'3\'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">\'4\'</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">\'5\'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">\'6\'</span><span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">\'7\'</span><span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">\'8\'</span><span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">\'9\'</span><span class="token punctuation">:</span> <span class="token number">9</span><span class="token punctuation">}</span>\n\n<span class="token keyword">def</span> <span class="token function">str2int</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">fn</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> x <span class="token operator">*</span> <span class="token number">10</span> <span class="token operator">+</span> y\n    <span class="token keyword">def</span> <span class="token function">char2num</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> DIGITS<span class="token punctuation">[</span>s<span class="token punctuation">]</span>\n    <span class="token keyword">return</span> <span class="token builtin">reduce</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> <span class="token builtin">map</span><span class="token punctuation">(</span>char2num<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>还可以用 lambda 函数进一步简化成：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="93096289349157750000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from functools import reduce\n\nDIGITS = {\'0\': 0, \'1\': 1, \'2\': 2, \'3\': 3, \'4\': 4, \'5\': 5, \'6\': 6, \'7\': 7, \'8\': 8, \'9\': 9}\n\ndef char2num(s):\n    return DIGITS[s]\n\ndef str2int(s):\n    return reduce(lambda x, y: x * 10 + y, map(char2num, s))`, `93096289349157750000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> functools <span class="token keyword">import</span> <span class="token builtin">reduce</span>\n\nDIGITS <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">\'0\'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">\'1\'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">\'2\'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">\'3\'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">\'4\'</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">\'5\'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">\'6\'</span><span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">\'7\'</span><span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">\'8\'</span><span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">\'9\'</span><span class="token punctuation">:</span> <span class="token number">9</span><span class="token punctuation">}</span>\n\n<span class="token keyword">def</span> <span class="token function">char2num</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> DIGITS<span class="token punctuation">[</span>s<span class="token punctuation">]</span>\n\n<span class="token keyword">def</span> <span class="token function">str2int</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> <span class="token builtin">reduce</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> x <span class="token operator">*</span> <span class="token number">10</span> <span class="token operator">+</span> y<span class="token punctuation">,</span> <span class="token builtin">map</span><span class="token punctuation">(</span>char2num<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="filter"><a href="#filter" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>filter</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20617052532601397000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def is_odd(n):\n    return n % 2 == 1\n\nlist(filter(is_odd, [1, 2, 4, 5, 6, 9, 10, 15]))\n# 结果: [1, 5, 9, 15]`, `20617052532601397000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">is_odd</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> n <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">1</span>\n\n<span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">filter</span><span class="token punctuation">(</span>is_odd<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token comment"># 结果: [1, 5, 9, 15]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意到 filter() 函数返回的是一个 Iterator，也就是一个惰性序列，所以要强迫 filter() 完成计算结果，需要用 list() 函数获得所有结果并返回 list。</p>\n<h4 id="用-filter-求素数"><a href="#%E7%94%A8-filter-%E6%B1%82%E7%B4%A0%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>用 filter 求素数</h4>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7576060972096976000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def _odd_iter():\n    n = 1\n    while True:\n        n = n + 2\n        yield n\n\ndef _not_divisible(n):\n    # def _can_be_devided(x):\n    #    return x % n > 0\n    return lambda x: x % n > 0\n\ndef primes():\n    yield 2\n    it = _odd_iter() # 初始序列\n    while True:\n        n = next(it) # 返回序列的第一个数\n        yield n\n        it = filter(_not_divisible(n), it) # 构造新序列\n\n# 打印 1000 以内的素数:\nfor n in primes():\n    if n < 1000:\n        print(n)\n    else:\n        break`, `7576060972096976000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">_odd_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    n <span class="token operator">=</span> <span class="token number">1</span>\n    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>\n        n <span class="token operator">=</span> n <span class="token operator">+</span> <span class="token number">2</span>\n        <span class="token keyword">yield</span> n\n\n<span class="token keyword">def</span> <span class="token function">_not_divisible</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token comment"># def _can_be_devided(x):</span>\n    <span class="token comment">#    return x % n > 0</span>\n    <span class="token keyword">return</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x <span class="token operator">%</span> n <span class="token operator">></span> <span class="token number">0</span>\n\n<span class="token keyword">def</span> <span class="token function">primes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">yield</span> <span class="token number">2</span>\n    it <span class="token operator">=</span> _odd_iter<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 初始序列</span>\n    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>\n        n <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span> <span class="token comment"># 返回序列的第一个数</span>\n        <span class="token keyword">yield</span> n\n        it <span class="token operator">=</span> <span class="token builtin">filter</span><span class="token punctuation">(</span>_not_divisible<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">,</span> it<span class="token punctuation">)</span> <span class="token comment"># 构造新序列</span>\n\n<span class="token comment"># 打印 1000 以内的素数:</span>\n<span class="token keyword">for</span> n <span class="token keyword">in</span> primes<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> n <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        <span class="token keyword">break</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="sort"><a href="#sort" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>sort</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46799511091837820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> sorted([36, 5, -12, 9, -21])\n[-21, -12, 5, 9, 36]\n>>> sorted([36, 5, -12, 9, -21], key=abs) # 自定义排序\n[5, 9, -12, -21, 36]\n>>> sorted([\'bob\', \'about\', \'Zoo\', \'Credit\']) # 按照 ASCII 的大小比较\n[\'Credit\', \'Zoo\', \'about\', \'bob\']\n>>> sorted([\'bob\', \'about\', \'Zoo\', \'Credit\'], key=str.lower) # 忽略大小写的排序\n[\'about\', \'bob\', \'Credit\', \'Zoo\']\n>>> sorted([\'bob\', \'about\', \'Zoo\', \'Credit\'], key=str.lower, reverse=True) # 倒序\n[\'Zoo\', \'Credit\', \'bob\', \'about\']`, `46799511091837820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">sorted</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">21</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">21</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">sorted</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">21</span><span class="token punctuation">]</span><span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token builtin">abs</span><span class="token punctuation">)</span> <span class="token comment"># 自定义排序</span>\n<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">21</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">sorted</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'bob\'</span><span class="token punctuation">,</span> <span class="token string">\'about\'</span><span class="token punctuation">,</span> <span class="token string">\'Zoo\'</span><span class="token punctuation">,</span> <span class="token string">\'Credit\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># 按照 ASCII 的大小比较</span>\n<span class="token punctuation">[</span><span class="token string">\'Credit\'</span><span class="token punctuation">,</span> <span class="token string">\'Zoo\'</span><span class="token punctuation">,</span> <span class="token string">\'about\'</span><span class="token punctuation">,</span> <span class="token string">\'bob\'</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">sorted</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'bob\'</span><span class="token punctuation">,</span> <span class="token string">\'about\'</span><span class="token punctuation">,</span> <span class="token string">\'Zoo\'</span><span class="token punctuation">,</span> <span class="token string">\'Credit\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">.</span>lower<span class="token punctuation">)</span> <span class="token comment"># 忽略大小写的排序</span>\n<span class="token punctuation">[</span><span class="token string">\'about\'</span><span class="token punctuation">,</span> <span class="token string">\'bob\'</span><span class="token punctuation">,</span> <span class="token string">\'Credit\'</span><span class="token punctuation">,</span> <span class="token string">\'Zoo\'</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">sorted</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'bob\'</span><span class="token punctuation">,</span> <span class="token string">\'about\'</span><span class="token punctuation">,</span> <span class="token string">\'Zoo\'</span><span class="token punctuation">,</span> <span class="token string">\'Credit\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">.</span>lower<span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token comment"># 倒序</span>\n<span class="token punctuation">[</span><span class="token string">\'Zoo\'</span><span class="token punctuation">,</span> <span class="token string">\'Credit\'</span><span class="token punctuation">,</span> <span class="token string">\'bob\'</span><span class="token punctuation">,</span> <span class="token string">\'about\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="返回函数"><a href="#%E8%BF%94%E5%9B%9E%E5%87%BD%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>返回函数</h2>\n<h3 id="函数作为返回值"><a href="#%E5%87%BD%E6%95%B0%E4%BD%9C%E4%B8%BA%E8%BF%94%E5%9B%9E%E5%80%BC" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>函数作为返回值</h3>\n<p>高阶函数除了可以接受函数作为参数外，还可以把函数作为结果值返回。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95726589382990790000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def lazy_sum(*args):\n    def sum():\n        ax = 0\n        for n in args:\n            ax = ax + n\n        return ax\n    return sum\n\n>>> f = lazy_sum(1, 3, 5, 7, 9)\n>>> f\n<function lazy_sum.<locals>.sum at 0x101c6ed90>\n>>> f()\n25`, `95726589382990790000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">lazy_sum</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        ax <span class="token operator">=</span> <span class="token number">0</span>\n        <span class="token keyword">for</span> n <span class="token keyword">in</span> args<span class="token punctuation">:</span>\n            ax <span class="token operator">=</span> ax <span class="token operator">+</span> n\n        <span class="token keyword">return</span> ax\n    <span class="token keyword">return</span> <span class="token builtin">sum</span>\n\n<span class="token operator">>></span><span class="token operator">></span> f <span class="token operator">=</span> lazy_sum<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> f\n<span class="token operator">&lt;</span>function lazy_sum<span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token builtin">locals</span><span class="token operator">></span><span class="token punctuation">.</span><span class="token builtin">sum</span> at <span class="token number">0x101c6ed90</span><span class="token operator">></span>\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token number">25</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>每次调用都会返回一个新的函数，即使传入相同的参数，f1() 和 f2() 的调用结果互不影响。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92863195475499300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> f1 = lazy_sum(1, 3, 5, 7, 9)\n>>> f2 = lazy_sum(1, 3, 5, 7, 9)\n>>> f1==f2\nFalse`, `92863195475499300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> f1 <span class="token operator">=</span> lazy_sum<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> f2 <span class="token operator">=</span> lazy_sum<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> f1<span class="token operator">==</span>f2\n<span class="token boolean">False</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="闭包"><a href="#%E9%97%AD%E5%8C%85" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>闭包</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53901830989925560000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def count():\n    fs = []\n    for i in range(1, 4):\n        def f():\n             return i*i\n        fs.append(f)\n    return fs\n\nf1, f2, f3 = count()\n\n>>> f1()\n9\n>>> f2()\n9\n>>> f3()\n9`, `53901830989925560000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    fs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n             <span class="token keyword">return</span> i<span class="token operator">*</span>i\n        fs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>f<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> fs\n\nf1<span class="token punctuation">,</span> f2<span class="token punctuation">,</span> f3 <span class="token operator">=</span> count<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span> f1<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token number">9</span>\n<span class="token operator">>></span><span class="token operator">></span> f2<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token number">9</span>\n<span class="token operator">>></span><span class="token operator">></span> f3<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token number">9</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>类似于 js，python 也有闭包，解决方式同 js</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56393599041205890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def count():\n    def f(j):\n        def g():\n            return j*j\n        return g\n    fs = []\n    for i in range(1, 4):\n        fs.append(f(i)) # f(i) 立刻被执行，因此 i 的当前值被传入 f()\n    return fs\n\n>>> f1, f2, f3 = count()\n>>> f1()\n1\n>>> f2()\n4\n>>> f3()\n9`, `56393599041205890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">g</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> j<span class="token operator">*</span>j\n        <span class="token keyword">return</span> g\n    fs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        fs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>f<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># f(i) 立刻被执行，因此 i 的当前值被传入 f()</span>\n    <span class="token keyword">return</span> fs\n\n<span class="token operator">>></span><span class="token operator">></span> f1<span class="token punctuation">,</span> f2<span class="token punctuation">,</span> f3 <span class="token operator">=</span> count<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> f1<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token number">1</span>\n<span class="token operator">>></span><span class="token operator">></span> f2<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token number">4</span>\n<span class="token operator">>></span><span class="token operator">></span> f3<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token number">9</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="nonlocal"><a href="#nonlocal" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>nonlocal</h3>\n<p>使用闭包，就是内层函数引用了外层函数的局部变量。如果只是读外层变量的值，我们会发现返回的闭包函数调用一切正常：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60692568397530030000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def inc():\n    x = 0\n    def fn():\n        # 仅读取 x 的值:\n        return x + 1\n    return fn\n\nf = inc()\nprint(f()) # 1\nprint(f()) # 1`, `60692568397530030000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    x <span class="token operator">=</span> <span class="token number">0</span>\n    <span class="token keyword">def</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token comment"># 仅读取 x 的值:</span>\n        <span class="token keyword">return</span> x <span class="token operator">+</span> <span class="token number">1</span>\n    <span class="token keyword">return</span> fn\n\nf <span class="token operator">=</span> inc<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 1</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是，如果对外层变量赋值，由于 Python 解释器会把 x 当作函数 fn() 的局部变量，它会报错：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54335361676636880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def inc():\n    x = 0\n    def fn():\n        # nonlocal x # 去掉注释可以正常运行\n        x = x + 1 # 不加 nonlocal，这里会报错，会被当成 fn 的局部变量\n        return x\n    return fn\n\nf = inc()\nprint(f()) # 1\nprint(f()) # 2`, `54335361676636880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    x <span class="token operator">=</span> <span class="token number">0</span>\n    <span class="token keyword">def</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token comment"># nonlocal x # 去掉注释可以正常运行</span>\n        x <span class="token operator">=</span> x <span class="token operator">+</span> <span class="token number">1</span> <span class="token comment"># 不加 nonlocal，这里会报错，会被当成 fn 的局部变量</span>\n        <span class="token keyword">return</span> x\n    <span class="token keyword">return</span> fn\n\nf <span class="token operator">=</span> inc<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 1</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 2</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>原因是 x 作为局部变量并没有初始化，直接计算 x+1 是不行的。但我们其实是想引用 inc() 函数内部的 x，所以需要在 fn() 函数内部加一个 nonlocal x 的声明。加上这个声明后，解释器把 fn() 的 x 看作外层函数的局部变量，它已经被初始化了，可以正确计算 x+1。</p>\n<h2 id="匿名函数"><a href="#%E5%8C%BF%E5%90%8D%E5%87%BD%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>匿名函数</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32166512274703260000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> list(map(lambda x: x * x, [1, 2, 3, 4, 5, 6, 7, 8, 9]))\n[1, 4, 9, 16, 25, 36, 49, 64, 81]`, `32166512274703260000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x <span class="token operator">*</span> x<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">49</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">81</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>匿名函数类似于</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3250877076884872700"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def f(x):\n    return x * x`, `3250877076884872700`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> x <span class="token operator">*</span> x</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>匿名函数有个限制，就是只能有一个表达式，不用写 return，返回值就是该表达式的结果。</p>\n<p>用匿名函数有个好处，因为函数没有名字，不必担心函数名冲突。此外，匿名函数也是一个函数对象，也可以把匿名函数赋值给一个变量，再利用变量来调用该函数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94396337914328470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> f = lambda x: x * x\n>>> f\n<function <lambda> at 0x101c6ef28>\n>>> f(5)\n25`, `94396337914328470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> f <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x <span class="token operator">*</span> x\n<span class="token operator">>></span><span class="token operator">></span> f\n<span class="token operator">&lt;</span>function <span class="token operator">&lt;</span><span class="token keyword">lambda</span><span class="token operator">></span> at <span class="token number">0x101c6ef28</span><span class="token operator">></span>\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>\n<span class="token number">25</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>同样，也可以把匿名函数作为返回值返回，比如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57198730638534820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def build(x, y):\n    return lambda: x * x + y * y`, `57198730638534820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">build</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> x <span class="token operator">*</span> x <span class="token operator">+</span> y <span class="token operator">*</span> y</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h2 id="装饰器"><a href="#%E8%A3%85%E9%A5%B0%E5%99%A8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>装饰器</h2>\n<p>由于函数也是一个对象，而且函数对象可以被赋值给变量，所以，通过变量也能调用该函数。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12963603438160165000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> def now():\n...     print(\'2015-3-25\')\n...\n>>> f = now\n>>> f()\n2015-3-25`, `12963603438160165000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">def</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'2015-3-25\'</span><span class="token punctuation">)</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token operator">>></span><span class="token operator">></span> f <span class="token operator">=</span> now\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token number">2015</span><span class="token operator">-</span><span class="token number">3</span><span class="token operator">-</span><span class="token number">25</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>函数对象有一个 <code class="language-text">__name__</code> 属性，可以拿到函数的名字：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26515123834267860000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> now.__name__\n\'now\'\n>>> f.__name__\n\'now\'`, `26515123834267860000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> now<span class="token punctuation">.</span>__name__\n<span class="token string">\'now\'</span>\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">.</span>__name__\n<span class="token string">\'now\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>假设我们要增强 now() 函数的功能，比如，在函数调用前后自动打印日志，但又不希望修改 now() 函数的定义，这种在代码运行期间动态增加功能的方式，称之为“装饰器”（Decorator）。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87593063268364450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def log(func):\n    def wrapper(*args, **kw):\n        print(\'call %s():\' % func.__name__)\n        return func(*args, **kw)\n    return wrapper`, `87593063268364450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">log</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'call %s():\'</span> <span class="token operator">%</span> func<span class="token punctuation">.</span>__name__<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> wrapper</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>观察上面的 log，因为它是一个 decorator，所以接受一个函数作为参数，并返回一个函数。我们要借助 Python 的 @ 语法，把 decorator 置于函数的定义处：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="57048833841102620000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@log\ndef now():\n    print(\'2015-3-25\')`, `57048833841102620000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token decorator annotation punctuation">@log</span>\n<span class="token keyword">def</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'2015-3-25\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>调用 now() 函数，不仅会运行 now() 函数本身，还会在运行 now() 函数前打印一行日志：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="43549325978014196000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> now()\ncall now():\n2015-3-25`, `43549325978014196000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> now<span class="token punctuation">(</span><span class="token punctuation">)</span>\ncall now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token number">2015</span><span class="token operator">-</span><span class="token number">3</span><span class="token operator">-</span><span class="token number">25</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>把 @log 放到 now() 函数的定义处，相当于执行了语句：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="39402764507564570000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`now = log(now)`, `39402764507564570000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">now <span class="token operator">=</span> log<span class="token punctuation">(</span>now<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>如果 decorator 本身需要传入参数，那就需要编写一个返回 decorator 的高阶函数，写出来会更复杂。比如，要自定义 log 的文本：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29150442311930780000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def log(text):\n    def decorator(func):\n        def wrapper(*args, **kw):\n            print(\'%s %s():\' % (text, func.__name__))\n            return func(*args, **kw)\n        return wrapper\n    return decorator`, `29150442311930780000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">log</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">decorator</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'%s %s():\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>text<span class="token punctuation">,</span> func<span class="token punctuation">.</span>__name__<span class="token punctuation">)</span><span class="token punctuation">)</span>\n            <span class="token keyword">return</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> wrapper\n    <span class="token keyword">return</span> decorator</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个 3 层嵌套的 decorator 用法如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37109296512285790000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@log(\'execute\')\ndef now():\n    print(\'2015-3-25\')\n\n>>> now()\nexecute now():\n2015-3-25`, `37109296512285790000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token decorator annotation punctuation">@log</span><span class="token punctuation">(</span><span class="token string">\'execute\'</span><span class="token punctuation">)</span>\n<span class="token keyword">def</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'2015-3-25\'</span><span class="token punctuation">)</span>\n\n<span class="token operator">>></span><span class="token operator">></span> now<span class="token punctuation">(</span><span class="token punctuation">)</span>\nexecute now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token number">2015</span><span class="token operator">-</span><span class="token number">3</span><span class="token operator">-</span><span class="token number">25</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>和两层嵌套的 decorator 相比，3 层嵌套的效果是这样的：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="673986313590724200"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> now = log(\'execute\')(now)`, `673986313590724200`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> now <span class="token operator">=</span> log<span class="token punctuation">(</span><span class="token string">\'execute\'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>我们来剖析上面的语句，首先执行 <code class="language-text">log(&#39;execute&#39;)</code>，返回的是 decorator 函数，再调用返回的函数，参数是 now 函数，返回值最终是 wrapper 函数。</p>\n<p>以上两种 decorator 的定义都没有问题，但还差最后一步。因为我们讲了函数也是对象，它有 <code class="language-text">__name__</code> 等属性，但你去看经过 decorator 装饰之后的函数，它们的 <code class="language-text">__name__</code> 已经从原来的 now 变成了 wrapper：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63603234189643930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> now.__name__\n\'wrapper\'`, `63603234189643930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> now<span class="token punctuation">.</span>__name__\n<span class="token string">\'wrapper\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>因为返回的那个 wrapper() 函数名字就是 wrapper，所以，需要把原始函数的 <code class="language-text">__name__</code> 等属性复制到 wrapper() 函数中，否则，有些依赖函数签名的代码执行就会出错。</p>\n<p>不需要编写 <code class="language-text">wrapper.__name__ = func.__name__</code> 这样的代码，Python 内置的 functools.wraps 就是干这个事的，所以，一个完整的 decorator 的写法如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8209244003737814000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import functools\n\ndef log(func):\n    @functools.wraps(func)\n    def wrapper(*args, **kw):\n        print(\'call %s():\' % func.__name__)\n        return func(*args, **kw)\n    return wrapper`, `8209244003737814000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> functools\n\n<span class="token keyword">def</span> <span class="token function">log</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    @functools<span class="token punctuation">.</span>wraps<span class="token punctuation">(</span>func<span class="token punctuation">)</span>\n    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'call %s():\'</span> <span class="token operator">%</span> func<span class="token punctuation">.</span>__name__<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> wrapper</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>或者针对带参数的 decorator：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25803721570655445000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import functools\n\ndef log(text):\n    def decorator(func):\n        @functools.wraps(func)\n        def wrapper(*args, **kw):\n            print(\'%s %s():\' % (text, func.__name__))\n            return func(*args, **kw)\n        return wrapper\n    return decorator`, `25803721570655445000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> functools\n\n<span class="token keyword">def</span> <span class="token function">log</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">decorator</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        @functools<span class="token punctuation">.</span>wraps<span class="token punctuation">(</span>func<span class="token punctuation">)</span>\n        <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'%s %s():\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>text<span class="token punctuation">,</span> func<span class="token punctuation">.</span>__name__<span class="token punctuation">)</span><span class="token punctuation">)</span>\n            <span class="token keyword">return</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> wrapper\n    <span class="token keyword">return</span> decorator</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="偏函数"><a href="#%E5%81%8F%E5%87%BD%E6%95%B0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>偏函数</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22815107862776010000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> import functools\n>>> int2 = functools.partial(int, base=2)\n>>> int2(\'1000000\')\n64\n>>> int2(\'1010101\')\n85`, `22815107862776010000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> functools\n<span class="token operator">>></span><span class="token operator">></span> int2 <span class="token operator">=</span> functools<span class="token punctuation">.</span>partial<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> base<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> int2<span class="token punctuation">(</span><span class="token string">\'1000000\'</span><span class="token punctuation">)</span>\n<span class="token number">64</span>\n<span class="token operator">>></span><span class="token operator">></span> int2<span class="token punctuation">(</span><span class="token string">\'1010101\'</span><span class="token punctuation">)</span>\n<span class="token number">85</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>所以，简单总结 functools.partial 的作用就是，把一个函数的某些参数给固定住（也就是设置默认值），返回一个新的函数，调用这个新函数会更简单。</p>\n<p>注意到上面的新的 int2 函数，仅仅是把 base 参数重新设定默认值为 2，但也可以在函数调用时传入其他值：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9303097287633345000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> int2(\'1000000\', base=10)\n1000000`, `9303097287633345000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> int2<span class="token punctuation">(</span><span class="token string">\'1000000\'</span><span class="token punctuation">,</span> base<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>\n<span class="token number">1000000</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>最后，创建偏函数时，实际上可以接收函数对象、<code class="language-text">*args</code> 和 <code class="language-text">**kw</code> 这 3 个参数，当传入：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77097903401951310000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`int2 = functools.partial(int, base=2)`, `77097903401951310000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">int2 <span class="token operator">=</span> functools<span class="token punctuation">.</span>partial<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> base<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>实际上固定了 int() 函数的关键字参数 base，也就是：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84362010989076730000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`int2(\'10010\')`, `84362010989076730000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">int2<span class="token punctuation">(</span><span class="token string">\'10010\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>相当于：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30288651574770920000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`kw = { \'base\': 2 }\nint(\'10010\', **kw)`, `30288651574770920000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">kw <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">\'base\'</span><span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span>\n<span class="token builtin">int</span><span class="token punctuation">(</span><span class="token string">\'10010\'</span><span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h1 id="模块"><a href="#%E6%A8%A1%E5%9D%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>模块</h1>\n<p>使用模块有什么好处？</p>\n<p>最大的好处是大大提高了代码的可维护性。其次，编写代码不必从零开始。当一个模块编写完毕，就可以被其他地方引用。我们在编写程序的时候，也经常引用其他模块，包括 Python 内置的模块和来自第三方的模块。</p>\n<p>使用模块还可以避免函数名和变量名冲突。相同名字的函数和变量完全可以分别存在不同的模块中，因此，我们自己在编写模块时，不必考虑名字会与其他模块冲突。但是也要注意，尽量不要与内置函数名字冲突。点<a href="https://docs.python.org/3/library/functions.html#built-in-functions" target="_blank" rel="nofollow noreferrer noopener">这里</a>查看 Python 的所有内置函数。</p>\n<p>如果不同的人编写的模块名相同怎么办？为了避免模块名冲突，Python 又引入了按目录来组织模块的方法，称为包（Package）。</p>\n<p>举个例子，一个 abc.py 的文件就是一个名字叫 abc 的模块，一个 xyz.py 的文件就是一个名字叫 xyz 的模块。</p>\n<p>现在，假设我们的 abc 和 xyz 这两个模块名字与其他模块冲突了，于是我们可以通过包来组织模块，避免冲突。方法是选择一个顶层包名，比如 mycompany，按照如下目录存放：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25136980157325816000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`mycompany\n├─ __init__.py\n├─ abc.py\n└─ xyz.py`, `25136980157325816000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">mycompany\n├─ __init__.py\n├─ abc.py\n└─ xyz.py</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>引入了包以后，只要顶层的包名不与别人冲突，那所有模块都不会与别人冲突。现在，abc.py 模块的名字就变成了 mycompany.abc，类似的，xyz.py 的模块名变成了 mycompany.xyz。</p>\n<p>请注意，每一个包目录下面都会有一个 <code class="language-text">__init__.py</code> 的文件，这个文件是必须存在的，否则，Python 就把这个目录当成普通目录，而不是一个包。<code class="language-text">__init__.py</code> 可以是空文件，也可以有 Python 代码，因为 <code class="language-text">__init__.py</code> 本身就是一个模块，而它的模块名就是 mycompany。</p>\n<p>类似的，可以有多级目录，组成多级层次的包结构。比如如下的目录结构：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21722820289046260000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`mycompany\n ├─ web\n │  ├─ __init__.py\n │  ├─ utils.py\n │  └─ www.py\n ├─ __init__.py\n ├─ abc.py\n └─ utils.py`, `21722820289046260000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">mycompany\n ├─ web\n │  ├─ __init__.py\n │  ├─ utils.py\n │  └─ www.py\n ├─ __init__.py\n ├─ abc.py\n └─ utils.py</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>文件 www.py 的模块名就是 mycompany.web.www，两个文件 utils.py 的模块名分别是 mycompany.utils 和 mycompany.web.utils</p>\n<blockquote>\n<p>自己创建模块时要注意命名，不能和 Python 自带的模块名称冲突。例如，系统自带了 sys 模块，自己的模块就不可命名为 sys.py，否则将无法导入系统自带的 sys 模块。</p>\n</blockquote>\n<h2 id="使用模块"><a href="#%E4%BD%BF%E7%94%A8%E6%A8%A1%E5%9D%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用模块</h2>\n<p>Python 本身就内置了很多非常有用的模块，只要安装完毕，这些模块就可以立刻使用。</p>\n<p>我们以内建的 sys 模块为例，编写一个 hello 的模块：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48514336984988656000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`#!/usr/bin/env python3\n# -*- coding: utf-8 -*-\n\n\' a test module \'\n\n__author__ = \'Michael Liao\'\n\nimport sys\n\ndef test():\n    args = sys.argv\n    if len(args)==1:\n        print(\'Hello, world!\')\n    elif len(args)==2:\n        print(\'Hello, %s!\' % args[1])\n    else:\n        print(\'Too many arguments!\')\n\nif __name__==\'__main__\':\n    test()`, `48514336984988656000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment">#!/usr/bin/env python3</span>\n<span class="token comment"># -*- coding: utf-8 -*-</span>\n\n<span class="token string">\' a test module \'</span>\n\n__author__ <span class="token operator">=</span> <span class="token string">\'Michael Liao\'</span>\n\n<span class="token keyword">import</span> sys\n\n<span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    args <span class="token operator">=</span> sys<span class="token punctuation">.</span>argv\n    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Hello, world!\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">elif</span> <span class="token builtin">len</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Hello, %s!\'</span> <span class="token operator">%</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Too many arguments!\'</span><span class="token punctuation">)</span>\n\n<span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">\'__main__\'</span><span class="token punctuation">:</span>\n    test<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>第 1 行和第 2 行是标准注释，第 1 行注释可以让这个 hello.py 文件直接在 Unix/Linux/Mac 上运行，第 2 行注释表示 .py 文件本身使用标准 UTF-8 编码；</p>\n<p>第 4 行是一个字符串，表示模块的文档注释，任何模块代码的第一个字符串都被视为模块的文档注释；</p>\n<p>第 6 行使用 <code class="language-text">__author__</code> 变量把作者写进去，这样当你公开源代码后别人就可以瞻仰你的大名；</p>\n<p>以上就是 Python 模块的标准文件模板，当然也可以全部删掉不写，但是，按标准办事肯定没错。</p>\n<p>后面开始就是真正的代码部分。</p>\n<p>你可能注意到了，使用 sys 模块的第一步，就是导入该模块：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92965106304721830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import sys`, `92965106304721830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> sys</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>导入 sys 模块后，我们就有了变量 sys 指向该模块，利用 sys 这个变量，就可以访问 sys 模块的所有功能。</p>\n<p>sys 模块有一个 argv 变量，用 list 存储了命令行的所有参数。argv 至少有一个元素，因为第一个参数永远是该 .py 文件的名称，例如：</p>\n<p>运行 python3 hello.py 获得的 sys.argv 就是 <code class="language-text">[&#39;hello.py&#39;]</code>；</p>\n<p>运行 python3 hello.py Michael 获得的 sys.argv 就是 <code class="language-text">[&#39;hello.py&#39;, &#39;Michael&#39;]</code>。</p>\n<p>最后，注意到这两行代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54721261458714390000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`if __name__==\'__main__\':\n    test()`, `54721261458714390000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">\'__main__\'</span><span class="token punctuation">:</span>\n    test<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>当我们在命令行运行 hello 模块文件时，Python 解释器把一个特殊变量 <code class="language-text">__name__</code> 置为 <code class="language-text">__main__</code>，而如果在其他地方导入该 hello 模块时，if 判断将失败，因此，这种 if 测试可以让一个模块通过命令行运行时执行一些额外的代码，最常见的就是运行测试。</p>\n<p>我们可以用命令行运行 hello.py 看看效果：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1905676426752234200"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ python3 hello.py\nHello, world!\n\\$ python3 hello.py Michael\nHello, Michael!`, `1905676426752234200`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">$ python3 hello.py\nHello, world!\n$ python3 hello.py Michael\nHello, Michael!</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果启动 Python 交互环境，再导入 hello 模块：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16040401767987400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ python3\nPython 3.4.3 (v3.4.3:9b73f1c3e601, Feb 23 2015, 02:52:03)\n[GCC 4.2.1 (Apple Inc. build 5666) (dot 3)] on darwin\nType &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.\n>>> import hello\n>>>`, `16040401767987400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">$ python3\nPython 3.4.3 (v3.4.3:9b73f1c3e601, Feb 23 2015, 02:52:03)\n[GCC 4.2.1 (Apple Inc. build 5666) (dot 3)] on darwin\nType &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.\n&gt;&gt;&gt; import hello\n&gt;&gt;&gt;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>导入时，没有打印 Hello, word!，因为没有执行 test() 函数。</p>\n<p>调用 hello.test() 时，才能打印出 Hello, word!：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89070137992432840000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> hello.test()\nHello, world!`, `89070137992432840000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> hello<span class="token punctuation">.</span>test<span class="token punctuation">(</span><span class="token punctuation">)</span>\nHello<span class="token punctuation">,</span> world!</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h3 id="作用域"><a href="#%E4%BD%9C%E7%94%A8%E5%9F%9F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>作用域</h3>\n<p>在一个模块中，我们可能会定义很多函数和变量，但有的函数和变量我们希望给别人使用，有的函数和变量我们希望仅仅在模块内部使用。在 Python 中，是通过 <code class="language-text">_</code> 前缀来实现的。</p>\n<p>正常的函数和变量名是公开的（public），可以被直接引用，比如：abc，x123，PI 等；</p>\n<p>类似 <code class="language-text">__xxx__</code> 这样的变量是特殊变量，可以被直接引用，但是有特殊用途，比如上面的 <code class="language-text">__author__</code>，<code class="language-text">__name__</code> 就是特殊变量，hello 模块定义的文档注释也可以用特殊变量 <code class="language-text">__doc__</code> 访问，我们自己的变量一般不要用这种变量名；</p>\n<p>类似 <code class="language-text">_xxx</code> 和 <code class="language-text">__xxx</code> 这样的函数或变量就是非公开的（private），不应该被直接引用，比如 <code class="language-text">_abc</code>，<code class="language-text">__abc</code> 等；</p>\n<p>之所以我们说，private 函数和变量“不应该”被直接引用，而不是“不能”被直接引用，是因为 Python 并没有一种方法可以完全限制访问 private 函数或变量，但是，从编程习惯上不应该引用 private 函数或变量。</p>\n<p>private 函数或变量不应该被别人引用，那它们有什么用呢？请看例子：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2025255146976934100"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def _private_1(name):\n    return \'Hello, %s\' % name\n\ndef _private_2(name):\n    return \'Hi, %s\' % name\n\ndef greeting(name):\n    if len(name) > 3:\n        return _private_1(name)\n    else:\n        return _private_2(name)`, `2025255146976934100`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">_private_1</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> <span class="token string">\'Hello, %s\'</span> <span class="token operator">%</span> name\n\n<span class="token keyword">def</span> <span class="token function">_private_2</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> <span class="token string">\'Hi, %s\'</span> <span class="token operator">%</span> name\n\n<span class="token keyword">def</span> <span class="token function">greeting</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">3</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> _private_1<span class="token punctuation">(</span>name<span class="token punctuation">)</span>\n    <span class="token keyword">else</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> _private_2<span class="token punctuation">(</span>name<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们在模块里公开 greeting() 函数，而把内部逻辑用 private 函数隐藏起来了，这样，调用 greeting() 函数不用关心内部的 private 函数细节，这也是一种非常有用的代码封装和抽象的方法，即：</p>\n<p>外部不需要引用的函数全部定义成 private，只有外部需要引用的函数才定义为 public。</p>\n<h2 id="安装第三方模块"><a href="#%E5%AE%89%E8%A3%85%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A8%A1%E5%9D%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>安装第三方模块</h2>\n<p>安装 Pillow 的命令就是</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37842497287363330000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pip install Pillow`, `37842497287363330000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">pip install Pillow</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="安装常用模块"><a href="#%E5%AE%89%E8%A3%85%E5%B8%B8%E7%94%A8%E6%A8%A1%E5%9D%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>安装常用模块</h3>\n<p>推荐直接使用 <a href="https://www.anaconda.com/products/distribution" target="_blank" rel="nofollow noreferrer noopener">Anaconda</a>，内置了许多非常有用的第三方库</p>\n<h3 id="模块搜索路径"><a href="#%E6%A8%A1%E5%9D%97%E6%90%9C%E7%B4%A2%E8%B7%AF%E5%BE%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>模块搜索路径</h3>\n<p>当我们试图加载一个模块时，Python 会在指定的路径下搜索对应的 .py 文件，如果找不到，就会报错：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="45657553008162410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> import mymodule\nTraceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\nImportError: No module named mymodule`, `45657553008162410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">&gt;&gt;&gt; import mymodule\nTraceback (most recent call last):\n  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;\nImportError: No module named mymodule</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>默认情况下，Python 解释器会搜索当前目录、所有已安装的内置模块和第三方模块，搜索路径存放在 sys 模块的 path 变量中：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20439313211656417000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> import sys\n>>> sys.path\n[\'\', \'/Library/Frameworks/Python.framework/Versions/3.6/lib/python36.zip\', \'/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6\', ..., \'/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/site-packages\']`, `20439313211656417000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> sys\n<span class="token operator">>></span><span class="token operator">></span> sys<span class="token punctuation">.</span>path\n<span class="token punctuation">[</span><span class="token string">\'\'</span><span class="token punctuation">,</span> <span class="token string">\'/Library/Frameworks/Python.framework/Versions/3.6/lib/python36.zip\'</span><span class="token punctuation">,</span> <span class="token string">\'/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6\'</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token string">\'/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/site-packages\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>如果我们要添加自己的搜索目录，有两种方法：</p>\n<ol>\n<li>\n<p>直接修改 sys.path，添加要搜索的目录，但是运行结束后失效。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61883576089829380000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> import sys\n>>> sys.path.append(\'/Users/michael/my_py_scripts\')`, `61883576089829380000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> sys\n<span class="token operator">>></span><span class="token operator">></span> sys<span class="token punctuation">.</span>path<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">\'/Users/michael/my_py_scripts\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n</li>\n<li>\n<p>设置环境变量 PYTHONPATH，该环境变量的内容会被自动添加到模块搜索路径中。设置方式与设置 Path 环境变量类似。注意只需要添加你自己的搜索路径，Python 自己本身的搜索路径不受影响。</p>\n</li>\n</ol>\n<h1 id="面向对象编程"><a href="#%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%BC%96%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>面向对象编程</h1>\n<p>在 Python 中，所有数据类型都可以视为对象，当然也可以自定义对象。自定义的对象数据类型就是面向对象中的类（Class）的概念。</p>\n<p>我们以一个例子来说明面向过程和面向对象在程序流程上的不同之处。</p>\n<p>假设我们要处理学生的成绩表，为了表示一个学生的成绩，面向过程的程序可以用一个 dict 表示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70440384169383100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`std1 = { \'name\': \'Michael\', \'score\': 98 }\nstd2 = { \'name\': \'Bob\', \'score\': 81 }`, `70440384169383100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">std1 <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">\'name\'</span><span class="token punctuation">:</span> <span class="token string">\'Michael\'</span><span class="token punctuation">,</span> <span class="token string">\'score\'</span><span class="token punctuation">:</span> <span class="token number">98</span> <span class="token punctuation">}</span>\nstd2 <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">\'name\'</span><span class="token punctuation">:</span> <span class="token string">\'Bob\'</span><span class="token punctuation">,</span> <span class="token string">\'score\'</span><span class="token punctuation">:</span> <span class="token number">81</span> <span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>而处理学生成绩可以通过函数实现，比如打印学生的成绩：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17085278212343824000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def print_score(std):\n    print(\'%s: %s\' % (std[\'name\'], std[\'score\']))`, `17085278212343824000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">print_score</span><span class="token punctuation">(</span>std<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'%s: %s\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>std<span class="token punctuation">[</span><span class="token string">\'name\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> std<span class="token punctuation">[</span><span class="token string">\'score\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>如果采用面向对象的程序设计思想，我们首选思考的不是程序的执行流程，而是 Student 这种数据类型应该被视为一个对象，这个对象拥有 name 和 score 这两个属性（Property）。如果要打印一个学生的成绩，首先必须创建出这个学生对应的对象，然后，给对象发一个 print_score 消息，让对象自己把自己的数据打印出来。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29640223800742960000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n\n    def __init__(self, name, score):\n        self.name = name\n        self.score = score\n\n    def print_score(self):\n        print(\'%s: %s\' % (self.name, self.score))`, `29640223800742960000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> score<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name\n        self<span class="token punctuation">.</span>score <span class="token operator">=</span> score\n\n    <span class="token keyword">def</span> <span class="token function">print_score</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'%s: %s\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>name<span class="token punctuation">,</span> self<span class="token punctuation">.</span>score<span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>给对象发消息实际上就是调用对象对应的关联函数，我们称之为对象的方法（Method）。面向对象的程序写出来就像这样：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79973333163044900000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`bart = Student(\'Bart Simpson\', 59)\nlisa = Student(\'Lisa Simpson\', 87)\nbart.print_score()\nlisa.print_score()`, `79973333163044900000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">bart <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">\'Bart Simpson\'</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">)</span>\nlisa <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">\'Lisa Simpson\'</span><span class="token punctuation">,</span> <span class="token number">87</span><span class="token punctuation">)</span>\nbart<span class="token punctuation">.</span>print_score<span class="token punctuation">(</span><span class="token punctuation">)</span>\nlisa<span class="token punctuation">.</span>print_score<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>数据封装、继承和多态是面向对象的三大特点</p>\n<h2 id="类和实例"><a href="#%E7%B1%BB%E5%92%8C%E5%AE%9E%E4%BE%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>类和实例</h2>\n<p>在 Python 中，定义类是通过 class 关键字：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="30636509699325497000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n    pass`, `30636509699325497000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>class 后面紧接着是类名，即 Student，类名通常是大写开头的单词，紧接着是(object)，表示该类是从哪个类继承下来的，继承的概念我们后面再讲，通常，如果没有合适的继承类，就使用 object 类，这是所有类最终都会继承的类。</p>\n<p>定义好了 Student 类，就可以根据 Student 类创建出 Student 的实例，创建实例是通过 <code class="language-text">类名()</code> 实现的：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75266327517378380000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> bart = Student()\n>>> bart\n<__main__.Student object at 0x10a67a590>\n>>> Student\n<class \'__main__.Student\'>`, `75266327517378380000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> bart <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> bart\n<span class="token operator">&lt;</span>__main__<span class="token punctuation">.</span>Student <span class="token builtin">object</span> at <span class="token number">0x10a67a590</span><span class="token operator">></span>\n<span class="token operator">>></span><span class="token operator">></span> Student\n<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.Student\'</span><span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，变量 bart 指向的就是一个 Student 的实例，后面的 0x10a67a590 是内存地址，每个 object 的地址都不一样，而 Student 本身则是一个类。</p>\n<p>可以自由地给一个实例变量绑定属性，比如，给实例 bart 绑定一个 name 属性：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25506528776320160000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> bart.name = \'Bart Simpson\'\n>>> bart.name\n\'Bart Simpson\'`, `25506528776320160000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">\'Bart Simpson\'</span>\n<span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>name\n<span class="token string">\'Bart Simpson\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>由于类可以起到模板的作用，因此，可以在创建实例的时候，把一些我们认为必须绑定的属性强制填写进去。通过定义一个特殊的 <code class="language-text">__init__</code> 方法，在创建实例的时候，就把 name，score 等属性绑上去：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29052551852162933000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n\n    def __init__(self, name, score):\n        self.name = name\n        self.score = score`, `29052551852162933000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> score<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name\n        self<span class="token punctuation">.</span>score <span class="token operator">=</span> score</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>注意：特殊方法 <code class="language-text">__init__</code> 前后分别有两个下划线！！！</p>\n</blockquote>\n<p>注意到 <code class="language-text">__init__</code> 方法的第一个参数永远是 self，表示创建的实例本身，因此，在 <code class="language-text">__init__</code> 方法内部，就可以把各种属性绑定到 self，因为 self 就指向创建的实例本身。</p>\n<p>有了 <code class="language-text">__init__</code> 方法，在创建实例的时候，就不能传入空的参数了，必须传入与 <code class="language-text">__init__</code> 方法匹配的参数，但 self 不需要传，Python 解释器自己会把实例变量传进去：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8975243209495410000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> bart = Student(\'Bart Simpson\', 59)\n>>> bart.name\n\'Bart Simpson\'\n>>> bart.score\n59`, `8975243209495410000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> bart <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">\'Bart Simpson\'</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>name\n<span class="token string">\'Bart Simpson\'</span>\n<span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>score\n<span class="token number">59</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>和普通的函数相比，在类中定义的函数只有一点不同，就是第一个参数永远是实例变量 self，并且，调用时，不用传递该参数。除此之外，类的方法和普通函数没有什么区别，所以，你仍然可以用默认参数、可变参数、关键字参数和命名关键字参数。</p>\n<h3 id="数据封装"><a href="#%E6%95%B0%E6%8D%AE%E5%B0%81%E8%A3%85" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>数据封装</h3>\n<p>面向对象编程的一个重要特点就是数据封装。在上面的 Student 类中，每个实例就拥有各自的 name 和 score 这些数据。我们可以通过函数来访问这些数据，比如打印一个学生的成绩：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58741716007357070000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> def print_score(std):\n...     print(\'%s: %s\' % (std.name, std.score))\n...\n>>> print_score(bart)\nBart Simpson: 59`, `58741716007357070000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">def</span> <span class="token function">print_score</span><span class="token punctuation">(</span>std<span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'%s: %s\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>std<span class="token punctuation">.</span>name<span class="token punctuation">,</span> std<span class="token punctuation">.</span>score<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token operator">>></span><span class="token operator">></span> print_score<span class="token punctuation">(</span>bart<span class="token punctuation">)</span>\nBart Simpson<span class="token punctuation">:</span> <span class="token number">59</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是，既然 Student 实例本身就拥有这些数据，要访问这些数据，就没有必要从外面的函数去访问，可以直接在 Student 类的内部定义访问数据的函数，这样，就把“数据”给封装起来了。这些封装数据的函数是和 Student 类本身是关联起来的，我们称之为类的方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74218556166429310000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n\n    def __init__(self, name, score):\n        self.name = name\n        self.score = score\n\n    def print_score(self):\n        print(\'%s: %s\' % (self.name, self.score))`, `74218556166429310000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> score<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name\n        self<span class="token punctuation">.</span>score <span class="token operator">=</span> score\n\n    <span class="token keyword">def</span> <span class="token function">print_score</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'%s: %s\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>name<span class="token punctuation">,</span> self<span class="token punctuation">.</span>score<span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>要定义一个方法，除了第一个参数是 self 外，其他和普通函数一样。要调用一个方法，只需要在实例变量上直接调用，除了 self 不用传递，其他参数正常传入：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4033799434878893000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> bart.print_score()\nBart Simpson: 59`, `4033799434878893000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>print_score<span class="token punctuation">(</span><span class="token punctuation">)</span>\nBart Simpson<span class="token punctuation">:</span> <span class="token number">59</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>这样一来，我们从外部看 Student 类，就只需要知道，创建实例需要给出 name 和 score，而如何打印，都是在 Student 类的内部定义的，这些数据和逻辑被“封装”起来了，调用很容易，但却不用知道内部实现的细节。</p>\n<p>封装的另一个好处是可以给 Student 类增加新的方法，比如 get_grade：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49407621339997635000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n    ...\n\n    def get_grade(self):\n        if self.score >= 90:\n            return \'A\'\n        elif self.score >= 60:\n            return \'B\'\n        else:\n            return \'C\'`, `49407621339997635000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n\n    <span class="token keyword">def</span> <span class="token function">get_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> self<span class="token punctuation">.</span>score <span class="token operator">>=</span> <span class="token number">90</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token string">\'A\'</span>\n        <span class="token keyword">elif</span> self<span class="token punctuation">.</span>score <span class="token operator">>=</span> <span class="token number">60</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token string">\'B\'</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token string">\'C\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>同样的，get_grade 方法可以直接在实例变量上调用，不需要知道内部实现细节：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71345910314301180000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n    def __init__(self, name, score):\n        self.name = name\n        self.score = score\n\n    def get_grade(self):\n        if self.score >= 90:\n            return \'A\'\n        elif self.score >= 60:\n            return \'B\'\n        else:\n            return \'C\'\n\nlisa = Student(\'Lisa\', 99)\nbart = Student(\'Bart\', 59)\nprint(lisa.name, lisa.get_grade()) # Lisa A\nprint(bart.name, bart.get_grade()) # Bart C`, `71345910314301180000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> score<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name\n        self<span class="token punctuation">.</span>score <span class="token operator">=</span> score\n\n    <span class="token keyword">def</span> <span class="token function">get_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> self<span class="token punctuation">.</span>score <span class="token operator">>=</span> <span class="token number">90</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token string">\'A\'</span>\n        <span class="token keyword">elif</span> self<span class="token punctuation">.</span>score <span class="token operator">>=</span> <span class="token number">60</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token string">\'B\'</span>\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token string">\'C\'</span>\n\nlisa <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">\'Lisa\'</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">)</span>\nbart <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">\'Bart\'</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>lisa<span class="token punctuation">.</span>name<span class="token punctuation">,</span> lisa<span class="token punctuation">.</span>get_grade<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># Lisa A</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>bart<span class="token punctuation">.</span>name<span class="token punctuation">,</span> bart<span class="token punctuation">.</span>get_grade<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># Bart C</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="小结-5"><a href="#%E5%B0%8F%E7%BB%93-5" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>类是创建实例的模板，而实例则是一个一个具体的对象，各个实例拥有的数据都互相独立，互不影响；</p>\n<p>方法就是与实例绑定的函数，和普通函数不同，方法可以直接访问实例的数据；</p>\n<p>通过在实例上调用方法，我们就直接操作了对象内部的数据，但无需知道方法内部的实现细节。</p>\n<p>和静态语言不同，Python 允许对实例变量绑定任何数据，也就是说，对于两个实例变量，虽然它们都是同一个类的不同实例，但拥有的变量名称都可能不同：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86387889571537200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> bart = Student(\'Bart Simpson\', 59)\n>>> lisa = Student(\'Lisa Simpson\', 87)\n>>> bart.age = 8\n>>> bart.age\n8\n>>> lisa.age\nTraceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\nAttributeError: \'Student\' object has no attribute \'age\'`, `86387889571537200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> bart <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">\'Bart Simpson\'</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> lisa <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">\'Lisa Simpson\'</span><span class="token punctuation">,</span> <span class="token number">87</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">8</span>\n<span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>age\n<span class="token number">8</span>\n<span class="token operator">>></span><span class="token operator">></span> lisa<span class="token punctuation">.</span>age\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\nAttributeError<span class="token punctuation">:</span> <span class="token string">\'Student\'</span> <span class="token builtin">object</span> has no attribute <span class="token string">\'age\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id="访问限制"><a href="#%E8%AE%BF%E9%97%AE%E9%99%90%E5%88%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>访问限制</h2>\n<p>在 Class 内部，可以有属性和方法，而外部代码可以通过直接调用实例变量的方法来操作数据，这样，就隐藏了内部的复杂逻辑。</p>\n<p>但是，从前面 Student 类的定义来看，外部代码还是可以自由地修改一个实例的 name、score 属性：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76835187009153470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> bart = Student(\'Bart Simpson\', 59)\n>>> bart.score\n59\n>>> bart.score = 99\n>>> bart.score\n99`, `76835187009153470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> bart <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">\'Bart Simpson\'</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>score\n<span class="token number">59</span>\n<span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>score <span class="token operator">=</span> <span class="token number">99</span>\n<span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>score\n<span class="token number">99</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果要让内部属性不被外部访问，可以把属性的名称前加上两个下划线 <code class="language-text">__</code>，在 Python 中，实例的变量名如果以 <code class="language-text">__</code> 开头，就变成了一个私有变量（private），只有内部可以访问，外部不能访问，所以，我们把 Student 类改一改：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18632725264937845000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n\n    def __init__(self, name, score):\n        self.__name = name\n        self.__score = score\n\n    def print_score(self):\n        print(\'%s: %s\' % (self.__name, self.__score))`, `18632725264937845000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> score<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>__name <span class="token operator">=</span> name\n        self<span class="token punctuation">.</span>__score <span class="token operator">=</span> score\n\n    <span class="token keyword">def</span> <span class="token function">print_score</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'%s: %s\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>__name<span class="token punctuation">,</span> self<span class="token punctuation">.</span>__score<span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>改完后，对于外部代码来说，没什么变动，但是已经无法从外部访问 <code class="language-text">实例变量.__name</code> 和 <code class="language-text">实例变量.__score</code> 了：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99395747544032380000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> bart = Student(\'Bart Simpson\', 59)\n>>> bart.__name\nTraceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\nAttributeError: \'Student\' object has no attribute \'__name\'`, `99395747544032380000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> bart <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">\'Bart Simpson\'</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>__name\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\nAttributeError<span class="token punctuation">:</span> <span class="token string">\'Student\'</span> <span class="token builtin">object</span> has no attribute <span class="token string">\'__name\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样就确保了外部代码不能随意修改对象内部的状态，这样通过访问限制的保护，代码更加健壮。</p>\n<p>但是如果外部代码要获取 name 和 score 怎么办？可以给 Student 类增加 <code class="language-text">get_name</code> 和 <code class="language-text">get_score</code> 这样的方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98364732111583600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n    ...\n\n    def get_name(self):\n        return self.__name\n\n    def get_score(self):\n        return self.__score`, `98364732111583600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n\n    <span class="token keyword">def</span> <span class="token function">get_name</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>__name\n\n    <span class="token keyword">def</span> <span class="token function">get_score</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>__score</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果又要允许外部代码修改 score 怎么办？可以再给 Student 类增加 set_score 方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82557822835667480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n    ...\n\n    def set_score(self, score):\n        self.__score = score`, `82557822835667480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n\n    <span class="token keyword">def</span> <span class="token function">set_score</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> score<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>__score <span class="token operator">=</span> score</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>你也许会问，原先那种直接通过 bart.score = 99 也可以修改啊，为什么要定义一个方法大费周折？因为在方法中，可以对参数做检查，避免传入无效的参数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3567697609337506000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n    ...\n\n    def set_score(self, score):\n        if 0 <= score <= 100:\n            self.__score = score\n        else:\n            raise ValueError(\'bad score\')`, `3567697609337506000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n\n    <span class="token keyword">def</span> <span class="token function">set_score</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> score<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> <span class="token number">0</span> <span class="token operator">&lt;=</span> score <span class="token operator">&lt;=</span> <span class="token number">100</span><span class="token punctuation">:</span>\n            self<span class="token punctuation">.</span>__score <span class="token operator">=</span> score\n        <span class="token keyword">else</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'bad score\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>需要注意的是，在 Python 中，变量名类似 <code class="language-text">__xxx__</code> 的，也就是以双下划线开头，并且以双下划线结尾的，是特殊变量，特殊变量是可以直接访问的，不是 private 变量，所以，不能用 <code class="language-text">__name__</code>、 <code class="language-text">__score__</code> 这样的变量名。</p>\n<p>有些时候，你会看到以一个下划线开头的实例变量名，比如 <code class="language-text">_name</code>，这样的实例变量外部是可以访问的，但是，按照约定俗成的规定，当你看到这样的变量时，意思就是，“虽然我可以被访问，但是，请把我视为私有变量，不要随意访问”。</p>\n<p>双下划线开头的实例变量是不是一定不能从外部访问呢？其实也不是。不能直接访问 <code class="language-text">__name</code> 是因为 Python 解释器对外把 <code class="language-text">__name</code> 变量改成了 <code class="language-text">_Student__name</code>，所以，仍然可以通过 <code class="language-text">_Student__name</code> 来访问 <code class="language-text">__name</code> 变量：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71412557356748590000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> bart._Student__name\n\'Bart Simpson\'`, `71412557356748590000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>_Student__name\n<span class="token string">\'Bart Simpson\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>但是强烈建议你不要这么干，因为不同版本的 Python 解释器可能会把 <code class="language-text">__name</code> 改成不同的变量名。</p>\n<p>总的来说就是，Python 本身没有任何机制阻止你干坏事，一切全靠自觉。</p>\n<p>最后注意下面的这种错误写法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18909543461607980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> bart = Student(\'Bart Simpson\', 59)\n>>> bart.get_name()\n\'Bart Simpson\'\n>>> bart.__name = \'New Name\' # 设置 __name 变量！\n>>> bart.__name\n\'New Name\'`, `18909543461607980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> bart <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">\'Bart Simpson\'</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>get_name<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token string">\'Bart Simpson\'</span>\n<span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>__name <span class="token operator">=</span> <span class="token string">\'New Name\'</span> <span class="token comment"># 设置 __name 变量！</span>\n<span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>__name\n<span class="token string">\'New Name\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>表面上看，外部代码“成功”地设置了 <code class="language-text">__name</code> 变量，但实际上这个 <code class="language-text">__name</code> 变量和 class 内部的 <code class="language-text">__name</code> 变量不是一个变量！内部的 <code class="language-text">__name</code> 变量已经被 Python 解释器自动改成了 <code class="language-text">_Student__name</code>，而外部代码给 bart 新增了一个 <code class="language-text">__name</code> 变量。不信试试：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36560977947739760000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> bart.get_name() # get_name() 内部返回 self.__name\n\'Bart Simpson\'`, `36560977947739760000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> bart<span class="token punctuation">.</span>get_name<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># get_name() 内部返回 self.__name</span>\n<span class="token string">\'Bart Simpson\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h2 id="继承和多态"><a href="#%E7%BB%A7%E6%89%BF%E5%92%8C%E5%A4%9A%E6%80%81" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>继承和多态</h2>\n<p>在 OOP 程序设计中，当我们定义一个 class 的时候，可以从某个现有的 class 继承，新的 class 称为子类（Subclass），而被继承的 class 称为基类、父类或超类（Base class、Super class）。</p>\n<p>比如，我们已经编写了一个名为 Animal 的 class，有一个 run() 方法可以直接打印：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15906310428046710000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Animal(object):\n    def run(self):\n        print(\'Animal is running...\')`, `15906310428046710000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Animal</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Animal is running...\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>当我们需要编写 Dog 和 Cat 类时，就可以直接从 Animal 类继承：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49811574642469480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Dog(Animal):\n    pass\n\nclass Cat(Animal):\n    pass`, `49811574642469480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Dog</span><span class="token punctuation">(</span>Animal<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n<span class="token keyword">class</span> <span class="token class-name">Cat</span><span class="token punctuation">(</span>Animal<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>对于 Dog 来说，Animal 就是它的父类，对于 Animal 来说，Dog 就是它的子类。Cat 和 Dog 类似。</p>\n<p>继承有什么好处？最大的好处是子类获得了父类的全部功能。由于 Animial 实现了 run() 方法，因此，Dog 和 Cat 作为它的子类，什么事也没干，就自动拥有了 run() 方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55135140458434440000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`dog = Dog()\ndog.run()\n\ncat = Cat()\ncat.run()`, `55135140458434440000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">dog <span class="token operator">=</span> Dog<span class="token punctuation">(</span><span class="token punctuation">)</span>\ndog<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\ncat <span class="token operator">=</span> Cat<span class="token punctuation">(</span><span class="token punctuation">)</span>\ncat<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>运行结果如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76662818026509320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Animal is running...\nAnimal is running...`, `76662818026509320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">Animal is running...\nAnimal is running...</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>当然，也可以对子类增加一些方法，比如 Dog 类：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77469522332218540000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Dog(Animal):\n\n    def run(self):\n        print(\'Dog is running...\')\n\n    def eat(self):\n        print(\'Eating meat...\')`, `77469522332218540000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Dog</span><span class="token punctuation">(</span>Animal<span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Dog is running...\'</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">eat</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Eating meat...\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>继承的第二个好处需要我们对代码做一点改进。你看到了，无论是 Dog 还是 Cat，它们 run() 的时候，显示的都是 Animal is running…，符合逻辑的做法是分别显示 Dog is running… 和 Cat is running…，因此，对 Dog 和 Cat 类改进如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34154323723770210000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Dog(Animal):\n\n    def run(self):\n        print(\'Dog is running...\')\n\nclass Cat(Animal):\n\n    def run(self):\n        print(\'Cat is running...\')`, `34154323723770210000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Dog</span><span class="token punctuation">(</span>Animal<span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Dog is running...\'</span><span class="token punctuation">)</span>\n\n<span class="token keyword">class</span> <span class="token class-name">Cat</span><span class="token punctuation">(</span>Animal<span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Cat is running...\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>再次运行，结果如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48508632986247100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Dog is running...\nCat is running...`, `48508632986247100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">Dog is running...\nCat is running...</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>当子类和父类都存在相同的 run() 方法时，我们说，子类的 run() 覆盖了父类的 run()，在代码运行的时候，总是会调用子类的 run()。这样，我们就获得了继承的另一个好处：多态。</p>\n<p>要理解什么是多态，我们首先要对数据类型再作一点说明。当我们定义一个 class 的时候，我们实际上就定义了一种数据类型。我们定义的数据类型和 Python 自带的数据类型，比如 str、list、dict 没什么两样：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15613079058114998000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`a = list() # a 是 list 类型\nb = Animal() # b 是 Animal 类型\nc = Dog() # c 是 Dog 类型`, `15613079058114998000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">a <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># a 是 list 类型</span>\nb <span class="token operator">=</span> Animal<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># b 是 Animal 类型</span>\nc <span class="token operator">=</span> Dog<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># c 是 Dog 类型</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>判断一个变量是否是某个类型可以用 isinstance() 判断：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90920836700824140000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> isinstance(a, list)\nTrue\n>>> isinstance(b, Animal)\nTrue\n>>> isinstance(c, Dog)\nTrue`, `90920836700824140000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span>\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> Animal<span class="token punctuation">)</span>\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> Dog<span class="token punctuation">)</span>\n<span class="token boolean">True</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>看来 a、b、c 确实对应着 list、Animal、Dog 这 3 种类型。</p>\n<p>但是等等，试试：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69783439107065635000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> isinstance(c, Animal)\nTrue`, `69783439107065635000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> Animal<span class="token punctuation">)</span>\n<span class="token boolean">True</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>看来 c 不仅仅是 Dog，c 还是 Animal！</p>\n<p>不过仔细想想，这是有道理的，因为 Dog 是从 Animal 继承下来的，当我们创建了一个 Dog 的实例 c 时，我们认为 c 的数据类型是 Dog 没错，但 c 同时也是 Animal 也没错，Dog 本来就是 Animal 的一种！</p>\n<p>所以，在继承关系中，如果一个实例的数据类型是某个子类，那它的数据类型也可以被看做是父类。但是，反过来就不行：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65956343748776680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> b = Animal()\n>>> isinstance(b, Dog)\nFalse`, `65956343748776680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> b <span class="token operator">=</span> Animal<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> Dog<span class="token punctuation">)</span>\n<span class="token boolean">False</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>Dog 可以看成 Animal，但 Animal 不可以看成 Dog。</p>\n<p>要理解多态的好处，我们还需要再编写一个函数，这个函数接受一个 Animal 类型的变量：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24000731182061187000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def run_twice(animal):\n    animal.run()\n    animal.run()`, `24000731182061187000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">run_twice</span><span class="token punctuation">(</span>animal<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    animal<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    animal<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>当我们传入 Animal 的实例时，run_twice() 就打印出：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28852411916534160000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> run_twice(Animal())\nAnimal is running...\nAnimal is running...`, `28852411916534160000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> run_twice<span class="token punctuation">(</span>Animal<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\nAnimal <span class="token keyword">is</span> running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nAnimal <span class="token keyword">is</span> running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>当我们传入 Dog 的实例时，run_twice() 就打印出：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53644080359206340000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> run_twice(Dog())\nDog is running...\nDog is running...`, `53644080359206340000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> run_twice<span class="token punctuation">(</span>Dog<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\nDog <span class="token keyword">is</span> running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nDog <span class="token keyword">is</span> running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>当我们传入 Cat 的实例时，run_twice() 就打印出：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36877870346189480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> run_twice(Cat())\nCat is running...\nCat is running...`, `36877870346189480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> run_twice<span class="token punctuation">(</span>Cat<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\nCat <span class="token keyword">is</span> running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nCat <span class="token keyword">is</span> running<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>看上去没啥意思，但是仔细想想，现在，如果我们再定义一个 Tortoise 类型，也从 Animal 派生：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56345936486254570000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Tortoise(Animal):\n    def run(self):\n        print(\'Tortoise is running slowly...\')`, `56345936486254570000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Tortoise</span><span class="token punctuation">(</span>Animal<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Tortoise is running slowly...\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>当我们调用 run_twice() 时，传入 Tortoise 的实例：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26575649324808070000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> run_twice(Tortoise())\nTortoise is running slowly...\nTortoise is running slowly...`, `26575649324808070000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> run_twice<span class="token punctuation">(</span>Tortoise<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\nTortoise <span class="token keyword">is</span> running slowly<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nTortoise <span class="token keyword">is</span> running slowly<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>你会发现，新增一个 Animal 的子类，不必对 run_twice() 做任何修改，实际上，任何依赖 Animal 作为参数的函数或者方法都可以不加修改地正常运行，原因就在于多态。</p>\n<p>多态的好处就是，当我们需要传入 Dog、Cat、Tortoise…… 时，我们只需要接收 Animal 类型就可以了，因为 Dog、Cat、Tortoise…… 都是 Animal 类型，然后，按照 Animal 类型进行操作即可。由于 Animal 类型有 run() 方法，因此，传入的任意类型，只要是 Animal 类或者子类，就会自动调用实际类型的 run() 方法，这就是多态的意思：</p>\n<p>对于一个变量，我们只需要知道它是 Animal 类型，无需确切地知道它的子类型，就可以放心地调用 run() 方法，而具体调用的 run() 方法是作用在 Animal、Dog、Cat 还是 Tortoise 对象上，由运行时该对象的确切类型决定，这就是多态真正的威力：调用方只管调用，不管细节，而当我们新增一种 Animal 的子类时，只要确保 run() 方法编写正确，不用管原来的代码是如何调用的。这就是著名的“开闭”原则：</p>\n<ul>\n<li>对扩展开放：允许新增 Animal 子类；</li>\n<li>对修改封闭：不需要修改依赖 Animal 类型的 run_twice() 等函数。</li>\n</ul>\n<p>继承还可以一级一级地继承下来，就好比从爷爷到爸爸、再到儿子这样的关系。而任何类，最终都可以追溯到根类 object，这些继承关系看上去就像一颗倒着的树。</p>\n<h3 id="静态语言-vs-动态语言"><a href="#%E9%9D%99%E6%80%81%E8%AF%AD%E8%A8%80-vs-%E5%8A%A8%E6%80%81%E8%AF%AD%E8%A8%80" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>静态语言 vs 动态语言</h3>\n<p>对于静态语言（例如 Java）来说，如果需要传入 Animal 类型，则传入的对象必须是 Animal 类型或者它的子类，否则，将无法调用 run() 方法。</p>\n<p>对于 Python 这样的动态语言来说，则不一定需要传入 Animal 类型。我们只需要保证传入的对象有一个 run() 方法就可以了：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4188720005391677400"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Timer(object):\n    def run(self):\n        print(\'Start...\')`, `4188720005391677400`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Timer</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Start...\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>这就是动态语言的“鸭子类型”，它并不要求严格的继承体系，一个对象只要“看起来像鸭子，走起路来像鸭子”，那它就可以被看做是鸭子。</p>\n<p>Python 的 <code class="language-text">file-like object</code> 就是一种鸭子类型。对真正的文件对象，它有一个 read() 方法，返回其内容。但是，许多对象，只要有 read() 方法，都被视为“file-like object“。许多函数接收的参数就是 <code class="language-text">file-like object</code>，你不一定要传入真正的文件对象，完全可以传入任何实现了 read() 方法的对象。</p>\n<h3 id="小结-6"><a href="#%E5%B0%8F%E7%BB%93-6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>继承可以把父类的所有功能都直接拿过来，这样就不必重零做起，子类只需要新增自己特有的方法，也可以把父类不适合的方法覆盖重写。</p>\n<p>动态语言的鸭子类型特点决定了继承不像静态语言那样是必须的。</p>\n<h2 id="获取对象信息"><a href="#%E8%8E%B7%E5%8F%96%E5%AF%B9%E8%B1%A1%E4%BF%A1%E6%81%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>获取对象信息</h2>\n<h3 id="使用-type"><a href="#%E4%BD%BF%E7%94%A8-type" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 type()</h3>\n<p>首先，我们来判断对象类型，使用 type() 函数：</p>\n<p>基本类型都可以用 type() 判断：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56351534074593940000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> type(123)\n<class \'int\'>\n>>> type(\'str\')\n<class \'str\'>\n>>> type(None)\n<type(None) \'NoneType\'>`, `56351534074593940000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span>\n<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'int\'</span><span class="token operator">></span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token string">\'str\'</span><span class="token punctuation">)</span>\n<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'str\'</span><span class="token operator">></span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span>\n<span class="token operator">&lt;</span><span class="token builtin">type</span><span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token string">\'NoneType\'</span><span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果一个变量指向函数或者类，也可以用 type() 判断：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97691399040811990000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> type(abs)\n<class \'builtin_function_or_method\'>\n>>> type(a)\n<class \'__main__.Animal\'>`, `97691399040811990000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token builtin">abs</span><span class="token punctuation">)</span>\n<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'builtin_function_or_method\'</span><span class="token operator">></span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>\n<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.Animal\'</span><span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是 type() 函数返回的是什么类型呢？它返回对应的 Class 类型。如果我们要在 if 语句中判断，就需要比较两个变量的 type 类型是否相同：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50719629385483756000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> type(123)==type(456)\nTrue\n>>> type(123)==int\nTrue\n>>> type(\'abc\')==type(\'123\')\nTrue\n>>> type(\'abc\')==str\nTrue\n>>> type(\'abc\')==type(123)\nFalse`, `50719629385483756000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token builtin">type</span><span class="token punctuation">(</span><span class="token number">456</span><span class="token punctuation">)</span>\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token builtin">int</span>\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token string">\'abc\'</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token builtin">type</span><span class="token punctuation">(</span><span class="token string">\'123\'</span><span class="token punctuation">)</span>\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token string">\'abc\'</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token builtin">str</span>\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token string">\'abc\'</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token builtin">type</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span>\n<span class="token boolean">False</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>判断基本数据类型可以直接写 int，str 等，但如果要判断一个对象是否是函数怎么办？可以使用 types 模块中定义的常量：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63228215174591940000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> import types\n>>> def fn():\n...     pass\n...\n>>> type(fn)==types.FunctionType\nTrue\n>>> type(abs)==types.BuiltinFunctionType\nTrue\n>>> type(lambda x: x)==types.LambdaType\nTrue\n>>> type((x for x in range(10)))==types.GeneratorType\nTrue`, `63228215174591940000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> types\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">def</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">pass</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token operator">==</span>types<span class="token punctuation">.</span>FunctionType\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token builtin">abs</span><span class="token punctuation">)</span><span class="token operator">==</span>types<span class="token punctuation">.</span>BuiltinFunctionType\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">)</span><span class="token operator">==</span>types<span class="token punctuation">.</span>LambdaType\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">==</span>types<span class="token punctuation">.</span>GeneratorType\n<span class="token boolean">True</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="使用-isinstance"><a href="#%E4%BD%BF%E7%94%A8-isinstance" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 isinstance()</h3>\n<p>对于 class 的继承关系来说，使用 type() 就很不方便。我们要判断 class 的类型，可以使用 isinstance() 函数。</p>\n<p>我们回顾上次的例子，如果继承关系是：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81540700110713500000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`object -> Animal -> Dog -> Husky`, `81540700110713500000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">object -&gt; Animal -&gt; Dog -&gt; Husky</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>那么，isinstance() 就可以告诉我们，一个对象是否是某种类型。先创建 3 种类型的对象：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="5159245371684929000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> a = Animal()\n>>> d = Dog()\n>>> h = Husky()`, `5159245371684929000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> Animal<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> d <span class="token operator">=</span> Dog<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> h <span class="token operator">=</span> Husky<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>然后，判断：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1109232412290350700"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> isinstance(h, Husky)\nTrue`, `1109232412290350700`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> Husky<span class="token punctuation">)</span>\n<span class="token boolean">True</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>没有问题，因为 h 变量指向的就是 Husky 对象。</p>\n<p>再判断：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20690033389961626000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> isinstance(h, Dog)\nTrue`, `20690033389961626000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> Dog<span class="token punctuation">)</span>\n<span class="token boolean">True</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>h 虽然自身是 Husky 类型，但由于 Husky 是从 Dog 继承下来的，所以，h 也还是 Dog 类型。换句话说，isinstance() 判断的是一个对象是否是该类型本身，或者位于该类型的父继承链上。</p>\n<p>因此，我们可以确信，h 还是 Animal 类型：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76478309220301500000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> isinstance(h, Animal)\nTrue`, `76478309220301500000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> Animal<span class="token punctuation">)</span>\n<span class="token boolean">True</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>同理，实际类型是 Dog 的 d 也是 Animal 类型：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58879851936601480000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> isinstance(d, Dog) and isinstance(d, Animal)\nTrue`, `58879851936601480000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> Dog<span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> Animal<span class="token punctuation">)</span>\n<span class="token boolean">True</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>但是，d 不是 Husky 类型：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54019502441668575000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> isinstance(d, Husky)\nFalse`, `54019502441668575000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> Husky<span class="token punctuation">)</span>\n<span class="token boolean">False</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>能用 type() 判断的基本类型也可以用 isinstance() 判断：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60937674399364596000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> isinstance(\'a\', str)\nTrue\n>>> isinstance(123, int)\nTrue\n>>> isinstance(b\'a\', bytes)\nTrue`, `60937674399364596000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span>\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span>\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token string">b\'a\'</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">)</span>\n<span class="token boolean">True</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>并且还可以判断一个变量是否是某些类型中的一种，比如下面的代码就可以判断是否是 list 或者 tuple：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34461377630760670000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> isinstance([1, 2, 3], (list, tuple))\nTrue\n>>> isinstance((1, 2, 3), (list, tuple))\nTrue`, `34461377630760670000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">,</span> <span class="token builtin">tuple</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">,</span> <span class="token builtin">tuple</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token boolean">True</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>总是优先使用 isinstance() 判断类型，可以将指定类型及其子类“一网打尽”。</p>\n</blockquote>\n<h3 id="使用-dir"><a href="#%E4%BD%BF%E7%94%A8-dir" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 dir()</h3>\n<p>如果要获得一个对象的所有属性和方法，可以使用 dir() 函数，它返回一个包含字符串的 list，比如，获得一个 str 对象的所有属性和方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9030655841959279000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> dir(\'ABC\')\n[\'__add__\', \'__class__\',..., \'__subclasshook__\', \'capitalize\', \'casefold\',..., \'zfill\']`, `9030655841959279000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">dir</span><span class="token punctuation">(</span><span class="token string">\'ABC\'</span><span class="token punctuation">)</span>\n<span class="token punctuation">[</span><span class="token string">\'__add__\'</span><span class="token punctuation">,</span> <span class="token string">\'__class__\'</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token string">\'__subclasshook__\'</span><span class="token punctuation">,</span> <span class="token string">\'capitalize\'</span><span class="token punctuation">,</span> <span class="token string">\'casefold\'</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token string">\'zfill\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>类似 <code class="language-text">__xxx__</code> 的属性和方法在 Python 中都是有特殊用途的，比如 <code class="language-text">__len__</code> 方法返回长度。在 Python 中，如果你调用 len() 函数试图获取一个对象的长度，实际上，在 len() 函数内部，它自动去调用该对象的 <code class="language-text">__len__()</code> 方法，所以，下面的代码是等价的：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50892665922505030000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> len(\'ABC\')\n3\n>>> \'ABC\'.__len__()\n3`, `50892665922505030000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token string">\'ABC\'</span><span class="token punctuation">)</span>\n<span class="token number">3</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token string">\'ABC\'</span><span class="token punctuation">.</span>__len__<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token number">3</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们自己写的类，如果也想用 len(myObj) 的话，就自己写一个 <code class="language-text">__len__()</code> 方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="7603733008191415000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> class MyDog(object):\n...     def __len__(self):\n...         return 100\n...\n>>> dog = MyDog()\n>>> len(dog)\n100`, `7603733008191415000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">class</span> <span class="token class-name">MyDog</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">return</span> <span class="token number">100</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token operator">>></span><span class="token operator">></span> dog <span class="token operator">=</span> MyDog<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">len</span><span class="token punctuation">(</span>dog<span class="token punctuation">)</span>\n<span class="token number">100</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>剩下的都是普通属性或方法，比如 lower() 返回小写的字符串：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="245743177419943680"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> \'ABC\'.lower()\n\'abc\'`, `245743177419943680`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token string">\'ABC\'</span><span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token string">\'abc\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>仅仅把属性和方法列出来是不够的，配合 getattr()、setattr() 以及 hasattr()，我们可以直接操作一个对象的状态：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77720190951160500000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> class MyObject(object):\n...     def __init__(self):\n...         self.x = 9\n...     def power(self):\n...         return self.x * self.x\n...\n>>> obj = MyObject()`, `77720190951160500000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">class</span> <span class="token class-name">MyObject</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         self<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token number">9</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">def</span> <span class="token function">power</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">return</span> self<span class="token punctuation">.</span>x <span class="token operator">*</span> self<span class="token punctuation">.</span>x\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token operator">>></span><span class="token operator">></span> obj <span class="token operator">=</span> MyObject<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>紧接着，可以测试该对象的属性：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52850875503538086000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> hasattr(obj, \'x\') # 有属性 \'x\' 吗？\nTrue\n>>> obj.x\n9\n>>> hasattr(obj, \'y\') # 有属性 \'y\' 吗？\nFalse\n>>> setattr(obj, \'y\', 19) # 设置一个属性 \'y\'\n>>> hasattr(obj, \'y\') # 有属性 \'y\' 吗？\nTrue\n>>> getattr(obj, \'y\') # 获取属性 \'y\'\n19\n>>> obj.y # 获取属性 \'y\'\n19`, `52850875503538086000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">\'x\'</span><span class="token punctuation">)</span> <span class="token comment"># 有属性 \'x\' 吗？</span>\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> obj<span class="token punctuation">.</span>x\n<span class="token number">9</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">\'y\'</span><span class="token punctuation">)</span> <span class="token comment"># 有属性 \'y\' 吗？</span>\n<span class="token boolean">False</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">setattr</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">\'y\'</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">)</span> <span class="token comment"># 设置一个属性 \'y\'</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">\'y\'</span><span class="token punctuation">)</span> <span class="token comment"># 有属性 \'y\' 吗？</span>\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">\'y\'</span><span class="token punctuation">)</span> <span class="token comment"># 获取属性 \'y\'</span>\n<span class="token number">19</span>\n<span class="token operator">>></span><span class="token operator">></span> obj<span class="token punctuation">.</span>y <span class="token comment"># 获取属性 \'y\'</span>\n<span class="token number">19</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果试图获取不存在的属性，会抛出 AttributeError 的错误：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31854157887830100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> getattr(obj, \'z\') # 获取属性 \'z\'\nTraceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\nAttributeError: \'MyObject\' object has no attribute \'z\'`, `31854157887830100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">\'z\'</span><span class="token punctuation">)</span> <span class="token comment"># 获取属性 \'z\'</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\nAttributeError<span class="token punctuation">:</span> <span class="token string">\'MyObject\'</span> <span class="token builtin">object</span> has no attribute <span class="token string">\'z\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以传入一个 default 参数，如果属性不存在，就返回默认值：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="15285260815062008000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> getattr(obj, \'z\', 404) # 获取属性 \'z\'，如果不存在，返回默认值 404\n404`, `15285260815062008000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">\'z\'</span><span class="token punctuation">,</span> <span class="token number">404</span><span class="token punctuation">)</span> <span class="token comment"># 获取属性 \'z\'，如果不存在，返回默认值 404</span>\n<span class="token number">404</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>也可以获得对象的方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63510379917334880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> hasattr(obj, \'power\') # 有属性 \'power\' 吗？\nTrue\n>>> getattr(obj, \'power\') # 获取属性 \'power\'\n<bound method MyObject.power of <__main__.MyObject object at 0x10077a6a0>>\n>>> fn = getattr(obj, \'power\') # 获取属性 \'power\' 并赋值到变量 fn\n>>> fn # fn 指向 obj.power\n<bound method MyObject.power of <__main__.MyObject object at 0x10077a6a0>>\n>>> fn() # 调用 fn() 与调用 obj.power() 是一样的\n81`, `63510379917334880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">\'power\'</span><span class="token punctuation">)</span> <span class="token comment"># 有属性 \'power\' 吗？</span>\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">\'power\'</span><span class="token punctuation">)</span> <span class="token comment"># 获取属性 \'power\'</span>\n<span class="token operator">&lt;</span>bound method MyObject<span class="token punctuation">.</span>power of <span class="token operator">&lt;</span>__main__<span class="token punctuation">.</span>MyObject <span class="token builtin">object</span> at <span class="token number">0x10077a6a0</span><span class="token operator">>></span>\n<span class="token operator">>></span><span class="token operator">></span> fn <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">\'power\'</span><span class="token punctuation">)</span> <span class="token comment"># 获取属性 \'power\' 并赋值到变量 fn</span>\n<span class="token operator">>></span><span class="token operator">></span> fn <span class="token comment"># fn 指向 obj.power</span>\n<span class="token operator">&lt;</span>bound method MyObject<span class="token punctuation">.</span>power of <span class="token operator">&lt;</span>__main__<span class="token punctuation">.</span>MyObject <span class="token builtin">object</span> at <span class="token number">0x10077a6a0</span><span class="token operator">>></span>\n<span class="token operator">>></span><span class="token operator">></span> fn<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 调用 fn() 与调用 obj.power() 是一样的</span>\n<span class="token number">81</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="小结-7"><a href="#%E5%B0%8F%E7%BB%93-7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>通过内置的一系列函数，我们可以对任意一个 Python 对象进行剖析，拿到其内部的数据。要注意的是，只有在不知道对象信息的时候，我们才会去获取对象信息。如果可以直接写：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94210165529004520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`sum = obj.x + obj.y`, `94210165529004520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token builtin">sum</span> <span class="token operator">=</span> obj<span class="token punctuation">.</span>x <span class="token operator">+</span> obj<span class="token punctuation">.</span>y</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>就不要写：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="87422400083807060000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`sum = getattr(obj, \'x\') + getattr(obj, \'y\')`, `87422400083807060000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token builtin">sum</span> <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">\'x\'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">\'y\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>一个正确的用法的例子如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96029412416332450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def readImage(fp):\n    if hasattr(fp, \'read\'):\n        return readData(fp)\n    return None`, `96029412416332450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">readImage</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token string">\'read\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> readData<span class="token punctuation">(</span>fp<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> <span class="token boolean">None</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>假设我们希望从文件流 fp 中读取图像，我们首先要判断该 fp 对象是否存在 read 方法，如果存在，则该对象是一个流，如果不存在，则无法读取。hasattr() 就派上了用场。</p>\n<p>请注意，在 Python 这类动态语言中，根据鸭子类型，有 read() 方法，不代表该 fp 对象就是一个文件流，它也可能是网络流，也可能是内存中的一个字节流，但只要 read() 方法返回的是有效的图像数据，就不影响读取图像的功能。</p>\n<h2 id="实例属性和类属性"><a href="#%E5%AE%9E%E4%BE%8B%E5%B1%9E%E6%80%A7%E5%92%8C%E7%B1%BB%E5%B1%9E%E6%80%A7" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实例属性和类属性</h2>\n<p>由于 Python 是动态语言，根据类创建的实例可以任意绑定属性。</p>\n<p>给实例绑定属性的方法是通过实例变量，或者通过 self 变量：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17278792488590256000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n    def __init__(self, name):\n        self.name = name\n\ns = Student(\'Bob\')\ns.score = 90`, `17278792488590256000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name\n\ns <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">\'Bob\'</span><span class="token punctuation">)</span>\ns<span class="token punctuation">.</span>score <span class="token operator">=</span> <span class="token number">90</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是，如果 Student 类本身需要绑定一个属性呢？可以直接在 class 中定义属性，这种属性是类属性，归 Student 类所有：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="84319253250772750000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n    name = \'Student\'`, `84319253250772750000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    name <span class="token operator">=</span> <span class="token string">\'Student\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>当我们定义了一个类属性后，这个属性虽然归类所有，但类的所有实例都可以访问到。来测试一下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="72329091008138510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> class Student(object):\n...     name = \'Student\'\n...\n>>> s = Student() # 创建实例 s\n>>> print(s.name) # 打印 name 属性，因为实例并没有 name 属性，所以会继续查找 class 的 name 属性\nStudent\n>>> print(Student.name) # 打印类的 name 属性\nStudent\n>>> s.name = \'Michael\' # 给实例绑定 name 属性\n>>> print(s.name) # 由于实例属性优先级比类属性高，因此，它会屏蔽掉类的 name 属性\nMichael\n>>> print(Student.name) # 但是类属性并未消失，用 Student.name 仍然可以访问\nStudent\n>>> del s.name # 如果删除实例的 name 属性\n>>> print(s.name) # 再次调用 s.name，由于实例的 name 属性没有找到，类的 name 属性就显示出来了\nStudent`, `72329091008138510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     name <span class="token operator">=</span> <span class="token string">\'Student\'</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 创建实例 s</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token comment"># 打印 name 属性，因为实例并没有 name 属性，所以会继续查找 class 的 name 属性</span>\nStudent\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>Student<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token comment"># 打印类的 name 属性</span>\nStudent\n<span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">\'Michael\'</span> <span class="token comment"># 给实例绑定 name 属性</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token comment"># 由于实例属性优先级比类属性高，因此，它会屏蔽掉类的 name 属性</span>\nMichael\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>Student<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token comment"># 但是类属性并未消失，用 Student.name 仍然可以访问</span>\nStudent\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">del</span> s<span class="token punctuation">.</span>name <span class="token comment"># 如果删除实例的 name 属性</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token comment"># 再次调用 s.name，由于实例的 name 属性没有找到，类的 name 属性就显示出来了</span>\nStudent</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>从上面的例子可以看出，在编写程序的时候，千万不要对实例属性和类属性使用相同的名字，因为相同名称的实例属性将屏蔽掉类属性，但是当你删除实例属性后，再使用相同的名称，访问到的将是类属性。</p>\n<h3 id="小结-8"><a href="#%E5%B0%8F%E7%BB%93-8" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>实例属性属于各个实例所有，互不干扰；</p>\n<p>类属性属于类所有，所有实例共享一个属性；</p>\n<p>不要对实例属性和类属性使用相同的名字，否则将产生难以发现的错误。</p>\n<h1 id="面向对象高级编程"><a href="#%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>面向对象高级编程</h1>\n<h2 id="使用-__slots__"><a href="#%E4%BD%BF%E7%94%A8-__slots__" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 <code class="language-text">__slots__</code></h2>\n<p>正常情况下，当我们定义了一个 class，创建了一个 class 的实例后，我们可以给该实例绑定任何属性和方法，这就是动态语言的灵活性。先定义 class：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32805634490554690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n    pass`, `32805634490554690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>然后，尝试给实例绑定一个属性：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="99218302762187260000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> s = Student()\n>>> s.name = \'Michael\' # 动态给实例绑定一个属性\n>>> print(s.name)\nMichael`, `99218302762187260000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">\'Michael\'</span> <span class="token comment"># 动态给实例绑定一个属性</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>name<span class="token punctuation">)</span>\nMichael</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>还可以尝试给实例绑定一个方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20106201999641240000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> def set_age(self, age): # 定义一个函数作为实例方法\n...     self.age = age\n...\n>>> from types import MethodType\n>>> s.set_age = MethodType(set_age, s) # 给实例绑定一个方法, 第二个参数作为 self 传入方法\n>>> s.set_age(25) # 调用实例方法\n>>> s.age # 测试结果\n25`, `20106201999641240000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">def</span> <span class="token function">set_age</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># 定义一个函数作为实例方法</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     self<span class="token punctuation">.</span>age <span class="token operator">=</span> age\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> types <span class="token keyword">import</span> MethodType\n<span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>set_age <span class="token operator">=</span> MethodType<span class="token punctuation">(</span>set_age<span class="token punctuation">,</span> s<span class="token punctuation">)</span> <span class="token comment"># 给实例绑定一个方法, 第二个参数作为 self 传入方法</span>\n<span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>set_age<span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span> <span class="token comment"># 调用实例方法</span>\n<span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>age <span class="token comment"># 测试结果</span>\n<span class="token number">25</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是，给一个实例绑定的方法，对另一个实例是不起作用的：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26280891046079226000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> s2 = Student() # 创建新的实例\n>>> s2.set_age(25) # 尝试调用方法\nTraceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\nAttributeError: \'Student\' object has no attribute \'set_age\'`, `26280891046079226000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> s2 <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 创建新的实例</span>\n<span class="token operator">>></span><span class="token operator">></span> s2<span class="token punctuation">.</span>set_age<span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span> <span class="token comment"># 尝试调用方法</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\nAttributeError<span class="token punctuation">:</span> <span class="token string">\'Student\'</span> <span class="token builtin">object</span> has no attribute <span class="token string">\'set_age\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>为了给所有实例都绑定方法，可以给 class 绑定方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81168791698154320000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> def set_score(self, score):\n...     self.score = score\n...\n>>> Student.set_score = set_score`, `81168791698154320000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">def</span> <span class="token function">set_score</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> score<span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     self<span class="token punctuation">.</span>score <span class="token operator">=</span> score\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token operator">>></span><span class="token operator">></span> Student<span class="token punctuation">.</span>set_score <span class="token operator">=</span> set_score</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>给 class 绑定方法后，所有实例均可调用：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85225824207102070000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> s.set_score(100)\n>>> s.score\n100\n>>> s2.set_score(99)\n>>> s2.score\n99`, `85225824207102070000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>set_score<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>score\n<span class="token number">100</span>\n<span class="token operator">>></span><span class="token operator">></span> s2<span class="token punctuation">.</span>set_score<span class="token punctuation">(</span><span class="token number">99</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> s2<span class="token punctuation">.</span>score\n<span class="token number">99</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>通常情况下，上面的 set_score 方法可以直接定义在 class 中，但动态绑定允许我们在程序运行的过程中动态给 class 加上功能，这在静态语言中很难实现。</p>\n<h3 id="使用-__slots__-1"><a href="#%E4%BD%BF%E7%94%A8-__slots__-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 <code class="language-text">__slots__</code></h3>\n<p>但是，如果我们想要限制实例的属性怎么办？比如，只允许对 Student 实例添加 name 和 age 属性。</p>\n<p>为了达到限制的目的，Python 允许在定义 class 的时候，定义一个特殊的 <code class="language-text">__slots__</code> 变量，来限制该 class 实例能添加的属性：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50487416679003510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n    __slots__ = (\'name\', \'age\') # 用 tuple 定义允许绑定的属性名称`, `50487416679003510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    __slots__ <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">\'name\'</span><span class="token punctuation">,</span> <span class="token string">\'age\'</span><span class="token punctuation">)</span> <span class="token comment"># 用 tuple 定义允许绑定的属性名称</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>然后，我们试试：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90945753597748300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> s = Student() # 创建新的实例\n>>> s.name = \'Michael\' # 绑定属性 \'name\'\n>>> s.age = 25 # 绑定属性 \'age\'\n>>> s.score = 99 # 绑定属性 \'score\'\nTraceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\nAttributeError: \'Student\' object has no attribute \'score\'`, `90945753597748300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 创建新的实例</span>\n<span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">\'Michael\'</span> <span class="token comment"># 绑定属性 \'name\'</span>\n<span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">25</span> <span class="token comment"># 绑定属性 \'age\'</span>\n<span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>score <span class="token operator">=</span> <span class="token number">99</span> <span class="token comment"># 绑定属性 \'score\'</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\nAttributeError<span class="token punctuation">:</span> <span class="token string">\'Student\'</span> <span class="token builtin">object</span> has no attribute <span class="token string">\'score\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>由于 score 没有被放到 <code class="language-text">__slots__</code> 中，所以不能绑定 score 属性，试图绑定 score 将得到 AttributeError 的错误。</p>\n<p>使用 <code class="language-text">__slots__</code> 要注意，<code class="language-text">__slots__</code> 定义的属性仅对当前类实例起作用，对继承的子类是不起作用的：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94220274911288210000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> class GraduateStudent(Student):\n...     pass\n...\n>>> g = GraduateStudent()\n>>> g.score = 9999`, `94220274911288210000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">class</span> <span class="token class-name">GraduateStudent</span><span class="token punctuation">(</span>Student<span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">pass</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token operator">>></span><span class="token operator">></span> g <span class="token operator">=</span> GraduateStudent<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> g<span class="token punctuation">.</span>score <span class="token operator">=</span> <span class="token number">9999</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>除非在子类中也定义 <code class="language-text">__slots__</code>，这样，子类实例允许定义的属性就是自身的 <code class="language-text">__slots__</code> 加上父类的 <code class="language-text">__slots__</code>。</p>\n<h2 id="使用-property"><a href="#%E4%BD%BF%E7%94%A8-property" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用 @property</h2>\n<p>在绑定属性时，如果我们直接把属性暴露出去，虽然写起来很简单，但是，没办法检查参数，导致可以把成绩随便改：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="54846495362691150000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`s = Student()\ns.score = 9999`, `54846495362691150000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">s <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token punctuation">)</span>\ns<span class="token punctuation">.</span>score <span class="token operator">=</span> <span class="token number">9999</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>这显然不合逻辑。为了限制 score 的范围，可以通过一个 <code class="language-text">set_score()</code> 方法来设置成绩，再通过一个 <code class="language-text">get_score()</code> 来获取成绩，这样，在 set_score() 方法里，就可以检查参数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4895753536695979000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n\n    def get_score(self):\n         return self._score\n\n    def set_score(self, value):\n        if not isinstance(value, int):\n            raise ValueError(\'score must be an integer!\')\n        if value < 0 or value > 100:\n            raise ValueError(\'score must between 0 ~ 100!\')\n        self._score = value`, `4895753536695979000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    <span class="token keyword">def</span> <span class="token function">get_score</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n         <span class="token keyword">return</span> self<span class="token punctuation">.</span>_score\n\n    <span class="token keyword">def</span> <span class="token function">set_score</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'score must be an integer!\'</span><span class="token punctuation">)</span>\n        <span class="token keyword">if</span> value <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token keyword">or</span> value <span class="token operator">></span> <span class="token number">100</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'score must between 0 ~ 100!\'</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>_score <span class="token operator">=</span> value</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在，对任意的 Student 实例进行操作，就不能随心所欲地设置 score 了：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6115250953341866000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> s = Student()\n>>> s.set_score(60) # ok!\n>>> s.get_score()\n60\n>>> s.set_score(9999)\nTraceback (most recent call last):\n  ...\nValueError: score must between 0 ~ 100!`, `6115250953341866000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>set_score<span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span> <span class="token comment"># ok!</span>\n<span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>get_score<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token number">60</span>\n<span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>set_score<span class="token punctuation">(</span><span class="token number">9999</span><span class="token punctuation">)</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nValueError<span class="token punctuation">:</span> score must between <span class="token number">0</span> <span class="token operator">~</span> <span class="token number">100</span>!</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是，上面的调用方法又略显复杂，没有直接用属性这么直接简单。</p>\n<p>有没有既能检查参数，又可以用类似属性这样简单的方式来访问类的变量呢？对于追求完美的 Python 程序员来说，这是必须要做到的！</p>\n<p>还记得装饰器（decorator）可以给函数动态加上功能吗？对于类的方法，装饰器一样起作用。Python 内置的 @property 装饰器就是负责把一个方法变成属性调用的：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70005788493029384000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n\n    @property\n    def score(self):\n        return self._score\n\n    @score.setter\n    def score(self, value):\n        if not isinstance(value, int):\n            raise ValueError(\'score must be an integer!\')\n        if value < 0 or value > 100:\n            raise ValueError(\'score must between 0 ~ 100!\')\n        self._score = value`, `70005788493029384000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    @<span class="token builtin">property</span>\n    <span class="token keyword">def</span> <span class="token function">score</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_score\n\n    @score<span class="token punctuation">.</span>setter\n    <span class="token keyword">def</span> <span class="token function">score</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'score must be an integer!\'</span><span class="token punctuation">)</span>\n        <span class="token keyword">if</span> value <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token keyword">or</span> value <span class="token operator">></span> <span class="token number">100</span><span class="token punctuation">:</span>\n            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'score must between 0 ~ 100!\'</span><span class="token punctuation">)</span>\n        self<span class="token punctuation">.</span>_score <span class="token operator">=</span> value</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>@property 的实现比较复杂，我们先考察如何使用。把一个 getter 方法变成属性，只需要加上 @property 就可以了，此时，@property 本身又创建了另一个装饰器 @score.setter，负责把一个 setter 方法变成属性赋值，于是，我们就拥有一个可控的属性操作：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="97944500733676490000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> s = Student()\n>>> s.score = 60 # OK，实际转化为 s.set_score(60)\n>>> s.score # OK，实际转化为 s.get_score()\n60\n>>> s.score = 9999\nTraceback (most recent call last):\n  ...\nValueError: score must between 0 ~ 100!`, `97944500733676490000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>score <span class="token operator">=</span> <span class="token number">60</span> <span class="token comment"># OK，实际转化为 s.set_score(60)</span>\n<span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>score <span class="token comment"># OK，实际转化为 s.get_score()</span>\n<span class="token number">60</span>\n<span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>score <span class="token operator">=</span> <span class="token number">9999</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nValueError<span class="token punctuation">:</span> score must between <span class="token number">0</span> <span class="token operator">~</span> <span class="token number">100</span>!</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意到这个神奇的 @property，我们在对实例属性操作的时候，就知道该属性很可能不是直接暴露的，而是通过 getter 和 setter 方法来实现的。</p>\n<p>还可以定义只读属性，只定义 getter 方法，不定义 setter 方法就是一个只读属性：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3072586622626905000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n\n    @property\n    def birth(self):\n        return self._birth\n\n    @birth.setter\n    def birth(self, value):\n        self._birth = value\n\n    @property\n    def age(self):\n        return 2015 - self._birth`, `3072586622626905000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    @<span class="token builtin">property</span>\n    <span class="token keyword">def</span> <span class="token function">birth</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_birth\n\n    @birth<span class="token punctuation">.</span>setter\n    <span class="token keyword">def</span> <span class="token function">birth</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_birth <span class="token operator">=</span> value\n\n    @<span class="token builtin">property</span>\n    <span class="token keyword">def</span> <span class="token function">age</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token number">2015</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>_birth</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面的 birth 是可读写属性，而 age 就是一个只读属性，因为 age 可以根据 birth 和当前时间计算出来。</p>\n<p>要特别注意：属性的方法名不要和实例变量重名。例如，以下的代码是错误的：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38875920568839930000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n\n    # 方法名称和实例变量均为 birth:\n    @property\n    def birth(self):\n        return self.birth`, `38875920568839930000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    <span class="token comment"># 方法名称和实例变量均为 birth:</span>\n    <span class="token decorator annotation punctuation">@property</span>\n    <span class="token keyword">def</span> <span class="token function">birth</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>birth</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这是因为调用 s.birth 时，首先转换为方法调用，在执行 return self.birth 时，又视为访问 self 的属性，于是又转换为方法调用，造成无限递归，最终导致栈溢出报错 RecursionError。</p>\n<h3 id="小结-9"><a href="#%E5%B0%8F%E7%BB%93-9" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>@property 广泛应用在类的定义中，可以让调用者写出简短的代码，同时保证对参数进行必要的检查，这样，程序运行时就减少了出错的可能性。</p>\n<h2 id="多重继承"><a href="#%E5%A4%9A%E9%87%8D%E7%BB%A7%E6%89%BF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>多重继承</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55946812554535354000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Animal(object):\n    pass\n\n# 大类:\nclass Mammal(Animal):\n    pass\n\nclass Bird(Animal):\n    pass\n\n# 各种动物:\nclass Dog(Mammal):\n    pass\n\nclass Bat(Mammal):\n    pass\n\nclass Parrot(Bird):\n    pass\n\nclass Ostrich(Bird):\n    pass`, `55946812554535354000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Animal</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n<span class="token comment"># 大类:</span>\n<span class="token keyword">class</span> <span class="token class-name">Mammal</span><span class="token punctuation">(</span>Animal<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n<span class="token keyword">class</span> <span class="token class-name">Bird</span><span class="token punctuation">(</span>Animal<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n<span class="token comment"># 各种动物:</span>\n<span class="token keyword">class</span> <span class="token class-name">Dog</span><span class="token punctuation">(</span>Mammal<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n<span class="token keyword">class</span> <span class="token class-name">Bat</span><span class="token punctuation">(</span>Mammal<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n<span class="token keyword">class</span> <span class="token class-name">Parrot</span><span class="token punctuation">(</span>Bird<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n<span class="token keyword">class</span> <span class="token class-name">Ostrich</span><span class="token punctuation">(</span>Bird<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在，我们要给动物再加上 Runnable 和 Flyable 的功能，只需要先定义好 Runnable 和 Flyable 的类：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37983348186920900000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Runnable(object):\n    def run(self):\n        print(\'Running...\')\n\nclass Flyable(object):\n    def fly(self):\n        print(\'Flying...\')`, `37983348186920900000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Running...\'</span><span class="token punctuation">)</span>\n\n<span class="token keyword">class</span> <span class="token class-name">Flyable</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">fly</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Flying...\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>对于需要 Runnable 功能的动物，就多继承一个 Runnable，例如 Dog：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88570817563335360000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Dog(Mammal, Runnable):\n    pass`, `88570817563335360000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Dog</span><span class="token punctuation">(</span>Mammal<span class="token punctuation">,</span> Runnable<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>对于需要 Flyable 功能的动物，就多继承一个 Flyable，例如 Bat：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70807228073706960000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Bat(Mammal, Flyable):\n    pass`, `70807228073706960000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Bat</span><span class="token punctuation">(</span>Mammal<span class="token punctuation">,</span> Flyable<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>通过多重继承，一个子类就可以同时获得多个父类的所有功能。</p>\n<h3 id="mixin"><a href="#mixin" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>MixIn</h3>\n<p>在设计类的继承关系时，通常，主线都是单一继承下来的，例如，Ostrich 继承自 Bird。但是，如果需要“混入”额外的功能，通过多重继承就可以实现，比如，让 Ostrich 除了继承自 Bird 外，再同时继承 Runnable。这种设计通常称之为 MixIn。</p>\n<p>为了更好地看出继承关系，我们把 Runnable 和 Flyable 改为 RunnableMixIn 和 FlyableMixIn。类似的，你还可以定义出肉食动物 CarnivorousMixIn 和植食动物 HerbivoresMixIn，让某个动物同时拥有好几个 MixIn：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69230188417400226000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Dog(Mammal, RunnableMixIn, CarnivorousMixIn):\n    pass`, `69230188417400226000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Dog</span><span class="token punctuation">(</span>Mammal<span class="token punctuation">,</span> RunnableMixIn<span class="token punctuation">,</span> CarnivorousMixIn<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>MixIn 的目的就是给一个类增加多个功能，这样，在设计类的时候，我们优先考虑通过多重继承来组合多个 MixIn 的功能，而不是设计多层次的复杂的继承关系。</p>\n<p>Python 自带的很多库也使用了 MixIn。举个例子，Python 自带了 TCPServer 和 UDPServer 这两类网络服务，而要同时服务多个用户就必须使用多进程或多线程模型，这两种模型由 ForkingMixIn 和 ThreadingMixIn 提供。通过组合，我们就可以创造出合适的服务来。</p>\n<p>比如，编写一个多进程模式的 TCP 服务，定义如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75857958516600030000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyTCPServer(TCPServer, ForkingMixIn):\n    pass`, `75857958516600030000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyTCPServer</span><span class="token punctuation">(</span>TCPServer<span class="token punctuation">,</span> ForkingMixIn<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>编写一个多线程模式的 UDP 服务，定义如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1264966571306458400"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyUDPServer(UDPServer, ThreadingMixIn):\n    pass`, `1264966571306458400`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyUDPServer</span><span class="token punctuation">(</span>UDPServer<span class="token punctuation">,</span> ThreadingMixIn<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>如果你打算搞一个更先进的协程模型，可以编写一个 CoroutineMixIn：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3522423167420974000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyTCPServer(TCPServer, CoroutineMixIn):\n    pass`, `3522423167420974000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyTCPServer</span><span class="token punctuation">(</span>TCPServer<span class="token punctuation">,</span> CoroutineMixIn<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>这样一来，我们不需要复杂而庞大的继承链，只要选择组合不同的类的功能，就可以快速构造出所需的子类。</p>\n<h3 id="小结-10"><a href="#%E5%B0%8F%E7%BB%93-10" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>由于 Python 允许使用多重继承，因此，MixIn 就是一种常见的设计。</p>\n<p>只允许单一继承的语言（如 Java）不能使用 MixIn 的设计。</p>\n<h2 id="定制类"><a href="#%E5%AE%9A%E5%88%B6%E7%B1%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>定制类</h2>\n<p>看到类似 <code class="language-text">__slots__</code> 这种形如 <code class="language-text">__xxx__</code> 的变量或者函数名就要注意，这些在 Python 中是有特殊用途的。</p>\n<p><code class="language-text">__slots__</code> 我们已经知道怎么用了，<code class="language-text">__len__()</code> 方法我们也知道是为了能让 class 作用于 len() 函数。</p>\n<p>除此之外，Python 的 class 中还有许多这样有特殊用途的函数，可以帮助我们定制类。</p>\n<h3 id="__str__"><a href="#__str__" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code class="language-text">__str__</code></h3>\n<p>我们先定义一个 Student 类，打印一个实例：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19493405192000356000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> class Student(object):\n...     def __init__(self, name):\n...         self.name = name\n...\n>>> print(Student(\'Michael\'))\n<__main__.Student object at 0x109afb190>`, `19493405192000356000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         self<span class="token punctuation">.</span>name <span class="token operator">=</span> name\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>Student<span class="token punctuation">(</span><span class="token string">\'Michael\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token operator">&lt;</span>__main__<span class="token punctuation">.</span>Student <span class="token builtin">object</span> at <span class="token number">0x109afb190</span><span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>打印出一堆 <code class="language-text">&lt;__main__.Student object at 0x109afb190&gt;</code>，不好看。</p>\n<p>怎么才能打印得好看呢？只需要定义好 <code class="language-text">__str__()</code> 方法，返回一个好看的字符串就可以了：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74528351037786080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> class Student(object):\n...     def __init__(self, name):\n...         self.name = name\n...     def __str__(self):\n...         return \'Student object (name: %s)\' % self.name\n...\n>>> print(Student(\'Michael\'))\nStudent object (name: Michael)`, `74528351037786080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         self<span class="token punctuation">.</span>name <span class="token operator">=</span> name\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">return</span> <span class="token string">\'Student object (name: %s)\'</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>name\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>Student<span class="token punctuation">(</span><span class="token string">\'Michael\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\nStudent <span class="token builtin">object</span> <span class="token punctuation">(</span>name<span class="token punctuation">:</span> Michael<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样打印出来的实例，不但好看，而且容易看出实例内部重要的数据。</p>\n<p>但是细心的朋友会发现直接敲变量不用 print，打印出来的实例还是不好看：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98036087274151870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> s = Student(\'Michael\')\n>>> s\n<__main__.Student object at 0x109afb310>`, `98036087274151870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">\'Michael\'</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> s\n<span class="token operator">&lt;</span>__main__<span class="token punctuation">.</span>Student <span class="token builtin">object</span> at <span class="token number">0x109afb310</span><span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>这是因为直接显示变量调用的不是 <code class="language-text">__str__()</code>，而是 <code class="language-text">__repr__()</code>，两者的区别是 <code class="language-text">__str__()</code> 返回用户看到的字符串，而 <code class="language-text">__repr__()</code> 返回程序开发者看到的字符串，也就是说，<code class="language-text">__repr__()</code> 是为调试服务的。</p>\n<p>解决办法是再定义一个 <code class="language-text">__repr__()</code>。但是通常 <code class="language-text">__str__()</code> 和 <code class="language-text">__repr__()</code> 代码都是一样的，所以，有个偷懒的写法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69586318350399275000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n    def __init__(self, name):\n        self.name = name\n    def __str__(self):\n        return \'Student object (name=%s)\' % self.name\n    __repr__ = __str__`, `69586318350399275000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name\n    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token string">\'Student object (name=%s)\'</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>name\n    __repr__ <span class="token operator">=</span> __str__</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="__iter__"><a href="#__iter__" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code class="language-text">__iter__</code></h3>\n<p>如果一个类想被用于 for … in 循环，类似 list 或 tuple 那样，就必须实现一个 <code class="language-text">__iter__()</code> 方法，该方法返回一个迭代对象，然后，Python 的 for 循环就会不断调用该迭代对象的 <code class="language-text">__next__()</code> 方法拿到循环的下一个值，直到遇到 StopIteration 错误时退出循环。</p>\n<p>我们以斐波那契数列为例，写一个 Fib 类，可以作用于 for 循环：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88759292193097660000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Fib(object):\n    def __init__(self):\n        self.a, self.b = 0, 1 # 初始化两个计数器 a，b\n\n    def __iter__(self):\n        return self # 实例本身就是迭代对象，故返回自己\n\n    def __next__(self):\n        self.a, self.b = self.b, self.a + self.b # 计算下一个值\n        if self.a > 100000: # 退出循环的条件\n            raise StopIteration()\n        return self.a # 返回下一个值`, `88759292193097660000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Fib</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>a<span class="token punctuation">,</span> self<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token comment"># 初始化两个计数器 a，b</span>\n\n    <span class="token keyword">def</span> <span class="token function">__iter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self <span class="token comment"># 实例本身就是迭代对象，故返回自己</span>\n\n    <span class="token keyword">def</span> <span class="token function">__next__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>a<span class="token punctuation">,</span> self<span class="token punctuation">.</span>b <span class="token operator">=</span> self<span class="token punctuation">.</span>b<span class="token punctuation">,</span> self<span class="token punctuation">.</span>a <span class="token operator">+</span> self<span class="token punctuation">.</span>b <span class="token comment"># 计算下一个值</span>\n        <span class="token keyword">if</span> self<span class="token punctuation">.</span>a <span class="token operator">></span> <span class="token number">100000</span><span class="token punctuation">:</span> <span class="token comment"># 退出循环的条件</span>\n            <span class="token keyword">raise</span> StopIteration<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>a <span class="token comment"># 返回下一个值</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在，试试把 Fib 实例作用于 for 循环：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="4395480968889109500"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> for n in Fib():\n...     print(n)\n...\n1\n1\n2\n3\n5\n...\n46368\n75025`, `4395480968889109500`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">for</span> n <span class="token keyword">in</span> Fib<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token number">1</span>\n<span class="token number">1</span>\n<span class="token number">2</span>\n<span class="token number">3</span>\n<span class="token number">5</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token number">46368</span>\n<span class="token number">75025</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="__getitem__"><a href="#__getitem__" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code class="language-text">__getitem__</code></h3>\n<p>Fib 实例虽然能作用于 for 循环，看起来和 list 有点像，但是，把它当成 list 来使用还是不行，比如，取第 5 个元素：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21981572398509110000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> Fib()[5]\nTraceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\nTypeError: \'Fib\' object does not support indexing`, `21981572398509110000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> Fib<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\nTypeError<span class="token punctuation">:</span> <span class="token string">\'Fib\'</span> <span class="token builtin">object</span> does <span class="token keyword">not</span> support indexing</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>要表现得像 list 那样按照下标取出元素，需要实现 <code class="language-text">__getitem__()</code> 方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77593643431615250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Fib(object):\n    def __getitem__(self, n):\n        a, b = 1, 1\n        for x in range(n):\n            a, b = b, a + b\n        return a`, `77593643431615250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Fib</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        a<span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span>\n        <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            a<span class="token punctuation">,</span> b <span class="token operator">=</span> b<span class="token punctuation">,</span> a <span class="token operator">+</span> b\n        <span class="token keyword">return</span> a</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在，就可以按下标访问数列的任意一项了：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="58338988183273770000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> f = Fib()\n>>> f[0]\n1\n>>> f[1]\n1\n>>> f[2]\n2\n>>> f[3]\n3\n>>> f[10]\n89\n>>> f[100]\n573147844013817084101`, `58338988183273770000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> f <span class="token operator">=</span> Fib<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>\n<span class="token number">1</span>\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>\n<span class="token number">1</span>\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>\n<span class="token number">2</span>\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>\n<span class="token number">3</span>\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span>\n<span class="token number">89</span>\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span>\n<span class="token number">573147844013817084101</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是 list 有个神奇的切片方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25214116906864968000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> list(range(100))[5:10]\n[5, 6, 7, 8, 9]`, `25214116906864968000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>对于 Fib 却报错。原因是 <code class="language-text">__getitem__()</code> 传入的参数可能是一个 int，也可能是一个切片对象 slice，所以要做判断：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="55699283707808640000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Fib(object):\n    def __getitem__(self, n):\n        if isinstance(n, int): # n 是索引\n            a, b = 1, 1\n            for x in range(n):\n                a, b = b, a + b\n            return a\n        if isinstance(n, slice): # n 是切片\n            start = n.start\n            stop = n.stop\n            if start is None:\n                start = 0\n            a, b = 1, 1\n            L = []\n            for x in range(stop):\n                if x >= start:\n                    L.append(a)\n                a, b = b, a + b\n            return L`, `55699283707808640000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Fib</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># n 是索引</span>\n            a<span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span>\n            <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>\n                a<span class="token punctuation">,</span> b <span class="token operator">=</span> b<span class="token punctuation">,</span> a <span class="token operator">+</span> b\n            <span class="token keyword">return</span> a\n        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token builtin">slice</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># n 是切片</span>\n            start <span class="token operator">=</span> n<span class="token punctuation">.</span>start\n            stop <span class="token operator">=</span> n<span class="token punctuation">.</span>stop\n            <span class="token keyword">if</span> start <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>\n                start <span class="token operator">=</span> <span class="token number">0</span>\n            a<span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span>\n            L <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n            <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>stop<span class="token punctuation">)</span><span class="token punctuation">:</span>\n                <span class="token keyword">if</span> x <span class="token operator">>=</span> start<span class="token punctuation">:</span>\n                    L<span class="token punctuation">.</span>append<span class="token punctuation">(</span>a<span class="token punctuation">)</span>\n                a<span class="token punctuation">,</span> b <span class="token operator">=</span> b<span class="token punctuation">,</span> a <span class="token operator">+</span> b\n            <span class="token keyword">return</span> L</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>现在试试 Fib 的切片：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73558705242230190000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> f = Fib()\n>>> f[0:5]\n[1, 1, 2, 3, 5]\n>>> f[:10]\n[1, 1, 2, 3, 5, 8, 13, 21, 34, 55]`, `73558705242230190000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> f <span class="token operator">=</span> Fib<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span>\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token number">34</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是没有对 step 参数作处理：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="49767890056401610000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> f[:10:2]\n[1, 1, 2, 3, 5, 8, 13, 21, 34, 55, 89]`, `49767890056401610000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token number">34</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">,</span> <span class="token number">89</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>也没有对负数作处理，所以，要正确实现一个 <code class="language-text">__getitem__()</code> 还是有很多工作要做的。</p>\n<p>此外，如果把对象看成 dict，<code class="language-text">__getitem__()</code> 的参数也可能是一个可以作 key 的 object，例如 str。</p>\n<p>与之对应的是 <code class="language-text">__setitem__()</code> 方法，把对象视作 list 或 dict 来对集合赋值。最后，还有一个 <code class="language-text">__delitem__()</code> 方法，用于删除某个元素。</p>\n<p>总之，通过上面的方法，我们自己定义的类表现得和 Python 自带的 list、tuple、dict 没什么区别，这完全归功于动态语言的“鸭子类型”，不需要强制继承某个接口。</p>\n<h3 id="__getattr__"><a href="#__getattr__" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code class="language-text">__getattr__</code></h3>\n<p>正常情况下，当我们调用类的方法或属性时，如果不存在，就会报错。比如定义 Student 类：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29039412496763363000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n\n    def __init__(self):\n        self.name = \'Michael\'`, `29039412496763363000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">\'Michael\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>调用 name 属性，没问题，但是，调用不存在的 score 属性，就有问题了：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56763102324216890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> s = Student()\n>>> print(s.name)\nMichael\n>>> print(s.score)\nTraceback (most recent call last):\n  ...\nAttributeError: \'Student\' object has no attribute \'score\'`, `56763102324216890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>name<span class="token punctuation">)</span>\nMichael\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>score<span class="token punctuation">)</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nAttributeError<span class="token punctuation">:</span> <span class="token string">\'Student\'</span> <span class="token builtin">object</span> has no attribute <span class="token string">\'score\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>错误信息很清楚地告诉我们，没有找到 score 这个 attribute。</p>\n<p>要避免这个错误，除了可以加上一个 score 属性外，Python 还有另一个机制，那就是写一个 <code class="language-text">__getattr__()</code> 方法，动态返回一个属性。修改如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="60841718601671520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n\n    def __init__(self):\n        self.name = \'Michael\'\n\n    def __getattr__(self, attr):\n        if attr==\'score\':\n            return 99`, `60841718601671520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">\'Michael\'</span>\n\n    <span class="token keyword">def</span> <span class="token function">__getattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> attr<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> attr<span class="token operator">==</span><span class="token string">\'score\'</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token number">99</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当调用不存在的属性时，比如 score，Python 解释器会试图调用 <code class="language-text">__getattr__(self, &#39;score&#39;)</code> 来尝试获得属性，这样，我们就有机会返回 score 的值：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91086731889509170000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n\n    def __init__(self):\n        self.name = \'Michael\'\n\n    def __getattr__(self, attr):\n        if attr==\'score\':\n            return 99`, `91086731889509170000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">\'Michael\'</span>\n\n    <span class="token keyword">def</span> <span class="token function">__getattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> attr<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> attr<span class="token operator">==</span><span class="token string">\'score\'</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token number">99</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当调用不存在的属性时，比如 score，Python 解释器会试图调用 <code class="language-text">__getattr__(self, &#39;score&#39;)</code> 来尝试获得属性，这样，我们就有机会返回 score 的值：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="2786758940140732400"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> s = Student()\n>>> s.name\n\'Michael\'\n>>> s.score\n99`, `2786758940140732400`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>name\n<span class="token string">\'Michael\'</span>\n<span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>score\n<span class="token number">99</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>返回函数也是完全可以的：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65658778740638260000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n\n    def __getattr__(self, attr):\n        if attr==\'age\':\n            return lambda: 25`, `65658778740638260000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    <span class="token keyword">def</span> <span class="token function">__getattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> attr<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> attr<span class="token operator">==</span><span class="token string">\'age\'</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> <span class="token number">25</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>只是调用方式要变为：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46587965835076180000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> s.age()\n25`, `46587965835076180000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>age<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token number">25</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>注意，只有在没有找到属性的情况下，才调用 <code class="language-text">__getattr__</code>，已有的属性，比如 name，不会在 <code class="language-text">__getattr__</code> 中查找。</p>\n<p>此外，注意到任意调用如 s.abc 都会返回 None，这是因为我们定义的 <code class="language-text">__getattr__</code> 默认返回就是 None。要让 class 只响应特定的几个属性，我们就要按照约定，抛出 AttributeError 的错误：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61657788141717740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n\n    def __getattr__(self, attr):\n        if attr==\'age\':\n            return lambda: 25\n        raise AttributeError(\'\\\'Student\\\' object has no attribute \\\'%s\\\'\' % attr)`, `61657788141717740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    <span class="token keyword">def</span> <span class="token function">__getattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> attr<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> attr<span class="token operator">==</span><span class="token string">\'age\'</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> <span class="token number">25</span>\n        <span class="token keyword">raise</span> AttributeError<span class="token punctuation">(</span><span class="token string">\'\\\'Student\\\' object has no attribute \\\'%s\\\'\'</span> <span class="token operator">%</span> attr<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这实际上可以把一个类的所有属性和方法调用全部动态化处理了，不需要任何特殊手段。</p>\n<p>这种完全动态调用的特性有什么实际作用呢？作用就是，可以针对完全动态的情况作调用。</p>\n<p>举个例子：</p>\n<p>现在很多网站都搞 REST API，比如新浪微博、豆瓣啥的，调用 API 的 URL 类似：</p>\n<ul>\n<li><code class="language-text">http://api.server/user/friends</code></li>\n<li><code class="language-text">http://api.server/user/timeline/list</code></li>\n</ul>\n<p>如果要写 SDK，给每个 URL 对应的 API 都写一个方法，那得累死，而且，API 一旦改动，SDK 也要改。</p>\n<p>利用完全动态的 <code class="language-text">__getattr__</code>，我们可以写出一个链式调用：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1038287557912265200"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Chain(object):\n\n    def __init__(self, path=\'\'):\n        self._path = path\n\n    def __getattr__(self, path):\n        return Chain(\'%s/%s\' % (self._path, path))\n\n    def __str__(self):\n        return self._path\n\n    __repr__ = __str__`, `1038287557912265200`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Chain</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token operator">=</span><span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>_path <span class="token operator">=</span> path\n\n    <span class="token keyword">def</span> <span class="token function">__getattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> Chain<span class="token punctuation">(</span><span class="token string">\'%s/%s\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>_path<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_path\n\n    __repr__ <span class="token operator">=</span> __str__</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>试试：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35722971221156663000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> Chain().status.user.timeline.list\n\'/status/user/timeline/list\'`, `35722971221156663000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> Chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>status<span class="token punctuation">.</span>user<span class="token punctuation">.</span>timeline<span class="token punctuation">.</span><span class="token builtin">list</span>\n<span class="token string">\'/status/user/timeline/list\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>这样，无论 API 怎么变，SDK 都可以根据 URL 实现完全动态的调用，而且，不随 API 的增加而改变！</p>\n<p>还有些 REST API 会把参数放到 URL 中，比如 GitHub 的 API：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17622633926326725000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`GET /users/:user/repos`, `17622633926326725000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">GET /users/:user/repos</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>调用时，需要把 :user 替换为实际用户名。如果我们能写出这样的链式调用：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="82813405810342460000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Chain().users(\'michael\').repos`, `82813405810342460000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">Chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>users<span class="token punctuation">(</span><span class="token string">\'michael\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>repos</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>就可以非常方便地调用 API 了。</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91492060673296200000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Chain(object):\n    def __init__(self, path=\'\'):\n       self.__path = path\n\n   def __getattr__(self, path):\n       return Chain(\'%s/%s\' % (self.__path, path))\n\n   def __call__(self, path):\n       return Chain(\'%s/%s\' % (self.__path, path))\n\n   def __str__(self):\n       return self.__path\n\n   __repr__ = __str__\n\nprint(Chain().users(\'michael\').repos) # /users/michael/repos`, `91492060673296200000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Chain</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token operator">=</span><span class="token string">\'\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n       self<span class="token punctuation">.</span>__path <span class="token operator">=</span> path\n\n   <span class="token keyword">def</span> <span class="token function">__getattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>\n       <span class="token keyword">return</span> Chain<span class="token punctuation">(</span><span class="token string">\'%s/%s\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>__path<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n   <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>\n       <span class="token keyword">return</span> Chain<span class="token punctuation">(</span><span class="token string">\'%s/%s\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>__path<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n   <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n       <span class="token keyword">return</span> self<span class="token punctuation">.</span>__path\n\n   __repr__ <span class="token operator">=</span> __str__\n\n<span class="token keyword">print</span><span class="token punctuation">(</span>Chain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>users<span class="token punctuation">(</span><span class="token string">\'michael\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>repos<span class="token punctuation">)</span> <span class="token comment"># /users/michael/repos</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="__call__"><a href="#__call__" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code class="language-text">__call__</code></h3>\n<p>一个对象实例可以有自己的属性和方法，当我们调用实例方法时，我们用 instance.method() 来调用。能不能直接在实例本身上调用呢？在 Python 中，答案是肯定的。</p>\n<p>任何类，只需要定义一个 <code class="language-text">__call__()</code> 方法，就可以直接对实例进行调用。请看示例：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71094436595432710000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Student(object):\n    def __init__(self, name):\n        self.name = name\n\n    def __call__(self):\n        print(\'My name is %s.\' % self.name)`, `71094436595432710000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name\n\n    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'My name is %s.\'</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>name<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>调用方式如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86358081232156300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> s = Student(\'Michael\')\n>>> s() # self 参数不要传入\nMy name is Michael.`, `86358081232156300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">\'Michael\'</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># self 参数不要传入</span>\nMy name <span class="token keyword">is</span> Michael<span class="token punctuation">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p><code class="language-text">__call__()</code> 还可以定义参数。对实例进行直接调用就好比对一个函数进行调用一样，所以你完全可以把对象看成函数，把函数看成对象，因为这两者之间本来就没啥根本的区别。</p>\n<p>如果你把对象看成函数，那么函数本身其实也可以在运行期动态创建出来，因为类的实例都是运行期创建出来的，这么一来，我们就模糊了对象和函数的界限。</p>\n<p>那么，怎么判断一个变量是对象还是函数呢？其实，更多的时候，我们需要判断一个对象是否能被调用，能被调用的对象就是一个 Callable 对象，比如函数和我们上面定义的带有 <code class="language-text">__call__()</code> 的类实例：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92872019929743100000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> callable(Student())\nTrue\n>>> callable(max)\nTrue\n>>> callable([1, 2, 3])\nFalse\n>>> callable(None)\nFalse\n>>> callable(\'str\')\nFalse`, `92872019929743100000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">callable</span><span class="token punctuation">(</span>Student<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">callable</span><span class="token punctuation">(</span><span class="token builtin">max</span><span class="token punctuation">)</span>\n<span class="token boolean">True</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">callable</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token boolean">False</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">callable</span><span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span>\n<span class="token boolean">False</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">callable</span><span class="token punctuation">(</span><span class="token string">\'str\'</span><span class="token punctuation">)</span>\n<span class="token boolean">False</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>通过 callable() 函数，我们就可以判断一个对象是否是“可调用”对象。</p>\n<h3 id="小结-11"><a href="#%E5%B0%8F%E7%BB%93-11" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>Python 的 class 允许定义许多定制方法，可以让我们非常方便地生成特定的类。</p>\n<h2 id="使用元类"><a href="#%E4%BD%BF%E7%94%A8%E5%85%83%E7%B1%BB" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用元类</h2>\n<h3 id="type"><a href="#type" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>type()</h3>\n<p>动态语言和静态语言最大的不同，就是函数和类的定义，不是编译时定义的，而是运行时动态创建的。</p>\n<p>比方说我们要定义一个 Hello 的 class，就写一个 hello.py 模块：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34619669076431880000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Hello(object):\n    def hello(self, name=\'world\'):\n        print(\'Hello, %s.\' % name)`, `34619669076431880000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Hello</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">hello</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">\'world\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Hello, %s.\'</span> <span class="token operator">%</span> name<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>当 Python 解释器载入 hello 模块时，就会依次执行该模块的所有语句，执行结果就是动态创建出一个 Hello 的 class 对象，测试如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25211223398374384000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> from hello import Hello\n>>> h = Hello()\n>>> h.hello()\nHello, world.\n>>> print(type(Hello))\n<class \'type\'>\n>>> print(type(h))\n<class \'hello.Hello\'>`, `25211223398374384000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> hello <span class="token keyword">import</span> Hello\n<span class="token operator">>></span><span class="token operator">></span> h <span class="token operator">=</span> Hello<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> h<span class="token punctuation">.</span>hello<span class="token punctuation">(</span><span class="token punctuation">)</span>\nHello<span class="token punctuation">,</span> world<span class="token punctuation">.</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>Hello<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'type\'</span><span class="token operator">></span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'hello.Hello\'</span><span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>type() 函数可以查看一个类型或变量的类型，Hello 是一个 class，它的类型就是 type，而 h 是一个实例，它的类型就是 class Hello。</p>\n<p>我们说 class 的定义是运行时动态创建的，而创建 class 的方法就是使用 type() 函数。</p>\n<p>type() 函数既可以返回一个对象的类型，又可以创建出新的类型，比如，我们可以通过 type() 函数创建出 Hello 类，而无需通过 class Hello(object)… 的定义：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="90163874516664610000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> def fn(self, name=\'world\'): # 先定义函数\n...     print(\'Hello, %s.\' % name)\n...\n>>> Hello = type(\'Hello\', (object,), dict(hello=fn)) # 创建 Hello class\n>>> h = Hello()\n>>> h.hello()\nHello, world.\n>>> print(type(Hello))\n<class \'type\'>\n>>> print(type(h))\n<class \'__main__.Hello\'>`, `90163874516664610000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">def</span> <span class="token function">fn</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">\'world\'</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># 先定义函数</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Hello, %s.\'</span> <span class="token operator">%</span> name<span class="token punctuation">)</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token operator">>></span><span class="token operator">></span> Hello <span class="token operator">=</span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token string">\'Hello\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>hello<span class="token operator">=</span>fn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 创建 Hello class</span>\n<span class="token operator">>></span><span class="token operator">></span> h <span class="token operator">=</span> Hello<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> h<span class="token punctuation">.</span>hello<span class="token punctuation">(</span><span class="token punctuation">)</span>\nHello<span class="token punctuation">,</span> world<span class="token punctuation">.</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>Hello<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'type\'</span><span class="token operator">></span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">\'__main__.Hello\'</span><span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>要创建一个 class 对象，type() 函数依次传入 3 个参数：</p>\n<ol>\n<li>class 的名称；</li>\n<li>继承的父类集合，注意 Python 支持多重继承，如果只有一个父类，别忘了 tuple 的单元素写法；</li>\n<li>class 的方法名称与函数绑定，这里我们把函数 fn 绑定到方法名 hello 上。</li>\n</ol>\n<p>通过 type() 函数创建的类和直接写 class 是完全一样的，因为 Python 解释器遇到 class 定义时，仅仅是扫描一下 class 定义的语法，然后调用 type() 函数创建出 class。</p>\n<p>正常情况下，我们都用 class Xxx… 来定义类，但是，type() 函数也允许我们动态创建出类来，也就是说，动态语言本身支持运行期动态创建类，这和静态语言有非常大的不同，要在静态语言运行期创建类，必须构造源代码字符串再调用编译器，或者借助一些工具生成字节码实现，本质上都是动态编译，会非常复杂。</p>\n<h3 id="metaclass"><a href="#metaclass" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>metaclass</h3>\n<p>除了使用 type() 动态创建类以外，要控制类的创建行为，还可以使用 metaclass。</p>\n<p>metaclass，直译为元类，简单的解释就是：</p>\n<p>当我们定义了类以后，就可以根据这个类创建出实例，所以先定义类，然后创建实例。</p>\n<p>但是如果我们想创建出类呢？那就必须根据 metaclass 创建出类，所以先定义 metaclass，然后创建类。</p>\n<p>连接起来就是：先定义 metaclass，就可以创建类，最后创建实例。</p>\n<p>所以，metaclass 允许你创建类或者修改类。换句话说，你可以把类看成是 metaclass 创建出来的“实例”。</p>\n<p>metaclass 是 Python 面向对象里最难理解，也是最难使用的魔术代码。正常情况下，你不会碰到需要使用 metaclass 的情况，所以，以下内容看不懂也没关系，因为基本上你不会用到。</p>\n<p>我们先看一个简单的例子，这个 metaclass 可以给我们自定义的 MyList 增加一个 add 方法：</p>\n<p>定义 ListMetaclass，按照默认习惯，metaclass 的类名总是以 Metaclass 结尾，以便清楚地表示这是一个 metaclass：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64346587550789720000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# metaclass 是类的模板，所以必须从 \\`type\\` 类型派生：\nclass ListMetaclass(type):\n    def __new__(cls, name, bases, attrs):\n        attrs[\'add\'] = lambda self, value: self.append(value)\n        return type.__new__(cls, name, bases, attrs)`, `64346587550789720000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment"># metaclass 是类的模板，所以必须从 `type` 类型派生：</span>\n<span class="token keyword">class</span> <span class="token class-name">ListMetaclass</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        attrs<span class="token punctuation">[</span><span class="token string">\'add\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">lambda</span> self<span class="token punctuation">,</span> value<span class="token punctuation">:</span> self<span class="token punctuation">.</span>append<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token builtin">type</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>cls<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>有了 ListMetaclass，我们在定义类的时候还要指示使用 ListMetaclass 来定制类，传入关键字参数 metaclass：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59534450859398210000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class MyList(list, metaclass=ListMetaclass):\n    pass`, `59534450859398210000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">MyList</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">,</span> metaclass<span class="token operator">=</span>ListMetaclass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>当我们传入关键字参数 metaclass 时，魔术就生效了，它指示 Python 解释器在创建 MyList 时，要通过 <code class="language-text">ListMetaclass.__new__()</code> 来创建，在此，我们可以修改类的定义，比如，加上新的方法，然后，返回修改后的定义。</p>\n<p><code class="language-text">__new__()</code> 方法接收到的参数依次是：</p>\n<ol>\n<li>当前准备创建的类的对象；</li>\n<li>类的名字；</li>\n<li>类继承的父类集合；</li>\n<li>类的方法集合。</li>\n</ol>\n<p>测试一下 MyList 是否可以调用 add() 方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70852449671602870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> L = MyList()\n>>> L.add(1)\n>> L\n[1]`, `70852449671602870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> L <span class="token operator">=</span> MyList<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> L<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>\n<span class="token operator">>></span> L\n<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>而普通的 list 没有 add() 方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="66262084985950945000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> L2 = list()\n>>> L2.add(1)\nTraceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\nAttributeError: \'list\' object has no attribute \'add\'`, `66262084985950945000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> L2 <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> L2<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>\n  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\nAttributeError<span class="token punctuation">:</span> <span class="token string">\'list\'</span> <span class="token builtin">object</span> has no attribute <span class="token string">\'add\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>动态修改有什么意义？直接在 MyList 定义中写上 add() 方法不是更简单吗？正常情况下，确实应该直接写，通过 metaclass 修改纯属变态。</p>\n<p>但是，总会遇到需要通过 metaclass 修改类定义的。ORM 就是一个典型的例子。</p>\n<p>ORM 全称 “Object Relational Mapping”，即对象-关系映射，就是把关系数据库的一行映射为一个对象，也就是一个类对应一个表，这样，写代码更简单，不用直接操作 SQL 语句。</p>\n<p>要编写一个 ORM 框架，所有的类都只能动态定义，因为只有使用者才能根据表的结构定义出对应的类来。</p>\n<p>让我们来尝试编写一个 ORM 框架。</p>\n<p>编写底层模块的第一步，就是先把调用接口写出来。比如，使用者如果使用这个 ORM 框架，想定义一个 User 类来操作对应的数据库表 User，我们期待他写出这样的代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12756587679795417000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class User(Model):\n    # 定义类的属性到列的映射：\n    id = IntegerField(\'id\')\n    name = StringField(\'username\')\n    email = StringField(\'email\')\n    password = StringField(\'password\')\n\n# 创建一个实例：\nu = User(id=12345, name=\'Michael\', email=\'test@orm.org\', password=\'my-pwd\')\n# 保存到数据库：\nu.save()`, `12756587679795417000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">(</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token comment"># 定义类的属性到列的映射：</span>\n    <span class="token builtin">id</span> <span class="token operator">=</span> IntegerField<span class="token punctuation">(</span><span class="token string">\'id\'</span><span class="token punctuation">)</span>\n    name <span class="token operator">=</span> StringField<span class="token punctuation">(</span><span class="token string">\'username\'</span><span class="token punctuation">)</span>\n    email <span class="token operator">=</span> StringField<span class="token punctuation">(</span><span class="token string">\'email\'</span><span class="token punctuation">)</span>\n    password <span class="token operator">=</span> StringField<span class="token punctuation">(</span><span class="token string">\'password\'</span><span class="token punctuation">)</span>\n\n<span class="token comment"># 创建一个实例：</span>\nu <span class="token operator">=</span> User<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">12345</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">\'Michael\'</span><span class="token punctuation">,</span> email<span class="token operator">=</span><span class="token string">\'test@orm.org\'</span><span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token string">\'my-pwd\'</span><span class="token punctuation">)</span>\n<span class="token comment"># 保存到数据库：</span>\nu<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>其中，父类 Model 和属性类型 StringField、IntegerField 是由 ORM 框架提供的，剩下的魔术方法比如 save() 全部由父类 Model 自动完成。虽然 metaclass 的编写会比较复杂，但 ORM 的使用者用起来却异常简单。</p>\n<p>现在，我们就按上面的接口来实现该 ORM。</p>\n<p>首先来定义 Field 类，它负责保存数据库表的字段名和字段类型：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62295497295197585000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Field(object):\n\n    def __init__(self, name, column_type):\n        self.name = name\n        self.column_type = column_type\n\n    def __str__(self):\n        return \'<%s:%s>\' % (self.__class__.__name__, self.name)`, `62295497295197585000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Field</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> column_type<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name\n        self<span class="token punctuation">.</span>column_type <span class="token operator">=</span> column_type\n\n    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token string">\'&lt;%s:%s>\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__<span class="token punctuation">,</span> self<span class="token punctuation">.</span>name<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 Field 的基础上，进一步定义各种类型的 Field，比如 StringField，IntegerField 等等：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12627692446499727000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class StringField(Field):\n\n    def __init__(self, name):\n        super(StringField, self).__init__(name, \'varchar(100)\')\n\nclass IntegerField(Field):\n\n    def __init__(self, name):\n        super(IntegerField, self).__init__(name, \'bigint\')`, `12627692446499727000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">StringField</span><span class="token punctuation">(</span>Field<span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span>StringField<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">\'varchar(100)\'</span><span class="token punctuation">)</span>\n\n<span class="token keyword">class</span> <span class="token class-name">IntegerField</span><span class="token punctuation">(</span>Field<span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span>IntegerField<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">\'bigint\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>下一步，就是编写最复杂的 ModelMetaclass 了：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="3846305418197482000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class ModelMetaclass(type):\n\n    def __new__(cls, name, bases, attrs):\n        if name==\'Model\':\n            return type.__new__(cls, name, bases, attrs)\n        print(\'Found model: %s\' % name)\n        mappings = dict()\n        for k, v in attrs.items():\n            if isinstance(v, Field):\n                print(\'Found mapping: %s ==> %s\' % (k, v))\n                mappings[k] = v\n        for k in mappings.keys():\n            attrs.pop(k)\n        attrs[\'__mappings__\'] = mappings # 保存属性和列的映射关系\n        attrs[\'__table__\'] = name # 假设表名和类名一致\n        return type.__new__(cls, name, bases, attrs)`, `3846305418197482000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">ModelMetaclass</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    <span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">if</span> name<span class="token operator">==</span><span class="token string">\'Model\'</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> <span class="token builtin">type</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>cls<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Found model: %s\'</span> <span class="token operator">%</span> name<span class="token punctuation">)</span>\n        mappings <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> attrs<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> Field<span class="token punctuation">)</span><span class="token punctuation">:</span>\n                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Found mapping: %s ==> %s\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">)</span>\n                mappings<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> v\n        <span class="token keyword">for</span> k <span class="token keyword">in</span> mappings<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            attrs<span class="token punctuation">.</span>pop<span class="token punctuation">(</span>k<span class="token punctuation">)</span>\n        attrs<span class="token punctuation">[</span><span class="token string">\'__mappings__\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> mappings <span class="token comment"># 保存属性和列的映射关系</span>\n        attrs<span class="token punctuation">[</span><span class="token string">\'__table__\'</span><span class="token punctuation">]</span> <span class="token operator">=</span> name <span class="token comment"># 假设表名和类名一致</span>\n        <span class="token keyword">return</span> <span class="token builtin">type</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>cls<span class="token punctuation">,</span> name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>以及基类 Model：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48660139588475790000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`class Model(dict, metaclass=ModelMetaclass):\n\n    def __init__(self, **kw):\n        super(Model, self).__init__(**kw)\n\n    def __getattr__(self, key):\n        try:\n            return self[key]\n        except KeyError:\n            raise AttributeError(r&quot;\'Model\' object has no attribute \'%s\'&quot; % key)\n\n    def __setattr__(self, key, value):\n        self[key] = value\n\n    def save(self):\n        fields = []\n        params = []\n        args = []\n        for k, v in self.__mappings__.items():\n            fields.append(v.name)\n            params.append(\'?\')\n            args.append(getattr(self, k, None))\n        sql = \'insert into %s (%s) values (%s)\' % (self.__table__, \',\'.join(fields), \',\'.join(params))\n        print(\'SQL: %s\' % sql)\n        print(\'ARGS: %s\' % str(args))`, `48660139588475790000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">class</span> <span class="token class-name">Model</span><span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">,</span> metaclass<span class="token operator">=</span>ModelMetaclass<span class="token punctuation">)</span><span class="token punctuation">:</span>\n\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token builtin">super</span><span class="token punctuation">(</span>Model<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token operator">**</span>kw<span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__getattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">try</span><span class="token punctuation">:</span>\n            <span class="token keyword">return</span> self<span class="token punctuation">[</span>key<span class="token punctuation">]</span>\n        <span class="token keyword">except</span> KeyError<span class="token punctuation">:</span>\n            <span class="token keyword">raise</span> AttributeError<span class="token punctuation">(</span><span class="token string">r"\'Model\' object has no attribute \'%s\'"</span> <span class="token operator">%</span> key<span class="token punctuation">)</span>\n\n    <span class="token keyword">def</span> <span class="token function">__setattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value\n\n    <span class="token keyword">def</span> <span class="token function">save</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n        params <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n        args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n        <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> self<span class="token punctuation">.</span>__mappings__<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n            fields<span class="token punctuation">.</span>append<span class="token punctuation">(</span>v<span class="token punctuation">.</span>name<span class="token punctuation">)</span>\n            params<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">\'?\'</span><span class="token punctuation">)</span>\n            args<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">getattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> k<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n        sql <span class="token operator">=</span> <span class="token string">\'insert into %s (%s) values (%s)\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>__table__<span class="token punctuation">,</span> <span class="token string">\',\'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>fields<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\',\'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'SQL: %s\'</span> <span class="token operator">%</span> sql<span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'ARGS: %s\'</span> <span class="token operator">%</span> <span class="token builtin">str</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当用户定义一个 class User(Model) 时，Python 解释器首先在当前类 User 的定义中查找 metaclass，如果没有找到，就继续在父类 Model 中查找 metaclass，找到了，就使用 Model 中定义的 metaclass 的 ModelMetaclass 来创建 User 类，也就是说，metaclass 可以隐式地继承到子类，但子类自己却感觉不到。</p>\n<p>在 ModelMetaclass 中，一共做了几件事情：</p>\n<ol>\n<li>排除掉对 Model 类的修改；</li>\n<li>在当前类（比如 User）中查找定义的类的所有属性，如果找到一个 Field 属性，就把它保存到一个 <code class="language-text">__mappings__</code> 的 dict 中，同时从类属性中删除该 Field 属性，否则，容易造成运行时错误（实例的属性会遮盖类的同名属性）；</li>\n<li>把表名保存到 <code class="language-text">__table__</code> 中，这里简化为表名默认为类名。</li>\n</ol>\n<p>在 Model 类中，就可以定义各种操作数据库的方法，比如 save()，delete()，find()，update() 等等。</p>\n<p>我们实现了 save() 方法，把一个实例保存到数据库中。因为有表名，属性到字段的映射和属性值的集合，就可以构造出 INSERT 语句。</p>\n<p>编写代码试试：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28178265100860990000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`u = User(id=12345, name=\'Michael\', email=\'test@orm.org\', password=\'my-pwd\')\nu.save()`, `28178265100860990000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">u <span class="token operator">=</span> User<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">12345</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">\'Michael\'</span><span class="token punctuation">,</span> email<span class="token operator">=</span><span class="token string">\'test@orm.org\'</span><span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token string">\'my-pwd\'</span><span class="token punctuation">)</span>\nu<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>输出如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="75887369744110620000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Found model: User\nFound mapping: email ==> <StringField:email>\nFound mapping: password ==> <StringField:password>\nFound mapping: id ==> <IntegerField:uid>\nFound mapping: name ==> <StringField:username>\nSQL: insert into User (password,email,username,id) values (?,?,?,?)\nARGS: [\'my-pwd\', \'test@orm.org\', \'Michael\', 12345]`, `75887369744110620000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">Found model<span class="token punctuation">:</span> User\nFound mapping<span class="token punctuation">:</span> email <span class="token operator">==</span><span class="token operator">></span> <span class="token operator">&lt;</span>StringField<span class="token punctuation">:</span>email<span class="token operator">></span>\nFound mapping<span class="token punctuation">:</span> password <span class="token operator">==</span><span class="token operator">></span> <span class="token operator">&lt;</span>StringField<span class="token punctuation">:</span>password<span class="token operator">></span>\nFound mapping<span class="token punctuation">:</span> <span class="token builtin">id</span> <span class="token operator">==</span><span class="token operator">></span> <span class="token operator">&lt;</span>IntegerField<span class="token punctuation">:</span>uid<span class="token operator">></span>\nFound mapping<span class="token punctuation">:</span> name <span class="token operator">==</span><span class="token operator">></span> <span class="token operator">&lt;</span>StringField<span class="token punctuation">:</span>username<span class="token operator">></span>\nSQL<span class="token punctuation">:</span> insert into User <span class="token punctuation">(</span>password<span class="token punctuation">,</span>email<span class="token punctuation">,</span>username<span class="token punctuation">,</span><span class="token builtin">id</span><span class="token punctuation">)</span> values <span class="token punctuation">(</span>?<span class="token punctuation">,</span>?<span class="token punctuation">,</span>?<span class="token punctuation">,</span>?<span class="token punctuation">)</span>\nARGS<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">\'my-pwd\'</span><span class="token punctuation">,</span> <span class="token string">\'test@orm.org\'</span><span class="token punctuation">,</span> <span class="token string">\'Michael\'</span><span class="token punctuation">,</span> <span class="token number">12345</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可以看到，save() 方法已经打印出了可执行的 SQL 语句，以及参数列表，只需要真正连接到数据库，执行该 SQL 语句，就可以完成真正的功能。</p>\n<p>不到 100 行代码，我们就通过 metaclass 实现了一个精简的 ORM 框架，是不是非常简单？</p>\n<h3 id="小结-12"><a href="#%E5%B0%8F%E7%BB%93-12" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>metaclass 是 Python 中非常具有魔术性的对象，它可以改变类创建时的行为。这种强大的功能使用起来务必小心。</p>\n<h1 id="错误、调试和测试"><a href="#%E9%94%99%E8%AF%AF%E3%80%81%E8%B0%83%E8%AF%95%E5%92%8C%E6%B5%8B%E8%AF%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>错误、调试和测试</h1>\n<h2 id="错误处理"><a href="#%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>错误处理</h2>\n<h3 id="try"><a href="#try" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>try</h3>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81819071319604820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`try:\n    print(\'try...\')\n    r = 10 / 0\n    print(\'result:\', r)\nexcept ZeroDivisionError as e:\n    print(\'except:\', e)\nfinally:\n    print(\'finally...\')\nprint(\'END\')`, `81819071319604820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">try</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'try...\'</span><span class="token punctuation">)</span>\n    r <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">/</span> <span class="token number">0</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'result:\'</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span>\n<span class="token keyword">except</span> ZeroDivisionError <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'except:\'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>\n<span class="token keyword">finally</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'finally...\'</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'END\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当我们认为某些代码可能会出错时，就可以用 try 来运行这段代码，如果执行出错，则后续代码不会继续执行，而是直接跳转至错误处理代码，即 except 语句块，执行完 except 后，如果有 finally 语句块，则执行 finally 语句块，至此，执行完毕。</p>\n<p>上面的代码在计算 10 / 0 时会产生一个除法运算错误：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41119577346612870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`try...\nexcept: division by zero\nfinally...\nEND`, `41119577346612870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">try</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n<span class="token keyword">except</span><span class="token punctuation">:</span> division by zero\n<span class="token keyword">finally</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nEND</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>从输出可以看到，当错误发生时，后续语句 <code class="language-text">print(&#39;result:&#39;, r)</code> 不会被执行，except 由于捕获到 ZeroDivisionError，因此被执行。最后，finally 语句被执行。然后，程序继续按照流程往下走。</p>\n<p>如果把除数 0 改成 2，则执行结果如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62298512865365565000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`try...\nresult: 5\nfinally...\nEND`, `62298512865365565000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">try</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nresult<span class="token punctuation">:</span> <span class="token number">5</span>\n<span class="token keyword">finally</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nEND</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>由于没有错误发生，所以 except 语句块不会被执行，但是 finally 如果有，则一定会被执行（可以没有 finally 语句）。</p>\n<p>你还可以猜测，错误应该有很多种类，如果发生了不同类型的错误，应该由不同的 except 语句块处理。没错，可以有多个 except 来捕获不同类型的错误：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8505551819250590000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`try:\n    print(\'try...\')\n    r = 10 / int(\'a\')\n    print(\'result:\', r)\nexcept ValueError as e:\n    print(\'ValueError:\', e)\nexcept ZeroDivisionError as e:\n    print(\'ZeroDivisionError:\', e)\nfinally:\n    print(\'finally...\')\nprint(\'END\')`, `8505551819250590000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">try</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'try...\'</span><span class="token punctuation">)</span>\n    r <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">/</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token string">\'a\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'result:\'</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span>\n<span class="token keyword">except</span> ValueError <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'ValueError:\'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>\n<span class="token keyword">except</span> ZeroDivisionError <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'ZeroDivisionError:\'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>\n<span class="token keyword">finally</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'finally...\'</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'END\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>int() 函数可能会抛出 ValueError，所以我们用一个 except 捕获 ValueError，用另一个 except 捕获 ZeroDivisionError。</p>\n<p>此外，如果没有错误发生，可以在 except 语句块后面加一个 else，当没有错误发生时，会自动执行 else 语句：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92572170374341300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`try:\n    print(\'try...\')\n    r = 10 / int(\'2\')\n    print(\'result:\', r)\nexcept ValueError as e:\n    print(\'ValueError:\', e)\nexcept ZeroDivisionError as e:\n    print(\'ZeroDivisionError:\', e)\nelse:\n    print(\'no error!\')\nfinally:\n    print(\'finally...\')\nprint(\'END\')`, `92572170374341300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">try</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'try...\'</span><span class="token punctuation">)</span>\n    r <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">/</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token string">\'2\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'result:\'</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span>\n<span class="token keyword">except</span> ValueError <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'ValueError:\'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>\n<span class="token keyword">except</span> ZeroDivisionError <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'ZeroDivisionError:\'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'no error!\'</span><span class="token punctuation">)</span>\n<span class="token keyword">finally</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'finally...\'</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'END\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Python 的错误其实也是 class，所有的错误类型都继承自 BaseException，所以在使用 except 时需要注意的是，它不但捕获该类型的错误，还把其子类也“一网打尽”。比如：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78242479995641640000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`try:\n    foo()\nexcept ValueError as e:\n    print(\'ValueError\')\nexcept UnicodeError as e:\n    print(\'UnicodeError\')`, `78242479995641640000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">try</span><span class="token punctuation">:</span>\n    foo<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">except</span> ValueError <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'ValueError\'</span><span class="token punctuation">)</span>\n<span class="token keyword">except</span> UnicodeError <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'UnicodeError\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>第二个 except 永远也捕获不到 UnicodeError，因为 UnicodeError 是 ValueError 的子类，如果有，也被第一个 except 给捕获了。</p>\n<p>Python 所有的错误都是从 BaseException 类派生的，常见的错误类型和继承关系看<a href="https://docs.python.org/3/library/exceptions.html#exception-hierarchy" target="_blank" rel="nofollow noreferrer noopener">这里</a></p>\n<p>使用 try…except 捕获错误还有一个巨大的好处，就是可以跨越多层调用，比如函数 main() 调用 bar()，bar() 调用 foo()，结果 foo() 出错了，这时，只要 main() 捕获到了，就可以处理：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11759922050282646000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def foo(s):\n    return 10 / int(s)\n\ndef bar(s):\n    return foo(s) * 2\n\ndef main():\n    try:\n        bar(\'0\')\n    except Exception as e:\n        print(\'Error:\', e)\n    finally:\n        print(\'finally...\')`, `11759922050282646000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> <span class="token number">10</span> <span class="token operator">/</span> <span class="token builtin">int</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>\n\n<span class="token keyword">def</span> <span class="token function">bar</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> foo<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span>\n\n<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        bar<span class="token punctuation">(</span><span class="token string">\'0\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Error:\'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>\n    <span class="token keyword">finally</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'finally...\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>也就是说，不需要在每个可能出错的地方去捕获错误，只要在合适的层次去捕获错误就可以了。这样一来，就大大减少了写 try…except…finally 的麻烦。</p>\n<h3 id="调用栈"><a href="#%E8%B0%83%E7%94%A8%E6%A0%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>调用栈</h3>\n<p>如果错误没有被捕获，它就会一直往上抛，最后被 Python 解释器捕获，打印一个错误信息，然后程序退出。来看看 err.py：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53914860076014380000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# err.py:\ndef foo(s):\n    return 10 / int(s)\n\ndef bar(s):\n    return foo(s) * 2\n\ndef main():\n    bar(\'0\')\n\nmain()`, `53914860076014380000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment"># err.py:</span>\n<span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> <span class="token number">10</span> <span class="token operator">/</span> <span class="token builtin">int</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>\n\n<span class="token keyword">def</span> <span class="token function">bar</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> foo<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span>\n\n<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    bar<span class="token punctuation">(</span><span class="token string">\'0\'</span><span class="token punctuation">)</span>\n\nmain<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>执行，结果如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80651910566366870000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ python3 err.py\nTraceback (most recent call last): # 错误的跟踪信息\n  File &quot;err.py&quot;, line 11, in <module> # 调用 main() 出错了，在代码文件 err.py 的第 11 行代码，但原因是第 9 行\n    main()\n  File &quot;err.py&quot;, line 9, in main # 调用 bar(\'0\') 出错了，在代码文件 err.py 的第 9 行代码，但原因是第 6 行\n    bar(\'0\')\n  File &quot;err.py&quot;, line 6, in bar # 原因是 return foo(s) * 2 这个语句出错了，但这还不是最终原因，继续往下看\n    return foo(s) * 2\n  File &quot;err.py&quot;, line 3, in foo # 原因是 return 10 / int(s) 这个语句出错了，这是错误产生的源头，因为下面打印了：ZeroDivisionError: division by zero\n    return 10 / int(s)\nZeroDivisionError: division by zero`, `80651910566366870000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ python3 err.py\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span>: <span class="token comment"># 错误的跟踪信息</span>\n  File <span class="token string">"err.py"</span>, line <span class="token number">11</span>, <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span> <span class="token comment"># 调用 main() 出错了，在代码文件 err.py 的第 11 行代码，但原因是第 9 行</span>\n    main<span class="token punctuation">(</span><span class="token punctuation">)</span>\n  File <span class="token string">"err.py"</span>, line <span class="token number">9</span>, <span class="token keyword">in</span> main <span class="token comment"># 调用 bar(\'0\') 出错了，在代码文件 err.py 的第 9 行代码，但原因是第 6 行</span>\n    bar<span class="token punctuation">(</span><span class="token string">\'0\'</span><span class="token punctuation">)</span>\n  File <span class="token string">"err.py"</span>, line <span class="token number">6</span>, <span class="token keyword">in</span> bar <span class="token comment"># 原因是 return foo(s) * 2 这个语句出错了，但这还不是最终原因，继续往下看</span>\n    <span class="token builtin class-name">return</span> foo<span class="token punctuation">(</span>s<span class="token punctuation">)</span> * <span class="token number">2</span>\n  File <span class="token string">"err.py"</span>, line <span class="token number">3</span>, <span class="token keyword">in</span> foo <span class="token comment"># 原因是 return 10 / int(s) 这个语句出错了，这是错误产生的源头，因为下面打印了：ZeroDivisionError: division by zero</span>\n    <span class="token builtin class-name">return</span> <span class="token number">10</span> / int<span class="token punctuation">(</span>s<span class="token punctuation">)</span>\nZeroDivisionError: division by zero</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>出错并不可怕，可怕的是不知道哪里出错了。解读错误信息是定位错误的关键，如上面的代码注释</p>\n<h3 id="记录错误"><a href="#%E8%AE%B0%E5%BD%95%E9%94%99%E8%AF%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>记录错误</h3>\n<p>如果不捕获错误，自然可以让 Python 解释器来打印出错误堆栈，但程序也被结束了。既然我们能捕获错误，就可以把错误堆栈打印出来，然后分析错误原因，同时，让程序继续执行下去。</p>\n<p>Python 内置的 logging 模块可以非常容易地记录错误信息：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="71756120613757340000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# err_logging.py\n\nimport logging\n\ndef foo(s):\n    return 10 / int(s)\n\ndef bar(s):\n    return foo(s) * 2\n\ndef main():\n    try:\n        bar(\'0\')\n    except Exception as e:\n        logging.exception(e)\n\nmain()\nprint(\'END\')`, `71756120613757340000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment"># err_logging.py</span>\n\n<span class="token keyword">import</span> logging\n\n<span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> <span class="token number">10</span> <span class="token operator">/</span> <span class="token builtin">int</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>\n\n<span class="token keyword">def</span> <span class="token function">bar</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> foo<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span>\n\n<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        bar<span class="token punctuation">(</span><span class="token string">\'0\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n        logging<span class="token punctuation">.</span>exception<span class="token punctuation">(</span>e<span class="token punctuation">)</span>\n\nmain<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'END\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>同样是出错，但程序打印完错误信息后会继续执行，并正常退出：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37617903727650860000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ python3 err_logging.py\nERROR:root:division by zero\nTraceback (most recent call last):\n  File &quot;err_logging.py&quot;, line 13, in main\n    bar(\'0\')\n  File &quot;err_logging.py&quot;, line 9, in bar\n    return foo(s) * 2\n  File &quot;err_logging.py&quot;, line 6, in foo\n    return 10 / int(s)\nZeroDivisionError: division by zero\nEND`, `37617903727650860000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ python3 err_logging.py\nERROR:root:division by zero\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span>:\n  File <span class="token string">"err_logging.py"</span>, line <span class="token number">13</span>, <span class="token keyword">in</span> main\n    bar<span class="token punctuation">(</span><span class="token string">\'0\'</span><span class="token punctuation">)</span>\n  File <span class="token string">"err_logging.py"</span>, line <span class="token number">9</span>, <span class="token keyword">in</span> bar\n    <span class="token builtin class-name">return</span> foo<span class="token punctuation">(</span>s<span class="token punctuation">)</span> * <span class="token number">2</span>\n  File <span class="token string">"err_logging.py"</span>, line <span class="token number">6</span>, <span class="token keyword">in</span> foo\n    <span class="token builtin class-name">return</span> <span class="token number">10</span> / int<span class="token punctuation">(</span>s<span class="token punctuation">)</span>\nZeroDivisionError: division by zero\nEND</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>通过配置，logging 还可以把错误记录到日志文件里，方便事后排查。</p>\n<h3 id="抛出错误"><a href="#%E6%8A%9B%E5%87%BA%E9%94%99%E8%AF%AF" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>抛出错误</h3>\n<p>因为错误是 class，捕获一个错误就是捕获到该 class 的一个实例。因此，错误并不是凭空产生的，而是有意创建并抛出的。Python 的内置函数会抛出很多类型的错误，我们自己编写的函数也可以抛出错误。</p>\n<p>如果要抛出错误，首先根据需要，可以定义一个错误的 class，选择好继承关系，然后，用 raise 语句抛出一个错误的实例：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="242407831420310400"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# err_raise.py\nclass FooError(ValueError):\n    pass\n\ndef foo(s):\n    n = int(s)\n    if n==0:\n        raise FooError(\'invalid value: %s\' % s)\n    return 10 / n\n\nfoo(\'0\')`, `242407831420310400`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment"># err_raise.py</span>\n<span class="token keyword">class</span> <span class="token class-name">FooError</span><span class="token punctuation">(</span>ValueError<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n<span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    n <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>\n    <span class="token keyword">if</span> n<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> FooError<span class="token punctuation">(</span><span class="token string">\'invalid value: %s\'</span> <span class="token operator">%</span> s<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> <span class="token number">10</span> <span class="token operator">/</span> n\n\nfoo<span class="token punctuation">(</span><span class="token string">\'0\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>执行，可以最后跟踪到我们自己定义的错误：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1029188570587313800"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ python3 err_raise.py\nTraceback (most recent call last):\n  File &quot;err_throw.py&quot;, line 11, in <module>\n    foo(\'0\')\n  File &quot;err_throw.py&quot;, line 8, in foo\n    raise FooError(\'invalid value: %s\' % s)\n__main__.FooError: invalid value: 0`, `1029188570587313800`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ python3 err_raise.py\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span>:\n  File <span class="token string">"err_throw.py"</span>, line <span class="token number">11</span>, <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\n    foo<span class="token punctuation">(</span><span class="token string">\'0\'</span><span class="token punctuation">)</span>\n  File <span class="token string">"err_throw.py"</span>, line <span class="token number">8</span>, <span class="token keyword">in</span> foo\n    raise FooError<span class="token punctuation">(</span><span class="token string">\'invalid value: %s\'</span> % s<span class="token punctuation">)</span>\n__main__.FooError: invalid value: <span class="token number">0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>只有在必要的时候才定义我们自己的错误类型。如果可以选择 Python 已有的内置的错误类型（比如 ValueError，TypeError），尽量使用 Python 内置的错误类型。</p>\n<p>最后，我们来看另一种错误处理的方式：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="20886693250102680000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# err_reraise.py\ndef foo(s):\n    n = int(s)\n    if n==0:\n        raise ValueError(\'invalid value: %s\' % s)\n    return 10 / n\n\ndef bar():\n    try:\n        foo(\'0\')\n    except ValueError as e:\n        print(\'ValueError!\')\n        raise\n\nbar()`, `20886693250102680000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment"># err_reraise.py</span>\n<span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    n <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>\n    <span class="token keyword">if</span> n<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">:</span>\n        <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'invalid value: %s\'</span> <span class="token operator">%</span> s<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> <span class="token number">10</span> <span class="token operator">/</span> n\n\n<span class="token keyword">def</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        foo<span class="token punctuation">(</span><span class="token string">\'0\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">except</span> ValueError <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'ValueError!\'</span><span class="token punctuation">)</span>\n        <span class="token keyword">raise</span>\n\nbar<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 bar() 函数中，我们明明已经捕获了错误，但是，打印一个 ValueError! 后，又把错误通过 raise 语句抛出去了，这不有病么？</p>\n<p>其实这种错误处理方式不但没病，而且相当常见。捕获错误目的只是记录一下，便于后续追踪。但是，由于当前函数不知道应该怎么处理该错误，所以，最恰当的方式是继续往上抛，让顶层调用者去处理。好比一个员工处理不了一个问题时，就把问题抛给他的老板，如果他的老板也处理不了，就一直往上抛，最终会抛给 CEO 去处理。</p>\n<p>raise 语句如果不带参数，就会把当前错误原样抛出。此外，在 except 中 raise 一个 Error，还可以把一种类型的错误转化成另一种类型：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8421560043657261000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`try:\n    10 / 0\nexcept ZeroDivisionError:\n    raise ValueError(\'input error!\')`, `8421560043657261000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">try</span><span class="token punctuation">:</span>\n    <span class="token number">10</span> <span class="token operator">/</span> <span class="token number">0</span>\n<span class="token keyword">except</span> ZeroDivisionError<span class="token punctuation">:</span>\n    <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">\'input error!\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>只要是合理的转换逻辑就可以，但是，决不应该把一个 IOError 转换成毫不相干的 ValueError。</p>\n<h3 id="小结-13"><a href="#%E5%B0%8F%E7%BB%93-13" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>Python 内置的 try…except…finally 用来处理错误十分方便。出错时，会分析错误信息并定位错误发生的代码位置才是最关键的。</p>\n<p>程序也可以主动抛出错误，让调用者来处理相应的错误。但是，应该在文档中写清楚可能会抛出哪些错误，以及错误产生的原因。</p>\n<h2 id="调试"><a href="#%E8%B0%83%E8%AF%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>调试</h2>\n<p>第一种方法简单直接粗暴有效，就是用 print() 把可能有问题的变量打印出来看看：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67663131039198585000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def foo(s):\n    n = int(s)\n    print(\'>>> n = %d\' % n)\n    return 10 / n\n\ndef main():\n    foo(\'0\')\n\nmain()`, `67663131039198585000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    n <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'>>> n = %d\'</span> <span class="token operator">%</span> n<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> <span class="token number">10</span> <span class="token operator">/</span> n\n\n<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    foo<span class="token punctuation">(</span><span class="token string">\'0\'</span><span class="token punctuation">)</span>\n\nmain<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>执行后在输出中查找打印的变量值：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52678178938276330000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ python err.py\n>>> n = 0\nTraceback (most recent call last):\n  ...\nZeroDivisionError: integer division or modulo by zero`, `52678178938276330000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ python err.py\n<span class="token operator">>></span><span class="token operator">></span> n <span class="token operator">=</span> <span class="token number">0</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span>:\n  <span class="token punctuation">..</span>.\nZeroDivisionError: integer division or modulo by zero</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>用 print() 最大的坏处是将来还得删掉它，想想程序里到处都是 print()，运行结果也会包含很多垃圾信息。所以，我们又有第二种方法。</p>\n<h3 id="断言"><a href="#%E6%96%AD%E8%A8%80" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>断言</h3>\n<p>凡是用 print() 来辅助查看的地方，都可以用断言（assert）来替代：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62923690860164890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def foo(s):\n    n = int(s)\n    assert n != 0, \'n is zero!\'\n    return 10 / n\n\ndef main():\n    foo(\'0\')`, `62923690860164890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    n <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>\n    <span class="token keyword">assert</span> n <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">\'n is zero!\'</span>\n    <span class="token keyword">return</span> <span class="token number">10</span> <span class="token operator">/</span> n\n\n<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    foo<span class="token punctuation">(</span><span class="token string">\'0\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>assert 的意思是，表达式 n != 0 应该是 True，否则，根据程序运行的逻辑，后面的代码肯定会出错。</p>\n<p>如果断言失败，assert 语句本身就会抛出 AssertionError：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12559416316369764000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ python err.py\nTraceback (most recent call last):\n  ...\nAssertionError: n is zero!`, `12559416316369764000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ python err.py\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span>:\n  <span class="token punctuation">..</span>.\nAssertionError: n is zero<span class="token operator">!</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>程序中如果到处充斥着 assert，和 print() 相比也好不到哪去。不过，启动 Python 解释器时可以用 -O 参数来关闭 assert：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9579915471347288000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ python -O err.py\nTraceback (most recent call last):\n  ...\nZeroDivisionError: division by zero`, `9579915471347288000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ python -O err.py\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span>:\n  <span class="token punctuation">..</span>.\nZeroDivisionError: division by zero</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<blockquote>\n<p>注意：断言的开关“-O”是英文大写字母 O，不是数字 0。</p>\n</blockquote>\n<p>关闭后，你可以把所有的 assert 语句当成 pass 来看。</p>\n<h3 id="logging"><a href="#logging" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>logging</h3>\n<p>把 print() 替换为 logging 是第 3 种方式，和 assert 比，logging 不会抛出错误，而且可以输出到文件：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="10036765418071013000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import logging\n\ns = \'0\'\nn = int(s)\nlogging.info(\'n = %d\' % n)\nprint(10 / n)`, `10036765418071013000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> logging\n\ns <span class="token operator">=</span> <span class="token string">\'0\'</span>\nn <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>\nlogging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">\'n = %d\'</span> <span class="token operator">%</span> n<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">/</span> n<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>logging.info() 就可以输出一段文本。运行，发现除了 ZeroDivisionError，没有任何信息。怎么回事？</p>\n<p>别急，在 import logging 之后添加一行配置再试试：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92985961627319700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import logging\nlogging.basicConfig(level=logging.INFO)`, `92985961627319700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> logging\nlogging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>level<span class="token operator">=</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>看到输出了：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21427039998673370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ python err.py\nINFO:root:n = 0\nTraceback (most recent call last):\n  File &quot;err.py&quot;, line 8, in <module>\n    print(10 / n)\nZeroDivisionError: division by zero`, `21427039998673370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ python err.py\nINFO:root:n <span class="token operator">=</span> <span class="token number">0</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span>:\n  File <span class="token string">"err.py"</span>, line <span class="token number">8</span>, <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\n    print<span class="token punctuation">(</span><span class="token number">10</span> / n<span class="token punctuation">)</span>\nZeroDivisionError: division by zero</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这就是 logging 的好处，它允许你指定记录信息的级别，有 debug，info，warning，error 等几个级别，当我们指定 level=INFO 时，logging.debug 就不起作用了。同理，指定 level=WARNING 后，debug 和 info 就不起作用了。这样一来，你可以放心地输出不同级别的信息，也不用删除，最后统一控制输出哪个级别的信息。</p>\n<p>logging 的另一个好处是通过简单的配置，一条语句可以同时输出到不同的地方，比如 console 和文件。</p>\n<h3 id="pdb"><a href="#pdb" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>pdb</h3>\n<p>第 4 种方式是启动 Python 的调试器 pdb，让程序以单步方式运行，可以随时查看运行状态。我们先准备好程序：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="33313680760532940000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# err.py\ns = \'0\'\nn = int(s)\nprint(10 / n)`, `33313680760532940000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment"># err.py</span>\ns <span class="token operator">=</span> <span class="token string">\'0\'</span>\nn <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">/</span> n<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>然后启动：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14837766333011905000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ python -m pdb err.py\n> /Users/michael/Github/learn-python3/samples/debug/err.py(2)<module>()\n-> s = \'0\'`, `14837766333011905000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ python -m pdb err.py\n<span class="token operator">></span> /Users/michael/Github/learn-python3/samples/debug/err.py<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">&lt;</span>module<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n-<span class="token operator">></span> s <span class="token operator">=</span> <span class="token string">\'0\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>以参数 <code class="language-text">-m pdb</code> 启动后，pdb 定位到下一步要执行的代码 <code class="language-text">-&gt; s = &#39;0&#39;</code>。输入命令 l 来查看代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73333894125207080000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(Pdb) l\n  1     # err.py\n  2  -> s = \'0\'\n  3     n = int(s)\n  4     print(10 / n)`, `73333894125207080000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token punctuation">(</span>Pdb<span class="token punctuation">)</span> l\n  <span class="token number">1</span>     <span class="token comment"># err.py</span>\n  <span class="token number">2</span>  <span class="token operator">-</span><span class="token operator">></span> s <span class="token operator">=</span> <span class="token string">\'0\'</span>\n  <span class="token number">3</span>     n <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>\n  <span class="token number">4</span>     <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">/</span> n<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>输入命令 n 可以单步执行代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="16410035813914003000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(Pdb) n\n> /Users/michael/Github/learn-python3/samples/debug/err.py(3)<module>()\n-> n = int(s)\n(Pdb) n\n> /Users/michael/Github/learn-python3/samples/debug/err.py(4)<module>()\n-> print(10 / n)`, `16410035813914003000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token punctuation">(</span>Pdb<span class="token punctuation">)</span> n\n<span class="token operator">></span> /Users/michael/Github/learn-python3/samples/debug/err.py<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">&lt;</span>module<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n-<span class="token operator">></span> n <span class="token operator">=</span> int<span class="token punctuation">(</span>s<span class="token punctuation">)</span>\n<span class="token punctuation">(</span>Pdb<span class="token punctuation">)</span> n\n<span class="token operator">></span> /Users/michael/Github/learn-python3/samples/debug/err.py<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token operator">&lt;</span>module<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n-<span class="token operator">></span> print<span class="token punctuation">(</span><span class="token number">10</span> / n<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>任何时候都可以输入命令 p 变量名来查看变量：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91319460808940160000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(Pdb) p s\n\'0\'\n(Pdb) p n\n0`, `91319460808940160000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token punctuation">(</span>Pdb<span class="token punctuation">)</span> p s\n<span class="token string">\'0\'</span>\n<span class="token punctuation">(</span>Pdb<span class="token punctuation">)</span> p n\n<span class="token number">0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>输入命令 q 结束调试，退出程序：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79013443598651790000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(Pdb) q`, `79013443598651790000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token punctuation">(</span>Pdb<span class="token punctuation">)</span> q</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>这种通过 pdb 在命令行调试的方法理论上是万能的，但实在是太麻烦了，如果有一千行代码，要运行到第 999 行得敲多少命令啊。还好，我们还有另一种调试方法。</p>\n<h3 id="pdbset_trace"><a href="#pdbset_trace" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>pdb.set_trace()</h3>\n<p>这个方法也是用 pdb，但是不需要单步执行，我们只需要 import pdb，然后，在可能出错的地方放一个 pdb.set_trace()，就可以设置一个断点：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="37151652786874780000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# err.py\nimport pdb\n\ns = \'0\'\nn = int(s)\npdb.set_trace() # 运行到这里会自动暂停\nprint(10 / n)`, `37151652786874780000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment"># err.py</span>\n<span class="token keyword">import</span> pdb\n\ns <span class="token operator">=</span> <span class="token string">\'0\'</span>\nn <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>\npdb<span class="token punctuation">.</span>set_trace<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 运行到这里会自动暂停</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">/</span> n<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>运行代码，程序会自动在 pdb.set_trace() 暂停并进入 pdb 调试环境，可以用命令 p 查看变量，或者用命令 c 继续运行：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92570000030987000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ python err.py\n> /Users/michael/Github/learn-python3/samples/debug/err.py(7)<module>()\n-> print(10 / n)\n(Pdb) p n\n0\n(Pdb) c\nTraceback (most recent call last):\n  File &quot;err.py&quot;, line 7, in <module>\n    print(10 / n)\nZeroDivisionError: division by zero`, `92570000030987000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ python err.py\n<span class="token operator">></span> /Users/michael/Github/learn-python3/samples/debug/err.py<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token operator">&lt;</span>module<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n-<span class="token operator">></span> print<span class="token punctuation">(</span><span class="token number">10</span> / n<span class="token punctuation">)</span>\n<span class="token punctuation">(</span>Pdb<span class="token punctuation">)</span> p n\n<span class="token number">0</span>\n<span class="token punctuation">(</span>Pdb<span class="token punctuation">)</span> c\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span>:\n  File <span class="token string">"err.py"</span>, line <span class="token number">7</span>, <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\n    print<span class="token punctuation">(</span><span class="token number">10</span> / n<span class="token punctuation">)</span>\nZeroDivisionError: division by zero</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个方式比直接启动 pdb 单步调试效率要高很多，但也高不到哪去。</p>\n<h3 id="ide"><a href="#ide" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>IDE</h3>\n<p>如果要比较爽地设置断点、单步执行，就需要一个支持调试功能的 IDE。</p>\n<h3 id="小结-14"><a href="#%E5%B0%8F%E7%BB%93-14" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>写程序最痛苦的事情莫过于调试，程序往往会以你意想不到的流程来运行，你期待执行的语句其实根本没有执行，这时候，就需要调试了。</p>\n<p>虽然用 IDE 调试起来比较方便，但是最后你会发现，logging 才是终极武器。</p>\n<h2 id="单元测试"><a href="#%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>单元测试</h2>\n<h2 id="文档测试"><a href="#%E6%96%87%E6%A1%A3%E6%B5%8B%E8%AF%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>文档测试</h2>\n<h1 id="io-编程"><a href="#io-%E7%BC%96%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>IO 编程</h1>\n<p>注意，本章的 IO 编程都是同步模式，异步 IO 由于复杂度太高，后续涉及到服务器端程序开发时我们再讨论。</p>\n<h2 id="文件读写"><a href="#%E6%96%87%E4%BB%B6%E8%AF%BB%E5%86%99" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>文件读写</h2>\n<p>读写文件是最常见的 IO 操作。Python 内置了读写文件的函数，用法和 C 是兼容的。</p>\n<h3 id="读文件"><a href="#%E8%AF%BB%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>读文件</h3>\n<p>要以读文件的模式打开一个文件对象，使用 Python 内置的 open() 函数，传入文件名和标示符：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="73083709916053750000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> f = open(\'/Users/michael/test.txt\', \'r\')`, `73083709916053750000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'/Users/michael/test.txt\'</span><span class="token punctuation">,</span> <span class="token string">\'r\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>标示符 ‘r’ 表示读，这样，我们就成功地打开了一个文件。</p>\n<p>如果文件不存在，open() 函数就会抛出一个 IOError 的错误，并且给出错误码和详细的信息告诉你文件不存在：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="52692088767898590000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> f=open(\'/Users/michael/notfound.txt\', \'r\')\nTraceback (most recent call last):\n  File &quot;<stdin>&quot;, line 1, in <module>\nFileNotFoundError: [Errno 2] No such file or directory: \'/Users/michael/notfound.txt\'`, `52692088767898590000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> <span class="token assign-left variable">f</span><span class="token operator">=</span>open<span class="token punctuation">(</span><span class="token string">\'/Users/michael/notfound.txt\'</span>, <span class="token string">\'r\'</span><span class="token punctuation">)</span>\nTraceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span>:\n  File <span class="token string">"&lt;stdin>"</span>, line <span class="token number">1</span>, <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>\nFileNotFoundError: <span class="token punctuation">[</span>Errno <span class="token number">2</span><span class="token punctuation">]</span> No such <span class="token function">file</span> or directory: <span class="token string">\'/Users/michael/notfound.txt\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果文件打开成功，接下来，调用 read() 方法可以一次读取文件的全部内容，Python 把内容读到内存，用一个 str 对象表示：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="6639263492014424000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> f.read()\n\'Hello, world!\'`, `6639263492014424000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token string">\'Hello, world!\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>最后一步是调用 close() 方法关闭文件。文件使用完毕后必须关闭，因为文件对象会占用操作系统的资源，并且操作系统同一时间能打开的文件数量也是有限的：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8888930693604435000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> f.close()`, `8888930693604435000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>由于文件读写时都有可能产生 IOError，一旦出错，后面的 f.close() 就不会调用。所以，为了保证无论是否出错都能正确地关闭文件，我们可以使用 try … finally 来实现：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91238619412159760000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`try:\n    f = open(\'/path/to/file\', \'r\')\n    print(f.read())\nfinally:\n    if f:\n        f.close()`, `91238619412159760000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">try</span><span class="token punctuation">:</span>\n    f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'/path/to/file\'</span><span class="token punctuation">,</span> <span class="token string">\'r\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">finally</span><span class="token punctuation">:</span>\n    <span class="token keyword">if</span> f<span class="token punctuation">:</span>\n        f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是每次都这么写实在太繁琐，所以，Python 引入了 with 语句来自动帮我们调用 close() 方法：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="11149535254703569000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`with open(\'/path/to/file\', \'r\') as f:\n    print(f.read())`, `11149535254703569000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'/path/to/file\'</span><span class="token punctuation">,</span> <span class="token string">\'r\'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>这和前面的 try … finally 是一样的，但是代码更加简洁，并且不必调用 f.close() 方法。</p>\n<p>调用 read() 会一次性读取文件的全部内容，如果文件有 10G，内存就爆了，所以，要保险起见，可以反复调用 read(size) 方法，每次最多读取 size 个字节的内容。另外，调用 readline() 可以每次读取一行内容，调用 readlines() 一次读取所有内容并按行返回 list。因此，要根据需要决定怎么调用。</p>\n<p>如果文件很小，read() 一次性读取最方便；如果不能确定文件大小，反复调用 read(size) 比较保险；如果是配置文件，调用 readlines() 最方便：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27128923994355335000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`for line in f.readlines():\n    print(line.strip()) # 把末尾的 \'\\n\' 删掉`, `27128923994355335000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">for</span> line <span class="token keyword">in</span> f<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span>line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 把末尾的 \'\\n\' 删掉</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h3 id="file-like-object"><a href="#file-like-object" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>file-like Object</h3>\n<p>像 open() 函数返回的这种有个 read() 方法的对象，在 Python 中统称为 file-like Object。除了 file 外，还可以是内存的字节流，网络流，自定义流等等。file-like Object 不要求从特定类继承，只要写个 read() 方法就行。</p>\n<p>StringIO 就是在内存中创建的 file-like Object，常用作临时缓冲。</p>\n<h3 id="二进制文件"><a href="#%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>二进制文件</h3>\n<p>前面讲的默认都是读取文本文件，并且是 UTF-8 编码的文本文件。要读取二进制文件，比如图片、视频等等，用 ‘rb’ 模式打开文件即可：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26248877432139973000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> f = open(\'/Users/michael/test.jpg\', \'rb\')\n>>> f.read()\nb\'\\xff\\xd8\\xff\\xe1\\x00\\x18Exif\\x00\\x00...\' # 十六进制表示的字节`, `26248877432139973000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'/Users/michael/test.jpg\'</span><span class="token punctuation">,</span> <span class="token string">\'rb\'</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token string">b\'\\xff\\xd8\\xff\\xe1\\x00\\x18Exif\\x00\\x00...\'</span> <span class="token comment"># 十六进制表示的字节</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<h3 id="字符编码-1"><a href="#%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>字符编码</h3>\n<p>要读取非 UTF-8 编码的文本文件，需要给 open() 函数传入 encoding 参数，例如，读取 GBK 编码的文件：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="96277714113653370000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> f = open(\'/Users/michael/gbk.txt\', \'r\', encoding=\'gbk\')\n>>> f.read()\n\'测试\'`, `96277714113653370000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'/Users/michael/gbk.txt\'</span><span class="token punctuation">,</span> <span class="token string">\'r\'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">\'gbk\'</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token string">\'测试\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>遇到有些编码不规范的文件，你可能会遇到 UnicodeDecodeError，因为在文本文件中可能夹杂了一些非法编码的字符。遇到这种情况，open() 函数还接收一个 errors 参数，表示如果遇到编码错误后如何处理。最简单的方式是直接忽略：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="9909446559712776000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> f = open(\'/Users/michael/gbk.txt\', \'r\', encoding=\'gbk\', errors=\'ignore\')`, `9909446559712776000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'/Users/michael/gbk.txt\'</span><span class="token punctuation">,</span> <span class="token string">\'r\'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">\'gbk\'</span><span class="token punctuation">,</span> errors<span class="token operator">=</span><span class="token string">\'ignore\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<h3 id="写文件"><a href="#%E5%86%99%E6%96%87%E4%BB%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>写文件</h3>\n<p>写文件和读文件是一样的，唯一区别是调用 open() 函数时，传入标识符 ‘w’ 或者 ‘wb’ 表示写文本文件或写二进制文件：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29384036752220920000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> f = open(\'/Users/michael/test.txt\', \'w\')\n>>> f.write(\'Hello, world!\')\n>>> f.close()`, `29384036752220920000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'/Users/michael/test.txt\'</span><span class="token punctuation">,</span> <span class="token string">\'w\'</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">\'Hello, world!\'</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>你可以反复调用 write() 来写入文件，但是务必要调用 f.close() 来关闭文件。当我们写文件时，操作系统往往不会立刻把数据写入磁盘，而是放到内存缓存起来，空闲的时候再慢慢写入。只有调用 close() 方法时，操作系统才保证把没有写入的数据全部写入磁盘。忘记调用 close() 的后果是数据可能只写了一部分到磁盘，剩下的丢失了。所以，还是用 with 语句来得保险：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="48244610535378895000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`with open(\'/Users/michael/test.txt\', \'w\') as f:\n    f.write(\'Hello, world!\')`, `48244610535378895000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'/Users/michael/test.txt\'</span><span class="token punctuation">,</span> <span class="token string">\'w\'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>\n    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">\'Hello, world!\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>要写入特定编码的文本文件，请给 open() 函数传入 encoding 参数，将字符串自动转换成指定编码。</p>\n<p>细心的童鞋会发现，以 ‘w’ 模式写入文件时，如果文件已存在，会直接覆盖（相当于删掉后新写入一个文件）。如果我们希望追加到文件末尾怎么办？可以传入 ‘a’ 以追加（append）模式写入。</p>\n<p>所有模式的定义及含义可以参考 Python 的官方<a href="https://docs.python.org/3/library/functions.html#open" target="_blank" rel="nofollow noreferrer noopener">文档</a>。</p>\n<h3 id="小结-15"><a href="#%E5%B0%8F%E7%BB%93-15" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>在 Python 中，文件读写是通过 open() 函数打开的文件对象完成的。使用 with 语句操作文件 IO 是个好习惯。</p>\n<h2 id="stringio-和-bytesio"><a href="#stringio-%E5%92%8C-bytesio" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>StringIO 和 BytesIO</h2>\n<h3 id="stringio"><a href="#stringio" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>StringIO</h3>\n<p>很多时候，数据读写不一定是文件，也可以在内存中读写。</p>\n<p>StringIO 顾名思义就是在内存中读写 str。</p>\n<p>要把 str 写入 StringIO，我们需要先创建一个 StringIO，然后，像文件一样写入即可：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89414920567493510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> from io import StringIO\n>>> f = StringIO()\n>>> f.write(\'hello\')\n5\n>>> f.write(\' \')\n1\n>>> f.write(\'world!\')\n6\n>>> print(f.getvalue())\nhello world!`, `89414920567493510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> io <span class="token keyword">import</span> StringIO\n<span class="token operator">>></span><span class="token operator">></span> f <span class="token operator">=</span> StringIO<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">\'hello\'</span><span class="token punctuation">)</span>\n<span class="token number">5</span>\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">\' \'</span><span class="token punctuation">)</span>\n<span class="token number">1</span>\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">\'world!\'</span><span class="token punctuation">)</span>\n<span class="token number">6</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>getvalue<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\nhello world!</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>getvalue() 方法用于获得写入后的 str。</p>\n<p>要读取 StringIO，可以用一个 str 初始化 StringIO，然后，像读文件一样读取：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22173406884115976000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> from io import StringIO\n>>> f = StringIO(\'Hello!\\nHi!\\nGoodbye!\')\n>>> while True:\n...     s = f.readline()\n...     if s == \'\':\n...         break\n...     print(s.strip())\n...\nHello!\nHi!\nGoodbye!`, `22173406884115976000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> io <span class="token keyword">import</span> StringIO\n<span class="token operator">>></span><span class="token operator">></span> f <span class="token operator">=</span> StringIO<span class="token punctuation">(</span><span class="token string">\'Hello!\\nHi!\\nGoodbye!\'</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     s <span class="token operator">=</span> f<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">if</span> s <span class="token operator">==</span> <span class="token string">\'\'</span><span class="token punctuation">:</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">break</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\nHello!\nHi!\nGoodbye!</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="bytesio"><a href="#bytesio" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>BytesIO</h3>\n<p>StringIO 操作的只能是 str，如果要操作二进制数据，就需要使用 BytesIO。</p>\n<p>BytesIO 实现了在内存中读写 bytes，我们创建一个 BytesIO，然后写入一些 bytes：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14232715103818938000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> from io import BytesIO\n>>> f = BytesIO()\n>>> f.write(\'中文\'.encode(\'utf-8\'))\n6\n>>> print(f.getvalue())\nb\'\\xe4\\xb8\\xad\\xe6\\x96\\x87\'`, `14232715103818938000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> io <span class="token keyword">import</span> BytesIO\n<span class="token operator">>></span><span class="token operator">></span> f <span class="token operator">=</span> BytesIO<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">\'中文\'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">\'utf-8\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token number">6</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>getvalue<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token string">b\'\\xe4\\xb8\\xad\\xe6\\x96\\x87\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>请注意，写入的不是 str，而是经过 UTF-8 编码的 bytes。</p>\n<p>和 StringIO 类似，可以用一个 bytes 初始化 BytesIO，然后，像读文件一样读取：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28125242339751600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> from io import BytesIO\n>>> f = BytesIO(b\'\\xe4\\xb8\\xad\\xe6\\x96\\x87\')\n>>> f.read()\nb\'\\xe4\\xb8\\xad\\xe6\\x96\\x87\'`, `28125242339751600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> io <span class="token keyword">import</span> BytesIO\n<span class="token operator">>></span><span class="token operator">></span> f <span class="token operator">=</span> BytesIO<span class="token punctuation">(</span><span class="token string">b\'\\xe4\\xb8\\xad\\xe6\\x96\\x87\'</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token string">b\'\\xe4\\xb8\\xad\\xe6\\x96\\x87\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="小结-16"><a href="#%E5%B0%8F%E7%BB%93-16" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>StringIO 和 BytesIO 是在内存中操作 str 和 bytes 的方法，使得和读写文件具有一致的接口。</p>\n<h2 id="操作文件和目录"><a href="#%E6%93%8D%E4%BD%9C%E6%96%87%E4%BB%B6%E5%92%8C%E7%9B%AE%E5%BD%95" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>操作文件和目录</h2>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78476993907110850000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> import os\n>>> os.name # 操作系统类型\n\'posix\'`, `78476993907110850000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> os\n<span class="token operator">>></span><span class="token operator">></span> os<span class="token punctuation">.</span>name <span class="token comment"># 操作系统类型</span>\n<span class="token string">\'posix\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>如果是 posix，说明系统是 Linux、Unix 或 Mac OS X，如果是 nt，就是 Windows 系统。</p>\n<p>要获取详细的系统信息，可以调用 uname() 函数：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="74464264520709180000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> os.uname()\nposix.uname_result(sysname=\'Darwin\', nodename=\'MichaelMacPro.local\', release=\'14.3.0\', version=\'Darwin Kernel Version 14.3.0: Mon Mar 23 11:59:05 PDT 2015; root:xnu-2782.20.48~5/RELEASE_X86_64\', machine=\'x86_64\')`, `74464264520709180000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> os<span class="token punctuation">.</span>uname<span class="token punctuation">(</span><span class="token punctuation">)</span>\nposix<span class="token punctuation">.</span>uname_result<span class="token punctuation">(</span>sysname<span class="token operator">=</span><span class="token string">\'Darwin\'</span><span class="token punctuation">,</span> nodename<span class="token operator">=</span><span class="token string">\'MichaelMacPro.local\'</span><span class="token punctuation">,</span> release<span class="token operator">=</span><span class="token string">\'14.3.0\'</span><span class="token punctuation">,</span> version<span class="token operator">=</span><span class="token string">\'Darwin Kernel Version 14.3.0: Mon Mar 23 11:59:05 PDT 2015; root:xnu-2782.20.48~5/RELEASE_X86_64\'</span><span class="token punctuation">,</span> machine<span class="token operator">=</span><span class="token string">\'x86_64\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>注意 uname() 函数在 Windows 上不提供，也就是说，os 模块的某些函数是跟操作系统相关的。</p>\n<h3 id="环境变量"><a href="#%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>环境变量</h3>\n<p>在操作系统中定义的环境变量，全部保存在 os.environ 这个变量中，可以直接查看：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95970082243409220000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> os.environ\nenviron({\'VERSIONER_PYTHON_PREFER_32_BIT\': \'no\', \'TERM_PROGRAM_VERSION\': \'326\', \'LOGNAME\': \'michael\', \'USER\': \'michael\', \'PATH\': \'/usr/bin:/bin:/usr/sbin:/sbin:/usr/local/bin:/opt/X11/bin:/usr/local/mysql/bin\', ...})`, `95970082243409220000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> os<span class="token punctuation">.</span>environ\nenviron<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">\'VERSIONER_PYTHON_PREFER_32_BIT\'</span><span class="token punctuation">:</span> <span class="token string">\'no\'</span><span class="token punctuation">,</span> <span class="token string">\'TERM_PROGRAM_VERSION\'</span><span class="token punctuation">:</span> <span class="token string">\'326\'</span><span class="token punctuation">,</span> <span class="token string">\'LOGNAME\'</span><span class="token punctuation">:</span> <span class="token string">\'michael\'</span><span class="token punctuation">,</span> <span class="token string">\'USER\'</span><span class="token punctuation">:</span> <span class="token string">\'michael\'</span><span class="token punctuation">,</span> <span class="token string">\'PATH\'</span><span class="token punctuation">:</span> <span class="token string">\'/usr/bin:/bin:/usr/sbin:/sbin:/usr/local/bin:/opt/X11/bin:/usr/local/mysql/bin\'</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>要获取某个环境变量的值，可以调用 os.environ.get(‘key’)：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92420067946120300000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> os.environ.get(\'PATH\')\n\'/usr/bin:/bin:/usr/sbin:/sbin:/usr/local/bin:/opt/X11/bin:/usr/local/mysql/bin\'\n>>> os.environ.get(\'x\', \'default\')\n\'default\'`, `92420067946120300000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'PATH\'</span><span class="token punctuation">)</span>\n<span class="token string">\'/usr/bin:/bin:/usr/sbin:/sbin:/usr/local/bin:/opt/X11/bin:/usr/local/mysql/bin\'</span>\n<span class="token operator">>></span><span class="token operator">></span> os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">\'x\'</span><span class="token punctuation">,</span> <span class="token string">\'default\'</span><span class="token punctuation">)</span>\n<span class="token string">\'default\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="操作文件和目录-1"><a href="#%E6%93%8D%E4%BD%9C%E6%96%87%E4%BB%B6%E5%92%8C%E7%9B%AE%E5%BD%95-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>操作文件和目录</h3>\n<p>操作文件和目录的函数一部分放在 os 模块中，一部分放在 os.path 模块中，这一点要注意一下。查看、创建和删除目录可以这么调用：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="1661060235652511700"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 查看当前目录的绝对路径:\n>>> os.path.abspath(\'.\')\n\'/Users/michael\'\n# 在某个目录下创建一个新目录，首先把新目录的完整路径表示出来:\n>>> os.path.join(\'/Users/michael\', \'testdir\')\n\'/Users/michael/testdir\'\n# 然后创建一个目录:\n>>> os.mkdir(\'/Users/michael/testdir\')\n# 删掉一个目录:\n>>> os.rmdir(\'/Users/michael/testdir\')`, `1661060235652511700`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment"># 查看当前目录的绝对路径:</span>\n<span class="token operator">>></span><span class="token operator">></span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span><span class="token string">\'.\'</span><span class="token punctuation">)</span>\n<span class="token string">\'/Users/michael\'</span>\n<span class="token comment"># 在某个目录下创建一个新目录，首先把新目录的完整路径表示出来:</span>\n<span class="token operator">>></span><span class="token operator">></span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">\'/Users/michael\'</span><span class="token punctuation">,</span> <span class="token string">\'testdir\'</span><span class="token punctuation">)</span>\n<span class="token string">\'/Users/michael/testdir\'</span>\n<span class="token comment"># 然后创建一个目录:</span>\n<span class="token operator">>></span><span class="token operator">></span> os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span><span class="token string">\'/Users/michael/testdir\'</span><span class="token punctuation">)</span>\n<span class="token comment"># 删掉一个目录:</span>\n<span class="token operator">>></span><span class="token operator">></span> os<span class="token punctuation">.</span>rmdir<span class="token punctuation">(</span><span class="token string">\'/Users/michael/testdir\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>把两个路径合成一个时，不要直接拼字符串，而要通过 os.path.join() 函数，这样可以正确处理不同操作系统的路径分隔符。在 Linux/Unix/Mac 下，os.path.join() 返回这样的字符串：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59950322427678660000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`part-1/part-2`, `59950322427678660000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">part-1/part-2</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>而 Windows 下会返回这样的字符串：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="76505247399462960000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`part-1\\part-2`, `76505247399462960000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">part-1\\part-2</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>同样的道理，要拆分路径时，也不要直接去拆字符串，而要通过 os.path.split() 函数，这样可以把一个路径拆分为两部分，后一部分总是最后级别的目录或文件名：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="46036811875457425000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> os.path.split(\'/Users/michael/testdir/file.txt\')\n(\'/Users/michael/testdir\', \'file.txt\')`, `46036811875457425000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">\'/Users/michael/testdir/file.txt\'</span><span class="token punctuation">)</span>\n<span class="token punctuation">(</span><span class="token string">\'/Users/michael/testdir\'</span><span class="token punctuation">,</span> <span class="token string">\'file.txt\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>os.path.splitext() 可以直接让你得到文件扩展名，很多时候非常方便：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89178490299081130000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> os.path.splitext(\'/path/to/file.txt\')\n(\'/path/to/file\', \'.txt\')`, `89178490299081130000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>splitext<span class="token punctuation">(</span><span class="token string">\'/path/to/file.txt\'</span><span class="token punctuation">)</span>\n<span class="token punctuation">(</span><span class="token string">\'/path/to/file\'</span><span class="token punctuation">,</span> <span class="token string">\'.txt\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>这些合并、拆分路径的函数并不要求目录和文件要真实存在，它们只对字符串进行操作。</p>\n<p>文件操作使用下面的函数。假定当前目录下有一个 test.txt 文件：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="78522491004934650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# 对文件重命名:\n>>> os.rename(\'test.txt\', \'test.py\')\n# 删掉文件:\n>>> os.remove(\'test.py\')`, `78522491004934650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment"># 对文件重命名:</span>\n<span class="token operator">>></span><span class="token operator">></span> os<span class="token punctuation">.</span>rename<span class="token punctuation">(</span><span class="token string">\'test.txt\'</span><span class="token punctuation">,</span> <span class="token string">\'test.py\'</span><span class="token punctuation">)</span>\n<span class="token comment"># 删掉文件:</span>\n<span class="token operator">>></span><span class="token operator">></span> os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span><span class="token string">\'test.py\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是复制文件的函数居然在 os 模块中不存在！原因是复制文件并非由操作系统提供的系统调用。理论上讲，我们通过上一节的读写文件可以完成文件复制，只不过要多写很多代码。</p>\n<p>幸运的是 shutil 模块提供了 copyfile() 的函数，你还可以在 shutil 模块中找到很多实用函数，它们可以看做是 os 模块的补充。</p>\n<p>最后看看如何利用 Python 的特性来过滤文件。比如我们要列出当前目录下的所有目录，只需要一行代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="67508742492192630000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> [x for x in os.listdir(\'.\') if os.path.isdir(x)]\n[\'.lein\', \'.local\', \'.m2\', \'.npm\', \'.ssh\', \'.Trash\', \'.vim\', \'Applications\', \'Desktop\', ...]`, `67508742492192630000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">[</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span><span class="token string">\'.\'</span><span class="token punctuation">)</span> <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isdir<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token string">\'.lein\'</span><span class="token punctuation">,</span> <span class="token string">\'.local\'</span><span class="token punctuation">,</span> <span class="token string">\'.m2\'</span><span class="token punctuation">,</span> <span class="token string">\'.npm\'</span><span class="token punctuation">,</span> <span class="token string">\'.ssh\'</span><span class="token punctuation">,</span> <span class="token string">\'.Trash\'</span><span class="token punctuation">,</span> <span class="token string">\'.vim\'</span><span class="token punctuation">,</span> <span class="token string">\'Applications\'</span><span class="token punctuation">,</span> <span class="token string">\'Desktop\'</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>要列出所有的 .py 文件，也只需一行代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17546984743723338000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> [x for x in os.listdir(\'.\') if os.path.isfile(x) and os.path.splitext(x)[1]==\'.py\']\n[\'apis.py\', \'config.py\', \'models.py\', \'pymonitor.py\', \'test_db.py\', \'urls.py\', \'wsgiapp.py\']`, `17546984743723338000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">[</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span><span class="token string">\'.\'</span><span class="token punctuation">)</span> <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isfile<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">and</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>splitext<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token string">\'.py\'</span><span class="token punctuation">]</span>\n<span class="token punctuation">[</span><span class="token string">\'apis.py\'</span><span class="token punctuation">,</span> <span class="token string">\'config.py\'</span><span class="token punctuation">,</span> <span class="token string">\'models.py\'</span><span class="token punctuation">,</span> <span class="token string">\'pymonitor.py\'</span><span class="token punctuation">,</span> <span class="token string">\'test_db.py\'</span><span class="token punctuation">,</span> <span class="token string">\'urls.py\'</span><span class="token punctuation">,</span> <span class="token string">\'wsgiapp.py\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>是不是非常简洁？</p>\n<h3 id="小结-17"><a href="#%E5%B0%8F%E7%BB%93-17" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>Python 的 os 模块封装了操作系统的目录和文件操作，要注意这些函数有的在 os 模块中，有的在 os.path 模块中。</p>\n<h2 id="序列化"><a href="#%E5%BA%8F%E5%88%97%E5%8C%96" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>序列化</h2>\n<p>在程序运行的过程中，所有的变量都是在内存中，比如，定义一个 dict：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="24090544283196723000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`d = dict(name=\'Bob\', age=20, score=88)`, `24090544283196723000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">d <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">\'Bob\'</span><span class="token punctuation">,</span> age<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> score<span class="token operator">=</span><span class="token number">88</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>可以随时修改变量，比如把 name 改成 ‘Bill’，但是一旦程序结束，变量所占用的内存就被操作系统全部回收。如果没有把修改后的 ‘Bill’ 存储到磁盘上，下次重新运行程序，变量又被初始化为 ‘Bob’。</p>\n<p>我们把变量从内存中变成可存储或传输的过程称之为序列化，在 Python 中叫 pickling，在其他语言中也被称之为 serialization，marshalling，flattening 等等，都是一个意思。</p>\n<p>序列化之后，就可以把序列化后的内容写入磁盘，或者通过网络传输到别的机器上。</p>\n<p>反过来，把变量内容从序列化的对象重新读到内存里称之为反序列化，即 unpickling。</p>\n<p>Python 提供了 pickle 模块来实现序列化。</p>\n<p>首先，我们尝试把一个对象序列化并写入文件：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18065346346236312000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> import pickle\n>>> d = dict(name=\'Bob\', age=20, score=88)\n>>> pickle.dumps(d)\nb\'\\x80\\x03}q\\x00(X\\x03\\x00\\x00\\x00ageq\\x01K\\x14X\\x05\\x00\\x00\\x00scoreq\\x02KXX\\x04\\x00\\x00\\x00nameq\\x03X\\x03\\x00\\x00\\x00Bobq\\x04u.\'`, `18065346346236312000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> pickle\n<span class="token operator">>></span><span class="token operator">></span> d <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">\'Bob\'</span><span class="token punctuation">,</span> age<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> score<span class="token operator">=</span><span class="token number">88</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> pickle<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>d<span class="token punctuation">)</span>\n<span class="token string">b\'\\x80\\x03}q\\x00(X\\x03\\x00\\x00\\x00ageq\\x01K\\x14X\\x05\\x00\\x00\\x00scoreq\\x02KXX\\x04\\x00\\x00\\x00nameq\\x03X\\x03\\x00\\x00\\x00Bobq\\x04u.\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>pickle.dumps() 方法把任意对象序列化成一个 bytes，然后，就可以把这个 bytes 写入文件。或者用另一个方法 pickle.dump() 直接把对象序列化后写入一个 file-like Object：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="34967653795764654000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> f = open(\'dump.txt\', \'wb\')\n>>> pickle.dump(d, f)\n>>> f.close()`, `34967653795764654000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'dump.txt\'</span><span class="token punctuation">,</span> <span class="token string">\'wb\'</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> pickle<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>d<span class="token punctuation">,</span> f<span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>看看写入的 dump.txt 文件，一堆乱七八糟的内容，这些都是 Python 保存的对象内部信息。</p>\n<p>当我们要把对象从磁盘读到内存时，可以先把内容读到一个 bytes，然后用 pickle.loads() 方法反序列化出对象，也可以直接用 pickle.load() 方法从一个 file-like Object 中直接反序列化出对象。我们打开另一个 Python 命令行来反序列化刚才保存的对象：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41548219253607965000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> f = open(\'dump.txt\', \'rb\')\n>>> d = pickle.load(f)\n>>> f.close()\n>>> d\n{\'age\': 20, \'score\': 88, \'name\': \'Bob\'}`, `41548219253607965000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'dump.txt\'</span><span class="token punctuation">,</span> <span class="token string">\'rb\'</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> d <span class="token operator">=</span> pickle<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> d\n<span class="token punctuation">{</span><span class="token string">\'age\'</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">\'score\'</span><span class="token punctuation">:</span> <span class="token number">88</span><span class="token punctuation">,</span> <span class="token string">\'name\'</span><span class="token punctuation">:</span> <span class="token string">\'Bob\'</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>变量的内容又回来了！</p>\n<p>当然，这个变量和原来的变量是完全不相干的对象，它们只是内容相同而已。</p>\n<p>Pickle 的问题和所有其他编程语言特有的序列化问题一样，就是它只能用于 Python，并且可能不同版本的 Python 彼此都不兼容，因此，只能用 Pickle 保存那些不重要的数据，不能成功地反序列化也没关系。</p>\n<h3 id="json"><a href="#json" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>JSON</h3>\n<p>如果我们要在不同的编程语言之间传递对象，就必须把对象序列化为标准格式，比如 XML，但更好的方法是序列化为 JSON，因为 JSON 表示出来就是一个字符串，可以被所有语言读取，也可以方便地存储到磁盘或者通过网络传输。JSON 不仅是标准格式，并且比 XML 更快，而且可以直接在 Web 页面中读取，非常方便。</p>\n<p>JSON 表示的对象就是标准的 JavaScript 语言的对象，JSON 和 Python 内置的数据类型对应如下：</p>\n<table>\n<thead>\n<tr>\n<th align="left">JSON 类型</th>\n<th align="left">Python 类型</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align="left">{}</td>\n<td align="left">dict</td>\n</tr>\n<tr>\n<td align="left">[]</td>\n<td align="left">list</td>\n</tr>\n<tr>\n<td align="left">“string”</td>\n<td align="left">str</td>\n</tr>\n<tr>\n<td align="left">1234.56</td>\n<td align="left">int 或 float</td>\n</tr>\n<tr>\n<td align="left">true/false</td>\n<td align="left">True/False</td>\n</tr>\n<tr>\n<td align="left">null</td>\n<td align="left">None</td>\n</tr>\n</tbody>\n</table>\n<p>Python 内置的 json 模块提供了非常完善的 Python 对象到 JSON 格式的转换。我们先看看如何把 Python 对象变成一个 JSON：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80040808460318470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> import json\n>>> d = dict(name=\'Bob\', age=20, score=88)\n>>> json.dumps(d)\n\'{&quot;age&quot;: 20, &quot;score&quot;: 88, &quot;name&quot;: &quot;Bob&quot;}\'`, `80040808460318470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> json\n<span class="token operator">>></span><span class="token operator">></span> d <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">\'Bob\'</span><span class="token punctuation">,</span> age<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> score<span class="token operator">=</span><span class="token number">88</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>d<span class="token punctuation">)</span>\n<span class="token string">\'{"age": 20, "score": 88, "name": "Bob"}\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>dumps() 方法返回一个 str，内容就是标准的 JSON。类似的，dump() 方法可以直接把 JSON 写入一个 file-like Object。</p>\n<p>要把 JSON 反序列化为 Python 对象，用 loads() 或者对应的 load() 方法，前者把 JSON 的字符串反序列化，后者从 file-like Object 中读取字符串并反序列化：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="593047015248471300"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> json_str = \'{&quot;age&quot;: 20, &quot;score&quot;: 88, &quot;name&quot;: &quot;Bob&quot;}\'\n>>> json.loads(json_str)\n{\'age\': 20, \'score\': 88, \'name\': \'Bob\'}`, `593047015248471300`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> json_str <span class="token operator">=</span> <span class="token string">\'{"age": 20, "score": 88, "name": "Bob"}\'</span>\n<span class="token operator">>></span><span class="token operator">></span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>json_str<span class="token punctuation">)</span>\n<span class="token punctuation">{</span><span class="token string">\'age\'</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">\'score\'</span><span class="token punctuation">:</span> <span class="token number">88</span><span class="token punctuation">,</span> <span class="token string">\'name\'</span><span class="token punctuation">:</span> <span class="token string">\'Bob\'</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>由于 JSON 标准规定 JSON 编码是 UTF-8，所以我们总是能正确地在 Python 的 str 与 JSON 的字符串之间转换。</p>\n<h3 id="json-进阶"><a href="#json-%E8%BF%9B%E9%98%B6" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>JSON 进阶</h3>\n<p>Python 的 dict 对象可以直接序列化为 JSON 的 {}，不过，很多时候，我们更喜欢用 class 表示对象，比如定义 Student 类，然后序列化：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56891699041010926000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import json\n\nclass Student(object):\n    def __init__(self, name, age, score):\n        self.name = name\n        self.age = age\n        self.score = score\n\ns = Student(\'Bob\', 20, 88)\nprint(json.dumps(s))`, `56891699041010926000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> json\n\n<span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> score<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name\n        self<span class="token punctuation">.</span>age <span class="token operator">=</span> age\n        self<span class="token punctuation">.</span>score <span class="token operator">=</span> score\n\ns <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">\'Bob\'</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">88</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>运行代码，毫不留情地得到一个 TypeError：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="65774762749077590000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Traceback (most recent call last):\n  ...\nTypeError: <__main__.Student object at 0x10603cc50> is not JSON serializable`, `65774762749077590000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span>:\n  <span class="token punctuation">..</span>.\nTypeError: <span class="token operator">&lt;</span>__main__.Student object at 0x10603cc5<span class="token operator"><span class="token file-descriptor important">0</span>></span> is not JSON serializable</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>错误的原因是 Student 对象不是一个可序列化为 JSON 的对象。</p>\n<p>如果连 class 的实例对象都无法序列化为 JSON，这肯定不合理！</p>\n<p>别急，我们仔细看看 dumps() 方法的参数列表，可以发现，除了第一个必须的 obj 参数外，dumps() 方法还提供了一大堆的可选<a href="https://docs.python.org/3/library/json.html#json.dumps" target="_blank" rel="nofollow noreferrer noopener">参数</a></p>\n<p>这些可选参数就是让我们来定制 JSON 序列化。前面的代码之所以无法把 Student 类实例序列化为 JSON，是因为默认情况下，dumps() 方法不知道如何将 Student 实例变为一个 JSON 的 {} 对象。</p>\n<p>可选参数 default 就是把任意一个对象变成一个可序列为 JSON 的对象，我们只需要为 Student 专门写一个转换函数，再把函数传进去即可：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="95621947882697600000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def student2dict(std):\n    return {\n        \'name\': std.name,\n        \'age\': std.age,\n        \'score\': std.score\n    }`, `95621947882697600000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">student2dict</span><span class="token punctuation">(</span>std<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> <span class="token punctuation">{</span>\n        <span class="token string">\'name\'</span><span class="token punctuation">:</span> std<span class="token punctuation">.</span>name<span class="token punctuation">,</span>\n        <span class="token string">\'age\'</span><span class="token punctuation">:</span> std<span class="token punctuation">.</span>age<span class="token punctuation">,</span>\n        <span class="token string">\'score\'</span><span class="token punctuation">:</span> std<span class="token punctuation">.</span>score\n    <span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这样，Student 实例首先被 student2dict() 函数转换成 dict，然后再被顺利序列化为 JSON：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="86125023112695740000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> print(json.dumps(s, default=student2dict))\n{&quot;age&quot;: 20, &quot;name&quot;: &quot;Bob&quot;, &quot;score&quot;: 88}`, `86125023112695740000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>s<span class="token punctuation">,</span> default<span class="token operator">=</span>student2dict<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token punctuation">{</span><span class="token string">"age"</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Bob"</span><span class="token punctuation">,</span> <span class="token string">"score"</span><span class="token punctuation">:</span> <span class="token number">88</span><span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>不过，下次如果遇到一个 Teacher 类的实例，照样无法序列化为 JSON。我们可以偷个懒，把任意 class 的实例变为 dict：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="14118209835568130000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`print(json.dumps(s, default=lambda obj: obj.__dict__))`, `14118209835568130000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">print</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>s<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token keyword">lambda</span> obj<span class="token punctuation">:</span> obj<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>因为通常 class 的实例都有一个 <code class="language-text">__dict__</code> 属性，它就是一个 dict，用来存储实例变量。也有少数例外，比如定义了 <code class="language-text">__slots__</code> 的 class。</p>\n<p>同样的道理，如果我们要把 JSON 反序列化为一个 Student 对象实例，loads() 方法首先转换出一个 dict 对象，然后，我们传入的 object_hook 函数负责把 dict 转换为 Student 实例：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="8601889932397455000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def dict2student(d):\n    return Student(d[\'name\'], d[\'age\'], d[\'score\'])`, `8601889932397455000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">dict2student</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">return</span> Student<span class="token punctuation">(</span>d<span class="token punctuation">[</span><span class="token string">\'name\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> d<span class="token punctuation">[</span><span class="token string">\'age\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> d<span class="token punctuation">[</span><span class="token string">\'score\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>运行结果如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89004779610599470000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> json_str = \'{&quot;age&quot;: 20, &quot;score&quot;: 88, &quot;name&quot;: &quot;Bob&quot;}\'\n>>> print(json.loads(json_str, object_hook=dict2student))\n<__main__.Student object at 0x10cd3c190>`, `89004779610599470000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> json_str <span class="token operator">=</span> <span class="token string">\'{"age": 20, "score": 88, "name": "Bob"}\'</span>\n<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>json_str<span class="token punctuation">,</span> object_hook<span class="token operator">=</span>dict2student<span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token operator">&lt;</span>__main__<span class="token punctuation">.</span>Student <span class="token builtin">object</span> at <span class="token number">0x10cd3c190</span><span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>打印出的是反序列化的 Student 实例对象。</p>\n<h3 id="小结-18"><a href="#%E5%B0%8F%E7%BB%93-18" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>Python 语言特定的序列化模块是 pickle，但如果要把序列化搞得更通用、更符合 Web 标准，就可以使用 json 模块。</p>\n<p>json 模块的 dumps() 和 loads() 函数是定义得非常好的接口的典范。当我们使用时，只需要传入一个必须的参数。但是，当默认的序列化或反序列机制不满足我们的要求时，我们又可以传入更多的参数来定制序列化或反序列化的规则，既做到了接口简单易用，又做到了充分的扩展性和灵活性。</p>\n<h1 id="进程和线程"><a href="#%E8%BF%9B%E7%A8%8B%E5%92%8C%E7%BA%BF%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>进程和线程</h1>\n<h2 id="多进程"><a href="#%E5%A4%9A%E8%BF%9B%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>多进程</h2>\n<p>要让 Python 程序实现多进程（multiprocessing），我们先了解操作系统的相关知识。</p>\n<p>Unix/Linux 操作系统提供了一个 fork() 系统调用，它非常特殊。普通的函数调用，调用一次，返回一次，但是 fork() 调用一次，返回两次，因为操作系统自动把当前进程（称为父进程）复制了一份（称为子进程），然后，分别在父进程和子进程内返回。</p>\n<p>子进程永远返回 0，而父进程返回子进程的 ID。这样做的理由是，一个父进程可以 fork 出很多子进程，所以，父进程要记下每个子进程的 ID，而子进程只需要调用 getppid() 就可以拿到父进程的 ID。</p>\n<p>Python 的 os 模块封装了常见的系统调用，其中就包括 fork，可以在 Python 程序中轻松创建子进程：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85728546258941770000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import os\n\nprint(\'Process (%s) start...\' % os.getpid())\n# Only works on Unix/Linux/Mac:\npid = os.fork()\nif pid == 0:\n    print(\'I am child process (%s) and my parent is %s.\' % (os.getpid(), os.getppid()))\nelse:\n    print(\'I (%s) just created a child process (%s).\' % (os.getpid(), pid))`, `85728546258941770000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> os\n\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Process (%s) start...\'</span> <span class="token operator">%</span> os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token comment"># Only works on Unix/Linux/Mac:</span>\npid <span class="token operator">=</span> os<span class="token punctuation">.</span>fork<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">if</span> pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'I am child process (%s) and my parent is %s.\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>getppid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'I (%s) just created a child process (%s).\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>运行结果如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="85125921608461650000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Process (876) start...\nI (876) just created a child process (877).\nI am child process (877) and my parent is 876.`, `85125921608461650000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">Process <span class="token punctuation">(</span><span class="token number">876</span><span class="token punctuation">)</span> start<span class="token punctuation">..</span>.\nI <span class="token punctuation">(</span><span class="token number">876</span><span class="token punctuation">)</span> just created a child process <span class="token punctuation">(</span><span class="token number">877</span><span class="token punctuation">)</span>.\nI am child process <span class="token punctuation">(</span><span class="token number">877</span><span class="token punctuation">)</span> and my parent is <span class="token number">876</span>.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>由于 Windows 没有 fork 调用，上面的代码在 Windows 上无法运行。</p>\n<p>有了 fork 调用，一个进程在接到新任务时就可以复制出一个子进程来处理新任务，常见的 Apache 服务器就是由父进程监听端口，每当有新的 http 请求时，就 fork 出子进程来处理新的 http 请求。</p>\n<h3 id="multiprocessing"><a href="#multiprocessing" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>multiprocessing</h3>\n<p>如果你打算编写多进程的服务程序，Unix/Linux 无疑是正确的选择。由于 Windows 没有 fork 调用，难道在 Windows 上无法用 Python 编写多进程的程序？</p>\n<p>由于 Python 是跨平台的，自然也应该提供一个跨平台的多进程支持。multiprocessing 模块就是跨平台版本的多进程模块。</p>\n<p>multiprocessing 模块提供了一个 Process 类来代表一个进程对象，下面的例子演示了启动一个子进程并等待其结束：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88609574500925180000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from multiprocessing import Process\nimport os\n\n# 子进程要执行的代码\ndef run_proc(name):\n    print(\'Run child process %s (%s)...\' % (name, os.getpid()))\n\nif __name__==\'__main__\':\n    print(\'Parent process %s.\' % os.getpid())\n    p = Process(target=run_proc, args=(\'test\',))\n    print(\'Child process will start.\')\n    p.start()\n    p.join()\n    print(\'Child process end.\')`, `88609574500925180000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process\n<span class="token keyword">import</span> os\n\n<span class="token comment"># 子进程要执行的代码</span>\n<span class="token keyword">def</span> <span class="token function">run_proc</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Run child process %s (%s)...\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">\'__main__\'</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Parent process %s.\'</span> <span class="token operator">%</span> os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    p <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>run_proc<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">\'test\'</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Child process will start.\'</span><span class="token punctuation">)</span>\n    p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    p<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Child process end.\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>执行结果如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12786265082104520000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Parent process 928.\nChild process will start.\nRun child process test (929)...\nProcess end.`, `12786265082104520000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">Parent process <span class="token number">928</span>.\nChild process will start.\nRun child process <span class="token builtin class-name">test</span> <span class="token punctuation">(</span><span class="token number">929</span><span class="token punctuation">)</span><span class="token punctuation">..</span>.\nProcess end.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>创建子进程时，只需要传入一个执行函数和函数的参数，创建一个 Process 实例，用 start() 方法启动，这样创建进程比 fork() 还要简单。</p>\n<p>join() 方法可以等待子进程结束后再继续往下运行，通常用于进程间的同步。</p>\n<h3 id="pool"><a href="#pool" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Pool</h3>\n<p>如果要启动大量的子进程，可以用进程池的方式批量创建子进程：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="92681930193678700000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from multiprocessing import Pool\nimport os, time, random\n\ndef long_time_task(name):\n    print(\'Run task %s (%s)...\' % (name, os.getpid()))\n    start = time.time()\n    time.sleep(random.random() * 3)\n    end = time.time()\n    print(\'Task %s runs %0.2f seconds.\' % (name, (end - start)))\n\nif __name__==\'__main__\':\n    print(\'Parent process %s.\' % os.getpid())\n    p = Pool(4)\n    for i in range(5):\n        p.apply_async(long_time_task, args=(i,))\n    print(\'Waiting for all subprocesses done...\')\n    p.close()\n    p.join()\n    print(\'All subprocesses done.\')`, `92681930193678700000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Pool\n<span class="token keyword">import</span> os<span class="token punctuation">,</span> time<span class="token punctuation">,</span> random\n\n<span class="token keyword">def</span> <span class="token function">long_time_task</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Run task %s (%s)...\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span>\n    end <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Task %s runs %0.2f seconds.\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">\'__main__\'</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Parent process %s.\'</span> <span class="token operator">%</span> os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    p <span class="token operator">=</span> Pool<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>\n    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        p<span class="token punctuation">.</span>apply_async<span class="token punctuation">(</span>long_time_task<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Waiting for all subprocesses done...\'</span><span class="token punctuation">)</span>\n    p<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    p<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'All subprocesses done.\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>执行结果如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="31293898561662090000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Parent process 669.\nWaiting for all subprocesses done...\nRun task 0 (671)...\nRun task 1 (672)...\nRun task 2 (673)...\nRun task 3 (674)...\nTask 2 runs 0.14 seconds.\nRun task 4 (673)...\nTask 1 runs 0.27 seconds.\nTask 3 runs 0.86 seconds.\nTask 0 runs 1.41 seconds.\nTask 4 runs 1.91 seconds.\nAll subprocesses done.`, `31293898561662090000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">Parent process <span class="token number">669</span>.\nWaiting <span class="token keyword">for</span> all subprocesses done<span class="token punctuation">..</span>.\nRun task <span class="token number">0</span> <span class="token punctuation">(</span><span class="token number">671</span><span class="token punctuation">)</span><span class="token punctuation">..</span>.\nRun task <span class="token number">1</span> <span class="token punctuation">(</span><span class="token number">672</span><span class="token punctuation">)</span><span class="token punctuation">..</span>.\nRun task <span class="token number">2</span> <span class="token punctuation">(</span><span class="token number">673</span><span class="token punctuation">)</span><span class="token punctuation">..</span>.\nRun task <span class="token number">3</span> <span class="token punctuation">(</span><span class="token number">674</span><span class="token punctuation">)</span><span class="token punctuation">..</span>.\nTask <span class="token number">2</span> runs <span class="token number">0.14</span> seconds.\nRun task <span class="token number">4</span> <span class="token punctuation">(</span><span class="token number">673</span><span class="token punctuation">)</span><span class="token punctuation">..</span>.\nTask <span class="token number">1</span> runs <span class="token number">0.27</span> seconds.\nTask <span class="token number">3</span> runs <span class="token number">0.86</span> seconds.\nTask <span class="token number">0</span> runs <span class="token number">1.41</span> seconds.\nTask <span class="token number">4</span> runs <span class="token number">1.91</span> seconds.\nAll subprocesses done.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>代码解读：</p>\n<p>对 Pool 对象调用 join() 方法会等待所有子进程执行完毕，调用 join() 之前必须先调用 close()，调用 close() 之后就不能继续添加新的 Process 了。</p>\n<p>请注意输出的结果，task 0，1，2，3 是立刻执行的，而 task 4 要等待前面某个 task 完成后才执行，这是因为 Pool 的默认大小在我的电脑上是 4，因此，最多同时执行 4 个进程。这是 Pool 有意设计的限制，并不是操作系统的限制。如果改成：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42870295773420675000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`p = Pool(5)`, `42870295773420675000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">p = Pool(5)</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>就可以同时跑 5 个进程。</p>\n<p>由于 Pool 的默认大小是 CPU 的核数，如果你不幸拥有 8 核 CPU，你要提交至少 9 个子进程才能看到上面的等待效果。</p>\n<h3 id="子进程"><a href="#%E5%AD%90%E8%BF%9B%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>子进程</h3>\n<p>很多时候，子进程并不是自身，而是一个外部进程。我们创建了子进程后，还需要控制子进程的输入和输出。</p>\n<p>subprocess 模块可以让我们非常方便地启动一个子进程，然后控制其输入和输出。</p>\n<p>下面的例子演示了如何在 Python 代码中运行命令 nslookup www.python.org，这和命令行直接运行的效果是一样的：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="61475151766849450000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import subprocess\n\nprint(\'\\$ nslookup www.python.org\')\nr = subprocess.call([\'nslookup\', \'www.python.org\'])\nprint(\'Exit code:\', r)`, `61475151766849450000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> subprocess\n\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'$ nslookup www.python.org\'</span><span class="token punctuation">)</span>\nr <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>call<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'nslookup\'</span><span class="token punctuation">,</span> <span class="token string">\'www.python.org\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Exit code:\'</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>运行结果：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80224735895886250000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ nslookup www.python.org\nServer:  192.168.19.4\nAddress: 192.168.19.4#53\n\nNon-authoritative answer:\nwww.python.org canonical name = python.map.fastly.net.\nName: python.map.fastly.net\nAddress: 199.27.79.223\n\nExit code: 0`, `80224735895886250000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">nslookup</span> www.python.org\nServer:  <span class="token number">192.168</span>.19.4\nAddress: <span class="token number">192.168</span>.19.4<span class="token comment">#53</span>\n\nNon-authoritative answer:\nwww.python.org canonical name <span class="token operator">=</span> python.map.fastly.net.\nName: python.map.fastly.net\nAddress: <span class="token number">199.27</span>.79.223\n\nExit code: <span class="token number">0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果子进程还需要输入，则可以通过 communicate() 方法输入：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59487019281813530000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import subprocess\n\nprint(\'\\$ nslookup\')\np = subprocess.Popen([\'nslookup\'], stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE)\noutput, err = p.communicate(b\'set q=mx\\npython.org\\nexit\\n\')\nprint(output.decode(\'utf-8\'))\nprint(\'Exit code:\', p.returncode)`, `59487019281813530000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> subprocess\n\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'$ nslookup\'</span><span class="token punctuation">)</span>\np <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'nslookup\'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> stdin<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span> stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span> stderr<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">)</span>\noutput<span class="token punctuation">,</span> err <span class="token operator">=</span> p<span class="token punctuation">.</span>communicate<span class="token punctuation">(</span><span class="token string">b\'set q=mx\\npython.org\\nexit\\n\'</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>output<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">\'utf-8\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Exit code:\'</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>returncode<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>上面的代码相当于在命令行执行命令 nslookup，然后手动输入：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="38785682387052490000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`set q=mx\npython.org\nexit`, `38785682387052490000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token builtin class-name">set</span> <span class="token assign-left variable">q</span><span class="token operator">=</span>mx\npython.org\n<span class="token builtin class-name">exit</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>运行结果如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42541940571928306000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ nslookup\nServer:  192.168.19.4\nAddress: 192.168.19.4#53\n\nNon-authoritative answer:\npython.org mail exchanger = 50 mail.python.org.\n\nAuthoritative answers can be found from:\nmail.python.org internet address = 82.94.164.166\nmail.python.org has AAAA address 2001:888:2000:d::a6\n\n\nExit code: 0`, `42541940571928306000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token function">nslookup</span>\nServer:  <span class="token number">192.168</span>.19.4\nAddress: <span class="token number">192.168</span>.19.4<span class="token comment">#53</span>\n\nNon-authoritative answer:\npython.org mail exchanger <span class="token operator">=</span> <span class="token number">50</span> mail.python.org.\n\nAuthoritative answers can be found from:\nmail.python.org internet address <span class="token operator">=</span> <span class="token number">82.94</span>.164.166\nmail.python.org has AAAA address <span class="token number">2001</span>:888:2000:d::a6\n\n\nExit code: <span class="token number">0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="进程间通信"><a href="#%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>进程间通信</h3>\n<p>Process 之间肯定是需要通信的，操作系统提供了很多机制来实现进程间的通信。Python 的 multiprocessing 模块包装了底层的机制，提供了 Queue、Pipes 等多种方式来交换数据。</p>\n<p>我们以 Queue 为例，在父进程中创建两个子进程，一个往 Queue 里写数据，一个从 Queue 里读数据：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="17561016750148983000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`from multiprocessing import Process, Queue\nimport os, time, random\n\n# 写数据进程执行的代码:\ndef write(q):\n    print(\'Process to write: %s\' % os.getpid())\n    for value in [\'A\', \'B\', \'C\']:\n        print(\'Put %s to queue...\' % value)\n        q.put(value)\n        time.sleep(random.random())\n\n# 读数据进程执行的代码:\ndef read(q):\n    print(\'Process to read: %s\' % os.getpid())\n    while True:\n        value = q.get(True)\n        print(\'Get %s from queue.\' % value)\n\nif __name__==\'__main__\':\n    # 父进程创建 Queue，并传给各个子进程：\n    q = Queue()\n    pw = Process(target=write, args=(q,))\n    pr = Process(target=read, args=(q,))\n    # 启动子进程 pw，写入:\n    pw.start()\n    # 启动子进程 pr，读取:\n    pr.start()\n    # 等待 pw 结束:\n    pw.join()\n    # pr 进程里是死循环，无法等待其结束，只能强行终止:\n    pr.terminate()`, `17561016750148983000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process<span class="token punctuation">,</span> Queue\n<span class="token keyword">import</span> os<span class="token punctuation">,</span> time<span class="token punctuation">,</span> random\n\n<span class="token comment"># 写数据进程执行的代码:</span>\n<span class="token keyword">def</span> <span class="token function">write</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Process to write: %s\'</span> <span class="token operator">%</span> os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token keyword">for</span> value <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">\'A\'</span><span class="token punctuation">,</span> <span class="token string">\'B\'</span><span class="token punctuation">,</span> <span class="token string">\'C\'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Put %s to queue...\'</span> <span class="token operator">%</span> value<span class="token punctuation">)</span>\n        q<span class="token punctuation">.</span>put<span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token comment"># 读数据进程执行的代码:</span>\n<span class="token keyword">def</span> <span class="token function">read</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Process to read: %s\'</span> <span class="token operator">%</span> os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>\n        value <span class="token operator">=</span> q<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Get %s from queue.\'</span> <span class="token operator">%</span> value<span class="token punctuation">)</span>\n\n<span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">\'__main__\'</span><span class="token punctuation">:</span>\n    <span class="token comment"># 父进程创建 Queue，并传给各个子进程：</span>\n    q <span class="token operator">=</span> Queue<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    pw <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>write<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    pr <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>read<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token comment"># 启动子进程 pw，写入:</span>\n    pw<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token comment"># 启动子进程 pr，读取:</span>\n    pr<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token comment"># 等待 pw 结束:</span>\n    pw<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token comment"># pr 进程里是死循环，无法等待其结束，只能强行终止:</span>\n    pr<span class="token punctuation">.</span>terminate<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>运行结果如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="41235633601103720000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Process to write: 50563\nPut A to queue...\nProcess to read: 50564\nGet A from queue.\nPut B to queue...\nGet B from queue.\nPut C to queue...\nGet C from queue.`, `41235633601103720000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">Process to write: <span class="token number">50563</span>\nPut A to queue<span class="token punctuation">..</span>.\nProcess to read: <span class="token number">50564</span>\nGet A from queue.\nPut B to queue<span class="token punctuation">..</span>.\nGet B from queue.\nPut C to queue<span class="token punctuation">..</span>.\nGet C from queue.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 Unix/Linux 下，multiprocessing 模块封装了 fork() 调用，使我们不需要关注 fork() 的细节。由于 Windows 没有 fork 调用，因此，multiprocessing 需要“模拟”出 fork 的效果，父进程所有 Python 对象都必须通过 pickle 序列化再传到子进程去，所以，如果 multiprocessing 在 Windows 下调用失败了，要先考虑是不是 pickle 失败了。</p>\n<h3 id="小结-19"><a href="#%E5%B0%8F%E7%BB%93-19" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>在 Unix/Linux 下，可以使用 fork() 调用实现多进程。</p>\n<p>要实现跨平台的多进程，可以使用 multiprocessing 模块。</p>\n<p>进程间通信是通过 Queue、Pipes 等实现的。</p>\n<h2 id="多线程"><a href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>多线程</h2>\n<p>多任务可以由多进程完成，也可以由一个进程内的多线程完成。</p>\n<p>由于线程是操作系统直接支持的执行单元，因此，高级语言通常都内置多线程的支持，Python 也不例外，并且，Python 的线程是真正的 Posix Thread，而不是模拟出来的线程。</p>\n<p>Python 的标准库提供了两个模块：<code class="language-text">_thread</code> 和 threading，<code class="language-text">_thread</code> 是低级模块，threading 是高级模块，对 <code class="language-text">_thread</code> 进行了封装。绝大多数情况下，我们只需要使用 threading 这个高级模块。</p>\n<p>启动一个线程就是把一个函数传入并创建 Thread 实例，然后调用 start() 开始执行：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79175106050448460000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import time, threading\n\n# 新线程执行的代码:\ndef loop():\n    print(\'thread %s is running...\' % threading.current_thread().name)\n    n = 0\n    while n < 5:\n        n = n + 1\n        print(\'thread %s >>> %s\' % (threading.current_thread().name, n))\n        time.sleep(1)\n    print(\'thread %s ended.\' % threading.current_thread().name)\n\nprint(\'thread %s is running...\' % threading.current_thread().name)\nt = threading.Thread(target=loop, name=\'LoopThread\')\nt.start()\nt.join()\nprint(\'thread %s ended.\' % threading.current_thread().name)`, `79175106050448460000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> time<span class="token punctuation">,</span> threading\n\n<span class="token comment"># 新线程执行的代码:</span>\n<span class="token keyword">def</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'thread %s is running...\'</span> <span class="token operator">%</span> threading<span class="token punctuation">.</span>current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>\n    n <span class="token operator">=</span> <span class="token number">0</span>\n    <span class="token keyword">while</span> n <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">:</span>\n        n <span class="token operator">=</span> n <span class="token operator">+</span> <span class="token number">1</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'thread %s >>> %s\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>threading<span class="token punctuation">.</span>current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span>\n        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'thread %s ended.\'</span> <span class="token operator">%</span> threading<span class="token punctuation">.</span>current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'thread %s is running...\'</span> <span class="token operator">%</span> threading<span class="token punctuation">.</span>current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>\nt <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>loop<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">\'LoopThread\'</span><span class="token punctuation">)</span>\nt<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>\nt<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'thread %s ended.\'</span> <span class="token operator">%</span> threading<span class="token punctuation">.</span>current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>由于任何进程默认就会启动一个线程，我们把该线程称为主线程，主线程又可以启动新的线程，Python 的 threading 模块有个 current_thread() 函数，它永远返回当前线程的实例。主线程实例的名字叫 MainThread，子线程的名字在创建时指定，我们用 LoopThread 命名子线程。名字仅仅在打印时用来显示，完全没有其他意义，如果不起名字 Python 就自动给线程命名为 Thread-1，Thread-2……</p>\n<h3 id="lock"><a href="#lock" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Lock</h3>\n<p>多线程和多进程最大的不同在于，多进程中，同一个变量，各自有一份拷贝存在于每个进程中，互不影响，而多线程中，所有变量都由所有线程共享，所以，任何一个变量都可以被任何一个线程修改，因此，线程之间共享数据最大的危险在于多个线程同时改一个变量，把内容给改乱了。</p>\n<p>来看看多个线程同时操作一个变量怎么把内容给改乱了：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62598064455230640000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import time, threading\n\n# 假定这是你的银行存款:\nbalance = 0\n\ndef change_it(n):\n    # 先存后取，结果应该为 0:\n    global balance\n    balance = balance + n\n    balance = balance - n\n\ndef run_thread(n):\n    for i in range(2000000):\n        change_it(n)\n\nt1 = threading.Thread(target=run_thread, args=(5,))\nt2 = threading.Thread(target=run_thread, args=(8,))\nt1.start()\nt2.start()\nt1.join()\nt2.join()\nprint(balance)`, `62598064455230640000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> time<span class="token punctuation">,</span> threading\n\n<span class="token comment"># 假定这是你的银行存款:</span>\nbalance <span class="token operator">=</span> <span class="token number">0</span>\n\n<span class="token keyword">def</span> <span class="token function">change_it</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token comment"># 先存后取，结果应该为 0:</span>\n    <span class="token keyword">global</span> balance\n    balance <span class="token operator">=</span> balance <span class="token operator">+</span> n\n    balance <span class="token operator">=</span> balance <span class="token operator">-</span> n\n\n<span class="token keyword">def</span> <span class="token function">run_thread</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2000000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        change_it<span class="token punctuation">(</span>n<span class="token punctuation">)</span>\n\nt1 <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>run_thread<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\nt2 <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>run_thread<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\nt1<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>\nt2<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>\nt1<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>\nt2<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span>balance<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>我们定义了一个共享变量 balance，初始值为 0，并且启动两个线程，先存后取，理论上结果应该为 0，但是，由于线程的调度是由操作系统决定的，当 t1、t2 交替执行时，只要循环次数足够多，balance 的结果就不一定是 0 了。</p>\n<p>原因是因为高级语言的一条语句在 CPU 执行时是若干条语句，即使一个简单的计算：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="50385932422388920000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`balance = balance + n`, `50385932422388920000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">balance <span class="token operator">=</span> balance <span class="token operator">+</span> n</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>也分两步：</p>\n<ol>\n<li>计算 balance + n，存入临时变量中；</li>\n<li>将临时变量的值赋给 balance。</li>\n</ol>\n<p>也就是可以看成：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="79747284771587830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`x = balance + n\nbalance = x`, `79747284771587830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">x <span class="token operator">=</span> balance <span class="token operator">+</span> n\nbalance <span class="token operator">=</span> x</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>由于 x 是局部变量，两个线程各自都有自己的 x，当代码正常执行时：</p>\n<p>初始值 balance = 0</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="56279298984498970000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`t1: x1 = balance + 5 # x1 = 0 + 5 = 5\nt1: balance = x1     # balance = 5\nt1: x1 = balance - 5 # x1 = 5 - 5 = 0\nt1: balance = x1     # balance = 0\n\nt2: x2 = balance + 8 # x2 = 0 + 8 = 8\nt2: balance = x2     # balance = 8\nt2: x2 = balance - 8 # x2 = 8 - 8 = 0\nt2: balance = x2     # balance = 0\n\n结果 balance = 0`, `56279298984498970000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">t1: x1 = balance + 5 # x1 = 0 + 5 = 5\nt1: balance = x1     # balance = 5\nt1: x1 = balance - 5 # x1 = 5 - 5 = 0\nt1: balance = x1     # balance = 0\n\nt2: x2 = balance + 8 # x2 = 0 + 8 = 8\nt2: balance = x2     # balance = 8\nt2: x2 = balance - 8 # x2 = 8 - 8 = 0\nt2: balance = x2     # balance = 0\n\n结果 balance = 0</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是 t1 和 t2 是交替运行的，如果操作系统以下面的顺序执行 t1、t2：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="91542042455070430000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`初始值 balance = 0\n\nt1: x1 = balance + 5  # x1 = 0 + 5 = 5\n\nt2: x2 = balance + 8  # x2 = 0 + 8 = 8\nt2: balance = x2      # balance = 8\n\nt1: balance = x1      # balance = 5\nt1: x1 = balance - 5  # x1 = 5 - 5 = 0\nt1: balance = x1      # balance = 0\n\nt2: x2 = balance - 8  # x2 = 0 - 8 = -8\nt2: balance = x2      # balance = -8\n\n结果 balance = -8`, `91542042455070430000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">初始值 balance = 0\n\nt1: x1 = balance + 5  # x1 = 0 + 5 = 5\n\nt2: x2 = balance + 8  # x2 = 0 + 8 = 8\nt2: balance = x2      # balance = 8\n\nt1: balance = x1      # balance = 5\nt1: x1 = balance - 5  # x1 = 5 - 5 = 0\nt1: balance = x1      # balance = 0\n\nt2: x2 = balance - 8  # x2 = 0 - 8 = -8\nt2: balance = x2      # balance = -8\n\n结果 balance = -8</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>究其原因，是因为修改 balance 需要多条语句，而执行这几条语句时，线程可能中断，从而导致多个线程把同一个对象的内容改乱了。</p>\n<p>两个线程同时一存一取，就可能导致余额不对，你肯定不希望你的银行存款莫名其妙地变成了负数，所以，我们必须确保一个线程在修改 balance 的时候，别的线程一定不能改。</p>\n<p>如果我们要确保 balance 计算正确，就要给 <code class="language-text">change_it()</code> 上一把锁，当某个线程开始执行 <code class="language-text">change_it()</code> 时，我们说，该线程因为获得了锁，因此其他线程不能同时执行 <code class="language-text">change_it()</code>，只能等待，直到锁被释放后，获得该锁以后才能改。由于锁只有一个，无论多少线程，同一时刻最多只有一个线程持有该锁，所以，不会造成修改的冲突。创建一个锁就是通过 threading.Lock() 来实现：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25196516697400504000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`balance = 0\nlock = threading.Lock()\n\ndef run_thread(n):\n    for i in range(100000):\n        # 先要获取锁:\n        lock.acquire()\n        try:\n            # 放心地改吧:\n            change_it(n)\n        finally:\n            # 改完了一定要释放锁:\n            lock.release()`, `25196516697400504000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">balance <span class="token operator">=</span> <span class="token number">0</span>\nlock <span class="token operator">=</span> threading<span class="token punctuation">.</span>Lock<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token keyword">def</span> <span class="token function">run_thread</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token comment"># 先要获取锁:</span>\n        lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">try</span><span class="token punctuation">:</span>\n            <span class="token comment"># 放心地改吧:</span>\n            change_it<span class="token punctuation">(</span>n<span class="token punctuation">)</span>\n        <span class="token keyword">finally</span><span class="token punctuation">:</span>\n            <span class="token comment"># 改完了一定要释放锁:</span>\n            lock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>当多个线程同时执行 lock.acquire() 时，只有一个线程能成功地获取锁，然后继续执行代码，其他线程就继续等待直到获得锁为止。</p>\n<p>获得锁的线程用完后一定要释放锁，否则那些苦苦等待锁的线程将永远等待下去，成为死线程。所以我们用 try…finally 来确保锁一定会被释放。</p>\n<p>锁的好处就是确保了某段关键代码只能由一个线程从头到尾完整地执行，坏处当然也很多，首先是阻止了多线程并发执行，包含锁的某段代码实际上只能以单线程模式执行，效率就大大地下降了。其次，由于可以存在多个锁，不同的线程持有不同的锁，并试图获取对方持有的锁时，可能会造成死锁，导致多个线程全部挂起，既不能执行，也无法结束，只能靠操作系统强制终止。</p>\n<h3 id="多核-cpu"><a href="#%E5%A4%9A%E6%A0%B8-cpu" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>多核 CPU</h3>\n<p>如果你不幸拥有一个多核 CPU，你肯定在想，多核应该可以同时执行多个线程。</p>\n<p>如果写一个死循环的话，会出现什么情况呢？</p>\n<p>打开 Mac OS X 的 Activity Monitor，或者 Windows 的 Task Manager，都可以监控某个进程的 CPU 使用率。</p>\n<p>我们可以监控到一个死循环线程会 100% 占用一个 CPU。</p>\n<p>如果有两个死循环线程，在多核 CPU 中，可以监控到会占用 200% 的 CPU，也就是占用两个 CPU 核心。</p>\n<p>要想把 N 核 CPU 的核心全部跑满，就必须启动 N 个死循环线程。</p>\n<p>试试用 Python 写个死循环：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25052357766071020000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import threading, multiprocessing\n\ndef loop():\n    x = 0\n    while True:\n        x = x ^ 1\n\nfor i in range(multiprocessing.cpu_count()):\n    t = threading.Thread(target=loop)\n    t.start()`, `25052357766071020000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> threading<span class="token punctuation">,</span> multiprocessing\n\n<span class="token keyword">def</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    x <span class="token operator">=</span> <span class="token number">0</span>\n    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>\n        x <span class="token operator">=</span> x <span class="token operator">^</span> <span class="token number">1</span>\n\n<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>multiprocessing<span class="token punctuation">.</span>cpu_count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    t <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>loop<span class="token punctuation">)</span>\n    t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>启动与 CPU 核心数量相同的 N 个线程，在 4 核 CPU 上可以监控到 CPU 占用率仅有 102%，也就是仅使用了一核。</p>\n<p>但是用 C、C++或 Java 来改写相同的死循环，直接可以把全部核心跑满，4 核就跑到 400%，8 核就跑到 800%，为什么 Python 不行呢？</p>\n<p>因为 Python 的线程虽然是真正的线程，但解释器执行代码时，有一个 GIL 锁：Global Interpreter Lock，任何 Python 线程执行前，必须先获得 GIL 锁，然后，每执行 100 条字节码，解释器就自动释放 GIL 锁，让别的线程有机会执行。这个 GIL 全局锁实际上把所有线程的执行代码都给上了锁，所以，多线程在 Python 中只能交替执行，即使 100 个线程跑在 100 核 CPU 上，也只能用到 1 个核。</p>\n<p>GIL 是 Python 解释器设计的历史遗留问题，通常我们用的解释器是官方实现的 CPython，要真正利用多核，除非重写一个不带 GIL 的解释器。</p>\n<p>所以，在 Python 中，可以使用多线程，但不要指望能有效利用多核。如果一定要通过多线程利用多核，那只能通过 C 扩展来实现，不过这样就失去了 Python 简单易用的特点。</p>\n<p>不过，也不用过于担心，Python 虽然不能利用多线程实现多核任务，但可以通过多进程实现多核任务。多个 Python 进程有各自独立的 GIL 锁，互不影响。</p>\n<h3 id="小结-20"><a href="#%E5%B0%8F%E7%BB%93-20" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>多线程编程，模型复杂，容易发生冲突，必须用锁加以隔离，同时，又要小心死锁的发生。</p>\n<p>Python 解释器由于设计时有 GIL 全局锁，导致了多线程无法利用多核。多线程的并发在 Python 中就是一个美丽的梦。</p>\n<h2 id="threadlocal"><a href="#threadlocal" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ThreadLocal</h2>\n<p>在多线程环境下，每个线程都有自己的数据。一个线程使用自己的局部变量比使用全局变量好，因为局部变量只有线程自己能看见，不会影响其他线程，而全局变量的修改必须加锁。</p>\n<p>但是局部变量也有问题，就是在函数调用的时候，传递起来很麻烦：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63015817120381350000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def process_student(name):\n    std = Student(name)\n    # std 是局部变量，但是每个函数都要用它，因此必须传进去：\n    do_task_1(std)\n    do_task_2(std)\n\ndef do_task_1(std):\n    do_subtask_1(std)\n    do_subtask_2(std)\n\ndef do_task_2(std):\n    do_subtask_2(std)\n    do_subtask_2(std)`, `63015817120381350000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">process_student</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    std <span class="token operator">=</span> Student<span class="token punctuation">(</span>name<span class="token punctuation">)</span>\n    <span class="token comment"># std 是局部变量，但是每个函数都要用它，因此必须传进去：</span>\n    do_task_1<span class="token punctuation">(</span>std<span class="token punctuation">)</span>\n    do_task_2<span class="token punctuation">(</span>std<span class="token punctuation">)</span>\n\n<span class="token keyword">def</span> <span class="token function">do_task_1</span><span class="token punctuation">(</span>std<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    do_subtask_1<span class="token punctuation">(</span>std<span class="token punctuation">)</span>\n    do_subtask_2<span class="token punctuation">(</span>std<span class="token punctuation">)</span>\n\n<span class="token keyword">def</span> <span class="token function">do_task_2</span><span class="token punctuation">(</span>std<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    do_subtask_2<span class="token punctuation">(</span>std<span class="token punctuation">)</span>\n    do_subtask_2<span class="token punctuation">(</span>std<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>每个函数一层一层调用都这么传参数那还得了？用全局变量？也不行，因为每个线程处理不同的 Student 对象，不能共享。</p>\n<p>如果用一个全局 dict 存放所有的 Student 对象，然后以 thread 自身作为 key 获得线程对应的 Student 对象如何？</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="94420393531821850000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`global_dict = {}\n\ndef std_thread(name):\n    std = Student(name)\n    # 把 std 放到全局变量 global_dict 中：\n    global_dict[threading.current_thread()] = std\n    do_task_1()\n    do_task_2()\n\ndef do_task_1():\n    # 不传入 std，而是根据当前线程查找：\n    std = global_dict[threading.current_thread()]\n    ...\n\ndef do_task_2():\n    # 任何函数都可以查找出当前线程的 std 变量：\n    std = global_dict[threading.current_thread()]\n    ...`, `94420393531821850000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">global_dict <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n<span class="token keyword">def</span> <span class="token function">std_thread</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    std <span class="token operator">=</span> Student<span class="token punctuation">(</span>name<span class="token punctuation">)</span>\n    <span class="token comment"># 把 std 放到全局变量 global_dict 中：</span>\n    global_dict<span class="token punctuation">[</span>threading<span class="token punctuation">.</span>current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> std\n    do_task_1<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    do_task_2<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token keyword">def</span> <span class="token function">do_task_1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token comment"># 不传入 std，而是根据当前线程查找：</span>\n    std <span class="token operator">=</span> global_dict<span class="token punctuation">[</span>threading<span class="token punctuation">.</span>current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n\n<span class="token keyword">def</span> <span class="token function">do_task_2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token comment"># 任何函数都可以查找出当前线程的 std 变量：</span>\n    std <span class="token operator">=</span> global_dict<span class="token punctuation">[</span>threading<span class="token punctuation">.</span>current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\n    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这种方式理论上是可行的，它最大的优点是消除了 std 对象在每层函数中的传递问题，但是，每个函数获取 std 的代码有点丑。</p>\n<p>有没有更简单的方式？</p>\n<p>ThreadLocal 应运而生，不用查找 dict，ThreadLocal 帮你自动做这件事：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98999873652641000000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import threading\n\n# 创建全局 ThreadLocal 对象:\nlocal_school = threading.local()\n\ndef process_student():\n    # 获取当前线程关联的 student:\n    std = local_school.student\n    print(\'Hello, %s (in %s)\' % (std, threading.current_thread().name))\n\ndef process_thread(name):\n    # 绑定 ThreadLocal 的 student:\n    local_school.student = name\n    process_student()\n\nt1 = threading.Thread(target=process_thread, args=(\'Alice\',), name=\'Thread-A\')\nt2 = threading.Thread(target=process_thread, args=(\'Bob\',), name=\'Thread-B\')\nt1.start()\nt2.start()\nt1.join()\nt2.join()`, `98999873652641000000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> threading\n\n<span class="token comment"># 创建全局 ThreadLocal 对象:</span>\nlocal_school <span class="token operator">=</span> threading<span class="token punctuation">.</span>local<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token keyword">def</span> <span class="token function">process_student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token comment"># 获取当前线程关联的 student:</span>\n    std <span class="token operator">=</span> local_school<span class="token punctuation">.</span>student\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Hello, %s (in %s)\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>std<span class="token punctuation">,</span> threading<span class="token punctuation">.</span>current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token keyword">def</span> <span class="token function">process_thread</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token comment"># 绑定 ThreadLocal 的 student:</span>\n    local_school<span class="token punctuation">.</span>student <span class="token operator">=</span> name\n    process_student<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\nt1 <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>process_thread<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">\'Alice\'</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">\'Thread-A\'</span><span class="token punctuation">)</span>\nt2 <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>process_thread<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">\'Bob\'</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">\'Thread-B\'</span><span class="token punctuation">)</span>\nt1<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>\nt2<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>\nt1<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>\nt2<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>执行结果：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35377866787921674000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Hello, Alice (in Thread-A)\nHello, Bob (in Thread-B)`, `35377866787921674000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">Hello, Alice <span class="token punctuation">(</span>in Thread-A<span class="token punctuation">)</span>\nHello, Bob <span class="token punctuation">(</span>in Thread-B<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>全局变量 <code class="language-text">local_school</code> 就是一个 ThreadLocal 对象，每个 Thread 对它都可以读写 student 属性，但互不影响。你可以把 <code class="language-text">local_school</code> 看成全局变量，但每个属性如 <code class="language-text">local_school.student</code> 都是线程的局部变量，可以任意读写而互不干扰，也不用管理锁的问题，ThreadLocal 内部会处理。</p>\n<p>可以理解为全局变量 <code class="language-text">local_school</code> 是一个 dict，不但可以用 <code class="language-text">local_school.student</code>，还可以绑定其他变量，如 <code class="language-text">local_school.teacher</code> 等等。</p>\n<p>ThreadLocal 最常用的地方就是为每个线程绑定一个数据库连接，HTTP 请求，用户身份信息等，这样一个线程的所有调用到的处理函数都可以非常方便地访问这些资源。</p>\n<h3 id="小结-21"><a href="#%E5%B0%8F%E7%BB%93-21" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>一个 ThreadLocal 变量虽然是全局变量，但每个线程都只能读写自己线程的独立副本，互不干扰。ThreadLocal 解决了参数在一个线程中各个函数之间互相传递的问题。</p>\n<h2 id="进程-vs-线程"><a href="#%E8%BF%9B%E7%A8%8B-vs-%E7%BA%BF%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>进程 vs 线程</h2>\n<p>首先，要实现多任务，通常我们会设计 Master-Worker 模式，Master 负责分配任务，Worker 负责执行任务，因此，多任务环境下，通常是一个 Master，多个 Worker。</p>\n<ol>\n<li>如果用多进程实现 Master-Worker，主进程就是 Master，其他进程就是 Worker。</li>\n<li>如果用多线程实现 Master-Worker，主线程就是 Master，其他线程就是 Worker。</li>\n</ol>\n<p>多进程模式最大的优点就是稳定性高，因为一个子进程崩溃了，不会影响主进程和其他子进程。（当然主进程挂了所有进程就全挂了，但是 Master 进程只负责分配任务，挂掉的概率低）著名的 Apache 最早就是采用多进程模式。</p>\n<p>多进程模式的缺点是创建进程的代价大，在 Unix/Linux 系统下，用 fork 调用还行，在 Windows 下创建进程开销巨大。另外，操作系统能同时运行的进程数也是有限的，在内存和 CPU 的限制下，如果有几千个进程同时运行，操作系统连调度都会成问题。</p>\n<p>多线程模式通常比多进程快一点，但是也快不到哪去，而且，多线程模式致命的缺点就是任何一个线程挂掉都可能直接造成整个进程崩溃，因为所有线程共享进程的内存。在 Windows 上，如果一个线程执行的代码出了问题，你经常可以看到这样的提示：“该程序执行了非法操作，即将关闭”，其实往往是某个线程出了问题，但是操作系统会强制结束整个进程。</p>\n<p>在 Windows 下，多线程的效率比多进程要高，所以微软的 IIS 服务器默认采用多线程模式。由于多线程存在稳定性的问题，IIS 的稳定性就不如 Apache。为了缓解这个问题，IIS 和 Apache 现在又有多进程+多线程的混合模式，真是把问题越搞越复杂。</p>\n<h3 id="线程切换"><a href="#%E7%BA%BF%E7%A8%8B%E5%88%87%E6%8D%A2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>线程切换</h3>\n<p>无论是多进程还是多线程，只要数量一多，效率肯定上不去，为什么呢？</p>\n<p>我们打个比方，假设你不幸正在准备中考，每天晚上需要做语文、数学、英语、物理、化学这 5 科的作业，每项作业耗时 1 小时。</p>\n<p>如果你先花 1 小时做语文作业，做完了，再花 1 小时做数学作业，这样，依次全部做完，一共花 5 小时，这种方式称为单任务模型，或者批处理任务模型。</p>\n<p>假设你打算切换到多任务模型，可以先做 1 分钟语文，再切换到数学作业，做 1 分钟，再切换到英语，以此类推，只要切换速度足够快，这种方式就和单核 CPU 执行多任务是一样的了，以幼儿园小朋友的眼光来看，你就正在同时写 5 科作业。</p>\n<p>但是，切换作业是有代价的，比如从语文切到数学，要先收拾桌子上的语文书本、钢笔（这叫保存现场），然后，打开数学课本、找出圆规直尺（这叫准备新环境），才能开始做数学作业。操作系统在切换进程或者线程时也是一样的，它需要先保存当前执行的现场环境（CPU 寄存器状态、内存页等），然后，把新任务的执行环境准备好（恢复上次的寄存器状态，切换内存页等），才能开始执行。这个切换过程虽然很快，但是也需要耗费时间。如果有几千个任务同时进行，操作系统可能就主要忙着切换任务，根本没有多少时间去执行任务了，这种情况最常见的就是硬盘狂响，点窗口无反应，系统处于假死状态。</p>\n<p>所以，多任务一旦多到一个限度，就会消耗掉系统所有的资源，结果效率急剧下降，所有任务都做不好。</p>\n<h3 id="计算密集型-vs-io-密集型"><a href="#%E8%AE%A1%E7%AE%97%E5%AF%86%E9%9B%86%E5%9E%8B-vs-io-%E5%AF%86%E9%9B%86%E5%9E%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>计算密集型 vs IO 密集型</h3>\n<p>是否采用多任务的第二个考虑是任务的类型。我们可以把任务分为计算密集型和 IO 密集型。</p>\n<p>计算密集型任务的特点是要进行大量的计算，消耗 CPU 资源，比如计算圆周率、对视频进行高清解码等等，全靠 CPU 的运算能力。这种计算密集型任务虽然也可以用多任务完成，但是任务越多，花在任务切换的时间就越多，CPU 执行任务的效率就越低，所以，要最高效地利用 CPU，计算密集型任务同时进行的数量应当等于 CPU 的核心数。</p>\n<p>计算密集型任务由于主要消耗 CPU 资源，因此，代码运行效率至关重要。Python 这样的脚本语言运行效率很低，完全不适合计算密集型任务。对于计算密集型任务，最好用 C 语言编写。</p>\n<p>第二种任务的类型是 IO 密集型，涉及到网络、磁盘 IO 的任务都是 IO 密集型任务，这类任务的特点是 CPU 消耗很少，任务的大部分时间都在等待 IO 操作完成（因为 IO 的速度远远低于 CPU 和内存的速度）。对于 IO 密集型任务，任务越多，CPU 效率越高，但也有一个限度。常见的大部分任务都是 IO 密集型任务，比如 Web 应用。</p>\n<p>IO 密集型任务执行期间，99% 的时间都花在 IO 上，花在 CPU 上的时间很少，因此，用运行速度极快的 C 语言替换用 Python 这样运行速度极低的脚本语言，完全无法提升运行效率。对于 IO 密集型任务，最合适的语言就是开发效率最高（代码量最少）的语言，脚本语言是首选，C 语言最差。</p>\n<h3 id="异步-io"><a href="#%E5%BC%82%E6%AD%A5-io" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>异步 IO</h3>\n<p>考虑到 CPU 和 IO 之间巨大的速度差异，一个任务在执行的过程中大部分时间都在等待 IO 操作，单进程单线程模型会导致别的任务无法并行执行，因此，我们才需要多进程模型或者多线程模型来支持多任务并发执行。</p>\n<p>现代操作系统对 IO 操作已经做了巨大的改进，最大的特点就是支持异步 IO。如果充分利用操作系统提供的异步 IO 支持，就可以用单进程单线程模型来执行多任务，这种全新的模型称为事件驱动模型，Nginx 就是支持异步 IO 的 Web 服务器，它在单核 CPU 上采用单进程模型就可以高效地支持多任务。在多核 CPU 上，可以运行多个进程（数量与 CPU 核心数相同），充分利用多核 CPU。由于系统总的进程数量十分有限，因此操作系统调度非常高效。用异步 IO 编程模型来实现多任务是一个主要的趋势。</p>\n<p>对应到 Python 语言，单线程的异步编程模型称为协程，有了协程的支持，就可以基于事件驱动编写高效的多任务程序。我们会在后面讨论如何编写协程。</p>\n<h2 id="分布式进程"><a href="#%E5%88%86%E5%B8%83%E5%BC%8F%E8%BF%9B%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分布式进程</h2>\n<p>在 Thread 和 Process 中，应当优选 Process，因为 Process 更稳定，而且，Process 可以分布到多台机器上，而 Thread 最多只能分布到同一台机器的多个 CPU 上。</p>\n<p>Python 的 multiprocessing 模块不但支持多进程，其中 managers 子模块还支持把多进程分布到多台机器上。一个服务进程可以作为调度者，将任务分布到其他多个进程中，依靠网络通信。由于 managers 模块封装很好，不必了解网络通信的细节，就可以很容易地编写分布式多进程程序。</p>\n<p>举个例子：如果我们已经有一个通过 Queue 通信的多进程程序在同一台机器上运行，现在，由于处理任务的进程任务繁重，希望把发送任务的进程和处理任务的进程分布到两台机器上。怎么用分布式进程实现？</p>\n<p>原有的 Queue 可以继续使用，但是，通过 managers 模块把 Queue 通过网络暴露出去，就可以让其他机器的进程访问 Queue 了。</p>\n<p>我们先看服务进程，服务进程负责启动 Queue，把 Queue 注册到网络上，然后往 Queue 里面写入任务：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44672287572994820000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# task_master.py\n\nimport random, time, queue\nfrom multiprocessing.managers import BaseManager\n\n# 发送任务的队列:\ntask_queue = queue.Queue()\n# 接收结果的队列:\nresult_queue = queue.Queue()\n\n# 从 BaseManager 继承的 QueueManager:\nclass QueueManager(BaseManager):\n    pass\n\n# 把两个 Queue 都注册到网络上, callable 参数关联了 Queue 对象:\nQueueManager.register(\'get_task_queue\', callable=lambda: task_queue)\nQueueManager.register(\'get_result_queue\', callable=lambda: result_queue)\n# 绑定端口 5000, 设置验证码 \'abc\':\nmanager = QueueManager(address=(\'\', 5000), authkey=b\'abc\')\n# 启动 Queue:\nmanager.start()\n\n# 获得通过网络访问的 Queue 对象:\ntask = manager.get_task_queue()\nresult = manager.get_result_queue()\n# 放几个任务进去:\nfor i in range(10):\n    n = random.randint(0, 10000)\n    print(\'Put task %d...\' % n)\n    task.put(n)\n# 从 result 队列读取结果:\nprint(\'Try get results...\')\nfor i in range(10):\n    r = result.get(timeout=10)\n    print(\'Result: %s\' % r)\n# 关闭:\nmanager.shutdown()\nprint(\'master exit.\')`, `44672287572994820000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment"># task_master.py</span>\n\n<span class="token keyword">import</span> random<span class="token punctuation">,</span> time<span class="token punctuation">,</span> queue\n<span class="token keyword">from</span> multiprocessing<span class="token punctuation">.</span>managers <span class="token keyword">import</span> BaseManager\n\n<span class="token comment"># 发送任务的队列:</span>\ntask_queue <span class="token operator">=</span> queue<span class="token punctuation">.</span>Queue<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token comment"># 接收结果的队列:</span>\nresult_queue <span class="token operator">=</span> queue<span class="token punctuation">.</span>Queue<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token comment"># 从 BaseManager 继承的 QueueManager:</span>\n<span class="token keyword">class</span> <span class="token class-name">QueueManager</span><span class="token punctuation">(</span>BaseManager<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n<span class="token comment"># 把两个 Queue 都注册到网络上, callable 参数关联了 Queue 对象:</span>\nQueueManager<span class="token punctuation">.</span>register<span class="token punctuation">(</span><span class="token string">\'get_task_queue\'</span><span class="token punctuation">,</span> <span class="token builtin">callable</span><span class="token operator">=</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> task_queue<span class="token punctuation">)</span>\nQueueManager<span class="token punctuation">.</span>register<span class="token punctuation">(</span><span class="token string">\'get_result_queue\'</span><span class="token punctuation">,</span> <span class="token builtin">callable</span><span class="token operator">=</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> result_queue<span class="token punctuation">)</span>\n<span class="token comment"># 绑定端口 5000, 设置验证码 \'abc\':</span>\nmanager <span class="token operator">=</span> QueueManager<span class="token punctuation">(</span>address<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">\'\'</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> authkey<span class="token operator">=</span><span class="token string">b\'abc\'</span><span class="token punctuation">)</span>\n<span class="token comment"># 启动 Queue:</span>\nmanager<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token comment"># 获得通过网络访问的 Queue 对象:</span>\ntask <span class="token operator">=</span> manager<span class="token punctuation">.</span>get_task_queue<span class="token punctuation">(</span><span class="token punctuation">)</span>\nresult <span class="token operator">=</span> manager<span class="token punctuation">.</span>get_result_queue<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token comment"># 放几个任务进去:</span>\n<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    n <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Put task %d...\'</span> <span class="token operator">%</span> n<span class="token punctuation">)</span>\n    task<span class="token punctuation">.</span>put<span class="token punctuation">(</span>n<span class="token punctuation">)</span>\n<span class="token comment"># 从 result 队列读取结果:</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Try get results...\'</span><span class="token punctuation">)</span>\n<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    r <span class="token operator">=</span> result<span class="token punctuation">.</span>get<span class="token punctuation">(</span>timeout<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Result: %s\'</span> <span class="token operator">%</span> r<span class="token punctuation">)</span>\n<span class="token comment"># 关闭:</span>\nmanager<span class="token punctuation">.</span>shutdown<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'master exit.\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>请注意，当我们在一台机器上写多进程程序时，创建的 Queue 可以直接拿来用，但是，在分布式多进程环境下，添加任务到 Queue 不可以直接对原始的 <code class="language-text">task_queue</code> 进行操作，那样就绕过了 QueueManager 的封装，必须通过 <code class="language-text">manager.get_task_queue()</code> 获得的 Queue 接口添加。</p>\n<p>然后，在另一台机器上启动任务进程（本机上启动也可以）：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25360713490414354000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`# task_worker.py\n\nimport time, sys, queue\nfrom multiprocessing.managers import BaseManager\n\n# 创建类似的 QueueManager:\nclass QueueManager(BaseManager):\n    pass\n\n# 由于这个 QueueManager 只从网络上获取 Queue，所以注册时只提供名字:\nQueueManager.register(\'get_task_queue\')\nQueueManager.register(\'get_result_queue\')\n\n# 连接到服务器，也就是运行 task_master.py 的机器:\nserver_addr = \'127.0.0.1\'\nprint(\'Connect to server %s...\' % server_addr)\n# 端口和验证码注意保持与 task_master.py 设置的完全一致:\nm = QueueManager(address=(server_addr, 5000), authkey=b\'abc\')\n# 从网络连接:\nm.connect()\n# 获取 Queue 的对象:\ntask = m.get_task_queue()\nresult = m.get_result_queue()\n# 从 task 队列取任务,并把结果写入 result 队列:\nfor i in range(10):\n    try:\n        n = task.get(timeout=1)\n        print(\'run task %d * %d...\' % (n, n))\n        r = \'%d * %d = %d\' % (n, n, n*n)\n        time.sleep(1)\n        result.put(r)\n    except Queue.Empty:\n        print(\'task queue is empty.\')\n# 处理结束:\nprint(\'worker exit.\')`, `25360713490414354000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token comment"># task_worker.py</span>\n\n<span class="token keyword">import</span> time<span class="token punctuation">,</span> sys<span class="token punctuation">,</span> queue\n<span class="token keyword">from</span> multiprocessing<span class="token punctuation">.</span>managers <span class="token keyword">import</span> BaseManager\n\n<span class="token comment"># 创建类似的 QueueManager:</span>\n<span class="token keyword">class</span> <span class="token class-name">QueueManager</span><span class="token punctuation">(</span>BaseManager<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">pass</span>\n\n<span class="token comment"># 由于这个 QueueManager 只从网络上获取 Queue，所以注册时只提供名字:</span>\nQueueManager<span class="token punctuation">.</span>register<span class="token punctuation">(</span><span class="token string">\'get_task_queue\'</span><span class="token punctuation">)</span>\nQueueManager<span class="token punctuation">.</span>register<span class="token punctuation">(</span><span class="token string">\'get_result_queue\'</span><span class="token punctuation">)</span>\n\n<span class="token comment"># 连接到服务器，也就是运行 task_master.py 的机器:</span>\nserver_addr <span class="token operator">=</span> <span class="token string">\'127.0.0.1\'</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Connect to server %s...\'</span> <span class="token operator">%</span> server_addr<span class="token punctuation">)</span>\n<span class="token comment"># 端口和验证码注意保持与 task_master.py 设置的完全一致:</span>\nm <span class="token operator">=</span> QueueManager<span class="token punctuation">(</span>address<span class="token operator">=</span><span class="token punctuation">(</span>server_addr<span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> authkey<span class="token operator">=</span><span class="token string">b\'abc\'</span><span class="token punctuation">)</span>\n<span class="token comment"># 从网络连接:</span>\nm<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token comment"># 获取 Queue 的对象:</span>\ntask <span class="token operator">=</span> m<span class="token punctuation">.</span>get_task_queue<span class="token punctuation">(</span><span class="token punctuation">)</span>\nresult <span class="token operator">=</span> m<span class="token punctuation">.</span>get_result_queue<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token comment"># 从 task 队列取任务,并把结果写入 result 队列:</span>\n<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">try</span><span class="token punctuation">:</span>\n        n <span class="token operator">=</span> task<span class="token punctuation">.</span>get<span class="token punctuation">(</span>timeout<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'run task %d * %d...\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>n<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span>\n        r <span class="token operator">=</span> <span class="token string">\'%d * %d = %d\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>n<span class="token punctuation">,</span> n<span class="token punctuation">,</span> n<span class="token operator">*</span>n<span class="token punctuation">)</span>\n        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>\n        result<span class="token punctuation">.</span>put<span class="token punctuation">(</span>r<span class="token punctuation">)</span>\n    <span class="token keyword">except</span> Queue<span class="token punctuation">.</span>Empty<span class="token punctuation">:</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'task queue is empty.\'</span><span class="token punctuation">)</span>\n<span class="token comment"># 处理结束:</span>\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'worker exit.\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>任务进程要通过网络连接到服务进程，所以要指定服务进程的 IP。</p>\n<p>现在，可以试试分布式进程的工作效果了。先启动 <code class="language-text">task_master.py</code> 服务进程：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="98065081738594980000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ python3 task_master.py\nPut task 3411...\nPut task 1605...\nPut task 1398...\nPut task 4729...\nPut task 5300...\nPut task 7471...\nPut task 68...\nPut task 4219...\nPut task 339...\nPut task 7866...\nTry get results...`, `98065081738594980000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ python3 task_master.py\nPut task <span class="token number">3411</span><span class="token punctuation">..</span>.\nPut task <span class="token number">1605</span><span class="token punctuation">..</span>.\nPut task <span class="token number">1398</span><span class="token punctuation">..</span>.\nPut task <span class="token number">4729</span><span class="token punctuation">..</span>.\nPut task <span class="token number">5300</span><span class="token punctuation">..</span>.\nPut task <span class="token number">7471</span><span class="token punctuation">..</span>.\nPut task <span class="token number">68</span><span class="token punctuation">..</span>.\nPut task <span class="token number">4219</span><span class="token punctuation">..</span>.\nPut task <span class="token number">339</span><span class="token punctuation">..</span>.\nPut task <span class="token number">7866</span><span class="token punctuation">..</span>.\nTry get results<span class="token punctuation">..</span>.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><code class="language-text">task_master.py</code> 进程发送完任务后，开始等待 result 队列的结果。现在启动 <code class="language-text">task_worker.py</code> 进程：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="18891483672613286000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ python3 task_worker.py\nConnect to server 127.0.0.1...\nrun task 3411 * 3411...\nrun task 1605 * 1605...\nrun task 1398 * 1398...\nrun task 4729 * 4729...\nrun task 5300 * 5300...\nrun task 7471 * 7471...\nrun task 68 * 68...\nrun task 4219 * 4219...\nrun task 339 * 339...\nrun task 7866 * 7866...\nworker exit.`, `18891483672613286000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ python3 task_worker.py\nConnect to server <span class="token number">127.0</span>.0.1<span class="token punctuation">..</span>.\nrun task <span class="token number">3411</span> * <span class="token number">3411</span><span class="token punctuation">..</span>.\nrun task <span class="token number">1605</span> * <span class="token number">1605</span><span class="token punctuation">..</span>.\nrun task <span class="token number">1398</span> * <span class="token number">1398</span><span class="token punctuation">..</span>.\nrun task <span class="token number">4729</span> * <span class="token number">4729</span><span class="token punctuation">..</span>.\nrun task <span class="token number">5300</span> * <span class="token number">5300</span><span class="token punctuation">..</span>.\nrun task <span class="token number">7471</span> * <span class="token number">7471</span><span class="token punctuation">..</span>.\nrun task <span class="token number">68</span> * <span class="token number">68</span><span class="token punctuation">..</span>.\nrun task <span class="token number">4219</span> * <span class="token number">4219</span><span class="token punctuation">..</span>.\nrun task <span class="token number">339</span> * <span class="token number">339</span><span class="token punctuation">..</span>.\nrun task <span class="token number">7866</span> * <span class="token number">7866</span><span class="token punctuation">..</span>.\nworker exit.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><code class="language-text">task_worker.py</code> 进程结束，在 <code class="language-text">task_master.py</code> 进程中会继续打印出结果：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29200827432467923000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Result: 3411 * 3411 = 11634921\nResult: 1605 * 1605 = 2576025\nResult: 1398 * 1398 = 1954404\nResult: 4729 * 4729 = 22363441\nResult: 5300 * 5300 = 28090000\nResult: 7471 * 7471 = 55815841\nResult: 68 * 68 = 4624\nResult: 4219 * 4219 = 17799961\nResult: 339 * 339 = 114921\nResult: 7866 * 7866 = 61873956`, `29200827432467923000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">Result: <span class="token number">3411</span> * <span class="token number">3411</span> <span class="token operator">=</span> <span class="token number">11634921</span>\nResult: <span class="token number">1605</span> * <span class="token number">1605</span> <span class="token operator">=</span> <span class="token number">2576025</span>\nResult: <span class="token number">1398</span> * <span class="token number">1398</span> <span class="token operator">=</span> <span class="token number">1954404</span>\nResult: <span class="token number">4729</span> * <span class="token number">4729</span> <span class="token operator">=</span> <span class="token number">22363441</span>\nResult: <span class="token number">5300</span> * <span class="token number">5300</span> <span class="token operator">=</span> <span class="token number">28090000</span>\nResult: <span class="token number">7471</span> * <span class="token number">7471</span> <span class="token operator">=</span> <span class="token number">55815841</span>\nResult: <span class="token number">68</span> * <span class="token number">68</span> <span class="token operator">=</span> <span class="token number">4624</span>\nResult: <span class="token number">4219</span> * <span class="token number">4219</span> <span class="token operator">=</span> <span class="token number">17799961</span>\nResult: <span class="token number">339</span> * <span class="token number">339</span> <span class="token operator">=</span> <span class="token number">114921</span>\nResult: <span class="token number">7866</span> * <span class="token number">7866</span> <span class="token operator">=</span> <span class="token number">61873956</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个简单的 Master/Worker 模型有什么用？其实这就是一个简单但真正的分布式计算，把代码稍加改造，启动多个 worker，就可以把任务分布到几台甚至几十台机器上，比如把计算 n*n 的代码换成发送邮件，就实现了邮件队列的异步发送。</p>\n<p>Queue 对象存储在哪？注意到 <code class="language-text">task_worker.py</code> 中根本没有创建 Queue 的代码，所以，Queue 对象存储在 <code class="language-text">task_master.py</code> 进程中：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53386502745400180000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`                                             │\n┌─────────────────────────────────────────┐     ┌──────────────────────────────────────┐\n│task_master.py                           │  │  │task_worker.py                        │\n│                                         │     │                                      │\n│  task = manager.get_task_queue()        │  │  │  task = manager.get_task_queue()     │\n│  result = manager.get_result_queue()    │     │  result = manager.get_result_queue() │\n│              │                          │  │  │              │                       │\n│              │                          │     │              │                       │\n│              ▼                          │  │  │              │                       │\n│  ┌─────────────────────────────────┐    │     │              │                       │\n│  │QueueManager                     │    │  │  │              │                       │\n│  │ ┌────────────┐ ┌──────────────┐ │    │     │              │                       │\n│  │ │ task_queue │ │ result_queue │ │<───┼──┼──┼──────────────┘                       │\n│  │ └────────────┘ └──────────────┘ │    │     │                                      │\n│  └─────────────────────────────────┘    │  │  │                                      │\n└─────────────────────────────────────────┘     └──────────────────────────────────────┘\n                                             │\n\n                                          Network`, `53386502745400180000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">                                             │\n┌─────────────────────────────────────────┐     ┌──────────────────────────────────────┐\n│task_master.py                           │  │  │task_worker.py                        │\n│                                         │     │                                      │\n│  task = manager.get_task_queue()        │  │  │  task = manager.get_task_queue()     │\n│  result = manager.get_result_queue()    │     │  result = manager.get_result_queue() │\n│              │                          │  │  │              │                       │\n│              │                          │     │              │                       │\n│              ▼                          │  │  │              │                       │\n│  ┌─────────────────────────────────┐    │     │              │                       │\n│  │QueueManager                     │    │  │  │              │                       │\n│  │ ┌────────────┐ ┌──────────────┐ │    │     │              │                       │\n│  │ │ task_queue │ │ result_queue │ │&lt;───┼──┼──┼──────────────┘                       │\n│  │ └────────────┘ └──────────────┘ │    │     │                                      │\n│  └─────────────────────────────────┘    │  │  │                                      │\n└─────────────────────────────────────────┘     └──────────────────────────────────────┘\n                                             │\n\n                                          Network</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>而 Queue 之所以能通过网络访问，就是通过 QueueManager 实现的。由于 QueueManager 管理的不止一个 Queue，所以，要给每个 Queue 的网络调用接口起个名字，比如 <code class="language-text">get_task_queue</code>。</p>\n<p>authkey 有什么用？这是为了保证两台机器正常通信，不被其他机器恶意干扰。如果 <code class="language-text">task_worker.py</code> 的 authkey 和 <code class="language-text">task_master.py</code> 的 authkey 不一致，肯定连接不上。</p>\n<h3 id="小结-22"><a href="#%E5%B0%8F%E7%BB%93-22" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>Python 的分布式进程接口简单，封装良好，适合需要把繁重任务分布到多台机器的环境下。</p>\n<p>注意 Queue 的作用是用来传递任务和接收结果，每个任务的描述数据量要尽量小。比如发送一个处理日志文件的任务，就不要发送几百兆的日志文件本身，而是发送日志文件存放的完整路径，由 Worker 进程再去共享的磁盘上读取文件。</p>\n<h1 id="正则表达式"><a href="#%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>正则表达式</h1>\n<h2 id="re-模块"><a href="#re-%E6%A8%A1%E5%9D%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>re 模块</h2>\n<p>Python 提供 re 模块，包含所有正则表达式的功能。由于 Python 的字符串本身也用 \\ 转义，所以要特别注意：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63532156253947190000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`s = \'ABC\\\\-001\' # Python 的字符串\n# 对应的正则表达式字符串变成：\n# \'ABC\\-001\'`, `63532156253947190000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">s <span class="token operator">=</span> <span class="token string">\'ABC\\\\-001\'</span> <span class="token comment"># Python 的字符串</span>\n<span class="token comment"># 对应的正则表达式字符串变成：</span>\n<span class="token comment"># \'ABC\\-001\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>因此我们强烈建议使用 Python 的 r 前缀，就不用考虑转义的问题了：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="44136060973865510000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`s = r\'ABC\\-001\' # Python 的字符串\n# 对应的正则表达式字符串不变：\n# \'ABC\\-001\'`, `44136060973865510000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">s <span class="token operator">=</span> <span class="token string">r\'ABC\\-001\'</span> <span class="token comment"># Python 的字符串</span>\n<span class="token comment"># 对应的正则表达式字符串不变：</span>\n<span class="token comment"># \'ABC\\-001\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>先看看如何判断正则表达式是否匹配：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="80613779715369580000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> import re\n>>> re.match(r\'^\\d{3}\\-\\d{3,8}\\$\', \'010-12345\')\n<_sre.SRE_Match object; span=(0, 9), match=\'010-12345\'>\n>>> re.match(r\'^\\d{3}\\-\\d{3,8}\\$\', \'010 12345\')\n>>>`, `80613779715369580000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> re\n<span class="token operator">>></span><span class="token operator">></span> re<span class="token punctuation">.</span>match<span class="token punctuation">(</span><span class="token string">r\'^\\d{3}\\-\\d{3,8}$\'</span><span class="token punctuation">,</span> <span class="token string">\'010-12345\'</span><span class="token punctuation">)</span>\n<span class="token operator">&lt;</span>_sre<span class="token punctuation">.</span>SRE_Match <span class="token builtin">object</span><span class="token punctuation">;</span> span<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">,</span> match<span class="token operator">=</span><span class="token string">\'010-12345\'</span><span class="token operator">></span>\n<span class="token operator">>></span><span class="token operator">></span> re<span class="token punctuation">.</span>match<span class="token punctuation">(</span><span class="token string">r\'^\\d{3}\\-\\d{3,8}$\'</span><span class="token punctuation">,</span> <span class="token string">\'010 12345\'</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>match() 方法判断是否匹配，如果匹配成功，返回一个 Match 对象，否则返回 None。常见的判断方法就是：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21203400385801617000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`test = \'用户输入的字符串\'\nif re.match(r\'正则表达式\', test):\n    print(\'ok\')\nelse:\n    print(\'failed\')`, `21203400385801617000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">test <span class="token operator">=</span> <span class="token string">\'用户输入的字符串\'</span>\n<span class="token keyword">if</span> re<span class="token punctuation">.</span>match<span class="token punctuation">(</span><span class="token string">r\'正则表达式\'</span><span class="token punctuation">,</span> test<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'ok\'</span><span class="token punctuation">)</span>\n<span class="token keyword">else</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'failed\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id="切分字符串"><a href="#%E5%88%87%E5%88%86%E5%AD%97%E7%AC%A6%E4%B8%B2" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>切分字符串</h3>\n<p>用正则表达式切分字符串比用固定的字符更灵活，请看正常的切分代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="70677520851798170000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> \'a b   c\'.split(\' \')\n[\'a\', \'b\', \'\', \'\', \'c\']`, `70677520851798170000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token string">\'a b   c\'</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">\' \'</span><span class="token punctuation">)</span>\n<span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>嗯，无法识别连续的空格，用正则表达式试试：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="64248046403804815000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> re.split(r\'\\s+\', \'a b   c\')\n[\'a\', \'b\', \'c\']`, `64248046403804815000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> re<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">r\'\\s+\'</span><span class="token punctuation">,</span> <span class="token string">\'a b   c\'</span><span class="token punctuation">)</span>\n<span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>无论多少个空格都可以正常分割。加入 <code class="language-text">,</code> 试试：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="28923706226290280000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> re.split(r\'[\\s\\,]+\', \'a,b, c  d\')\n[\'a\', \'b\', \'c\', \'d\']`, `28923706226290280000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> re<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">r\'[\\s\\,]+\'</span><span class="token punctuation">,</span> <span class="token string">\'a,b, c  d\'</span><span class="token punctuation">)</span>\n<span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>再加入 <code class="language-text">;</code> 试试：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35711237360441905000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> re.split(r\'[\\s\\,\\;]+\', \'a,b;; c  d\')\n[\'a\', \'b\', \'c\', \'d\']`, `35711237360441905000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> re<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">r\'[\\s\\,\\;]+\'</span><span class="token punctuation">,</span> <span class="token string">\'a,b;; c  d\'</span><span class="token punctuation">)</span>\n<span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">,</span> <span class="token string">\'d\'</span><span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>如果用户输入了一组标签，下次记得用正则表达式来把不规范的输入转化成正确的数组。</p>\n<h3 id="分组"><a href="#%E5%88%86%E7%BB%84" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>分组</h3>\n<p>除了简单地判断是否匹配之外，正则表达式还有提取子串的强大功能。用 () 表示的就是要提取的分组（Group）。比如：</p>\n<p><code class="language-text">^(\\d{3})-(\\d{3,8})$</code> 分别定义了两个组，可以直接从匹配的字符串中提取出区号和本地号码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="83072307565258920000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> m = re.match(r\'^(\\d{3})-(\\d{3,8})\\$\', \'010-12345\')\n>>> m\n<_sre.SRE_Match object; span=(0, 9), match=\'010-12345\'>\n>>> m.group(0)\n\'010-12345\'\n>>> m.group(1)\n\'010\'\n>>> m.group(2)\n\'12345\'`, `83072307565258920000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> m <span class="token operator">=</span> re<span class="token punctuation">.</span>match<span class="token punctuation">(</span><span class="token string">r\'^(\\d{3})-(\\d{3,8})$\'</span><span class="token punctuation">,</span> <span class="token string">\'010-12345\'</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> m\n<span class="token operator">&lt;</span>_sre<span class="token punctuation">.</span>SRE_Match <span class="token builtin">object</span><span class="token punctuation">;</span> span<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">,</span> match<span class="token operator">=</span><span class="token string">\'010-12345\'</span><span class="token operator">></span>\n<span class="token operator">>></span><span class="token operator">></span> m<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>\n<span class="token string">\'010-12345\'</span>\n<span class="token operator">>></span><span class="token operator">></span> m<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>\n<span class="token string">\'010\'</span>\n<span class="token operator">>></span><span class="token operator">></span> m<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>\n<span class="token string">\'12345\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>如果正则表达式中定义了组，就可以在 Match 对象上用 group() 方法提取出子串来。</p>\n<p>注意到 group(0) 永远是与整个正则表达式相匹配的字符串，group(1)、group(2)…… 表示第 1、2、…… 个子串。</p>\n<p>提取子串非常有用。来看一个更凶残的例子：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="19110515960101646000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> t = \'19:05:30\'\n>>> m = re.match(r\'^(0[0-9]|1[0-9]|2[0-3]|[0-9])\\:(0[0-9]|1[0-9]|2[0-9]|3[0-9]|4[0-9]|5[0-9]|[0-9])\\:(0[0-9]|1[0-9]|2[0-9]|3[0-9]|4[0-9]|5[0-9]|[0-9])\\$\', t)\n>>> m.groups()\n(\'19\', \'05\', \'30\')`, `19110515960101646000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> t <span class="token operator">=</span> <span class="token string">\'19:05:30\'</span>\n<span class="token operator">>></span><span class="token operator">></span> m <span class="token operator">=</span> re<span class="token punctuation">.</span>match<span class="token punctuation">(</span><span class="token string">r\'^(0[0-9]|1[0-9]|2[0-3]|[0-9])\\:(0[0-9]|1[0-9]|2[0-9]|3[0-9]|4[0-9]|5[0-9]|[0-9])\\:(0[0-9]|1[0-9]|2[0-9]|3[0-9]|4[0-9]|5[0-9]|[0-9])$\'</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> m<span class="token punctuation">.</span>groups<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">(</span><span class="token string">\'19\'</span><span class="token punctuation">,</span> <span class="token string">\'05\'</span><span class="token punctuation">,</span> <span class="token string">\'30\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>这个正则表达式可以直接识别合法的时间。但是有些时候，用正则表达式也无法做到完全验证，比如识别日期：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="12127503740726686000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\'^(0[1-9]|1[0-2]|[0-9])-(0[1-9]|1[0-9]|2[0-9]|3[0-1]|[0-9])\\$\'`, `12127503740726686000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token string">\'^(0[1-9]|1[0-2]|[0-9])-(0[1-9]|1[0-9]|2[0-9]|3[0-1]|[0-9])$\'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>对于 ‘2-30’，‘4-31’ 这样的非法日期，用正则还是识别不了，或者说写出来非常困难，这时就需要程序配合识别了。</p>\n<h3 id="贪婪匹配"><a href="#%E8%B4%AA%E5%A9%AA%E5%8C%B9%E9%85%8D" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>贪婪匹配</h3>\n<p>最后需要特别指出的是，正则匹配默认是贪婪匹配，也就是匹配尽可能多的字符。举例如下，匹配出数字后面的 0：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="77210448899709400000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> re.match(r\'^(\\d+)(0*)\\$\', \'102300\').groups()\n(\'102300\', \'\')`, `77210448899709400000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> re<span class="token punctuation">.</span>match<span class="token punctuation">(</span><span class="token string">r\'^(\\d+)(0*)$\'</span><span class="token punctuation">,</span> <span class="token string">\'102300\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>groups<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">(</span><span class="token string">\'102300\'</span><span class="token punctuation">,</span> <span class="token string">\'\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>由于 <code class="language-text">\\d+</code> 采用贪婪匹配，直接把后面的 0 全部匹配了，结果 <code class="language-text">0*</code> 只能匹配空字符串了。</p>\n<p>必须让 <code class="language-text">\\d+</code> 采用非贪婪匹配（也就是尽可能少匹配），才能把后面的 0 匹配出来，加个 <code class="language-text">?</code> 就可以让 <code class="language-text">\\d+</code> 采用非贪婪匹配：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="63100397293164040000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> re.match(r\'^(\\d+?)(0*)\\$\', \'102300\').groups()\n(\'1023\', \'00\')`, `63100397293164040000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> re<span class="token punctuation">.</span>match<span class="token punctuation">(</span><span class="token string">r\'^(\\d+?)(0*)$\'</span><span class="token punctuation">,</span> <span class="token string">\'102300\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>groups<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">(</span><span class="token string">\'1023\'</span><span class="token punctuation">,</span> <span class="token string">\'00\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<h3 id="编译"><a href="#%E7%BC%96%E8%AF%91" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>编译</h3>\n<p>当我们在 Python 中使用正则表达式时，re 模块内部会干两件事情：</p>\n<ol>\n<li>编译正则表达式，如果正则表达式的字符串本身不合法，会报错；</li>\n<li>用编译后的正则表达式去匹配字符串。</li>\n</ol>\n<p>如果一个正则表达式要重复使用几千次，出于效率的考虑，我们可以预编译该正则表达式，接下来重复使用时就不需要编译这个步骤了，直接匹配：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="36727791957108780000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`>>> import re\n# 编译:\n>>> re_telephone = re.compile(r\'^(\\d{3})-(\\d{3,8})\\$\')\n# 使用：\n>>> re_telephone.match(\'010-12345\').groups()\n(\'010\', \'12345\')\n>>> re_telephone.match(\'010-8086\').groups()\n(\'010\', \'8086\')`, `36727791957108780000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> re\n<span class="token comment"># 编译:</span>\n<span class="token operator">>></span><span class="token operator">></span> re_telephone <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span><span class="token string">r\'^(\\d{3})-(\\d{3,8})$\'</span><span class="token punctuation">)</span>\n<span class="token comment"># 使用：</span>\n<span class="token operator">>></span><span class="token operator">></span> re_telephone<span class="token punctuation">.</span>match<span class="token punctuation">(</span><span class="token string">\'010-12345\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>groups<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">(</span><span class="token string">\'010\'</span><span class="token punctuation">,</span> <span class="token string">\'12345\'</span><span class="token punctuation">)</span>\n<span class="token operator">>></span><span class="token operator">></span> re_telephone<span class="token punctuation">.</span>match<span class="token punctuation">(</span><span class="token string">\'010-8086\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>groups<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">(</span><span class="token string">\'010\'</span><span class="token punctuation">,</span> <span class="token string">\'8086\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>编译后生成 Regular Expression 对象，由于该对象自己包含了正则表达式，所以调用对应的方法时不用给出正则字符串。</p>\n<h3 id="小结-23"><a href="#%E5%B0%8F%E7%BB%93-23" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>正则表达式非常强大，要在短短的一节里讲完是不可能的。要讲清楚正则的所有内容，可以写一本厚厚的书了。如果你经常遇到正则表达式的问题，你可能需要一本正则表达式的参考书。</p>\n<h1 id="virtualenv"><a href="#virtualenv" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>virtualenv</h1>\n<p>virtualenv 就是用来为一个应用创建一套“隔离”的 Python 运行环境。</p>\n<p>首先，我们用 pip 安装 virtualenv：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="25221413175476190000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`\\$ pip3 install virtualenv`, `25221413175476190000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ pip3 <span class="token function">install</span> virtualenv</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>然后，假定我们要开发一个新的项目，需要一套独立的 Python 运行环境，可以这么做：</p>\n<p>第一步，创建目录：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="32520038538301743000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Mac:~ michael\\$ mkdir myproject\nMac:~ michael\\$ cd myproject/\nMac:myproject michael\\$`, `32520038538301743000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">Mac:~ michael$ <span class="token function">mkdir</span> myproject\nMac:~ michael$ <span class="token builtin class-name">cd</span> myproject/\nMac:myproject michael$</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>\n<p>第二步，创建一个独立的 Python 运行环境，命名为 venv：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="22296157026321440000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Mac:myproject michael\\$ virtualenv --no-site-packages venv\nUsing base prefix \'/usr/local/.../Python.framework/Versions/3.4\'\nNew python executable in venv/bin/python3.4\nAlso creating executable in venv/bin/python\nInstalling setuptools, pip, wheel...done.`, `22296157026321440000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">Mac:myproject michael$ virtualenv --no-site-packages venv\nUsing base prefix <span class="token string">\'/usr/local/.../Python.framework/Versions/3.4\'</span>\nNew python executable <span class="token keyword">in</span> venv/bin/python3.4\nAlso creating executable <span class="token keyword">in</span> venv/bin/python\nInstalling setuptools, pip, wheel<span class="token punctuation">..</span>.done.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>命令 virtualenv 就可以创建一个独立的 Python 运行环境，我们还加上了参数 —no-site-packages，这样，已经安装到系统 Python 环境中的所有第三方包都不会复制过来，这样，我们就得到了一个不带任何第三方包的“干净”的 Python 运行环境。</p>\n<p>新建的 Python 环境被放到当前目录下的 venv 目录。有了 venv 这个 Python 环境，可以用 source 进入该环境：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="42511827207377230000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Mac:myproject michael\\$ source venv/bin/activate\n(venv)Mac:myproject michael\\$`, `42511827207377230000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">Mac:myproject michael$ <span class="token builtin class-name">source</span> venv/bin/activate\n<span class="token punctuation">(</span>venv<span class="token punctuation">)</span>Mac:myproject michael$</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>注意到命令提示符变了，有个 <code class="language-text">(venv)</code> 前缀，表示当前环境是一个名为 venv 的 Python 环境。</p>\n<p>下面正常安装各种第三方包，并运行 python 命令：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="916234753579492400"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(venv)Mac:myproject michael\\$ pip install jinja2\n...\nSuccessfully installed jinja2-2.7.3 markupsafe-0.23\n(venv)Mac:myproject michael\\$ python myapp.py\n...`, `916234753579492400`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token punctuation">(</span>venv<span class="token punctuation">)</span>Mac:myproject michael$ pip <span class="token function">install</span> jinja2\n<span class="token punctuation">..</span>.\nSuccessfully installed jinja2-2.7.3 markupsafe-0.23\n<span class="token punctuation">(</span>venv<span class="token punctuation">)</span>Mac:myproject michael$ python myapp.py\n<span class="token punctuation">..</span>.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>在 venv 环境下，用 pip 安装的包都被安装到 venv 这个环境下，系统 Python 环境不受任何影响。也就是说，venv 环境是专门针对 myproject 这个应用创建的。</p>\n<p>退出当前的 venv 环境，使用 deactivate 命令：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89987536639547690000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`(venv)Mac:myproject michael\\$ deactivate\nMac:myproject michael\\$`, `89987536639547690000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token punctuation">(</span>venv<span class="token punctuation">)</span>Mac:myproject michael$ deactivate\nMac:myproject michael$</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>\n<p>此时就回到了正常的环境，现在 pip 或 python 均是在系统 Python 环境下执行。</p>\n<p>完全可以针对每个应用创建独立的 Python 运行环境，这样就可以对每个应用的 Python 环境进行隔离。</p>\n<p>virtualenv 是如何创建“独立”的 Python 运行环境的呢？原理很简单，就是把系统 Python 复制一份到 virtualenv 的环境，用命令 <code class="language-text">source venv/bin/activate</code> 进入一个 virtualenv 环境时，virtualenv 会修改相关环境变量，让命令 python 和 pip 均指向当前的 virtualenv 环境。</p>\n<h2 id="小结-24"><a href="#%E5%B0%8F%E7%BB%93-24" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h2>\n<p>virtualenv 为应用提供了隔离的 Python 运行环境，解决了不同应用间多版本的冲突问题。</p>\n<h1 id="异步-io-1"><a href="#%E5%BC%82%E6%AD%A5-io-1" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>异步 IO</h1>\n<p>在 IO 编程一节中，我们已经知道，CPU 的速度远远快于磁盘、网络等 IO。在一个线程中，CPU 执行代码的速度极快，然而，一旦遇到 IO 操作，如读写文件、发送网络数据时，就需要等待 IO 操作完成，才能继续进行下一步操作。这种情况称为同步 IO。</p>\n<p>在 IO 操作的过程中，当前线程被挂起，而其他需要 CPU 执行的代码就无法被当前线程执行了。</p>\n<p>因为一个 IO 操作就阻塞了当前线程，导致其他代码无法执行，所以我们必须使用多线程或者多进程来并发执行代码，为多个用户服务。每个用户都会分配一个线程，如果遇到 IO 导致线程被挂起，其他用户的线程不受影响。</p>\n<p>多线程和多进程的模型虽然解决了并发问题，但是系统不能无上限地增加线程。由于系统切换线程的开销也很大，所以，一旦线程数量过多，CPU 的时间就花在线程切换上了，真正运行代码的时间就少了，结果导致性能严重下降。</p>\n<p>由于我们要解决的问题是 CPU 高速执行能力和 IO 设备的龟速严重不匹配，多线程和多进程只是解决这一问题的一种方法。</p>\n<p>另一种解决 IO 问题的方法是异步 IO。当代码需要执行一个耗时的 IO 操作时，它只发出 IO 指令，并不等待 IO 结果，然后就去执行其他代码了。一段时间后，当 IO 返回结果时，再通知 CPU 进行处理。</p>\n<p>可以想象如果按普通顺序写出的代码实际上是没法完成异步 IO 的：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="69459139745891570000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`do_some_code()\nf = open(\'/path/to/file\', \'r\')\nr = f.read() # <== 线程停在此处等待 IO 操作结果\n# IO 操作完成后线程才能继续执行:\ndo_some_code(r)`, `69459139745891570000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">do_some_code<span class="token punctuation">(</span><span class="token punctuation">)</span>\nf <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'/path/to/file\'</span><span class="token punctuation">,</span> <span class="token string">\'r\'</span><span class="token punctuation">)</span>\nr <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># &lt;== 线程停在此处等待 IO 操作结果</span>\n<span class="token comment"># IO 操作完成后线程才能继续执行:</span>\ndo_some_code<span class="token punctuation">(</span>r<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>所以，同步 IO 模型的代码是无法实现异步 IO 模型的。</p>\n<p>异步 IO 模型需要一个消息循环，在消息循环中，主线程不断地重复“读取消息-处理消息”这一过程：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="29171628182333075000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`loop = get_event_loop()\nwhile True:\n    event = loop.get_event()\n    process_event(event)`, `29171628182333075000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py">loop <span class="token operator">=</span> get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>\n    event <span class="token operator">=</span> loop<span class="token punctuation">.</span>get_event<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    process_event<span class="token punctuation">(</span>event<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>消息模型其实早在应用在桌面应用程序中了。一个 GUI 程序的主线程就负责不停地读取消息并处理消息。所有的键盘、鼠标等消息都被发送到 GUI 程序的消息队列中，然后由 GUI 程序的主线程处理。</p>\n<p>由于 GUI 线程处理键盘、鼠标等消息的速度非常快，所以用户感觉不到延迟。某些时候，GUI 线程在一个消息处理的过程中遇到问题导致一次消息处理时间过长，此时，用户会感觉到整个 GUI 程序停止响应了，敲键盘、点鼠标都没有反应。这种情况说明在消息模型中，处理一个消息必须非常迅速，否则，主线程将无法及时处理消息队列中的其他消息，导致程序看上去停止响应。</p>\n<p>消息模型是如何解决同步 IO 必须等待 IO 操作这一问题的呢？当遇到 IO 操作时，代码只负责发出 IO 请求，不等待 IO 结果，然后直接结束本轮消息处理，进入下一轮消息处理过程。当 IO 操作完成后，将收到一条“IO 完成”的消息，处理该消息时就可以直接获取 IO 操作结果。</p>\n<p>在“发出 IO 请求”到收到“IO 完成”的这段时间里，同步 IO 模型下，主线程只能挂起，但异步 IO 模型下，主线程并没有休息，而是在消息循环中继续处理其他消息。这样，在异步 IO 模型下，一个线程就可以同时处理多个 IO 请求，并且没有切换线程的操作。对于大多数 IO 密集型的应用程序，使用异步 IO 将大大提升系统的多任务处理能力。</p>\n<h2 id="协程"><a href="#%E5%8D%8F%E7%A8%8B" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>协程</h2>\n<p>在学习异步 IO 模型前，我们先来了解协程。</p>\n<p>协程，又称微线程，纤程。英文名 Coroutine。</p>\n<p>协程的概念很早就提出来了，但直到最近几年才在某些语言（如 Lua）中得到广泛应用。</p>\n<p>子程序，或者称为函数，在所有语言中都是层级调用，比如 A 调用 B，B 在执行过程中又调用了 C，C 执行完毕返回，B 执行完毕返回，最后是 A 执行完毕。</p>\n<p>所以子程序调用是通过栈实现的，一个线程就是执行一个子程序。</p>\n<p>子程序调用总是一个入口，一次返回，调用顺序是明确的。而协程的调用和子程序不同。</p>\n<p>协程看上去也是子程序，但执行过程中，在子程序内部可中断，然后转而执行别的子程序，在适当的时候再返回来接着执行。</p>\n<p>注意，在一个子程序中中断，去执行其他子程序，不是函数调用，有点类似 CPU 的中断。比如子程序 A、B：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="62299454358802310000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def A():\n    print(\'1\')\n    print(\'2\')\n    print(\'3\')\n\ndef B():\n    print(\'x\')\n    print(\'y\')\n    print(\'z\')`, `62299454358802310000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'1\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'2\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'3\'</span><span class="token punctuation">)</span>\n\n<span class="token keyword">def</span> <span class="token function">B</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'x\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'y\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'z\'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>假设由协程执行，在执行 A 的过程中，可以随时中断，去执行 B，B 也可能在执行过程中中断再去执行 A，结果可能是：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="23444712776737030000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`1\n2\nx\ny\n3\nz`, `23444712776737030000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title=""\n              >\n                \n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">1\n2\nx\ny\n3\nz</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>但是在 A 中是没有调用 B 的，所以协程的调用比函数调用理解起来要难一些。</p>\n<p>看起来 A、B 的执行有点像多线程，但协程的特点在于是一个线程执行，那和多线程比，协程有何优势？</p>\n<ol>\n<li>最大的优势就是协程极高的执行效率。因为子程序切换不是线程切换，而是由程序自身控制，因此，没有线程切换的开销，和多线程比，线程数量越多，协程的性能优势就越明显。</li>\n<li>第二大优势就是不需要多线程的锁机制，因为只有一个线程，也不存在同时写变量冲突，在协程中控制共享资源不加锁，只需要判断状态就好了，所以执行效率比多线程高很多。</li>\n</ol>\n<p>因为协程是一个线程执行，那怎么利用多核 CPU 呢？最简单的方法是多进程+协程，既充分利用多核，又充分发挥协程的高效率，可获得极高的性能。</p>\n<p>Python 对协程的支持是通过 generator 实现的。</p>\n<p>在 generator 中，我们不但可以通过 for 循环来迭代，还可以不断调用 next() 函数获取由 yield 语句返回的下一个值。</p>\n<p>但是 Python 的 yield 不但可以返回一个值，它还可以接收调用者发出的参数。</p>\n<p>来看例子：</p>\n<p>传统的生产者-消费者模型是一个线程写消息，一个线程取消息，通过锁机制控制队列和等待，但一不小心就可能死锁。</p>\n<p>如果改用协程，生产者生产消息后，直接通过 yield 跳转到消费者开始执行，待消费者执行完毕后，切换回生产者继续生产，效率极高：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89264531773623060000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`def consumer():\n    r = \'\'\n    while True:\n        n = yield r\n        if not n:\n            return\n        print(\'[CONSUMER] Consuming %s...\' % n)\n        r = \'200 OK\'\n\ndef produce(c):\n    c.send(None)\n    n = 0\n    while n < 5:\n        n = n + 1\n        print(\'[PRODUCER] Producing %s...\' % n)\n        r = c.send(n)\n        print(\'[PRODUCER] Consumer return: %s\' % r)\n    c.close()\n\nc = consumer()\nproduce(c)`, `89264531773623060000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">def</span> <span class="token function">consumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    r <span class="token operator">=</span> <span class="token string">\'\'</span>\n    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>\n        n <span class="token operator">=</span> <span class="token keyword">yield</span> r\n        <span class="token keyword">if</span> <span class="token keyword">not</span> n<span class="token punctuation">:</span>\n            <span class="token keyword">return</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'[CONSUMER] Consuming %s...\'</span> <span class="token operator">%</span> n<span class="token punctuation">)</span>\n        r <span class="token operator">=</span> <span class="token string">\'200 OK\'</span>\n\n<span class="token keyword">def</span> <span class="token function">produce</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    c<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span>\n    n <span class="token operator">=</span> <span class="token number">0</span>\n    <span class="token keyword">while</span> n <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">:</span>\n        n <span class="token operator">=</span> n <span class="token operator">+</span> <span class="token number">1</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'[PRODUCER] Producing %s...\'</span> <span class="token operator">%</span> n<span class="token punctuation">)</span>\n        r <span class="token operator">=</span> c<span class="token punctuation">.</span>send<span class="token punctuation">(</span>n<span class="token punctuation">)</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'[PRODUCER] Consumer return: %s\'</span> <span class="token operator">%</span> r<span class="token punctuation">)</span>\n    c<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\nc <span class="token operator">=</span> consumer<span class="token punctuation">(</span><span class="token punctuation">)</span>\nproduce<span class="token punctuation">(</span>c<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>执行结果：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="59781124227494890000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`[PRODUCER] Producing 1...\n[CONSUMER] Consuming 1...\n[PRODUCER] Consumer return: 200 OK\n[PRODUCER] Producing 2...\n[CONSUMER] Consuming 2...\n[PRODUCER] Consumer return: 200 OK\n[PRODUCER] Producing 3...\n[CONSUMER] Consuming 3...\n[PRODUCER] Consumer return: 200 OK\n[PRODUCER] Producing 4...\n[CONSUMER] Consuming 4...\n[PRODUCER] Consumer return: 200 OK\n[PRODUCER] Producing 5...\n[CONSUMER] Consuming 5...\n[PRODUCER] Consumer return: 200 OK`, `59781124227494890000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token punctuation">[</span>PRODUCER<span class="token punctuation">]</span> Producing <span class="token number">1</span><span class="token punctuation">..</span>.\n<span class="token punctuation">[</span>CONSUMER<span class="token punctuation">]</span> Consuming <span class="token number">1</span><span class="token punctuation">..</span>.\n<span class="token punctuation">[</span>PRODUCER<span class="token punctuation">]</span> Consumer return: <span class="token number">200</span> OK\n<span class="token punctuation">[</span>PRODUCER<span class="token punctuation">]</span> Producing <span class="token number">2</span><span class="token punctuation">..</span>.\n<span class="token punctuation">[</span>CONSUMER<span class="token punctuation">]</span> Consuming <span class="token number">2</span><span class="token punctuation">..</span>.\n<span class="token punctuation">[</span>PRODUCER<span class="token punctuation">]</span> Consumer return: <span class="token number">200</span> OK\n<span class="token punctuation">[</span>PRODUCER<span class="token punctuation">]</span> Producing <span class="token number">3</span><span class="token punctuation">..</span>.\n<span class="token punctuation">[</span>CONSUMER<span class="token punctuation">]</span> Consuming <span class="token number">3</span><span class="token punctuation">..</span>.\n<span class="token punctuation">[</span>PRODUCER<span class="token punctuation">]</span> Consumer return: <span class="token number">200</span> OK\n<span class="token punctuation">[</span>PRODUCER<span class="token punctuation">]</span> Producing <span class="token number">4</span><span class="token punctuation">..</span>.\n<span class="token punctuation">[</span>CONSUMER<span class="token punctuation">]</span> Consuming <span class="token number">4</span><span class="token punctuation">..</span>.\n<span class="token punctuation">[</span>PRODUCER<span class="token punctuation">]</span> Consumer return: <span class="token number">200</span> OK\n<span class="token punctuation">[</span>PRODUCER<span class="token punctuation">]</span> Producing <span class="token number">5</span><span class="token punctuation">..</span>.\n<span class="token punctuation">[</span>CONSUMER<span class="token punctuation">]</span> Consuming <span class="token number">5</span><span class="token punctuation">..</span>.\n<span class="token punctuation">[</span>PRODUCER<span class="token punctuation">]</span> Consumer return: <span class="token number">200</span> OK</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意到 consumer 函数是一个 generator，把一个 consumer 传入 produce 后：</p>\n<ol>\n<li>首先调用 c.send(None) 启动生成器；</li>\n<li>然后，一旦生产了东西，通过 c.send(n) 切换到 consumer 执行；</li>\n<li>consumer 通过 yield 拿到消息处理，又通过 yield 把结果传回；</li>\n<li>produce 拿到 consumer 处理的结果，继续生产下一条消息；</li>\n<li>produce 决定不生产了，通过 c.close() 关闭 consumer，整个过程结束。</li>\n</ol>\n<p>整个流程无锁，由一个线程执行，produce 和 consumer 协作完成任务，所以称为“协程”，而非线程的抢占式多任务。</p>\n<p>最后套用 Donald Knuth 的一句话总结协程的特点：</p>\n<p>“子程序就是协程的一种特例。”</p>\n<h2 id="asyncio"><a href="#asyncio" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>asyncio</h2>\n<p>asyncio 是 Python 3.4 版本引入的标准库，直接内置了对异步 IO 的支持。</p>\n<p>asyncio 的编程模型就是一个消息循环。我们从 asyncio 模块中直接获取一个 EventLoop 的引用，然后把需要执行的协程扔到 EventLoop 中执行，就实现了异步 IO。</p>\n<p>用 asyncio 实现 Hello world 代码如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="21950512904951513000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import asyncio\n\n@asyncio.coroutine\ndef hello():\n    print(&quot;Hello world!&quot;)\n    # 异步调用 asyncio.sleep(1):\n    r = yield from asyncio.sleep(1)\n    print(&quot;Hello again!&quot;)\n\n# 获取 EventLoop:\nloop = asyncio.get_event_loop()\n# 执行 coroutine\nloop.run_until_complete(hello())\nloop.close()`, `21950512904951513000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> asyncio\n\n@asyncio<span class="token punctuation">.</span>coroutine\n<span class="token keyword">def</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Hello world!"</span><span class="token punctuation">)</span>\n    <span class="token comment"># 异步调用 asyncio.sleep(1):</span>\n    r <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token keyword">from</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Hello again!"</span><span class="token punctuation">)</span>\n\n<span class="token comment"># 获取 EventLoop:</span>\nloop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token comment"># 执行 coroutine</span>\nloop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>hello<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\nloop<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><code class="language-text">@asyncio.coroutine</code> 把一个 generator 标记为 coroutine 类型，然后，我们就把这个 coroutine 扔到 EventLoop 中执行。</p>\n<p>hello() 会首先打印出 Hello world!，然后，yield from 语法可以让我们方便地调用另一个 generator。由于 asyncio.sleep() 也是一个 coroutine，所以线程不会等待 asyncio.sleep()，而是直接中断并执行下一个消息循环。当 asyncio.sleep() 返回时，线程就可以从 yield from 拿到返回值（此处是 None），然后接着执行下一行语句。</p>\n<p>把 asyncio.sleep(1) 看成是一个耗时 1 秒的 IO 操作，在此期间，主线程并未等待，而是去执行 EventLoop 中其他可以执行的 coroutine 了，因此可以实现并发执行。</p>\n<p>我们用 Task 封装两个 coroutine 试试：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="35792371509737710000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import threading\nimport asyncio\n\n@asyncio.coroutine\ndef hello():\n    print(\'Hello world! (%s)\' % threading.currentThread())\n    yield from asyncio.sleep(1)\n    print(\'Hello again! (%s)\' % threading.currentThread())\n\nloop = asyncio.get_event_loop()\ntasks = [hello(), hello()]\nloop.run_until_complete(asyncio.wait(tasks))\nloop.close()`, `35792371509737710000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> threading\n<span class="token keyword">import</span> asyncio\n\n@asyncio<span class="token punctuation">.</span>coroutine\n<span class="token keyword">def</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Hello world! (%s)\'</span> <span class="token operator">%</span> threading<span class="token punctuation">.</span>currentThread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token keyword">from</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Hello again! (%s)\'</span> <span class="token operator">%</span> threading<span class="token punctuation">.</span>currentThread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\nloop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>\ntasks <span class="token operator">=</span> <span class="token punctuation">[</span>hello<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> hello<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>\nloop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span>tasks<span class="token punctuation">)</span><span class="token punctuation">)</span>\nloop<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>观察执行过程：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88603076357675430000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`Hello world! (<_MainThread(MainThread, started 140735195337472)>)\nHello world! (<_MainThread(MainThread, started 140735195337472)>)\n(暂停约1秒)\nHello again! (<_MainThread(MainThread, started 140735195337472)>)\nHello again! (<_MainThread(MainThread, started 140735195337472)>)`, `88603076357675430000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">Hello world<span class="token operator">!</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>_MainThread<span class="token punctuation">(</span>MainThread, started <span class="token number">140735195337472</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token punctuation">)</span>\nHello world<span class="token operator">!</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>_MainThread<span class="token punctuation">(</span>MainThread, started <span class="token number">140735195337472</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token punctuation">)</span>\n<span class="token punctuation">(</span>暂停约1秒<span class="token punctuation">)</span>\nHello again<span class="token operator">!</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>_MainThread<span class="token punctuation">(</span>MainThread, started <span class="token number">140735195337472</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token punctuation">)</span>\nHello again<span class="token operator">!</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>_MainThread<span class="token punctuation">(</span>MainThread, started <span class="token number">140735195337472</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>由打印的当前线程名称可以看出，两个 coroutine 是由同一个线程并发执行的。</p>\n<p>如果把 asyncio.sleep() 换成真正的 IO 操作，则多个 coroutine 就可以由一个线程并发执行。</p>\n<p>我们用 asyncio 的异步网络连接来获取 sina、sohu 和 163 的网站首页：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="81942954316181590000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import asyncio\n\n@asyncio.coroutine\ndef wget(host):\n    print(\'wget %s...\' % host)\n    connect = asyncio.open_connection(host, 80)\n    reader, writer = yield from connect\n    header = \'GET / HTTP/1.0\\r\\nHost: %s\\r\\n\\r\\n\' % host\n    writer.write(header.encode(\'utf-8\'))\n    yield from writer.drain()\n    while True:\n        line = yield from reader.readline()\n        if line == b\'\\r\\n\':\n            break\n        print(\'%s header > %s\' % (host, line.decode(\'utf-8\').rstrip()))\n    # Ignore the body, close the socket\n    writer.close()\n\nloop = asyncio.get_event_loop()\ntasks = [wget(host) for host in [\'www.sina.com.cn\', \'www.sohu.com\', \'www.163.com\']]\nloop.run_until_complete(asyncio.wait(tasks))\nloop.close()`, `81942954316181590000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> asyncio\n\n@asyncio<span class="token punctuation">.</span>coroutine\n<span class="token keyword">def</span> <span class="token function">wget</span><span class="token punctuation">(</span>host<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'wget %s...\'</span> <span class="token operator">%</span> host<span class="token punctuation">)</span>\n    connect <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>open_connection<span class="token punctuation">(</span>host<span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">)</span>\n    reader<span class="token punctuation">,</span> writer <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token keyword">from</span> connect\n    header <span class="token operator">=</span> <span class="token string">\'GET / HTTP/1.0\\r\\nHost: %s\\r\\n\\r\\n\'</span> <span class="token operator">%</span> host\n    writer<span class="token punctuation">.</span>write<span class="token punctuation">(</span>header<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">\'utf-8\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token keyword">yield</span> <span class="token keyword">from</span> writer<span class="token punctuation">.</span>drain<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>\n        line <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token keyword">from</span> reader<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">if</span> line <span class="token operator">==</span> <span class="token string">b\'\\r\\n\'</span><span class="token punctuation">:</span>\n            <span class="token keyword">break</span>\n        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'%s header > %s\'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>host<span class="token punctuation">,</span> line<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">\'utf-8\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rstrip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token comment"># Ignore the body, close the socket</span>\n    writer<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\nloop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>\ntasks <span class="token operator">=</span> <span class="token punctuation">[</span>wget<span class="token punctuation">(</span>host<span class="token punctuation">)</span> <span class="token keyword">for</span> host <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">\'www.sina.com.cn\'</span><span class="token punctuation">,</span> <span class="token string">\'www.sohu.com\'</span><span class="token punctuation">,</span> <span class="token string">\'www.163.com\'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>\nloop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span>tasks<span class="token punctuation">)</span><span class="token punctuation">)</span>\nloop<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>执行结果如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="27884832409784830000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`wget www.sohu.com...\nwget www.sina.com.cn...\nwget www.163.com...\n(等待一段时间)\n(打印出sohu的header)\nwww.sohu.com header > HTTP/1.1 200 OK\nwww.sohu.com header > Content-Type: text/html\n...\n(打印出sina的header)\nwww.sina.com.cn header > HTTP/1.1 200 OK\nwww.sina.com.cn header > Date: Wed, 20 May 2015 04:56:33 GMT\n...\n(打印出163的header)\nwww.163.com header > HTTP/1.0 302 Moved Temporarily\nwww.163.com header > Server: Cdn Cache Server V2.0\n...`, `27884832409784830000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token function">wget</span> www.sohu.com<span class="token punctuation">..</span>.\n<span class="token function">wget</span> www.sina.com.cn<span class="token punctuation">..</span>.\n<span class="token function">wget</span> www.163.com<span class="token punctuation">..</span>.\n<span class="token punctuation">(</span>等待一段时间<span class="token punctuation">)</span>\n<span class="token punctuation">(</span>打印出sohu的header<span class="token punctuation">)</span>\nwww.sohu.com header <span class="token operator">></span> HTTP/1.1 <span class="token number">200</span> OK\nwww.sohu.com header <span class="token operator">></span> Content-Type: text/html\n<span class="token punctuation">..</span>.\n<span class="token punctuation">(</span>打印出sina的header<span class="token punctuation">)</span>\nwww.sina.com.cn header <span class="token operator">></span> HTTP/1.1 <span class="token number">200</span> OK\nwww.sina.com.cn header <span class="token operator">></span> Date: Wed, <span class="token number">20</span> May <span class="token number">2015</span> 04:56:33 GMT\n<span class="token punctuation">..</span>.\n<span class="token punctuation">(</span>打印出163的header<span class="token punctuation">)</span>\nwww.163.com header <span class="token operator">></span> HTTP/1.0 <span class="token number">302</span> Moved Temporarily\nwww.163.com header <span class="token operator">></span> Server: Cdn Cache Server V2.0\n<span class="token punctuation">..</span>.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>可见 3 个连接由一个线程通过 coroutine 并发完成。</p>\n<h3 id="小结-25"><a href="#%E5%B0%8F%E7%BB%93-25" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>asyncio 提供了完善的异步 IO 支持；</p>\n<p>异步操作需要在 coroutine 中通过 yield from 完成；</p>\n<p>多个 coroutine 可以封装成一组 Task 然后并发执行。</p>\n<h2 id="async--await"><a href="#async--await" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>async / await</h2>\n<p>用 asyncio 提供的 <code class="language-text">@asyncio.coroutine</code> 可以把一个 generator 标记为 coroutine 类型，然后在 coroutine 内部用 yield from 调用另一个 coroutine 实现异步操作。</p>\n<p>为了简化并更好地标识异步 IO，从 Python 3.5 开始引入了新的语法 async 和 await，可以让 coroutine 的代码更简洁易读。</p>\n<p>请注意，async 和 await 是针对 coroutine 的新语法，要使用新的语法，只需要做两步简单的替换：</p>\n<ol>\n<li>把 <code class="language-text">@asyncio.coroutine</code> 替换为 async；</li>\n<li>把 yield from 替换为 await。</li>\n</ol>\n<p>让我们对比一下上一节的代码：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="89778656362168500000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`@asyncio.coroutine\ndef hello():\n    print(&quot;Hello world!&quot;)\n    r = yield from asyncio.sleep(1)\n    print(&quot;Hello again!&quot;)`, `89778656362168500000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token decorator annotation punctuation">@asyncio<span class="token punctuation">.</span>coroutine</span>\n<span class="token keyword">def</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Hello world!"</span><span class="token punctuation">)</span>\n    r <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token keyword">from</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Hello again!"</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>用新语法重新编写如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="26013620428227457000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`async def hello():\n    print(&quot;Hello world!&quot;)\n    r = await asyncio.sleep(1)\n    print(&quot;Hello again!&quot;)`, `26013620428227457000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Hello world!"</span><span class="token punctuation">)</span>\n    r <span class="token operator">=</span> <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Hello again!"</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>剩下的代码保持不变。</p>\n<h3 id="小结-26"><a href="#%E5%B0%8F%E7%BB%93-26" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>小结</h3>\n<p>Python 从 3.5 版本开始为 asyncio 提供了 async 和 await 的新语法；</p>\n<p>注意新语法只能用在 Python 3.5 以及后续版本，如果使用 3.4 版本，则仍需使用上一节的方案。</p>\n<h2 id="aiohttp"><a href="#aiohttp" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>aiohttp</h2>\n<p>asyncio 可以实现单线程并发 IO 操作。如果仅用在客户端，发挥的威力不大。如果把 asyncio 用在服务器端，例如 Web 服务器，由于 HTTP 连接就是 IO 操作，因此可以用单线程 + coroutine 实现多用户的高并发支持。</p>\n<p>asyncio 实现了 TCP、UDP、SSL 等协议，aiohttp 则是基于 asyncio 实现的 HTTP 框架。</p>\n<p>我们先安装 aiohttp：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="53881791950582140000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`pip install aiohttp`, `53881791950582140000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="bash"\n              >\n                <span class="gatsby-code-button-language">bash</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">pip <span class="token function">install</span> aiohttp</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>\n<p>然后编写一个 HTTP 服务器，分别处理以下 URL：</p>\n<ul>\n<li><code class="language-text">/</code> - 首页返回 <code class="language-text">b&#39;&lt;h1&gt;Index&lt;/h1&gt;&#39;</code>；</li>\n<li><code class="language-text">/hello/{name}</code> - 根据 URL 参数返回文本 <code class="language-text">hello, %s!</code>。</li>\n</ul>\n<p>代码如下：</p>\n<div\n              class="gatsby-code-button-container"\n              data-toaster-id="88880972511754860000"\n              data-toaster-class="gatsby-code-button-toaster"\n              data-toaster-text-class="gatsby-code-button-toaster-text"\n              data-toaster-text="复制成功"\n              data-toaster-duration="3500"\n              onClick="copyToClipboard(`import asyncio\n\nfrom aiohttp import web\n\nasync def index(request):\n    await asyncio.sleep(0.5)\n    return web.Response(body=b\'<h1>Index</h1>\')\n\nasync def hello(request):\n    await asyncio.sleep(0.5)\n    text = \'<h1>hello, %s!</h1>\' % request.match_info[\'name\']\n    return web.Response(body=text.encode(\'utf-8\'))\n\nasync def init(loop):\n    app = web.Application(loop=loop)\n    app.router.add_route(\'GET\', \'/\', index)\n    app.router.add_route(\'GET\', \'/hello/{name}\', hello)\n    srv = await loop.create_server(app.make_handler(), \'127.0.0.1\', 8000)\n    print(\'Server started at http://127.0.0.1:8000...\')\n    return srv\n\nloop = asyncio.get_event_loop()\nloop.run_until_complete(init(loop))\nloop.run_forever()`, `88880972511754860000`)"\n            >\n              <div\n                class="gatsby-code-button"\n                title="py"\n              >\n                <span class="gatsby-code-button-language">py</span>\n                <span class="gatsby-code-button-text-icon">复制代码</span>\n              </div>\n            </div>\n<div class="gatsby-highlight" data-language="py"><pre style="counter-reset: linenumber NaN" class="language-py line-numbers"><code class="language-py"><span class="token keyword">import</span> asyncio\n\n<span class="token keyword">from</span> aiohttp <span class="token keyword">import</span> web\n\n<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>\n    <span class="token keyword">return</span> web<span class="token punctuation">.</span>Response<span class="token punctuation">(</span>body<span class="token operator">=</span><span class="token string">b\'&lt;h1>Index&lt;/h1>\'</span><span class="token punctuation">)</span>\n\n<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">hello</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>\n    text <span class="token operator">=</span> <span class="token string">\'&lt;h1>hello, %s!&lt;/h1>\'</span> <span class="token operator">%</span> request<span class="token punctuation">.</span>match_info<span class="token punctuation">[</span><span class="token string">\'name\'</span><span class="token punctuation">]</span>\n    <span class="token keyword">return</span> web<span class="token punctuation">.</span>Response<span class="token punctuation">(</span>body<span class="token operator">=</span>text<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">\'utf-8\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">init</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    app <span class="token operator">=</span> web<span class="token punctuation">.</span>Application<span class="token punctuation">(</span>loop<span class="token operator">=</span>loop<span class="token punctuation">)</span>\n    app<span class="token punctuation">.</span>router<span class="token punctuation">.</span>add_route<span class="token punctuation">(</span><span class="token string">\'GET\'</span><span class="token punctuation">,</span> <span class="token string">\'/\'</span><span class="token punctuation">,</span> index<span class="token punctuation">)</span>\n    app<span class="token punctuation">.</span>router<span class="token punctuation">.</span>add_route<span class="token punctuation">(</span><span class="token string">\'GET\'</span><span class="token punctuation">,</span> <span class="token string">\'/hello/{name}\'</span><span class="token punctuation">,</span> hello<span class="token punctuation">)</span>\n    srv <span class="token operator">=</span> <span class="token keyword">await</span> loop<span class="token punctuation">.</span>create_server<span class="token punctuation">(</span>app<span class="token punctuation">.</span>make_handler<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">\'127.0.0.1\'</span><span class="token punctuation">,</span> <span class="token number">8000</span><span class="token punctuation">)</span>\n    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">\'Server started at http://127.0.0.1:8000...\'</span><span class="token punctuation">)</span>\n    <span class="token keyword">return</span> srv\n\nloop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>\nloop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>init<span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">)</span>\nloop<span class="token punctuation">.</span>run_forever<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>注意 aiohttp 的初始化函数 init() 也是一个 coroutine，loop.create_server() 则利用 asyncio 创建 TCP 服务。</p>\n<p>// TODO Python 入门学习待完成</p>',
id:"/home/runner/work/GatsbyBlog/GatsbyBlog/blog/Python入门学习/index.md absPath of file >>> MarkdownRemark",timeToRead:117,frontmatter:{date:"2022-04-02 16:40:55",path:"/python-introduce-learn/",tags:"后端, python, 读书笔记",title:"Python入门学习",draft:null}}],length:4,tag:"python",pagesSum:1,page:1}}}});